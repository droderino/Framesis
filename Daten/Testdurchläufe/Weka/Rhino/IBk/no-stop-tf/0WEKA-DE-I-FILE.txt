@relation 'Bugzilla data'

@attribute bug_bug_id numeric
@attribute bug_short_desc string
@attribute bug_product string
@attribute bug_component string
@attribute bug_reporter string
@attribute bug_assigned_to string
@attribute bug_long_desc string
@attribute bug_thetext string
@attribute bug_classification {BUG,RFE,IMPROVEMENT,DOCUMENTATION,BUILD_SYSTEM,REFACTORING,CLEANUP,SPEC,TEST,BACKPORT,TASK,OTHER,DESIGN_DEFECT}

@data
18229,'Bogus class file names being generated on Windows',Rhino,Compiler,treilly,norrisboyd,'The first line of\norg.mozilla.javascript.optimizer.OptClassNameHelper.setTargetClassFileName(String)\nis the bug.  It is assuming the path separator is a \'/\' causing bad things\nto happen on Windows when the path separator is a \'\\\\\'.  Using\nFile.separatorChar fixed the problem for me.Fixed (Thanks for pointing this out!):\n\nChecking in OptClassNameHelper.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/optimizer/OptClassNameHelper.ja\nva,v  <--  OptClassNameHelper.java\nnew revision: 1.3; previous revision: 1.2\ndone',?,CLEANUP
19980,'catch() block can\'t span multiple lines in interactive rhino shell',Rhino,Core,jonathan_leech,rogerl,'rhino interactive shell chokes on catch{} block syntax if the block spans\nmultiple lines, with a syntax error javascript exception.  The version of rhino\nwas the rhinoTip.zip from the fpt site on 11/23/99.\nto reproduce:\njava -jar js.jar\ntry {\n   java.lang.Class.forName(\"blah\")\n}\ncatch (e) {\njs>  print(e)\njs: \"<stdin>\", line 6: uncaught JavaScript exception: ReferenceError: \"e\" is not\ndefined.\njs> }\njs: \"<stdin>\", line 7: uncaught JavaScript exception: SyntaxError: syntax error\n\nNotice that it came back to the shell prompt prematurely -- It isn\'t expecting\nthe rest of the catch block.\nIt works fine if you type it in as \"catch(e) {print(e)}\", all on one line.  It\nalso works fine, spanning multiple lines, if the catch() block is nested in a\ntry{} block -- e.g.\ntry {\n   try {\n      java.lang.Class.forName(\"blah\")\n   }\n   catch (e) {\n      print(e)\n   }\n}\ncatch (e) {}Roger, I verified that there\'s a problem here. If you get to this first,\nreassign the bug to yourself.Fixed - parser needed to error if token after catch block wasn\'t a close curly.',?,BUG
23609,'NullPointerException processing postincrement',Rhino,Compiler,norrisboyd,rogerl,'From n.p.m.jseng:\n\nSubject:\n             rhino problem with post increment inside array index\n        Date:\n             Mon, 10 Jan 2000 13:08:14 GMT\n       From:\n             aanten@my-deja.com\n Organization:\n             Deja.com - Before you buy.\n Newsgroups:\n             netscape.public.mozilla.jseng\n\n\n\n\nI am having problems with the following code, which seems to cause the\nrhino engine to fail\n\nvar k=0;\nvar x=new Array(1,2,3);\nx[k]+=3; //works fine\nx[k++]+=3; //breaks rhino\n\n\nfrom the final line, i get the exception. I can work around the\nproblem, by incrementing k elsewhere, but should this work ?\n\nJust as a side issue, does anyone know how the rhino tip builds are\nscheduled ? there doesn\'t seem to have been any for a while.\n\nmany thanks.\n\njava.lang.NullPointerException\n        at org.mozilla.javascript.optimizer.Codegen.visitIncDec\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.generateCodeFromNode\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.generateCodeFromNode\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.generateCodeFromNode\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.generateCodeFromNode\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.generateCode\n(Compiled Code)\n        at org.mozilla.javascript.optimizer.Codegen.compile(Compiled\nCode)\n        at org.mozilla.javascript.Context.compile(Compiled Code)\n        at org.mozilla.javascript.Context.compile(Compiled Code)\n        at org.mozilla.javascript.Context.compileReader(Compiled Code)\n        at org.mozilla.javascript.Context.evaluateReader(Compiled Code)\n        at org.mozilla.javascript.Context.evaluateString(Compiled Code)\n        at org.mozilla.javascript.tools.shell.Main.processSource\n(Compiled Code)\n        at org.mozilla.javascript.tools.shell.Main.main(Compiled Code)\n\n\nSent via Deja.com http://www.deja.com/\nBefore you buy.Changing qa contact.Fixed - IRFactory was trying to optimize the formation of post-increment trees\nbut didn\'t handle indexing with side effects correctly.Marking Verified.',?,BUG
24023,'Rethrowing an exception infinite loop',Rhino,Core,beard,norrisboyd,'The following example never terminates:\n\nfunction test()\n{\n    try {\n        throwException();\n    } catch (ex) {\n        throw ex;\n    }\n}\n\nfunction throwException()\n{\n    throw new java.lang.Exception();\n}\n\ntest();\n\nThe problem seems to be that in the interpreter loop, the local variable\n<code>tryStackTop</code> never gets decremented, so the same exception\nhandler keeps getting control over and over again. I don\'t know if this is\nan interpreter bug or a code generation bug.Created attachment 4350\nProposed patchI think the ENDTRY icode needs to be at the end of the code inside of the try\nrather than at the end of the catch. This allows us to then decrement\ntryStackTop when we\'re catching the exception, and so rethrows occur relative to\nthe correct try.\n\nI haven\'t tested this change for regressions yet. I\'ll do so before committing\nit.Having the ENDTRY at the end of the try block is correct, it was broken\npreviously because it got set AFTER the goto which was at the end of the try\nblokc and so was never executing, resulting in a bad array reference. That test\ncase is :\n\ntry {\n    a = 1;\n}\ncatch (x) {\n}\n\ntry {\n    a = 2;\n    throw \"a\";\n}\ncatch (x) {\n}\n\ntry {\n    a = 3;\n}\ncatch (x) {\n}\n\nI\'ve checked in Norris\' fix with the ENDTRY just before the goto.',?,BUG
26454,'Use Class.getDeclaredMethods() instead of getMethods()',Rhino,Core,vajda,norrisboyd,'The following piece of code comes from FunctionObject.findMethods().\nIt appears that this method wants the locally declared public methods on the \nclass passed in. Class.getMethods() is a relatively expensive operation (as my \nprofiler reports) since all superclasses have to be scanned going up the tree \nand put together in an array. This can be expensive when the class hierarchy is \ndeep. A more efficient method would be to call Class.getDeclaredMethods() and \nfilter by name (as you already do) and by modifier using the \nMethod.getModifiers() method.\nOr am I missing something ? I am using the latest rhino tip as of last week.\n\nRegards\nAndi..\n\n    // TODO: Make not public\n    /**\n     * Finds methods of a given name in a given class.\n     *\n     * <p>Searches <code>clazz</code> for methods with name\n     * <code>name</code>. Maintains a cache so that multiple\n     * lookups on the same class are cheap.\n     *\n     * @param clazz the class to search\n     * @param name the name of the methods to find\n     * @return an array of the found methods, or null if no methods\n     *         by that name were found.\n     * @see java.lang.Class#getMethods\n     */\n    public static Method[] findMethods(Class clazz, String name) {\n        Vector v = new Vector(5);\n        Method[] methods = clazz.getMethods();\n        for (int i=0; i < methods.length; i++) {\n            if (methods[i].getDeclaringClass() == clazz &&\n                methods[i].getName().equals(name)){\n                v.addElement(methods[i]);\n            }\n        }\n        if (v.size() == 0) {\n            return null;\n        }\n        Method[] result = new Method[v.size()];\n        v.copyInto(result);\n        return result;\n    }A good suggestion. I\'ll change the one instance you point out and examine the \nother uses of getMethods.Fixed:\nChecking in FunctionObject.java;\n/m/pub/mozilla/js/rhino/org/mozilla/javascript/FunctionObject.java,v  <--  Funct\nionObject.java\nnew revision: 1.12.2.2; previous revision: 1.12.2.1\ndone\nFrom aw@softcom.com:\n\nRecently a change was made to FunctionObject.findMethods. It was changed to use\nClass.getDeclaredMethods instead of Class.getMethods.\nhttp://bugzilla.mozilla.org/show_bug.cgi?id=26454\n\nThe problem is, getDeclaredMethods returns all public, private, protected and\npackage access methods while getMethods only returns public methods. So when\nRhino is being run under a SecurityManager, it fails with a SecurityException\n(because it is trying to access private methods).\n\nSo?I?think?it?should?be?changed?back?to?getMethods.\n\njava -Djava.security.manager=java.lang.SecurityManager\norg.mozilla.javascript.tools.shell.Main examples\\NervousText.js\nException in thread \"main\" org.mozilla.javascript.WrappedException:\nWrappedException of access denied (java.lang.RuntimePermission\naccessDeclaredMembers )\nat org.mozilla.javascript.WrappedException.wrapException(WrappedException.java:111)\nat org.mozilla.javascript.Context.initStandardObjects(Context.java, Compiled Code)\n????????at?org.mozilla.javascript.tools.shell.Global.<init>(Global.java:74)\n????????at?org.mozilla.javascript.tools.shell.Main.exec(Main.java:88)\n????????at?org.mozilla.javascript.tools.shell.Main.main(Main.java:74)\n\n\nAndrew\nI checked in changes that revert back to using getMethods(). I couldn\'t get\naround security exceptions, even using getModifiers to filter out everything but\nprivate members.\n\nHowever, I did put in some performance changes to cache the results of\ngetMethods(), so I hope that performance won\'t suffer.\nI just checked in changes to go back to getDeclaredMethods. I was able to get it \nrunning with the security manager. \n\nMy previous checkin using getDeclaredMethods didn\'t check for private or \nprotected members. But even when I fixed that bug, I still got security \nexceptions. The problem was that I was using class compilation mode, which \nattempts to create a class loader. \n\nSo now I\'m able to execute\n\njava -Djava.security.manager=java.lang.SecurityManager\norg.mozilla.javascript.tools.shell.Main -opt -1 examples\\NervousText.js\n\nwithout errors. Andrew, do you remove the optimizer package when you run with a \nsecurity manager so that you get interpretive mode without using \"-opt -1\"?',?,IMPROVEMENT
31639,'Oldstyle Java property method names no longer work with defineClass',Rhino,Core,rbk,norrisboyd,'Since at least release 1.5beta, the defineClass method in\norg.mozilla.javascript.ScriptableObject no longer works with the old way of\ndefining properties in Java classes - e.g.\n\npublic class Foo extends Scriptable Object {\n\npublic String jsProperty_getFoo() { return foo; }\n}\n\ncauses a ArrayIndexOutOfBoundsException to be thrown.\n\nThe problem is at line 900 where the jsProperty_ prefix is removed from the\nmethod name, and then removed again at line 909.\n\nRichard.Doh! Thanks for pointing this out.\n\nFixed:\n\nChecking in ScriptableObject.java;\n/m/pub/mozilla/js/rhino/org/mozilla/javascript/ScriptableObject.java,v  <--  Scr\niptableObject.java\nnew revision: 1.17; previous revision: 1.16\ndone',?,BUG
33239,'Bad trees cause NullPointerException',Rhino,Core,norrisboyd,norrisboyd,'Subject:\n             a rhino bug with parsing\n        Date:\n             Fri, 24 Mar 2000 15:25:58 -0500\n       From:\n             Kumanan Yogaratnam <kumanan@espial.com>\n Organization:\n             Espial Group Inc.\n         To:\n             norris@netscape.com\n\n\n\n\nhi norris,\n\nthe following was reported by our QA dept:\n\n(just so you know, we do not use the optimizer.)\n\n---------------------------------- 8<--------------\nTest case for a JavaScript Bug:\n\nThe JS engine failed with the following piece of code:\n\n    alert(\"inside js file\");\n    var anArray = new Array();\n    var pos = 1;\n    anArray[0] = 5;\n    anArray[1] = 6;\n\n    ++anArray[--pos];\n    alert(anArray[pos]);\n\nThe above script works fine within netscape, but it throws the following\nexception with our browser which uses rhino:\n\njava.lang.NullPointerException\n at org.mozilla.javascript.Interpreter.generateICode(Compiled Code)\n at org.mozilla.javascript.Interpreter.generateICode(Compiled Code)\n at org.mozilla.javascript.Interpreter.generateICode(Compiled Code)\n at org.mozilla.javascript.Interpreter.generateICode(Compiled Code)\n at org.mozilla.javascript.Interpreter.generateICode(Compiled Code)\n at org.mozilla.javascript.Interpreter.generateICodeFromTree(Compiled\nCode)\n at\norg.mozilla.javascript.Interpreter.generateScriptICode(Interpreter.java)\n at org.mozilla.javascript.Interpreter.compile(Interpreter.java)\n at org.mozilla.javascript.Context.compile(Context.java)\n at org.mozilla.javascript.Context.compile(Context.java)\n at org.mozilla.javascript.Context.compileReader(Context.java)\n\n------------------------ 8<---------------\n\nregards,\nkumanan\n\n--\nKumanan Yogaratnam  <mailto:kumanan@espial.com>\nEspial Group Inc.\nhttp://www.espial.comCreated attachment 6908\nproposed fixChecking in IRFactory.java;\n/m/pub/mozilla/js/rhino/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.\njava\nnew revision: 1.10; previous revision: 1.9\ndone\n\n',?,BUG
37317,'multithread not working with JavaAdapter',Rhino,Core,howard,norrisboyd,'In JS, we implement a Java interface and in Java we call methods of this \ninterface from a seperate thread and a \"No context associated with current \nthread\" exception is thrown. Note, this only happens when the method has at \nleast one parameter. If the method has no parameter, it worked fine. I enclosed \nseveral files to illustrate this problem.\n\nHello.java is the interface declaration file.\nSayHello.java is the class that use this interface. \nthread.js is the JS file that implements Hello interface and passes the \ninterface to SayHello class.\nawt.js is a similar JS file which implements actionListener interface and \npasses the interface to Button class. This JS file worked fine. \n\nTo repeat this problem, compile both java files and put the classes in the same \ndirectory as that contains js.jar and jstools.jar, run the following command \nfrom the DOS command:\n\njava -classpath .;js.jar;jstools.jar org.mozilla.javascript.tools.shell.Main\n\nAt JS prompt, type \"load thread.js\", you will get the following exception:\njs> load(\"thread.js\");\ncurrent Thread is Thread[main,5,main]\njs> current Thread is Thread[Thread-0,5,main]\nException caught No Context associated with current Thread\njava.lang.RuntimeException: No Context associated with current Thread\n        at org.mozilla.javascript.Context.getContext()\n        at org.mozilla.javascript.ScriptRuntime.toObject()\n        at org.mozilla.javascript.Context.toObject()\n        at adapter0.print()\n        at SayHello$HelloThread.run()\n\nNotes:\n1) if the print method in the Hello interface doesn\'t take any parameters, it \nworked fine;\n2) awt.js runs fine, even though the actionPerformed method is called on a \nseperate thread too. I don\'t know why. \n3) a side problem. importClass can\'t be used more than once. If I try to \nrun \"load thread.js\" again on the same JS session, I got an exception \nsaying \"property already defined\". I think it should just return quietly \ninstead of throwing an exception, just like importPackage does.\n4) This problem happened in both JDK1.2 and JDK1.1.8.\n\nHowardCreated attachment 8019\nDefine a simple interface with only one methodCreated attachment 8020\nA simple class to call Hello interface on a separate threadCreated attachment 8021\na JS file implementing Hello interfaceCreated attachment 8022\na JS file implementing AWT actionListener interfaceChecked in fix for multithreaded problem:\nChecking in JavaAdapter.java;\n/m/pub/mozilla/js/rhino/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdap\nter.java\nnew revision: 1.23; previous revision: 1.22\ndoneFix for multiple uses of importClass on the same class:\n\nChecking in ImporterTopLevel.java;\n/m/pub/mozilla/js/rhino/org/mozilla/javascript/ImporterTopLevel.java,v  <--  Imp\norterTopLevel.java\nnew revision: 1.9; previous revision: 1.8\ndone',?,RFE
38384,'Instance variable is treated as class variable',Rhino,Core,gerrit.riessen,rogerl,'----------- file: nesting_test.js -----------------\nfunction Nest() \n{\n  this.toString_return_value = \"\";\n  this.contents = new Array();\n\n  this.addElement = \n      new Function( \"elem\", \"this.contents[this.contents.length] = elem; return \n(this);\" );\n  this.toString = NEST_toString_m;\n}\n\nfunction NEST_toString_m()\n{\n  this.toString_return_value = \"\";\n\n  for ( var i = 0; i < this.contents.length; i++ ) \n    {\n      this.toString_return_value += this.contents[ i ].toString() ;\n    }\n\n  return ( this.toString_return_value );\n}\n\nnet = new Nest();\nnet.addElement( \'foobar\' );\nnet.addElement( new Nest().addElement( \'hello world\' ) );\nnet.addElement( \'snafu\' );\n---------------------------------------------------\n\nwhen doing a net.toString() in the Rhino shell i get:\njs> load( \'nesting_test.js\' )\njs> net.toString();\nhello world\njs>\n\nbut when i use IE(5.X) to test the code i get, what i think assume\nto be correct: \'foobarhello worldsnafu\' [same result using Netscape\n4.X]\n\n------------ file: nesting_test.html ---------------\n<html>\n<head>\n<title></title>\n<script language=\"JavaScript\" src=\"nesting_test.js\"></script>\n</head>\n\n<body onLoad=\"alert( net.toString() )\">\n\n</body>\n\n</html>\n----------------------------------------------------\n\nI don\'t know what the ECMAScript Standard says, but i would assume\nthat the IE/Netscape result is the correct result?\n\nHope it helps,\n\nGerritProposed fix:\n\nIndex: Interpreter.java\n===================================================================\nRCS file: /m/pub/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.30\ndiff -u -r1.30 Interpreter.java\n--- Interpreter.java    2000/03/13 18:27:25     1.30\n+++ Interpreter.java    2000/05/07 05:45:50\n@@ -1314,6 +1314,7 @@\n         byte[] iCode = theData.itsICode;        \n         int pc = 0;\n         int iCodeLength = theData.itsICodeTop;\n+        Scriptable itsThisObj = theData.itsThisObj;\n         \n         Object[] local = null;        // used for newtemp/usetemp etc.\n         if (theData.itsMaxLocals > 0)\n@@ -1659,8 +1660,7 @@\n                         lhs = stack[stackTop];\n                         stack[stackTop] = ScriptRuntime.callSpecial(\n                                             cx, lhs, rhs, outArgs, \n-                                            theData.itsThisObj,\n-                                            scope, name, i);\n+                                            itsThisObj, scope, name, i);\n                         pc += 6;\n                         break;\n                     case TokenStream.CALL :\n@@ -1765,7 +1765,7 @@\n                         stack[++stackTop] = null;\n                         break;\n                     case TokenStream.THIS :\n-                        stack[++stackTop] = theData.itsThisObj;\n+                        stack[++stackTop] = itsThisObj;\n                         break;\n                     case TokenStream.FALSE :\n                         stack[++stackTop] = Boolean.FALSE;\n\nThe problem is that the InterpreterData object is referenced for the current \n\'this\' object, but recursive calls can overwrite that value. Copying it into a \nlocal prevents the problem.\n\nThis seems a bit inefficient. Roger, do you remember why it was done this way? \nShould we just add another parameter to the interpret method? \n\nIf the change looks okay to you, Roger, could you check it in? I\'ll wait for my \nnew email address to come before I request checkin privileges.I think the only reason I didn\'t want it passed around was that it uses up a \nslot and a low-index Java register. The testing I did with various JITs \nindicated that they were favoring the parameters and earlier-declared variables \n(for register allocation? - seems kind of hard to believe on x86, but who \nknows). I checked in your fix, but moved the local \'itsThisObj\' further down in \nthe declaration order as it doesn\'t get used that freqeuntly.',?,BUG
38590,'with objects improperly capture eval\'d var declarations',Rhino,Core,mike+mozilla,norrisboyd,'given\n\njs> with(o) {\neval(\"var foo = 4\");\n}\n\nby section 10.1.4, we shouldn\'t see foo defined on the with object o.  But on\nrhino, it seems to be-\n\njs> foo\nReferenceError: \"foo\" is not defined.\njs> o.foo\n4\n\n(thanks to Waldemar for clarifying the correct behavior in this case.)So should the rule be: When executing an eval() inside a with statement, define \nany variables resulting from var statements in the first non-with, non-catch \nscope. \n\nSo another test for this is\n\ntry {\n    throw 3;\n} catch (e) {\n    eval(\"var bar = 6\");\n}\nprint(bar);\n\nwhich should print 6.Fixed:\n\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptRuntime.java,v  <--  Scri\nptRuntime.java\nnew revision: 1.44; previous revision: 1.43\ndone\n\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptRuntime.java,v  <--  Scri\nptRuntime.java\nnew revision: 1.41.2.2; previous revision: 1.41.2.1\ndone',?,BUG
39034,'Rhino no longer parses Macintosh format files',Rhino,Core,beard,norrisboyd,'If I use the load() command from within the Rhino shell, and the .js file is in \nMacintosh text format (lines end with \'\\r\') the Rhino parser/scanner flags the \nfile as containing illegal characters. If I change the file to UNIX format, the \nparser/scanner is happy. This used to work. I don\'t know which version of Rhino \nthis regressed in, but I\'m looking.This regressed in version 1.8 of:\n\nmozilla/js/rhino/org/mozilla/javascript/LineBuffer.java\n\nReverting to 1.7 fixes the problem.\nAdding roger since he made the changes.\nI screwed up the \\n logic trying to get \\u2028 & \\u2029 to work. Fix checked in.Yup, this fixes it. Thanks Roger.\n\n',?,BUG
39309,'concatenating string and number doesn\'t work compiled.',Rhino,Compiler,vajda,norrisboyd,'Given the code:\n{\n    var i = 0;\n    while (i++ < 5) {\n       var text = inputText + i;\n       ... do stuff ...\n}\n\nInterpreted the above code works, that is text is the inputText followed by a \nnumber.\nCompiled (with max optimization level) text becomes NaN.\nThe interpreted behaviour is the correct one according to the javascript book \n(O\'Reilly rhino).\n\nSince this is a discrepancy between interpreted and compiled script it is major. \nThe current workaround is to call i.toString() before concatenating.This happens on the latest rhinoTip, js.jar is dated 4/25 and is 331802 bytes \nlong.I tried the following:\n\n[rhino] cat test.js\nvar inputText = \"hi\";\nvar i = 0;\nwhile (i++ < 5) {\n        var text = inputText + i;\n        print(text);\n}\n[rhino] java org.mozilla.javascript.tools.shell.Main -opt 9 test.js\nhi1\nhi2\nhi3\nhi4\nhi5\n\nCan you give me more information on the code that fails?Wait....\n\nI found this from a mail:\n==================================================\nI just posted a compiler bug on bugzilla (#39309).\nIt has to do with concatenating a string and a number.\nInterpreted concatenation works. Compiled it produces \'NaN\'.\n\nAndi..\n\nfor example:\n\nfunction addSnackItems(textProp, imageProp, len, centerText, \ncenterImages)\n{\n    var fragment = new Fragment(inputNode.doc);\n\n    var i = 0;\n    while (++i <= len) \n    {\n        var iString = i.toString();\n        var name = textProp + iString;\n        var imgname = imageProp + iString;\n\n        if (addSnackTextItem(fragment, name, null, 0, 0, centerText))\n            addSnackImageItem(fragment, imgname, centerImages);\n    }\n\n    return fragment;             \n}\n\nIf you take the .toString() calls away, concatenation name becomes \n\'NaN\'.Okay: this case generates the error:\n\nfunction addSnackItems(textProp, len) {\n    var i = 0;\n    while (++i <= len) {\n       var name = textProp + i;\n       print(name);\n    }\n}\naddSnackItems(\"text\", 1);\n\nThis will print out \"NaN\" rather than \"text1\". \n\nI\'ve tracked down the problem this far: It only occurs with -opt 9 and is caused \nby Optimizer.findSinglyTypedVars calling setIsNumber for the \"name\" variable. \n\nCould you take a look at it, Roger, since it\'s your code?\n\nReassign back to me.Created attachment 8954\nproposed patchFix checked in + addition to handle case of var being used before def\'d.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-39309.js\n\nMarking Verified FIXED. The testcase passes in the Rhino shell\non WinNT4.0 with optimization levels set to -1, 0, or 9.Trageting as resolved against 1.5R5',?,BUG
39906,'Problem with JavaAdapter Scoping',Rhino,Core,beard,norrisboyd,'Try the following example in Rhino\'s shell:\n\n/*\n\trunnable.js\n\t\n\tDemonstrates use of JavaScript from JShell, implementing the\n\tinterface java.lang.Runnable using the new syntax.\n\t\n\tby Patrick C. Beard.\n */\n\nvar runnableDate = new Date();\nrunnableDate.run = function() {\n\tprint(\'runnableDate.run() here.\');\n}\n\n// create a java.lang.Runnable.\nvar runnable = new java.lang.Runnable(runnableDate);\n\nStore this in \"runnable.js\" and type this in the shell:\n\njs> load(\'runnable.js\')\njs> runnable\nadapter0@bb070d\njs> runnable.self\njava.lang.NullPointerException\njava.lang.NullPointerException\n\tat \norg.mozilla.javascript.ScriptableObject.getTopLevelScope(ScriptableObject.java:12\n89)\n\tat \norg.mozilla.javascript.ScriptableObject.getClassPrototype(ScriptableObject.java:1\n263)\n\tat \norg.mozilla.javascript.ScriptableObject.getFunctionPrototype(ScriptableObject.jav\na:1242)\n\tat org.mozilla.javascript.JavaMembers.reflectMethod(JavaMembers.java:305)\n\tat org.mozilla.javascript.JavaMembers.reflect(JavaMembers.java:319)\n\tat org.mozilla.javascript.JavaMembers.<init>(JavaMembers.java:58)\n\tat org.mozilla.javascript.JavaMembers.lookupClass(JavaMembers.java:488)\n\tat org.mozilla.javascript.NativeJavaObject.<init>(NativeJavaObject.java:72)\n\tat org.mozilla.javascript.NativeJavaObject.wrap(NativeJavaObject.java:191)\n\tat org.mozilla.javascript.NativeJavaMethod.call(NativeJavaMethod.java:215)\n\tat \norg.mozilla.javascript.ScriptableObject.getDefaultValue(ScriptableObject.java:528\n)\n\tat org.mozilla.javascript.NativeDate.getDefaultValue(NativeDate.java:101)\n\tat org.mozilla.javascript.ScriptRuntime.toString(ScriptRuntime.java:408)\n\tat org.mozilla.javascript.Context.toString(Context.java:1108)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:287)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:146)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:74)\n\tat org.jxe.tools.java.Java.main(Java.java:113)\n\tat org.jxe.kernel.Tool$ToolThread.run(Tool.java:215)\n\nThe problem seems to be that \norg.mozilla.javascript.ScriptableObject.getTopLevelScope() is getting passed a \nnull scope to begin with.Reassign to my other accountI checked in the fix and removed the negative tests that started failing as a \nresult (see thread in n.p.m.jseng)',?,BUG
40485,'Patch to catch bytecode generated by javascript compiler',Rhino,Compiler,vajda,norrisboyd,'- added ClassOutput interface\n  - added setter/getter on Context and NameHelper (and its implementation).\n  - instead of adding parameters in quite a few places, I followed the model\n    set by Context.setTargetClassFileName() et al. by adding \n    Context.setClassOutput(). The classOutput gets used when a class is\n    produced unless Context.setTargetClassFileName() was called.Created attachment 9094\ncvs diff -uCreated attachment 9095\nAdditional ClassOutput.java file (cvs add)Created attachment 9096\nAn example ScriptCompiler.java file using the new ClassOutput featureReassign to my new account name.Looks good. Regression tests pass with this change.\n\nSince it introduces a new API class and we\'re trying to wrap up 1.5R1, I think \nI\'ll put this into 1.5R2.\n\nI finally committed this. Thanks for your contribution!',?,RFE
40688,'Exception accessing package protected member',Rhino,Core,norrisboyd,norrisboyd,'[rhino] cat A.java\ninterface A { int a = 0;  }\n[rhino] rhino\njs> Packages.A.a\njava.lang.RuntimeException: unexpected IllegalAccessException accessing Java fie\nld\n        at org/mozilla/javascript/JavaMembers.get (JavaMembers.java:102)\n        at org/mozilla/javascript/NativeJavaClass.get (NativeJavaClass.java:94)\n        at org/mozilla/javascript/ScriptRuntime.getProp (ScriptRuntime.java:691)\n\n        at org/mozilla/javascript/Interpreter.interpret (Interpreter.java:1594)\n        at org/mozilla/javascript/InterpretedScript.call (InterpretedScript.java\n:67)\n        at org/mozilla/javascript/InterpretedScript.exec (InterpretedScript.java\n:54)\n        at org/mozilla/javascript/Context.evaluateReader (Context.java:741)\n        at org/mozilla/javascript/tools/shell/Main.evaluateReader (Main.java:347\n)\n        at org/mozilla/javascript/tools/shell/Main.processSource (Main.java:284)\n\n        at org/mozilla/javascript/tools/shell/Main.exec (Main.java:148)\n        at org/mozilla/javascript/tools/shell/Main.main (Main.java:74)\n\nERROR: java.lang.RuntimeException: unexpected IllegalAccessException accessing J\nava fieldreassign to other accountHmm. Calling getModifiers on the java.lang.reflect.Field object for \"a\" returns \n25, and Modifiers.isPublic(25) is true.\n\nThis looks like a JDK bug: the modifiers values for \"A\" and \"a\" are the same for \nboth\n    interface A { int a = 0;  }\nand\n    interface A { public int a = 0;  }\n\nAny ideas, Patrick?Must be a JVM bug indeed. but it works with JDK1.3.1 and JDK1.4.0, so sun must \nhave fixed it (though I couldnt find a reference to it in the bug parade). \nPackages.A.a returns 0 for me as it should.\n\n\nWhether you explicitly say a field is public or not it is still going to be \npublic. From Java Specification about interfaces:\n\n9.3 Field (Constant) Declarations\n..\nEvery field declaration in the body of an interface is implicitly public, \nstatic, and final. It is permitted to redundantly specify any or all of these \nmodifiers for such fields.\nThe raeson for the bug is that interface is declared package-private, and with\nreflection it is not possible to access such field. With public interface it\nworks under jdk 1.1-1.4:\n\n~/tmp> cat A.java \npublic interface A { int a = 0;  }\n\n~/tmp> CLASSPATH=. java -jar js.jar -e \'print(Packages.A.a)\'\n0\n\nOn the other hand, if one apply the following patch to omj/JavaMembers.java to\nprint a detailed stack trace, then the original non=public A I got:\n\njava.lang.IllegalAccessException: Class org.mozilla.javascript.JavaMembers can\nnot access a member of class A with modifiers \"public static final\"\n        at sun.reflect.Reflection.ensureMemberAccess(Reflection.java:57)\n        at java.lang.reflect.Field.doSecurityCheck(Field.java:811)\n\n\nUnder jdk 1.1, 1.3 the exception is the same but it does not have a detailed\nmessage.\n\nIn principle this can be solved under JDK 1.2 via calling setAccessible on the\nfield if its access trigers IllegalAccessException, but perhaps such change it\nis better to do consistently in places where reflection is used.\n\n\n\n\nPatch to enable stack printout:\nIndex: JavaMembers.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v\nretrieving revision 1.31\ndiff -u -r1.31 JavaMembers.java\n--- JavaMembers.java\t9 Jun 2002 15:58:14 -0000\t1.31\n+++ JavaMembers.java\t3 Apr 2003 14:39:37 -0000\n@@ -104,11 +104,16 @@\n                 type = bp.getter.getReturnType();\n             } else {\n                 Field field = (Field) member;\n-                rval = field.get(isStatic ? null : javaObject);\n+                if (isStatic) {\n+\t\t\t\t\trval = field.get(null);\n+\t\t\t\t} else {\n+\t\t\t\t\trval = field.get(javaObject);\n+\t\t\t\t}\n                 type = field.getType();\n             }\n         } catch (IllegalAccessException accEx) {\n-            throw new RuntimeException(\"unexpected IllegalAccessException \"+\n+            accEx.printStackTrace();\n+\t\t\tthrow new RuntimeException(\"unexpected IllegalAccessException \"+\n                                        \"accessing Java field\");\n         } catch (InvocationTargetException e) {\n             // Since JavaScriptException is a checked exception, must\nMarking as fixed: Rhino calls for some time setAccessible under JDK >= 1.2 after\nfirst failed access with IllegalAccessExceptionRubber-stamp vrfyTrageting as resolved against 1.5R5',?,BUG
40844,'Incorrect static method called for inherited class',Rhino,Core,mberney,norrisboyd,'From Rhino Newsgroup (netscape.public.mozilla.jseng):\n\nI have potentially discovered a problem with Javascript.  Here is my java code:\n \npublic abstract class ParentClass {\n \n    public static void printSomething() {\n        System.out.println(\"ParentClass.printSomething()\");\n    }\n}\n \n \npublic class ChildClass extends ParentClass {\n \n    public static void printSomething() {\n        System.out.println(\"ChildClass.printSomething()\");\n    }\n}\n \njava org.mozilla.javascript.tools.shell.Main\n \njs> importClass(Packages.ChildClass);\njs>\njs> ChildClass.printSomething();\nParentClass.printSomething();\njs> quit();\n \nNow, I could be wrong, but the way I understand things, it seems like the Child \nClass method should be invoked here.  Is this something similar to the bug \nreport I found in:  37381?\n \nThanks,\n \nMattreassign to my other accountInteresting: this bug occurs in Sun\'s JDK, but not in Microsoft\'s JViewOn some JVMs, Class.getMethods will return all\nstatic methods of the class heirarchy, even if\na derived class\'s parameters match exactly.\nWe want to call the dervied class\'s method.\nAdded code to do that:\n\nChecking in NativeJavaMethod.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NativeJavaMethod.java,v  <--  N\nativeJavaMethod.java\nnew revision: 1.13; previous revision: 1.12\ndone',?,BUG
41111,'java.lang.String vs. primitive string type',Rhino,Core,norrisboyd,norrisboyd,'rubys@us.ibm.com wrote:\n\n  That code snippet below is actually the same test as the one that I said\n  that works.\n\nSorry. I misread your note.\n\n\n\n  Note that there actually are three cases.  (1) java.lang.String, (2)\n  org.mozilla.javascript.NativeString, and (30\n  org.mozilla.javascript.NativeJavaObject wrappered java.lang.String.  It is\n  the third case that is not handled well.\n\n  If org.mozilla.javascript.NativeString were enhanced to support all of the\n  neccessary functions and attributes of java.lang.String, and the code were\n  more consistent on how it chose to wrapper String objects, then you could\n  eliminate a source of confusion while retaining backwards compatibility.\n\n  Another solution would be to find all cases where strings are handled\n  (e.g., ScriptRuntime.toNumber(Object)) and add specific code to handle\n  NativeJavaObject wrappered Strings as well.\n\nThat sounds like a reasonable approach. I\'ll open a bug for it and look into it \nonce we finally wrap up the 1.5 final.\n\n\n\n  - Sam Ruby\n\n  Norris Boyd <nboyd@atg.com> on 05/30/2000 04:06:31 PM\n\n  To:   Sam Ruby/Raleigh/IBM@IBMUS\n  cc:   Rick Rineholt/Raleigh/IBM@IBMUS\n  Subject:  Re: java.lang.String vs. JavaScript \"string\"\n\n  Actually, now that I think about it, we did make a change not too long ago\n  that\n  increases the priority of a [[DefaultValue]] conversion of a wrapped\n  java.lang.String to a JavaScript primitive string. So that fixes the code\n  snippet below:\n\n  js> foo = \"5\";\n  5\n  js> foo - 3\n  2\n\n  There are still some instances where problems may crop up, but they should\n  be\n  less with this change.\n\n  I\'m trying to post a new zip file for Rhino, but have discovered that I\n  don\'t\n  have access anymore to post. I\'m working to get around that.\n\n  --N\n\n  rubys@us.ibm.com wrote:\n\n  > In exploring code written using Rhino (and Rick\'s VB like front end), we\n  > find that there are a number of differences in ways that these two types\n  of\n  > strings are handled.  It would seem to me that these differences would be\n  > confusing to an end user.  In particular, the following works:\n  >\n  >    var foo = \"5\";\n  >    var bar = foo - 3;\n  >\n  > However, if foo is set as the return from a liveConnect type of call\n  (i.e.,\n  > it gets a true java.lang.String), then the user sees an error message\n  that\n  > the object does not have a \"toDouble\" method.  At a minimum, a more\n  > specific error message would be appropriate.\n  >\n  > A simple fix would seem to me to keep Strings always in their JavaScript\n  > format.  In particular, if the following call in NativeJavaMethod were\n  > changed from:\n  >\n  >    Object wrapped = NativeJavaObject.wrap(scope, retval, staticType);\n  >\n  > to\n  >\n  >    Object wrapped = ScriptRuntime.wrap(scope, retval, staticType);\n  >\n  > Then I think cases like these would be handled more intuitively.  Similar\n  > cases occur in JavaMembers, NativeJavaArray, and others.\n  >\n  > - Sam RubyI suggest to close the bug as fixed as since 1.5R2 one can use omj.WrapHandler\nto explicitly control mapping of Java String to JS one and in Rhino 1.5R4 one\nwill be able to alter the behavior via simple\ncontextInstance.getWrapHandler().setJavaPrimitiveWrap(true) \nOK, resolving as FIXED -And marking Verified -Targeting as resolved against 1.5R4',?,DESIGN_DEFECT
42097,'var definition overrides function definition',Rhino,Compiler,mike+mozilla,norrisboyd,'Just got this bug report -\n\nThe following code demonstrates a bug in Rhino. Correct behavior: \"var now\"\ndefines a local property in \"function now\". However, in Rhino it overwrites the\n\"function now\". This code essentially behaves as if the \"var\" part is not there,\nmeaning a global property overwrite is occuring instead of a local prop being\ncreated in function now.\n\nSteven\n\n//////////////////////////////////////////////////////////\n<script>\n\nfunction now(year){\n        alert( now);\n        var now = -9\n       alert( now);\n}\n\nnow(20);\n\n</script>Fixed:\n\nChecking in NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NodeTransformer.java,v  <--  No\ndeTransformer.java\nnew revision: 1.14; previous revision: 1.13\ndone\n\n',?,BUG
45928,'NativeDate uses getDeclaredConstructor instead of getConstructor',Rhino,Core,bdc,norrisboyd,'We had to make the following change to NativeDate.java to get it to work in the \nbrowser in the applet sandbox. Note that there is no reason to call the version \nthat even can access the private constructors, since it\'s a public constructor \nit\'s looking for. I believe that this affects both Netscape and IE.\n\nuse getConstructor() instead of getDeclaredConstructor(). This is because\nreflective access to the native data formatter is restricted in the browser.Mike, do you see any problems with making this change?Why does getDeclaredConstructor fail and getConstructor succeed, when the\nconstructor in question is public?\n\nLooks like the methods are equivalent in this case.  This change looks fine to\nme.Checking in org/mozilla/javascript/NativeDate.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NativeDate.java,v  <--  NativeD\nate.java\nnew revision: 1.9; previous revision: 1.8\ndoneVerifying -\nThanks a lot for fixing this. I agree that it is lame for getDeclaredConstuctor \nto fail if it is in fact asking for a public method, but all the getDeclared* \nwork this way.',?,DESIGN_DEFECT
46968,'JavaDoc files for Rhino are wrapped',Rhino,Core,yugo,norrisboyd,'Directory: http://www.mozilla.org/js/rhino/org/mozilla/javascript/\n\nClassOutput.html and WrapHandler.html are wrapped.\nPlease add them to NOWRAP.updating product and setting default owner.Fixed - thanks.Marking Verified -\n',?,CLEANUP
47859,'old package com.netscape.javascript',Rhino,Core,yugo,norrisboyd,'The old package name \"com.netscape.javascript\" still remains.\nPlease replace it with org.mozilla.javascript.\n\njs/rhino/org/mozilla/javascript/resources/Messages.properties, line 44\n# com.netscape.javascript.resources\n\njs/rhino/org/mozilla/javascript/tools/resources/Messages.properties, line 45\n    Must have the com.netscape.javascript.optimizer package available \\And the release date is 1999 not 1998.thanks, fix checked inVerifying fixed -\n',?,CLEANUP
48930,'NativeJavaObject.initJSObject() early exit?',Rhino,Core,norrisboyd,norrisboyd,'Subject: \n        Bug report. Please respond.\n   Date: \n        Mon, 14 Aug 2000 16:24:42 +0200\n   From: \n        \"Michael Titenstein\" <mt@edusoft.co.il>\n     To: \n        <nboyd@atg.com>\n    CC: \n        \"Hernan (E-mail)\" <hernan@edusoft.co.il>\n\n\n\n\nHello, I want to report about bug in Rhino JavaScript Engine. This problem\noccurs only under window2000 sp1 AFAIK. After some debugging session I found\nwhere exactly the problem occurs.\n\nProblem description: Main application being terminated without any error\nmessages.\n\nWhen: on script engine initialization .\nCode sample:\n\nContext m_cx = Context.enter();\nm_cx.setLanguageVersion(Context.VERSION_1_2);\nm_cx.setErrorReporter(new JSEvalErrorReporter());\nm_scope=new FlattenedObject(m_cx.initStandardObjects(null));\n\nafter executing last line of code application terminates.\nUsing java source of JS engine I found the \"guilty\" line . File\n\"NativeJavaPackage.java\", function \"init\", line\nNativeJavaObject.initJSObject();\n\nThis problem happens on both JS engines ver 1.4R3 and v1.5.\nI\'m using MSJ++ v1.1 sp3 compiler.\n\nPlease respond somehow, this is very important issue.\n\nThanks and best regard,\nMichael Titenstein.\nSoftware developer.When I execute NativeJavaObject.initJSObject(), I get an early return because \nContext.useJSObject is false. Is it true for you?\nA MS JIT/JVM bug.\n\nChecking in a workaround.Worked around bug in MSJVM.',?,BUG
49286,'try/catch within JavaScript not working as expected',Rhino,Compiler,jlaprise,norrisboyd,'Consider the following JavaScript scenario\n\nvar myObj = new Packages.myclasses.MyClass();\n\ntry\n{\n  // If setting a property on this object throws an exception, the exception\n  // will not be caught by the JavaScript try/catch\n  myObj.prop1 = \"test\";\n\n  // Exceptions from methods work fine\n  myObj.setProp1( \"test\" );\n}\ncatch( e ) { java.lang.System.out.println( \"An Exception Occurred:  \" + e ); }\n\nOn a related note, the try/catch mechanism doesn\'t seem to work at all when \ncalling a function (containing a try/catch block) directly via the call method \nof the Function interface.  If an exception occurs within the try, it will not \nbe caught; instead, a NullPointerException is propagated up to the caller.Roger, Patrick: any chance I could get some help with this one? Finally fixed.Testcase added to JS test suite: \n\n           js/tests/ecma_3/Function/regress-49286.js\n\nCovers this part of the report:\n\n> On a related note, the try/catch mechanism doesn\'t seem to work at all when \n> calling a function (containing a try/catch block) directly via the call method \n> of the Function interface.  If an exception occurs within the try, it will not \n> be caught; instead, a NullPointerException is propagated up to the caller.\n\n\nTestcase now passing in both the compiled and interpreted Rhino shells - jlaprise@delanotech.com: has this bug gone away for you now:\n\n> Consider the following JavaScript scenario\n\n> var myObj = new Packages.myclasses.MyClass();\n\n> try\n> {\n>   // If setting a property on this object throws an exception, the exception\n>   // will not be caught by the JavaScript try/catch\n\n>                          etc. \n>                          etc.\n\n\nIf the bug is fixed for you now, you can mark this bug \"Verified\" \n(see option above). If it is not fixed, you can reopen it - thanks.\n',?,BUG
49325,'JavaAdapter method lookup does not follow prototype chain',Rhino,Core,rade,norrisboyd,'Define a simple Java interface as follows:\n\npublic interface Foo {\n    public int bar(int x);\n}\n\nand then run the following Javascript program:\n\nvar foo = {}\nfoo.__proto__.bar = function(x) { return x; }\nfoo.bar(10);\t//=> 10\nvar f = new JavaAdapter(Packages.Foo,foo);\nf.bar(10);\t//=> 0\n\nThe invocation of \"bar\" on \"f\" returns 0 instead of 10. That is because \nJavaAdapters do not follow the prototype chain on attribute/method lookup.\n\nbtw, we get \"0\" because of another problem - a failed method lookup results in \n\"undefined\" being returned, which gets converted to 0 by the JavaAdapter.Created attachment 13053\nfix for both problems - I haven\'t done any extensive testing on this, but it *does* fix the test caseCreated attachment 13057\nAnother proposed patchI believe my changes to your patch handle the case where the function isn\'t \ndefined more rigorously. (Curse my initial laziness to not fix the TODO.)\n\nWhat do you think?Norris, your fix looks good to me.\nCool. Thanks for all your help with these. You\'re fast with the patches!\n\nI\'ll run regression tests on this change tonight and check it in tomorrow if all \ngoes well.Sorry--a little slow on this.\n\nChecking in now.',?,BUG
49350,'JavaAdapter changes prototype of delegee',Rhino,Core,rade,norrisboyd,'For some bizarre reason there is some code in JavaAdapter that changes the \nprototype of the delegee object, e.g.\n new JavaAdapter(Packages.Foo, foo)\nwill actually change the prototype of foo to be the newly created object.\nThis is bad because\na) it is not very intuitive\nb) one cannot use Javascript inheritance (via prototypes) to implement methods \nof Java interfaceschanging ScriptRuntime::setAdapterProto as follows fixes things: \n\n    public static void setAdapterProto(Scriptable obj, Object adapter) {\n        Scriptable scope = ScriptableObject.getTopLevelScope(obj);\n        Scriptable wrapped = (Scriptable) Context.toObject(adapter, scope);\n        wrapped.setPrototype(obj);\n    }\n\nHowever, I\'m not sure what the rationale was behind the original design. It is \ntherefore possible that the above completely misses the point :)\nThis code is in to support the use of JavaAdapters as in NervousText.js. See \nexamples/NervousText.js in the distribution. I verified that the proposed change \nbreaks this example:\n\n[rhino] java sun.applet.AppletViewer NervousText.html\nReferenceError: \"resize\" is not defined.\n        at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:\n496)\n        at org.mozilla.javascript.ScriptRuntime.getBase(ScriptRuntime.java, Comp\niled Code)\n        at NervousText$init.call(Unknown Source)\n        at org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1217)\n        at org.mozilla.javascript.JavaAdapter.callMethod(JavaAdapter.java:301)\n        at NervousText.init(<adapter>)\n        at sun.applet.AppletPanel.run(AppletPanel.java:333)\n        at java.lang.Thread.run(Thread.java:479)\n\nIn the init function, resize is called. In the Java implementation, the resize \nmethod lives in the base class, so we make the prototype of the JavaAdapter be \nthe Java reflection of the class so that base methods are \"inherited\". \n\nIt\'d be great if we could figure out a way to make both work. Maybe the \nprototype should be changed only if it is set to Object.prototype (the default)?  \nIt\'s a bit of a weird case because of the collision of prototypes and \nclass-baseed inheritance.Here is what I think should be done.\n\n1) Instead of setting the proto of the delegee to the wrapper, the proto of the \nwrapper is set to the delegee. This is *a lot* cleaner since it leaves the \ndelegee intact. It also means that any properties added later to the delegee (or \none of the objects in the prototype chain) will be accessible from the wrapper \n(on the Javascript side only though).\n\n2) When creating the wrapper class we not only generate methods for properties \non the delegee but also traverse the delegee\'s prototype chain. As a result, \nJava code can invoke methods on the Javascript object that are defined anywhere \nwithin the Javascript prototype chain.\n\n3) Instead of calling methods on the wrapper with \"this\" bound to the delegee, \nwe call them with \"this\" bound to the wrapper. This means that the \"this\" can be \nused to call methods on Java base classes. This *will* break existing code which \n calls the methods unqualified, but doing so was never the right thing to do in \nthe first place, IMHO.\n\nI have implemented 1)+3) and it works great. What do you think ?\nHere\'s a nice little example of inheritance in Java and Javascript working in \nperfect harmony. This all works fine with the changes I proposed.\n\nA.java:\npublic class A extends B {\n    public String m1() { return \"m1\"+m2(); }\n}\n\nB.java:\npublic class B {\n    public String m2() { return \"m2\"; }\n    public String m4() { return \"m4\"; }\n}\n\nJavascript:\nfunction P() {}\nP.prototype.m2 = function() { return \"j2\"+this.m3(); }\nfunction J() {}\nJ.prototype = new P;\nJ.prototype.m3 = function() { return \"j3\"+this.m4(); }\nvar j = new J;\nvar jj = new JavaAdapter(Packages.A,j);\njj.m1(); //=> \"m1j2j3m4\"\nDo you have a patch that implements the changes you suggest?\n\nThanks for looking at this.Created attachment 13362\npatch (part 1/3)Created attachment 13363\npatch (part 2/3)Created attachment 13364\npatch (part 3/3)I\'m looking at this. Thanks for the patch files. Perhaps I\'m doing something \nwrong, but I have trouble with the format of your patch files. I generally use a \nunified diff for patch files.In the JavaAdapter patch you have\n\n+    public static Scriptable setAdapterProto(Scriptable obj, Object adapter) {\n+        Scriptable res = ScriptRuntime.toObject(ScriptableObject.getTopLevelSco\npe(obj),adapter);\n+        res.setPrototype(obj);\n+        return res;\n+    }\n\nThe parameters for Context.toObject are (value, scope). Did you mean \n    ScriptRuntime.toObject(adapter,ScriptableObject.getTopLevelScope(obj));\ninstead?The parameters for Context.toObject are \"value,scope\". However, I\'m using\n*ScriptRuntime* and there the parameters are \"scope,value\" :)\nFinally got around to merging this patch. The only change I made was to keep\nRhino working on JDK 1.1.x by removing the use of HashSet. It\'s unfortunate \nbecause that looked like the best solution.\n\nChecking in examples/NervousText.js;\n/cvsroot/mozilla/js/rhino/examples/NervousText.js,v  <--  NervousText.js\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAd\napter.java\nnew revision: 1.29; previous revision: 1.28\ndone\nChecking in org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptRuntime.java,v  <--  Scri\nptRuntime.java\nnew revision: 1.47; previous revision: 1.46\ndone\nChecking in org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptableObject.java,v  <--  S\ncriptableObject.java\nnew revision: 1.20; previous revision: 1.19\ndoneNorris,\n\nin your attempt to eliminate HashSets you introduced an infinite loop in \nScriptableObject::getPropertyIds :\n\n       while (obj != null) {\n            Object[] ids = obj.getIds();\n            for (int i=0; i < ids.length; i++) {\n                h.put(ids[i], ids[i]);\n            }\n        }\n\nYou\'ve missed out\n       obj = (Scriptable)obj.getPrototype();\nfrom the loop.\nI did check in the fix to this, but didn\'t mark this fixed.',?,BUG
56158,'Error() constructor doesn\'t conform to ECMAv3',Rhino,Core,david,norrisboyd,'1) The Error() constructor does not set the message property when passed\n   a message argument.  (See ECMAv3 15.11.2.1)\n\n2) When Error() is called as a function rather than as a constructor\n   (see ECMA v3: 15.11.1.1) it causes a Java exception to be thrown, and\n   rhino exits.\n\nBoth problems exist in the rhinoTip.zip file dated 9/11/00.\nThe following rhino shell session demonstrates both bugs:\n\njs> var e = new Error(\"message\");\njs> e\nError: \njs> e = Error(\"message\");\nException in thread \"main\" java.lang.RuntimeException:\norg.mozilla.javascript.PropertyException: Constructor for \"TypeError\" not found.\n        at\norg.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:500)\n        at\norg.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:467)\n        at\norg.mozilla.javascript.ScriptableObject.getDefaultValue(ScriptableObject.java:600)\n        at org.mozilla.javascript.ScriptRuntime.toString(ScriptRuntime.java:408)\n        at org.mozilla.javascript.Context.toString(Context.java:1102)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:243)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:110)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:68)Just missing code for the JavaScript constructor definition in Java:\n\n    public static Object jsConstructor(Context cx, Object[] args, \n                                       Function funObj, boolean inNewExpr)\n    {\n        NativeError result = new NativeError();\n        if (args.length >= 1) \n            result.put(\"message\", result, cx.toString(args[0]));\n        result.setPrototype(getClassPrototype(funObj, \"Error\"));\n        return result;\n    }\n    \nMarking Verified -',?,SPEC
56185,'try/finally without catch doesn\'t work right!',Rhino,Core,david,norrisboyd,'I\'m using rhino from the file rhinoTip.zip, of 9/11/00.\n\nThe following code doesn\'t work as it should unless you uncomment\nthe catch clause.  Otherwise, I get a bogus exception from the \nfinally clause().\n\nvar i = 0, total = 0; \nvar a = [1,2,3,4];\nwhile(i < a.length) {\n    try {\n        print(i);\n        print(a[i]);\n        if ((typeof a[i] != \"number\") || isNaN(a[i])) // If it is not a number\n            continue;  // then go on to the next iteration of the loop.\n        total += a[i]; // Otherwise, add the number to the total.\n        print(\"total: \" + total);\n    }\n/*    catch(e) { print(e); } */\n    finally {\n        i++;  // Always increment i, even if we used continue above\n    }\n}Just occurs in interpretive mode.This patch fixes it. Roger, would you review this change?\n\nIndex: org/mozilla/javascript/Interpreter.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.33\ndiff -u -r1.33 Interpreter.java\n--- Interpreter.java    2000/08/15 15:54:11     1.33\n+++ Interpreter.java    2000/10/12 16:08:31\n@@ -493,8 +493,7 @@\n                 */\n                     Node target = (Node)(node.getProp(Node.TARGET_PROP));\n                     target.putProp(Node.FINALLY_PROP, node);\n-                    iCodeTop = addGoto(node, TokenStream.GOSUB,\n-                                                        iCodeTop);\n+                    iCodeTop = addGoto(node, TokenStream.GOSUB, iCodeTop);\n                 }\n                 break;\n\n@@ -848,20 +847,25 @@\n                         exception object.\n                     */\n                     while (child != null) {\n-                        if (lastChild == catchTarget) {\n+                        if (catchTarget != null && lastChild == catchTarget) {\n                             itsStackDepth = 1;\n                             if (itsStackDepth > itsData.itsMaxStack)\n                                 itsData.itsMaxStack = itsStackDepth;\n                         }\n                         /*\n-                            When the following child is the catchTarget,\n+                            When the following child is the catchTarget\n+                            (or the finallyTarget if there are no catches),\n                             the current child is the goto at the end of\n                             the try statemets, we need to emit the endtry\n                             before that goto.\n                         */\n-                        if (child.getNextSibling() == catchTarget)\n+                        Node nextSibling = child.getNextSibling();\n+                        if (nextSibling == catchTarget ||\n+                            nextSibling == finallyTarget)\n+                        {\n                             iCodeTop = addByte((byte) TokenStream.ENDTRY,\n-                                                                iCodeTop);\n+                                               iCodeTop);\n+                        }\n                         iCodeTop = generateICode(child, iCodeTop);\n                         lastChild = child;\n                         child = child.getNextSibling();\n\nChecking in org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v  <--  Interp\nreter.java\nnew revision: 1.34; previous revision: 1.33\ndonelooks good to meCompare bug 56716 in JS Engine -',?,BUG
56318,'function literals with names don\'t work right',Rhino,Core,david,norrisboyd,'ECMA v3 (section 13) allows function literals to have names so you can write\nanonymous recursive functions.  But it doesn\'t work right in rhino:\n\nvar f = function fact(x) { if (x <= 1) return 1; else return x*fact(x-1); };\nprint(f(5));\n\nThis results in \n\njs> js: \"<stdin>\", line 12: uncaught JavaScript exception: ReferenceError:\n\"fact\" is not defined. (<stdin>; line 12)I\'m working on this--it\'s harder than it looks.Fixed. The name of the function is assigned to a local variable in the \nfunction prolog when appropriate.',?,BUG
56879,'ECMA conformance: Object.prototype.toLocaleString() undefined!',Rhino,Core,david,norrisboyd,'The latest rhinoTip does not conform to ECMA v3 15.2.4.3:\nit does not define Object.prototype.toLocaleStringCreated attachment 17737\nTrivial implementation of Object.prototype.toLocaleString()Fixed with patch from beard@netscape.com.\n\nChecking in NativeObject.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NativeObject.java,v  <--  Nativ\neObject.java\nnew revision: 1.9; previous revision: 1.8\ndoneVerified on Linux and WinNT using trunk build of Rhino 2000-10-25; \nmethod of verficiation the same as in bug 56878 -',?,SPEC
56883,'ECMA conformance: Array.prototype.toLocaleString()',Rhino,Core,david,norrisboyd,'The latest rhinoTip does not conform to ECMA v3 15.4.4.3:\nit does not define Array.prototype.toLocaleStringDoesn\'t fixing #56879 trivially fix this?\nNo, fixing 56879 doesn\'t trivially fix this. Here\'s a test case that shows the \nway it should work.\n\njs> x = { toLocaleString: function() { count++ } }\n[object Object]\njs> count =0\n0\njs> a = [x,x,x]\n[object Object],[object Object],[object Object]\njs> count\n0\njs> a.toLocaleString()\nundefined,undefined,undefined\njs> count\n3\n\nFixed:\n\nChecking in NativeArray.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NativeArray.java,v  <--  Native\nArray.java\nnew revision: 1.10; previous revision: 1.9\ndoneVerified on Linux and WinNT using trunk build of Rhino 2000-10-25; \nmethod of verficiation the same as in bug 56884 -NOTE: also passed Norris\' test case described above at 2000-10-23 07:30.\nWill add to the test suite -Norris\' testcase has been added to JS test suite as follows: \n\n              js/tests/ecma_3/Array/15.4.4.3-1.js\n\n           ',?,SPEC
57045,'negative integers as object properties: weird behavior',Rhino,Core,david,norrisboyd,'When I use a negative integer as an object property name (is this\neven legal?) I get weird behavior with the latest rhinoTip.  The following\njs shell session illustrates.  Note that this does not occur with\nnon-negative integers, or any floating-point values.\n\nNote that this is very similar to, but not quite the same behavior\nas that reported against spidermonkey in bug #57043\n\noxymoron:7 \% java -jar rhinoTip/js.jar\njs> var o = new Object();\njs>  o[-1] = \"number\";\nnumber\njs>  o[-1]\nnumber\njs> o[\"-1\"]\njs>  o[\"-1\"] = \"string\";   \nstring\njs> o[-1]\nnumber\njs> o[\"-1\"]\nstring\njs> for(i in o) print(i + \": \" + typeof i + \": \" + o[i]);\n-1: number: number\n-1: string: stringCompare bug 57043 in JS Engine -This seems to treat -1 and \"-1\" as distinct keys.\nI have a fix for this. I\'ll run regression tests.Special processing of integers as strings wasn\'t handling negative integers.Verified on Linux and WinNT via this testcase added to JS test suite:\n\n                js/tests/js1_5/Regress/regress-57043.js',?,BUG
57060,'for/in loop enumerates array elements as numbers, not strings',Rhino,Core,david,norrisboyd,'In the latest rhinoTip, the for/in loop enumerates array indexes\nas numbers, rather than as strings:\n\noxymoron:13 \% java -jar rhinoTip/js.jar\njs> var a = [1,2,3];\njs> for(i in a) print(typeof i);\nnumber\nnumber\nnumber\n\nI think this violates 12.6.4 of ECMA v3, which speaks of\n\"the name of the next property\".  I would assume from this\nlanguage that the property name is assumed to be a string.\nThis also differs from spidermonkey, which returns strings.This seems related to #57045, which -1 and \"-1\" are treated as distinct keys.\nThe typeof all values from for..in should now be \"string\".',?,SPEC
58008,'ECMA Conformance: missing Date.to[Locale](Date|Time)String() functions',Rhino,Core,david,mike+mozilla,'The latest rhinoTip, \"rhino15R2pre\" does not implement four Date methods:\n\ntoDateString(), toTimeString(), toLocaleDateString() and toLocaleTimeString().\n\nSee ECMA v3 spec, sections 15.9.5.3 to 15.9.5.7\n\nNote that this bug also exists in Spidermonkey.  See bug #58007.Confirming with Rhino built on WinNT 2000-10-25. Here are the ECMA sections:\n\n\n15.9.5.3 Date.prototype.toDateString ( )\nThis function returns a string value. The contents of the string are \nimplementation-dependent, but are intended to represent the ?date? portion \nof the Date in the current time zone in a convenient, human-readable form.\n\n15.9.5.4 Date.prototype.toTimeString ( )\nThis function returns a string value. The contents of the string are \nimplementation-dependent, but are intended to represent the ?time? portion \nof the Date in the current time zone in a convenient, human-readable form.\n\n15.9.5.6 Date.prototype.toLocaleDateString ( )\nThis function returns a string value. The contents of the string are \nimplementation-dependent, but are intended to represent the ?date? portion \nof the Date in the current time zone in a convenient, human-readable form \nthatcorresponds to the conventions of the host environment?s current locale.\n\nNOTE The first parameter to this function is likely to be used in a future \nversion of this standard; it is recommended that implementations do not use \nthis parameter position for anything else.\n\n15.9.5.7 Date.prototype.toLocaleTimeString ( )\nThis function returns a string value. The contents of the string are \nimplementation-dependent, but are intended to represent the ?time? portion \nof the Date in the current time zone in a convenient, human-readable form that\ncorresponds to the conventions of the host environment?s current locale.\n\nNOTE The first parameter to this function is likely to be used in a future \nversion of this standard; it is recommended that implementations do not use \nthis parameter position for anything else.\nThe spec just says that it is basically implementation defined.\n\nSo for a Date d with \n  d.toString() == \"Thu Oct 26 11:10:05 GMT-0400 (EDT) 2000\" \nshould we have \n  d.toDateString() == \"Thu Oct 26 2000\"\nand \n  d.toTimeString() == \"11:10:05 GMT-0400 (EDT)\"\nand similarly for toLocaleDateString and toLocaleTimeString?I hate to say this, but I\'d like it if the implementation-dependent behavior\nof Rhino and Spidermonkey just happened to match whatever it is that\nJScript does, assuming Microsoft has implemented these functions in IE 5.5\n(I don\'t have a copy, or I\'d check on this myself.)\n\nAlso, my intuition is that it is not useful to include the timezone in\nthe output of toTimeString().  Since the method explicitly returns a time in the\ncurrent time zone, I\'d leave out the specification of the time zone.Here you go, Mike...The intent of the committee was that toDateString and toTimeString together \nshould provide the same information as toString.  The descriptions state \"in the \ncurrent time zone\" because the description of toString states \"in the current \ntime zone\" to distinguish the output from that of toUTCString.  The output of \ntoString must include the time zone for two reasons:\n\n1.  The standard requires Date.parse to round-trip (15.9.4.2) both toString and \ntoUTCString-generated strings.\n2.  Times close to the fall time change from daylight savings time to standard \ntime cannot be represented without using the time zone.\n\nAs such, toTimeString should include the time zone as well.\nCreated attachment 18481\nadd missing date functions to Rhino; restructure date formatter initializationFor this (or similar) script\nd =new Date();\n\nprint(\n\'\\ntoString: \' + d.toString() +\n\'\\ntoGMTString: \' + d.toGMTString() +\n\'\\ntoLocaleString: \' + d.toLocaleString() +\n\'\\ntoLocaleDateString: \' + d.toLocaleDateString() +\n\'\\ntoLocaleTimeString: \' + d.toLocaleTimeString() +\n\'\\ntoDateString: \' + d.toDateString() +\n\'\\ntoTimeString: \' + d.toTimeString())\n\n\nie output:\n\ntoString: Tue Oct 31 16:26:23 PST 2000\ntoGMTString: Wed, 1 Nov 2000 00:26:23 UTC\ntoLocaleString: Tuesday, October 31, 2000 4:26:23 PM\ntoLocaleDateString: Tuesday, October 31, 2000\ntoLocaleTimeString: 4:26:23 PM\ntoDateString: Tue Oct 31 2000\ntoTimeString: 16:26:23 PST \n\n\nmonkey output:\n\ntoString: Tue Oct 31 09:41:40 GMT-0800 (PST) 2000\ntoGMTString: Tue, 31 Oct 2000 17:41:40 GMT\ntoLocaleString: Tue Oct 31 09:41:40 2000\ntoLocaleDateString: 10/31/00\ntoLocaleTimeString: 09:41:40\ntoDateString: undefined  // Tue Oct 31 2000\ntoTimeString: undefined  // 09:41:40 GMT-0800 (PST)\n\n\nrhino output:\n\ntoString: Wed Nov 01 06:19:24 GMT-0800 (PST) 2000\ntoGMTString: Wed, 01 Nov 2000 14:19:24 GMT\ntoLocaleString: November 1, 2000 6:19:24 AM PST\ntoLocaleDateString: November 1, 2000\ntoLocaleTimeString: 6:19:24 AM PST\ntoDateString: Wed Nov 01 2000\ntoTimeString: 06:19:24 GMT-0800 (PST)\n\n\nLocale output is all over the map, but toDateString and toTimeString parallels\nthe toString format.  We add GMT-0800 (which ie lacks) to ensure parsability in\nthe absence of cross-platform tables for decoding time zone names.\n\nReview?  Is init-on-demand for the Date formatters OK with threading?Created attachment 18635\nadd missing date apisThe proposed patches look good as far as I can tell. Could you commit them?Fixes checked in.  Also removed unused isFinite function.Testcases added to JS test suite for ECMA3 sections 15.9.5.3 to 15.9.5.7: \n\n\n           js/tests/ecma_3/Date/15.9.5.3.js - 15.9.5.7.js\n\n\nVerified  on Linux and WinNT -',?,SPEC
58118,'ECMA Compliance: daylight savings time wrong prior to year 1',Rhino,Core,david,igor,'Rhino computes daylight savings time wrong for years before 1AD\nIt appears to never recognize daylight savings time before year 1.\n\noxymoron:44 \% java -jar js.jar\njs> d = new Date(2000,6)\nSat Jul 01 00:00:00 GMT-0700 (PDT) 2000\njs> d.setFullYear(1900)                  \n-2193325200000\njs> d\nSun Jul 01 00:00:00 GMT-0700 (PDT) 1900\njs> d.setFullYear(0)\n-62151465600000\njs> d\nSat Jul 01 00:00:00 GMT-0800 (PST) 0000\njs> d.setFullYear(-1000)\n-93708460800000\njs> d\nTue Jul 01 00:00:00 GMT-0800 (PST) -1000\njs> d.getTimezoneOffset()\n480\njs> d.setFullYear(2000)\n962434800000\njs> d\nSat Jul 01 00:00:00 GMT-0700 (PDT) 2000\njs> d.getTimezoneOffset()\n420\n\nSee section 15.9.1.8 of the ECMA v3 spec, which says that the daylight\nsavings time adjustment should be applied to all dates, regardless of year.\nThat is, there should be no attempt to track the actual historical definitions\nand adoption of daylight savings time.\n\nSee also bug #58116: spidermonkey has a similar bug for years before 1970Here is the ECMA section:\n\n\n15.9.1.8 Daylight Saving Time Adjustment\n\nAn implementation of ECMAScript is expected to determine the daylight saving time \nalgorithm. The algorithm to determine the daylight saving time adjustment \nDaylightSavingTA(t), measured in milliseconds, must depend only on four things:\n\n(1) the time since the beginning of the year    \n          t ? TimeFromYear(YearFromTime(t))\n(2) whether t is in a leap year                 \n          InLeapYear(t)\n(3) the week day of the beginning of the year\n          WeekDay(TimeFromYear(YearFromTime(t))\nand\n(4) the geographic location.\n\nThe implementation of ECMAScript should not try to determine whether the exact \ntime was subject to daylight saving time, but just whether daylight saving time \nwould have been in effect if the current daylight saving time algorithm had been \nused at the time. This avoids complications such as taking into account the years \nthat the locale observed daylight saving time year round.\n\nIf the host environment provides functionality for determining daylight saving \ntime, the implementation of ECMAScript is free to map the year in question to \nan equivalent year (same leap-year-ness and same starting week day for the year) \nfor which the host environment provides daylight saving time information. The \nonly restriction is that all equivalent years should produce the same result.\nMike, do you want this one, too?Sure!  I just got the Spider Monkey counterpart.Created attachment 20284\nproposed fix; new EquivalentYear function.A little discussion of EquivalentYear is in 58116.\n\nWith the same EquivalentYear fix in Spider Monkey, Rhino\'s (java\'s) current\nnotion of daylight savings begins differing from that of Spider Monkey in 1581! \n(before, of course, giving up the ghost at year 0.)  Since there pretty likely\nwasn\'t daylight savings in 1581, I think this patch probably gives more-correct\nbehavior.\n\nThey match out to year 4000, so I think I got the mod 400 leap year behavior\nright.Created attachment 20287\nupdated version of last patch, also gets equiv. year before formatting timezone.CCing Norris.Reassigning Mike\'s Rhino bugs to Patrick, as per recent meeting - I look at the patchCreated attachment 144946\nPatch update to reflect code evolution during past 3 yearsCreated attachment 145081\nPatch update to include only essential changesI committed the patch',?,SPEC
58120,'Date.setYear() modifies the time',Rhino,Core,david,mike+mozilla,'Date.setYear() modifies the time as well as the year:\n\noxymoron:47 \% java -jar js.jar\njs> d = new Date()\nThu Oct 26 14:41:50 GMT-0700 (PDT) 2000\njs> d.setYear(2000)\n972621710313\njs> d\nThu Oct 26 21:41:50 GMT-0700 (PDT) 2000\n\nNote that the time changes by 7 hours (which is the difference between\nlocal time and UTC time).  I think this behavior is incorrect, and it\ndiffers from the behavior of spidermonkey.\n\nSee ECMA v3, section B.2.5 (in appendix B, since this is a deprecated method)I\'ll look at this.Here is the ECMA section:\n\nB.2.5 Date.prototype.setYear(year)\n\nNOTE The setFullYear method is preferred for nearly all purposes, \nbecause it avoids the ?year 2000 problem.?\n\n\nWhen the setYear method is called with one argument year the following steps \nare taken:\n\n1. Let t be the result of LocalTime(this time value); but if this time value is      \n   NaN, let t be +0.\n2. Call ToNumber(year).\n3. If Result(2) is NaN, set the [[Value]] property of the this value to NaN \n   and return NaN.\n4. If Result(2) is not NaN and 0 ? ToInteger(Result(2)) ? 99 then Result(4) is  \n   ToInteger(Result(2)) + 1900. Otherwise, Result(4) is Result(2).\n5. Compute MakeDay(Result(4), MonthFromTime(t), DateFromTime(t)).\n6. Compute UTC(MakeDate(Result(5), TimeWithinDay(t))).\n7. Set the [[Value]] property of the this value to TimeClip(Result(6)).\n8. Return the value of the [[Value]] property of the this value.\nYep, this is busted.  Sorry for not resolving it earlier - at first glance, I\nthought it might be related to a daylight savings transition - points at which\nunintuitive behavior can occur.\n\nWe\'re missing a LocalTime call.  Thanks for catching this.Created attachment 20289\nadd local time adjustment.Fix checked in.',?,BUG
58479,'functions defined within conditional phrases are always created.',Rhino,Core,dnavas,norrisboyd,'This causes /mozilla/js/tests/js1_2/Array/tostring_2.js to fail\nbecause the test thinks it\'s always running a 1.2 version of JS.\nTo wit:\n    var VERSION = \"JS_12\";\n\n    .\n    .\n    .\n    if ( typeof version == \"function\" ) {\n        writeLineToLog(\"version 120\");\n        version(120);\n        VERSION = \"120\";\n    } else {\n        writeLineToLog(typeof version);\n        function version() { return 0; };\n    }\n\n    testcases[tc++] = new TestCase ( SECTION,\n        \"a.toString()\",\n        ( VERSION == \"120\" ? \"[]\" : \"\" ),\n            a.toString() );\n\nThe current Interpreter creates a version() function always, and then\nruns the test to see if one already exists, which is the wrong order,\nsadly.Fixed. The name should now be created only when the conditional is executed.Could someone help me out on this one? If I simply go into the JS shell,\n(SpiderMonkey or Rhino), I see this:\n\n\njs> typeof version\nfunction\n\n\nSo I don\'t follow what\'s going on here. It looks like \"version\" is an inbuilt \nfunction property of the global object. Isn\'t it supposed to be? How could the \ntestcase ever have fallen into the \"else\" case above? \n\n\nDavid, what was the failure message you were getting from the test? \nDid you have to alter the test in any way to see the failure? \nI just need to know how to test this \"before\" and \"after\" the fix.\n\n\nThanks - I\'m lost on this one\nAs far as I can tell, version() should only be a function if you\'re running \nV120.  In other versions, apparently version() is unbound.\n\nTo test this, try changing the reference to \'version\' to something else -- \nsomething that isn\'t defined.  Rhino [15b1, at least -- Norris seemed to \nindicate the problem existed in 15r1 as well] defines the function in\nthe \'else\' clause regardless of program flow.  BTW, when I run SeaMonkey [PR3],\nI get \"Error: version is not defined\" in the javascript console, which is what \nI expect to see, so I\'m confused how you\'re seeing version() defined in \nSeaMonkey....\nPhil, yes, the \"version\" function is defined in the shell, but not in the \nbrowser. That\'s actually what this piece of code is trying to do is detect\nwhether the code is executing inside the shell or the browser.\n\nDavid\'s suggestion about using a variable other than \"version\" is a good one.\n\nBTW, are you creating new test cases for this and all of david@orielly.com\'s \nbugs?Thanks for the explanations -\n\nYes, I will be adding testcases this week. I\'ve been behind in doing this\nwhile I\'ve been doing the triaging, but expect to catch up this week.Following David\'s suggestion, I\'m using an arbitrary variable name in his test.\nUsing Rhino on WinNT built 2000-10-23, I now see the bug:\n\n\nTHIS TEST FAILED (USING FUNCTION LITERAL): \n\nvar res = (typeof(non_existing_function));\n\nif (res == \'function\') \n{\n  print(\'\\ntest FAILED - typeof(non_existing_function) = \'  +  res +  \'\\n\');\n} \nelse \n{       \n  var f = function non_existing_function() { return 0; };\n  print(\'\\ntest PASSED - typeof(non_existing_function) = \'  +  res  +  \'\\n\');\n}\n\nOUTPUT: \ntest FAILED - typeof(non_existing_function) = function\n\n\n\n\nTHIS TEST PASSED (USING FUNCTION CONSTRUCTOR):\n\nvar res = (typeof(non_existing_function));\n\nif (res == \'function\' ) \n{\n  print(\'\\ntest FAILED - typeof(non_existing_function) = \'  +  res +  \'\\n\');\n} \nelse \n{       \n  non_existing_function =  new Function(\"return 0;\");\n  print(\'\\ntest PASSED - typeof(non_existing_function) = \'  +  res  +  \'\\n\');\n}\n\nOUTPUT: \ntest PASSED - typeof(non_existing_function) = undefined\n It works for me with both the interpreted and compiled modes. Did you build\nwith the atest source?No: I was using Rhino on WinNT built 2000-10-23 to benchmark \"before/after\".\nUsing Rhino on WinNT and Linux built 2000-10-31, both tests pass.\n\n\nI tried the tests against both the interpreted and compiled modes of Rhino.\n\n                      On WinNT:  JDK 1.2.2\n                      On Linux:  JDK 1.1.8\n\n\nMarking Verified. The tests will be added to the test suite.I could not for the life of me get this to work in compiled mode until I\nchanged the following in Codegen.java (around line 1350):\n\n<             // load boolean indicating whether fn name should be set in scope\n<             boolean setFnName = str != null && str.length() > 0 &&\n<                                 ((FunctionNode) def).getFunctionType() !=\n<                                     FunctionNode.FUNCTION_EXPRESSION;\n\nto:\n\n>             // load boolean indicating whether fn name should be set in scope\n>             boolean setFnName = str != null && str.length() > 0 &&\n>                                 ((FunctionNode) def).getFunctionType() ==\n>                                     FunctionNode.FUNCTION_STATEMENT;\n\nI think this was a typo...?\nWhat\'s your test case? I always have to go back and puzzle over ECMA to\nfigure these out.I believe if you take Phil\'s case and remove the \'var f = \' in front of the \nfunction declaration, you\'ll see the failure.  Either the compiled version \nshouldn\'t fail, or the unoptimized version should.  Not sure which is right,\nbut if it\'s the latter, then there\'s a whole slew of testcases under \nmozilla/js/tests that need to be looked at :(\n\n-Dave\nChecked in the suggested change--thanks.',?,BUG
60093,'series of try {} catch() doesn\'t work',Rhino,Core,dnavas,norrisboyd,'The problem appears to be simple (and I hope not a result of my merge ;^/).\nThe ENDTRY instruction decrements the tryStackTop.  So does the actual \nexception handling code at the bottom of the interpret() function.  The \nfollowing fails:\n    try\n    {\n        throw SOME_EXCEPTION;\n    } catch (e) {}\n    try\n    {\n        throw SOME_EXCEPTION;\n    } catch(e) {}\n\nbecause when the second TRY begins, the tryStackTop is -1.\n\nThe problem appears to be with the generateICode().  There is a comparison \nbetween nextSibling and catchTarget and nextSibling and finallyTarget.  If it \nmatches one of them, then the ENDTRY is added.  But, nextSibling and \nfinallyTarget can be null!  Also, if the ENDTRY has already been added for the \ncatchTarget, you don\'t want to add one again before the finallyTarget (which \nmay or may not exist, but will always match nextSibling once...).\n\nThe hack I used was to set a boolean before the while() loop, initialized to \nfalse.  I made the conditional additionally check for falsity of the boolean \nflag, and inside the body set the boolean flag to true.  That way, only one \nENDTRY statement is added....\n\nSeems to work.Can you attach the diff for your change?\n\nThanks!Proposed patch:\n\nIndex: Interpreter.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.37\ndiff -u -r1.37 Interpreter.java\n--- Interpreter.java    2000/11/20 16:16:32     1.37\n+++ Interpreter.java    2000/12/01 15:17:33\n@@ -241,8 +241,7 @@\n                                         + node.toString());\n     }\n\n-    private int generateICode(Node node, int iCodeTop)\n-    {\n+    private int generateICode(Node node, int iCodeTop) {\n         int type = node.getType();\n         Node child = node.getFirstChild();\n         Node firstChild = child;\n@@ -860,8 +859,9 @@\n                             before that goto.\n                         */\n                         Node nextSibling = child.getNextSibling();\n-                        if (nextSibling == catchTarget ||\n-                            nextSibling == finallyTarget)\n+                        if (nextSibling != null &&\n+                            (nextSibling == catchTarget ||\n+                             nextSibling == finallyTarget))\n                         {\n                             iCodeTop = addByte((byte) TokenStream.ENDTRY,\n                                                iCodeTop);The only concern I have with that (and I apologize for not getting you a diff \nyet :( -- I only have a hack ;^/) is that the ENDTRY would seem to be added in \nthe catch clause for the following case:\n   try\n   {\n   }\n   catch () {}\n   finally {}\n\nWhen you\'re in the catch node, the next node is the finally node, and an\nendtry is added.  Don\'t think that\'s right -- you only want to add the ENDTRY \nonce.  I may be misremembering the code however, and if that\'s not the case,\nthen I see no problem with this.\nOk, thanks for pointing that out. How about the following, which I think is \nsimilar to what you did:\n\nIndex: Interpreter.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.37\ndiff -u -r1.37 Interpreter.java\n--- Interpreter.java\t2000/11/20 16:16:32\t1.37\n+++ Interpreter.java\t2000/12/01 15:53:32\n@@ -241,8 +241,7 @@\n                                         + node.toString());\n     }\n     \n-    private int generateICode(Node node, int iCodeTop)\n-    {\n+    private int generateICode(Node node, int iCodeTop) {\n         int type = node.getType();\n         Node child = node.getFirstChild();\n         Node firstChild = child;\n@@ -846,6 +845,7 @@\n                         set the stackDepth to 1 to account for the incoming\n                         exception object.\n                     */\n+                    boolean insertedEndTry = false;\n                     while (child != null) {\n                         if (catchTarget != null && lastChild == catchTarget) {\n                             itsStackDepth = 1;\n@@ -860,11 +860,13 @@\n                             before that goto.\n                         */\n                         Node nextSibling = child.getNextSibling();\n-                        if (nextSibling == catchTarget ||\n-                            nextSibling == finallyTarget)\n+                        if (!insertedEndTry && nextSibling != null &&\n+                            (nextSibling == catchTarget ||\n+                             nextSibling == finallyTarget))\n                         {\n                             iCodeTop = addByte((byte) TokenStream.ENDTRY,\n                                                iCodeTop);\n+                            insertedEndTry = true;\n                         }\n                         iCodeTop = generateICode(child, iCodeTop);\n                         lastChild = child;\n\nI verified that only one ENDTRY gets added for the snippet in the last comment.\n\nCommitted that change:\n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/Interpreter.java,v  <--  Interp\nreter.java\nnew revision: 1.38; previous revision: 1.37\ndoneThis is nearly identical to what I did.',?,BUG
60184,'Functions created in wrong scope',Rhino,Core,dnavas,norrisboyd,'To recreate, run the mozilla/js/tests/ecma/FunctionObjects/15.3.1.1-3 test.\n\nTypos (possibly merge problem on my end, apologies if true):\n    FunctionObject does not set Context\'s ctorScope in the call() method\n        when paramslength is < 0, like it does in the constructor.\n    NativeFunction\'s jsConstructor uses the global scope as the scope of the\n        created function.  Shouldn\'t it use scope rather than global as the\n        parentScope of the function?  I would have thought that the scope\n        for the function was a matter of where it was created....\n\nChanging both of these allows this test to pass in Rhino as it does in mozilla.\n\nNote: if Rhino\'s testing harness runs the test in the global scope, I suppose \nthe test won\'t actually fail....  We\'re running the tests where the scope that \nthe test code runs in is NOT the global scope....Could you post a proposed patch using diff -u? Sounds like you already \nfixed the problem in your local copy.\n\nThanks!Line-numbers are off -- I\'ve been making some mods to the engine to support \nsome of our needs, but here\'s the two parts of the diffs you\'re likely \ninterested in:\nNativeFunction.java:\n@@ -910,7 +916,7 @@\n             fn.names = new String[1];\n         fn.names[0] = \"anonymous\";\n         fn.setPrototype(getFunctionPrototype(global));\n-        fn.setParentScope(global);\n+        fn.setParentScope(scope);\n\n         return fn;\n     }\n\nFunctionObject.java (using -u4)\n     public Object call(Context cx, Scriptable scope, Scriptable thisObj,\n                        Object[] args)\n         throws JavaScriptException\n     {\n+//System.out.println(\"Calling: \" + method.getName() + \" on: \" + thisObj.getClas\ns().getName());\n         if (parmsLength < 0)\n-            return callVarargs(cx, thisObj, args, false);\n+        {\n+            cx.ctorScope = scope;\n+            Object result = callVarargs(cx, thisObj, args, false);\n+            cx.ctorScope = null;\n+\n+            return result;\n+        }\n\n\nYou can ignore my printlns ovbiously :-)\n\nYou\'re right that our standard testing setup runs this test in the global scope,\nso we don\'t fail this test with the current code.\n\nI\'m a little confused as I look at this more. Does the scope you run the code\nin have a parent scope? ECMA specifically states that the scope chain for\nthe function consists of the global scope only. With your change I get the\nfollowing behavior, which I think is non-ECMA:\n\njs> function f(a) { with (a) { return new Function(\"return y\"); } };\njs> x = f({y:3})\n\nfunction anonymous() {\n    return y;\n}\n\njs> y = 7\n7\njs> x()\n3\n\nI believe this last call should return 7, not 3, which is the behavior before \nthe change.Well, if Ecma says the scope should be the global scope, then so be it :-)\n\nHmm, maybe NativeFunction doesn\'t need to change, then.\n\nHere\'s the scope setup I see:\n\n    Window1 --> [proto] Window2 --> [parent] object --> [parent] null\n            --> [parent] null\n\nThe scope we run the test in does not have a direct parent scope -- I believe \nthat\'s the way you\'ve documented to allow reuse of the standard objects, yes?  \n\nMyFunc gets added as a property of Window.  The function itself wants to access\nMyFunc -- and it can\'t be found when the function is run.  However, I believe\nthat the fix is then purely the change in FunctionObject.\n\nIndeed, removing the change to NativeFunction allows the test to continue to \npass.  My bad.\nOkay, the FunctionObject change by itself makes sense--I see the code path\nthrough Function-as-a-call to Function-as-a-constructor.\n\nI\'ll run regressions on this and commit it if there are no problems. I\'ve\nadded your name to the list of contributors.\n\nThanks!Checked in FunctionObject change. Thanks!Norris, is there a test I should add for this? I\'m out of my depth on this\nbug, so if you have one, I\'ll add it to the suite - This one isn\'t possible to test for with the js shell. I\'d recommend not \nwriting a regression test for it.',?,BUG
60235,'Cannot override existing methods in new instances of sealed classes',Rhino,Core,dnavas,norrisboyd,'I\'m not sure if this is intended behavior or not -- it\'s odd if it\'s intended, \nas it makes it difficult to use sealed classes, but anyway....\n\nIf you create a sealed class, you cannot create an object whose prototype is \nthat sealed class and override a method that was originally declared in the \nsealed class.\n\nI changed this by doing the following, but I don\'t know what the definition of\nsealed is.  I can see why it\'s a gray area, but if sealed objects are supposed \nto represent reusable prototypes, don\'t you need to override methods like \ntoString(), etc?\n\n\nIndex: ScriptableObject.java\n===================================================================\nRCS file: /src/master/org/mozilla/javascript/ScriptableObject.java,v\nretrieving revision 1.3\ndiff -u -r1.3 ScriptableObject.java\n--- ScriptableObject.java       2000/11/04 00:10:09     1.3\n+++ ScriptableObject.java       2000/11/15 21:44:29\n@@ -226,7 +226,19 @@\n         }\n         Slot slot = slots[slotIndex];\n         if ((slot.attributes & ScriptableObject.READONLY) != 0)\n-            return;\n+        {\n+            // Allow function override, even if functions are sealed!\n+            // Note that we can override a function to point to void or an actu\nal property value,\n+            // we should really check the existing value if we want to just sea\nl functions.\n+            // We don\'t want to make readonly properties settable, now, do we?!\n\n+            // [Properties like Math.PI, etc...]\n+//System.out.println(\"Setting: \" + name + \" to: \" + value + \" on: \" + start + \"\n for: \" + this);\n+            if ( start == this || !(slot.value instanceof Function)\n+             ||  ((slot.flags & (Slot.HAS_SETTER|Slot.HAS_GETTER)) != 0) )\n+            {\n+                return;\n+            }\n+        }\n         if ((slot.flags & Slot.HAS_SETTER) != 0) {\n             GetterSlot getterSlot = (GetterSlot) slot;\n             try {As a result of changes in sealed semantics, see bug 203013, one can now\noverrides properties from object\'s prototype even if the prototype is sealed.\nMarking Verified - see bug 203013.Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
61226,'JavaAdapter masks inherited methods if they implement an interface',Rhino,Core,rade,norrisboyd,'Take the following class and interface\n\npublic class B {\n    public String m2() { return \"m2\"; }\n    public String m4() { return \"m4\"; }\n}\n\npublic interface C {\n    public String m2();\n    public String m3();\n}\n\nNow try to execute the following js code:\n\nfunction F() {}\nF.prototype.m3 = function() { return \"m3\"; }\n\nvar f = new JavaAdapter(Packages.B, new F());\nf.m2(); //succeeds\nvar f = new JavaAdapter(Packages.B,Packages.C, new F());\nf.m2(); //fails\n\n\nThe problem is that JavaAdapter will generate override-methods for all methods \ndefined on any interface *regardless* of whether they are actually defined by \nthe JS object. The override masks the implementation of m2 in B.Created attachment 19734\nthis patch fixes the problemaccepted patch--thanksKurt Westerfeld discovered that this change causes a regression in some \nJavaAdapter behavior he was depending on:\n\nSubject: \n        Rhino\'s Interpreted Mode vs. Compiled Mode and Dynamic Scopes\n   Date: \n        Mon, 1 Jan 2001 17:10:58 -0500\n   From: \n        \"Kurt Westerfeld\" <kurt@managedobjects.com>\n     To: \n        \"Norris Boyd\" <nboyd@atg.com>\n\n\n\n\nI am having very reproducible problems with using dynamic scopes and rhino when \ndealing with code that is\ngenerated via the Java Adapter (for swing/awt event handlers).  Event handlers I \nam creating using JavaAdapter\nare failing to find globally scoped variables whenever run in compiled form and \ndynamic scopes are on. \nHowever, the same code works fine in interpreted mode.\n \nI was going to try to make a little example here, but first I\'d like to give you \nan example that used to work with\nRhino but now doesn\'t:\n\n     this.foo = \'bar\'\n\n     var d = new java.awt.Dialog( new java.awt.Frame(), \'Tester\', true )\n     d.addWindowListener\n     (\n        new java.awt.event.WindowListener()\n        {\n           windowClosing: function( evt )\n           {\n              // Fails?\n              java.lang.System.out.println( \'Value of foo: \' + foo )\n              d.setVisible( false )\n           }\n        }\n     )\n     d.setVisible( true )\n\nThis was an attempt to show you the dynamic scope problem, but the JavaAdapter \nactually fails to implement\nthe java.awt.event.WindowListener interface properly (it doesn\'t produce all the \ninterface members any more).\n \nSo, here\'s a fixed version, to show you the dynamic scope problem:\n\n     this.foo = \'bar\'\n\n     var d = new java.awt.Dialog( new java.awt.Frame(), \'Tester\', true )\n     d.addWindowListener\n     (\n        new java.awt.event.WindowListener()\n        {\n           windowClosing: function( evt )\n           {\n              // Fails?\n              java.lang.System.out.println( \'Value of foo: \' +  foo )\n              d.setVisible( false )\n           },\n           windowOpened: function( evt ) {},        // Note: all interface \nmembers now required?\n           windowClosed: function( evt ) {},\n           windowActivated: function( evt ) {},\n           windowDeactivated: function( evt ) {},\n           windowIconified: function( evt ) {},\n           windowDeiconified: function( evt ) {},\n        }\n     )\n     d.setVisible( true )\n\nSo, \"foo\" can\'t be found if the scope of the environment is setup in conjunction \nwith dynamic scopes.  I\'m not\nsure why, but there it is.\n \nI believe I turned on dynamic scopes because I am populating a shared global \nscope chain, with an importer\ntop-level, and then another scope whose parent is the importer top-level where \nour statically-defined\n\"embedding extensions\" are defined.  Finally, the read-write \"global\" scope  is \ncreated and it\'s parent is set to\nthe embedding scope.\n \nBut, I don\'t think I need dynamic scopes now because all the embedding does is \npopulate with Scriptable (all\nJava native) objects.  This subject is still a little confusing to me, and I \ndon\'t think things are working 100\% in\nmy implementation.\n \nAny help you can provide would be great.\n \n________________________________________________________________________\n  Kurt Westerfeld\n  Senior Software Architect\n  Managed Objects\n  mailto:kwester@ManagedObjects.com\n  703.770.7225\n  http://www.ManagedObjects.com\n \n  Managed Objects: manage technology > rule business\n\n\n\n\nCreated attachment 21563\nproposed patchMarking as fixed as the patch was committed long time ago.Trageting as resolved against 1.5R5Fixing wrong milestone assignment',?,BUG
61267,'ECMAScript compliance: passing a RegExp to the RegExp() constructor',Rhino,Core,david,rogerl,'Rhino has the same bug as spidermonkey, see bug #61266Fixed:\n\nChecking in regexp/NativeRegExp.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/regexp/NativeRegExp.java,v  <--\n  NativeRegExp.java\nnew revision: 1.23; previous revision: 1.22\ndone(crossed signals - we were both looking at this!)\n\nDavid pointed out another aspect of conformance to the spec in 61266; RegExp\ncalled as a function with a RegExp argument should return the RegExp, also\nthrowing a typeerror if the flags argument is specified.\n\n(For strict conformance, we should be checking against not supplied -or-\nundefined; passing void 0 should be OK.  args[1] != Undefined.instance)\n\nAlso the message needs to be internationalized.  (When I fixed it in my tree, I\njust reused msg.bad.param.)Does your fix address all of these? If so, just back out my fix and check \nyours in. \n\nAnd next time don\'t be afraid just reassign the bug to yourself so we avoid\nduplication of effor.\n\nThanks,\nNorrisTestcases in js/tests/ecma_3/RegExp are failing in Rhino for these reasons:\n\n\n1. Passing a RegExp object to the RegExp() function is not returning the object\n2. undefined is not being accepted as a valid flag parameter for RegExp()\n3. RegExp() is segfaulting if either its pattern or flag parameter is invalid\n\n\nReassigning to rogerl, who has just fixed these same problems in SpiderMonkey.Created attachment 20495\nmy Rhino test results for js/tests/ecma_3/RegExp/Mike, do you have a fix for these problems?If I had a fix, I misplaced it!\n\nRoger and I just flipped for this, and he got it.EEK!!! Apologies to everyone - I did not have the most recent Rhino source... \n\nAll tests in js/tests/ecma_3/RegExp are passing in Rhino(both in compiled mode \nand interpreted mode) on these platforms:\n\n\n                         WinNT   JDK 1.2.2\n                         Linux   JDK 1.1.8\n\n\nAll three issues I mentioned above at 2000-12-11 16:03 seem to have been\naddressed. Does this sound right - and is this bug ready to close, then?  \n\n\ncc\'ing Norris - Yes, I checked in fixes for these problems today.Marking Verified -',?,SPEC
61979,'ClassCircularityError Loading org.mozilla.javascript.FunctionObject',Rhino,Core,ecattanach,norrisboyd,'Rhino 1.5\nJDK\'s Used Sun JDK 1.2.2/1.3 (Windows & Solaris)\n\nThe following error has been reproduced on both solaris and nt - it only \nhappens if you use the classic vm, its ok if hotspot is used.\n\nIf you are using your own class-loader and running under the classic vm when \nthe class org.mozilla.javascript.FunctionObject is loaded you get the following \nexception java.lang.ClassCircularityError.\n\nThis is not technically a problem with the rhino product and is in fact a bug \nin the java classic vm it can be simply resolved as follows:\n\n\nFile:org.mozilla.javascript.ScriptableObject\n\nMake the classes Slot and GetterSlot private static inner classes.\n\nI have changed the file locally and the above fix resolved the problem.So a change like the following is what works for you?\n\nIndex: ScriptableObject.java\n===================================================================\nRCS file: \n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptableObject.java,v\nretrieving revision 1.25\ndiff -u -r1.25 ScriptableObject.java\n--- ScriptableObject.java\t2000/11/27 17:46:56\t1.25\n+++ ScriptableObject.java\t2000/12/05 14:38:19\n@@ -1775,25 +1774,23 @@\n     private String lastName;\n     private int lastHash;\n     private Object lastValue = REMOVED;\n-}\n \n+    private static class Slot {\n+        static final int HAS_GETTER  = 0x01;\n+        static final int HAS_SETTER  = 0x02;\n+        \n+        int intKey;\n+        String stringKey;\n+        Object value;\n+        short attributes;\n+        short flags;\n+    }\n \n-class Slot {\n-    static final int HAS_GETTER  = 0x01;\n-    static final int HAS_SETTER  = 0x02;\n-    \n-    int intKey;\n-    String stringKey;\n-    Object value;\n-    short attributes;\n-    short flags;\n-}\n+    private static class GetterSlot extends Slot {\n+        Object delegateTo;  // OPT: merge with \"value\"\n+        Method getter;\n+        Method setter;\n+        boolean setterReturnsValue;\n+    }\n \n-class GetterSlot extends Slot {\n-    Object delegateTo;  // OPT: merge with \"value\"\n-    Method getter;\n-    Method setter;\n-    boolean setterReturnsValue;\n }\n-\n-\nYes that is the change I made locally\nChecking in ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/ScriptableObject.java,v  <--  S\ncriptableObject.java\nnew revision: 1.26; previous revision: 1.25\ndoneMarking Verified - ',?,IMPROVEMENT
62559,'Large negative numbers not processed correctly',Rhino,Core,norrisboyd,norrisboyd,'Subject: \n            Re: Fixes for org/mozilla/ScriptRuntime.java, indexFromString method\n       Date: \n            Wed, 06 Dec 2000 18:31:35 +0100\n      From: \n            Igor Bukanov <igor@icesoft.no>\n        To: \n            Norris Boyd <nboyd@atg.com>\n References: \n            1 , 2\n\n\n\n\nNorris Boyd wrote:\n\n> Thanks for the patch. Could you give me a unified diff? My version of patch\n> doesn\'t seem to like the context diff you sent.\n> \n> Also, could you give me an example that is fixed with your change--that way we\n> can add a regression test.\n> \n> Thanks,\n> Norris\n\nIn the attached files.zip you will find:\n\n1. context.patch, produced via\ndiff -c ScriptRuntime.java.orig ScriptRuntime.java\n\n2. unified.patch, produced via\ndiff ScriptRuntime.java.orig ScriptRuntime.java\n\n3. ScriptRuntime.java, the modified file itself\n\n4. test_index.js, the test file to show the problem\n\nHere is the test code:\n\nfunction debug(str) {\njava.lang.System.out.println(str);\n}\n\nfunction do_test(number) {\nvar index_test = new Object();\nindex_test[number] = 1;\nreturn index_test[number] == index_test[\"\" + number];\n\n}\n\nvar MIN_INT = -2147483648;\n\ndebug(do_test(111));\ndebug(do_test(MIN_INT));\n\n\nThis should print true, true but without the fix you will get true, \nfalse because \"-2147483648\" is not treated as -2147483648.\n\nRegards, IgorCreated attachment 20471\nIgor\'s filesFix checked in',?,BUG
64149,'Rhino should accept (and warn about) 008, etc.',Rhino,Compiler,mike+mozilla,mike+mozilla,'Brendan put scan changes in the Monkey for bug 49233 to clean up the\n08-is-decimal special case and extend it to accept 008, etc.  Rhino needs\nsimilar changes to stay in parity.Created attachment 21635\nproposed fixFixing Norris CC.\n\nI just noticed that the Rhino shell still needs -w to enable warnings.  I\nchanged the js shell to issue warnings by default, with -W to disable them...\nwould that be appropriate to the Rhino shell?Lexer tests all pass; fix checked in.Verified on WinNT and Linux -',?,SPEC
64285,'Regexp changes for SpiderMonkey needed in Rhino',Rhino,Core,norrisboyd,rogerl,'The changes put into SpiderMonkey for bug 57572 are needed in Rhino. \n\npschwartau\'s comments from that bug:\n\nAdded testcase to JS test suite:\n\n             js/tests/ecma_3/RegExp/regress-57572.js\n\n\nThis testcase is currently passing on SpiderMonkey, but parts of it \nare failing in Rhino. Specifically:\n\n\nCASE A     pattern = /^(\\S+)?( ?)(B+)$/;  //single space before second \"?\" \n           string = \'AAABBB\';             //no spaces in given string\n           actual = string.match(pattern);\n           expect = Array(string, \'AAABB\', cnEmptyString, \'B\');\n\n\nIn Rhino:  string.match(pattern) === null \n\n\n\nCASE B     pattern = /(.+)?(!?)(!+)/;\n           string = \'WOW !!! !!!\';\n           actual = string.match(pattern);\n           expect = Array(string, \'WOW !!! !!\', cnEmptyString,  \'!\');\n\n\nIn Rhino:  string.match(pattern) = (\"!!!\", \"!!! !!!\", \"!\",  \"!!\")\n           This is especially strange: although matches are being produced, \n           the first term in the match array is not the given string.Fix checked in.Reopening. I\'m getting these failures on WinNT:\n\n\nTestcase ecma_3/RegExp/regress-24712.js failed Bug Number 24712\nFailure messages were:\n FAILED!: [reported from test()] exec() returned null.\n\n\nTestcase ecma_3/RegExp/regress-57572.js failed Bug Number 57572\nExpected exit code 0, got 3\nTestcase terminated with signal 0\nComplete testcase output was:\n BUGNUMBER: 57572\n STATUS: Testing regular expressions containing \"?\"\n js: uncaught JavaScript exception: TypeError: Cannot convert null to an object.\nCreated attachment 23080\nHTML version of new test results, with hyperlinksUh, oh - I notice from the test results that my WinNT box is now using JDK 1.3 -\n\n[/d/JS_TRUNK/mozilla/js/tests] java -fullversion\njava full version \"1.3.0_01\"\n\n\nI always used to have JDK 1.2.2, Recently, however, I downloaded \nthe Java2 Plugin, and I think this has given me JDK 1.3 -\n\n\nI\'m confused, because I watched for this at the time, and saw that\nmy JDK 1.2.2 directory still existed after the download. A separate\nJDK 1.3 directory was created under C:\\Program Files\\JavaSoft\\JRE\\.\n\n\nFurthermore, my PATH variable has not changed: \n                          etc. \n                          etc.\nC:/jdk1.2.2/bin: C:/Program Files/JavaSoft/JRE/1.2/bin:\n                          etc. \n                          etc.\n\n\nI have not been successful at using the \"-j\" option of the test driver\nto force it to use JDK 1.2.2. Also, I haven\'t been able to do it directly\nat the command line. I tried this (for readablity I\'ve added CR\'s):\n\n\"/Program Files/JavaSoft/JRE/1.2/bin/java\" \n    org.mozilla.javascript.tools.shell.Main \n       -f /d/JS_TRUNK/mozilla/js/tests/ecma_3/shell.js \n          -f /d/JS_TRUNK/mozilla/js/tests/ecma_3/RegExp/regress-57572.js\n\n\n\nBut I got these errors:\n\njs: Couldn\'t open file \"/d/JS_TRUNK/mozilla/js/tests/ecma_3/shell.js\".\njs: Couldn\'t open file \n\"/d/JS_TRUNK/mozilla/js/tests/ecma_3/RegExp/regress-57572.js\".\n\n\n\nThese are correct filepaths, however. For example: \n\n[/d/JS_TRUNK/mozilla/js/tests] ls /d/JS_TRUNK/mozilla/js/tests/ecma_3/shell.js\n/d/JS_TRUNK/mozilla/js/tests/ecma_3/shell.js\n\n\nAny ideas on what I\'m doing wrong? \n\n\nAnd WHY is my system going for JDK 1.3, when JDK 1.2.2 still exists,\nand is the only JDK listed in my PATH variable ???OK, think I got it this time - i\'d messed up on the merge in a couple of places.\n\n[Don\'t know why your java version has changed; maybe a registry entry points to \nthe actual VM?]Verified fixed. Tested js/tests/ecma_3/RegExp/ with optimized and interpreted \nbuilds of Rhino on:\n\n                           WinNT  (JDK 1.3)\n                           Linux  (JDK 1.1.8)',?,SPEC
64788,'Make method invocation 10x faster with following code....',Rhino,Core,dnavas,norrisboyd,'Method.invoke() is an NMI call (JNI in 1.3 and up) and is not replaced when \nusing the JIT.  That means that it\'s gawd-awful slow.  By replacing \nmethod.invoke() and getterSlot.getter.invoke() calls with on-the-fly generated \nstub code that calls the method in question directly, the invocation of methods \ncan be sped up by an order of magnitude (or 20x when running under 1.3).\n\nTo hook the code in, keep a MyMethod instance in the FunctionObject and \nGetterSlot.  You may want to only keep a MyMethod instance for getters (setters \ncan be slow, I would think, and may not warrant the extra space?).  You create \nthe instances on-the-fly or during construction -- both seem to work -- by \ncalling initializeMyMethod().  If you plan on creating instances on-the-fly, \nyou should review the FunctionObject constructor.  It modifies the parameter \ntypes so that primitive types aren\'t primitive types anymore.  There may have \noriginally been a reason for this code, but the parameter casting code checks \nboth the ScriptRuntime classes and the primitive type classes when deciding how \nto perform the cast, so I\'m not sure it needs to do that anymore.  <shrug>\nI\'ve removed that code without ill effect.\n\nI have the MyMethod class as a static member of the FunctionObject class -- you \nmay wish to change that.  You\'ll need to change some constants in the case.  \nI\'ve run the rhino regression suite and mozilla DOM tests, and they seem happy \nwith this change....\n\nCode for MyMethod (note, requires org.mozilla.classfile.* classes):\n    public abstract static class MyMethod\n    {\n        static int _classNumber = 0;\n        static Hashtable _myMethodHash = new Hashtable();\n        static JavaAdapter.MyClassLoader _classLoader = new \nJavaAdapter.MyClassLoader();\n            \n        public static MyMethod initializeMyMethod(Method method, Class[] types)\n        {\n            MyMethod result = (MyMethod)_myMethodHash.get(method);\n            \n            if ( result != null )\n                return result;\n                \n            int classNumber;\n            \n            synchronized(_myMethodHash)\n            {\n                classNumber = ++_classNumber;\n            }\n            \n            String className = \"js\" + classNumber;\n            ClassFileWriter cfw = new ClassFileWriter\n(className, \"org.mozilla.javascript.FunctionObject$MyMethod\", \"\");\n            cfw.setFlags((short)(ClassFileWriter.ACC_PUBLIC | \nClassFileWriter.ACC_FINAL));\n            \n            // Add our instantiator!\n            cfw.startMethod(\"<init>\", \"()V\", ClassFileWriter.ACC_PUBLIC);\n            cfw.add(ByteCode.ALOAD_0);\n            cfw.add\n(ByteCode.INVOKESPECIAL,\"org.mozilla.javascript.FunctionObject$MyMethod\",\n                    \"<init>\", \"()\", \"V\");\n            cfw.add(ByteCode.RETURN);\n            cfw.stopMethod((short)1, null); // one argument -- this???\n\n            // Add the invoke() method call\n            cfw.startMethod(\"invoke\", \"(Ljava/lang/Object;[Ljava/lang/Object;)\nLjava/lang/Object;\",\n                            (short)(ClassFileWriter.ACC_PUBLIC | \nClassFileWriter.ACC_FINAL));\n            \n            // If we return a primitive type, then do something special!\n            String declaringClassName = method.getDeclaringClass().getName\n().replace(\'.\', \'/\');\n            Class returnType = method.getReturnType();\n            String invokeSpecial = null;\n            String invokeSpecialType = null;\n            boolean returnsVoid = false;\n            boolean returnsBoolean = false;\n            \n            if ( returnType.isPrimitive() )\n            {\n                if ( returnType == Boolean.TYPE )\n                {\n                    returnsBoolean = true;\n                    invokeSpecialType = \"(Z)\";\n                }\n                else if ( returnType == Void.TYPE )\n                {\n                    returnsVoid = true;\n                    invokeSpecialType = \"(V)\";\n                }\n                else if ( returnType == Integer.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Integer\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(I)\";\n                }\n                else if ( returnType == Long.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Long\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(J)\";\n                }\n                else if ( returnType == Short.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Short\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(S)\";\n                }\n                else if ( returnType == Float.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Float\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(F)\";\n                }\n                else if ( returnType == Double.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Double\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(D)\";\n                }\n                else if ( returnType == Byte.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial = \"java/lang/Byte\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(B)\";\n                }\n                else if ( returnType == Character.TYPE )\n                {\n                    cfw.add(ByteCode.NEW, invokeSpecial \n= \"java/lang/Character\");\n                    cfw.add(ByteCode.DUP);\n                    invokeSpecialType = \"(C)\";\n                }\n            }\n            \n            // handle setup of call to virtual function (if calling non-static)\n            if ( !java.lang.reflect.Modifier.isStatic(method.getModifiers()) )\n            {\n                cfw.add(ByteCode.ALOAD_1);\n                cfw.add(ByteCode.CHECKCAST, declaringClassName);\n            }\n            \n            // Handle parameters!\n            StringBuffer params = new StringBuffer( 2 + ((types!=null)?(20 * \ntypes.length):0) );\n            \n            params.append(\"(\");\n            if ( types != null )\n            {\n                for(int i = 0; i < types.length; i++)\n                {\n                    Class type = types[i];\n\n                    cfw.add(ByteCode.ALOAD_2);\n                    \n                    if ( i <= 5) \n                    {\n                        cfw.add((byte) (ByteCode.ICONST_0 + i));\n                    }\n                    else if (i <= Byte.MAX_VALUE)\n                    {\n                        cfw.add(ByteCode.BIPUSH, i);\n                    }\n                    else if (i <= Short.MAX_VALUE)\n                    {\n                        cfw.add(ByteCode.SIPUSH, i);\n    \t            }\n    \t            else \n    \t            {\n    \t                cfw.addLoadConstant((int)i);\n    \t            }\n                    \n                    cfw.add(ByteCode.AALOAD);\n                    \n                    if ( type.isPrimitive() )\n                    {\n                        //Convert enclosed type back to primitive.\n                        \n                        if ( type == Boolean.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Boolean\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Boolean\", \"booleanValue\", \n                                    \"()\", \"Z\");\n                            params.append(\"Z\");\n                        }\n                        else if ( type == Integer.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Number\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Number\", \"intValue\", \n                                    \"()\", \"I\");\n                            params.append(\"I\");\n                        }\n                        else if ( type == Short.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Number\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Number\", \"shortValue\", \n                                    \"()\", \"S\");\n                            params.append(\"S\");\n                        }\n                        else if ( type == Character.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Character\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Character\", \"charValue\", \n                                    \"()\", \"C\");\n                            params.append(\"C\");\n                        }\n                        else if ( type == Double.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Number\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Number\", \"doubleValue\", \n                                    \"()\", \"D\");\n                            params.append(\"D\");\n                        }\n                        else if ( type == Float.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Number\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Number\", \"floatValue\", \n                                    \"()\", \"F\");\n                            params.append(\"F\");\n                        }\n                        else if ( type == Byte.TYPE )\n                        {\n                            cfw.add(ByteCode.CHECKCAST, \"java/lang/Byte\");\n                            cfw.add\n(ByteCode.INVOKEVIRTUAL, \"java/lang/Byte\", \"byteValue\", \n                                    \"()\", \"B\");\n                            params.append(\"B\");\n                        }\n                    }\n                    else\n                    {\n                        String typeName = type.getName().replace(\'.\', \'/\');\n                        cfw.add(ByteCode.CHECKCAST, typeName);\n                        \n                        if ( !type.isArray() )\n                        {\n                            params.append(\'L\');\n                        }\n                        params.append(typeName);\n                        \n                        if ( !type.isArray() )\n                        {\n                            params.append(\';\');\n                        }\n                    }\n                }\n            }\n            params.append(\")\");\n            \n            // Call actual function!\n            if ( !java.lang.reflect.Modifier.isStatic(method.getModifiers()) )\n            {\n                cfw.add(ByteCode.INVOKEVIRTUAL, declaringClassName, \nmethod.getName(), params.toString(),\n                        (invokeSpecialType!=null?invokeSpecialType.substring\n(1,2)\n                                                :returnType.isArray()?\nreturnType.getName().replace(\'.\',\'/\')\n                                                                    :\"L\".concat\n(returnType.getName().replace(\'.\', \'/\').concat(\";\"))));\n            }\n            else\n            {\n                cfw.add(ByteCode.INVOKESTATIC, declaringClassName, \nmethod.getName(), params.toString(),\n                        (invokeSpecialType!=null?invokeSpecialType.substring\n(1,2)\n                                                :returnType.isArray()?\nreturnType.getName().replace(\'.\',\'/\')\n                                                                    :\"L\".concat\n(returnType.getName().replace(\'.\', \'/\').concat(\";\"))));\n            }\n            \n            // Handle return value;\n            if ( returnsVoid )\n            {\n                cfw.add(ByteCode.ACONST_NULL);\n                cfw.add(ByteCode.ARETURN);\n            }\n            else if ( returnsBoolean )\n            {\n                // HACK\n                //check to see if true;\n                // \'7\' is the number of bytes of the ifeq<branch> plus \ngetstatic<TRUE> plus areturn instructions\n                cfw.add(ByteCode.IFEQ, 7);\n                cfw.add(ByteCode.GETSTATIC,\n                        \"java/lang/Boolean\",\n                                \"TRUE\",\n                                \"Ljava/lang/Boolean;\");\n                cfw.add(ByteCode.ARETURN);\n                cfw.add(ByteCode.GETSTATIC,\n                        \"java/lang/Boolean\",\n                                \"FALSE\",\n                                \"Ljava/lang/Boolean;\");\n                cfw.add(ByteCode.ARETURN);\n            }\n            else if ( invokeSpecial != null )\n            {\n                cfw.add(ByteCode.INVOKESPECIAL,\n                            invokeSpecial,\n                            \"<init>\", invokeSpecialType, \"V\");\n                cfw.add(ByteCode.ARETURN);\n            }\n            else\n            {\n                cfw.add(ByteCode.ARETURN);\n            }\n            cfw.stopMethod((short)3, null); // three arguments, including the \nthis pointer???\n            \n            // Add class to our classloader.\n            java.io.ByteArrayOutputStream bos = new \njava.io.ByteArrayOutputStream(550);\n            \n            try\n            {\n                cfw.write(bos);\n            }\n            catch (Throwable t)\n            {\n                t.printStackTrace();\n            }\n            \n            try\n            {\n                byte [] bytes = bos.toByteArray();\n                Class clazz = _classLoader.defineClass(className, bytes);\n                result = (MyMethod)clazz.newInstance();\n                \n    //System.out.println(\"Generated method delegate for: \" + method.getName() \n+ \" on \" + method.getDeclaringClass().getName() + \" :: \" + params.toString() \n+ \" :: \" + types);\n                _myMethodHash.put(method, result);\n            }\n            catch (Throwable t)\n            {\n                t.printStackTrace();\n            }\n\n            return result;\n        }\n        \n        public abstract Object invoke(Object that, Object [] args);\n    }Fantastic! \n\nCould you send me a diff for FunctionObject.java that shows how you call it? \nI\'ve tried what I thought was obvious but it doesn\'t quite work.\n\nOkay, I\'ve got it running now. I\'m seeing no difference on BenchPress.js, but\nit doesn\'t call too many built-in functions. I made a simple test like \n\nfunction f() {\n        for (var i=0; i < 10000; i++) {\n                Math.abs(-1);\n        }\n}\nvar d = new Date();\nf();\nprint((new Date()) - d);\n\nI see a speedup of a little under 50\%. I\'ll attach my diff so you can see if I\nleft out something. (Still a nice performance boost.)Created attachment 22172\nproposed patch with recommended changesSorry to mislead -- the 10x performance is the performance boost seen from just \nthe .invoke() viewpoint, not the boost seen through the entire javascript \nfunction call process (which includes looking up the function to call, possibly \nthrough scope or prototype chains, retrieving the Context from a hashtable, \netc.).  Now, that would be too much to hope for!\n\nThe time spent in the test I was using decreased by about 30\% overall, iirc.  \nIf it helps, the .js I\'m using is:\n    http://pages.ebay.com/included/js/cobrand/links.js\n[yes, it would be easier to fix the javascript, but I don\'t have that \nluxury ;^/]\n\n\nLooked at the proposed changes, four comments:\n\n1) This diff has got to be wrong:\n+                    type == Boolean.TYPE &&\n+                    type == Byte.TYPE &&\n+                    type == Short.TYPE &&\n+                    type == Integer.TYPE &&\n+                    type == Float.TYPE && \n+                    type == Double.TYPE)\n\nThere\'s no way for that to ever be true!\nThe only thing I changed there was to remove these lines\n<                     types[i] = ScriptRuntime.BooleanClass;\n178d561\n<                     types[i] = ScriptRuntime.ByteClass;\n181d563\n<                     types[i] = ScriptRuntime.ShortClass;\n184d565\n<                     types[i] = ScriptRuntime.IntegerClass;\n187d567\n<                     types[i] = ScriptRuntime.FloatClass;\n190d569\n<                     types[i] = ScriptRuntime.DoubleClass;\n\n2) The constructor for FunctionObject sometimes nulls out the types\n   array (if there is no casting required).  I don\'t think your change took\n   that into account???  I grab the paramTypes of the method again if types\n   is null.  No biggie....\n\n3) There are two methods in FunctionObject, one in call() and one in\n   callVarargs(), that can use MyMethod\n\n4) There is one place in ScriptableObject (getter invoke) you might want to\n   consider as well.  Most of the code I was dealing with was actually calling\n   getters (getDocument(), getLinks(), getHref(), etc., as you might be able\n   to tell from the above .js file)\n\nI\'d send a FunctionObject diff to you, but I\'ve made so many tweaks to the\nfile at this point that it might call functions or reference classes that don\'t \nexist in your version (getParameterTypes() and NativeDelegate I think fall into \nthat category).  But, for what it\'s worth, aside from the MyMethod stuff I \nalready sent, and the import line:\n***************\n*** 171,194 ****\n                  {\n                      hasConversions = true;\n                  } else if (type == Boolean.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.BooleanClass;\n                  } else if (type == Byte.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.ByteClass;\n                  } else if (type == Short.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.ShortClass;\n                  } else if (type == Integer.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.IntegerClass;\n                  } else if (type == Float.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.FloatClass;\n                  } else if (type == Double.TYPE) {\n                      hasConversions = true;\n-                     types[i] = ScriptRuntime.DoubleClass;\n                  } else if ( type.isInterface() )\n                  {\n                      //Pretend like none is needed.\n                      //hasConversions = true;\n--- 556,573 ----\n***************\n*** 592,601 ****\n              if ( thisObj instanceof NativeDelegate )\n              {\n                  thisObj = thisObj.getPrototype();\n              }\n!             Object result = (method != null)\n!                             ? method.invoke(thisObj, invokeArgs)\n                              : ctor.newInstance(invokeArgs);\n              return hasVoidReturn ? Undefined.instance : result;\n          }\n          catch (InvocationTargetException e) {\n--- 971,986 ----\n              if ( thisObj instanceof NativeDelegate )\n              {\n                  thisObj = thisObj.getPrototype();\n              }\n!\n!             if ( myMethod == null && method != null)\n!             {\n!                 // Initialize the myMethod correctly!\n!                 myMethod = MyMethod.initializeMyMethod(method, (types==null?ge\ntParameterTypes(method):types));\n!             }\n!\n!             Object result = (myMethod!=null)? myMethod.invoke(thisObj, invokeA\nrgs)\n                              : ctor.newInstance(invokeArgs);\n              return hasVoidReturn ? Undefined.instance : result;\n          }\n          catch (InvocationTargetException e) {\n***************\n*** 661,677 ****\n          throws JavaScriptException\n      {\n          try {\n              if (parmsLength == VARARGS_METHOD) {\n!                 Object[] invokeArgs = { cx, thisObj, args, this };\n!                 Object result = method.invoke(null, invokeArgs);\n                  return hasVoidReturn ? Undefined.instance : result;\n              } else {\n                  Boolean b = inNewExpr ? Boolean.TRUE : Boolean.FALSE;\n!                 Object[] invokeArgs = { cx, args, this, b };\n!                 return (method == null)\n!                        ? ctor.newInstance(invokeArgs)\n!                        : method.invoke(null, invokeArgs);\n              }\n          }\n          catch (InvocationTargetException e) {\n              Throwable target = e.getTargetException();\n--- 1046,1073 ----\n          throws JavaScriptException\n      {\n          try {\n              if (parmsLength == VARARGS_METHOD) {\n!                 Object[] invokeArgs = cx.getStaticFunctionArgs( thisObj, args,\n this );\n!                 if ( myMethod == null)\n!                 {\n!                     // Initialize the myMethod correctly!\n!                     myMethod = MyMethod.initializeMyMethod(method, (types==nul\nl?getParameterTypes(method):types));\n!                 }\n!                 Object result = myMethod.invoke(null, invokeArgs);\n                  return hasVoidReturn ? Undefined.instance : result;\n              } else {\n                  Boolean b = inNewExpr ? Boolean.TRUE : Boolean.FALSE;\n!                 Object[] invokeArgs = cx.getStaticFunctionArgs( args, this, b\n);\n!\n!                 if ( myMethod == null && method != null)\n!                 {\n!                     // Initialize the myMethod correctly!\n!                     myMethod = MyMethod.initializeMyMethod(method, (types==nul\nl?getParameterTypes(method):types));\n!                 }\n!\n!                 return (myMethod!=null)?myMethod.invoke(null, invokeArgs)\n!                                        :ctor.newInstance(invokeArgs);\n              }\n          }\n          catch (InvocationTargetException e) {\n              Throwable target = e.getTargetException();\n***************\n*** 704,711 ****\n--- 1100,1108 ----\n      private static boolean sawSecurityException;\n\n      static Method[] methodsCache;\n\n+     MyMethod myMethod;\n      Method method;\n      Constructor ctor;\n      private Class[] types;\n      private short parmsLength;\n\nFixed:\n\nChecking in Context.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/Context.java,v  <--  Context.ja\nva\nnew revision: 1.47; previous revision: 1.46\ndone\nChecking in FunctionObject.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/FunctionObject.java,v  <--  Fun\nctionObject.java\nnew revision: 1.20; previous revision: 1.19\ndone\nChecking in JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAd\napter.java\nnew revision: 1.36; previous revision: 1.35\ndoneMarking Verified - ',?,IMPROVEMENT
68084,'Regular subexpressions followed by +, ? not running to completion',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 67773 in SpiderMonkey.\nHave added this regression testcase to the test suite:\n\n\n      js/tests/ecma_3/RegExp/regress-67773.js\n\n\nNote: this depends on a new shell.js file I have added: \n\n\n      js/tests/ecma_3/RegExp/shell.jsCreated attachment 27313\nFixes converted from 67773.With the latest rhino, rhinoi on WinNT, all tests in js/tests/ecma_3/RegExp/ \nare passing. It looks like a fix may have already been posted. See: \n\n\nhttp://bonsai.mozilla.org/cvsview2.cgi?diff_mode=context&whitespace_mode=show&fi\nle=NativeRegExp.java&root=/cvsroot&subdir=mozilla/js/rhino/org/mozilla/javascrip\nt/regexp&command=DIFF_FRAMESET&rev1=1.31&rev2=1.32Sure enough, cool! Since the tests pass I guess you can go ahead and close it \nout. Thanks.Resolving as FIXED - And marking Verified - ',?,BUG
72021,'The ScriptRuntime class tries to convert even the String values to JavaNativeObject',Rhino,Core,anup,norrisboyd,'The rhino script engine converts every java object that the application passes\n(if it is not a Scriptable object) to the JavaNativeObject. Our applaiction \npasses a String object to script runtime and it converts it to the \nNativeJavaObject. Now if the user tries to increment or decrement the string \nobject in the script the runtime callls the \"doubleValue\" method by default to \nconvert the string to number and this fails since there is no method \nnamed \"doubleValue\" implemented in the class String. \n\nHowever if the user directly declares a String object inside the script the \nscript runtime recognizes it as such and deals with it correctly. \n\nI think the script runtime should also recognize the String object returned by \nthe application that is using it. And should do the correct conversion to \nnumber and boolean in the same way that it does for the String objects defined \ninside the script.Created attachment 28699\nWorkaround suggestionI have come across the same problem. Below is a sample of scripts which will \nreproduce the problem when run in the Rhino shell Main:-\n\n   a = new java.lang.String(\"TEST\");\n   a <= \"TEST\";\n\nBelow is a work around by changing \'a\' to javascript string:-\n\n   a = new java.lang.String(\"TEST\");\n   b = new String(a);\n   b <= \"TEST\";\n\nIn the current Rhino tip it is possible to convert java.lang.String returned by\nJava methods directly to JS String via simple:\n\nContext cx = Context.enter();\ncx.getWrapFactory().setJavaPrimitiveWrap(false);\n\nSee API documentation for\norg.mozilla.javascript.WrapFactory#isJavaPrimitiveWrap() in the current tip for\ndetails.\n\nNote that this does not make to work:\na = new java.lang.String(\"TEST\");\na <= \"TEST\";\n\nas WrapFactory#setJavaPrimitiveWrap(boolean) does not affect explicit\nconstructor calls, but if one wish to completely replace Java String, he can\noverride WrapFactory#wrapNewObject to return new JS String object for Java\nString. See the following attachment for details.\nCreated attachment 91278\nWrapFactory implementation to map Java String to JS String in all cases\n\nWith this MyWrap class that example works as expected:\n\nRhino 1.5 release 4 0000 00 00 (in progress)\njs> var  cx = Packages.org.mozilla.javascript.Context.getCurrentContext();\njs> var wrap = new Packages.MyWrap(cx);\njs> var a = new java.lang.String(\"TEST\");\njs> a <= \"TEST\";\ntrueI mark the bug as fixed as the required functionality is already available with\nminimal setup.Marking Verified. Anup, please reopen if you disagree -Targeting as resolved against 1.5R4',?,IMPROVEMENT
72921,'NativeError objects are missing toString() method',Rhino,Core,pschwartau,norrisboyd,'The following causes an exception in the current Rhino build:\n\nEvalError.toString(); \njs: uncaught JavaScript exception: java.lang.NullPointerException\n\n\nI get the same exception from TypeError, etc. : all the \"NativeError\" types.\nBy contrast, Error.toString() may be invoked without causing an exception: \n\njs> print(Error.toString());\nfunction Error() {\n        [native code]\n}\n\n\n\nI believe the NativeError types should have toString as well. See: \n\n------------------------------------------------------------------------------\nECMA3 Section 15.11.7.7 Properties of the NativeError Prototype Objects\n\nEach NativeError prototype object is an Error object (its [[Class]] is \"Error\"). \nThe value of the internal [[Prototype]] property of each NativeError prototype \nobject is the Error prototype object(section 15.11.4).\n\n------------------------------------------------------------------------------\n\n\nSince EvalError.prototype is an instance of Error, and Error.toString exists, \nI would expect EvalError.toString to exist also -Fixed:\n\nChecking in NativeGlobal.java;\n/cvsroot/mozilla/js/rhino/org/mozilla/javascript/NativeGlobal.java,v  <--  Nativ\neGlobal.java\nnew revision: 1.24; previous revision: 1.23\ndoneVERIFIED FIXED with rhino and rhinoi shells built on WinNT 2001-03-27.',?,DESIGN_DEFECT
73448,'Multiple classes to represent reflected private java class',Rhino,Core,norrisboyd,norrisboyd,'Thanks for sending this along. Here\'s what\'s going on:\n\nThe value returned by v.interator() is an object of class \njava.util.AbstractList.Itr, which is a private class. The logic in Rhino \nattempts first to \nuse information about the dynamic type of the class; but if it is private it \nthen walks up the superclass list looking for a class it has access to. If it \nreaches java.lang.Object, it gives up and uses the static type of the class (in \nthis case java.util.Iterator). \n\nIdeally, rhino would use some combination of the static type and the superclass \nof the dynamic type in this case, but that\'s a tricky change to \nmove from a one-to-one relationship between the object and the class to a \none-to-many relationship. \n\nDavid Peacham wrote:\n\n  Norris - you might recall I asked you about this a few weeks back, but I\n  failed to produce a very convincing example.\n\n  I\'ve now realised that it can be recreated much more simply. Try this in\n  your Rhino shell:\n\n  var v = new java.util.Vector();\n  print(v);\n  print(v.toString());\n  var it = v.iterator();\n  print(it);\n  print(it.toString());\n\n  The last statement fails. The iterator \'it\' is of an interface type, and the\n  interface doesn\'t include toString(). The Java equivalent of this script\n  works fine, of course.\n\n  This isn\'t entirely an academic problem. For toString() it doesn\'t matter. I\n  can always convert \'it\' to a JavaScript string by writing it+\"\". But if we\n  replace toString() with getClass(), it does matter. I can find out the class\n  of the vector, but not of the iterator.\n\n  I don\'t know whether you see this as a bug or not. You might argue that I\n  shouldn\'t call methods that aren\'t defined in the interface.\n\n  ===========================================\n  A David Peacham\n  ===========================================Markin as fixed as the above example now works with Rhino tip even if the last\nline would be replaced by \n  print(it.getClass().getName());\n\nThe fixes for bug 201893 addressed this issue as well.\n\nMarking Verified; the above testcase works for me in Rhino, too -Trageting as resolved against 1.5R5',?,DESIGN_DEFECT
73555,'NativeError constructors have wrong [[Class]] property',Rhino,Core,pschwartau,norrisboyd,'The testcase above has been newly added to the JS test suite. \nIt is passing in SpiderMonkey, but failing in Rhino:\n\n\nBUGNUMBER: 56868\nSTATUS: Testing the internal [[Class]] property of native error constructors\n*-* Testcase ecma_3/Object/class-004.js failed:\nFailure messages were:\n\nFAILED!: Current constructor is: EvalError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\nFAILED!: Current constructor is: RangeError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\nFAILED!: Current constructor is: ReferenceError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\nFAILED!: Current constructor is: SyntaxError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\nFAILED!: Current constructor is: TypeError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\nFAILED!: Current constructor is: URIError\nFAILED!: Expected value \'Function\', Actual value \'NativeMethod\'\n\n\n\nI would expect the [[Class]] property of any JS constructor to be \'Function\'.\nNotice Rhino does give \'Function\' as the [[Class]] property of Error.Fixed.VERIFIED FIXED with rhino and rhinoi shells built on WinNT 2001-03-27.',?,BUG
76683,'RegExp regression (NullPointerException)',Rhino,Core,beard,rogerl,'Bjorn showed me a problem where the regular expression code is generating a \nNullPointerException, when running in their web server product. They have been \nusing an older version of Rhino that doesn\'t have this problem. Bjorn, please \ninclude the date of the older Rhino you were using, so we can narrow our search \nfor the cause of the regression. Please also include the stack crawls we \ngenerated yesterday.If there is a RegExp testcase I could addd to the testsuite, let me know.\nI just ran the full testsuite under Rhino and got 0 errors - To amplify on that: the testsuite already contains many RegExp tests,\nbut is there a new one I could add that shows this NullPointerException?Patrick:\n\nGood news, I found the culprit regular expression throwing the \nNullPointerException:\n\n/(<!--([^-]|-[^-]|--[^>])*-->)|(<(tagPattern)((([ ][^\\/>]*)?\\/>)|(([ \n][^>]*)?>)))|(<\\/tagPattern[^>]*>)/\n\nHere is the block of code that has the expression:\n\n regexp_cache: {\n                // used to search for any start-end tag:\n                anySE: /(<!--([^-]|-[^-]|--[^>])*-->)|(<([\\$\\w:\\.\\-]+)((([ \n][^\\/>]*)?\\/>)|(([ ][^>]*)?>)))/,\n                // used to search for a generic start-end tag:\n                genSE: /(<!--([^-]|-[^-]|--[^>])*-->)|(<(tagPattern)((([ \n][^\\/>]*)?\\/>)|(([ ][^>]*)?>)))/,\n                // used to search for a generic end tag:\n                genE : /(<!--([^-]|-[^-]|--[^>])*-->)|(<(tagPattern)((([ \n][^\\/>]*)?\\/>)|(([ ][^>]*)?>)))|(<\\/tagPattern[^>]*>)/,\n                // tag start-end regexps:\n                tagSE: {},\n                // tag end regexps:\n                tagE : {},\n                // attribute regexps:\n                attr : {}\n        },\n\nIt\'s in a file called parseXML.js that is a part of fast_track.\n\nLet me know if you need more information.Here\'s a stack trace for matching an empty string against the regexp:\n\njs> var re = /(<!--([^-]|-[^-]|--[^>])*-->)|(<(tagPattern)((([ \n][^\\/>]*)?\\/>)|(([ ][^>]*)?>)))|(<\\/tagPattern[^>]*>)/;\njs> try {\"\".match(re);} catch(e) {e.printStackTrace();}\njava.lang.NullPointerException\n\tat \norg.mozilla.javascript.regexp.NativeRegExp.matchRENodes(NativeRegExp.java:1505)\n\tat \norg.mozilla.javascript.regexp.NativeRegExp.matchRegExp(NativeRegExp.java:1866)\n\tat \norg.mozilla.javascript.regexp.NativeRegExp.executeRegExp(NativeRegExp.java:1912)\n\tat \norg.mozilla.javascript.regexp.RegExpImpl.matchOrReplace(RegExpImpl.java:201)\n\tat org.mozilla.javascript.regexp.RegExpImpl.match(RegExpImpl.java:77)\n\tat \norg.mozilla.javascript.NativeString.jsFunction_match(NativeString.java:710)\n\tat inv2.invoke()\n\tat \norg.mozilla.javascript.FunctionObject.doInvoke(FunctionObject.java:579)\n\tat \norg.mozilla.javascript.FunctionObject.callVarargs(FunctionObject.java:594)\n\tat org.mozilla.javascript.FunctionObject.call(FunctionObject.java:448)\n\tat org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1218)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:1722)\n\tat \norg.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:67)\n\tat \norg.mozilla.javascript.InterpretedScript.exec(InterpretedScript.java:58)\n\tat org.mozilla.javascript.Context.evaluateReader(Context.java:778)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:286)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:210)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:96)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:66)\njs> \n\nThe problem is in line:\n  state.parens[i].length = 0;\nWe know that \"state\" isn\'t null as it gets used a few lines earlier. So it\'s got \nto be parens[i] that is causing the problem.\n\nThe bug could have been introduced by me in revision 1.32 on 2001/03/06 when I \nreplicated the Spidermonkey fix for bug 67773. The conversion wasn\'t \nstraightforward, so I may have broken things. Could someone please run the above \nthrough Spidermonkey to see whether that breaks too ?\nHere\'s a transcript from Spidermonkey:\n\njs> var re = /(<!--([^-]|-[^-]|--[^>])*-->)|(<(tagPattern)((([][^\\/>]*)?\\/>)|(([ \n][^>]*)?>)))|(<\\/tagPattern[^>]*>)/;\njs> \"\".match(re)\nnull\n\nThis is running on the Mac. So, any internal bad pointerness won\'t be caught. \nI\'ll also try on Linux and on Mac OS X.\nI get the same results running on Linux and Mac OS X. I suspect your changes in \ntranslating to Java are probably the culprit. I\'ll take a look at your diffs.\nI seem to recall that I had to slightly alter the code when converting from C++ \nsince Java was throwing an ArrayIndexOutOfBounds or NullPointerException \nsomewhere (which, of course, wouldn\'t trouble C++ ;).\n\nThen again, this may just have been a dream.\nI checked out several old trees, going back as far as revision 1.22 of \nNativeRegExp (25 Sep 2000). They *all* exhibit the same problem. Revision 1.29 \nis the first time I touched NativeRegExp, so the problem is not my fault after \nall. Unfortunately it\'s not that easy to go back further since build.xml was \nintroduced around that time and I don\'t fancy building rhino by hand.\nI can go back further, as I have CodeWarrior projects that go back much further. \nI\'ll have to continue to search for the regression. Bjorn, can you confirm what \nversion of js.jar this DOESN\'T happen with?\nUnfortunately, I don\'t know how old the version of js.jar is that we were\nusing before. But it\'s definitely older than Sep 25 2000. I\'d say it\'s at least\nas old as Jun 2000.\n\nbjornCreated attachment 32386\nProposed fix - don\'t assume parens[i] exists, just blow it off.I will send a build with this patch to Bjorn\'s team, so they can test it.\nDoes this mean that we should be able to have it this week? That would be good. \nRegarding the version of js.jar we are using as I see it some of the comments \nit\'s from Nov 17 2000. Testcase added to JS/Rhino testsuite: \n\n                js/tests/ecma_3/RegExp/regress-76683.js\n\n\nTo run this directly from the Rhino shell, do the following:\n(The \'shell.js\' files contain utility functions the testcase needs)\n\n\n[/d/JS_TRUNK/mozilla/js/rhino] java org.mozilla.javascript.tools.shell.Main\njs> load(\'../tests/ecma_3/shell.js\')\njs> load(\'../tests/ecma_3/RegExp/shell.js\')\njs> load(\'../tests/ecma_3/RegExp/regress-76683.js\')\nWithout the patch to this bug applied, we see the NullPointerException\nin the output of the testcase: \n\njs: \"D:\\JS_trunk\\mozilla\\js\\tests\\ecma_3\\RegExp\\regress-76683.js\", line 58:                  \n     uncaught JavaScript exception: java.lang.NullPointerException\n\n\nThe testcase contains the regular expressions \"anySE\", \"genSE\", \"genE\" above.\nThe NullPointerException seems only to be caused by \"genE\" -\nI committed Roger\'s patch:\n\nChecking in src/org/mozilla/javascript/regexp/NativeRegExp.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java,v\n <--  NativeRegExp.java\nnew revision: 1.2; previous revision: 1.1\ndone\n\nI will post a .jar to the ftp site.The Rhino tree is closed right now. Your checkin will get obliterated as soon as \nleaf copies over the revision history.\nPatrick:\n\nI didn\'t see this but today after getting the js.jar from rhinoTip.zip I tested \none of the pages that heavily uses Javascript. The whole page was messed up and \nfills that page with $1, $2... characters. If you like to see it and have access \nthe internal machines please take a look at \nhttp://cleopatra.netscape.com/fast_track/ftstatus.psp. I couldn\'t notice it \nbefore but it happens with the version of js.jar you gave me too.Please isolate and file a new bug. This bug will be marked fixed as soon as the \nRhino tree opens again.\n...which it did a while ago.Verified fixed on WinNT. \nTestcase passes in both the rhino, rhinoi shells.Targeting as resolved against 1.5R3',?,BUG
77671,'IdFunction.java won\'t compile with JDK 1.1.8 javac',Rhino,Core,beard,norrisboyd,'The javac compiler that comes with MRJ 2.2.4 won\'t compile IdFunction.java. For \nsome reason, the assignments to the final members, master and methodId in the \nIdFunction constructor are flagged as errors.Created attachment 32265\nPatch to allow IdFunction.java to compileI\'ve had the same problem with the JDK 1.1.8 javac on Linux!Here are the errors I kept getting on Linux:\n\n\njavascript/../classfile/ByteCode.java\norg/mozilla/javascript/../classfile/ClassFileWriter.java \n./org/mozilla/javascript/IdFunction.java:65: Blank final variable \'master\' \nmay not have been initialized. It must be assigned a value in an initializer, \nor in every constructor.\n    public IdFunction(Master master, String name, int id) {\n           ^\n\n./org/mozilla/javascript/IdFunction.java:65: Blank final variable \'methodName\' \nmay not have been initialized. It must be assigned a value in an initializer, \nor in every constructor.\n    public IdFunction(Master master, String name, int id) {\n           ^\n\n./org/mozilla/javascript/IdFunction.java:65: Blank final variable \'methodId\' \nmay not have been initialized. It must be assigned a value in an initializer, \nor in every constructor.\n    public IdFunction(Master master, String name, int id) {\n           ^\n\n3 errors\nmake[1]: *** [classes/org/mozilla/javascript/DeepBytecodeHook.class]\nError 1\nmake[1]: Leaving directory `/data/phil/JS_TRUNK/mozilla/js/rhino\'\nmake: *** [js.jar] Error 2\nThe patch allows me to compile Rhino using JDK 1.1.8 on Linux.The patch has apparently already been applied. Marking fixed.Marking Verified - ',?,BUG
78706,'String() HTML methods not XHTML compliant',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 76054 in SpiderMonkey -\nReporter: ajvincent@hotmail.com\n\n\"I\'ve noticed the HTML methods of String.prototype return uppercase tags.  \nThe latest HTML recommendation from the W3C specifies lowercase tags -- \nexample: <big>k</big> instead of <BIG>k</BIG>.\"\n\nReproducible: Always\nSteps to Reproduce:\n1. Type javascript:alert(\"k\".big()) into your location bar.\n\n\nActual Results:    Alert window containing \"<BIG>k</BIG>\".\nExpected Results:  Alert window containing \"<big>k</big>\".Fixed: \nChecking in src/org/mozilla/javascript/NativeString.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeString.java,v  <--  N\nativeString.java\nnew revision: 1.18; previous revision: 1.17\ndoneTestcase js/tests/js1_5/Regress/regress-76054.js is now passing\nin the rhino and rhinoi shells. Marking Verified Fixed - \n',?,SPEC
79568,'delete on an arguments[i] not working correctly',Rhino,Core,pschwartau,norrisboyd,'The following testcase is passing in SpiderMonkey, but failing in Rhino: \n\n               js/tests/ecma_3/Function/arguments-001.js\n\n\nIn Rhino : test FAILS\nfunction g(){delete arguments[0]; return arguments[0]}\ng(42)\n42   //should print \'undefined\'\n\n\nIn SpiderMonkey: test PASSES\nfunction g(){delete arguments[0]; return arguments[0]}\ng(42)\nundefined  \n\n\n\nBrendan (from bug 72884):\n\n\"Per ECMA-262, delete on an arguments[i] should succeed and remove that property  \nfrom the arguments object, leaving any get of it after the delete to evaluate  \nto undefined.\"Fixed: \n\nChecking in Arguments.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Arguments.java,v  <--  Argu\nments.java\nnew revision: 1.11; previous revision: 1.10\ndoneTestcase passing in rhino/rhinoi shells. Marking Verified - ',?,BUG
80322,'Rhino: failed to execute the script that has inner function',Rhino,Core,hliu,norrisboyd,'// --test.js\nfunction foo()\n{\n\ttry {\n\t\tvar x = bar(1, 3);\n\t\tjava.lang.System.out.println(x);\n\t} \n\tcatch (e) {}\n\n\tfunction bar(a, b) {\n\t\treturn a+b;\n\t}\n}\nfoo();\n//---\n\n1. Compile the script using \"java org.mozilla.javascript.tools.jsc.Main test.js\"\n2. Run the class file using \"java test\"\nOBSERVE: \njava.lang.VerifyError: (class: test$foo, method: call signature: \n(Lorg/mozilla/javascript/Context;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla\n/javascript/Scriptable;[Ljava/lang/Object;)Ljava/lang/Object;) Inconsistent \nstack height 0 != 1\n\tat test.initScript(Unknown Source)\n\tat test.exec(Unknown Source)\n\tat org.mozilla.javascript.ScriptRuntime.main(ScriptRuntime.java, \nCompiled Code)\n\tat test.main(Unknown Source)\nException in thread \"main\"\n\nNOTE: If I remove the try/catch statement or move inner function bar() outside \nfoo(), it works.Fixed:\n\nChecking in Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <\n--  Codegen.java\nnew revision: 1.44; previous revision: 1.43\ndoneVerified on WinNT: \n                                                                                   \nhliu@allegis.com\'s testcase now succeeds without error -',?,BUG
83051,'A function defined under a with block can\'t be invoked outside it',Rhino,Core,pschwartau,norrisboyd,'In SpiderMonkey, I can define f() under a with block and then call it from\ntop-level code. In Rhino, I cannot:\n\nDEFINITION OF f\njs> with(Math) {function f(){return PI}}\nfunction f() {\n    return PI;\n}\n\n\nTHIS SUCCEEDS:\njs> with(Math) {f()}\n3.141592653589793\n\n\nTHIS FAILS: \njs> f()\njs: \"<stdin>\", line 10: uncaught JavaScript exception: ReferenceError: \"f\" is \nnot defined. (<stdin>; line 10)\n\n\n\nThis issue is causing the following testcase to fail:\n\n         js/tests/ecma_3/Function/scope-001.jsUpdate: I AM able to invoke f globally in Rhino (as well as SpiderMonkey)\nif I use a variable assignment instead of a function declaration:\n\njs> with(Math) {var f = function(){return PI}}\n\njs> f()\n3.141592653589793This may be the explanation:\n\n1st test above: under the with statement there is a function declaration \n2nd test above: under the with statement there is a function expression \n\n\nIt may be that ECMA does not specifially provide for function declarations\nto appear under with statements, and that this is a SpiderMonkey extension\nto the language. I will have to do more ECMA research to find out - \nAnother puzzle: Rhino gives me different errors on testcase \n\n         js/tests/ecma_3/Function/scope-001.js\n\ndepending on whether or not I use the -f operator or the load() method:\n\n\n[//d/JS_TRUNK/mozilla/js/tests/ecma_3/Function]\njava org.mozilla.javascript.tools.shell.Main  -f ../shell.js -f scope-001.js\njs: \"D:\\JS_trunk\\mozilla\\js\\tests\\ecma_3\\Function\\scope-001.js\", line 100: \nuncaught JavaScript exception: ReferenceError: \"f\"\nis not defined. (D:\\JS_trunk\\mozilla\\js\\tests\\ecma_3\\Function\\scope-001.js; line \n100)\n\n\n[//d/JS_TRUNK/mozilla/js/tests/ecma_3/Function]\n$ java org.mozilla.javascript.tools.shell.Main\njs> load(\'../shell.js\')\njs> load(\'scope-001.js\')\nBUGNUMBER: (none)\nSTATUS: Testing that functions are scoped statically, not dynamically\nFAILED!: [reported from test()] Section C of test\nFAILED!: [reported from test()] Expected value \'2\', Actual value \'1\'\nFAILED!: [reported from test()]\nFAILED!: [reported from test()] Section D of test\nFAILED!: [reported from test()] Expected value \'3\', Actual value \'1\'\nFAILED!: [reported from test()]\nFAILED!: [reported from test()] Section E of test\nFAILED!: [reported from test()] Expected value \'2\', Actual value \'1\'\nFAILED!: [reported from test()]\nFAILED!: [reported from test()] Section F of test\nFAILED!: [reported from test()] Expected value \'2\', Actual value \'1\'\nFAILED!: [reported from test()]\n\n\nAny idea why this would be???\n\nNote: in Rhino interpreted mode, I only get the latter type of failure,\nwhether I use the -f option or the load() method -  I take that back : now I\'m getting the same behavior in the rhinoi shell \n(interpreted mode) as in the rhino shell(compiled mode: \n\na discrepancy between the failure under the -f option as opposed \nto the load() method. I don\'t how to explain what happened above ...\n\n\nNow I see what I did wrong. When I was using load() to run the two\ndifferent tests in the shell, I wasn\'t exiting the shell in between them. \nThe function f is successfully defined by the one test. If I then happened \nto run the other test, f was still in memory and produced output...\n\nSorry for the confusion -To summarize: whether using the -f option or load(), both Rhino shells error on\n\n             js/tests/ecma_3/Function/scope-001.js\n\njs: \"D:\\JS_trunk\\mozilla\\js\\tests\\ecma_3\\Function\\scope-001.js\", line 100: \nuncaught JavaScript exception: ReferenceError: \"f\"\nis not defined. (D:\\JS_trunk\\mozilla\\js\\tests\\ecma_3\\Function\\scope-001.js; line \n100)\n\n\nThis is the test with the function DECLARATION under the with statement,\nwhere we try to invoke the function globally. SpiderMonkey allows this.\n\n\n\nBoth Rhino and SpiderMonkey pass the other test:\n\n             js/tests/ecma_3/Function/scope-002.js\n\nThis is the test with the function EXPRESSION under the with statement,\nwhere we try to invoke the function globally. Both engines allow this.\nThis can be market as fixed as the bug 184107 is effectively a duplicate of this\nand it is fixed. Now the bug can be removed from the excluding list in\nmozilla/js/tests/rhino-n.tests:\n\nIndex: rhino-n.tests\n===================================================================\nRCS file: /cvsroot/mozilla/js/tests/rhino-n.tests,v\nretrieving revision 1.50\ndiff -u -r1.50 rhino-n.tests\n--- rhino-n.tests\t4 Sep 2002 22:56:39 -0000\t1.50\n+++ rhino-n.tests\t23 Dec 2002 15:14:53 -0000\n@@ -6,8 +6,6 @@\n #\n #bug 152646 Will not fix this in Rhino; too much of a corner case\n js1_5/Regress/regress-152646.js\n-# bug 83051\n-ecma_3/Function/scope-001.js\n # bug 59861\n ecma/Date/15.9.4.3.js\n #See bug number 94506 \nIgor is correct.\n\nThe testcase, js/tests/ecma_3/Function/scope-001.js, started\npassing in Rhino when the fix for bug 184107 was checked in.\n\nMarking FIXED -Marking Verified Fixed.\n\nI have removed these two lines from the rhino-n.tests skip list:\n\n# bug 83051\necma_3/Function/scope-001.js\n\n\n[//d/JS_TRUNK/mozilla/js/tests] cvs ci rhino-n.tests\nChecking in rhino-n.tests;\n/cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\nnew revision: 1.51; previous revision: 1.50\ndoneTargeting as resolved against 1.5R4',?,BUG
85426,'available width/height returns incorrect value under gnome',Rhino,Core,nus,norrisboyd,'the screen.availWidth and screen.availHeight fuctions under ximian gnome 1.4\nreturn the screen width and height.  The available height and width as defined\nby whether panels are to be avoided or not, is not reported properlysorry, wrong place, and it seems to be fixed in .9.1 anyway.OK, marking Verified - ',?,BUG
85880,'.arguments after function calls in interpreter mode',Rhino,Core,user,norrisboyd,'When run in interpreter mode (java org.mozilla.javascript.tools.shell.Main -opt\n-1), the following prints \"null\" instead of expected \"[object Arguments]\":\n\nfunction g(x) {\n}\n\nfunction f() {\n\tg();\n\treturn f.arguments;\n}\n\nprint(f(0))\n\nI beliave this is caused by the following code in omj/ScriptRuntime.java, lines\n1725-1727:\n\nstack[stackTop] = ScriptRuntime.call(cx, lhs, rhs, \n                                     outArgs, \n                                     calleeScope);\nif (theData.itsNeedsActivation) {\n    ScriptRuntime.popActivation(cx);\n}\n\nwhich removes activation object after each function call.Created attachment 38395\nMove ScriptRuntime.popActivation(cx) to omj.InterpretedFunction plus NativeCall cleanupCreated attachment 38396\nMove ScriptRuntime.popActivation(cx) to omj.InterpretedFunction plus NativeCall cleanupThe attached patch moves ScriptRuntime.popActivation(cx) to the call method of\nomj.InterpretedFunction in the similar way omj.optimizer.CdeGen does and removes\nunused outside NativeCall NativeCall(Context, Scriptable, NativeFunction,\nScriptable) constructor by inlining its code.Committed patch, marking fixed. Thanks, Igor.Testcase addded to JS test suite:\n\n          js/tests/ecma_3/Function/regress-85880.js\n\n\nBefore fix, failing in Rhino interpreted mode only.\nPassing in Rhino complied mode; passing in SpiderMonkey.After fix, testcase passing in both Rhino modes on WinNT.\nMarking VERIFIED FIXED -',?,BUG
91343,'Pattern matching failing on non-Latin1 characters',Rhino,Core,pschwartau,rogerl,'RegExp pattern matching is failing on Unicode characters higher than \\u00FF.\nThis is the Rhino version of bug 72964 in SpiderMonkey. Testcase added:\n\n             mozilla/js/tests/ecma_3/RegExp/regress-72964.jsFix checked in.Verified Fixed on WinNT. Testcase passes in both rhino, rhinoi shells -Targeting as resolved against 1.5R3',?,BUG
94250,'Reflection of non-public java classes that implement public interfaces',Rhino,Core,wtam,norrisboyd,'In the constructor of the class org.mozilla.javascript.JavaMembers:\nWith the current implementation, if class being reflected is not declared as\npublic, then none of its methods are reflected, even if the class implements a\npublic interface.\n\nMy fix for this was to replace the reflect(scope,cl) line in the constructor\nwith the following code:\n\n        if(Modifier.isPublic(cl.getModifiers()))\n            reflect(scope, cl);\n        else{\n            Class[] cls = cl.getInterfaces();\n            for(int i=0;i<cls.length;i++)\n                reflect(scope,cls[i]);\n        }This is addresses in the current Rhino tip, see bug 201893.Rubber-stamp vrfy -Trageting as resolved against 1.5R5',?,BUG
94257,'Computation within a array index fails.',Rhino,Core,wtam,norrisboyd,'This following javascript fails to execute:\nvar a = new Array(4);\na[1+3] = \"test\";  // this is the line that fails.\n\nThe problem is in the generation of the parse tree in the class\norg.mozilla.javascript.IRFactory in the method \"createSetProp\".  When the above\ncode is parsed, \"1+3\" is parsed into a node/branch that is separate from the\narray accessor node.  It is later cloned and appended to the array accessor\nnode.  The problem is, only a shallow clone is performed on the parent node of\ncomputation branch, which means that none of the children nodes, ie. the actual\nnodes representing the computation itself, is cloned.\n\nThe solution was simply to do a deep clone, but the Node object did not include\na deep clonging method.  Not wanting break anything in the Node object, I put\nthe following deep cloning method into IRFactory:\n\n    private Node deepClone(Node n)\n    {\n        Node first = n.getFirst();\n        if(first != null){\n            if(first.getType() == TokenStream.IFNE){\n                Node ifTrue = first.getNext();\n                Node ifFalse = ifTrue.getNext().getNext().getNext();\n                return (Node)createIf(deepClone(first.getFirst()),\n                                      deepClone(ifTrue),\n                                      deepClone(ifFalse),-1);\n            }else{\n                Node result = n.cloneNode();\n                while(first != null){\n                    result.addChildToBack(deepClone(first));\n                    first = first.getNext();\n                }\n                return result;\n            }\n        }\n        return n.cloneNode();\n    }\n\nI used this method in \"createSetProp\" to change this:\n\n        } else {\n            tmp1 = obj.cloneNode();\n            tmp2 = id.cloneNode();\n            opLeft = new Node(nodeType, obj, id);\n        }\n\nto this:\n\n        } else {\n            tmp1 = obj.cloneNode();\n            tmp2 = deepClone(id); \n            opLeft = new Node(nodeType, obj, id);\n        }\n\nI found this bug in 1.5R1, but I think R2 also has this problem.This is working correctly for me with the latest Rhino source:\n\n[c:/] java org.mozilla.javascript.tools.shell.Main\n\njs> var a = new Array(4);\n\njs> a.length\n4\n\njs> a[1+3] = \"test\";\ntest\n\njs> a[4]\ntest\n\njs> a[1+3]\ntest\n\njs> a[2+2]\ntest\n\n\nwtam@bigfoot.com: can you download the latest tarball (Rhino 1.5r2)\nat ftp://ftp.mozilla.org/pub/js, or the latest Rhino source from CVS,\nand see if the problem has gone away for you, too?\nI gave the wrong test code with my original submission.  I found the problem\nalmost a year ago, so I forgot what the exact problem was.  Here\'s the original\ncode I used to test for the problem:\n\nvar testArray = new Array(6);\ntestArray[1+1] = 1;\ntestArray[1+1]+=2;\n\nwtam@bigfoot.com: thank you; this is a bug with my source, too:\n\n[c/] java org.mozilla.javascript.tools.shell.Main\n\njs> var testArray = new Array(6);\n\njs> testArray.length\n6\n\njs> testArray[1+1] = 1;\n1\n\njs> testArray.length\n6\n\njs> testArray[1+1]\n1\n\njs> testArray[2]\n1\n\njs> testArray[2]+=2;                          <<<<<<<<<<<<<<<<<< (THIS IS OK)\n3\n\njs> testArray[1+1]+=2;                        <<<<<<<<<<<<<<<<<< (THIS CRASHES)\nException in thread \"main\" java.lang.NullPointerException\nat org.mozilla.javascript.Interpreter.generateICode(Interpreter.java:258)\nat org.mozilla.javascript.Interpreter.generateICode(Interpreter.java:579)\nat org.mozilla.javascript.Interpreter.generateICode(Interpreter.java:660)\nat org.mozilla.javascript.Interpreter.generateICode(Interpreter.java:810)\nat org.mozilla.javascript.Interpreter.generateICode(Interpreter.java:279)\nat org.mozilla.javascript.Interpreter.generateICodeFromTree(Interpreter.java:89)\nat org.mozilla.javascript.Interpreter.generateScriptICode(Interpreter.java:134)\nat org.mozilla.javascript.Interpreter.compile(Interpreter.java:78)\nat org.mozilla.javascript.Context.compile(Context.java:1810)\nat org.mozilla.javascript.Context.compile(Context.java:1735)\nat org.mozilla.javascript.Context.compileReader(Context.java:852)\nat org.mozilla.javascript.Context.evaluateReader(Context.java:770)\nat org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:293)\nat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:217)\nat org.mozilla.javascript.tools.shell.Main.exec(Main.java:104)\nat org.mozilla.javascript.tools.shell.Main.main(Main.java:66)\nThanks, I just checked in a fix to create a temp rather than the deep clone.Marking VERIFIED. Testcase added to JS testsuite: \n\n           mozilla/js/tests/js1_5/Array/regress-94257.js\n\nTestcase passing in Rhino compiled and interpreted modes on WinNT.*** Bug 109438 has been marked as a duplicate of this bug. ***Targeting as resolved against 1.5R3',?,BUG
95101,'Problem with exception thrown for undefined function with v1.5r2',Rhino,Core,pschwartau,norrisboyd,'Reported by brien.oberstein@transacttools.net:\n\nWe\'ve noticed behavior that\'s changed between rhino 1.5r1 and 1.5r2.\nWhen calling a function that has not been defined via evaluateString(),\nthe EcmaError that is thrown returns an (incorrect?) value for .getName().\n\nPreviously it returned ReferenceError whereas now it returns \"undefined\".\nNot sure what the correct value is going strictly by the spec, but it seems\nlike EcmaErrors should probably not be returning \'undefined\' in any case.Confirming bug on WinNT. If I load the Rhino shell, and call a \nnon-existent function \"f\", here is the output I get in RC1 vs. RC2:\n\n\nRC1\njs: \"TEST.js\", line 40: uncaught JavaScript exception: \nReferenceError: \"f\" is not defined.\n(TEST.js; line 40)\n\n\nRC2\njs: \"TEST.js\", line 40: uncaught JavaScript exception:\nundefined: \"f\" is not defined.\n(TEST.js; line 40)\nHowever, if I use a try...catch block, the error is correctly caught\nas a ReferenceError object in Rhino. Therefore the following testcase\nis passing in both RC1 and RC2 of Rhino:\n\n      mozilla/js/tests/ecma_3/Exceptions/regress-95101.js\nThe only way I can see the error is manually in the interactive shell,\nas described above - Is there a method on the ReferenceError object that will allow me to \nsee the full error message? As in this pseudo-code:\n\ntry\n{\n  fNONEXISTENT();\n}\ncatch (e)\n{\n  e.printFullError();\n}\n\n\nDoes anything like that exist?There\'s e.toString() and e.message.Fixed:\n\nChecking in NativeGlobal.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeGlobal.java,v  <--  N\nativeGlobal.java\nnew revision: 1.34; previous revision: 1.33\ndoneImproved the testcase above by testing e.toString(). \nFailed this before the fix; now passes. \n\nMarking bug Verified Fixed -\nTargeting as resolved against 1.5R3',?,BUG
95736,'Changing a text field value from withing an inner class results in a NullPointerException',Rhino,Compiler,cyrille.rigault,norrisboyd,'Here is a short sample (44 lines)\n=================================\nimport java.awt.*;\nimport java.awt.event.*;\nimport javax.swing.*;\nimport org.mozilla.javascript.*;\n\n\npublic class Bug\n{\n\tpublic static void main (String[] args)\n\t{\n\t\tJTextField\t\t_field\t= new JTextField( 10);\n\t\tJRadioButton\t_button\t= new JRadioButton( \"button\", false);\n\t\t\n\t\t//------------------------------\n\t\tfinal Context\t\t_context = Context.enter();\n\t\tfinal Scriptable\t_scope   = _context.initStandardObjects\n( null);\n\t\t\n\t\tScriptable jsargs = Context.toObject( _field, _scope); \n\t\t_scope.put( \"input\", _scope, jsargs);\n\t\t\n\t\t_button.addActionListener( new ActionListener() {\n\t\t\tpublic void actionPerformed( ActionEvent event) {\n\t\t\t\tObject result = null;\n\t\t\t\ttry {\n\t\t\t\t\tString script = \"input.setText\n(\\\"hello\\\")\";\n\t\t\t\t\tresult = _context.evaluateString( \n_scope, script, \"<cmd>\", 1, null);\n\t\t\t\t} catch (JavaScriptException e) {\n\t\t\t\t\tSystem.err.println( \"script \nexception : \" + e.toString());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\t//------------------------------\n\t\t\n\t\tJFrame _frame = new JFrame();\n\t\t_frame.addWindowListener(new WindowAdapter() {\n\t\t\tpublic void windowClosing(WindowEvent e) {System.exit\n(0);}\n\t\t});\n\t\t_frame.getContentPane().setLayout( new FlowLayout());\n\t\t_frame.getContentPane().add( _field);\n\t\t_frame.getContentPane().add( _button);\n\t\t_frame.pack();\n\t\t_frame.setVisible(true);\n\t}\n}\n\nHere is the result when the button is clicked\n=============================================\nException occurred during event dispatching:\njava.lang.NullPointerException\n        at org.mozilla.javascript.optimizer.OptTransformer.detectDirectCall\n(OptTransformer.java:84)\n        at org.mozilla.javascript.optimizer.OptTransformer.visitCall\n(OptTransformer.java:115)\n        at org.mozilla.javascript.NodeTransformer.transform\n(NodeTransformer.java:388)\n        at org.mozilla.javascript.optimizer.OptTransformer.transform\n(OptTransformer.java:74)\n        at org.mozilla.javascript.optimizer.Codegen.transform(Codegen.java:67)\n        at org.mozilla.javascript.Context.compile(Context.java:1791)\n        at org.mozilla.javascript.Context.compile(Context.java:1735)\n        at org.mozilla.javascript.Context.compileReader(Context.java:852)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:770)\n        at org.mozilla.javascript.Context.evaluateString(Context.java:737)\n        at Bug$1.actionPerformed(Bug.java:26)\n        at javax.swing.AbstractButton.fireActionPerformed(Unknown Source)\n        at javax.swing.AbstractButton$ForwardActionEvents.actionPerformed\n(Unknown Source)\n        at javax.swing.DefaultButtonModel.fireActionPerformed(Unknown Source)\n        at javax.swing.JToggleButton$ToggleButtonModel.setPressed(Unknown \nSource)\n        at javax.swing.plaf.basic.BasicButtonListener.mouseReleased(Unknown \nSource)\n        at java.awt.Component.processMouseEvent(Unknown Source)\n        at java.awt.Component.processEvent(Unknown Source)\n        at java.awt.Container.processEvent(Unknown Source)\n        at java.awt.Component.dispatchEventImpl(Unknown Source)\n        at java.awt.Container.dispatchEventImpl(Unknown Source)\n        at java.awt.Component.dispatchEvent(Unknown Source)\n        at java.awt.LightweightDispatcher.retargetMouseEvent(Unknown Source)\n        at java.awt.LightweightDispatcher.processMouseEvent(Unknown Source)\n        at java.awt.LightweightDispatcher.dispatchEvent(Unknown Source)\n        at java.awt.Container.dispatchEventImpl(Unknown Source)\n        at java.awt.Window.dispatchEventImpl(Unknown Source)\n        at java.awt.Component.dispatchEvent(Unknown Source)\n        at java.awt.EventQueue.dispatchEvent(Unknown Source)\n        at java.awt.EventDispatchThread.pumpOneEventForHierarchy(Unknown Source)\n        at java.awt.EventDispatchThread.pumpEventsForHierarchy(Unknown Source)\n        at java.awt.EventDispatchThread.pumpEvents(Unknown Source)\n        at java.awt.EventDispatchThread.run(Unknown Source)The above example now works, it seems post 1.5R4.1 fixes for optimizer took care\nof this one as well.Targeting as resolved against 1.5R5',?,BUG
96270,'Unable to create java objects from within a javascript.',Rhino,Core,sonali,norrisboyd,'Hi,\nI want to create a new insatnce of my java class from within a javascript.\n\n//JAVASCRIPT CODE\n importClass(Packages.com.sonicsw.xs.envelope.Address)\n address = new Packages.com.sonicsw.xs.envelope.Address(\"Queue1\");\n\nI\'m using BSF 2.2 and Rhino Javascript Engine 1.5 on Windows 2000, \nto execute this javascript.\n\nHowever, the execution just hangs at the 2nd line written above.\nThe Address class is in classpath too.\nPlease let me know what am I missing here.Having the same problem. Scripts that worked fine in 1.5R3 now get something \nlike this in 1.5R4:\n\ncom.ibm.bsf.BSFException: JavaScript Error: Function importClass must be called \nwith a class; had \"[JavaPackage \ncom.emaritz.mario.participation.FindParticipationStatusByDateCmd]\" instead. (; \nline 5)\n\nJim Cakalic\njames.cakalic@Maritz.comcc\'ing Igor -Jim, do you set any classloaders in your application? And what the following\nscript will print under 1.5R4 and 1.5R3:\n\njava.lang.System.out.println(Packages.org.mozilla.javascript.Context.currentContext.optimizationLevel)\n\nvar cl =\njava.lang.Class.forName(\"com.emaritz.mario.participation.FindParticipationStatusByDateCmd\");\n\njava.lang.System.out.println(cl);\nCC to Jim so he will get a message about the previous comment.This is indeed a regression since 1.5R3 caused by the fact that 1.5R4 uses\nScriptableObject.has to check for property existence instead of checking\nScriptableObject.get != NOT_FOUND. In this way an assignment to a property which\ninitial value is initialized on the first read access would not need to create\nthe default value. See CVS log for org/mozilla/javascript/ScriptRutime.java from\n2002-04-11.\n\nUnfortunately not all classes are updated for this pattern change and in\nparticular ImporterTopLevel does not have proper has method, which can be seen\nif the following script is run in Rhino shell with optimization level -1:\n\nimportPackage(java.util);\nvar v = Vector();\nprint(v);\n\nwhich gives:\n\njs: \"/home/igor/js/x/test.js\", line 2: uncaught JavaScript exception:\nReferenceError: \"Vector\" is not defined. (/home/igor/js/x/test.js; line 2)\n\nAs far as I can see the bug is visible only when calling constructors of Java\nobjects imported through importPackage without using new keyword. If the above\nexample will be changed to \n\nimportPackage(java.util);\nvar v = new Vector();\nprint(v);\n\nit correctly prints \"[]\"\n\nCreated attachment 115059\nFix: proper implementation of has in ImporterTopLevel and NativeJavaPackagesI commited the fixMarking FIXED - the tests given by Igor in Comment #5 both pass now.\nI tested this in the Rhino shell with optimization levels -1, 0, 1, 9.Marking Verified.\n\nSonali and Jim: please reopen this bug if the fix doesn\'t work for you -Targeting as resolved against 1.5R4.1',?,BUG
102093,'parameter named \"arguments\" is not accessible in JavaScript method',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 94506 in SpiderMonkey, reported by \ndeneen@alum.bucknell.edu:\n\nThe following code does not do what is expected:\n\nfunction f(arguments)\n{ \n  return arguments;\n} \nf(5);\n\n\nActual Results:    [object Arguments]\nExpected Results:  5\n\n\nThere is a testcase for this in the JS testsuite:\n\n        mozilla/js/tests/ecma_3/Function/regress-94506.js\n\n\nSee bug 94506 for considerable discussion -Created attachment 126859\nFix and optimization\n\nThe patch adds to NativeCall constructor checks to ensure that arguments object\nis only initialized if there is no function parameter with the same name.\n\nI also split NativeCall that inherited from IdScriptable into NativeCall that\nextends ScriptableObject and NativeCallPrototype that extends to make instances\nof NativeCall smaller and to allow for faster property access since get/put/has\nwould not go throw an additional indirection level in IdScriptable.I committed the fixCreated attachment 126922\nrhino-n.tests update to remove skipping of ecma_3/Function/regress-94506.js\n\nDue to the bug fix Rhino passing now ecma_3/Function/regress-94506.js so there\nis no point to skip it. \n\nPhil, could you apply this?Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
103859,'\"debugSource\" not set in  \"generateFunctionICode\" function of class Interpreter',Rhino,Core,dkeller,norrisboyd,'From Bugzilla Helper:\nUser-Agent: Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 5.0)\nBuildID:    \n\n\"debugSource\" not set in \"generateFunctionICode\" function of \nclass \"Interpreter\" as it set in \"generateScriptICode\" function.\n\nReproducible: Always\nSteps to Reproduce:\n1.use rhino debugger\n2.\n3.rhino bug -> rhino product.  (hey norris!)I guess this was fixed since at least 1.5R2, at least\nInterpreter.generateFunctionICode does have that code.Rubber-stamp vrfy -Targeting as resolved against 1.5R5Fixing wrong milestone assignment',?,BUG
104493,'questionable dead code in NativeRegExp.java',Rhino,Core,bdc,norrisboyd,'We have a tool that looks for a scary noop case of assigning an instance field \nto itself. this usually comes from a constructor that assigns a argument to a \ninstance field with the same name and then later the argument changes name. we \nran our tool on all of our classes we have in our classpath here and found this \nproblem in your code.\n\nrhino1_5R2/src/org/mozilla/javascript/regexp/NativeRegExp.java line 159 it has:\n        this.flags = flags;\n\nThis seems to be a bad cut and paste from the CompilerState constructor on line \n2155. or has some initialization that used to work been lost?cc\'ing Roger - Fixed-- The value of flags is computed earlier in the method, so I believe\nit is safe just to remove the assignment.\n\nThanks for finding this.Marking Verified - Targeting as resolved against 1.5R3',?,CLEANUP
105438,'SourceName and lineNumbers of syntax errors in Javascript files not dispalyed.',Rhino,Core,sonali,norrisboyd,'I\'m using IBM\'s Bean Scripting Framework 2.2 for loading Rhino\'s js.jar 1.5, for \nevaluating Javascript files. However if a Syntax error occurs in the Javascript, \nthe sourceName and line number of the error is not displayed. \nThe following is the StackTrace I get:\n\nSyntaxError: missing ; before statement\n        at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:\n498)\n        at org.mozilla.javascript.TokenStream.reportSyntaxError(TokenStream.java\n:1356)\n        at org.mozilla.javascript.Parser.reportError(Parser.java:76)\n        at org.mozilla.javascript.Parser.wellTerminated(Parser.java:307)\n        at org.mozilla.javascript.Parser.statementHelper(Parser.java:790)\n        at org.mozilla.javascript.Parser.statement(Parser.java:337)\n        at org.mozilla.javascript.Parser.parseFunctionBody(Parser.java:180)\n        at org.mozilla.javascript.Parser.function(Parser.java:245)\n        at org.mozilla.javascript.Parser.parse(Parser.java:122)\n        at org.mozilla.javascript.Context.compile(Context.java:1834)\n        at org.mozilla.javascript.Context.compile(Context.java:1782)\n        at org.mozilla.javascript.Context.compileReader(Context.java:822)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:738)\n        at org.mozilla.javascript.Context.evaluateString(Context.java:705)\n        at com.ibm.bsf.engines.javascript.JavaScriptEngine.eval(JavaScriptEngine\n.java:83)\n        at com.ibm.bsf.util.BSFEngineImpl.exec(BSFEngineImpl.java:106)\n\nI found that this can be partially fixed in file EcmaError.java, method \ntoString() line 86, by returning the line number and the columnNumber along with \nthe errorMessage, even when the sourceName is null.\n\nREPLACE:\nreturn errorObject.toString();\nWITH\nreturn errorObject.toString() + \"( line \" + lineNumber + \" column \" + \ncolumnNumber + \")\" ; \n\nPlease fix this problem as it is very essential to know the line number of the \nerror. \nAlso, the sourceName is null in this case. Why ?Note bug 50447 against SpiderMonkey may be of interest. The fix there\nwas to add new properties to Error objects: \'fileName\' and \'lineNumber\'.\n(I don\'t know if added to Error.prototype or to Error objects themselves.)\n\nAt any rate, there is a testcase for it now:\n\n       mozilla/js/tests/js1_5/Exceptions/regress-50447.js\n\nI added this to rhino-n.tests skip list, since these new properties\nare non-ECMA extensions. If Rhino decides to implement them, we could\nuse this testcase in Rhino, too -\nI just checked in a fix.Trying to verify this. If I launch the Rhino shell and load a file\ninteractively, I do see a \"file name\" and line number:\n\n[] java org.mozilla.javascript.tools.shell.Main\njs> load(\'../../tests/test/test/bug.js\')\njs: \"<stdin>\", line 1: uncaught JavaScript exception: SyntaxError:\n                       Invalid assignment left-hand side. (<stdin>; line 1)\n\n\nBut if I load the file via the option -f, I don\'t get the same info:\n\n[] java org.mozilla.javascript.tools.shell.Main -f ../../tests/test/test/bug.js\njs: uncaught JavaScript exception: SyntaxError: \n                                   Invalid assignment left-hand side.\n\n\nShould we reopen this bug for consideration of this case?\nOr is it just a problem with the shell and not Rhino proper?  I guess I\'ll take the plunge and reopen. This is SpiderMonkey in the same\ntwo situations:\n\nINTERACTIVE LOADING\n[] ./js\njs> load(\'../../tests/test/test/bug.js\')\n../../tests/test/test/bug.js:34: SyntaxError: invalid assignment left-hand side:\n../../tests/test/test/bug.js:34: 1 = 2;\n../../tests/test/test/bug.js:34: ..^\n\nLOADING VIA -f OPTION\n[] ./js -f ../../tests/test/test/bug.js\n../../tests/test/test/bug.js:34: invalid assignment left-hand side:\n../../tests/test/test/bug.js:34: 1 = 2;\n../../tests/test/test/bug.js:34: ..^\n../../tests/test/test/bug.js:34: SyntaxError: invalid assignment left-hand side:\n../../tests/test/test/bug.js:34: 1 = 2;\n../../tests/test/test/bug.js:34: ..^\nCreated attachment 87785\nDefaultErrorReporter show line numbers on errors\n\nI keep getting syntax errors with no line numbers as well.\n\nThat happens when I use Context.compileReader(..) to compile the script. The\nDefaultErrorReporter will throw an exception with only the message and not the\nline it happened on.\n\nIt is of course easy to workaround using your own error reporter, but I\'ve\nattached a patch to add on the line and source name so the DefaultErrorReporter\ngives the similar output as EcmaError if that is wanted.Thanks for the patch--I regresion tested and committed it. Marking Verified Fixed.\n\nHere is the effect of the fix, as I load bad syntax in Rhino;\nfirst interactively via load(), then via the file option -f.\nThe file I\'m loading has a deliberate error |1=2| on line 1:\n\n\n-----------------------   BEFORE THE FIX  -------------------------------\n\n[ ] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 4 0000 00 00 (in progress)\njs> load(\'../../tests/BAD.js\')\njs: \"<stdin>\", line 6: uncaught JavaScript exception:\nSyntaxError: Invalid assignment left-hand side. (<stdin>; line 6)\n\n\n[ ] java org.mozilla.javascript.tools.shell.Main  -f ../../tests/BAD.js\njs: uncaught JavaScript exception:\nSyntaxError: Invalid assignment left-hand side.\n\n\n\n-----------------------   AFTER THE FIX  -------------------------------\n\n[ ] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 4 0000 00 00 (in progress)\njs> load(\'../../tests/BAD.js\')\n\njs: \"D:\\JS_trunk\\mozilla\\js\\tests\\BAD.js\",line 1:\nuncaught JavaScript exception: SyntaxError: Invalid assignment left-hand side. \n(D:\\JS_trunk\\mozilla\\js\\tests\\BAD.js; line 1)\njs: 1=2;\njs: ...^\n\n\n[ ] java org.mozilla.javascript.tools.shell.Main  -f ../../tests/BAD.js\njs: \"D:\\JS_trunk\\mozilla\\js\\tests\\BAD.js\", line 1:\nuncaught JavaScript exception: SyntaxError: Invalid assignment left-hand side. \n(D:\\JS_trunk\\mozilla\\js\\tests\\BAD.js; line 1)\njs: 1=2;\njs: ...^\nNOTE: in my data above, I formatted the last two lines by hand\nto look like this:\n\njs: 1=2;\njs: ...^\n\n\nIn actuality, they were reported like this:\n\njs: 1=2;\n\n\njs: ...^\n\n\nQUESTION: do we want these two line feeds between the error and the caret? Targeting as resolved against 1.5R4',?,CLEANUP
106548,'/^.*?$/ will not match anything',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 105972 against SpiderMonkey.\nSee that bug for further details. The testcase for both is: \n\n         mozilla/js/tests/ecma_3/RegExp/regress-105972.jsThis bug now fixed in SpiderMonkey; still need the fix in Rhino for it -Fix checked in.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,BUG
108719,'FunctionObject.getDeclaringClass() unambiguously identifies wrapped method',Rhino,Core,john,norrisboyd,'In an IdScriptable/ jsFunction context, both arguments and \"thisObj\" can be a\nfunction with scope \"global\" and prototype \"function\".  If we want the class to\nwhich the wrapped function is a member -- in order to call another function for\nexample user help about the function, our options are limited.\n\nFor example, implementing `help(name)\' or equivalently \"help(\'name\')\" where name\nevaluates to a known (constructor or) function.\n\n`FunctionObject.getDeclaringClass()\' returns the `Method.getDeclaringClass\' when\n`method\' is not null.\n\nIn org/mozilla/javascript/FunctionObject:\n\n    /**\n     * If the method exists in the current state, return the Java\n     * class of which this function\'s method is a member.  Otherwise\n     * return null.  */\n    public Class getDeclaringClass(){\n        if ( null != method)\n            return method. getDeclaringClass();\n        else\n            return null;\n    }\n\nThis appears to work well.\n\nAn alternative would be for FunctionObject to implement Wrapper, and unwrap to\nMethod.  This may or may not be appropriate, I\'m not sure.Created attachment 126941\nNew method: FunctionObject.getMethodOrConstructor()\n\nThe new method returns Method or Constructor instance that FunctionObject\nrepresents which can be used to get their declared class as well.\n\nI do not think implementing Wrapper interface by FunctionObject is a good idea.\nAFAICS it is only useful when calling Java methods that take Method or\nConstructor arguments which is rare. An other hand it would unwrap\nFunctionObject when calling to Java methods taking Object as argument like\nArray or Hashtable methods. Which in turn would make FunctionObject to behaves\ndifferently from other Function instances which is unnatural.I committed the patch.Targeting as resolved against 1.5R5',?,BUG
114491,'blowout on conditional anonymous function invocation',Rhino,Compiler,rokicki,norrisboyd,'E:\\p4test\\main\\dev>java -version\njava version \"1.2.2\"\nJava HotSpot(TM) Server VM (2.0rc1, mixed mode, build I)\n\nE:\\p4test\\main\\dev>java -jar e:/rhino/js.jar\njs> if (true) function f(){}()\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.IRFactory.setFunctionExpressionStatement(IRFac\ntory.java:235)\n        at org.mozilla.javascript.Parser.statementHelper(Parser.java:767)\n        at org.mozilla.javascript.Parser.statement(Parser.java:334)\n        at org.mozilla.javascript.Parser.statementHelper(Parser.java:376)\n        at org.mozilla.javascript.Parser.statement(Parser.java:334)\n        at org.mozilla.javascript.Parser.parse(Parser.java:133)\n        at org.mozilla.javascript.Context.stringIsCompilableUnit(Context.java:81\n0)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:213)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:104)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:66)\n\nHappens on linux with jdk1.3.0 too.I\'m seeing the same thing. Note the following variations:\n\n-----------------------  NO CONDITIONAL -------------------------------------\njs> function f(){}()\njs: \"<stdin>\", line 1: uncaught JavaScript exception: SyntaxError: syntax error                                                                \n(<stdin>; line 1)\njs: function f(){}()\njs: ...............^\n\n\n-----------------------  NO INVOCATION -------------------------------------\njs> if (true) function f(){}\n\nfunction f() {\n}\n\n\n------------------  CONDITIONAL + INVOCATION--------------------------------\njs> if (true) function f(){}()\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.IRFactory.setFunctionExpressionStatement(IRFac\ntory.java:234)\n        at org.mozilla.javascript.Parser.statementHelper(Parser.java:813)\n        at org.mozilla.javascript.Parser.statement(Parser.java:382)\n        at org.mozilla.javascript.Parser.statementHelper(Parser.java:424)\n        at org.mozilla.javascript.Parser.statement(Parser.java:382)\n        at org.mozilla.javascript.Parser.parse(Parser.java:125)\n        at \norg.mozilla.javascript.Context.stringIsCompilableUnit(Context.java:814)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:215)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:106)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:68)\nTestcase added to JS testsuite:\n\n          mozilla/js/tests/js1_5/Regress/regress-114491.jsFixed:\n\nChecking in IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFa\nctory.java\nnew revision: 1.20; previous revision: 1.19\ndone\nChecking in Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.\njava\nnew revision: 1.21; previous revision: 1.20\ndoneVerified FIXED. The construct produces a syntax error instead of crashing.\nThe testcase above now passes in both the rhino and rhinoi shells.Targeting as resolved against 1.5R3',?,BUG
114493,'blowout on out-of-bounds array invocation as function',Rhino,Compiler,rokicki,norrisboyd,'E:\\p4test\\main\\dev>java -version\njava version \"1.2.2\"\nJava HotSpot(TM) Server VM (2.0rc1, mixed mode, build I)\n\nE:\\p4test\\main\\dev>java -jar e:/rhino/js.jar\njs> \"3\"[5]()\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at org.mozilla.javascript.Interpreter.getString(Interpreter.java:1132)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:1942)\n        at org.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:\n68)\n        at org.mozilla.javascript.InterpretedScript.exec(InterpretedScript.java:\n59)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:773)\n        at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:293)\n\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:217)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:104)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:66)I\'m also seeing this. Compare SpiderMonkey:\n\njs>  \"3\"[5]();\n1: TypeError: \"3\"[5] is not a functionTestcase added to JS testsuite:\n\n          mozilla/js/tests/js1_5/Regress/regress-114493.jsFixed:\n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  In\nterpreter.java\nnew revision: 1.61; previous revision: 1.60\ndoneVerified FIXED. The construct produces a TypeError instead of crashing.\nThe testcase above now passes in both the rhino and rhinoi shells.Targeting as resolved against 1.5R3',?,BUG
114583,'script compile/decompile bug',Rhino,Compiler,bugzilla,norrisboyd,'the following code :\n\n>\t    \tContext cx = Context.enter();\n>\t\tScriptable scope = cx.initStandardObjects( null );\n>\n>\t        cx.setGeneratingDebug( true );\n>\t        cx.setGeneratingSource( true );\n>\n>\t\tString src = \" var x = 5; var y = 10; \"; \n>\t\tStringReader sr = new StringReader( src ); \n>\t\tScript script = null;\n>\t\t\n>\t\ttry {\n>\t\t\tscript = cx.compileReader( scope, sr, \"Test\", 1, null );\n>\t\t} catch ( Exception e ) {\n>\t\t}\n>\t\tSystem.out.println( cx.decompileScript( script, scope, 4 ) );\n>\t\tSystem.exit( 1 );\n\t\t\ngives :\n\n\tfunction () {\n\t\t[native code]\n\t}\n\nwhereas the following :\n\n>\t    \tContext cx = Context.enter();\n>\t\tScriptable scope = cx.initStandardObjects( null );\n>\n>\t        cx.setGeneratingDebug( true );\n>\t        cx.setGeneratingSource( true );\n>\n>\t\tString src = \" var x = 5; var y = 10; \"; \n>\t\tStringReader sr = new StringReader( src ); \n>\t\tScript script = null;\n>\t\t\n>\t\ttry {\n>\t\t\tscript = cx.compileReader( scope, sr, \"Test\", 1, null );\n>\t\t\tscript.exec(cx, scope);\n>\t\t} catch ( Exception e ) {\n>\t\t}\n>\t\tSystem.out.println( cx.decompileScript( script, scope, 4 ) );\n>\t\tSystem.exit( 1 );\n\n\nbehaves as expected (by printing the decompiled script). \n( there is a added exec() call to \"script\" )This is fixed as a byproduct of recent changes in decompilation support, for\ntest see the following java source.Created attachment 109963\nFull program for test caseMarking FIXED.\n\nI successfully compiled and ran Igor\'s test \"Y.java\".\nI got this output:\n\n[//c/WinNT/profiles/pschwartau/Desktop]\n$ java -classpath \"D:\\JS_trunk\\mozilla\\js\\rhino\\build\\rhino1_5R4pre\\js.jar;.\" Y\nfunction () {\n        [native code, arity=0]\n}Marking Verified -*** Bug 61579 has been marked as a duplicate of this bug. ***Just to double-check with Igor: was my output above correct?\n\nfunction () {\n        [native code, arity=0]\n}OOPS!!! I had my directories mixed up, and was using an old Rhino tree.\nThe bug is indeed fixed. Now that I\'ve updated the correct tree, we can\ncompare rhino1_5R3pre vs. rhino1_5R4pre:\n\n\n[//c/WinNT/profiles/pschwartau/Desktop]\n$ java -classpath \"D:\\JS_TRUNK\\mozilla\\js\\rhino\\build\\rhino1_5R3pre\\js.jar; .\" Y\nfunction () {\n        [native code]\n}\n\n\n[//c/WinNT/profiles/pschwartau/Desktop]\n$ java -classpath \"D:\\JS_TRUNK\\mozilla\\js\\rhino\\build\\rhino1_5R4pre\\js.jar; .\" Y\n\n    var x = 5;\n    var y = 10;\n\n\nAnd this shows the effect of the bug fix -Targeting as resolved against 1.5R4',?,BUG
114969,' are valid RegExp conditions',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 100199 against SpiderMonkey. \nThe testcase for this bug is: \n\n         mozilla/js/tests/ecma_3/RegExp/regress-100199.jsFix checked in - new engine implementation ported from SpiderMonkey.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,BUG
118636,'Date format change in SpiderMonkey should be done in Rhino',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 118266 against SpiderMonkey. \nNote the resulting change in SpiderMonkey date format: \n\nBEFORE FIX:\njs> Date();\nMon Jan 07 13:40:34 GMT-0800 (Pacific Standard Time) 2002\n\nAFTER FIX:\njs> Date();\nMon Jan 07 2002 13:40:34 GMT-0800 (Pacific Standard Time)\n\n\nRHINO CURRENTLY:\njs> Date();\nMon Jan 07 13:40:34 GMT-0800 (PST) 2002\n\n\nThis is in sync with the old style. Can we change it to be consistent\nwith the new SpiderMonkey style? Note: the examples I\'ve given are on\nWinNT. There are slight differences on the other platforms, but the \ngist of the issue is the same.Note: I have modified the following testcases to take the new \nSpiderMonkey date format into account:\n \n            mozilla/js/tests/ecma_3/Date/15.9.5.4\n            mozilla/js/tests/ecma_3/Date/15.9.5.7\n\nThe latter is irrelevant to Rhino: it is on the rhino-n.tests skip list.\nHowever, the former is now failing when tested against Rhino.\nThe reason for the change is to match PR_ParseTimeString and its precursor\nxptime.c code in Nav1-4, which is used when parsing cookie expiration times.  So\nbesides syncing Rhino and SpiderMonkey, Rhino may benefit in environments where\nits Date implementation is used to produce a cookie expiration time.\n\n/beFixed: \nChecking in src/org/mozilla/javascript/NativeDate.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeDate.java,v  <--  Nat\niveDate.java\nnew revision: 1.29; previous revision: 1.28\ndoneVerified FIXED on WinNT in rhino, rhinoi shells built today:\n\njs> Date()\nWed Jan 09 2002 11:25:57 GMT-0800 (PST)\n\nIn addition, the testcase mozilla/js/tests/ecma_3/Date/15.9.5.4.js\nis now passing in both Rhino shells -Targeting as resolved against 1.5R3',?,SPEC
120194,'JS toInt32(x) conversion doesn\'t match ECMAScript definition',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 120083,\n\"JavaScript toInt32 conversion doesn\'t match ECMAScript definition\"\n\nThe problem centers on numbers between 2^31 and 2^32 with fractional parts.\nThe JS internal function toInt32(x), available to the JS user as x | 0\nor  x << 0, is off by one on these. Same for negative numbers between\n-2^31 and -2^32 with fractional parts.\n\nRhino has the same problem as SpiderMonkey had. Tests to cover this\nissue were added to \n\n        mozilla/js/tests/ecma/TypeConversion/9.5-2.js\n\nThis test is now failing in the Rhino shell -Here is the failure output from the testcase:\n\n*-* Testcase ecma/TypeConversion/9.5-2.js failed:\n\nPOSITIVE NUMBERS\n2147483648.25 << 0 = -2147483647 FAILED! expected: -2147483648\n2147483648.5 << 0 = -2147483647 FAILED! expected: -2147483648\n2147483648.75 << 0 = -2147483647 FAILED! expected: -2147483648\n4294967295.25 << 0 = 0 FAILED! expected: -1\n4294967295.5 << 0 = 0 FAILED! expected: -1\n4294967295.75 << 0 = 0 FAILED! expected: -1\n3000000000.25 << 0 = -1294967295 FAILED! expected: -1294967296\n3000000000.5 << 0 = -1294967295 FAILED! expected: -1294967296\n3000000000.75 << 0 = -1294967295 FAILED! expected: -1294967296\n\nNEGATIVE NUMBERS\n-2147483648.25 << 0 = 2147483647 FAILED! expected: -2147483648\n-2147483648.5 << 0 = 2147483647 FAILED! expected: -2147483648\n-2147483648.75 << 0 = 2147483647 FAILED! expected: -2147483648\n-4294967295.25 << 0 = 0 FAILED! expected: 1\n-4294967295.5 << 0 = 0 FAILED! expected: 1\n-4294967295.75 << 0 = 0 FAILED! expected: 1\n-3000000000.25 << 0 = 1294967295 FAILED! expected: 1294967296\n-3000000000.5 << 0 = 1294967295 FAILED! expected: 1294967296\n-3000000000.75 << 0 = 1294967295 FAILED! expected: 1294967296Created attachment 65905\nFix ala the Spidermonkey change\n\nSame algorithmic change as in bug 120083.  Note: I am not a Java programmer,\nand have *not* tested this patch.  Nevertheless, we tested the C-version in the\nspidermonkey bug, and I\'m pretty sure this will fly.Created attachment 65906\n<sigh> Try #2.\n\nWell, that figures: Rhino has two places where this code lives.  (I hate code\nduplication!)\n\nPhil, the two different code paths come as conversions from doubles to int32s\nand conversions from jsvalues to int32s.  I\'m *guessing* that we ought to test\nfor both the numeric form of these numbers, and the string form of these\nnumbers in order to hit both sections of the code.  Norris should be able to\nshed more light on just the right way to test both pieces, though.\n\n--scoleCreated attachment 65907\nActually changed the file I uploaded.\n\nWell, it\'s been quite a morning.  I didn\'t actually save the last patch before\nsubmitting it to bugzilla.  Here\'s the right one.Created attachment 81407\ntested fix and code duplication removal\n\nThe previous fix from Steven actually does not work as it turned out it was\nnecessary to call floor/ceil before calling IEEEremainer. \n\nThe patch also removes code duplication by simply calling toInt32(double) from\ntoInt32(Object) and adds optimization for the case when number is already exact\nint. \n\nWith the patch rhino passes the tests.Thanks, Igor, for the patch. I committed it.Marking Verified Fixed.\n\nThe above testcase now passes in both the compiled and\ninterpreted modes of the Rhino shell -Targeting as resolved against 1.5R4',?,SPEC
121790,'Rhino 1.5r3rc2: NullPointerException when using the JSConsole',Rhino,Core,steve,norrisboyd,'On Mac OS X 10.1.2 with all the latest updates and no Java-specific \nupdates, with Rhino 1.5R3rc2 \"js.jar\" installed in /Library/Java/Extensions, \nif I run my \"jsconsole\" script:\n\n#!/bin/sh\njava org.mozilla.javascript.tools.shell.JSConsole $1\n\nThe window comes up (sometimes with a strange message back from \nthe dock as the app is initialized and the dock entry appears choppily, but \nnot always), The window draws but the \"js\" prompt never appears.  \nInstead, I get a NullPointerException:\n\nException in thread \"main\" java.lang.NullPointerException\n        at \norg.mozilla.javascript.ScriptableObject.getProperty(ScriptableObject.java:1\n374)\n        at \norg.mozilla.javascript.tools.shell.Global.getInstance(Global.java:373)\n        at org.mozilla.javascript.tools.shell.Main.setIn(Main.java:377)\n        at org.mozilla.javascript.tools.shell.JSConsole.<init>\n(JSConsole.java:161)\n        at \norg.mozilla.javascript.tools.shell.JSConsole.main(JSConsole.java:74)I\'m seeing this too, on WinNT. Changing OS: MacOSX ---> AllFixed:\nChecking in Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v\n  <--  Main.java\nnew revision: 1.41; previous revision: 1.40\ndoneMarking Verified; now the JS Console comes up fine for me on WinNT.\n\nA question, though: what is the significance of \"$1\", \"$2\"?\nThe command\n\n      java org.mozilla.javascript.tools.shell.JSConsole\n\nbrings up the JS Console just as well. I see JSConsole$1.class\nand JSConsole$2.class in my directory. They each are 1KB, whereas\nJSConsole.class is 6KB. There are no corresponding .java files for \nJSConsole$1.class, JSConsole$2.class.\n\n\nDo the \"$1\", \"$2\" refer to some global variable?  Note I can do\n\n     java org.mozilla.javascript.tools.shell.JSConsole $3\n\nand still get the JS Console, but I get a crash on \n\n     java org.mozilla.javascript.tools.shell.JSConsole $30Targeting as resolved against 1.5R3',?,BUG
122167,'string.replace() placeholder \'$1\' not working',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 104375 against SpiderMonkey.\nThe testcase for this is \n\n            mozilla/js/tests/ecma_3/String/regress-104375.jsCreated attachment 88787\nPatch to RegExpImpl.java to fig #122167\n\nI hit this bug so I thought I\'d fix it.\n\nUsing the spidermonkey fix, I produced the patch attached. Rhino passes\necma_3/String/regress-104385 after applying.Created attachment 88788\nPatch to fix #122167\n\nSorry last diff was wrong..I just checked in a fix for this (pretty much ditto your patch) since I was \njust all over the RegExp stuff; sorry to tread on your toes.Verified Fixed. With the new RegExp engine in Rhino (see bug 153223)\nthe above testcase passes in both compiled and interpreted modes.\n\nMorten: thank you for your interest in this!Targeting as resolved against 1.5R4',?,BUG
123439,'Backreferences /(a)? etc./ must hold |undefined| if not used',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 123437 against SpiderMonkey.\nThe testcase for this bug will be\n\n           mozilla/js/tests/ecma_3/RegExp/regress-123437.jsFix checked in - new engine implementation ported from SpiderMonkey.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,BUG
124508,'regexp.lastIndex should be integer-valued double, not uint32',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 124339 against SpiderMonkey.\nThe relevant testcase is an old one:\n\n        mozilla/js/tests/ecma_2/RegExp/properties-002.js\n\nFive new cases ranging between Math.pow(2,32) and Number.MAX_VALUE\nhave now been added to the testcase to cover the range between the\nuint32 upper bound and the upper bound for doubles. These new cases\nare failing in Rhino:\n\n\n*-* Testcase ecma_2/RegExp/properties-002.js failed:\n\nFailure messages were:\n/\\B/.lastIndex = 0 FAILED! expected: 4294967296\n/\\B/.lastIndex = 1 FAILED! expected: 4294967297\n/\\B/.lastIndex = 0 FAILED! expected: 8589934592\n/\\B/.lastIndex = 0 FAILED! expected: 1099511627776\n/\\B/.lastIndex = 0 FAILED! expected: 1.7976931348623157e+308Fix checked in - new engine implementation ported from SpiderMonkey.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,BUG
124900,'arguments object storing duplicate parameter values',Rhino,Core,pschwartau,norrisboyd,'The testcase\n\n           js/tests/ecma_3/ExecutionContexts/10.1.3-1.js\n\nhas recently been added to the JS testsuite, to test functions having\nduplicate formal parameter names. The following section of the test\nis passing in SpiderMonkey, but failing in Rhino:\n\n\nfunction f(x,x,x,x)\n{\n  var ret = [];\n\n  for (var i=0; i<arguments.length; i++)\n    ret.push(arguments[i]);\n\n  return ret.toString();\n}\n\nactual = f(1,2,3,4);\nexpect = \'1,2,3,4\';\n\n\nSPIDERMONKEY\ntest passes\n\nRHINO\ntest FAILED!: Expected value \'1,2,3,4\', Actual value \'4,4,4,4\'\n\n\n\nECMA-262, 3rd Edition Final, contains this language:\n\n\n10.1.3 Variable Instantiation \nEvery execution context has associated with it a variable object.\nVariables and functions declared in the source text are added as properties\nof the variable object. For function code, parameters are added as properties\nof the variable object. \n\nWhich object is used as the variable object and what attributes are used\nfor the properties depends on the type of code, but the remainder of the\nbehaviour is generic. On entering an execution context, the \nproperties are bound to the variable object in the following order: \n\n? For function code: for each formal parameter, as defined in the\nFormalParameterList, create a property of the variable object whose name\nis the Identifier and whose attributes are determined by the type of code.\nThe values of the parameters are supplied by the caller as arguments to\n[[Call]]. If the caller supplies fewer parameter values than there are formal\nparameters, the extra formal parameters have value undefined. If two or more\nformal parameters share the same name, hence the same property, the\ncorresponding property is given the value that was supplied for the last\nparameter with\nthis name. If the value of this last parameter was not supplied by the caller,\nthe value of the corresponding property is undefined. \n  \n  \n\n10.1.8 Arguments Object \nWhen control enters an execution context for function code, an arguments object\nis created and initialised as follows: \n\n? The value of the internal [[Prototype]] property of the arguments object\nis the original Object prototype object, the one that is the initial value of\nObject.prototype (see 15.2.3.1). \n\n? A property is created with name callee and property attributes { DontEnum }.\nThe initial value of this property is the Function object being executed.\nThis allows anonymous functions to be recursive. \n\n? A property is created with name length and property attributes { DontEnum }.\nThe initial value of this property is the number of actual parameter values\nsupplied by the caller. \n\n? For each non-negative integer, arg, less than the value of the length\nproperty, a property is created with name ToString(arg) and property\nattributes { DontEnum }. The initial value of this property is the value\nof the corresponding actual parameter supplied by the caller. The first\nactual parameter value corresponds to arg = 0, the second to arg = 1, and so on.\nIn the case when arg is less than the number of formal parameters for the\nFunction object, this property shares its value with the corresponding property\nof the activation object. This means that changing this property changes the \ncorresponding property of the activation object and vice versa.My reading of ECMA is that disparate parameter values should be preserved\nin the arguments object, even if the parameter names are the same in each case,\nand even though it is only the last parameter value that will have effect.\n\ncc\'ing Waldemar to be sure -So this behavior is correct, right?\n\njs> function f(x,x) { x = 7; return arguments[0]; }\njs> f(3,4)\n7\njs> function f(x,x) { x = 7; return arguments[1]; }\njs> f(3,4)\n7Comment 2: I agree.\n\nComment 3: I\'d expect, in a faithful ECMA implementation, the first function\ndefinition to return 3 and the second one to return 7.  If they both return 7,\nyou get a nonsensical situation of x being an alias of arguments[0], x being an\nalias of arguments[1], but arguments[0] and arguments[1] initially holding\ndifferent values.\n\nAs an aside, I personally feel that the standard is unnecessarily detailed about\nthis case and should have left it unspecified.  Having two parameters with the\nsame name is not something ECMAScript programs should do.Here\'s what SpiderMonkey does on Norris\' example:\n\njs> function f(x,x) {x=7; return arguments[0]}\njs> f(3,4);\n3\n\njs> function f(x,x) {x=7; return arguments[1]}\njs> f(3,4);\n7\nI wish I knew why MS\'s lead was so intent on making this case work, and making\nthe spec for it so detailed.  It seems to be gilding the lily, at best.  I tried\npushing for SpiderMonkey\'s behavior (an error, now a strict warning), but lost\nno good reason.\n\n/beFixed:\n\nChecking in Arguments.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Arguments.java,v  <-- \nArguments.java\nnew revision: 1.13; previous revision: 1.12\ndoneVerified Fixed. Both new testcases on duplicate parameters are now\npassing in the rhino and rhinoi shells on WinNT: \n\n           js/tests/ecma_3/ExecutionContexts/10.1.3-1.js\n           js/tests/ecma_3/ExecutionContexts/10.1.3-2.jsTargeting as resolved against 1.5R4',?,BUG
125562,'Regexp performance improvement',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of bug 85721 against SpiderMonkey. The testcase\nfor this bug is\n\n              js/tests/ecma_3/RegExp/regress-85721.js\n\nI have added this to the rhino-n.tests skip list for now, since it\ncontains timing tests that currently take a long time to complete.\nOnce the fix for this bug is made, they will run in a few milliseconds.Gee, I\'m wondering if we have an issue here after all. On the above test,\nmy current time in either Rhino compiled or interpreted mode is 31ms :\n\njava -jar D:/JS_trunk/mozilla/js/rhino/build/rhino1_5R4pre/js.jar\n-f ecma_3/shell.js\n-f ecma_3/RegExp/shell.js\n-f ecma_3/RegExp/regress-85721.js\n\n\nNote: I\'m using WinNT; 128M RAM, 500MHz CPU.\nNorris, do you get about the same time on this test? (embarrased cough) I think what you\'re seeing here is that there are still bug \nfixes from SpiderMonkey that have yet to be transferred to the Rhino engine and \nthose fixes will promptly whack the performance down. The engine rewrite in the \nattachment to #85721 fixes the bugs and gets the performance back in line. Fix checked in - new engine implementation ported from SpiderMonkey.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,IMPROVEMENT
126317,'Crash on re.exec(str) if re.lastIndex set to certain values',Rhino,Core,pschwartau,rogerl,'The tests below each involve a regexp with the global flag set, where \nre.lastIndex has been set to out-of-bounds values: i.e. < 0  or > str.length.\n\nIn such a case, ECMA specifies that re.exec(str) should return null.\n(and set re.lastIndex to 0). Here is what Rhino is currently doing: \n\n[] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 4 0000 00 00 (in progress)\n\njs> var re = /abc/gi;\njs> var str = \'AbcaBcabC\';\njs> re.lastIndex = -1;\n-1\njs> re.exec(str);\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRENodes(NativeRegExp.java:1855)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRegExp(NativeRegExp.java:1879)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.executeRegExp(NativeRegExp.java:1925)\n\n                                etc.\n                                etc.\n\n\njs> var re = /abc/gi;\njs> var str = \'AbcaBcabC\';\njs> re.lastIndex = 9999999;\n9999999\njs> re.exec(str);\nnull  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< CORRECT\n\n\njs> var re = /abc/gi;\njs> var str = \'AbcaBcabC\';\njs> re.lastIndex = Number.MAX_VALUE;\n1.7976931348623157e+308\njs> re.exec(str);\nAbc  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< should be null!\n\n\njs> re.lastIndex = Math.pow(2,31);\n2147483648\njs> re.exec(str);\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRENodes(NativeRegExp.java:1855)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRegExp(NativeRegExp.java:1879)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.executeRegExp(NativeRegExp.java:1925)\n        at \n                                etc.\n                                etc.\n\n\njs> var re = /abc/gi;\njs> var str = \'AbcaBcabC\';\njs> re.lastIndex = Math.pow(2,30);\n1073741824\njs> re.exec(str);\nnull  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< CORRECT\n\n\njs> var re = /abc/gi;\njs> var str = \'AbcaBcabC\';\njs> re.lastIndex = Math.pow(2,31);\n2147483648\njs> re.exec(str);\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRENodes(NativeRegExp.java:1855)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.matchRegExp(NativeRegExp.java:1879)\n        at \norg.mozilla.javascript.regexp.NativeRegExp.executeRegExp(NativeRegExp.java:1925)\n        at\n                                etc.\n                                etc.This problem is causing the following new testcase to fail: \n\n        mozilla/js/tests/ecma_3/RegExp/15.10.6.2-2.jsThe cases above where re.exec(str) returns \'Abc\' instead of |null| \nmight be a consequence of bug 124508 against Rhino:\n\"regexp.lastIndex should be integer-valued double, not uint32\"\n\nBut I don\'t know if that\'s so, and I also don\'t know if that would\nexplain the crashes above. If it does, please dupe.Fix checked in - new engine implementation ported from SpiderMonkey.Verified Fixed - the above testcase now passes in the rhino, rhinoi shells.Targeting as resolved against 1.5R4',?,BUG
126722,'(undefined === null) evaluating to true in Rhino compiled mode',Rhino,Core,pschwartau,norrisboyd,'I have a testcase which examines (undefined === null), expecting this\nto be false. It passes in the SpiderMonkey shell and in Rhino interpreted\nmode, but it\'s failing in Rhino compiled mode. I will check the testcase\ninto CVS and give the path for it below -Testcase added to JS testsuite:\n\n          mozilla/js/tests/ecma_3/Expressions/11.9.6-1.js\n\n\nIt is named after Section 11.9.6 in the ECMA-262 Edition 3 Final:\n\n11.9.6 The Strict Equality Comparison Algorithm\nThe comparison x === y, where x and y are values, produces true or false.\nSuch a comparison is performed as follows:\n\n1. If Type(x) is different from Type(y), return false.\n2. If Type(x) is Undefined, return true.\n3. If Type(x) is Null, return true.\n\n               etc.\n               etc.\n\nSince typeof undefined = \'undefined\', and typeof null = \'object\',\nI would expect (undefined === null) to be false by Step 1.Here are the command lines I\'m using:\n\ncd mozilla/js/tests\n\nTEST PASSES:\nperl jsDriver.pl -e rhinoi -f TEST.html -k -l ecma_3/Expressions/11.9.6-1.js\n\nTEST FAILS:\nperl jsDriver.pl -e rhino  -f TEST.html -k -l ecma_3/Expressions/11.9.6-1.js\n\n\nEngine command line: java org.mozilla.javascript.tools.shell.Main \nOS type: WIN\njava full version \"1.3.0_01\" \n\nFailure Details\n     Testcase ecma_3/Expressions/11.9.6-1.js failed \n     Bug Number 126722\n     \n     STATUS: Testing the comparison |undefined === null|\n     Failure messages were:\n     FAILED!: [reported from test()] Section 1 of test -\n     FAILED!: [reported from test()] Expected value \'false\', Actual value \'true\'\n     FAILED!: [reported from test()] \n     FAILED!: [reported from test()] Section 2 of test -\n     FAILED!: [reported from test()] Expected value \'false\', Actual value \'true\'\n     FAILED!: [reported from test()] \n     FAILED!: [reported from test()] Section 3 of test -\n     FAILED!: [reported from test()] Expected value \'false\', Actual value \'true\'\n     FAILED!: [reported from test()] \n     FAILED!: [reported from test()] Section 4 of test -\n     FAILED!: [reported from test()] Expected value \'false\', Actual value \'true\'\n     FAILED!: [reported from test()] Fixed:\n\nChecking in optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <\n--  Codegen.java\nnew revision: 1.53; previous revision: 1.52\ndoneReopening. I\'m still getting a failure on Section 1 of the testcase:\n\njava -jar build/rhino1_5R4pre/js.jar\n     -f ../tests/ecma_3/shell.js\n     -f ../tests/ecma_3/Expressions/11.9.6-1.js\n\nBUGNUMBER: 126722\nSTATUS: Testing the comparison |undefined === null|\nFAILED!: [reported from test()] Section 1 of test -\nFAILED!: [reported from test()] Expected value \'false\', Actual value \'true\'\n\n\nSection 1 is as follows:\n\nif (undefined === null)\n  actual = true;\nelse\n  actual = false;\nexpect = false;Thanks--missed one codepath.\n\nChecking in Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <\n--  Codegen.java\nnew revision: 1.54; previous revision: 1.53\ndoneMarking Verified FIXED.\n\nThe testcase now passes in both the rhino and rhinoi shells on WinNT -Targeting as resolved against 1.5R4',?,BUG
129365,'Incorrect licensing in dtoa.java',Rhino,Core,gerv,norrisboyd,'DToA.java is a translation of a .c file by David M. Gay. Somewhere along the\nway, his copyright got removed. It needs to be replaced.\n\nAs far as I can see, we can keep the tri-license in there, because his license\npermits us to license our changes however we like.\n\nGervTaking.\n\nGervCreated attachment 72858\nPatch v.1\n\nHere we go.\n\nCould someone review this? Norris?\n\nGervr=nboyd@atg.com\n\nThanks for discovering and fixing this issue.Fixed.\n\nGervVerified -Targeting as resolved against 1.5R4',?,CLEANUP
132217,'delete on global function should not delete the function',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 131964 against SpiderMonkey.\nThe testcase for this bug is \n\n          mozilla/js/tests/ecma_3/Function/regress-131964.js\n\nAt present, it tests four scenarios:\n\n1. f defined and deleted in global scope\n2. f defined and deleted in function scope\n3. f defined and deleted in eval scope\n4. f defined in eval scope, but deleted in global scope\n\nI\'m still trying to sort out what the expected behavior should be\nfor 3 and 4, but ECMA seems pretty clear about 1 and 2: f should not\nbe deleted in those cases.\n\nHere are the ECMA references quoted by Thomas Much in the original bug:\n\n> ECMA 262-3, section 13 says that function declarations create a property\n> of the current variable object as specified in 10.1.3.\n\n> 10.1.3 says that for function declarations, the property\'s attributes\n> are determined by the type of the code.\n\n> 10.2.1 says that for global code, variable instantiation is performed\n> [...] using property attributes { DontDelete }.\n\n\nAnd there are similar sections for function scope and eval scope...Fixed:\n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  In\nterpreter.java\nnew revision: 1.74; previous revision: 1.73\ndone\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--\nScriptRuntime.java\nnew revision: 1.87; previous revision: 1.86\ndoneReopening bug -\n\n\n-------------------    SUMMARY OF TEST RESULTS    ---------------------------\nThe test above checks delete of functions defined in\n\n1. global scope\n2. function scope\n3. eval scope (delete also done within eval scope)\n4. eval scope (delete done in global scope)\n\n\n-------------------    OUTPUT BEFORE PATCH    ---------------------------\nFAILED!: Section 1 of test -\nFAILED!: Expected value \'f lives!\', Actual value \'f was deleted\'\n\nFAILED!: Section 2 of test -\nFAILED!: Expected value \'f lives!\', Actual value \'f was deleted\'\n\n\n-------------------    OUTPUT AFTER PATCH    ----------------------------\nFAILED!: Section 3 of test -\nFAILED!: Expected value \'h was deleted\', Actual value \'h lives!\'\n\nFAILED!: Section 4 of test -\nFAILED!: Expected value \'k was deleted\', Actual value \'k lives!\'\n\n\nSo the patch has fixed the bug in global and function scope, but\nhas changed the behavior in eval scope. It used to be that functions\ndefined in eval scope were deletable; now apparently they are not.\nAccording to ECMA, they should be. See discussion in bug 131964.Fixed: \n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  In\nterpreter.java\nnew revision: 1.75; previous revision: 1.74\ndoneVerified FIXED -\n\nThe testcase passes in both the rhino and rhinoi shells on WinNT.Targeting as resolved against 1.5R4',?,BUG
136893,'Rhino treatment of |for(i in undefined)|, |for(i in null)|',Rhino,Core,pschwartau,norrisboyd,'This issue grows out of:\n\nbug 121744 SpiderMonkey should error on |for(i in undefined)|, |for(i in null)|\nbug 131348 |var obj; for (item in obj) {}| causes error\n\n\nBefore these bugs were filed, SpiderMonkey did NOT error on these statements;\nRhino does. Since ECMA-262 Edition 3 requires ECMAScript to error on them,\nbug 121744 was filed and SpiderMonkey corrected its behavior to match the \nstandard.\n\nBut many complaints ensued because we had changed the behavior of JS,\nand were no longer in agreement with the behavior of NN4.7 and IE6.\nSo bug 131348 was filed, and it was decided to undo the 121744 fix.\n\nIn addition, Waldemar reports in bug 131348 that the ECMA committee is\nleaning toward treating this as a bug in the standard, and changing it\nin Edition 4. So: how does Rhino want to behave on these statements? \n\nWe currently have two testcases, for the two SpiderMonkey bugs:\n\n        mozilla/js/tests/ecma_3/Statements/regress-121744.js\n        mozilla/js/tests/ecma_3/Statements/regress-131348.js\n\nThe two tests expect contrary things. I retain both of them because\nat present, SpiderMonkey and Rhino do contrary things on these statements.\nOnce this bug is resolved, I will adjust the testcases accordingly.*** Bug 156510 has been marked as a duplicate of this bug. ***Created attachment 90654\nReturn in ScriptRuntime.initEnum empty enum for null and undefinedWith the patch above Rhino passes ecma_3/Statements/regress-131348.js and\nnaturally fails at ecma_3/Statements/regress-121744.js to follow SM. I can\ncommit it if it is OK (it passes the rest of test suite).\n\n(And sory for that bug 156510, next time I will try to do the search in bugzilla\n...)I commited the fix, so now mozilla/js/tests/ecma_3/Statements/regress-121744.js\ncan be removedIgor: thanks. Do you want to mark this bug as Fixed, then?\n\nI have modified both tests above now that Rhino and SpiderMonkey\nare in synch on this issue.\n\n    mozilla/js/tests/ecma_3/Statements/regress-121744.js\n    mozilla/js/tests/ecma_3/Statements/regress-131348.js\n\nThe two tests expect contrary things. I\'ve put an early return on the\nformer test, so that it no longer runs in either SpiderMonkey or Rhino.\nI decided to retain it as a record of the issue, rather than CVS-deleting it. \n\nMeanwhile, I have removed the early Rhino return on the latter test, \nso that it tests both SpiderMonkey and Rhino on this issue now.\nIt now passes in both the interpreted and compiled Rhino shells -Fixed, as Rhino passes the modified tests.Thanks - marking Verified.Targeting as resolved against 1.5R4',?,SPEC
137181,'delete on an arguments[i] not working correctly',Rhino,Core,pschwartau,norrisboyd,'Reported in the JS Engine newsgroup by ibukanov8@yahoo.com (Igor Bukanov):\n\n\"Given the following and my reading of Ecma-262\n\nfunction test1(x) {\n    x = 1;\n    delete arguments[0];\n    return x;\n}\n\nfunction test2(x) {\n    x = 1;\n    delete arguments[0];\n    arguments[0] = -1;\n    return x;\n}\n\n\ntest1(0) and test2(0) should both return 1, since after |delete argument[0]|,\narguments[0] loses any connection with x, even if arguments[0] is recreated. \n\n\nFrom ECMA-262 Edition 3:\n\n\nSection 10.1.8 Arguments Object\n\n*  For each non-negative integer, arg, less than the value of the length\nproperty, a property is created with name ToString(arg) and property\nattributes { DontEnum }. The initial value of this property is the value \nof the corresponding actual parameter supplied by the caller. The first \nactual parameter value corresponds to arg = 0, the second to arg = 1, \nand so on. In the case when arg is less than the number of formal \nparameters for the Function object, this property shares its value with \nthe corresponding property of the activation object. This means that \nchanging this property changes the corresponding property of the \nactivation object and vice versa.\n\n\nSection 10.2.3 Function Code\n\n*  Variable instantiation is performed using the activation object as \nthe variable object and using property attributes { DontDelete }.\n\n\nSpiderMonkey meets these expectations, but Rhino does not.\nIn Rhino, test1(0) returns |undefined|; test2(0) returns -1.\n\n\nNote the testcase for bug 72884,\n\n     mozilla/js/tests/ecma_3/Function/arguments-001.js\n\ndoes not touch this area, so maybe it should be updated to\ncover this issue as well -\"\n\n\n\nFOR REFERENCE:\n\nbug 72884 (SpiderMonkey) \"Arguments object has incorrect [[Prototype]] property\"\nbug 79568 (Rhino)        \"delete on an arguments[i] not working correctly\"Igor\'s test has been added to the JS testsuite:\n\n          mozilla/js/tests/ecma_3/Function/regress-137181.js\n\n\nCurrently passing in SpiderMonkey, failing in Rhino:\n\nFAILED!: Section 1 of test -\nFAILED!: Expected value \'1\', Actual value \'undefined\'\n\nFAILED!: Section 2 of test -\nFAILED!: Expected value \'1\', Actual value \'-1\'Created attachment 79191\nCode fix: patch to omj/Arguments.java\n\nThe patch uses the special NOT_FOUND value to flag deleted indexes. It also\nmake sure that original array object passed to Function.call is not modified,\nas all changes goes to cloned copy. It is not necessary for the fix, but it is\nthe only place in the current Rhino that can alter Object[] array passed to\nFunction.call and I think it is better to remove this exceptional case.\n\nI will run the tests and if there are no objections will commit it in couple\ndays.Created attachment 79192\nFixing comments misspells in the previous patch versionI committed the fix so Rhino passes the additional tests.As this is in Rhino CVS for a long time now, maybe it can be marked fixed/verified?Igor is correct - marking FIXEDMarking Verified Fixed.\n\nIgor\'s testcase now passes in both the rhino and rhinoi shells -Targeting as resolved against 1.5R4',?,BUG
145791,'ECMA conformance: Function.prototype.apply(), Function.prototype.call()',Rhino,Core,pschwartau,norrisboyd,'Function.prototype.apply has a FormalParameterList of length two:\n\n          Function.prototype.apply (thisArg, argArray)\n\nAccordingly, Function.prototype.apply.length should return 2.\nThis is explicitly stated in Section 15.3.4.3 of ECMA-262 Edition 3.\nSee http://www.mozilla.org/js/language/ for a reference.\n\nHowever, Rhino currently returns 1 instead of 2.\nThis was reported by igor3@apochta.com.This bug is the Rhino version of bug 145779 against SpiderMonkey.\nThe corresponding testcase for this is:\n\n          mozilla/js/tests/ecma_3/Function/regress-145779.jsCreated attachment 84524\nExtending ecma_3/Function/regress-145779.js to cover other Ecma deviations\n\nThere are other problems with apply/call non-conformance.  ECMA 15.3.4.3\nrequires for apply to behave in the same way when passing undefined as first or\nsecond argument as in case of passing null:\n\n<i>If  thisArg is null or undefined, the called function is passed the global\nobject as the this value. Otherwise, the called function is passed\nToObject(thisArg) as the this value. \n\nIf argArray is null or undefined, the called function is passed no arguments.\nOtherwise, if argArray is neither an array nor an arguments object (see\n10.1.8), a TypeError exception is thrown. If argArray is either an array or an\narguments object, the function is passed the (ToUint32(argArray.length))\narguments argArray[0], argArray[1], ...,\nargArray[ToUint32(argArray.length)&#65533;1].</i>\n\nSimilarly ECMA 15.3.4.4 states for call:\n\n<i>If  thisArg is null or undefined, the called function is passed the global\nobject as the this value. Otherwise, the called function is passed\nToObject(thisArg) as the this value.</i>\n\nRhino does not behave as required for many cases of calling apply/call with\nnull or undefined but I think there is no point in creating additional bug\nreports for this so the the patch extends ecma_3/Function/regress-145779.js to\ncheck against the cited text.Created attachment 84531\nFixes to org/mozilla/javascript/baseFunction.java\n\nThe patch makes apply.length to return 2 and addresses apply(undefined) etc.\nissues.Igor: thank you for such thorough and precise tests! Following\nprevailing custom in the JS testsuite, I have CVS-deleted\n\n  mozilla/js/tests/ecma_3/Function/regress-145779.js\n\nand added Igor\'s tests in the following two testcases:\n\n  mozilla/js/tests/ecma_3/Function/15.3.4.3-1.js\n  mozilla/js/tests/ecma_3/Function/15.3.4.4-1.js\n\nwhich test ECMA-262 Edition 3\n\n  Section 15.3.4.3 (Function.prototype.apply)\n  Section 15.3.4.4 (Function.prototype.call)\n\nI can confirm that before Igor\'s patch, Rhino generated exceptions\non both these testcases, but with Igor\'s patch, both tests pass -I commited the patchIgor, thanks! Marking Fixed, then -And marking Verified FIXED. Both testcases now pass in Rhino:\n\n          mozilla/js/tests/ecma_3/Function/15.3.4.3-1.js\n          mozilla/js/tests/ecma_3/Function/15.3.4.4-1.js\n\nAnd that holds for both the compiled and interpreted modes of Rhino.Targeting as resolved against 1.5R4',?,BUG
149285,'Complier does not report the correct line number on SyntaxError:Invalid assignment left-hand side.',Rhino,Compiler,zoltan.luspai,norrisboyd,'This script throws an EcmaError which is correct, but the EcmaError contains \ninvalid 0 as line number for the error:\n\na=15;\nb=\'test\';\nif(DateTime.length() = 14)\n{\n}\n\nPlease see the attached JUnit test case reproduces the problem.Created attachment 86403\njunit test class demonstrates the problemFixed:\n\nChecking in IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <-- \nIRFactory.java\nnew revision: 1.23; previous revision: 1.22\ndoneZoltan, could you verify that this bug is now fixed? If so, please\nmark this bug \"Verified\"; otherwise, you can reopen it; thanks -Verified; it works fine. Thanks.Targeting as resolved against 1.5R4',?,BUG
151337,'EcmaError.getLineSource() returns 0x0 characters.',Rhino,Core,morten,norrisboyd,'The function EcmaError.getLineSource() returns 0x0 ascii characters if the \nsyntax error happened on a line that doesnt have a end of line before the \nscript ends (last line of the code that doesnt have a newline in the end).\n\nFor example, the script \"illegal javascript syntax\" will return \"illegal \njavascript syntax[][][][][][][][][]\" where [] is ascii 0x0.\n\n---- Little code showing the problem ----\nimport org.mozilla.javascript.*;\nimport java.io.*;\n\npublic class EcmaError {\n    public static void main(String args[]) \n        throws JavaScriptException, IOException\n    {\n        Context cx = Context.enter();\n        Scriptable scope = cx.initStandardObjects(null);\n        String s = \"\\njavascript syntax error\";  // A script with syntax error \nand no newline\n        try {\n        Object result = cx.evaluateString(scope, s, \"<cmd>\", 1, null);\n\n        } catch (EcmaError e) {\n            e.printStackTrace();\n            for (int i = 0 ; i < e.getLineSource().length() ; i++ )\n                System.out.print(\" \" + (int)(e.getLineSource().charAt(i)));  \n            System.out.println(\"\\nline is : \\\"\" + e.getLineSource() + \"\\\" \n(length of line = \" + e.getLineSource().length() + \")\");\n        }\n        \n        Context.exit();\n    }\n}\n\n---- Run result ---\n106 97 118 97 115 99 114 105 112 116 32 115 121 110 116 97 120 32 101 114 114 \n111 114 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \n0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \n0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \n0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \n0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \n0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\nline is : \"javascript syntax error\" (length of line = 254)\n\nNotice the string is 254 characters long and have a lot of 0x0 ascii chars in \nthe end. Sounds like a end of buffer problem.Created attachment 91521\nTest java code as an attachment (save it as ErrorTest.java)\n\nThe test should print PASSED if getLineSource returns proper stringCreated attachment 91522\nPatch including the fix among other things\n\nI committed the patch which is big due to removal of startString/getString as\nTokenStream uses own buffer.Fixed: it would be nice if Rhino will implement the line property of the error\nobject to match SM so the test case can be written in JS...Verified FIXED. Before the patch, the above testcase failed as follows:\n\nFAILED! e.getLineSource() does not match \'javascript syntax error\':\njavascript syntax \nerror\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x0\n0\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x0\n0\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\nx00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\n\n\nAfter the patch: \n\nPASSEDTargeting as resolved against 1.5R4',?,BUG
153223,'New RegExp engine in Rhino',Rhino,Core,pschwartau,rogerl,'A new RegExp implementation has been checked into Rhino. See, for example,\nbug 125562, \"Regexp performance improvement\".\n\nThis has fixed 6 Rhino bugs:\n  bug 106548  /^.*?$/ will not match anything\n  bug 114969  [], [^] are valid RegExp conditions\n  bug 123439  Backreferences /(a)? etc./ must hold |undefined| if not used\n  bug 124508  regexp.lastIndex should be integer-valued double, not uint32\n  bug 125562  Regexp performance improvement\n  bug 126317  Crash on re.exec(str) if re.lastIndex set to certain values\n\nAnd has fixed 6 test failures:\n  ecma_3/RegExp/regress-105972.js\n  ecma_3/RegExp/regress-100199.js\n  ecma_3/RegExp/regress-123437.js\n  ecma_2/RegExp/properties-002.js\n  ecma_3/RegExp/regress-85721.js\n  ecma_3/RegExp/15.10.6.2-2.js\n\n\nI have removed all 6 of these from the \"rhino-n.tests\" skip list.\n\n\nHowever, I am getting 6 new test failures:\n  ecma_2/String/match-002.js\n  ecma_2/String/match-003.js\n  ecma_3/String/regress-83293.js\n  ecma_3/Unicode/uc-002.js\n  ecma_3/Unicode/uc-004.js\n  js1_2/regexp/control_characters.js\n\n\nI am filing this bug to track this issue. I will attach an HTML \nfile of these test failures below, with hyperlinks to the testcases -Created attachment 88537\nNew RegExp test failuresFix checked in - variety of things:\n\n\'isWhitespace\' doesn\'t return \'true\' for non-breaking spaces.\nThe \'flat\' input string might be the empty string.\nMessed up sign extension from Byte to Char.\nMessed up flow-control for capture setting in \'Match\' vs. \'Test\' cases.The latest patch fixes all 6 of the new testcase failures I reported.\nHowever, it is causing one of the previous testcases to fail:\n\n\n*-* Testcase ecma_3/RegExp/regress-85721.js failed:\nBug Number 85721\nSTATUS: Performance: execution of regular expression\nFailure messages were:\n\nFAILED!: Section 1 of test -\n         Expected value \'Execution took less than 25 ms\',\n         Actual value   \'Execution took 63 ms\'\n\n\nFAILED!: Section 2 of test -\n\nregexp = /<sql:connection \nid=\"([^\\r\\n]*?)\">\\s*<sql:url>\\s*([^\\r\\n]*?)\\s*<\\/sql:url>\\s*<sql:driver>\\s*([^\\r\n\\n]*?)\\s*<\n\\/sql:driver>\\s*(\\s*<sql:userId>\\s*([^\\r\\n]*?)\\s*<\\/sql:userId>\\s*)?\\s*(\\s*<sql:\npassword>\\s*([^\\r\\n]*?)\\s*<\\/sql:password>\\s*\n)?\\s*<\\/sql:connection>/\n\nstring = \'<sql:connection id=\"conn1\"> <sql:url>www.m.com</sql:url> \n<sql:driver>drive.class</sql:driver>\\n<sql:userId\n>foo</sql:userId> <sql:password>goo</sql:password> </sql:connection>\'\n\n\nFAILED!: ERROR !!! regexp FAILED to match anything !!!\n\nExpect: [\"<sql:connection id=\"conn1\"> <sql:url>www.m.com</sql:url> \n<sql:driver>drive.class</sql:driver>\n<sql:userId>foo</sql:userId> <sql:password>goo</sql:password> \n</sql:connection>\", \"conn1\", \"www.m.com\", \"drive.class\n\", \"<sql:userId>foo</sql:userId> \", \"foo\", \"<sql:password>goo</sql:password> \", \n\"goo\"]\n\nActual: null\n\n\n\nSection 1 (performance measurement) can be adusted if 25 ms is too unrealistic.\nHowever, note that before the latest patch, this section passed.\n\nSection 2 is checking the accuracy of the regexp match. It is a complicated\none, and I\'m not sure what\'s going wrong...ggggaaaaaaaaaaaaarrrrrgghnnnnnnnnnhhhhh!\n\nI ran the tests, I swear I ran the tests.New fix checked in - isSpaceChar wasn\'t the right answer after all.\nRan all the tests - this time without any skip lists at all, I\'m getting 36 \nfailures (Phil - does this seem right?) though none seem RegExp related.Roger: that sounds about right, actually. There is a skip list \ncalled \"rhino-n.tests\" in the js/tests/ directory, and it contains\nabout that number. \n\nI will run the full testsuite myself on this and report back -Marking Verified Fixed.\n\nI get no test failures in either the compiled or interpreted modes\nof Rhino. I am using only the current rhino-n.tests as a skip list.\n\nAfter discussion with Roger, I have increased the time limit in\necma_3/RegExp/regress-85721.js to 100 ms for the performance tests.Targeting as resolved against 1.5R4',?,RFE
154693,'Interpreted mode doesn\'t grok different functions on different objects',Rhino,Core,erik,norrisboyd,'I have a script where I define a function on an object, I construct the object \ntwice and then Rhino thinks that the the functions in the two different objects \nare identical.  This only occurs in interpretted mode \n(Context.setOptimizationLevel(-1)).  I\'ll attach a test case to demonstrate the \nproblem.Created attachment 89456\nProblem script & test case.I forgot to mention that I also tried this against the latest release version \n(1.5 R3) and it demonstrates the same problem.Here is a simpler example to expose the problem in Rhino shell:\n\nfunction f() { \n\tfunction nested() { }  \n\treturn nested; \n}\n\nvar f1 = f(); \nvar f2 = f(); \n \nvar ok = (f1 != f2);\n\nprint(ok ? \"GOOD\" : \"BAD\");\n \nIgor: thank you for this test! I have added it to the JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-154693.js\n\nIt is currently passing in SpiderMonkey and Rhino compiled mode,\nbut failing in Rhino interpreted mode, as Erik reported -Created attachment 108053\nFix for omj/Interpreter.java\n\nThe reason for the bug is the current code in Interpreter.interpret that\ninstead of creating new InterpretedFunction for each nested function statement\non function entry, put to the activation scope a function currently stored in\nInterpretedData.itsNestedFunction. \n\nI believe the patch fixes that (Rhino passes all tests with it) but as it\nremoves redundant generation of CLOSURE statements for each nested function\nstatement, as it seems they are only needed for function expression and\nfunction expression statements, it would be nice to here something from someone\nwho wrote initial code.Created attachment 108193\nReduced version of the previous patch as I commited part of it\n\nI commited essentially cosmetics part of the previous patch as it reduces\ncodesize and makes a real bug fix smaller which still needs some considerations\nbefore the commit.Created attachment 108404\nAnother patch reduction due to a partial commit\n\nI commited another part of the patch where it removes closure icode generation\nfor function statements. It seems for me it was a bug on its own.\n\n diff -u -r1.115 Interpreter.java\n--- Interpreter.java\t4 Dec 2002 09:49:07 -0000\t1.115\n+++ Interpreter.java\t5 Dec 2002 20:57:58 -0000\n@@ -271,13 +271,20 @@\n\t switch (type) {\n \n\t     case TokenStream.FUNCTION : {\n-\t\t Node fn = (Node) node.getProp(Node.FUNCTION_PROP);\n-\t\t int index = fn.getExistingIntProp(Node.FUNCTION_PROP);\n-\t\t iCodeTop = addByte(TokenStream.CLOSURE, iCodeTop);\n-\t\t iCodeTop = addIndex(index, iCodeTop);\n-\t\t itsStackDepth++;\n-\t\t if (itsStackDepth > itsData.itsMaxStack)\n-\t\t     itsData.itsMaxStack = itsStackDepth;\n+\t\t FunctionNode fn\n+\t\t     = (FunctionNode) node.getProp(Node.FUNCTION_PROP);\n+\t\t if (fn.itsFunctionType != FunctionNode.FUNCTION_STATEMENT) {\n+\t\t     // Only function expressions or function expression\n+\t\t     // statements needs closure code creating new function\n+\t\t     // object on stack as function statements are initialized\n+\t\t     // at script/function start\n+\t\t     int index = fn.getExistingIntProp(Node.FUNCTION_PROP);\n+\t\t     iCodeTop = addByte(TokenStream.CLOSURE, iCodeTop);\n+\t\t     iCodeTop = addIndex(index, iCodeTop);\n+\t\t     itsStackDepth++;\n+\t\t     if (itsStackDepth > itsData.itsMaxStack)\n+\t\t\t itsData.itsMaxStack = itsStackDepth;\n+\t\t }\n\t\t break;\n\t     }I commited the fix, so the bug can be marked as fixed.Marking FIXED -Marking Verified Fixed.\n\nThe above testcase used to pass in Rhino compiled mode,\nbut fail in interpreted mode. Now it passes in both -Targeting as resolved against 1.5R4',?,BUG
157196,'ScriptableObject needs custom serialization implementation',Rhino,Core,igor,norrisboyd,'Currently ScriptableObject uses the standard Java support for serialization of\nits data structures from hashtable implementation. But this does not work\nproperly as long as the slots array contains deleted entries marked with the\nREMOVED slot tag. The standard Java de-serialization restores such entries to a\nreference to a newly allocated object which != REMOVED. Such entries will stick\nwith hashtable forever and at some point will violate internal sanity checks.\n\nIn addition, the standard serialization waists storage as it takes room to store\nempty/deleted slots.Created attachment 91169\nCustom serialization of ScriptableObject\n\nThe patch marks slots array as transient and adds writeObject/readObject that\nwrite/read only existing slots in the hashtable. I had also to change\nimplementation of sealObject to set count to -1 - count so it would be possible\nto know amount of existing slots without searching throw the slots array even\nin the sealed object.Created attachment 91548\nStress test for ScriptableObject serialization\n\nSave it as SerTest.javaFixed: I commited the patch as it passes the above stress test.Verified FIXED. Before the patch, the above testcase failed as follows:\n\nException in thread \"main\" java.lang.RuntimeException: FAILED!\n        at SerTest.test(SerTest.java:36)\n        at SerTest.main(SerTest.java:12)\n\n\n\nAfter the patch:\n\nPASSEDTargeting as resolved against 1.5R4',?,DESIGN_DEFECT
157509,'No error on invalid usage of \\ in identifiers',Rhino,Core,igor,norrisboyd,'Rhino does not throw SyntaxError on invalid \\ usage in identifiers like in:\n\nvar a\\b;\n\nIn general, as long as \\ in the middle of the identifier does not follow by u,\nRhino silently swallow that:\n\ntry {\n\teval(\"var a\\\\1 = 0; print(a\\\\1); \");\n} catch (e) {\n\tprint(e);\n}\n\nwhich prints 0 while SM correctly prints:\n\nSyntaxError: illegal characterTestcase added to JS testsuite:\n\n          mozilla/js/tests/ecma_3/Statements/regress-157509.js\n\nAs Igor says, this is passing in SpiderMonkey, failing in Rhino -Created attachment 91382\nTokenStream refactoring\n\nI commited the patch with the following comments:\n--\nI changed TokenStream to use internal buffer in place of\nLineBuffer#startString/\ngetString to store currently read characters for identifiers, strings and\nnumber\ns. For the price of yet another character coping it allows to simplify code\nlogi\nc especially regarding interaction with LineBuffer.\n--With the above patch commited Rhino passes\nmozilla/js/tests/ecma_3/Statements/regress-157509.js\nVerified FIXED. Testcase now passes in both the rhino, rhinoi shells -Targeting as resolved against 1.5R4',?,BUG
158159,'Should Rhino support octal escape sequences in regexps?',Rhino,Core,pschwartau,rogerl,'This is the Rhino version of SpiderMonkey bug 141078. \nThe testcase is:\n\n        mozilla/js/tests/ecma_3/RegExp/octal-001.js\n\nOctal escape sequences in regexps were accepted in ECMA-262 Edition 2\nbut deprecated in ECMA-262 Edition 3. In bug 141078, SpiderMonkey has\ndecided to support octal escape sequences for backward compatiblity. \n\nI assume we want to keep the Rhino regexp engine in synch, so I am \nfiling this bug to track this issue.Fix checked in.Umm. Actually I got ahead of myself on this - Norris, did you have any thoughts\non whether \'tis better to pursue SpiderMonkey or ECMA3 compatibility here?There are now two testcases for this bug:\n\n        mozilla/js/tests/ecma_3/RegExp/octal-001.js\n        mozilla/js/tests/ecma_3/RegExp/octal-002.js\n\nBoth are currently passing with the patch Roger has committed.I think this can be closed now as fixed, right?I don\'t see why not.Marking Verified Fixed.\n\nBoth testcases above are still passing in Rhino, both in interpreted\nand compiled mode -Targeting as resolved against 1.5R4',?,RFE
159334,'The javascript functions size is limited by a bug',Rhino,Core,ycoquillard,norrisboyd,'As far as I understand Rhino\'s source code, I think it\'s a bug. It is present \non both versions 1.5R2 & 1.5R3. It occurs each time the number of token exceeds \n32767. \n\nV1.5R2 : org.mozilla.javascript.Interpreter:getString()\nV1.5R3 : org.mozilla.javascript.Interpreter.getShort()\n\nThe way the index to enter the token\'s table (theStringTable) is computed can \nresult in negative numbers. \n\nHere\'s the code in 1.5R2 ;\n\n    private static String getString(String[] theStringTable, byte[] iCode,\n                                    int pc){\n        int index = (iCode[pc] << 8) + (iCode[pc + 1] & 0xFF);\n        return theStringTable[index];\n    }\n\nAs iCode is a table of bytes, iCode[pc] can result in a negative number. Here\'s \nan ugly-coded patch ;\n\n    private static String getString(String[] theStringTable, byte[] iCode,\n                                    int pc){\n\tint a1 = iCode[pc];\n\tif ( a1<0 ) a1 += 256;\n\ta1 = a1 << 8;\n\tint a2 = iCode[pc + 1];\n\tif ( a2<0 ) a2 += 256;\n\ta2 = a2  & 0xFF;\n\tint index = a1 + a2;\n        return theStringTable[index];\n    }\n\nAs I use some kind of code-generation, I have functions that exceed 2500 lines. \nBy using this patch, everything works fine. Sorry for my bad english, I hope \nthis will help :)(forgot the exception stack)\n\nException stack for v1.5R2 :\n\njava.lang.reflect.InvocationTargetException: \njava.lang.ArrayIndexOutOfBoundsException\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:1782)\n        at org.mozilla.javascript.InterpretedScript.call\n(InterpretedScript.java:68)\n        at org.mozilla.javascript.InterpretedScript.exec\n(InterpretedScript.java:59)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:778)\n        at net.com_6.js.RhinoInterpretor.evaluateReader\n(RhinoInterpretor.java:223)\n        at net.com_6.js.RhinoInterpretor.processFile(RhinoInterpretor.java:203)\n        at net.com_6.js.Global.include(Global.java:185)\n        at inv1.invoke()\n        at org.mozilla.javascript.FunctionObject.doInvoke\n(FunctionObject.java:519)\n        at org.mozilla.javascript.FunctionObject.callVarargs\n(FunctionObject.java:534)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:399)\n        at org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1225)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:1935)\n        at org.mozilla.javascript.InterpretedScript.call\n(InterpretedScript.java:68)\n        at org.mozilla.javascript.InterpretedScript.exec\n(InterpretedScript.java:59)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:778)\n        at net.com_6.js.RhinoInterpretor.evaluateReader\n(RhinoInterpretor.java:223)\n        at net.com_6.js.RhinoInterpretor.processSource\n(RhinoInterpretor.java:153)\n        at net.com_6.js.RhinoInterpretor.run(RhinoInterpretor.java:327)\n        at net.com_6.hiope.Main.<init>(Main.java:84)\n        at net.com_6.hiope.Main.main(Main.java:42)Created attachment 104747\nexplicit test case for script with 64K diffrent  tokensCreated attachment 104748\nExtending limit on number of different tokens to 64K\n\nThe Rhino tip already contains fixes to extend the limit from 32K name and\nstrings to 32K of different name and strings. This patch extends the limit\nfarther to 64K via storing indexes as uint16 and explicitly detects during byte\ncode generation the limit violations.Created attachment 104749\nTest with 0xFFFF names and string literals \n\nThis version passes in SM as wellIgor\'s testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-159334.js\n\nAs Igor indicates, this test passes in the SpiderMonkey shell.\nWithout the above patch, it fails in the current Rhino shell:\n\n*-* Testcase js1_5/Regress/regress-159334.js failed:\nExpected exit code 0, got 1\nTestcase terminated with signal 0\nComplete testcase output was:\n\njava.lang.ArrayIndexOutOfBoundsException: -32768\n  at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2231)\n  at org.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:64)\n  at org.mozilla.javascript.NativeGlobal.evalSpecial(NativeGlobal.java:530)\n  at     \norg.mozilla.javascript.ScriptRuntime.callOrNewSpecial(ScriptRuntime.java:1207)\n  at org.mozilla.javascript.ScriptRuntime.callSpecial(ScriptRuntime.java:1247)\n  at org.mozilla.javascript.gen.c17.call([path to]/regress-159334.js:67)\n  at org.mozilla.javascript.gen.c17.exec([path to]/regress-159334.js)\n  at org.mozilla.javascript.Context.evaluateReader(Context.java:820)\n  at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n  at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:354)\n  at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:291)\n  at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:283)\n  at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n  at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\nException in thread \"main\"Created attachment 104840\nNew version js1_5/Regress/regress-159334.js\n\nThe current version of js1_5/Regress/regress-159334.js takes too long time and\ntoo match memory to run under JDK 1.1. This patch changes it to bring time\ndown. It still necessary to specify 50M heap size to run it under JDK 1.1, but\nat least timing is resonable.I commited the patchIgor\'s new version of the test has been checked in:\n\nChecking in regress-159334.js;\n/cvsroot/mozilla/js/tests/js1_5/Regress/regress-159334.js,v  <--  \nregress-159334.js\nnew revision: 1.2; previous revision: 1.1\ndone\n\n\nIs it OK to mark this bug fixed, or is there further work left?\nThe testcase (new version) used to fail in Rhino as in Comment #5.\nNow, it passes in both the compiled and interpreted Rhino shells -Yes, then it should be marked as fixedResolving as Fixed -Marking Verified -Targeting as resolved against 1.5R4',?,BUG
164947,'Debugging unique.js produce a stack trace and erratic results.',Rhino,Core,michel,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nBuild Identifier: rhino1_5R2 or rhino1_5R3\n\nI\'m testing the rhino debugger under Window-XP with SUN JRE 1.4.0 and 1.3.1 \nwith the example \"unique.js\". I always get a java stark trace the second time \nI reach the line \"o[line] = true;\". After the stack trace, the debugger start \nto be erratic (at least, the watch window stop working). \n\nReproducible: Always\n\nSteps to Reproduce:\n1.Run the debugger\nIn my case, the command line is C:\\program\\j2sdk1.4.0\\bin\\java.exe -\nclasspath \".;js.jar\" org.mozilla.javascr\nipt.tools.debugger.Main unique.js unique.txt\n2.Step over each line up to the line \"o[line] = true;\"\n3.Step over this line twice\n\nActual Results:  \njava.lang.reflect.InvocationTargetException\n\n\tat java.awt.EventQueue.invokeAndWait(EventQueue.java:799)\n\n\tat javax.swing.SwingUtilities.invokeAndWait(SwingUtilities.java:1197)\n\n\tat org.mozilla.javascript.tools.debugger.Main.swingInvoke(Unknown \nSource)\n\n\tat org.mozilla.javascript.tools.debugger.Main.interrupted(Unknown \nSource)\n\n\tat org.mozilla.javascript.tools.debugger.Main.handleBreakpointHit\n(Unknown Source)\n\n\tat org.mozilla.javascript.Interpreter.interpret(Unknown Source)\n\n\tat org.mozilla.javascript.InterpretedScript.call(Unknown Source)\n\n\tat org.mozilla.javascript.InterpretedScript.exec(Unknown Source)\n\n\tat org.mozilla.javascript.Context.evaluateReader(Unknown Source)\n\n\tat org.mozilla.javascript.tools.shell.Main.evaluateReader(Unknown \nSource)\n\n\tat org.mozilla.javascript.tools.shell.Main.processFile(Unknown Source)\n\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Unknown \nSource)\n\n\tat org.mozilla.javascript.tools.shell.Main.exec(Unknown Source)\n\n\tat org.mozilla.javascript.tools.debugger.Main.main(Unknown Source)\n\nCaused by: java.lang.ArrayIndexOutOfBoundsException: -1 < 0\n\n\tat java.util.Vector.elementAt(Vector.java:437)\n\n\tat org.mozilla.javascript.tools.debugger.ContextWindow.actionPerformed\n(Unknown Source)\n\n\tat javax.swing.JComboBox.fireActionEvent(JComboBox.java:1196)\n\n\tat javax.swing.JComboBox.setSelectedItem(JComboBox.java:561)\n\n\tat javax.swing.JComboBox.setSelectedIndex(JComboBox.java:597)\n\n\tat org.mozilla.javascript.tools.debugger.UpdateContext.run(Unknown \nSource)\n\n\tat java.awt.event.InvocationEvent.dispatch(InvocationEvent.java:171)\n\n\tat java.awt.EventQueue.dispatchEvent(EventQueue.java:443)\n\n\tat java.awt.EventDispatchThread.pumpOneEventForHierarchy\n(EventDispatchThread.java:190)\n\n\tat java.awt.EventDispatchThread.pumpEventsForHierarchy\n(EventDispatchThread.java:144)\n\n\tat java.awt.EventDispatchThread.pumpEvents\n(EventDispatchThread.java:138)\n\n\tat java.awt.EventDispatchThread.pumpEvents\n(EventDispatchThread.java:130)\n\n\tat java.awt.EventDispatchThread.run(EventDispatchThread.java:98)Is it possible to get those unique.js unique.txt?Should be market as FIXED:\n\nThe bug is caused by calling setSelectedIndex(0) on JList at  when the list is\nempty at\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java#1723\nIt was taken care by a fix from Christopher Oliver and adding an explicit check\nnot to call setSelectedIndex when there are no frames.\n\nFrom Christopher Oliver email:\n\nI think this problem is the same as the one Marcus reported, see the below email\nexchange I had with him which contains the fix. It looks like this patch has\nalready been applied. That patch should also fix the problem reported in 164947.\n\nMarking FIXED as requested -Verified FIXED\n\nSTEPS TO REPRODUCE:\n1. cd //d/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R4/examples\n\n2. Compile \"File.java\" to produce \"File.class\":\n[//d/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R4/examples]\n$ //d/jdk1.4.1/bin/javac File.java\n\n3. Create a text file called \"unique.txt\" with more than one line in it.\nSave it to //d/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R4/examples.\n\n4. Open the debugger, providing \"unique.js\" and \"unique.txt\" as arguments: \n[//d/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R4/examples]\n$ java -classpath \".;../js.jar\" org.mozilla.javascript.tools.debugger.Main    \nunique.js unique.txt\n\n5. Note the file \"unique.js\" uses the File class to:\na) Open the file \"unique.txt\"\nb) Read it line-by-line in a loop\nc) Print each line to the debugger JavaScript Console\n\n\nThis all worked perfectly, even when \"unique.txt\" had several lines\nof text in it, forcing more than one access to the code reported above:\n\n                      o[line] = true;Targeting as resolved against 1.5R4',?,BUG
166530,'ClassCostException in FunctionObject static initializer',Rhino,Core,lkuoza,norrisboyd,'When I run unit tests that use rhino in JUnit GUI test tunner I receive the \nfollowing exception:\n\njava.lang.ExceptionInInitializerError: java.lang.ClassCostException: \norg.mozilla.javascript.optimizer.InvokerImpl\n  at org.mozilla.javascript.javascript.FunctionObject.newInvokerMaster(Unknown \nSource)\n  ...\n\nWhen I run it in JUnit text test runner, it works OK.\n\nI believe that it is because GUI JUnit uses its own class loader and Rhino uses \nits own.\n\nThe following test case might be used to reproduce bug:\n\n\npackage com.actimind.watf;\n\nimport junit.framework.*;\nimport org.mozilla.javascript.Context;\nimport org.mozilla.javascript.Scriptable;\n\npublic class RhinoTest extends TestCase\n{\n    public RhinoTest( String s )\n    {\n        super( s );\n    }\n\n    public void testRhino()\n    {\n        Context context = Context.enter();\n        try\n        {\n            Scriptable scope = context.initStandardObjects( null );\n        }\n        finally\n        {\n            context.exit();\n        }\n    }\n}\n\n\nJust run this in GUI JUnit test runner, and see what happens.\n\nI use Rhino 1.5R3Created attachment 110302\nTo search in DefiningClassLoader.loadClass(String name, boolean resolve) for classes not defined by the class loader itself use parent loader, not the one obtained via Thread.getContextClassLoader()\n\nVarious parts of Rhino need to define classes based on generated code and for\nthat they use org.mozilla.classfile.DefiningClassLoader. Currently its\nDefiningClassLoader.loadClass(String name, boolean resolve) method when\nsearches for a class not defined by the loader itself calls\nThread.getContextClassLoader() on the assumption that an application may call\nThread.setContextClassLoader() to alter class loader for a particular thread. \n\nBy default Thread.getContextClassLoader() returns the system classes loader and\nif Rhino classes are not loaded through it, then any reference to a Rhino class\nfrom the generated byte code would either lead to ClassNotFoundException or if\na copy of Rhino is available on the system loader to ClassCastException later\nas in JVM classes with the same name but different class loaders are treated as\ndifferent classes. The later case I believe is the reason for the reported\nerror.\n\nTo resolve the issue, the patch changes DefiningClassLoader.loadClass to look\nfor a class from the parent class loader, which points to the loader that loads\nRhino classes and this is what necessary in all cases involving\nDefiningClassLoader usage.Created attachment 110304\nSmall fix to the previous version: the parentLoader field should be privateI committed the above patch with few other changes to replace calls to\nThread.getContextClassLoader() by using a proper parent class loader for\ngenerated code. This fixed I believe a similar problem reported by Mike Gillam\nas he confirmed that after the changes the following is no longer an issue:\n\nMike Gillam <mgillam@attbi.com> wrote to netsacpe.public.mozilla.jseng:\n...\nI am using Rhino to script business objects implemented within an EJB\nSession object.\n\nEverything works fine until I redeploy the .EAR file.  After\nredeployment, none of the methods I expose in the ScriptableObject\nclasses work.  I get a ClassCastException.\n...\n\n org.mozilla.javascript.JavaScriptException:\njava.lang.ClassCastException\n \tat\norg.mozilla.javascript.JavaScriptException.wrapException(JavaScriptException.java:69)\n \tat org.mozilla.javascript.FunctionObject.call(FunctionObject.java:439)\n \tat org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1225)\n \tat\norg.mozilla.javascript.gen.c85.call(IDBE_Pricing_Policy::SIZE_CRUST::IDV_Pricing_Formula:2)\n \tat com.moose.bos.BusinessRule.execute(BusinessRule.java:88)\n \tat com.moose.erp.PricingPolicy.price(PricingPolicy.java:88)\n \tat com.moose.erp.ItemHasPrice.price(ItemHasPrice.java:106)\n \tat com.moose.erp.Attribute.price(Attribute.java:225)\n \tat\ncom.moose.erp.ItemHasAttributes.describeConfiguration(ItemHasAttributes.java:186)\n \tat com.moose.erp.Item.configure(Item.java:245)\n \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n \tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n \tat java.lang.reflect.Method.invoke(Method.java:324)\n \tat com.moose.bos.BusinessObj.callCommand(BusinessObj.java:69)\n \tat com.moose.bos.BusinessObj.process(BusinessObj.java:488)\n \tat com.moose.bos.Entity.process(Entity.java:1507)\n \tat com.moose.bos.BusinessObj.processMessage(BusinessObj.java:574)\n \tat com.moose.bos.Server.processMessage(Server.java:973)\n \tat com.moose.bos.Server.processExternalMessage(Server.java:865)\n \tat com.moose.ejb.BOSSessionStatelessBean.process(BOSSessionStatelessBean.java:125)\n \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n \tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n \tat java.lang.reflect.Method.invoke(Method.java:324)\n \tat\norg.jboss.ejb.StatelessSessionContainer$ContainerInterceptor.invoke(StatelessSessionContainer.java:664)\n \tat\norg.jboss.resource.connectionmanager.CachedConnectionInterceptor.invoke(CachedConnectionInterceptor.java:186)\n \tat\norg.jboss.ejb.plugins.AbstractTxInterceptor.invokeNext(AbstractTxInterceptor.java:96)\n \tat\norg.jboss.ejb.plugins.AbstractTxInterceptorBMT.invokeNext(AbstractTxInterceptorBMT.java:144)\n \tat org.jboss.ejb.plugins.TxInterceptorBMT.invoke(TxInterceptorBMT.java:62)\n \tat\norg.jboss.ejb.plugins.StatelessSessionInstanceInterceptor.invoke(StatelessSessionInstanceInterceptor.java:77)\n \tat org.jboss.ejb.plugins.SecurityInterceptor.invoke(SecurityInterceptor.java:129)\n \tat org.jboss.ejb.plugins.LogInterceptor.invoke(LogInterceptor.java:166)\n \tat\norg.jboss.ejb.StatelessSessionContainer.invoke(StatelessSessionContainer.java:313)\n \tat org.jboss.ejb.Container.invoke(Container.java:705)\n \tat org.jboss.mx.server.MBeanServerImpl.invoke(MBeanServerImpl.java:491)\n \tat org.jboss.invocation.local.LocalInvoker.invoke(LocalInvoker.java:98)\n \tat org.jboss.invocation.InvokerInterceptor.invoke(InvokerInterceptor.java:102)\n \tat org.jboss.proxy.TransactionInterceptor.invoke(TransactionInterceptor.java:73)\n \tat org.jboss.proxy.SecurityInterceptor.invoke(SecurityInterceptor.java:76)\n \tat\norg.jboss.proxy.ejb.StatelessSessionInterceptor.invoke(StatelessSessionInterceptor.java:111)\n \tat org.jboss.proxy.ClientContainer.invoke(ClientContainer.java:76)\n \tat $Proxy29.process(Unknown Source)\n \tat com.moose.servlet.BOSSrvlet.callBOS(BOSSrvlet.java:108)\n \tat\ncom.moose.servlet.ConfiguratorServlet.buildConfigFrame(ConfiguratorServlet.java:269)\netc.....\nMarking FIXED -Tentatively marking Verified; Leonid, can you confirm\nthat the bug is fixed with the latest Rhino source?\n\nIf not, you can reopen this bug; thanks -Targeting as resolved against 1.5R4',?,BUG
169830,'Array.concat(function) doesn\'t add function to the array',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 169795 against SpiderMonkey.\nOther datatypes are being successfully pushed by Array.prototype.concat(),\nbut not function datatypes:\n\njs> x = \'Hi\';\nHi\njs> [].concat(x);\nHi\n\njs> x = 1;\n1\njs> [].concat(x);\n1\n\njs> x = {};\n[object Object]\njs> [].concat(x);\n[object Object]\n\n\njs> x = function() {}\n\nfunction () {\n}\n\njs> [].concat(x);\n                  <<<------------------- x WAS NOT PUSHED ONTO THE ARRAY !!!\njs> [].concat(x).length;\n0\n\n\nBy contrast, if we wrap the function object in an array,\nArray.prototype.concat() will successfully push it:\n\n\njs> x = function() {}\n\nfunction () {\n}\n\njs> [].concat([x])\n\nfunction () {\n}The testcase for this bug is\n\n      mozilla/js/tests/ecma_3/Array/15.4.4.4-001.js\n\nCurrently failing in both SpiderMonkey and Rhino -Created attachment 100405\nUse ScriptRuntime.instanceOf instead of hasLengthPropertyCommitted as the patch passed the testsuite.Igor: do you want to mark this as fixed?\n\nI can verify the fix: the above testcase is now passing \nfor me in the rhino and rhinoi shells on WinNT -To Phil: I can not mark the bug as fixed since I do not have permissions to do\nso. I changed my account e-mail to igor@icesoft.no as we got better anti-spam\nsoftware at work but now I realized that I lost a permission to alter bugs status...\n\nIgor: thanks; let me mark this as FIXED, then -Marking Verified FIXED -Targeting as resolved against 1.5R4',?,BUG
173180,'Rhino UTF-8 decoder accepts overlong sequences',Rhino,Core,pschwartau,norrisboyd,'This is the Rhino version of bug 172699 against SpiderMonkey.\nEXAMPLE: decodeURI(\"\%C0\%AF\").charCodeAt(0) should result in 65533\n\nThe testcase for this is\n\n      mozilla/js/tests/js1_5/Regress/regress-172699.js\n\nwhich is currently failing in Rhino:\n\n\n*-* Testcase js1_5/Regress/regress-172699.js failed:\nBug Number 172699\nSTATUS: UTF-8 decoder should not accept overlong sequences\nFailure messages were:\nFAILED!: Section 1 of test -\nFAILED!: Expected value \'65533\', Actual value \'37\'Created attachment 103523\nChecking for overlong\n\nThe patch merges utf8ToOneUcs4Char body into the decode method and adds checks\nfor overlongs to follow SpiderMonkey.I commited the above patch, so now Rhino passes the tests.Marking FIXED. \n\nThe above testcase now passes for me in the Rhino shells on WinNT,\nin both compiled and interpreted mode -Marking Verified -Targeting as resolved against 1.5R4',?,BUG
173906,'= 1',Rhino,Compiler,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; de-AT; rv:1.1) Gecko/20020826\nBuild Identifier: \n\nWhen optimization is set to 1 or higher, per-thread dynamic scopes stop working\nas soon as more than one nested function is executed. This means that as soon as\nI have one function calling another, variables will be looked up in the shared\nscope only instead of the per-thread scope.\n\nI\'m seeing this using both Rhino 1.5_R3 and the latest CVS version, running on\nJDK 1.3.1 on Mac OS X.\n\nThe bug is reproducable with a slightly modified version of\nexamples/DynamicScopes.java. (I\'m also attaching the modified source file.)\n\n--- DynamicScopes.java.orig     Fri Oct 11 11:03:13 2002\n+++ DynamicScopes.java  Fri Oct 11 11:04:27 2002\n@@ -63,6 +63,7 @@\n         throws JavaScriptException\n     {\n         Context cx = Context.enter();\n+        cx.setOptimizationLevel(1);\n         try {\n             cx.setCompileFunctionsWithDynamicScope(false);\n             runScripts(cx);\n@@ -84,7 +85,8 @@\n         // Now we can evaluate a script and functions will be compiled to\n         // use dynamic scope if the Context is so initialized.\n         String source = \"var x = \'sharedScope\';\" +\n-                        \"function f() { return x; }\";\n+                        \"function f() { return f2(); }\" +\n+                        \"function f2() { return x; }\";\n         cx.evaluateString(scope, source, \"MySource\", 1, null);\n \n         // Now we spawn some threads that execute a script that calls the \n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Run the modified version of DynamicScopes.java\n\nActual Results:  \nsharedScope\nsharedScope\nsharedScope\nsharedScope\nsharedScope\nsharedScope\n\nExpected Results:  \nsharedScope\nsharedScope\nsharedScope\nthread1\nthread0\nthread2Created attachment 102559\nModified version of DynamicScopes.java that produces the bugcc\'ing Igor -Created attachment 103842\nFix: change Codegen.visitCall to check for dynamic scope flag when calling direct call target\n\nThe patch fixes the reported problem but as currently there are no tests for\ndynamic scope mode I need at leat a confirmation that the patch works as\nexpected from a real-life Rhino usage.Thanks Igor, I just checked it out with some pretty complex Java/JavaScript\ncombination and everything works fine now (same results with optimization turned\non and off).I commited the patchBased on Hannes\' findings in Comment #4, marking FIXEDAnd marking Verified -Targeting as resolved against 1.5R4',?,BUG
177314,'Rhino should allow \'\\400\' to mean \' 0\'',Rhino,Core,user,norrisboyd,'Although octal escapes in string literals are not part of Ecma 262 since the\nversion 3, to support old scripts Rhino should handle them correctly. In\nparticular, currently Rhino throws an error when evaluating\n\'\\400\' == \' 0\'\n\njs> \'\\400\' == \' 0\'\njs: \"<stdin>\", line 1: uncaught JavaScript exception: SyntaxError: octal escape\ntoo large (<stdin>; line 1)\njs: \'\\400\' == \' 0\'\njs: ....^\n\nwhile SM gives true, which is what required by Ecma 262 version 1 and 2.Created attachment 104561\nAssume 3-char octal escape only if the result  <= 0377\n\nThe patch also removes msg.oct.esc.too.large from the resources as it is no\nonger usedI commited the above patch, as it passes the test suite and gives true \'\\400\' ==\n\' 0\'. The question is where to put a testcase for it?\nTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/LexicalConventions/regress-177314.jsMarking as fixed as the patch was commited.Marking Verified FIXED. \n\nBefore the patch, Rhino errored on the testcase as described above.\nNow, the testcase passes in both compiled and interpreted mode -Targeting as resolved against 1.5R4',?,IMPROVEMENT
179068,'String literals in Rhino are limited to 64K',Rhino,Core,user,norrisboyd,'Currently Rhino does not support long string literals with more then 64K of\ncharacters, which can be a problem to run it against automatically generated\nscripts.Created attachment 105575\nTest case \n\nTest that the interpreter can handle string literals exceeding 64K limit. For\nthat the script passes to eval \"str =\'LONG_STRING_LITERAL\';\" where\nLONG_STRING_LITERAL is a string with 200K chars.Created attachment 105577\nAllow to use char sequences exceeding 64K when storing source for decompilation\n\nThe current 64K limit comes from omj/Parser.java where it constructs the\ninternal script presentation for future decompilation. The patch extends this\nform to allow string sequences with more then 64K characters and modifes\ndecompilation code in omj/NativeFunction.java accordingly.Note that the above patch does not extend support for extremely long strings to\nthe compiler mode due to 64K limit on string in Java classfile format, but at\nleast with interpreter mode a Java-based browser can support a generate HTML\ncontaining\n\n<script>\n...\ndocument.write(\'HTML CODE WITH MORE THEN 64K CHARACTERS\');\n...\n</script>\n\nTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/String/regress-179068.jsI commited the fixMarking Verified FIXED.\n\nThe above testcase used to fail in Rhino; now it passes in both\ncompiled and interpreted mode on WinNT -Targeting as resolved against 1.5R4',?,IMPROVEMENT
179366,' after whitespace after line start should mean comments to line end',Rhino,Core,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\n\nThis is a Rhino version of bug 31255.\n\nRhino should follow SpiderMonkey and allow to treat --> after a possible\nwhitespace after line start to mean comments until line end.\n\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 105752\nPure JS test case to check that ^\\s*--> means comments\n\nTests in bug 31255 use scripts embedded in HTML, this is a pure JS version that\ncan be run against stand-along script engine.Created attachment 105755\npatch to omj/TokenStream.java\n\nThis is a replica of the SM solutionIgor\'s testcase added to JS testsuite. As is customary, I have \nnamed it after the original bug:\n\n      mozilla/js/tests/js1_5/Regress/regress-31255.jsI commited the fixMarking Verified FIXED.\n\nThe above testcase used to fail in Rhino; now it passes in both\ncompiled and interpreted mode on WinNT -Targeting as resolved against 1.5R4',?,SPEC
181654,'Calling toString for an object derived from the Error class throws TypeError',Rhino,Core,joerg.schaible,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; Q312461)\nBuild Identifier: Rhino 1.5 release 4 0000 00 00 (in progress)\n\nCalling the toString method for an object that is derived from the Error class \nresults in a thrown TypeError (Rhino only, works perfectly in SpiderMonkey).\n\nReproducible: Always\n\nSteps to Reproduce:\nregression test case attached\nActual Results:  \nTypeError raised\n\nExpected Results:  \nsame behaviour as with SpiderMonkey: method returns String with class name and \nerror message.\n\nEnvironment is reproducable with Rhino 1.5 RC4pre from current CVSCreated attachment 107245\njs\\tests\\ecma_3\\Exceptions\\regress-181654.js\n\nRegression test for this bug.J?rg\'s testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/Exceptions/regress-181654.jsConfirming what J?rg has reported. SpiderMonkey passes the above test,\nwhereas Rhino generates a TypeError. Here is an example:\n\n\n---------------------------  IN SPIDERMONKEY  ---------------------------\njs> function f() {}\njs> f.prototype = new Error();\nError\njs> obj = new f();\nError\njs> obj.toString();\nError\n\n\n---------------------------  IN RHINO  ---------------------------\njs> function f() {}\njs> f.prototype = new Error();\nError: undefined\njs> obj = new f();\njs: \"<stdin>\", line 25: uncaught JavaScript exception: TypeError:\nMethod \"toString\" called on incompatible object. (<stdin>; line 25)\njs> obj.toString();\njs: \"<stdin>\", line 26: uncaught JavaScript exception: TypeError:\nMethod \"toString\" called on incompatible object. (<stdin>; line 26)\n\n\nNote, no trouble in Rhino for a primary Error object:\n\njs> obj = new Error();\nError: undefined\njs> obj.toString();\nError: undefinedCreated attachment 107255\nMaking Error.prototype.toString generic\n\nI guess it is possible to argue that current Rhino behavior confirms Ecma 262,\nv3 as according to 15.11.4.4  Error.prototype.toString() returns an\nimplementation defined string, and throwing an exception can be very well\ndefined result ;).\n\nBut as not throwing exceptions fulfills 15.11.4.4 without guesses, here is a\npatch that effectively makes Error.prototype.toString a generic function\nprinting this.name + \": \" + this.message for any this.Can be marked as fixed as I commited the attachmentMarking FIXED -Marking Verified FIXED.\n\nThe above testcase now passes in the Rhino shell, in both compiled\nand interpreted modes. Here is an interactive session:\n\n[ ] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 4 0000 00 00 (in progress)\n\njs> function f() {}\njs> f.prototype = new Error();\nError:\njs> obj = new f();\nError:\njs> obj.toString()\nError:\n\njs> f.prototype = new SyntaxError();\nSyntaxError:\njs> obj = new f();\nSyntaxError:\njs> obj.toString()\nSyntaxError:\n\njs> f.prototype = new TypeError();\nTypeError:\njs> obj = new f();\nTypeError:\njs> obj.toString()\nTypeError:Targeting as resolved against 1.5R4',?,BUG
181834,'wrong scope used for inner functions when compiling functions with dynamic scopes (interpreted only)',Rhino,Core,felix.meschberger,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.2b) Gecko/20021016\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.2b) Gecko/20021016\n\ni fear, i found a scoping problem with rhino related to the \'compile functions\nwith dynamic scope\' feature. given the code :\n\n\tfunction outer( /* String */ arg ) {\n        var outer_d = 0;\n\t  function inner( /* int */ level ) {\n          outer_d++;\n          if (level > 0) {\n            inner( level - 1 );\n          } else {\n            return outer_d;\n          }\n        }\n        return inner(5);\n      }\n      var result = outer(\"arg\");\n\nshould set the result variable to 6, but this is what happens (where o is the\noptimization level and d is the dynamic function scope flag) :\n\n\to >= 0 && d     : result == 6\n\to >= 0 && !d    : result == 6\n\to == -1 && d    : ReferenceError: \"outer_d\" is not defined.\n\to == -1 && !d   : result == 6\n\nso it seems, as long as the code is compiled to a class file, execution works\nall right. but if the code is interpreted, something goes wrong with the scopes.\n\nby inspecting the code (Interpreter.java), i found out, that inner functions are\ncompiled with the context\'s compileFunctionsWithDynamicScope flag. in the\ndynamic case, this of course is the scope within which the outer function is\nrunning instead of the variable object of the outer function, in which the inner\nfunction is defined and obviously should be running.\n\ni assume, inner functions should always be compiled with static scope regardless\nof whether the context is set for dynamic scope compilations of functions or not.\n\nif i am correct, then the Interpreter.generateNestedFunctions method should\nprobably be added the line\n\n\t            jsi.itsData.itsUseDynamicScope = false;\n\nafter creating the InterpreterData instance.\n\ni tried it with the above sample code and it seems to fix the problem. though i\nam not sure, whether it runs fine with more thorough regression tests.\n\nwhat do you think of it ?\n\nregards, felix\n\nReproducible: Always\n\nSteps to Reproduce:\n1. make Context interpreting (optimizationLevel = -1)\n2. make Context \"compile\" functions with dynamic scope\n3. run the above script and see the error noted using the shell tool.\n\nActual Results:  \nerror message : ReferenceError: \"outer_d\" is not defined.\n\nExpected Results:  \nthe variable should be set to 6.cc-ing igor.A possible fix can be rather nontrivial as it has to address the issue of\nfunctions defined by eval and new Function.\n\nFor example, int the above example should not give different results if \nfunction inner would be replaced by\n\ninner = new Function(\"level\", \"outer_d++; ...\");\n\nso setting itsUseDynamicScope should depend on if the scope during compilation\ntime is suitable for dynamic behaviour... I have a couple questions about the example:\n\n1. The parameter |arg| to the outer function plays no role\n   and can be omitted, right?\n\n2. Shouldn\'t there be a |return| statement here?\n\n         if (level > 0) {\n            inner( level - 1 );   <<<---- should be |return inner(level -1);|  (?)(1) yes, the argument arg to the outer function plays no role and the argument\nlevel to the inner function is only used to limit recursion depth.\n\n(2) hmpf, yes, of course the line should read\n        return inner(level-1);Felix: thanks. I\'ve added your test to the JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-181834.jsThis is related to bug 154693 where the problem is exposed without activation of\ndynamic scope. Created attachment 108605\nDo not use dynamic scope for nested functions and functions defined under with\n\nThe patch changes Interpreter to ignore dynamic scope flag for nested functions\nand functions defined inside with statements as in the first case a dynamic\nscope object should already present on the scope chain of a nested function and\nin the second case there is no good way to use a dynamic scope. For example,\nconsider a script compiled with dynamic scope on:\n\nvar f;\n\nwith (some_object) {\n  f = function() { ... }\n}\n\nhere f contains a function with some_object as its scope object. But if a\ndynamic scope object should be taken into account when resolving a particular\nreference during execution of the function, how should it interfere with\nsome_object? The patch takes a simple approach of ignoring dynamic scope in\nthis case as anything else would add a lot of code which nobody may use...Created attachment 108765\nPrev patch update due to unrelated changes in the InterpreterQuestion: is there any way for me to test this in the Rhino shell?\n\nWould the testcase above, mozilla/js/tests/js1_5/Scope/regress-181834.js,\nhave to include code to turn on the \'compile functions with dynamic scope\'\nfeature? Is that possible?Created attachment 109102\nPatch update due to partial commit\n\nI committed the patch part that check for dynamic scope flag at function\ninitialization, not during compilation phase. It removes difference between\nordinary functions and functions defined via Function constructor.In Rhino it is possible to check/switch to dynamic scope mode from JavaScript via:\n\nfunction setDynamicScope(flag) {\n\tif (this.Packages) {\n\t\tvar cx = this.Packages.org.mozilla.javascript.Context.getCurrentContext();\n\t\tcx.setCompileFunctionsWithDynamicScope(flag); \n\t}\n}\n\n\nfunction getDynamicScope() {\n\tif (this.Packages) {\n\t\tvar cx = this.Packages.org.mozilla.javascript.Context.getCurrentContext();\n\t\treturn cx.hasCompileFunctionsWithDynamicScope(); \n\t}\n}\n\nbut it would not affect function statements in the current script and prior that\npartial commit of the patch function expressions after switch to the dynamic\nscope mode are not affected either. Thus one has to either use Function, eval or\ncall load on another script to see the difference.Created attachment 109113\nYet another patch update\n\nWith more commits patch became ratjer small and readable but still it does not\nreduce its consiquences.Igor: thanks. I have added functionality from your Comment #11 \nto the testcase above, to set and unset the \'compile functions\nwith dynamic scope\' feature of Rhino. \n\nI use eval() to recompile the |outer| function each time\nI set or unset this feature.\n\nWith the latest build of Rhino, the testcase fails in both interpreted\nand compiled modes with the error that Felix reported above:\n\n         ReferenceError: \"outer_d\" is not definedNote for the test cases: in Rhino eval and new Function always use the\ninterpreted mode, so the compilation mode under dynamic scope setup can not be\ntested that way.\n\nI commited the fix so the bug can be marked as fixed.Marking FIXED -Marking Verified Fixed.\n\nThe above testcase now passes in Rhino. As Igor indicated in Comment #14, \nhowever, this only exercises Rhino interpreted mode. To check Rhino\ncompiled mode, I tested interactively as follows:\n\n java org.mozilla.javascript.tools.shell.Main  -f file1.js -f file2.js\n\nwhere \"file1.js\" sets the dynamic mode and \"file2.js\" contains the test.\n\n\nWe found that Rhino compiled mode passed this test both before and after\nthe patch was committed. As reported above, it was only interpreted mode\nthat was having a problem on this.\n\nBut that\'s fixed now -thanks very much too all.Targeting as resolved against 1.5R4',?,BUG
181909,'some regression tests for Error invalid',Rhino,Core,joerg.schaible,pschwartau,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; Q312461)\nBuild Identifier: Rhino 1.5 release 4 0000 00 00 (in progress)\n\nThe regression tests js/tests/ecma_3/Exceptions/15.11.4.4-1.js and \njs/tests/ecma_3/Exceptions/regress-181654.js fail to test the meggase argument. \nThe validating comparison just checks for the content of Error.message in \nError.toString without checking whether the given message of the constructor is \ncontained in the message.\n\nReproducible: Always\n\nSteps to Reproduce:\n\nActual Results:  \njs/tests/ecma_3/Exceptions/regress-181654.js has a bug, that results in a \nmissing/empty Error.message member, but the test succeeds.\n\nExpected Results:  \nThe test should have failed.\n\ntwo patches will be attached.Created attachment 107385\njs\\tests\\ecma_3\\Exceptions\\15.11.4.4-1.js.patchCreated attachment 107387\njs\\tests\\ecma_3\\Exceptions\\regress-181654.js.patchCreated attachment 107392\njs\\tests\\ecma_3\\Exceptions\\regress-181654.js.patch\n\nCorrected another (copy & paste) bug in regression test.Assigning to self -Marking FIXED.\n\nJ?rg: thank you for your precise observations on this!\nI\'ve checked in your fixes to both tests -Marking Verified -Targeting as resolved against 1.5R4',?,TEST
182028,'Calling has() in get() of a ScriptableObject causes getter function to not be called',Rhino,Core,morten,norrisboyd,'If has() is called within get() of a ScriptableObject, lastAccess is set to the\nslot found by has. When my get() then calls super.get() into the\nScriptableObject, the lastAccess.value is returned to me and the getter method\nis not called. The cahched slot object (lastAccess) does not check for a getter\nmethod.\n\nThe following patch fixes the problem:\n\n[root@mmoeller rhino]# cvs diff -u src/org/mozilla/javascript/ScriptableObject.java\nIndex: src/org/mozilla/javascript/ScriptableObject.java\n===================================================================\nRCS file:\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v\nretrieving revision 1.55\ndiff -u -r1.55 ScriptableObject.java\n--- src/org/mozilla/javascript/ScriptableObject.java    24 Sep 2002 14:10:53\n-0000      1.55\n+++ src/org/mozilla/javascript/ScriptableObject.java    26 Nov 2002 17:20:03 -0000\n@@ -160,7 +160,12 @@\n         Slot slot = lastAccess; // Get local copy\n         if (name == slot.stringKey) {\n             // Cache match, check if it was not deleted\n-            if (slot.wasDeleted == 0) { return slot.value; }\n+            if (slot.wasDeleted == 0) {\n+                if ((slot.flags & Slot.HAS_GETTER) != 0) {\n+                    return getByGetter((GetterSlot) slot, name, start);\n+                }\n+                return slot.value;\n+            }\n         }\n\n         int hashCode = name.hashCode();cc\'ing Igor to consider this patch -The patch is right. In think it also makes sence to update the get method to\ncache last accessed slot even it has getter/setter, but that is something to\nconsider later.\n\nI can commit the patch later next week as I will be away for few days, but if\nNorris would like to freeze for 1.5R4 sooner, then it is a good idea to include\nthe patch before that.I commited a fix similar to the one outlined in the patch together with a bigger\nset of changes to remove a potential race condition in ScriptableObject.setBySetter.\n\nIt is possible to see the regression via simple a test case which uses the fact\nthat currently java object for LiveConnect is initialized via getter/setter:\n\nfunction f() {\n\t// put java into cache via ScriptableObject.has\n\tthis.hasOwnProperty(\"java\");\n\t// use java from cache via ScriptableObject.get\n\treturn this.java;\n}\n\nvar ok = (f() === java);\nprint(ok);\n\nThe test case printed false before the commit and true now. As the test is very\nimplementation-specific I doubt it would have any sence to add it to the test suite.Marking FIXED. I tested this on WinNT 4.0 using JRE 1.4.1-b21.\n\nAs Igor stated, the testcase above returned \'false\' before \nthe patch was committed, and now returns \'true\'\n\nI tried the testcase in the interpreted and compiled modes of Rhino,\nusing both the -f option to the Rhino shell, and the load() function.Marking Verified -Targeting as resolved against 1.5R4',?,BUG
184107,'with(...) { function f ...} should set f in the global scope',Rhino,Core,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\n\nWhen evaluationg the following test:\n\nvar x = {y:10};\nwith (x) {\n\tfunction f()  {\n\t\treturn y;\n\t}\n}\n\nvar result = f();\n\nvar ok1 = (x.f === undefined)\nprint(ok1)\n\nvar ok2 = (result === x.y);\nprint(ok2)\n\n\nRhino incorrectly put f into the x object instead of the global scope. \n\nThe test would work as expected if function f()... would be replaced by f =\nfunction()...\n\n\n\nReproducible: Always\n\nSteps to Reproduce:Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-184107.js\n\nCurrently passing in SpiderMonkey. In Rhino, the test fails in both\ncompiled and interpreted modes. As Igor states, function expressions\n\n      f = function()...\n\nare correctly created by Rhino in global scope, but function statements\n\n      function f() ...\n\nare being created in local scope.Created attachment 109964\nputting function expression statements always into activation object ignoring scopes introduced by with\n\nAfter the patch js1_5/Scope/regress-185485.js will fail as the patch follows SM\npath there and SM copes with this Ecma extension in a different way as Netscape\n4.* and it was decided that it was OK to keep the current SM behavior in this\nobscure case.I commited the fix.Verified FIXED. \n\nThe above testcase, js1_5/Scope/regress-184107.js, now passes in \nboth Rhino interpreted and comiled modes.\n\nThe testcase js1_5/Scope/regress-185485.js has now been corrected.\nIt now passes in Rhino as well as in SpiderMonkey -Targeting as resolved against 1.5R4',?,BUG
184111,'ArrayOutOfBounds Exception thrown when using Rhino Javascript Debugger',Rhino,Core,crafterm,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.2) Gecko/20021204 Debian/1.2.1-1\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.2) Gecko/20021204 Debian/1.2.1-1\n\nNote, this bug report relates to the Rhino version by Christopher Oliver that\nsupports Continuations available from\nftp://ftp.primaryinterface.com/pub/rhino/rhino1_5R4pre-sharedlocals.zip.\n\nWhen using the Rhino Javascript debugger under JDK 1.4 an ArrayOutOfBounds\nException is thrown when returning from a Continuation.\n\nAfter speaking with Christopher Oliver, the problem seems to be a general JDK\n1.4 bug that caches selected values in JComboBox, even after removeAllItems() is\ncalled. Since its a general defect Christopher and I thought we\'d report and get\nit fixed in the main CVS tree.\n\nReproducible: Always\n\nSteps to Reproduce:\nThe javascript code used is available from\nhttp://cvs.apache.org/viewcvs.cgi/xml-cocoon2/src/java/org/apache/cocoon/components/flow/javascript/system.js\n\n1. Enter a toplevel javascript method that creates a continuation and suicides()\n2. Continue the contination with the debugger calling \'step-into\', inside of the\nhandleContinuation() method.\n3. Press \'step-into\' again 2 times.\n\nActual Results:  \nFirst an ArrayOutOfBoundsException was thrown, then a Context related exception\nwas thrown.\n\nExpected Results:  \nThe debugger should have incremented the display to the next line.\n\nPatch fixing the defect follows:\n\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugge\nr/Main.java,v\nretrieving revision 1.28\ndiff -u -r1.28 Main.java\n--- toolsrc/org/mozilla/javascript/tools/debugger/Main.java     14 Nov 2002 21:1\n2:36 -0000      1.28\n+++ toolsrc/org/mozilla/javascript/tools/debugger/Main.java     7 Dec 2002 20:59\n:23 -0000\n@@ -1699,6 +1699,8 @@\n         db.context.disableUpdate();\n         int frameCount = contextData.getFrameCount();\n         ctx.removeAllItems();\n+        ctx.setSelectedItem(null); // workaround for JDK 1.4 bug that caches\n+                                   // selected value even after removeAllItems(\n) is called\n         toolTips.removeAllElements();\n         for (int i = 0; i < frameCount; i++) {\n             FrameHelper frame = contextData.getFrame(i);cc\'ing Igor -I commited the patch: see \nhttp://developer.java.sun.com/developer/bugParade/bugs/4712013.html for details\nof this JDK 1.4 bug.\n\nResolving as FIXED -Checkin verified -Targeting as resolved against 1.5R4',?,BUG
185165,'Decompilation of \"\\\\\" gives broken \"\\\"',Rhino,Core,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\n\nRhino does not decompile \"\\\\\"  string literal properly. Given\nfunction f() { return \"\\\\\"; } Rhino currently produces for print(f.toString())\n\nfunction f() {\n    return \"\\\";\n}\n\nwhich contains broken \"\\\"\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRun in the shell the following script:\n\n// Check that second decompilation of script gives the same string as first one.\n\nvar f1 = function() {\n\treturn \"\\\\\";\n}\n\nvar s1 = f1.toString();\n\nvar f2;\neval(\"f2=\"+s1);\n\nvar s2 = f2.toString();\n\nvar ok = (s1 === s2);\n\nprint(ok);\n\nActual Results:  \nThe shell signals syntax error:\njs: \"x.js#8(eval)\", line 3: uncaught JavaScript exception: SyntaxError:\nunterminated string literal (x.js#8(eval); line 3)\njs:     return \"\\\";\njs: ..............^\n\n\nExpected Results:  \nThe shell should print:\ntrueCreated attachment 109222\nFix for ScriptRuntime.escapeString to correctly escape \\\n\nThe above fix also removes code to escape single quote \' as it was unreachable\ndue to the previous if (\' \' <= c && c <= \'~\' && c != \'\"\') check.I commited the fix.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-185165.jsVerified FIXED.\n\nBefore the patch was applied, the testcase failed as Igor described.\nNow, the testcase passes in both the rhino and rhinoi shells -Targeting as resolved against 1.5R4',?,BUG
189183,'Debugger source frame window layering fix',Rhino,Core,crafterm,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.2.1) Gecko/20021226 Debian/1.2.1-9\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.2.1) Gecko/20021226 Debian/1.2.1-9\n\nWhen using jdk 1.4.1 on linux, the Rhino debugger doesn\'t automatically focus\nthe internal frames when tracing through applications spread across multiple\nsources. \n\nWhen tracing through an application that uses multiple sources, the currently\nactive window isn\'t brought to the front. Tracing succeeds, but the user needs\nto manually go through the \'window\' menu item to make the active internal frame\nvisible.\n\nAfter speaking with Christopher Oliver, it seems this problem is only apparent\nwith JDK 1.4.1\n\nReproducible: Always\n\nSteps to Reproduce:\n1. debug application that uses multiple source files\n2. trace through function that invokes a method in another source file\nActual Results:  \nObserved that the trace succeeds but the internal frame window isn\'t modified.\n\nExpected Results:  \nThe source file windows should be automatically focused when tracing between them.\n\nChristopher Oliver sent me a fix which I tested, I\'ll attach a patch after\nsubmitting this form.Created attachment 111615\nPatch to fix internal frame layering under jdk 1.4.1cc\'ing Igor -Marcus, could you check that with your fix everything is OK under JDK 1.3 as well?Hi Igor, testing with JDK 1.3.1 (under Linux) looks good.\n\nCheers, MarcusCreated attachment 112052\nSingle file testcase for debugger\n\nThe test case uses Function and eval to make debugger to show several windows.\nTo test, select \"Break on function enter\" in the Debug menu and press GO\nseveral time.I commited Christopher Oliver\'s patch, the bug can be market as fixed.\nMarcus, you could mark as it fixed as long the fix is in CVS and you can see\nthat is works. I could not mark it because I am not a bug owner or reporter. The\nverified status then should set somebody else.Using JDK 1.4.1-b21 on WinNT.\n\nMarking FIXED. I see the change in CVS and have tried the\ntestcase Igor provided in Comment #5, with good results -Marking Verified Fixed.\n\nWhen I follow the steps Igor gave in Comment #5, I see the\nnew debugger windows being created, and the most recent one,\ncorresponding to the active frame, gets put on top as desired -Targeting as resolved against 1.5R4',?,CLEANUP
189898,'Broken String.replace:  \"XaXY\".replace(\"XY\", \"--\") gives --aXY',Rhino,Core,user,rogerl,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: The third release candidadte of Rhino 1.5R4\n\nThe following scripts demonstartes the problem:\n\nvar result = \"XaXY\".replace(\"XY\", \"--\");\t\n\nvar expect = \"Xa--\"\n\nvar ok = result == expect;\n\nif (ok) {\n\tprint(\"OK\");\n} else {\n\tprint(\"FAILED: expected=\'\"+expect+\"\', result=\'\"+result+\"\'\");\n}\n\n\nIt looks like replace in general always match the first character if it starts\nthe match string\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the above script in the rhino shell\nActual Results:  \nFAILED: expected=\'Xa--\', result=\'--aXY\'\n\n\nExpected Results:  \nOKCC to Roger, this is a regression since 1.5R3Shorter titleConfirming and reassigning to Roger.\n\nCURRENT SPIDERMONKEY (as is; without patch for bug 85721)\njs> \"XaXY\".replace(\"XY\", \"--\")\nXa--\n\nCURRENT RHINO\njs> \"XaXY\".replace(\"XY\", \"--\")\n--aXY\n\nand yet:\n\njs> \"XaXY\".search(\"XY\")\n2FWIW:\n\nNote there is an important difference between the replace() method\nand the search() and match() methods of String.prototype, when the\nfirst parameter provided is a string and not a regexp. \n\nThis was a last-minute change made in the ECMA-262 Edition 3 spec.\nAs late as the Final Draft for Edition 3, the spec used to require\nthese to be equivalent:\n\n   str.replace(strA, strB) == str.replace(new RegExp(strA),strB)\n\n\nHowever, in bug 83293 Jim Ley pointed out that ECMA-262 Edition 3 Final \nchanged on this. String.prototype.replace (searchValue, replaceValue),\nif provided a searchValue that is not a RegExp, is NOT to replace it with\n\n                    new RegExp(searchValue)\nbut rather:\n                        String(searchValue)\n\n\nThis puts the replace() method at variance with search() and match(),\nwhich continue to follow the RegExp conversion of the Final Draft.\n\nSee ECMA-262 Edition 3 Final, 15.5.4.11 String.prototype.replace\n\nThis is of relevance if strings contain any regexp meta-characters\nlike \'$\', \'^\', etc.  If such a string is provided as a first parameter\nto the replace() method, these characters are to be interpreted as \nstring literals, unlike the case for search() and match().\n\nFinally, note the place to get the ECMA-262 Edition 3 Final is at\nhttp://www.mozilla.org/js/language (also note the list of errata).\nI am told that the version at the ECMA website itself is not current!Testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/String/regress-189898.js\n\nCurrently passing in SpiderMonkey, failing in Rhino -Note for String.prototype.replace semantics in MSIE:\n\nwww.microsoft.com contains JavaScript with expressions like:\n\n<html-fragment1>.replace(<html-fragment2>, <html-fragment3>) \n\nwhere <html-fragment2> contains at least . and ? and often JavaScript fragments\nfrom even handlers with +, [] etc.. So it is essential there that\n<html-fragment2> is treated as a string, not RegExp.\nThe REOP_FLAT node being generated for the \'flat\' entry-point used by replace\nwas constructed wrong. I also added error checks for bad quantifiers from\nSpiderMonkey bug 188206Verified FIXED.\n\nThe testcase for this bug is now passing in both the interpreted\nand compiled modes of Rhino:\n\n      mozilla/js/tests/ecma_3/String/regress-189898.js\n\n\nFurthermore, as Roger indicated, Rhino is also now passing the\ntestcase for bug 188206:\n\n      mozilla/js/tests/ecma_3/RegExp/regress-188206.js\n\nThis test deliberately misuses regexp quantifiers and checks\nfor SyntaxErrors to result. This is now working in Rhino -Yes, now www.microsoft.com works with the Rhino CVS version in our browser.Status CLOSED is deprecated as per bug 169885Re-Resolvingverifying former CLOSED bugsTrageting as resolved against 1.5R5Fixing wrong milestone assignment',?,BUG
190685,'Unexpected SyntaxError for /^{(.*)\\}$/',Rhino,Core,user,rogerl,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino  2003-01-25 CVS\n\nAlready applied fix for the bug 189898 broke js1_2/Objects/toString-001.js test\ncase which now fails with:\n\n*-* Testcase js1_2/Objects/toString-001.js failed:\nExpected exit code 0, got 3\nTestcase terminated with signal 0\nComplete testcase output was:\njs: uncaught JavaScript exception: SyntaxError: Invalid quantifier {\n\n\nThe test case fails when it declares the following regular expression:\n\n/^{(.*)\\}$/\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Run Rhino shell\n2. Enter there the foolowing regular expression:\n/{\\}/\nActual Results:  \njs: uncaught JavaScript exception: SyntaxError: Invalid quantifier {\n\n\nExpected Results:  \n/{\\}/Reassign to RogerAlthough the Ecma standard does not allow standalong {, but SM and js in MSIE\nallows it.Sigh. Once the mega-fix for 85721 goes in, SM will fail on this, too. ECMA\nclearly disallows this, but backwards and MSIE compatibility arguments are stronger.\n\nFix checked in.OK, double-sigh. Now regress-188206 will fail because we explicitly included \'{\'\nas a bad thing resulting from that bug report (bug 188206). Looking for\nsuggestions, back out this fix and stay with ECMA, or officially support \'{\' and\nchange the test ?FWIW:\n\nThe test js1_2/Objects/toString-001.js uses the regexp in question\nto check the output of the Object.prototype.toString() function.\n\nSuch output is expected to begin and end with a curly bracket.\nThis is the regexp the test uses to check for that:\n\nfunction checkObjectToString(s, a) {\n  var m = /^{(.*)\\}$/(s);\n  if (!m)\n    return false;  // should begin and end with curly brackets\n\n         etc.\n         etc.\n\n\nNotice that the right brace was escaped, but the left one not.\nIt looks simply like an oversight when the test was written.\n\nAs Roger indicates, the ECMA-262 Edition 3 Final spec is quite clear\nthat neither \'{\' nor \'}\' may appear in a regexp literal unescaped.\n\n\nHowever, note that Perl seems to allow \'{\' and \'}\' to appear unescaped.\nNote, I\'m switching between \'p\' and \'P\' as a sanity check:\n\nperl -e \'if (\"{p:1}\" =~ /{p/) {print(\"MATCH!\");} else {print(\"NO MATCH\");}\'\nMATCH!\nperl -e \'if (\"{p:1}\" =~ /{P/) {print(\"MATCH!\");} else {print(\"NO MATCH\");}\'\nNO MATCH\n\nperl -e \'if (\"{p:1}\" =~ /{p:1}/) {print(\"MATCH!\");} else {print(\"NO MATCH\");}\'\nMATCH!\nperl -e \'if (\"{p:1}\" =~ /{P:1}/) {print(\"MATCH!\");} else {print(\"NO MATCH\");}\'\nNO MATCH\n\n\nNow, let\'s try the specific regexp above:\n$ perl -e \'if (\"{p:1}\" =~ /^{(.*)\\}$/) {print(\"MATCH!\");}\'\nMATCH!\n\nHere, without the escape of \'}\':\n$ perl -e \'if (\"{p:1}\" =~ /^{(.*)}$/) {print(\"MATCH!\");}\'\nMATCH!\n\n\n\nFurthermore, all three of these browsers currently allow it:\nMoz/N6/N7, IE6, and N4.7. I will attach an HTML testcase below.\n\nNote we had a similar situation in bug 141078,\n\"Should JS support octal escape sequences in regexps?\"\n\nHere was Brendan\'s take on that issue: bug 141078 comment 2.Created attachment 112826\nHTML testcaseIn any case, I\'ve gone ahead and added the missing escape to the testcase.\nEven though it\'s \"historic\" (i.e. lies in the js1_2 directory), I couldn\'t\nfind any deliberate reason via bonsai for having the right brace escaped\nbut the left one not:\n\nhttp://bonsai.mozilla.org/cvslog.cgi?\nfile=mozilla/js/tests/js1_2/Objects/toString-001.jsI have modified mozilla/js/tests/ecma_3/RegExp/regress-188206.js\nto follow Perl custom regarding braces in regexp patterns.\n\nFor reference, from the \"perlre\" doc on the Web:\n\n----\nThe following standard quantifiers are recognized:\n\n   *      Match 0 or more times\n   +      Match 1 or more times\n   ?      Match 1 or 0 times\n   {n}    Match exactly n times\n   {n,}   Match at least n times\n   {n,m}  Match at least n but not more than m times\n\nIf a curly bracket occurs in any other context, it is treated\nas a regular character.\n----\n\n\nThe testcase now tests that braces may appear unescaped in regexp\npatterns, even they are not part of a quantifier. This will enforce \nbackward compatibility, and compatibility with IE.Created attachment 113066\nHTML testcase #2  (for Moz and IE only; NN4.x won\'t accept try...catch)Have to reopen this bug. With the new sections, testcase\necma_3/RegExp/regress-188206.js is failing in Rhino.\n\nThese sections use braces, unescaped, as literal characters\nin regexp patterns. Even though this is ECMA-incorrect, we\nexpect no errors, re the compatibility issues raised above -Fixed in patch for bug 85721Confirming - with the latest patch for bug 85721, the testcase\n\n      mozilla/js/tests/ecma_3/RegExp/regress-188206.js\n\npasses in SpiderMonkey; still failing in Rhino.Created attachment 128343\nCleaned up weird quantifier handlingFixed in bug 225926Trageting as resolved against 1.5R5',?,BUG
190841,'Generated classes have too low privileges',Rhino,Core,user,szegedia,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS from 2003-01-27\n\nCurrently any generated class will have lowest possible privileges which does\nnot allow to use the optimizer or scripting of Java classes with SecurityManager\ninstalled even if the Rhino classes are allowed to carry corresponding task.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRun Rhino shell with security manager installed and a polycy file that gives\nrhino classes all permissions, like in:\n\njava -Djava.security.manager \\\n  -Djava.security.policy=file:/home/some-path/java.policy \\\n  -Drhino.classes=file:/home/some-path/js.jar \\\n  -jar /home/some-path/js.jar \\\n  sectest.js\n\nwhere file:/home/some-path/java.policy is a modified java.policy from a JDK\ndistribution with the following lines added:\n\ngrant codeBase \"${rhino.classes}\" {\n\tpermission java.security.AllPermission;\n};\n\nand sectest.js contains the single line:\n\nprint(java.lang.System.getProperty(\"user.home\"));\n\nNote that it is essential to use a separated file for the test as in the\ninteractive mode the shell uses pure interpreter which works.\nActual Results:  \njs: uncaught JavaScript exception: java.security.AccessControlException: access\ndenied (java.util.PropertyPermission user.home read)\n\n\nExpected Results:  \nA path to user home directory, like /home/igorCreated attachment 112789\nDefine generated classes with the same privileges as rhino classes themselves\n\nThe patch effectively makes omj/DefiningClassLoader to call\nClassLoader.defineClass with ProtectionDomain argument containg necessary\nprivileges.The above patch is a post 1.5R4 stuff and I added it now just in case if someone\nwill have that problem when scripting java classes via JavaAdapter. There is a\npotential issue with the patch that may arise if Sun finally fix a nasty\nsecurity problem that effectively allows to gain any permission as long as the\napplication can create class loaders.\n\nAnother problem is that it uses to match reflection to stay within 1.1\ncompatibility. It may be better to have something like omj.jdk12 package for\ncode like that.Created attachment 193149\nA jar file which contains two Java source files that use Proxy to do JavaAdapter\'s job\n\nA problem with patches above is that it still depends on custom ClassLoader. \nAt least in Java 1.4 such approach will generate permission exception whenever\na custom ClassLoader is created.  As the result, codes that requires\nJavaAdapter to function will run into problems.\n\nRhino\'s default behavior cannot be run in Java Web Start Sandbox due to two\nreasons.\n\n1. Optimization flag is on by default, which would produce byte code.\n2. JavaAdapter requires some byte compilation of the code.\n\nAs the result, both requires custom ClassLoader to load new classes from byte\ncode.\n\nIn JDK 1.3, java.lang.reflect.Proxy allows dynamic creation of Java classes\nwithout using ClassLoader.  If we also turn off Context optimization flag,\ncustom ClassLoader won\'t be created and permission exception can be avoided.\n\nMy software CookJS (http://cookxml.sourceforge.net/cookjs/) has the\nProxyJavaAdapter class implemented.  The attached jar file contains the two\njava files cookxml.cookjs.util.ProxyHandler and\ncookxml.cookjs.util.ProxyJavaAdapter that can solve the problem.  It is not as\nfeature rich as JavaAdapter and mostly depend on JavaAdapter to do all the hard\nwork.\n\nThe following code shows how it works:\n\nScriptable scope = cx.initStandardObjects ();\ncx.setOptimizationLevel (-1);\nProxyJavaAdapter.init (cx, scope, true);\nObject result = cx.evaluateString (scope, code, src, 1, null);\n\nBasically it overrides the default JavaAdapter object in the scope.  Nothing in\nRhino 1.6R1 needs any changes.I found Heng\'s workaround very helpful, and pointed out how to grab just those bits from CookXML, here:\n\nhttp://kylecordes.com/2006/03/24/rhino-web-start/\n\nThis is not helpful for fixing Rhino, but it might be helpful for the next person who lands here via a web search (which I how I landed here).Also if you\'re looking to disable Rhino\'s compilation mode, you can remove all the classes in the org.mozilla.classfile package and Rhino is smart enough just to start up in interpreter mode. This is a real problem - I want to preserve JDK 1.1 compatibility for 1.6R3, but once it is out, we\'ll move over to at least 1.2 compatibility, and we\'ll be able to solve it by using a JDK 1.2-introduced defineClass() method that takes a ProtectionDomain argumentChanging priority to P5 based on recent bug triage.I encountered a similar bug in Rhino 1.6R7. \n\nI was using JavaAdapter in my script. According to the documentation of JavaAdapter, if I call\n\n    new JavaAdapter(java-class, javascript-object)\n\nRhino generates a class on the fly which delegates all calls to the methods of the javascript-object. However, the generated class does not have any security privileges so I got AccessControlException when SecurityManager was installed.\n\nAfter some debugging, I found the problem exists in \'loadAdapterClass\' method in JavaAdapter.\n\n       static Class loadAdapterClass(String className, byte[] classBytes)\n       {\n           GeneratedClassLoader loader\n               = SecurityController.createLoader(null, null);\n           Class result = loader.defineClass(className, classBytes);\n           loader.linkClass(result);\n           return result;\n       }\n\nNote the SecurityController.createLoader call has two NULL parameters. The second parameter should be a security domain, and the method creates a class loader with restrictions imposed by the security domain. Since the parameter is null in Rhino 1.6R7 implementation, the generated adapter class is loaded with no security domain, and there will be AccessControlException when Java Security Manager checks security permissions on this class.\n\nTo fix this bug, I think we need pass in proper security domain parameters in the SecurityController.createLoader call. The security domain should be the same one associated with the javascript-object (which is being adaptered).\n\nActually, we may follow the example in org.mozilla.javascript.optimizer.CodeGen class. The CodeGen class generates \'javascript-object\' which can be used with JavaAdapter and the generated byte codes are loaded with proper security domain information. The \'defineClass\' method in the class make use of security domain information properly:\n\n    private Class defineClass(Object bytecode,\n                              Object staticSecurityDomain)\n    {\n        Object[] nameBytesPair = (Object[])bytecode;\n        String className = (String)nameBytesPair[0];\n        byte[] classBytes = (byte[])nameBytesPair[1];\n\n        // The generated classes in this case refer only to Rhino classes\n        // which must be accessible through this class loader\n        ClassLoader rhinoLoader = getClass().getClassLoader();\n        GeneratedClassLoader loader;\n        loader = SecurityController.createLoader(rhinoLoader,\n                                                 staticSecurityDomain);\n        Exception e;\n        try {\n            Class cl = loader.defineClass(className, classBytes);\n            loader.linkClass(cl);\n            return cl;\n        } catch (SecurityException x) {\n            e = x;\n        } catch (IllegalArgumentException x) {\n            e = x;\n        }\n        throw new RuntimeException(\"Malformed optimizer package \" + e);\n    }\n\nIf JavaAdapter can obtain the security domain associated with the \'javascript-object\' class, then this bug can be fixed.\n  Created attachment 302760\nProposed bug fix on org.mozilla.javascript.JavaAdapter\n\nThis JavaAdapter.java is modified based on release 1.6R7.\n\nThe changes are in method loadAdapterClass() and getAdapterClass(), which now loads the adapter class using proper classloader and protection domain.Attila, please have a look my proposal. I\'m willing to make this issue closed in 1.7 release.Well, I\'ve looked into it, and unfortunately I don\'t think it is valid. The problem is that you\'ll mostly end up running with the CodeSource of js.jar, as the \"obj\" will more often than not be a NativeObject. \n\nNow, on the other hand, since the generated code is actually generated by Rhino, I believe we should use the CodeSource of JavaAdapter itself (as the meat of the generated methods delegate anyway to JavaAdapter static methods). When individual functions are invoked, they\'ll get their CodeSource applied to the current access context anyway, so all should be well. \n\nTherefore, I think the correct solution is to replace\n\nSecurityController.createLoader(null, null)\n\nwith something similar to:\n\nSecureClassLoader cl = (SecureClassLoader)JavaAdapter.class.getClassLoader();\nSecurityController.createLoader(cl, cl.getProtectionDomain().getCodeSource());\n\nof course, with safeguard provisions for cases when \"cl\" is not a SecureClassLoader, or when the SecurityController in effect does not, in fact, understand CodeSource (such is the price of an overgeneric SecurityController interface...).\n\nIf you agree, I can implement this fairly quickly.Ok, the logic I came up with is in the end:\n\n        Object staticDomain;\n        Class domainClass = SecurityController.getStaticSecurityDomainClass();\n        if(domainClass == CodeSource.class || domainClass == ProtectionDomain.class) {\n            ProtectionDomain protectionDomain = JavaAdapter.class.getProtectionDomain();\n            if(domainClass == CodeSource.class) {\n                staticDomain = protectionDomain == null ? null : protectionDomain.getCodeSource();\n            }\n            else {\n                staticDomain = protectionDomain;\n            }\n        }\n        else {\n            staticDomain = null;\n        }\n        GeneratedClassLoader loader = SecurityController.createLoader(null, \n                staticDomain);\n\nI added a \"SecurityController.getStaticSecurityDomainClass()\" method so that the security controller can declare the kind of the security domain object it expects -- our PolicySecurityController accepts CodeSource while our JavaPolicySecurity (found in shell) uses a ProtectionDomain, although I believe that\'s flawed, but don\'t want to touch it for now, so I\'ll rather make the JavaAdapter code more flexible.\n\nDo you agree with this solution?Attila, thanks for looking into this issue!\n\nActually, our ideas are not very different.\n\nThere are two decisions we need to make here about the two parameters passing to SecurityController.createLoader():\n\n1/ Which class loader should we pass to SecurityController? \n\nI think \"JavaAdapter.class.getClassLoader()\" should be fine. This means we use the class loader that loads Rhino. (You leave this parameter as null in your last post, is it a typo?)\n\n2/ Which ProtectionDomain/CodeSource to use?\n\nI think \"JavaAdapter.class.getProtectionDomain()\" should be fine. Since JavaAdapter is loaded from js.jar, in effect we assign js.jar\'s security privileges to the generated adapter class. \n\nIn your post, you were saying \"The problem is that you\'ll mostly end up running with the CodeSource of js.jar..\" I still don\'t see the problem of using CodeSource of js.jar. Your solution also has the same effect, isn\'t it?\n\nIn my proposed fix, \"obj.getClass().getProtectionDomain()\" will get the domain for NativeObject class in most of the cases; when the \'obj\' is not a NativeObject, I don\'t know what will happen. So \"JavaAdapter.class.getProtectionDomain()\" is more clear.\n(In reply to comment #13)\n> \n> 1/ Which class loader should we pass to SecurityController? \n> \n> I think \"JavaAdapter.class.getClassLoader()\" should be fine. This means we use\n> the class loader that loads Rhino. (You leave this parameter as null in your\n> last post, is it a typo?)\n\nActually, no. null will cause it to use Context.getApplicationClassLoader(), which I think is a better choice. In reality, it shouldn\'t really matter much, as it\'s really just used as the parent for a newly created class loader that will be used to load this single adapter only.\n\n> \n> 2/ Which ProtectionDomain/CodeSource to use?\n> \n> I think \"JavaAdapter.class.getProtectionDomain()\" should be fine. Since\n> JavaAdapter is loaded from js.jar, in effect we assign js.jar\'s security\n> privileges to the generated adapter class. \n> \n> In your post, you were saying \"The problem is that you\'ll mostly end up running\n> with the CodeSource of js.jar..\" I still don\'t see the problem of using\n> CodeSource of js.jar. Your solution also has the same effect, isn\'t it?\n\nYes. I was writing a reply to you as I was thinking about the issue, and didn\'t properly edit it post fact :-). I was going \"hm... this will usually use js.jar code source... hey, wait a minute, shouldn\'t it actually always use js.jar code source? Let\'s see if the generated code will ensure that further protection domain acrobatics are performed for individual function invocations... check, check... yes they are... okay, then we should really always use js.jar code source, as the generated code is basically constant modulo function names\".\n\nSo yes, we should always use the code source (or less preferably, protection domain) of js.jar for JavaAdapter generated code.\n\n> In my proposed fix, \"obj.getClass().getProtectionDomain()\" will get the domain\n> for NativeObject class in most of the cases; when the \'obj\' is not a\n> NativeObject, I don\'t know what will happen. So\n> \"JavaAdapter.class.getProtectionDomain()\" is more clear.\n> \n\nCommitted the fix:\n\n    Checking in src/org/mozilla/javascript/JavaAdapter.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\n    new revision: 1.111; previous revision: 1.110\n\nAlso:\n\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/JavaPolicySecurity.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/JavaPolicySecurity.java,v  <--  JavaPolicySecurity.java\n    new revision: 1.11; previous revision: 1.10\n    done\n    Checking in src/org/mozilla/javascript/SecurityController.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/SecurityController.java,v  <--  SecurityController.java\n    new revision: 1.13; previous revision: 1.12\n    done\n    Checking in src/org/mozilla/javascript/PolicySecurityController.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/PolicySecurityController.java,v  <--  PolicySecurityController.java\n    new revision: 1.8; previous revision: 1.7\n    done\n\nI have verified the fix in my application. It solves my problem.\n\nAttila, thanks for your hard work! Marking fixed since the changes are checked in.',?,DESIGN_DEFECT
191276,'this[name] gives unexpected undefined with optimizer',Rhino,Compiler,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS 2003-01-30\n\nThe following scripts when run in Rhino shell prints unexpected false, while the\ninterpreter mode prints correct true. Note that presence of never called\nunused_function with test(\"a\") line is essential, scripts work OK without it.\nThe bug presents at least since 1.5R3.\n\nfunction test(name) { return this[name]; }\n\nfunction unused_function() { test(\"a\"); }\n\nvar result = test.call({ a: \"aaa\" }, \"a\");\n\nvar ok = (result === \"aaa\")\n\nprint(ok)\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the test script against Rhino shell\nActual Results:  \nfalse\n\nExpected Results:  \ntrueCreated attachment 113087\nThe test case as a separated fileTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-191276.js\n\nHowever, I must say I do not get a failure when I run the testcase,\nnor the above script. In both Rhino compiled and interpreted modes,\nI get \"true\":\n\n[ ] java org.mozilla.javascript.tools.shell.Main -f 191276.js\ntrue\n[ ] java org.mozilla.javascript.tools.shell.Main -opt -1 -f 191276.js\ntrue\n\nI am using this version of Java:\n\n[ ] java -fullversion\njava full version \"1.4.1-b21\"\n\nHowever, it looks like my Ant compiler is using Java 1.3 to compile Rhino.\nThis is my $CLASSPATH variable:\n\nD:\\JS_trunk\\mozilla\\js\\rhino\\build\\rhino1_5R4\\js.jar;\nD:\\JS_TRUNK\\mozilla\\js\\tests\\src\\jstests.jar;\nD:\\Ant\\jakarta-ant-1.3\\lib\\ant.jar;\nD:\\Ant\\jakarta-ant-1.3\\lib\\parser.jar;\nD:\\Ant\\jakarta-ant-1.3\\lib\\jaxp.jar;\nD:\\jdk1.3.0_02\\lib\\tools.jar\n\nI recently tried to change that last one to my jdk1.4.1 directory\n(D:\\jdk1.4.1\\lib\\tools.jar), but Ant did not recognize it, and I\nhad to change it back to jdk1.3.0_02 in order to compile Rhino.\n\nDo you think I\'m not seeing the bug because of compiler differences\nlike that? I am on WinNT4.0, by the way -For test to fail it is necessary to use an optimization level greater then 0.\nThis what I got when the test fails when run jsDriver with the rhino9 engine:\n\n\n\n-*- executing: .../java org.mozilla.javascript.tools.shell.Main -opt 9  -f\n./js1_5/shell.js -f ./js1_5/Scope/regress-191276.js\n*-* Testcase js1_5/Scope/regress-191276.js failed:\nBug Number 191276\nSTATUS: Testing |this[name]| via Function.prototype.call(), apply()\nFailure messages were:\nFAILED!: [reported from test()] Section 1 of test -\nFAILED!: [reported from test()] Type mismatch, expected type string, actual type\nundefined\nFAILED!: [reported from test()] Expected value \'aaa\', Actual value \'undefined\'\nFAILED!: [reported from test()] \nFAILED!: [reported from test()] Section 2 of test -\nFAILED!: [reported from test()] Type mismatch, expected type string, actual type\nundefined\nFAILED!: [reported from test()] Expected value \'aaa\', Actual value \'undefined\'\nFAILED!: [reported from test()] \nFAILED!: [reported from test()] Section 3 of test -\nFAILED!: [reported from test()] Type mismatch, expected type string, actual type\nundefined\nFAILED!: [reported from test()] Expected value \'aaa\', Actual value \'undefined\'\nFAILED!: [reported from test()] \nFAILED!: [reported from test()] Section 4 of test -\nFAILED!: [reported from test()] Type mismatch, expected type string, actual type\nundefined\nFAILED!: [reported from test()] Expected value \'aaa\', Actual value \'undefined\'\nFAILED!: [reported from test()] \nThe reason for the bug is that omj/optimizer/Optimizer.java when optimizing code\nfor this[name] (see GETELEM switch, line 665,\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java#665\n) assumes a number context for GETELEM index node which is wrong.Created attachment 113199\nDo not assume number context for index in x[i]\n\nWith the patch applied the test case passes and the number of the tests failing\nwith VerifyError with optimization level > 0 remains the same.CC to Roger: hopefully I did not miss something in the above patch.I commited the fixMarking fixedVerified FIXED. The above testcase now passes in the Rhino shell.\nI tested with optimization levels set to -1, 0, 1, and 9.Targeting as resolved against 1.5R5',?,BUG
191633,'Rhino tokenizer should not use recursion',Rhino,Core,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS from 2003-02-02\n\nCurrently Rhino tokenizer calls itself recursively to process single line\ncomments which can lead to too deep recursion when processing many lines of //\ncomments.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Run Rhino shell against the following attached JavaScript file\n\nActual Results:  \nException in thread \"main\" java.lang.StackOverflowError\n        at org.mozilla.javascript.TokenStream.getToken(TokenStream.java:753)\n        at org.mozilla.javascript.TokenStream.getToken(TokenStream.java:1197)\n\n\nExpected Results:  \nSingle true should be printedCreated attachment 113335\nTest case: calling eval on a string with 40000 lines of // commentsCreated attachment 113336\nReplace tail recursion in TokenStream.getToken by a loop\n\nThe patch also removes unused TokenStream.isJSIdentifier() and adds few\noptimizations not to call java.lang.Character methods for ASCII characters.\n\nIn addition patch makes sure that different occurrences of the same string\nreturned as the same String instance which allows to speedup the interpreter\nmode as different functions from a single script use the same string instances\nfor equals strings which reduces the need to call String.equals in various\nruntime hash tables.As this bug is not a regression since 1.5R3, its fixing should wait 1.5R4 release.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-191633.js\n\nThis passes in SpiderMonkey, but fails in Rhino as Igor indicated.\nSince the failure output is so enormous, I have temporarily added\nthe test to the rhino-n.tests skip list:\n\n      /cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\n      new revision: 1.52; previous revision: 1.51\n\nWe can remove it from the skip list once this fix is checked in -I commited the fix.Verified FIXED.\n\nThe above testcase now passes in the Rhino shell. I tested\noptimization levels -1, 0, 1, and 9.\n\nI will now remove the testcase from the rhino-n.tests skip list -rhino-n.tests has now been updated:\n\nChecking in rhino-n.tests;\n/cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\nnew revision: 1.54; previous revision: 1.53\ndoneTargeting as resolved against 1.5R5',?,IMPROVEMENT
191668,!-,Rhino,Core,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS from 2003-02-02\n\nRhino tokenizer violates single character lookahead restriction of\nomj.LineBuffer when implementing recognition of HTML comments <!-- . In\nparticular, LineBuffer assumes that calls to LineBuffer.match will not unread\nafter successful match, but code to recognize <!-- does exactly that as <! and\n<!- are valid sequence of JavaScript operators. \n\nThe following attached test case calls eval on \"if (0<!-0) ++j;\" prefixed by\nincreasing sequence of spaces to make sure that at some point <!- occurs on\ninternal buffer boundary when LineBuffer.unread can not work.\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the test by Rhino shell\nActual Results:  \nException in thread \"main\" java.lang.RuntimeException: FAILED ASSERTION\n        at org.mozilla.javascript.Context.codeBug(Context.java:2150)\n        at org.mozilla.javascript.LineBuffer.unread(LineBuffer.java:116)\n        at org.mozilla.javascript.TokenStream.getToken(TokenStream.java:1131)\n\n\nExpected Results:  \nThe test should print OKCreated attachment 113355\nTest caseAs the bug presents in 1.5R3, its fix should wait until 1.5R4 is released. Created attachment 113398\nFix: use special buffer for unreading of several chars and move the logic of recognizing line ends and format chars to TokenStream to follow SM more closely. LineBuffer is kept only for buferization.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-191668.js\n\nCurrently passing in SpiderMonkey, but failing in Rhino as\nIgor described above -Created attachment 113539\nPatch update\n\nThis is a patch update that integrates LineBuffer into TokenStream and teaches\nit to read tokens from String, not only java.io.Reader to avoid constructing\nStringReader/TokenStream buffer when evaluating scripts from strings.I commited the patchVerified FIXED.\n\nThe above testcase now passes in the Rhino shell. I tested\noptimization levels -1, 0, 1, and 9.Targeting as resolved against 1.5R5Fixing wrong milestone assignment',?,BUG
192105,'= 1',Rhino,Compiler,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS 2003-01-04\n\nWith optimization set to 1 or higher instanceof inside a function to test if the\nfunction is called as a constructor or not returns false if the function is\ncalled as constructor from some other function.\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the following attached test case with rhino shell with optimization set to 1.\nActual Results:  \nThe test case prints FAILED\n\nExpected Results:  \nIt should print OK\n\nThe test case ecma_3/Exceptions/regress-181914.js from the js test suite fails\nwith an infinite recursion for exactly this reason, just run it via jsDriver.pl\nwith the engine set to rhino9.Created attachment 113675\nThe test caseSince the bug is present in Rhino 1.5R3, the fix should wait until 1.5R4 is\nreleased.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Object/regress-192105.js\n\nThis passes in SpiderMonkey and in Rhino when optimization < 1.\nBut, as Igor reported, it fails if Rhino optimization is set >=1:\n\njava org.mozilla.javascript.tools.shell.Main -opt 1\n                             -f mozilla/js/tests/js1_5/shell.js\n                             -f mozilla/js/tests/js1_5/Object/regress-192105.js\n\n\nFAILED!: [reported from test()] Section 3 of test -\nFAILED!: [reported from test()] Expected value \'true\', Actual value \'false\'\nFAILED!: [reported from test()]\nFAILED!: [reported from test()] Section 5 of test -\nFAILED!: [reported from test()] Expected value \'true\', Actual value \'false\'\nFAILED!: [reported from test()]\nFAILED!: [reported from test()] Section 7 of test -\nFAILED!: [reported from test()] Expected value \'true\', Actual value \'false\'\n\n\nSections 3, 5, and 7 are precisely those which test if the\nfunction is called as constructor from some other function -Created attachment 113729\nFixing incorrect double call to setPrototype when generating constructDirect\n\nThe reason for the bug is that emitDirectConstructor generates code to call\nsetPrototype twice instead of setPrototype/setParentScope pair during new JS\nobject construction. The fix replaces that setup by a single call to\nBaseFunction.createObject which is used by Interpreter as well.I commited the fixVerified FIXED.\n\nThe above testcase now passes in the Rhino shell.\nI tested optimization levels -1, 0, 1, and 9.Targeting as resolved against 1.5R5',?,BUG
192226,'Wrong code generation for function calls inside with or catch',Rhino,Compiler,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS from 2003-02-07\n\nWith optimization set to at least one, optimizer fails when generating code for\na script function containing calls to to other functions inside the with or\ncatch statement. This bug is present at least since Rhino 1.5R3.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nTo test, run the following attached script with optimization set to 1.\n\n\nActual Results:  \nTest fails with NullPointerException in omj.optimizer.Codegen. If calls to\ntest0() in the test script are commented out, then it would fail with\njava.lang.VerifierError when loading the script.\n\n\n\nExpected Results:  \nShould print OK.Created attachment 113793\nTest caseCreated attachment 113794\nFix for incorrect application of simple call optimization for directly called functions. \n\nCodegen.visitRegularCall should not try to apply the simple call optimization\nwhen firstArgDone is true indicating directly called function. The patch also\nreplaces generation of code to call new Object[0] by loading the\nScripRuntime.emptyArgs field. \n\nTo be applied after 1.5R4.Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-192226.js\n\nThis passes in SpiderMonkey and in Rhino when optimization < 1.\nBut, as Igor reported, it fails if Rhino optimization is set >=1:\n\njava org.mozilla.javascript.tools.shell.Main -opt 1\n                                             -f js1_5/shell.js \n                                             -f js1_5/Scope/regress-192226.js\n\n\nException in thread \"main\" java.lang.NullPointerException\nat org.mozilla.javascript.optimizer.Codegen.visitRegularCall(Codegen.java:1927)\nat org.mozilla.javascript.optimizer.Codegen.visitCall(Codegen.java:1794)\n \n           etc.\n           etc.I commited the patchVerified FIXED.\n\nThe above testcase now passes in the Rhino shell. I tested\noptimization levels -1, 0, 1, and 9.Targeting as resolved against 1.5R5',?,BUG
192288,'= 1 gives bad class code',Rhino,Compiler,user,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.1) Gecko/20021003\nBuild Identifier: Rhino CVS from 2003-02-07\n\nWith optimization set to 1 or higher 0 / 0  in functions leads to bad class code\ntriggering java.lang.NoSuchFieldError during execution. The bug is present at\nleast since  Rhino 1.5R3 so its fix has to wait post 1.5R4 time.\n\nA simple test case is a script like\n\nfunction f() { return 0 / 0; }\nf();\n\nwhich gives java.lang.NoSuchFieldError: jsK_0\n\nThis is the reason why ecma/Expressions/11.5.2.js from the test suite currently\nfails when jsDriver.pl runs with --engine rhino9\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the following attached test case under Rhino shell with optimization set to\n1 or higher.\n\nActual Results:  \nException in thread \"main\" java.lang.NoSuchFieldError: jsK_0\n        at org.mozilla.javascript.gen.c1.call(/home/igor/w/js/x/opt.js:1)\n        at\norg.mozilla.javascript.optimizer.OptRuntime.callSimple(OptRuntime.java:275)\n        at org.mozilla.javascript.gen.c2.call(/home/igor/w/js/x/opt.js:3)\n        at org.mozilla.javascript.gen.c2.exec(/home/igor/w/js/x/opt.js)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:818)\n        at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:354)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:291)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:283)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\n\n\nExpected Results:  \nIt should print OK.Created attachment 113822\nTest caseTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Expressions/regress-192288.js\n\nThis passes in SpiderMonkey and in Rhino when optimization < 1.\nBut, as Igor reported, it fails if Rhino optimization is set >=1:\n\njava org.mozilla.javascript.tools.shell.Main -opt 1\n                                        -f js1_5/shell.js \n                                        -f js1_5/Expressions/regress-192288.js\n\n[ Exception as given above ]Created attachment 113855\nFix: call Codegen.addNumberConstant only once\n\nThe bug was caused by a double call to Codegen.addNumberConstant, the first\ntime correctly from Codegen.visitLiteral and the second time wrongfully from\nthe loop in emitConstantDudeInitializers where loop index should be used\ninstead of calling addNumberConstant. As addNumberConstant would return the\nsame index for same numbers, the bug surfaces only with NaN as\naddNumberConstant does not recognizes already added NaN. The bug also visible\nonly with optimization set to 1 or higher since only then constant folding can\nproduce NaN literal.\n\nThe patch removes the second call to addNumberConstant and uses\nScriptRuntime.NaNobj for NaNs.\n\nIt touches Context to make Context.codeBug() public and ScriptRuntime to make\nNaN and NaNobj final as a workaround for MS JVM bug can be done without making\nthese fields mutable.I commited the fixVerified FIXED. The above testcase now passes in the Rhino shell.\nI tested with optimization levels set to -1, 0, 1, and 9.Targeting as resolved against 1.5R5',?,BUG
193168,'Rhino debugger in v1.5R4 fails to update script source when a script is reloaded.',Rhino,Core,steven.beal,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: \n\nRhino debugger in v1.5R4 fails to update script source when a script is \nreloaded.  The executing code reflects the new script source but the\nsource displayed in the debugger is out of sync.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Reload a script using Context.getCurrentContext().evaluateReader()\n2.The script is reloaded but the source displayed in the debugger does not \nreflect the new source loaded.\n\n\n\n\nThis problem is a regression introduced with v1.29 of \norg.mozilla.javascript.tools.debugger.Main.java.\n\nAttached is a patch that restores the original behavior.\nThe refactorings introduced with v1.29 are preserved but the handling of\npreviously loaded SourceInfo objects is restored and the\ncheck for previously loaded ScriptItem instances\nremoved.Created attachment 114346\npatch that resolves Bug #193168 by restoring original behavior of handleCompilationdone()This problem was resolved on the rhino tip with v1.36 of \norg.mozilla.javascript.tools.debugger.Main.java.\n\nIf this fix is required without any other post 1.5R4 changes\nuse the attached patch.Verified FIXED. I made a small test file as follows:\n\nvar x;\nx = 1;\nx = 2;\nx = 3;\n//x = 4;\n//x = 5; \nprint(x);\n\nBefore I downloaded the patch for this bug, I ran this file in\nthe Rhino debugger and entered |x| into the Watch pane. I saw\nthe value of x correctly increment from 1 to 3.\n\nI went to the source and removed the comment signs. Back in the\ndebugger, I ran the file again. In the Watch pane, I could see\n|x| increment from 1 to 5 this time, but the source pane still\nshowed these lines as commented out!\n\nAfter downloading the fix for this bug, I repeated the same steps.\nThis time, the source pane updated correctly to the new source,\nas the variable |x| incremented from 1 to 5:\n\nvar x;\nx = 1;\nx = 2;\nx = 3;\nx = 4;\nx = 5; \nprint(x);*** Bug 202140 has been marked as a duplicate of this bug. ***Targeting as resolved against 1.5R4.1',?,BUG
193418,'= 1',Rhino,Compiler,user,norrisboyd,'Empty block {} triggers NullPointerException when optimization >= 1\n\nWith optimization level set to 1 or higher empty block { } usage can trigger\nNullPointerException in the compiler.\n\nTo reproduce, run the following script against Rhino shell with the optimization\nlevel set to 1:\n\n//-------TEST START --------------------------------\nvar test = false;\n\nfunction f() {\n  while (0) {\n    {  }\n  }\n  test = true;\n}\n\nf();\n\nprint(test ? \"OK\" : \"FAILED!\");\n//-------TEST END ----------------------------------\n\n\nThe test should print \"OK\" but instead the following stack trace appears:\n\n\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.optimizer.Block.buildBlocks(Block.java:137)\n        at\norg.mozilla.javascript.optimizer.Optimizer.optimizeFunction(Optimizer.java:71)\n        at org.mozilla.javascript.optimizer.Optimizer.optimize(Optimizer.java:149)\n        at org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:95)\n        at org.mozilla.javascript.Context.compile(Context.java:2072)\n        at org.mozilla.javascript.Context.compile(Context.java:2002)\n        at org.mozilla.javascript.Context.compileReader(Context.java:897)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:815)\n        at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:354)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:291)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:283)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)Created attachment 114504\nFixing tree iteration problem in Optimizer.buildStatementList\n\nThe bug caused by missed check in StmtNodeIterator.nextNode for a possible null\nresult of findFirstInterestingNode inside the search loop which made search to\nstop preliminary with non-empty stack.\n\nThe patch fixes this and integrates StmtNodeIterator into\nOptimizer.buildStatementList as StmtNodeIterator was used only by\nbuildStatementList and the new version is simpler.I commited the fixTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-193418.jsVerified FIXED. The above testcase now passes in the Rhino shell.\nI tested with optimization levels set to -1, 0, 1, and 9.\n\nBefore this patch was committed, the test failed as Igor described\nabove, whenever the optimization was set to be greater than 0.Targeting as resolved against 1.5R5',?,BUG
193555,'1.5R4 regression: function expression has no access to its name',Rhino,Core,user,norrisboyd,'In 1.5R4 a function expression can not access its function name. To test, run\nthe following test case in the Rhino shell with arbitrary optimization:\n\nvar x = function f() { return f.toString(); };\n\nvar ok = (x.toString() === x());\n\nprint(ok ? \"OK\" : \"FAILED\");\n\n\nIn Rhino 1.5R3 it prints OK while running 1.5R4 produces:\n\njs: \"/home/igor/js/x/f_rec.js\", line 2: uncaught JavaScript exception:\nReferenceError: \"f\" is not defined. (/home/igor/js/x/f_rec.js; line 2)Created attachment 114598\nFix: replacing vars.hasLocal(name) by !vars.hasLocal(name)\n\nI wish I would be more careful when made the changes to VraibaleTable. In\nNodeTransformer.addVariables() in 1.4R3 had a condition \"vars.getLocal(name) ==\nnull\" which I replaced by \"vars.hasLocal(name)\" thus disabling access to the\nfunction name. On the other hand even the test suite does not have a check for\nthat, so it seems this feature quite unknown.\n\nIn any case, this one line patch to NodeTransformer.addVariables() restores the\nfunctionality.Testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/Function/regress-193555.jsTestcase passes in SpiderMonkey; and as Igor reports, it passes if I run\nversion 1.5R3 of Rhino. Fails in 1.5RC4 with the error Igor reports -Marking fixed as I commited the fix some time agoVerified FIXED. \n\nThe above testcase now passes in the Rhino shell, in both \ncompiled and interpreted mode -Targeting as resolved against 1.5R4.1',?,BUG
193700,'Useless error message when retrieving property of undefined object',Rhino,Core,russgold,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\nBuild Identifier: \n\nWhen parsing an expression like:\n\nbase.something.here, if \"base.something\" is undefined, the error message \ngenerated is \"The undefined object has no properties\" which is not very helpful \nin tracking down the problem.\n\nThe following patch should provide a better message:\n\nRCS \nfile: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.130\ndiff -u -r1.130 Interpreter.java\n--- js/rhino/src/org/mozilla/javascript/Interpreter.java        17 Feb 2003 \n08:50:55 -0000      1.130\n+++ js/rhino/src/org/mozilla/javascript/Interpreter.java        17 Feb 2003 \n15:07:46 -0000\n@@ -2032,6 +2032,12 @@\n         --stackTop;\n         Object lhs = stack[stackTop];\n         if (lhs == DBL_MRK) lhs = doubleWrap(sDbl[stackTop]);\n+        else if (lhs == undefined) {\n+            // special code for better error message for get property from \nundefined\n+            int i = getShort(iCode, pc-6);\n+            if (i != -1) lhs=strings[i];\n+                throw NativeGlobal.typeError1( \"msg.is.not.defined\", \nScriptRuntime.toString(lhs),scope );\n+        }\n         stack[stackTop] = ScriptRuntime.getProp(lhs, name, scope);\n         break;\n     }\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Ask Rhino to parse an expression in which the second-to-last element part is \nundefined\n2.\n3.\n\nActual Results:  \nIt generates the above error messageThe submitted patch does not always work...  this one may be better:\n\nIndex: js/rhino/src/org/mozilla/javascript/Interpreter.java\n===================================================================\nRCS \nfile: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v\nretrieving revision 1.130\ndiff -u -r1.130 Interpreter.java\n--- js/rhino/src/org/mozilla/javascript/Interpreter.java        17 Feb 2003 \n08:50:55 -0000      1.130\n+++ js/rhino/src/org/mozilla/javascript/Interpreter.java        17 Feb 2003 \n15:43:53 -0000\n@@ -2032,6 +2032,16 @@\n         --stackTop;\n         Object lhs = stack[stackTop];\n         if (lhs == DBL_MRK) lhs = doubleWrap(sDbl[stackTop]);\n+        else if (lhs == undefined) {\n+            // special code for better error message for get property from \nundefined\n+            int j = pc-6;\n+            while (j > 0 && iCode[j] != 0) j--;\n+            int i = getShort(iCode, j);\n+            if (i >= 0 && i < strings.length) {\n+                lhs=strings[i];\n+                throw NativeGlobal.typeError1( \"msg.is.not.defined\", \nScriptRuntime.toString(lhs),scope );\n+            }\n+        }\n         stack[stackTop] = ScriptRuntime.getProp(lhs, name, scope);\n         break;\n     }cc\'ing Igor to consider this patch -Although the patch idea is fine, I think it would be better to report the\nproperty name for undefined null value, i.e. in x.y.z with undefined y it would\nbe sufficient for debugging to report about accessing the property z of\nundefined. In this way a reasonable message would be printed for x[0].z or x.y[0]. Created attachment 114733\nUse property names in error messages about accessing undefined or null\n\nPatch adds to various getElem/getProp explicit checks for null/undefined and in\nsuch cases report which property of null/undefined was accessed.\n\nWith the patch I have in Rhino shell:\n\njs> x = {}\n[object Object]\njs> x.y.z\njs: \"<stdin>\", line 2: uncaught JavaScript exception: TypeError: Cannot get\nproperty \"z\" from undefined (<stdin>; line 2)\njs> x[0].z\njs: \"<stdin>\", line 3: uncaught JavaScript exception: TypeError: Cannot get\nproperty \"z\" from undefined (<stdin>; line 3)\njs> x.y[0]\njs: \"<stdin>\", line 4: uncaught JavaScript exception: TypeError: Cannot get\nproperty \"0\" from undefined (<stdin>; line 4)Created attachment 114831\nPatch update to report assignments to properties of undefined/null \n\nThis is a patch extention to cover property assignments as well so I have in\nRhino shell:\n\njs> x={}\n[object Object]\njs> x.y.z\njs: \"<stdin>\", line 2: uncaught JavaScript exception: TypeError: Cannot read\nproperty \"z\" from undefined (<stdin>; line 2)\njs> x.y.z=1\njs: \"<stdin>\", line 3: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"z\" of undefined to \"1\" (<stdin>; line 3)\njs> x.y[0]=Math.sin\njs: \"<stdin>\", line 4: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"0\" of undefined to \"org.mozilla.javascript.IdFunction@93dcd\"\n(<stdin>; line 4)\njs> x[1][2]=1\njs: \"<stdin>\", line 6: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"2\" of undefined to \"1\" (<stdin>; line 6)I commited the patch few days ago.Verified Fixed -\n\njs> x = {}\n[object Object]\n\njs> x.y.z\njs: \"<stdin>\", line 8: uncaught JavaScript exception: TypeError: Cannot read\nproperty \"z\" from undefined (<stdin>; line 8)\n\njs> x.y.z=1\njs: \"<stdin>\", line 9: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"z\" of undefined to \"1\" (<stdin>; line 9\n\njs> x.y[0]=Math.sin\njs: \"<stdin>\", line 10: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"0\" of undefined to \"org.mozilla.javasc\nipt.IdFunction@1f14ceb\" (<stdin>; line 10)\n\njs> x[1][2]=1\njs: \"<stdin>\", line 11: uncaught JavaScript exception: TypeError: Cannot set\nproperty \"2\" of undefined to \"1\" (<stdin>; line 1)Targeting as resolved against 1.5R5',?,CLEANUP
194364,'function expression statements produces value',Rhino,Core,user,norrisboyd,'ECMA extension to support function expression statements in Rhino behaves\ndifferently from SM and MSIE as it produces value which affects eval results.\nFor example, given the following, \n\nvar x = eval(\'0; if (true) function f() {}\')\nprint(x)\n\nRhino assigns to x the function f and prints \n\nfunction f() {\n}\n\nwhile SM assigns to x 0 and prints 0. With the standard function statements\nRhino behaves correctly and print(eval(\'0; function f() {}\')) gives correct 0.Testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/Statements/regress-194364.js\n\nCurrently passing in SpiderMonkey, and failing in Rhino as \nIgor reported above -Created attachment 115477\nFix: no assignment of function expression statements to script resultI commited the fixVerified FIXED - the testcase in Comment #1 now passes in Rhino.\nI tested this with optimization levels -1, 0, 1, 9.Targeting as resolved against 1.5R5',?,SPEC
196017,'1.5R4 regression: script can not find classes on some versions of JDK',Rhino,Core,igor,norrisboyd,'New class loader code for generated classes in 1.5R4 to fix bug 166530 causes a\nregressions when used with some JDK 1.4 releases as was reported by Anreas Rozek:\n\nAfter having \"installed\" Rhino 1.5r4 on my system, many of my old\nRhino scripts fail to run any longer. Reason: Java class lookup seems\nto be broken!\n\nHere are some facts:\n - Java classes and interfaces within JAR files or directory trees\n   (within my \"ClassPath\") are no longer found - although they are\n   definitely present\n - unpacking JAR files (or moving directory tree contents) into a\n   folder such as $JavaHome/jre/lib/classes solves the problem -\n   however, I would even have to unpack the Rhino library (js.jar) \n - going back to Rhino 1.5r3 immediately solves the problem as well\n - I\'m currently running Sun JDK 1.4.0_03 - but the problem exists\n   as well under 1.4.0_02, 1.4.0_01 and 1.3.?_06 (don\'t remember the\n   version number) I already had a similar problem with \"BeanShell\"\n   (www.beanshell.org) and JDK 1.4.1 a few weeks ago - I then deci-\n   ded to go back to 1.4.0_03 as this solved most of the problems.\n   Later, a colleague ran into similar class loading problems and\n   had to go back to 1.4.0 as well...(very strange)\n - I\'m running Win98SE, she was running WinXP ProfessionalIt seems the regression is caused by a JDK bug on Win98 when it returns for\nRhino classes loaded from CLASSPATH variable a class loader that can only load\nclasses from Rhino jar or system locations and can not find classes from other\ncomponents of CLASSPATH. On the other hand a class loader returned by\nThread.getContextClassLoader() is able to find classes from all CLASSPATH\ncomponents and since Rhino 1.5R3 uses that for class loading, the problem only\nappeared in 1.5R4.\nCreated attachment 116297\nUse Thread.getContextClassLoader as the last resort to find classes\n\nThe patch does not restore 1.5R3 since it used Thread.getContextClassLoader()\ninitially and only then it tried a class loader for Rhino classes leading to\nvarious problems. The patch instead uses Thread.getContextClassLoader() as a\nlast attempt to find the required class thus preserving child-parent class\nloader semantics between generated and Rhino classes.I commited the patch, for verification I asked Anreas Rozek to check it, let see\nwhat he will report.Can we mark this one Verified? Have we heard from Anreas?Marking as verified assuming that silence of Anreas Rozek means it is OK for him...Targeting as resolved against 1.5R4.1',?,BUG
196149,'A regression-fix release for Rhino 1.5R4?',Rhino,Core,igor,norrisboyd,'I would suggest to make a release for Rhino 1.5R4 with fixes for regressions\nsince Rhino 1.5R3 if more users will complain. Currently they include:\n\nbug 96270\nbug 193168\nbug 193555\nbug 196017\n\nThe most problematic regression is the bug 96270 since it may influence any\nscript with importClass/importPackage that omits \"new\" before calling Java\nconstructors.\n\nAs a preparation for that I created Rhino150R4_BRANCH in Rhino CVS and committed\nfixes for the above bugs there.Sounds fine by me. Do you think we should call it 1.5 Release 4.1, or 1.5 Release 5?1.5R5 would not emphasis that it is only regression-fix for 1.5R4. On the other\nhand, 1.5R4.1 looks to dotty for me. Perhaps something like Rhino 1.5 Release 4\npatch 1 or 1.5R4p1 sounds better?\n\nI also suggest to make it sometime during April to see if something else will\npop up.  I added another regression to fix: see bug 200551 .On Rhino150R4_BRANCH I added docs/rhino15R41.html and updated docs/download.html\nto look like 1.5R4.1 happened. \n\nIn the documentation I referred to this release as 1.5R4.1 (at the end dots are\nfine with me ;) . I also assumed that release candidate phase will be skipped\nfor the release since it seems users do not test RC releases but wait for the\n\"real stuff\". And in case of problems, 1.5R4.2 can be issued.\n\nThe documentation changes should also be put on the main branch as well when the\nrelease happened.\nBefore the release, build.xml and Context.java should also be updated with the\nversion string but then is it OK to use 1.5R4.1 ?I checked in changes to use the 1.5R4.1 version string and built\nrhino1_5R4_1.zip and posted it on ftp, but I haven\'t yet announced it. \n\nI noticed you made the appropriate changes in the docs directory. I\'m assuming\nwe should just propagate those changes forward to the CVS trunk and I can then\npost them to the website. Sound good?\n\nYes, that sounds good! \n\nThe only problem is that merging of documentation may not work as is since after\n1.5R4 I updated few links there and then I updated the branch with this\ninformation as well while adding release info for 1.5R4.1. For thiss reason \nsomething like \"cvs upd -j Rhino150R4_BRANCH\" from the doc directory may not work.\n\nBut then Rhino150R4_BRANCH contains I believe the most up-to day docs and in\ncase of any merge conflicts it should take priority.Posted 1.5 Release 4.1 and announced.\n\nMarking Fixed.Marking Verified -\n\nThis release tests out fine. The only testcases outside the\nrhino-n.tests skip list that fail are:\n\n1) bug 188206: whether or not certain uses of regexp quantifiers\n   are considered to be invalid...\n\n2) seven failures from bugs fixed in Rhino between the release of 1.5R4\n   and today. That is, all seven are currently fixed in the Rhino tip.\n\nNorris and I corresponded about this. These fixes will be included\nin the 1.5R5 release -Targeting as resolved against 1.5R4.1',?,BUG
197682,'Memory leak via static filed in generated bytecode',Rhino,Compiler,igor,norrisboyd,'Currently Rhino optimizer with optimization level set to 1 or higher adds a\nstatic fields to classes representing compiled script functions to perform\nfunction call optimization.\n\nThese static fields holds references to script runtime objects and as long as\nthe loaded classes together with their static fields are not garbage collected,\nthe runtime structures will remain in JVM memory. It is not a problem in typical\nsituations where script is created and immediately executed since in such cases\ngenerated classes can be GCed after script execution allowing to GC the runtime\nas well.\n\nBut in the case of JavaScript compiler this is no longer true since then\ngenerated classes representing a compiled script are stored as class files and\ncan be loaded via system class loader which means that object stored in static\nfields will never be garbage collected. It leaks references to script runtime\nstructures and if script is loaded more then once, it will disable the\noptimization altogether since the static fields will hold the reference for\nwrong runtime structures.\n\nP.S. From now I will use igor@fastmail.fm for mozilla.org and other\ncommunications outside my work since due to various reorganization at work\nigor@icesoft.no and igor@icesoft.com may or may not work, a provider that I used\nfor private mail (igor at mir2 org) made an \"improvement\" that stopped mail\nworking for days and igor3@apochta.com that I sometime used for various mail\nlists to prevent spam is no longer necessary since I finally got good enough\nspam filters.Created attachment 117387\nScript test case where optimizer uses optimization leading to creation of static fieldCreated attachment 117388\nJava program to demonstrate a memory leak with classes created by JavaScript compiler for the the previous attachmentSteps to reproduce the problem:\n\n1. Compile the script from the first attachment by JavaScript compiler with an\noptimization level set to 1 or higher:\n\njava -classpath js.jar  org.mozilla.javascript.tools.jsc.Main -opt 1 script.js\n\n2. Compile a Java program form the second attachment:\n\njavac -classpath .:js.jar StaticFieldProblem.java\n\nwhere . is included to the classpath so javac finds classes generated by\nJavaScript compiler. \n\nThe program instantiate and execute an instance of the class script created by\nJavaScript compiler and then calls the garbage collector explicitly to see if an\ninstance of CustomScope which the program as a scope object is finalized.\n\n3. Run StaticFieldProblem:\n\njavac -classpath .:js.jar StaticFieldProblem\n\nIt currently prints \nfinalizeCount=0\nindicating that a reference to CustomScope is not GCed. \nCreated attachment 117390\nMaking references to direct call targets an instance fields of the main script class.\n\nThe static fields generated by the compiler store references to objects\nrepresenting JavaScript functions that are targets of direct call optimization.\n\nThey are used to make sure during optimized calls that a function reference\nstill points to the original function object.  For example, in the script from\nthe first attachment:\n\nfunction a(x)\n{\n\tb(x);\n}\n\nfunction b(x)\n{\n\treturn x == 0;\n}\n\nthe code generated for a() to call b() checks if the property b still holds the\noriginal function object and if it does, a() will use an optimized calling\nconversion to call b(). \n\nThe patch replaces static fields by an instance fields in the class\nrepresenting the main script object. This is quite significant change since it\nadds code to store/query a field that refers to the main class to each function\nclass and changes the way the direct fields are initialized. Still the patch\nitself is not that big since during the work on the patch I found that some of\nrefactoring that are necessary for the patch is make sense to apply on its own\nand that part is already in CVS.I commited the patch and now the test case prints what it should:\n\nfinalizeCount=1Marking Verified.\n\nI also get \'finalizeCount=1\' as the output of the steps to reproduce\ngiven in Comment #3. \n\nHowever, that\'s what I got before the patch was committed, as well!\nIs it possible the results are machine-dependent?Phil, did you re-run the JavaScript compiler with optimization set to 1 against\nthe scripts when you run the test with and without patch? It is strange that you\nget that finalizeCount=1 in both cases. Without the patch the script compiler\nhas to produce the code with static fields that are never cleared and AFAIK\nobjects reachable through such fields should not be subject of garbage\ncollection since JDK 1.1 in this case.Igor: you\'re right! I must have made some mistake the other day. When\nI try the testcase today against rhino1_5R4pre (i.e. before the fix),\nI get finalizeCount=0 just like you did.\n\nSorry for the trouble. I will attach my results below, verifying\nthat the bug is fixed -Created attachment 117645\nVerification results:  rhino1_5R4pre  vs.  rhino1_5R4Thanks Phil!Targeting as resolved against 1.5R5',?,IMPROVEMENT
198086,'optimizer enhancement: generate only single class per script and all its functions',Rhino,Compiler,igor,norrisboyd,'Currently Rhino optimizer generates one Java class per JavaScript function which\nmay lead to significant runtime overhead. I think it would be worth to try to\nreplace that by a single class with a switch dispatch to select code for a\nparticular function. I open this report to record work on it.Created attachment 130119\nStoring numerical constants in the single class\n\nThis is a small step to address the issue, but it makes sense on its own since\ncurrently script containing\n\nfunction f() { return 1; }\nfunction g() { return 1; }\n\nprint(f()+g()+Math.sqrt(1));\n\nwould create 3 classes each contain a code to generate a wrapper Number object\nto represent 1 and with the patch the single constant from the class for the\nmain script will be used.Created attachment 130216\nAll function implementations are generated in the single class.\n\nThis is an extension of the previous patch to place code implementing functions\nbodies in single class. \n\nWith the new patch classes implementing functions contain only constructor and\na call method that calls a static method \n\nc<function-index>(<FunctionClass> function, Context cx. Scriptable scope,\nScriptable thisObj, <possible-direct-call-params>, Object[] args)\n\nIn this way almost all strings representing JS names and strings are stored in\nthe main class reducing total amount of memory that generated classes occupy.Created attachment 130279\nAll script and function specific code are generated in one class\n\nWith this patch the first generated class will contain all code to initialize\nand execute script and functions. The rest of generated classes contain\neffectively 3 functions that looks like:\n\nvoid constructor(Context cx, Scriptable scope, int id)\n{\n    store id\n    static call to firestGeneratedClass._i<id>(this, cx, scope);\n}\n\nObject call(Context cx, Scriptable scope, Scriptable thisObj, Object[] args)\n{\n    static call to firestGeneratedClass._c<id>(\n\tsignature-with-possible-direct-call-optimization);\n}\n\nObject getEncodedSource()\n{\n    static call to firestGeneratedClass.getEncodedSourceImpl(id);\n}\n\nSo only the first class contains all script-specific strings and functions, the\nrest of the generated classes looks almost identical. To make them identical,\nit would be necessary to replace \n    static call to firestGeneratedClass._i<id>(this, cx, scope);\n    static call to firestGeneratedClass._c<id>(this, cx, scope);\nby a switch like\n\nswitch (id) {\n  case 0: static call to firestGeneratedClass._i0(this, cx, scope);\n  case 1: static call to firestGeneratedClass._i1(this, cx, scope);\n  ...\n}\n\nand \nswitch (id) {\n  case 0: static call to firestGeneratedClass._c0(...);\n  case 1: static call to firestGeneratedClass._c1(...);\n  ...\n}\n\nThe patch touches org/mozilla/classfile/ClassFileWriter to add a support for\nswitch generation which patch uses to generate switch in getEncodedSourceImpl\nand adds public methods to NativeFunction to initialize protected fields which\nare not accessible otherwise for code in static functions in\nfirestGeneratedClass.Created attachment 130359\nAn update for the previous patch to fix some uglinessCreated attachment 130412\nWorking full fix: generating only 2 classes to represent script code\n\nWith the above patch the optimizer produces at most 2 classes for a script with\narbitrary number of possibly nested functions.\n\nThe patch passes the test suite with optimization set to 0 and 9 but since it\nis very intrusive, I will try to test it before committing. \n\nIn principle it is possible to make optimizer to generate exactly one class\nsince a subclass of omj.NativeScript is not necessary and can be replaced by a\nomj.NativeFunction implementing some interface and hence the same class that\npatch uses to generate omj.NativeFunction subclass can also implement that\ninterface. But such change would probably require non-trivial modifications in\nomj.NativeScript.Created attachment 130422\nPatch update after partial committ.\n\nI committed the changes non-optimizer related changes that are necessary for\nthe patch like support for tableswitch in org/mozilla/classfile/ClassFileWriter\nand making BaseFunction.createObject public instead of protected so it can be\ncalled from after changes to the optimizer.Created attachment 130464\nPatch update to use more compact bytecode for call switch and remove changes to OptNameHelper\n\nI removed changes to OptNameHelper since they were too intrusive and changed\nnaming of generated files which I would prefer to keep as compatible with the\ncurrent naming as possible.\n\nThe patch passes the test suite and few my own stress tests. In addition the JS\ncompiler is working fine as well.I benchmarked the patch against BenchPress.js and from func_bench.js\nmozilla/js/benchmarks. As far as I can tell an additional overhead switch/static\nmethod call to implement Function.call does not change the running time in any\nsignificant way. Such overhead is present only when direct call optimization is\nnot available since direct calls invoke the corresponding static method directly\nand their timing should be the same as before the patch. \n\nThe benchmarks confirmed this as I could not see a statistically meaningful\ndifference between running time when using -opt 9. \n\nWith -opt 0 under JDK 1.1 there is not change in timing, under JDK 1.3 the patch\nmakes benchmarks slower by 1-2\% while under JDK 1.4 they are faster by 1-2\%.\nThis is under Linux.\n\nNow regarding the generated class files size. Using JS compiler for\nexamples/NervousText.js as described at the bottom of\nhttp://mozilla.org/rhino/jsc.html gives without the patch 8 class files with\ntotal size 21321 and corresponding compressed jar gives 9842 bytes. \n\nAfter the patch the compiler produces only 3 class files with the total size\n12851 and the jar size 5569 bytes.\n\n\nCreated attachment 130526\nYet another patch update to generate smaller bytecode for switches.Created attachment 130530\nTest case to check for class file limitations.\n\n\nDue to limitations of JVM class format, the patch clearly adds restrictions to\ncomplexity of script code that optimizer can handle since now all the constants\nand strings goes into single file. But such additional restrictions are not\nthat bad since the patch does not affect the major restriction of restricting\nbyte code size for methods to 64K.\n\nThe test case generates a JS source of the form\n\nfunction f1(n) { return n; }\nfunction f2(n) { return f1(n); }\nfunction f3(n) { return f2(n); }\n...\nfunction f<N>(n) { return f<N-1>(n); }\n\nf<N>(<some-value>);\n\nand then compile/execute it via \"var code = new Script(); code()\" since eval\ncan not be used as Rhino uses interpreter mode for it.\n\nIt turned out that before patch the maximum value for N with optimization level\n0 was 2847 before JVM refused to load the file and after it actually increased\nto 2853. The limit came from the code for script body that has to instantiate N\ndifferent functions and the patch made that slightly more compact that explains\nthe reason for the limit increase. Of cause a mixture of top-level functions\nand nested ones would show the patch limitations since without the patch nested\nfunctions will be initialized in a separated classes, but still a limit of 2500\nfunctions per script seems reasonable.I tagged Rhino sources with before_less_classes_optimizer tag and committed the\npatch. I do not mark the bug as fixed since I would prefer to try to change\noptimizer to produce exactly one class for both script and all the functions it\ncontains. It will allow to make all internal fields and methods private which\nwould allow for better optimization of generated code by JVM.Created attachment 130587\nRemoval of the dual nature of NativeScript\n\nThe patch changes omj.NativeScript to represent only instances of Script object\nin scripts and removes its second role to server as a superclass for compiled\nforms of JS scripts. In is not only allow to make optimizer to generate only\nsingle class but also would make instances of Script generated by optimizer not\nto depend on the scope. The later is essential for Script object reuse to\nexecute it against different scopes.\n\nCurrently the optimizer sets the prototype of the compiled script to\nScript.prototype from the scope but this wrong since the compiled script is\nnever exported to script. The interpreter never did it so compiled script\nproduced in this mode were almost scope independent (they currently hold a\nscope reference through instantiated regular expressions while scripts\ngenerated by the compiler instantiate the regexps during eval call).Created attachment 130593\nOne class for script and all its functions\n\nPatch makes optimizer to generate exactly one class to represent a script and\nall functions. That class implements Script and initializes in the default\nconstructor and Script.eval implementation script support while using a\nseparated constructor to initialize the function objects.I committed the last patch which finally allows to mark the bug as fixed.Rubber-stamp vrfy -Created attachment 130969\nFix for regression that prevented script to be executed twice\n\nWithout this fix which I committed Script instances can not be executed twice\nsince it would reinitialize NativeFunction each time the script is executed. \n\nThe fix also moves initialization of regular expression for scripts (and only\nfor scripts) directly into the call method implementation where they are stored\ninto a local variable. Previously regexps would be stored in a class field\nwhich the call method accessed thus making Script.exec non-reentrant and thread\nunsafe.\n\nThe last part would probably should go as a fix for bug 218440 but it is too\ncomplex to separate the patches.\n\nNote that the test case from attachment 130962 from that bug can be used to\ncheck this regression since the test calls Script.exec twice.Trageting as resolved against 1.5R5',?,IMPROVEMENT
198208,'Removal of deprecated in 1.5R4 classes',Rhino,Core,igor,norrisboyd,'I suggest to remove deprecated in 1.5R4 omj.ClassOutput and omj.SecuritySupport\nsince ClassOutput is not supposed to be used since 1.5R3 and I would prefer that\ncode using SecuritySupport would be upgraded to use\nClassShutter/SecurityController sooner then later.Created attachment 117717\nRemoval of SecuritySupport and ClassOutput and corresponding setter/getter methods in Context and ClassNameHelperCreated attachment 117857\nPatch update to remove deprecated access methods in Context that simply redirect to corresponding ClassNameHelper methodsI commited the patch part that deals with removal of the deprecated\nomj.SecuritySupport.Created attachment 118931\nPatch update to reflect commited removal of SecuritySupport.Verifying checkin in Comment #3 removing |SecuritySupport|:\n\n1. CVS-removal of the file SecuritySupport.java\n2. Removal from the file Context.java of references to |SecuritySupport|I committed the above patch so now omj.Context does not depend on\nClassNameHelper. In fact, now only optimizer package depends on\nomj.ClassNameHelper and omj.ClassRepository and this classes are not useful on\nits own and perhaps they can be moved to optimizer package to reduce code size\nwhen Rhino embedding does not need optimizer? But this is for another bugzilla\nreport.Trying to verify the checkin, but it seems to contain additional\nelements from the patch. For example, in bonsai, the differences\nbetween v1.17 and v1.16 of ClassNameHelper.java shows this change:\n\nWAS THIS:\n----------------------------  v.1.16  ----------------------------\npublic String getTargetClassFileName() {                                \n    ClassRepository repository = getClassRepository();\n    if (repository instanceof FileClassRepository) {\n        return ((FileClassRepository)repository).\n            getTargetClassFileName(getClassName());\n    }                                                                       \n    return null;                                                            \n}\n\n\nNOW THIS:\n----------------------------  v.1.17  ----------------------------\npublic abstract String getTargetClassFileName();     \n\n\n\nbut I can\'t see that change in the patch. Is that correct?I should be more careful next time not to infect my commits related to a\nparticular patch with other changes. \n\nThat \npublic String getTargetClassFileName() {...}\nis replaced by \npublic abstract String getTargetClassFileName();\nand its code is moved to optimizer/OptClassNameHelper.java since the only way to\naccess ClassNameHelper is through OptClassNameHelper instances. In this way\napplications that do not use optimizer will have less code.Igor: thanks; marking Verified -Targeting as resolved against 1.5R5',?,CLEANUP
199051,'Invoker optimization does not work with security manager',Rhino,Core,igor,norrisboyd,'To speedup invocation of Java methods via reflection Rhino generates special\nclasses that calls the reflected method directly. It requires to create a class\nloader to load the generated byte code for the class but currently Rhino does\nnot check for a possible SecurityException during loader creation/class load. \n\nIt can happen, for example, if a system security policy disable creation of\nclass loaders or a currently executed script does not have sufficient privileges\neven if Rhino classes are allowed to do that.\n\nThe problem was initially reported in netscape.public.mozilla.jseng, see\nhttp://groups.google.com/groups?dq=&hl=en&lr=&ie=UTF-8&threadm=3E708F75.2020108\%40icesoft.com&prev=/groups\%3Fdq\%3D\%26num\%3D25\%26hl\%3Den\%26lr\%3D\%26ie\%3DUTF-8\%26group\%3Dnetscape.public.mozilla.jseng\%26start\%3D25\n\nHere is a way to reproduce the problem based on that:\n\n1. Create the policy file test.policy that prevents Rhino from creating class\nloaders with the following body:\n\ngrant codeBase \"file:${user.home}/path-to-js-jar\" \n{\n  permission java.lang.RuntimePermission \"accessDeclaredMembers\";\n  permission java.io.FilePermission \"<<ALL FILES>>\", \"read\";\n  permission java.util.PropertyPermission \"*\", \"read\";\n}; \n\n\nwhere ${user.home}/path-to-js-jar should be adjusted accordingly (on windows one\nmay use something like file:/d:/rhino1_5/js.jar\n\n2. Put the following 2 lines into the file test.js in the same directory as\ntest.policy:\n\nvar x = new java.lang.Integer(2);\nprint(x.intValue());\n\n\n3. Run Rhino shell in the interpreted mode (if creation of class loaders is\ndisabled, the optimizer would not work):\n\njava -Djava.security.manager -Djava.security.policy=test.policy\norg.mozilla.javascript.tools.shell.Main -opt -1 test.js\n\nIt gives instead of expected printed number 2 an exception stack trace:\n\nException in thread \"main\" java.security.AccessControlException: access denied\n(java.lang.RuntimePermission createClassLoader)\n        at\njava.security.AccessControlContext.checkPermission(AccessControlContext.java:272)\n        at java.security.AccessController.checkPermission(AccessController.java:399)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:545)\n        at\njava.lang.SecurityManager.checkCreateClassLoader(SecurityManager.java:610)\n        at java.lang.ClassLoader.<init>(ClassLoader.java:234)\n        at\norg.mozilla.javascript.DefiningClassLoader.<init>(DefiningClassLoader.java:55)\n\n\nMore complex test case would be to grant the createClassLoader permission to\nRhino classes and use optimizer. In this case the generated classes does not\nsufficient privileges and triggers AccessControlException as well:\n\ntest.policy:\n\ngrant codeBase \"file:${user.home}/path-to-js-jar\" \n{\n  permission java.lang.RuntimePermission \"createClassLoader\";\n  permission java.lang.RuntimePermission \"accessDeclaredMembers\";\n  permission java.io.FilePermission \"<<ALL FILES>>\", \"read\";\n  permission java.util.PropertyPermission \"*\", \"read\";\n}; \n\ninvocation:\n\njava -Djava.security.manager -Djava.security.policy=test.policy\norg.mozilla.javascript.tools.shell.Main -opt 9 test.js\n\nleads to exactly the same exception.Created attachment 118361\nDisable invoker optimization if it triggers SecurityException\n\n\n\nThe patch adds a public API to enable/disable on per Context basis the invoker\noptimization and disables it for any Context instance that has seen\nSecurityException during invoker invocation. \n\nThe patch also disables invoker optimization in case of var-arg methods since\nthere any speedup in method invocation is berried under the need to\ncreate/unwrap additional argument arrays.Created attachment 118908\nMinimalistic patch: initialize invoker in FunctionObject constructor\n\nA simple way to resolve the issue is to create an invoker object in\nFunctionObject constructor instead of doing this lazily during script call. In\ntypical applications FunctionObject instances are constructed during\ninitialization when there is no script or other code on Java stack with\nrestricted permissions, so as long as Rhino classes have enough permissions,\nInvoker optimization should be available. And if it is not, the patch catches\nSecurityException to disable the optimization in this case which will happen\nonly once and not during each call, so the performance impact should be minimal\neven in this case.Created attachment 118933\nPatch fix: In FunctionObject constructor create invoker only if method != nullCreated attachment 118934\nYet another patch update: see comments in omj/optimizer/InvokerImpl.java for the reasonI committed the above patch.Verified FIXED.\n\nI followed the steps that Igor outlined above in the Rhino1_5R4\nshell vs. the Rhino1_5R5pre shell. I got the same exception as\nIgor in R4, but no exception in R5pre. I tried both variations\nof the test (opt -1 and opt 9) which Igor explained above.\n\nI will attach my opt -1 results below -Created attachment 118978\nVerification results on WinNTTargeting as resolved against 1.5R5',?,IMPROVEMENT
200551,'JavaAdapter not loading a class if js.jar installed in jre/lib/ext directory',Rhino,Core,rivasdiaz,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.2) Gecko/20021126\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.2) Gecko/20021126\n\nIn my app I execute some javascript files, they use the constructor JavaAdapter\nto load and extend java clases, some of them abstract clases extended in\njavascript code. If I run my app this way:\n\njava -cp js.jar;myapp.jar myapp.Main\n\neverythigs work ok, but when I put js.jar on the jre/lib/ext directory, and execute\n\njava -jar myapp.jar\n\nwhen my code is trying to execute the javascript file I get an error on the line:\nnew JavaAdapter(...);\n\nThe error is:\n\nTypeError: expected java class object\n(jar:file:/C:/Work/Eclipse/docgen.jar!/com/prospectiva/templates/poder_general.js;\nline 547)\n        at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:597)\n        at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:557)\n        at org.mozilla.javascript.JavaAdapter.jsConstructor(JavaAdapter.java:100)\n        at inv1.invoke()\n        at org.mozilla.javascript.FunctionObject.doInvoke(FunctionObject.java:498)\n        at\norg.mozilla.javascript.FunctionObject.callVarargs(FunctionObject.java:518)\n        at org.mozilla.javascript.FunctionObject.construct(FunctionObject.java:450)\n        at org.mozilla.javascript.ScriptRuntime.newObject(ScriptRuntime.java:1265)\n        at\norg.mozilla.javascript.gen.c12.call(jar:file:/C:/Work/Eclipse/docgen.jar!/com/prospectiva/templates/poder_general.js:547)\n        at\norg.mozilla.javascript.optimizer.OptRuntime.callSimple(OptRuntime.java:275)\n        at\norg.mozilla.javascript.gen.c13.call(jar:file:/C:/Work/Eclipse/docgen.jar!/com/prospectiva/templates/poder_general.js:553)\n        at\norg.mozilla.javascript.gen.c13.exec(jar:file:/C:/Work/Eclipse/docgen.jar!/com/prospectiva/templates/poder_general.js)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:820)\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. just put js.jar on the jre/lib/ext directory and execute a javascript program\nthat uses new JavaAdapter(...)\n\nActual Results:  \nException thrown\n\nExpected Results:  \ninstantiate a new classcc\'ing Igor -Rivas, which version of Rhino do you use? If it is 1.5R4, try 1.5R3 or the\nlatest build from CVS, it can be that you are affected by the regression bug\n196017 in 1.5R4.I use rhino 1.5r4 and j2sdk 1.4.1_02\n\nI checked the other bug but i can\'t see if it\'s related. My app works perfectly\nif it is on the classpath, but fails if it is in jre/ext/lib.\nI\'ll download tonight the new j2sdk 1.4.2 beta to test it.\n\nthanks.As regarding bug 196017, although its reasons are different, the fix there may\nhelp in your situation as well. So could you try Rhino build from CVS tip from\nftp://ftp.mozilla.org/pub/js/rhinoLatest.zip ?\n\nA detailed test case:\n\n1. Copy js.jar from a Rhino distribution to lib/ext directory from JDK/JRE\ninstallation.\n\n2. Save the following Java source as MyTest.java in some directory and compile it:\n\npublic abstract class MyTest\n{\n\tpublic abstract int test();\n\t\n\tpublic static int runTest (MyTest x)\n\t{\n\t\treturn x.test();\n\t}\n\t\n}\n\n3. Save the following JS as test.js in the same directory:\n\nvar o = { test: function() { return 100; } };\n\nvar test_instance = new JavaAdapter(Packages.MyTest, o);\n\nvar i = Packages.MyTest.runTest(test_instance);\n\nprint(i);\n\n4. Run from this directory:\n\njava -classpath . org.mozilla.javascript.tools.shell.Main -f test.js\n\nI got with 1.5R4:\njs: \"/home/igor/w/js/test.js\", line 3: uncaught JavaScript exception: TypeError:\nexpected java class object (/home/igor/w/js/test.js; line 3)\n\n\nwhile js.jar from 1.5R3 gives the proper output:\n100\n\nIf the same is run Created attachment 120301\nThe test case files as a single patch file for convenienceThe fix in the bug 196017 does not fix the problem since with the current Rhino\ntip I got the same problem:\n\njs: \"/home/igor/w/js/test.js\", line 3: uncaught JavaScript exception: TypeError:\nexpected java class object (/home/igor/w/js/test.js; line 3).\n\nThe reason for this is that the fix only restored search for thread context\nloader when defining classes and not when doing class search in NativeJavaPackage.\n\n\nCreated attachment 120305\nFix: Introduction of Context.getApplicationClassLoader() to get proper application loader.\n\nThe patch adds Context.getApplicationClassLoader() that is now used in all\ncases as a parent loader for generated classes and as the default class loader\nfor NativeJavaPackage. The default implementation tries to use\nThread.getContextClassLoader, but only when it is available and if Rhino\nclasses is available through it. Otherwise the loader for Context instance is\nused. In this way if Rhino is loaded through a custom loader, it will be used,\nand if Rhino classes are placed in lib/ext,  Thread.getContextClassLoader still\ngive the application loader.\n\nAnd if this default policy would not work in a particular application,\nContext.getApplicationClassLoader() can be overridden to in that application.\n\nI believe in this way all functionality of Rhino 1.5R3 regarding class loading\nis restored while making sure that fixes that triggers class loading changes in\n1.5R4 are not affected.Created attachment 120308\nPatch update: do not assume that Class.getClassLoader() is not null to be compatible with JDK 1.1Created attachment 120370\nPatch update to add explicit getter/setter for application class loader to Context\n\n\n\nI changed the patch to provide explicit getter/setter for application class\nloader so changing the application loader can be done without subclassing\nContext and a custom loader will be checked that current Rhino classes is\naccessible through it. Moreover, the method can be called from scripts directly\nto help to identify class loader problems quickly.Created attachment 120373\nPatch update: call Context.getApplicationClassLoader() each time a default class loader is needed in NativeJavaPackage\n\nIn the previous version of the patch NativeJavaPackage called\nContext.getApplicationClassLoader() only in its constructor effectively\nignoring changes subsequent changes in Context.getApplicationClassLoader(). The\nnew version calls the method each time a new class is accessed.I committed the last version of the patchCreated attachment 120557\nThe fix version for Rhino150R4_BRANCH since the bug is a regression since 1.5R3I committed the fix to Rhino150R4_BRANCH as well Verified FIXED.\n\nFollowing the precise steps Igor gave in Comment #5, I copied js.jar from\ndifferent Rhino 1.5 releases to C:\\Program Files\\Java\\j2re1.4.1\\lib\\ext\\\n\nThe output I got before this fix were the same as Igor\'s results:\n\n1.5R3      --->  100\n1.5R4      --->  JavaScript exception: TypeError: expected java class object\n1.5R5pre   --->  JavaScript exception: TypeError: expected java class object\n\n\nNow, with 1.5R5pre after this fix, I get 100 as output -Targeting as resolved against 1.5R4.1',?,BUG
201326,'Rhino should be able to coerce JavaScript Date to Java Date',Rhino,Core,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.3b) Gecko/20030210\nBuild Identifier: Rhino 1.5R4\n\nRhino does not coerce JavaScript Date objects to Java Date objects when calling\nJava methods that take java.util.Date as parameter. I think that coercion would\nbe both quite simple and useful.\n\nReproducible: Always\n\nSteps to Reproduce:\njs> var d = new Date();\njs> var f = new java.text.SimpleDateFormat();\njs> f.format(d);\njs: \"<stdin>\", line 18: uncaught JavaScript exception:\njava.lang.IllegalArgumentException: Cannot format given Object as a Datecc\'ing Igor -Created attachment 120192\npatch to convert NativeDate to java.util.Date\n\nI\'ve found the problem fairly easy to fix. This patch works well for me, would\nbe nice if it was applied to CVS.Created attachment 120257\nModification of Hannes patch for speed and code size\n\nThe patch changes includes the new DataClass field in ScriptRuntime to use it\nin NativeJavaObject, a direct access method to NativeDate time and if-sequence\noptimization in coerceType.I commited the above patch:\n\njs> var d = new Date();\njs> var f = new java.text.SimpleDateFormat();\njs> f.format(d);\n4/12/03 12:49 PM\nVerified FIXED:\n\n------------------------------ BEFORE ------------------------------\njs> var d = new Date();\njs> var f = new java.text.SimpleDateFormat();\njs> f.format(d);\njs: \"<stdin>\", line 3: uncaught JavaScript exception:\njava.lang.IllegalArgumentException: Cannot format given Object as a Date\n\n------------------------------ AFTER -------------------------------\njs> var d = new Date();\njs> var f = new java.text.SimpleDateFormat();\njs> f.format(d);\n4/12/03 6:14 PMTargeting as resolved against 1.5R5',?,RFE
201893,'Too slow invocation of reflected methods for package-private classes',Rhino,Core,igor,norrisboyd,'Steven Beal wrote to me some time ago:\n\n-------- Original Message --------\nSubject: Rhino performance tip (FAQ recommendation)\nDate: Fri, 28 Feb 2003 10:20:34 -0800\nFrom: Steven Beal <steven.beal@peregrine.com>\nTo: \"Igor Bukanov (E-mail)\" <igor@icesoft.com>\n\nIgor,\n\nI was experiencing poor performance on the IBM virtual\nmachine (the one shipped with Websphere) and eventually\ntraced the problem to excessive throwing and catching\nof exceptions.  \n\nThe Sun VM  handles exceptions much more efficiently\nand thus does not suffer quite so much from exceptions\nbeing thrown and caught in quick succession, which is\nwhy I didn\'t notice the issue before.\n\nThis is not a bug in rhino, in fact the condition is\nproduced by a workaround for a Sun java bug\n\nhttp://developer.java.sun.com/developer/bugParade/bugs/4071593.html\n\nSee org.mozilla.javascript.NativeJavaMethod.retryIllegalAccessInvoke().\n\nThe pattern used here is the same as that shown in one of the\nannotations of the currently open incarnation of the same bug\n\nhttp://developer.java.sun.com/developer/bugParade/bugs/4071957.html\n\nThis bug is not limited to inner classes though.  It\nwill also manifest itself why trying to invoke via reflection\na method on a pkg. private class offered via an Interface.\n\nI place several references into the local scope created for\na request that are interface references to pkg. private classes\ncreated via an Abstract Factory pattern.  By making these\nclasses public I avoided the need for the bug workaround and\nimproved performance significantly (a necessary compromise).\n\nPerhaps some mention of this should be made in the FAQ since the\nperformance impact is significant (extremely so on the IBM VM).\nThe same problem would be seen when using Dynamic Proxies, \nand features of the Collection classes.  If you read through\nthe associated bug reports I\'m sure you will find more cases.\n\nRegards,\n\n-SteveI think besides documentation it could be possible to do something with Rhino\ncode as well. If on the first failed method invocation code would search for a\npublic method in a class public super classes or interfaces which this method\noverrides, then the issue can be solved.Created attachment 127127\nFix: after the first IllegalAccessException replace method by a better version if available.\n\nThe reason for performance problem is that the above\nNativeJavaMethod.retryIllegalAccessInvoke() does not cache the accessible\nmethod it found. Thus the idea is to replace on the first\nIllegalAccessException the original method in NativeJavaMethod.methods by its\naccessible version so the following invocations would not throw\nIllegalAccessException.\n\nIt would be simple to modify retryIllegalAccessInvoke if only  NativeJavaMethod\nused it, but the same problem presents with\nJavaMembers.BeanProperty.setter/getter and I would like not to repeat the same\ncode there twice. To resolve this, I replaced Method references in BeanProperty\nby references to NativeJavaMethod together with method indexes since previously\nBeanProperty was created from NativeJavaMethod in any case. \n\nIn this way single invoke utility in NativeJavaMethod would be sufficient and\nif a getter method is called both directly and through a property access, it\nwill be replaced only one time. In addition, it allowed not to call\nMethod.getPrametersInfo() on setter during its invocation since this\ninformation is already cached in NativeJavaMethod.Note for the above patch: it depends essentially on my chages to cache\nMethod.getParameterInfo() in NativeJavaMethod/NativeJavaConstructor that I put\nto CVS on 2003-07-06.Created attachment 127619\nBetter approach: new class MemberBox to recover from IllegalArgumentException\n\nThe patch moved all logic to recover from IllegalArgumentException to new\nMemberBox class that wraps Method or Constructor instances. The class also\ncache results of getParameterTyps() and implements Serializable. The later\nallows to skip implementing read/writeObject when class previously contained\nMethod or Constructor instances which are replaced by MemeberBox wrappers.I committed the patch. Steven does not have time to verify that now but perhaps\nlater he can test.I think there are some problems with the patch you committed. I\'m no longer able\nto invoke public methods on non-public classes. The error message I get is:\n\nTypeError: undefined is not a function.\n\nWhich may serve as clue, because it\'s not that we get a security exception when\ninvoking the method, the method is simply not there.\n\nAlso, when trying to invoke a public static method on a non-public class, I get\nthe following message:\n\norg.mozilla.javascript.EvaluatorException: Java class \"java.lang.Object\" has no\npublic instance field or method named \"foo\".\n\nShould I open a new bug for this, or will this one be reopened?Please open a new bug, since it is a different issue.I openned the bug 214608 about the problem reported in the comments 6Targeting as resolved against 1.5R5',?,IMPROVEMENT
201896,'Convenient way to implement functions in Java without using reflection',Rhino,Core,igor,norrisboyd,'Currently any usage of IdFunction requires to implement at least 2 methods in\nIdFunctionMaster, execMethod and methodArity in addition to code to create\nIdFunction instances. If methodArity is replaced by passing the arity value\ndirectly to IdFunction constructor, the usage would be simpler.Created attachment 120402\nReplacing methodArity in IdFunctionMaster by the arity field in IdFunction\n\nThe patch did not touch IdScriptable ands its subclasses besides changing\nmethodArity in IdScriptable from public to protected since IdScriptable needs\nto get an arity value form its subclasses which brings patrch minuses:\n\n1. Additional method invocation per each IdFunction instance initialization in\nIdScriptable subclasses.\n\n2. Additional field in IdScriptable.\n\nPerhaps for code that wants to add a function or two without using reflection\nit would be better to define something like JavaFunction or SimpleFunction that\nshould be extended to override the call method?I renamed title since it seems a separated class to provide IdFunction\nfunctionality without a requirement to implement an additional interface would\nbe a good option to have.Created attachment 122199\nNew JIFunction and its usage in NativeJavaPackage\n\nThe patch adds new JIFunction class  which stands for Java Implemented Function\n(NativeFunction is already taken and I like to have a short name) which is a\nsimplified version of IdFunction. The function has to be subclassed to\nimplement call method. I changed NativeJavaPackage to use it instead of using\nreflection to export getClass functionality. The core of changes is\nreplacement:\n\n-\t Method[] methods = FunctionObject.getMethodList(\n-\t\t\t\tNativeJavaPackage.class);\n-\t Method m = FunctionObject.findSingleMethod(methods,\n-\t\t\t\t\t\t    \"jsFunction_getClass\");\n-\t FunctionObject f = new FunctionObject(\"getClass\", m, scope);\n+\t JIFunction getClass = new JIFunction(\"getClass\", 1) {\n+\t     public Object call(Context fcx, Scriptable fscope,\n+\t\t\t\tScriptable thisObj, Object[] args)\n+\t     {\n+\t\t return js_getClass(fcx, fscope, packages, args);\n+\t     }\n+\t };\n \n...\n\n-\t global.defineProperty(\"getClass\", f, ScriptableObject.DONTENUM);\n+\t getClass.define(global, ScriptableObject.DONTENUM);\n\nwhich defines new function and does not increase amount of code lines\nnoticeably.\n\nIt also allows to make NativeJavaPackage.js_getClass package private thus\nproviding less room for erroneous code calling js_getClass from Java.Created attachment 122597\nPatch update: better method naming and using JIFunction instead of IdFunction in ImporterTopLevelI committed the patch.Rubber-stamp vrfy -Targeting as resolved against 1.5R5',?,IMPROVEMENT
201987,'delete \"\".x throws ClassCastException',Rhino,Core,igor,norrisboyd,'The following code when executed produces unexpected exception instead of\nexpected Ok printout:\n\nvar test = delete \"\".x\nprint (test ? \"OK\" : \"FAILED\");Confirming on WinNT:\n\n-------------------- Rhino 1.5 release 5 0000 00 00 -------------------- \njs> delete \"\".x\nException in thread \"main\" java.lang.ClassCastException\n  at org.mozilla.javascript.ScriptRuntime.delete(ScriptRuntime.java:1064)\n  at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2019)\n  at org.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:62)\n  at org.mozilla.javascript.InterpretedScript.exec(InterpretedScript.java:55)\n  at org.mozilla.javascript.Context.evaluateReader(Context.java:806)\n  at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n  at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:260)\n  at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n  at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\n\n\n\n----------------------- COMPARE SPIDERMONKEY ----------------------- \njs> delete \"\".x\ntrue\n\n\n\nNote: this may seem confusing at first, since |\"\"| doesn\'t have any\nproperty named |x|. Here is an ECMA-262 Edition 3 reference:\n\n\n11.4.1 The delete Operator\nThe production UnaryExpression : delete UnaryExpression is evaluated as follows:\n\n1. Evaluate UnaryExpression.\n2. If Type(Result(1)) is not Reference, return true.\n3. Call GetBase(Result(1)).\n4. Call GetPropertyName(Result(1)).\n5. Call the [[Delete]] method on Result(3), providing Result(4)\n   as the property name to delete.\n6. Return Result(5).\n\n\nI believe that even though |\"\".x| hasn\'t been defined, it is still\nof type \"Reference\" in the technical language of the ECMA spec. So\nwe pass Step 2 of 11.4.1 and make it to Step 5. This relies on the\ninternal [[Delete]] method on objects, specified by:\n\n\n8.6.2.5 [[Delete]] (P)\nWhen the [[Delete]] method of O is called with property name P,\nthe following steps are taken:\n\n1. If O doesn?t have a property with name P, return true.\n2. If the property has the DontDelete attribute, return false.\n3. Remove the property with name P from O.\n4. Return true.\n\n\nTherefore by Step 1 here, since |\"\"| doesn\'t have a property named |x|,\nthe return value of |delete \"\".x| should be |true|.Testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/Operators/11.4.1-001.js\n\nCurrently passing in SpiderMonkey, crashing in Rhino as above -Created attachment 120497\nFix: in ScriptRutime.delete call toObject if delete target is not Scriptable\n\nThe patch touches Interpreter.java and optimizer/Codegen.java since it changes\nScriptRuntime.delete to pass Contex and scope for toObject call.I commited the above patch.Verified FIXED.\n\nThe above testcase now passes in the Rhino shell in compiled and interpreted mode.Targeting as resolved against 1.5R5',?,BUG
201989,'prototype property of predefined error object is neither ReadOnly nor DontDelete',Rhino,Core,igor,norrisboyd,'The EcmaScript standard in 15.11.7.6 states:\n\n15.11.7.6    NativeError.prototype\nThe initial value of NativeError.prototype is a NativeError prototype object\n(15.11.7.7). Each\nNativeError constructor has a separate prototype object.\nThis property has  the attributes { DontEnum, DontDelete, ReadOnly }.\n\nIn Rhino the prototype property has neither of this attributes as a test case\nfrom the following attchment indicates.Created attachment 120458\nTest case\n\nThe test case should print nothing, but instead it indicates failure for each\nerror object. Note: the test case does not check that prototype is DontEnumCreated attachment 120461\nFix: use initAsConstructor to initialize Error constructors in NativeGlobal.initIgor, thank you for these tests! I added one for DontEnum, also.\nI split them up and added them to JS testsuite as follows:\n\n  mozilla/js/tests/ecma_3/Exceptions/15.11.7.6-001.js   <---DontEnum\n  mozilla/js/tests/ecma_3/Exceptions/15.11.7.6-002.js   <---DontDelete\n  mozilla/js/tests/ecma_3/Exceptions/15.11.7.6-003.js   <---ReadOnly\n\n\nAll three are currently passing in SpiderMonkey.\nIn Rhino, only the first one is passing -Created attachment 120556\nPatch extension to remove unused functionality in IdFunction.java\n\nSince the changes to NatveGlobal removed the only usage of\nIdFunction.setFunctionType method outside IdFunction, I extended the patch to\nremove setFunctionType and corresponding getFunctionType in IdFunction and use\na simple private boolean field there to mark functions that can be called as\nconstructors.I committed the above fix.Verified FIXED.\n\nThe above testcases now pass in the Rhino shell in compiled and interpreted mode.Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
202255,'Removal of support in ScriptableObject.defineClass for old method forms',Rhino,Core,igor,norrisboyd,'I suggest to remove in ScriptableObject.defineClass support for pre 1.5R1 method\nforms to define JS properties and functions and look only methods that match the\nnaming conventions specified in JavaDoc for the method.Created attachment 120691\nRemoval of old naming conventionsI commited the patchCheckin verified -Targeting as resolved against 1.5R5',?,CLEANUP
202344,'clearing a breakpoint does not get properly repainted',Rhino,Core,mpg,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 4.0)\nBuild Identifier: Rhino 1.5R4\n\nIn the Rhino debugger, clearing a breakpoint does not get properly repainted.\n\nIn the following method (org/mozilla/javascript/tools/debugger/Main.java, \nSourceInfo class):\n\n    synchronized boolean removeBreakpoint(int line) {\n        boolean wasBreakpoint = false;\n        if (breakpoints != null && line < breakpoints.length) {\n            wasBreakpoint = (breakpoints[line] == BREAK_FLAG);\n            breakpoints[line] = 0;\n        }\n        return wasBreakpoint;\n    }\n\nThe line:\n            wasBreakpoint = (breakpoints[line] == BREAK_FLAG);\n\nwas incorrectly coded like this:\n\n            wasBreakpoint = (breakpoints[line] != BREAK_FLAG);\n\nChanging the \"!=\" to \"==\" fixes the bug.\n\nAlso, as a tip to make toggling breakpoints easier, move the body of the \nFileHeader.mouseClicked to FileHeader.mouseReleased. The Java mouseClicked \nevent is too limiting - it is only posted if you press & release the mouse \nbutton on the exact same pixel. It\'s difficult for many users to be so precise, \nand it winds up looking like the feature doesn\'t work.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Set a breakpoint in the Rhino debugger by clicking on the left margin.\n2. Try to remove the breakpoint created in step (1) by clicking on it.\n3. It will NOT disappear.  Move the window off screen and back on screen and it \nwill repaint correctly.\n\nActual Results:  \nIt did not repaint as described above.  See details for a solution to this bug.Thanks for debugging this problem and suggesting fixes. So does this diff\ncapture your suggested fixes? \n\nIndex: Main.java\n===================================================================\nRCS file:\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java,v\nretrieving revision 1.36\ndiff -u -r1.36 Main.java\n--- Main.java\t13 Feb 2003 03:01:09 -0000\t1.36\n+++ Main.java\t17 Apr 2003 01:31:08 -0000\n@@ -431,6 +431,8 @@\n     }\n     public void mouseReleased(MouseEvent e) {\n         checkPopup(e);\n+        requestFocus();\n+        getCaret().setVisible(true);\n     }\n \n     private void checkPopup(MouseEvent e) {\n@@ -2311,7 +2313,7 @@\n     synchronized boolean removeBreakpoint(int line) {\n         boolean wasBreakpoint = false;\n         if (breakpoints != null && line < breakpoints.length) {\n-            wasBreakpoint = (breakpoints[line] != BREAK_FLAG);\n+            wasBreakpoint = (breakpoints[line] == BREAK_FLAG);\n             breakpoints[line] = 0;\n         }\n         return wasBreakpoint;cc\'ing Igor -Reviewed by Christopher Olivier. Fix committed:\n\nChecking in Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java,v\n <--  Main.java\nnew revision: 1.37; previous revision: 1.36\ndoneThis is not a fix.  The body of the method\norg.mozilla.javascript.tools.debugger.FileHeader::mouseClicked() should be \nempty.\n\nThe mouseReleased() method of the FileTextArea can remain unchanged.  The \nsuggested change does trigger a repaint, but it needs to be processed on \nmouseRelease in the FileHeader class, and this makes the change to the \nFileTextArea unnecessary (the two lines of changes to \nFileTextArea::mouseReleased() here:\n     +        requestFocus();\n     +        getCaret().setVisible(true);\n)\n\nThe changes to removeBreakpoint are needed:\n-            wasBreakpoint = (breakpoints[line] != BREAK_FLAG);\n+            wasBreakpoint = (breakpoints[line] == BREAK_FLAG);\n             \nand I suggest making the FileHeader class look like this (only up to the \nconstructor).  I\'ve added a variable to make sure that the toggle only gets \nprocessed on the same line that the mousePressed occurred.\n\nclass FileHeader extends JPanel implements MouseListener {\n    private int pressLine = -1;\n    FileWindow fileWindow;\n\n    public void mouseEntered(MouseEvent e) {\n    }\n    public void mousePressed(MouseEvent e) {\n\t\tFont font = fileWindow.textArea.getFont();\n\t\tFontMetrics metrics = getFontMetrics(font);\n\t\tint h = metrics.getHeight();\n\t\tpressLine = e.getY() / h;\n    }\n    public void mouseClicked(MouseEvent e) {\n    }\n    public void mouseExited(MouseEvent e) {\n    }\n    public void mouseReleased(MouseEvent e) {\n        if (e.getComponent() == this &&\n          (e.getModifiers() & MouseEvent.BUTTON1_MASK) != 0) {\n            int x = e.getX();\n            int y = e.getY();\n            Font font = fileWindow.textArea.getFont();\n            FontMetrics metrics = getFontMetrics(font);\n            int h = metrics.getHeight();\n            int line = y/h;\n            if (line == pressLine) {\n            \tfileWindow.toggleBreakPoint(line + 1);\n            }\n            else {\n            \tpressLine = -1;\n            }\n        }\n    }\n\n\n\n\n\n\n\n\nAlso, the reason why it should be processed on mouseReleased, is that many \nusers can not press and release the mouse on the same pixel.  The press + \nrelease combination is much less difficult for most users.\n\nThanksOkay, thanks. I appreciate your help; I\'m not a Swing programmer and the\ndebugger UI code was donated by someone else. \n\nSo are these the changes you suggest?\n\nIndex: Main.java\n===================================================================\nRCS file:\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java,v\nretrieving revision 1.37\ndiff -u -r1.37 Main.java\n--- Main.java\t21 Apr 2003 14:59:22 -0000\t1.37\n+++ Main.java\t21 Apr 2003 17:44:07 -0000\n@@ -432,8 +432,6 @@\n     }\n     public void mouseReleased(MouseEvent e) {\n         checkPopup(e);\n-        requestFocus();\n-        getCaret().setVisible(true);\n     }\n \n     private void checkPopup(MouseEvent e) {\n@@ -756,28 +754,38 @@\n };\n \n class FileHeader extends JPanel implements MouseListener {\n-\n+    private int pressLine = -1;\n     FileWindow fileWindow;\n \n     public void mouseEntered(MouseEvent e) {\n     }\n     public void mousePressed(MouseEvent e) {\n+        Font font = fileWindow.textArea.getFont();\n+        FontMetrics metrics = getFontMetrics(font);\n+        int h = metrics.getHeight();\n+        pressLine = e.getY() / h;\n     }\n     public void mouseClicked(MouseEvent e) {\n+    }\n+    public void mouseExited(MouseEvent e) {\n+    }\n+    public void mouseReleased(MouseEvent e) {\n         if (e.getComponent() == this &&\n-          (e.getModifiers() & MouseEvent.BUTTON1_MASK) != 0) {\n+          (e.getModifiers() & MouseEvent.BUTTON1_MASK) != 0) \n+        {\n             int x = e.getX();\n             int y = e.getY();\n             Font font = fileWindow.textArea.getFont();\n             FontMetrics metrics = getFontMetrics(font);\n             int h = metrics.getHeight();\n             int line = y/h;\n-            fileWindow.toggleBreakPoint(line + 1);\n+            if (line == pressLine) {\n+                fileWindow.toggleBreakPoint(line + 1);\n+            }\n+            else {\n+                pressLine = -1;\n+            }\n         }\n-    }\n-    public void mouseExited(MouseEvent e) {\n-    }\n-    public void mouseReleased(MouseEvent e) {\n     }\n \n     FileHeader(FileWindow fileWindow) {\nYes, those look like the changes.  \nI don\'t quite know what this means:\n\n     private void checkPopup(MouseEvent e) {\n@@ -756,28 +754,38 @@\n };\n \n\nbut I have made no changes to the checkPopup(...) method.  I\'m hoping that \nthat\'s what \"@@ -756,28 +754,38 @@\" means, namely \"no changes\", to\norg.mozilla.javascript.tools.debugger.Main.FileTextArea::checkPopup(MouseEvent).\n\nBut yes the looks perfect.  The method body of what was mouseClicked is now \nmouseReleased, and the toggle only occurs if the line of text associated with \nthe mouseReleased is the same as the line of text associated with mousePressed, \nwhich is what we have here.\n\nThis appears to fix it.  \nThanks.\nYes, the @@ -756,28 +754,38 @@ means \"no changes\".\n\nChecking in Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java,v\n <--  Main.java\nnew revision: 1.38; previous revision: 1.37\n\nThanks for your help.\nVerified FIXED. The red breakpoint toggles correctly now -Targeting as resolved against 1.5R5',?,CLEANUP
202872,'Removal of FunctionObject.findMethods?',Rhino,Core,igor,norrisboyd,'Currently FunctionObject.findMethods is used to search for all methods with the\nsame name in the given class and returns them as an array. But all places where\nthis method is used in Rhino expects explicitly or implicitly that there is only\none such method. So the idea is to replace \n\nstatic Method[] findMethods(Class clazz, String name)\n\nby \n\nstatic Method findSingleMethod(Class clazz, String name)\n\nwhich will throw an exception if the method is overloaded.\n\nBut then findMethods uses a static cache for a method list for the given class\nsince in few places  findMethods is called many times on the same class but that\nis also overkill since in all such places FunctionObject.getMethodList can be\nused to get the list and caching with all potential memory leaks can be removed\ncompletely. So the following patch replaces findMethods by\n\nstatic Method findSingleMethod(Class clazz, String name) ...\n\nThe patch removes FunctionObject.findMethods but since it contains comments\n \n // TODO: Make not public\n\nperhaps somebody used the method outside Rhino?\n\nIf this is an issue the method can be restored with explicit deprecation but I\nwould prefer to remove it explicitly if possible.Created attachment 121265\nImplementation of the proposalI commited the patch as is, if somebody uses findMethods, then \n\ncvs diff -r  1.52 -r  1.53 FunctionObject.java\n\ncan be used to put it back as a deprecated method.Checkin verified -Targeting as resolved against 1.5R5',?,CLEANUP
203013,'Any modification of sealed object should throw exception?',Rhino,Core,igor,norrisboyd,'Rhino supports a notion of a sealed object where properties can not be added /\ndeleted from it. It does not make the object fully immune since the existing\nproperties can be still modified. On the other hand Rhino also has an option to\ninitialize standard objects as sealed ones but then it also makes all properties\nof the standard objects read only.\n\nIn my opinion the later behavior is more natural and meets expectations that\nsealed == immune. Thus I suggest to make sealed == immune to hold always.Created attachment 121397\nsealed == immune\n\nPatch makes sealed objects to behave as if their properties are read only.I commited the patch.Checkin verified -Any modification of sealed object should throw exception?\n\nI reopen this since it seems that the notion \n\nsealed object -> all properties read only \n\nis less useful then the following \n\nsealed object -> any attempt to modify the object should fail with exception.\n\nIn this way one would have guaranty that if a script that operates with sealed\nobjects runs without exceptions then \n\n1. the sealed objects are not modified\n2. the script would run exactly in the same way if objects are not sealed\n\nCurrently only 1 is satisfied since with read-only properties sealed objects are\nimmune to modifications indeed, but the item 2 is not addressed as changes to\nread-only properties are silently ignored. \n\nIf one has a script with\n\nObject.prototype.hasOwnProperty = myHasOwnproperty\n\nand later to save memory one decided to share sealed standard objects between\ndifferent script invocations then the fact that it is not possible to do this\nwith the above script would not be visible immediately. \n\nMoreover, read-only properties ignore changes on whole prototype chain so if\nObject.prototype is sealed with the current semantic then\n\nx = { hasOwnProperty: 1 }\n\nwould not set hasOwnProperty in x since Object.prototype.hasOwnProperty is read\nonly. In this example it makes perfect sense to have sealed shared standard\nlibrary, but the current rules prevent it.\n\nOn the other hand if sealed would mean that any modification to the object\nshould fail without affecting prototype chain semantics, in the first case one\nwould get an exception telling what is wrong and the second case would continue\nto work in the same way.\nNew titleCreated attachment 123384\nsealed == any modification throws exception\n\nThe patch also adds -sealedlib options to Rhino shell so after \njava -jar js.jar -sealedlib \nI have:\n\nRhino 1.5 release 5 0000 00 00\njs> Math.sin = 1\njs: Cannot modify a property of a sealed object: sin.\njs>  Object.prototype.hasOwnProperty = 1\njs: Cannot modify a property of a sealed object: hasOwnProperty.\njs>  x = { hasOwnProperty: 1}\n[object Object]\njs> x.hasOwnProperty \n1I committed the change in sealed semantics.I have a question. I do see what Igor reported above:\n\n----------------  WITHOUT -sealedlib OPTION  ----------------\n[ ] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> Math.sin = 1;\n1\njs> Math.sin\n1\n\n------------------  WITH -sealedlib OPTION  -----------------\n[ ] java org.mozilla.javascript.tools.shell.Main -sealedlib\nRhino 1.5 release 5 0000 00 00\njs> Math.sin = 1;\njs: Cannot modify a property of a sealed object: sin.\n\n\nHowever, I am able to modify |eval|, for example:\n\njs> eval = 1;\n1\njs> eval;\n1\njs> eval(\'a\');\njs: uncaught JavaScript exception: TypeError: 1 is not a function.\n\n\nThat isn\'t the expected behavior under -sealedlib, is it?\nShouldn\'t |eval| become ReadOnly then, just like |Math.sin|?Compare the current SpiderMonkey shell:\n\n---------------------  WITHOUT SEALING  ---------------------\njs> eval = 1;\n1\njs> eval;\n1\n\n-----------------------  WITH SEALING  ----------------------\njs> seal(this);\njs> eval = 1;\n7: Error: eval is read-onlyThe option -sealedlib in the current form seals only the standard library\nobjects themselves, it does not affect the global scope object and its\nproperties. Otherwise no new properties can be added to the global object. So\neven with -sealedlib one can write Math = Object even if eval.length = 2 gives\nan exception.\n\nThis is confusing, but then it is for another bug report. Created attachment 123685\nseal function in Rhino shell\n\nThe patch adds seal function to Rhino shell with to match SM.I committed the above patch to add seal so now in Rhino one can also have:\n\njs> seal(this)\njs> eval = 1\njs: \"<stdin>\", line 2: Cannot modify a property of a sealed object: eval.\nLooks good:\n\njs> seal(this);\njs> eval = 1;\njs: \"<stdin>\", line 4: Cannot modify a property of a sealed object: eval.\n\n\nBut I still have some questions:\n\n1. If we have the seal() function, do we also want to have\n   the optional second parameter, as in SpiderMonkey?\n\n   seal(obj, true) ---> seals the entire object graph,\n                        including the __parent__ chain \n\n   See bug 94693 comment 10, bug 94693 comment 22, etc.\n\n\n2. The help message needs updating, to mention the -sealedlib option:\n\n   [ ] java org.mozilla.javascript.tools.shell.Main -XXX\n   Didn\'t understand \"-XXX\".\n   Valid arguments are:\n       -w\n       -version 100|110|120|130|140|150\n       -opt [-1|0-9]\n       -f script-filename\n       -e script-source\n\n\n3. Should |seal(this)| prevent the user from doing |this = 1| ? \n   Note: the latter is currently causing a Rhino crash, independently\n   of any sealing issues. I have filed bug 206658 -Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
203402,'java.lang.VerifyError: stack size too large error when compiling JavaScript containing embedded ternary operator',Rhino,Compiler,briang,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.0.2) Gecko/20021216\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.0.2) Gecko/20021216\n\nThe resultant class generated from the Rhino bytecode generator for the\nfollowing JavaScript causes the JVM to throw a VerifyError.\n\nfunction testit()\n{\n   a = \"a\" + (1==0) ? \"b\" : \"c\";\n}\n\nThe exception is:\n\n[java.lang.VerifyError: (class: org/mozilla/javascript/gen/c156, method: call\nsignature:\n(Lorg/mozilla/javascript/Context;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla/javascript/Scriptable;[Ljava/lang/Object;)Ljava/lang/Object;)\nStack size too large]\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.  Use the following Java source:\n\nimport org.mozilla.javascript.*;\nimport java.io.StringReader;\n\npublic class RhinoTest\n{\n    public static void failingCase()\n    {\n        Context context = Context.enter();\n        ImporterTopLevel global = new ImporterTopLevel(context);\n        StringReader reader = new StringReader(\"function testit(){ a = \\\"a\\\" +\n(1==0) ? \\\"b\\\" : \\\"c\\\"; }\");\n        try\n        {\n            Script script = context.compileReader(null, reader, \"Example 1\", 1,\nnull);\n            script.exec(context, global);\n        }\n        catch (Exception e)\n        {\n            e.printStackTrace(System.err);\n        }\n        context.exit();\n    }\n\n    public static void main(String[] args)\n    {\n        failingCase();\n    }\n}\n\nActual Results:  \nException in thread \"main\" java.lang.VerifyError: (class: org/mozilla/javascript\n/gen/c1, method: call signature: (Lorg/mozilla/javascript/Context;Lorg/mozilla/j\navascript/Scriptable;Lorg/mozilla/javascript/Scriptable;[Ljava/lang/Object;)Ljav\na/lang/Object;) Stack size too large\n        at org.mozilla.javascript.gen.c2.call(Example 1)\n        at org.mozilla.javascript.gen.c2.exec(Example 1)\n        at RhinoTest.failingCase(RhinoTest.java:14)\n        at RhinoTest.main(RhinoTest.java:25)\n\nExpected Results:  \nShouldn\'t have gotten a JVM class verification error\n\nIt looks like the placement of the ternary operator is important.  The following\nexample does not have a problem:\n\nfunction testit()\n{\n   a =(1==0) ? \"b\" : \"c\" + \"a\";\n}cc\'ing Igor -A simpler test case would be one line script:\n\n\"\" + (1==0) ? \"\" : \"\";\n\nwhich execution in Rhino shell gives:\n\nException in thread \"main\" java.lang.IllegalStateException: Stack underflow: -1\n        at org.mozilla.classfile.ClassFileWriter.badStack(ClassFileWriter.java:1154)\n        at org.mozilla.classfile.ClassFileWriter.add(ClassFileWriter.java:401)\n        at org.mozilla.javascript.optimizer.Codegen.addByteCode(Codegen.java:3569)\n        at org.mozilla.javascript.optimizer.Codegen.visitGOTO(Codegen.java:1575)\n        at org.mozilla.javascript.optimizer.Codegen.generateCodeFromNode(CodegenCreated attachment 121842\nFix for Codege: do not pass trueLabel, falseLabel to recursive generateCodeFromNode from ADD nodeI committed the fixTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-203402.jsVerified FIXED.\n\nBefore the patch, the testcase passed in interpreted mode (-opt -1)\nbut crashed in any optimized mode (e.g -opt 0, -opt 1, -opt 9):\n\n*-* Testcase js1_5/Regress/regress-203402.js failed:\nExpected exit code 0, got 1\nTestcase terminated with signal 0\nComplete testcase output was:\n\njava.lang.AbstractMethodError\norg.mozilla.javascript.ScriptableObject.getBase(ScriptableObject.java:1583)\norg.mozilla.javascript.ScriptableObject.putProperty(ScriptableObject.java:1473)\norg.mozilla.javascript.ScriptRuntime.setName(ScriptRuntime.java:1137)\norg.mozilla.javascript.gen.c14.call(D:\\JS_trunk\\mozilla\\js\\tests\\js1_5\\Regress\\regress-203402.js:57)\norg.mozilla.javascript.gen.c14.exec(D:\\JS_trunk\\mozilla\\js\\tests\\js1_5\\Regress\\regress-203402.js)\norg.mozilla.javascript.Context.evaluateReader(Context.java:806)\norg.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\norg.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:354)\norg.mozilla.javascript.tools.shell.Main.processFile(Main.java:291)\norg.mozilla.javascript.tools.shell.Main.processSource(Main.java:283)\norg.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\norg.mozilla.javascript.tools.shell.Main.main(Main.java:76)\nException in thread \"main\"\n\n\nAfter the patch, the testcase passes in every mode -Targeting as resolved against 1.5R5',?,BUG
203752,'NativeGlobal is not serializable when propagating exceptions',Rhino,Core,bc1-bugzilla,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: Rhino 1.5r5pre\n\nPosting this error since a quick search through Bugzilla using \'NativeGlobal\' \ndid not show up anything.\n\nWhen using client/server (RMI) with Rhino JavaScript, exceptions do not get \npropagated.\n\nJavaScriptException has a constructor that takes as a parameter any Object and \nin case it is a org.mozilla.javascript.NativeGlobal exception cannot be \nserialized (JVM tries to serialize the exception and, consiquentialy, it\'s \nfield \'value\', which is not serializable).\n\nI have quickhacked JavaScriptException to work correctly:\n\tpublic JavaScriptException(Object value) {\n\t\tsuper(ScriptRuntime.toString(value));\n\t\t// bugfix to allow serialization of NativeGlobal\n\t\tif (value instanceof Wrapper) {\n\t\t\tvalue = ((Wrapper) value).unwrap();\n\t\t}\n\t\tif (value instanceof NativeGlobal) {\n\t\t\tthis.value = value.toString();\n\t\t} else {\n\t\t\tif(value instanceof Throwable) {\n\t\t\t\tinitCause((Throwable) value);\n\t\t\t}\n\t\t\tthis.value = value;\n\t\t}\n\t}\n\nBut this hack is quick and dirty and the right way to go would probably be to \nmake NativeGlobal serializable.\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Fire up your favorite application server.\n2. Make a *bean, call in it JavaScript that throws a (wrapped) exception.\n3. Call the *bean from your client.\n\nActual Results:  \njava.io.NotSerializableException: org.mozilla.javascript.NativeGlobal\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1054)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1302)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1302)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n\tat org.mozilla.javascript.ScriptableObject.writeObject\n(ScriptableObject.java:1833)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeWriteObject\n(ObjectStreamClass.java:795)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1294)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n\tat org.mozilla.javascript.NativeJavaObject.writeExternal\n(NativeJavaObject.java:880)\n\tat java.io.ObjectOutputStream.writeExternalData\n(ObjectOutputStream.java:1265)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1243)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1302)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.defaultWriteObject\n(ObjectOutputStream.java:367)\n\tat java.lang.Throwable.writeObject(Throwable.java:648)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeWriteObject\n(ObjectStreamClass.java:795)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1294)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.defaultWriteObject\n(ObjectOutputStream.java:367)\n\tat java.lang.Throwable.writeObject(Throwable.java:648)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeWriteObject\n(ObjectStreamClass.java:795)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1294)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.defaultWriteObject\n(ObjectOutputStream.java:367)\n\tat java.lang.Throwable.writeObject(Throwable.java:648)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeWriteObject\n(ObjectStreamClass.java:795)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1294)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.defaultWriteFields\n(ObjectOutputStream.java:1330)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1302)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n\tat java.util.LinkedList.writeObject(LinkedList.java:681)\n\tat sun.reflect.GeneratedMethodAccessor66.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeWriteObject\n(ObjectStreamClass.java:795)\n\tat java.io.ObjectOutputStream.writeSerialData\n(ObjectOutputStream.java:1294)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject\n(ObjectOutputStream.java:1245)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n\tat java.rmi.MarshalledObject.<init>(MarshalledObject.java:92)\n\tat org.jboss.invocation.jrmp.server.JRMPInvoker.invoke\n(JRMPInvoker.java:387)\n\tat sun.reflect.GeneratedMethodAccessor71.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:261)\n\tat sun.rmi.transport.Transport$1.run(Transport.java:148)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat sun.rmi.transport.Transport.serviceCall(Transport.java:144)\n\tat sun.rmi.transport.tcp.TCPTransport.handleMessages\n(TCPTransport.java:460)\n\tat sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run\n(TCPTransport.java:701)\n\tat java.lang.Thread.run(Thread.java:536)\n\tat sun.rmi.transport.StreamRemoteCall.exceptionReceivedFromServer\n(StreamRemoteCall.java:247)\n\tat sun.rmi.transport.StreamRemoteCall.executeCall\n(StreamRemoteCall.java:223)\n\tat sun.rmi.server.UnicastRef.invoke(UnicastRef.java:133)\n\tat org.jboss.invocation.jrmp.server.JRMPInvoker_Stub.invoke(Unknown \nSource)\n\tat org.jboss.invocation.jrmp.interfaces.JRMPInvokerProxy.invoke\n(JRMPInvokerProxy.java:275)\n\tat org.jboss.invocation.InvokerInterceptor.invoke\n(InvokerInterceptor.java:108)\n\tat org.jboss.proxy.TransactionInterceptor.invoke\n(TransactionInterceptor.java:77)\n\tat org.jboss.proxy.SecurityInterceptor.invoke\n(SecurityInterceptor.java:80)\n\tat org.jboss.proxy.ejb.StatefulSessionInterceptor.invoke\n(StatefulSessionInterceptor.java:117)\n\tat org.jboss.proxy.ClientContainer.invoke(ClientContainer.java:76)\n\tat $Proxy43.readBuffer(Unknown Source)\n\tat com.parsek.shell.ShellObjectReader._readObject\n(ShellObjectReader.java:83)\n\tat com.parsek.shell.ShellObjectReader.readObject\n(ShellObjectReader.java:98)\n\tat com.parsek.FormTest.getForm(FormTest.java:43)\n\tat _cp2__jsp._jspService(/forms/cp2.jsp:54)\n\tat com.caucho.jsp.JavaPage.service(JavaPage.java:75)\n\tat com.caucho.jsp.Page.subservice(Page.java:506)\n\tat com.caucho.server.http.FilterChainPage.doFilter\n(FilterChainPage.java:182)\n\tat com.caucho.server.http.Invocation.service(Invocation.java:315)\n\tat com.caucho.server.http.CacheInvocation.service\n(CacheInvocation.java:135)\n\tat com.caucho.server.http.RunnerRequest.handleRequest\n(RunnerRequest.java:344)\n\tat com.caucho.server.http.RunnerRequest.handleConnection\n(RunnerRequest.java:274)\n\tat com.caucho.server.TcpConnection.run(TcpConnection.java:139)\n\tat java.lang.Thread.run(Thread.java:534)\n\n\nExpected Results:  \nException while executing com.parsek.io.ApplicationIOException\n\tat com.parsek.io.BufferImpl.setThrowable(BufferImpl.java:286)\n\tat com.parsek.shell.impl.Process.closeJob(Process.java:190)\n\tat com.parsek.shell.impl.Process.run(Process.java:249)\n\tat com.parsek.cpii.services.PoolRunner$1.run(PoolRunner.java:58)\nCaused by: com.parsek.forms.WizardProcessingException: \norg.mozilla.javascript.JavaScriptException: \ncom.parsek.forms.NotAValidTypeException: Type \'Kak?en e-amil naslov ima??\' is \nnot recognized as a valid type by this wizard.\n\tat com.parsek.forms.impl.WizardImpl.<init>(WizardImpl.java:223)\n\tat com.parsek.cp2.iskernel.InsurletImpl.<init>(InsurletImpl.java:32)\n\tat com.parsek.cp2.iskernel.ISEngine.openSession(ISEngine.java:157)\n\tat com.parsek.shell.commands.wizard.WizardExe.process\n(WizardExe.java:319)\n\tat com.parsek.shell.AbstractExecutable.execute\n(AbstractExecutable.java:615)\n\tat com.parsek.shell.impl.Process.run(Process.java:220)\n\t... 1 more\nCaused by: org.mozilla.javascript.JavaScriptException: \ncom.parsek.forms.NotAValidTypeException: Type \'Kak?en e-amil naslov ima??\' is \nnot recognized as a valid type by this wizard.\n\tat org.mozilla.javascript.JavaScriptException.wrapException\n(JavaScriptException.java:77)\n\tat org.mozilla.javascript.NativeJavaMethod.call\n(NativeJavaMethod.java:265)\n\tat org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1200)\n\tat org.mozilla.javascript.gen.c1.call(183:28)\n\tat com.parsek.forms.impl.WizardImpl.<init>(WizardImpl.java:220)\n\t... 6 moreCC selfCreated attachment 122002\nFix: making NativeGlobal serializable\n\nIn the patch beyond making NativeGlobal to implement Serilalizable I removed\nunused import statements as well.Bojan, but how did you managed to pass NativeGlobal instance to\nJavaScriptException? It is not visible from scripts and it is public class only\nfor implementation reasons.I have not passed it to the exception; it got passed by itself :-)\n\nActually, what happened is that the (java)script was executing and an exception\nhappened in a Java class that this script was calling. Now, when this exception\ngot propagated to the client (in this case, from jBoss to Resin and to the\nHTML), I got a NotSerializableException.Reply to the last comment:\n\nThat makes sense since the exception contains the scope object which holds\nindirectly NativeGlobal instance. It also means that serialization does not use\norg.mozilla.javascript.serialize.ScriptableOutputStream and hence quite\ninefficient, but that is a different issue.While you are messing arround with JavaScriptException, is it possible to add\n\nif(value instanceof Throwable) {\n\tinitCause((Throwable) value);\n}\n\nI know it\'s a Java 1.4 feature and not directly connected to this bug and don\'t\nknow what\'s the Rhino\'s policy of supported Java versions, but it in the end it\ncould be done with method.invoke() or something similar.\n\nThis would help debugging a lot.\nPatches to invoke initCause via reflection are welcome.\nCreated attachment 122008\nJavaScriptException invoking initCause() using reflection\n\nAdded invoking od initCause() by reflection.\n\nHaven\'t tested it thorougly yet, but it should work.For the above chnages since they has nothing to do with this bug report, please\nfile a separated bugzilla report and mark it as enhancement or for simple\nimprovment like this you can either mail to me or Norris Boyd directly. And\nplease add diffs in unified output format (diff -u) not the sources so it would\nbe easier to see changes. And one more tip: please expand all tabs.\nkI committed the change to make NG serializableProvisionally marking Verified. Bojan, could you confirm that this\nhas fixed the problem for you? If not, please reopen this bug; thanks -Created attachment 122327\nThe initCause change in better patch form\n\nHere\'s the initCause change in better patch formCreated attachment 122599\nMaking prev patch smaller\n\nMy take on the previous patch to address to use single \"catch (Exception ex)\"\nand simply ignore exceptions if they happen for the following reasons:\n\n1. Many JVM outside Sun/IBM implementations can throw RuntimeExceptions when\nreflection fails which does not fit the official signature. \n\n2. Using single \"catch (Exception ex)\" saves a lot of byte code and makes class\nloading faster.\n\n3. If exception that is not suppose to happen still generated\nSystem.err/System.out may not work as well. In general it is rather bad idea to\nuse System.err/System.out for logging on embedded JVMs and if one needs such\nlogging, it is better to provide a separated API for that since not everybody\nworks with JDK 1.4.Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
203841,'Bad code generation to merge \"if\" and boolean expressions',Rhino,Compiler,briang,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.0.2) Gecko/20021216\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.0.2) Gecko/20021216\n\nWhen using a comma operator inside an if statement in non-interpreted mode, as\nin the following example,\n\nif (a = 5, b == 6) { c = 1; }\n\nRhino throws this exception:\n\nException in thread \"main\" java.lang.IllegalStateException: Stack underflow: -1\n        at org.mozilla.classfile.ClassFileWriter.badStack(ClassFileWriter.java:1154)\n        at org.mozilla.classfile.ClassFileWriter.add(ClassFileWriter.java:401)\n        at org.mozilla.javascript.optimizer.Codegen.addByteCode(Codegen.java:3568)\n        at org.mozilla.javascript.optimizer.Codegen.visitGOTO(Codegen.java:1574)\n        at\norg.mozilla.javascript.optimizer.Codegen.generateCodeFromNode(Codegen.java:1172)\n        at\norg.mozilla.javascript.optimizer.Codegen.generateCodeFromNode(Codegen.java:1044)\n        at\norg.mozilla.javascript.optimizer.Codegen.generateCodeFromNode(Codegen.java:1044)\n        at org.mozilla.javascript.optimizer.Codegen.generateCode(Codegen.java:409)\n        at org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:137)\n        at org.mozilla.javascript.Context.compile(Context.java:1916)\n        at org.mozilla.javascript.Context.compileReader(Context.java:886)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:803)\n        at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:260)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\n\nReproducible: Always\n\nSteps to Reproduce:\n1. use the js> shell\n2. Enter the following:\n\njs> Packages.org.mozilla.javascript.Context.enter().setOptimizationLevel(1);\njs> if (a = 5, b==6} { return false; }\n\nActual Results:  \nGot this exception:\n\norg.mozilla.javascript.optimizer.Codegen.generateCode(Codegen.java:409)\n        at org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:137)\n        at org.mozilla.javascript.Context.compile(Context.java:1916)\n        at org.mozilla.javascript.Context.compileReader(Context.java:886)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:803)\n        at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:260)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\n\nExpected Results:  \nNo exception\n\nThis isn\'t a problem in interpreted mode.Confirming bug; cc\'ing Igor -Testcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-203841.js\n\n\nCurrently passing in SpiderMonkey and Rhino interpreted mode.\nBut crashing in any optimized Rhino mode, with the above stack.I changed the subject since the same problem persists not only with comma\noperator cases like:\n\nif (1, 1 == 6) ;\n\nbut also with the following cases\"\n\n// get elem case\nx=[];\nif (x[1==2]) ;\n\n// set elem case\nif (x[1==2]=1) ;\n\n// delete elem case\nif (delete x[1==2]) ;\n\n\nAll these cases caused by incorrect code generation optimization to merger\nevaluation of boolean expressions like x == y, a && b etc. with generation code\nfor conditional jumps like code for if statements, ? operator etc.\n\nIn fact these test cases are produced by looking for the code of\ngenerateCodeFromNode in  omj/optimizer/Codegen.java.\nCreated attachment 122121\nFix for Codegen.java: conditional jumps are processed in new generateIfJump method\n\nTo fix the issue I moved away from generateCodeFromNode code to merge boolean\nchecks and conditional jumps into separated generateIfJump method that tries to\napply this optimization and if it is not possible, it calls\ngenerateCodeFromNode and adds a generic jump.I\'ve added Igor\'s new examples from Comment #3 to the testcase.\nOnce again, passing in SpiderMonkey and in Rhino interpreted mode,\nbut failing in Rhino compiled modes.I committed the fix. By \"if and boolean checks merger\" I mean special code in\nthe optimizer not to generate Boolean object just to convert them to boolean on\nJVM stack later when generating bytecode for conditional jumps but rather use\nIFLE etc. bytecode to compare and jump skipping intermediate steps. \n\nHopefully the fix closed all the problems with the optimization.\n\nVerified FIXED.\n\nThe above testcase now passes not only in Rhino interpreted mode,\nbut in optimized modes as well.Targeting as resolved against 1.5R5',?,BUG
203909,'Behavior of built-in functions called as constructors should follow standard.',Rhino,Core,igor,norrisboyd,'This is a Rhino version of bug 202019 , see the description there.Created attachment 122124\nFix: throw TypeError by default in IdFunction.constructor if the function is not explicitly coded as constructor.\n\nTo resolve this in a uniform way I changed BaseFunction.constructor to always\ncall createObject and then run the call method so IdFunction and FunctionObject\nneeds to override only createObject and not the construct method itself. Then\nIdFunction.createObject simply throws TypeError if the function is not\nexplicitly marked as constructor.\n\nThe current behavior of SM can be obtained if instead of throwing error,\nIdFunction.createObject can call super.createObject.\n\nThe patch should cover all the standard library functions since all of them are\nimplemented in terms of IdFunction and they marked as constructors only when\nthe standard required it.Created attachment 122125\nFix update: better commentsI committed the fix, now in Rhino shell:\n\njs> new parseInt(\'1\')\njs: \"<stdin>\", line 1: uncaught JavaScript exception: TypeError: \"parseInt\" is\nnot a constructor. (<stdin>; line 1)\n\njs> new String.prototype.toString()\njs: \"<stdin>\", line 2: uncaught JavaScript exception: TypeError: \"toString\" is\nnot a constructor. (<stdin>; line 2)\n\nVerified FIXED. But is the error message for |eval| correct?\n\nRhino 1.5 release 5 0000 00 00\njs> var obj = new eval();\nTypeError: [object global] is not a function.\n\n\nShouldn\'t the error message say, \'\"eval\" is not a constructor\'?\n\n\nCOMPARE: \n\njs> var obj = new isFinite();\nTypeError: \"isFinite\" is not a constructor.\n\njs> var obj = new Date.parse();\nTypeError: \"parse\" is not a constructor.Note: Igor has fixed the error message for |new eval();| in bug 204210.\nSee bug 204210 comment 4.Targeting as resolved against 1.5R5',?,SPEC
204210,'new eval() triggers ArrayIndexOutOfBoundsException in interpreted mode',Rhino,Core,igor,norrisboyd,'The following one line script causes ArrayIndexOutOfBoundsException in\ninterpreted mode:\n\nnew eval();\n\n~> java -jar ~/.../js.jar -opt -1 -e \'new eval()\'\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2117)\n        at org.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:62)\n        at org.mozilla.javascript.InterpretedScript.exec(InterpretedScript.java:5\n...\n\n\nFor the test case it may be necessary to use code like:\n\nfunction f()\n{\n\tnew eval();\n}\n\nf();\n\nsince the bug corrupts interpreter stack and it may not be visible if new eval()\nis not a single statement in function/script.Testcase added to JS testsuite:\n\n          mozilla/js/tests/js1_5/Regress/regress-204210.js\n\nThe testcase puts |new eval();| inside |try...catch| blocks, since in Rhino\nthis construct is supposed to produce a run-time error due to bug 203909,\n\"Behavior of built-in functions called as constructors should follow standard.\"\n\nHowever: the Rhino interpreted-mode crash on |new eval();|, i.e. the\ncurrent bug, isn\'t occurring when |new eval();| is inside |try...catch|!\n\nSo it looks like I\'ll have to verify the fix for this bug manually -Created attachment 122578\nFix: eval call reorganization\n\nThe patch merges ScriptRuntime.callSpecial and ScriptRuntime.newObjectSpecial\ninto single ScriptRuntime.callSpecial which takes a boolean flag to indicate if\nthis is a call from new and a special call type id as parameter for better\nerror reporting so new eval() prints:\njs: \"<stdin>\", line 1: uncaught JavaScript exception: TypeError: \"eval\" is not\na constructor. (<stdin>; line 1)I committed the fixVerified FIXED interactively in the Rhino shell:\n\n\n------------------------- BEFORE THE FIX -------------------------\njs> new eval();\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: -1\nat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2115)\nat org.mozilla.javascript.InterpretedScript.call(InterpretedScript.java:62)\nat org.mozilla.javascript.InterpretedScript.exec(InterpretedScript.java:55)\nat org.mozilla.javascript.Context.evaluateReader(Context.java:806)\nat org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\nat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:260)\nat org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\nat org.mozilla.javascript.tools.shell.Main.main(Main.java:76)\n\n\n\n-------------------------- AFTER THE FIX -------------------------\njs> new eval();\njs: \"<stdin>\", line 1: uncaught JavaScript exception:\nTypeError: \"eval\" is not a constructor. (<stdin>; line 1)Targeting as resolved against 1.5R5',?,BUG
204513,'Not recognizing JS primitive string as CharSequence',Rhino,Core,timothy.folks,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.3) Gecko/20030312\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.3) Gecko/20030312\n\nRunning under Java 1.4.1 Calling a Java method that takes a CharSequence and\npassing either a JavaScript string or a Java string results in \"Can\'t find\n method(string)\" or \"Cannot convert <string> to java.lang.CharSequence\"\nrespectively.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Using Java 1.4 or higher, create a simple Java class:\n\npublic Foo {\n  void bar(CharSequence cs) {\n      //Do something\n  }\n}\n\n2. Compile the class.\n3. Start Rhino with Foo in the classpath.\n4. importClass(Packages.Foo);\n5. var o = new Foo\n6. o.bar(\'somestring\');\n\nActual Results:  \nMessage returned:\n\"<stdin>\", line 3: Can\'t find method Foo.bar(string).\n\nExpected Results:  \nSimply returned to the shell prompt without errorcc\'ing Igor -Just clarifying: in the sample Foo class posted with the initial report, void \nbar should be *public* void bar. It was a typo. The public void bar method \ngenerates the error message.1. Inability to use instances of Java String obtained via LiveConnect as an\nargument to Java method taking CharSequence parameter. This is a regression\nsince Rhino 1.5R3 and I will file a separated bug for that. For example in 1.5R3\nthe following prints 4 as expected but in 1.5R4* it gives an exception:\n\nvar length = Packages.test.length(java.lang.String(\"test\"))\nprint(length)\n\nwhere test is \n\npublic class test\n{\n\tpublic static int length(CharSequence cs)\n\t{\n\t\treturn cs.length();\n\t}\n}\n\n\n2. Inability to use JS primitive strings as an argument to Java method taking\nCharSequence parameter (this bug). It never worked so it is just a new feature\nto support. Note that the fact that JS primitive strings are represented\ninternally by instances of java.lang.String does not matter here since\nLiveConnect support treats them in a very different way than instances of\njava.lang.String exposed to scripts via LiveConnect.Changing title to better reflect the bug natureCreated attachment 122570\nFix: use type.isInstance(str) to check if str can be used as argument with the given type\n\n\n\nThe fix replaces explicit checks to see if type is Object, Serializable or\nComparable by more generic calls to type.isInstance(str) which covers\nCharSequence case as well.I committed the fixVerified FIXED.\n\nBelow, I compare Rhino1_5R3 vs. Rhino1_5R5pre before and after\nthe fix. For \"//Do something\" in Tim\'s testcase above, I put:\n\n  System.out.println(\"\\nYOU HAVE FOUND THE Foo.bar METHOD\\n\");\n\n\n------------------------------  Rhino1_5R3:  ------------------------------ \n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R3/js.jar\" \n         org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 3 2002 01 24\njs> importClass(Packages.Foo);\njs> var o = new Foo;\njs> o\nFoo@540408\n\n------------------ PROVIDING A JS PRIMITIVE STRING ------------------\njs> o.bar(\'test\');\njs: \"<stdin>\", line 4: Can\'t find method Foo.bar(string).\n\n--------------------- PROVIDING A JAVA STRING  ----------------------\njs>o.bar(java.lang.String(\"test\"))\n\nYOU HAVE FOUND THE Foo.bar METHOD\n\n\n\n\n--------------------------  Rhino1_5R5pre BEFORE  ---------------------------\n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R5pre/js.jar\" \n         org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> importClass(Packages.Foo);\njs> var o = new Foo;\njs> o\nFoo@18a7efd\n\n------------------ PROVIDING A JS PRIMITIVE STRING ------------------\njs> o.bar(\'test\');\njs: \"<stdin>\", line 4: Can\'t find method Foo.bar(string).\n\n--------------------- PROVIDING A JAVA STRING  ----------------------\njs> o.bar(java.lang.String(\"test\"))\njs: \"<stdin>\", line 6: Can\'t find method Foo.bar(string).\n\n\n\n\n--------------------------  Rhino1_5R5pre AFTER  ---------------------------\n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R5pre/js.jar\"  \n          org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> importClass(Packages.Foo);\njs> var o = new Foo;\njs> o\nFoo@18a7efd\n\n------------------ PROVIDING A JS PRIMITIVE STRING ------------------\njs> o.bar(\'test\');\n\nYOU HAVE FOUND THE Foo.bar METHOD\n\n--------------------- PROVIDING A JAVA STRING  ----------------------\njs>o.bar(java.lang.String(\"test\"))\n\nYOU HAVE FOUND THE Foo.bar METHODTargeting as resolved against 1.5R5',?,DESIGN_DEFECT
204576,'1.5R4 regression: java.lang.String can not be used when argument type is  java.lang.CharSequence',Rhino,Core,igor,norrisboyd,'Given the following script:\n\nvar length = Packages.test.length(java.lang.String(\"test\"))\nprint(length)\n\nwhere test is Java class \n\npublic class test\n{\n\tpublic static int length(CharSequence cs)\n\t{\n\t\treturn cs.length();\n\t}\n}\n\nRhino 1.5R3 correctly prints 4 while 1.5R4 and the current tip gives an error;\n\njs: \"/home/igor/w/js/x/test.js\", line 1: Can\'t find method test.length(string).Bug 204513 should wait until this regression will be fixedI believe the problem was introduced with the revision 1.26 of NativeJavaMethod\nwhich fixed a problem of selecting overriden methods when used with Cistom wrap\nobjects:\n\n----------------------------\nrevision 1.26\ndate: 2002/04/11 12:56:24;  author: nboyd\%atg.com;  state: Exp;  lines: +15 -0\nFix for following problem:\n\nhi Norris,\n\nin our product, which makes heavy use of Rhino, we have many Java Objects\nwe wrap with ECMAScript wrappers, which extend the ScriptableObject class\nand implement the Wrapper interface. Those wrappers automagically wrap the\nnative Java object with the help of a WrapHandler implementation.\n\nwe now ran into a problem :\n\nwe have a java class with two overloaded static methods like this :\n     public class Test {\n         public static String create(File f) {}\n         public static String create(Custom c) {}\n     }\n\nThe Custom class exists as a native Java implementation like\n     public class Custom {}\n\nand a accompanying ECMAScript wrapper like\n     public class CustomWrapper\n        extends ScriptableObject\n        implements Wrapper {}\n\nin our ECMAScripts we make the wrapper class known as a host object along\nthe lines of\n     defineClass(\"CustomWrapper\");\nand can then use the object as a normal ECMAScript host object. no big deal\nand working great.\n\nbut : the code\n     var s = Test.creat( new Custom( \"xyz\") );\nfails with the information, that the methods are ambiguous, which of course\nthey are not.\n\nLooking at the code of NativeJavaMethod.findFunction() and the helpers in\nNativeJavaObject it seems, that the fact of the Custom host object being a\nWrapper is not taken into account. in an easy fix of\nNativeJavaMethod.findFunction(), i simply replace all arguments, which are\nWrapper imlpementation by the wrapped object. this solves my problem, but\nof course i\'m not sure on side effects.\n\ni attach the testcase as well as the fixed NativeJavaMethod class in the\njar file. to run the test with and without the fix, extract the jar and do\n     ant test\n\nplease let me know, what you think of this.\n\nregards and thanks, f.\n\nFelix Meschberger\n----------------------------\n\nThe problem is that the fix unconditionally unwraps wrapped java.lang.String\nwhich means that they are treated as JS primitive strings and that are not\nsupported with java.lang.CharSequence.\n\nCreated attachment 122558\nTest case for custom wrap problem as a patch file\n\nAny fix should not only address the problem itself but also keeps working\ncustom wrapping, so here is a test case to check that as well. To run it,\ncompile 204576/CustomWrapFactory.java and then run 204576/wrap_test.js with the\nRhino shell. It should print \nsize Vector: 0\nsize Hashtable: 0Created attachment 122559\nFix: proper handling of custom wrappers\n\nThe fix idea is to make sure that all code like (obj instanceof\nNativeJavaObject) should be replaced by (obj instanceof Wrapper) since the idea\nof Wrapper interface introduction is to use it instead of NativeJavaObject in\nthe LiveConnect code. It turned out the only such place left is\nNativeJavaObject.getJSTypeCode which the patch replaces. Then the patch undo\nthe initial fix.I committed the fix.I put the fix to Rhino150R4_BRANCH as well. It a pity that the problem was found\nafter 1.5R4.1 but if someone wants a Rhino with just that version fixed, the\nbranch can be used.Verified FIXED.\n\nWe compare Rhino1_5R3 vs. Rhino1_5R5pre before and after the fix:\n\nRhino1_5R3\n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R3/js.jar\" \n         org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 3 2002 01 24\njs> var length = Packages.test.length(java.lang.String(\"test\"))\njs> length\n4\n\n\nRhino1_5R5pre BEFORE\n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R5pre/js.jar\" \n         org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> var length = Packages.test.length(java.lang.String(\"test\"))\njs: \"<stdin>\", line 1: Can\'t find method test.length(string).\n\n\nRhino1_5R5pre AFTER\n[ ] java -classpath \".;D:/JS_TRUNK/mozilla/js/rhino/build/rhino1_5R5pre/js.jar\"  \n          org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> var length = Packages.test.length(java.lang.String(\"test\"))\njs> length\n4Targeting as resolved against 1.5R5',?,BUG
205297,'Infinite recursion with LazilyLoadedCtor',Rhino,Core,igor,norrisboyd,'My changes to ScriptableObject.setBySetter, see revision 1.56 that I put to fix\na potential race condition with one-time setters contains a bug that leads to\ninfinite recursion with rather specific usage of this feature.\n\n----------------------------\nrevision 1.56\ndate: 2002/12/03 12:38:55;  author: igor\%mir2.org;  state: Exp;  lines: +115 -10\n6\n...\n2. Fixing a potential race condition in setBySetter when a setter slot becomes\nan ordinary slot in response to a setter returning a value.\n\nDuring execution of setBySetter a different thread can see initial null value in\nslot.value instead of the result of setter call as it is possible that JVM will\nfirst update slot.flags and only then slot.value for that thread. The fix\nreplaces the old getter slot  by an ordinary one under synchronized block for\nthat I added new getSlotPosition method and updated the rest of code accordingly.\n----------------------------\n\nThe problem with the changes is that lastAccess is not cleared in setBySetter\nand will contain the old setter so the next get access for the same property\nwill invoke the old getter which in case of LazilyLoadedCtor will invoke put and\nsetBySetter recursively.Created attachment 122990\n Java test case with call to LazilyLoadedCtor to trigger the problem\n\nTo test, compile and add to CLASSPATH Test class and then run the following\nscript in Rhino shell:\n\nPackages.Test.lazilyInit(this);\n\nprint(\"OK\");\n\nwhich should print OK but without the fix the the result is an exception.Created attachment 122991\nFixI committed fix to the main bramch and Rhino150R4_BRANCH as well since it is a\nregression since 1.5R3 even it is hard to trigger.\nVerified FIXED. Igor: thank you for the testcase!\n\n\nBEFORE:\n[ ] java org.mozilla.javascript.tools.shell.Main -f test.js\njs: uncaught JavaScript exception: org.mozilla.javascript.WrappedException:\nWrappedException of null\n\nAFTER:\n[ ] java org.mozilla.javascript.tools.shell.Main -f test.js\nOKTargeting as resolved against 1.5R5',?,BUG
205661,'Unexpected prototype and Java setter interaction',Rhino,Core,igor,norrisboyd,'Rhino contains API that allows to define in Java getters and setters for JS\nproperties, see\nhttp://mozilla.org/rhino/apidocs/org/mozilla/javascript/ScriptableObject.html#defineProperty(java.lang.String,\%20java.lang.Object,\%20java.lang.reflect.Method,\%20java.lang.reflect.Method,\%20int)\n\nBut when the delegator form of the setter for property \"someProperty\" is used\nfor object \"x\" which is a prototype for object \"y\", then invoking:\n\ny.someProperty = 1\n\nwill change the value of someProperty in x leaving y object intact. This is\nrather unexpected behavior since it does not follow the standard JS logic which\nrequire in this case to create a new property someProperty in y without changing x.\n\nThis form of getters/setters is used to initialize various library objects\nlazily which can be used to demonstrate the problem in Rhino shell:\n\n----- test start -----\nfunction X() { }\nX.prototype = this;\n\nvar x = new X; // this is prototype of x now\n\n//Uncomment the following to enable proper behavior since it will initialize \n//JavaAdapter and replace getter/setter for JavaAdapter property in this \n\n//this.JavaAdapter;\n\nx.JavaAdapter = 1;\n\n\nvar ok = this.JavaAdapter != 1;\nprint(ok ? \"OK\" : \"Strange\");\n----- test end -----Created attachment 123280\nFix: follow default JS rules in ScriptableObject.setBySetter if start != this\n\nThe patch changes changes logic of a setter with delegator to never invoke it\nif the property is accessed via prototype. A similar treatment is applied for a\nsetter without delegator in the cases when start is not an instance of this\ntype since this case would show the same behavior of changing prototype\nproperty and not creating a new property in the original object.I committed the patchVerified FIXED using Igor\'s testcase above -\n\nBEFORE FIX:\n[ ] java org.mozilla.javascript.tools.shell.Main -f 205661.js\nStrange\n\nAFTER FIX:\n[ ] java org.mozilla.javascript.tools.shell.Main -f 205661.js\nOKTargeting as resolved against 1.5R5',?,DESIGN_DEFECT
207968,'Wrapped Exception \"fills\" in stack trace masking original stack',Rhino,Core,rknight,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.0.3705; .NET CLR 1.1.4322)\nBuild Identifier: \n\nThe line:\n    this.exception = exception.fillInStackTrace();\nin the WrappedException constructor causes the original stack trace to be \nmasked. My suggestion is simply to remove this line.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.cc\'ing Igor -Sounds like a reasonable change to me.Created attachment 125314\nThe fix a s a patchCreated attachment 125315\nThe fix as a patchI committed the fix.Rubber-stamp vrfy -Targeting as resolved against 1.5R5',?,CLEANUP
207999,'Cannot derive from EcmaError class since construction parameter is private class',Rhino,Core,rknight,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.0.3705; .NET CLR 1.1.4322)\nBuild Identifier: \n\nWe need to derive from the EcmaError class to create our own exceptions. The \nfirst parameter of the EcmaError constructor is the private class NativeError. \nEither the NativeError class needs to be made public or the parameter changed \nto a public class.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 125318\nFix: use generic Scriptable as an argument to EcmaError\n\nThe only reason for EcmaError to require NativeError as constructor argument is\nto be able to call getName/getMessage on the error object. But NativeError\nobjects will return the same information via generic\nScriptRuntime.getStrIdElem(object, \"name\"/\"value\"), so the patch uses that\nmethod instead. \n\nIt is now a responsibility of EcmaError caller to supply objects with\nreasonable \nvalues for \"name\"/\"message\" properties.I committed the fixRubber-stamp vrfy -Targeting as resolved against 1.5R5',?,DESIGN_DEFECT
208293,'Loading a large script in the Rhino debugger results in an endless loop (100\% CPU utilization)',Rhino,Core,steven.beal,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: \n\nLoading a large script in the Rhino debugger results in an endless loop.\nThe CPU utilization will jump to 100\% and stay there.  A <ctrl><break>\nthread dump from the VM indicates an endless loop in \norg.mozilla.javascript.Context.readReader().\n\nLooking at the code, an error was introduced with Context.java v1.110.\nThe buffer is never grown prior to the call to System.arraycopy().\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Start the debugger\n2.Load a script file containing more than 512 characters.\n3.\n\nActual Results:  \nCPU utilization rose to 100\%\n\nExpected Results:  \nThe text of the .js file should have been displayed in the\ndebugger.Created attachment 124916\npatch correcting the described bugcc\'ing Igor -I committed the fix. Thanks Steve for spotting this!Rubber-stamp vrfy -Targeting as resolved against 1.5R5',?,IMPROVEMENT
210605,'Script catches all Throwables when inside reflected Java method',Rhino,Core,hannesw,igor,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.4) Gecko/20030529\nBuild Identifier: \n\nIf a java method is called through reflection by\norg.mozilla.javascript.NativeJavaMethod.call(), all instances of\njava.lang.Throwable thrown while executing that method are caught by a\nsurrounding JavaScript try/catch statement.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Compile this class and add it to your classpath:\npublic class Test {\n    public static void stop() {\n        Thread.currentThread().stop();\n    }\n}\n\n2. Execute this script: \ntry {\n        Packages.Test.stop();\n} catch (x) {\n        java.lang.System.err.println(\"cought: \"+x);\n}\n\nActual Results:  \nThe following line is printed: \ncought: java.lang.ThreadDeath\n\nExpected Results:  \nJavaScript shouldn\'t be able to catch the java.lang.ThreadDeath.\n\nThe cause of the problem seems to be that all Errors/Throwables are caught by\nNativeJavaMethod.call() wrapped inside a InvocationTargetException, which is\nthen again wrapped inside a JavaScriptException. I guess the right thing would\nbe to unwrap and check the Throwable wrapped by the InvocationTargetException\nand either wrap that in the JavaScriptException or rethrow it. The following\ncode in line 272 of NativeJavaMethod fixes the problem for me:\n\n        } catch (InvocationTargetException e) {\n            Throwable t = e.getTargetException();\n            if (!(t instanceof Exception)) {\n                Thread.currentThread().stop(t);\n            }\n            throw JavaScriptException.wrapException(cx, scope, e);\n        }\n\nI\'m not sure if this is the way to go, though, and I don\'t understand why\nNativeJavaMethod behaves differently than FunctionObject, which handles\nInvocationTargetExceptions in the same way.cc\'ing Igor -Created attachment 126809\nConsistent exception handling \n\nThis big patch changes exception handling in Rhino in the following way:\n\n1. JavaScriptException is used only to represent exceptions thrown by the\nscript throw statement. Previously the class was used as well to wrap instances\nof Throwable that script can catch.\n\n2. WrappedException is always used to wrap instances of Throwable that script\ncan catch by the catch statement. The new method\nScriptRutime.throwAsUncheckedException() that replaces\nWrappedException.wrapException() will either re-throw the exception wrapped as\nWrappedException or re-throw it as is. The method unwrap\nInvocationTargetExceptions and if its target is Error instance, it is re-thrown\nas is. In this way the script catch statement will never see instances of Error\nincluding ThreadDeath.\n\n3. Since the change effectively means that the script catch can see instances\nof JavaScriptException, EcmaError and WrappedException, the new method\nScriptRutime.getCatchObject is used to extract JS object that is passed as the\ncatch argument. For JavaScriptException and EcmaError the method simply\nextracts the corresponding JS object. For WrappedException the method wraps the\noriginal exception as a LiveConnect object. In this way a potentially expensive\nLiveConnect wrapping is avoided if the exception is never caught by a script.\n\nInterpreter.interpret and optimizer/Codegen.generateCatchBlock is updated to\nuse the new method.Created attachment 126817\nPatch updates with more commentsThanks Igor. I\'m running the patched version, everything looks right now.I committed the patch.This bug has resurfaced with revision 1.173 of Context.java committed on\n01/16/2004: By removing the lines \n\n    if (e instanceof Error) { \n        throw (Error)e;                                                     \n    }\n\nfrom Context.throwAsUncheckedException(), java.lang.Errors are thrown as\nWrappedExceptions, which will be cought by JavaScript catch statements.That was caused by my attempt to get script source/line number information for\nall exceptions including LinkageError and StackOverflow. For I now I will revert\nthe check for Error instances and after 1.5R1.5 release implement better solution.Should be fixed in 1.5R5Created attachment 140103\nFix to restore special handling of ErrorI committed the fix.Thanks Igor. From your comments it seems like 1.5R5 is just around the corner,\nwhich is also good to hear.Trageting as resolved against 1.5R5',?,DESIGN_DEFECT
210682,'if a line ends with \'continue\' and is only terminated by a CR causes a \'SyntaxError: missing ; before statement\'',Rhino,Core,briang,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.4) Gecko/20030529\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.4) Gecko/20030529\n\nif you have the following code snippet:\n\nfor (i = 0; i < 100; i++) {\n   if (i \% 2 == 0) continue\n   this.lasti = i;\n}\n\nyou get the following error: \"SyntaxError: missing ; before statement\"\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.\n\n\n\nExpected Results:  \nIt above code example is valid JS syntax.  The problem lies in TokenStream. \nWhen the continue keyword is processed, Rhino checks for the optional label. \nSince there isn\'t one, it pushes back the EOL token.  However,\nTokenStream.peekTokenSameLine changes the token from EOL to EOF when it pushes\nback the token (member variable pushbackToken).  Finally, when Rhino calls\ncheckWellTerminated, the TokenStream sees the EOF, continues processing the\nstream and \'forgets\' it saw an EOL.\n\nI fixed this by not converting the EOL to EOF in\nTokenStream.peekTokenSameLine().  TokenStream.getToken() then checks if the\npushbackToken was EOL, and if so, validates for the TSF_NEWLINES flag.  If that\nis set, it returns the EOL, otherwise it drops through and continues processing\nthe stream.cc\'ing Igor -My code changes for TokenStream.java are:\n\n    public final int peekTokenSameLine() throws IOException {\n        flags |= TSF_NEWLINES;          // SCAN_NEWLINES from jsscan.h\n        int result = getToken();\n        this.pushbackToken = result;    // BG: Removed check for EOL\n        tokenno--;\n        flags &= ~TSF_NEWLINES;         // HIDE_NEWLINES from jsscan.h\n        return result;\n    }\n\nand\n\n   public final int getToken() throws IOException {\n        int c;\n        tokenno++;\n\n        // Check for pushed-back token\n        if (this.pushbackToken != EOF) {\n            // If this isn\'t an EOL or it\'s an EOL and we are tokenizing EOL,\nreturn it.  Otherwise\n            // fall through.\n            if (this.pushbackToken != EOL || (this.pushbackToken == EOL &&\n(flags & TSF_NEWLINES) != 0)) {\n                int result = this.pushbackToken;\n                this.pushbackToken = EOF;\n                return result;\n            }\n        }\n        ....\nCreated attachment 126720\nfix as a patch\n\nIn the patch I made sure that pushbackToken is always set to EOF after its\nvalue is consumed even if it would contain EOL pushed there by\npeekTokenSameLine.I committed the patchTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-210682.jsTargeting as resolved against 1.5R5',?,BUG
212395,'Bad Flag field assignment in javascript.regexp.NativeRegExp',Rhino,Core,olivier.oeuillot,rogerl,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.4) Gecko/20030624\nBuild Identifier: \n\norg.mozilla.javascript.regexp.NativeRegExp\n\n\n\tpublic void init(Context cx, Scriptable scope, String str, String global,\nboolean flat) {\n\n\n.....\n\nthis.parenCount = state.parenCount;\nthis.flags = flags;  <<<<<<<< NO effect !\nthis.lastIndex = 0;\n\n....\n}\n\n\nSolution ? :\n\n\tpublic void init(Context cx, Scriptable scope, String str, String global,\nboolean flat) {\n\t\tthis.source = str.toCharArray();\n\t\tint length = str.length();\n\t\tint flags = 0;   <<<<< int declaration !\n\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Assigning this one to Roger -Created attachment 130719\nThe above suggestion as a patchI committed the fix.Rubber-stamp vrfy -Trageting as resolved against 1.5R5',?,BUG
213231,'try / finally not working right',Rhino,Core,okidoky,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.3b) Gecko/20021213\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.3b) Gecko/20021213\n\nLike in Java, each finally block gets a guaranteed chance to run code upon exit\nof a scope.\nThings get a little strange when an exception is thrown from inside a finally\nblock, but, the outer finally blocks still must get a chance to run. \nPresumably, the first exception actually thrown makes it through, not sure.\nThe thing, is, it\'s understandable that it is quite tricky to implement a\nJavascript interpreter/compiler (or Java compiler) that properly handles this.\nBelow is a small code fragment how it gets confused.\n\nReproducible: Always\n\nSteps to Reproduce:\ntry\n{\n  print(\"try\");\n}\nfinally\n{\n  print(\"finally\");\n  throw 1;\n}\n\nThe output is:\ntry\nfinally\nfinally\n\nIt ran the print(\"finally\") twice...\n\nTry this in more details, using a counter:\n\n    try\n    {\n        n=0;\n        try\n        {\n          print(\"try\");\n        }\n        finally\n        {\n          print(\"finally\");\n          n++;\n          throw 1;\n        }\n    }\n    catch (e)\n    {\n        print(\"caught \" + e);\n    }\n    print(\"n=\" + n);\n\nThe output is:\ntry\nfinally\nfinally\ncaught 1\nn=2\n\nn became 2, proving again that the finally block ran twice.\n\nmy guess is that the bug is that Rhino wants to run the finally block even\nthough the exception is thrown from within that finally block.  It is not\ninfinite looping because presumably upon the first throw, the finally block gets\nmarked/flagged, so that next time it knows it already ran.  If this is how it\nworks, then perhaps a simple fix would be to \'flag\' the finally block upon\nentering, before any exception.\n\n\n\n\n\nIf there are no developers involved in Rhino anymore, I wouldn\'t mind getting\ninvolved.  Rhino is a relative untapped resource and is way more useful than\npeople give it credit for.  Therefore I wouldn\'t mind getting some exposure this\nway.The bug presnts only in the interpreter mode (optimization -1), with\noptimization set to 0 or higher I have in the current tip/ 1.5R4.1 / 1.5R3:\n\ntry\nfinally\ncaught 1\nn=1\n\nwhile the interpreter gives:\n\ntry\nfinally\nfinally\ncaught 1\nn=2\nThe reason for the bug is that the interpreter maintains a stack of entered try\nstatements and during execution of a finally handler when code leaves the try\nblock, the finally handler is executed with the try stack still pointing to the\ncurrent try.\n\nIt is possible to fix the bug with properly updating the try stack before\ncalling the finally handler (adding ENDTRY byte code when necessary) but it is\ncomplicated by the fact that finally has to be executed after each\nreturn/break/continue that transfer control outside the try block and each such\ncase requires to know if the code is inside try or is inside catch with try\nstack already updated.\n\nIt seems a better way to fix this is to follow JVM byte code in the interpreter\n and construct a table of starting/ending byte codes for the try blocks and\ninstead of looking at the top of the try stack search this table when looking\nfor catch or finally handler. In this way finally code will never be executed\ntwice since it will be outside code for the try block.\n\nAs far as I can see the biggest obstacle to such implementation comes from\n\"with\" statements and changes in the scope that exception handler has to\nrestore. Currently the proper scope is placed on the try stack providing a\ntrivial way to restore the scope. \n\nWithout the try stack a counter has to be maintained of current \"with\" statement\n nesting and exception handler should store a static information about its\n\"with\" level. The exception handling can then unwind with scopes until the\ncurrent and expected levels matches.\nCreated attachment 128319\nFirst fix part: when handling exceptions, restore proper scope without using try stack\n\nThe patch implements the above idea of restoring catch/finally scope without\nusing try stackCreated attachment 128323\nThe seconf fix part: replacing try stack by static table of exception handlers\n\nWith the patch the above test case behaves properly under any optimization\nlevel.Created attachment 128336\nAdditional cleanup: store catch/finally/with depth in the exception handler\n\nThis is an addition to the previous patch to completely remove generation f TRY\nbyte code. Since the second patch makes TRY byte code to hold only\ncatch/finally offsets and width depth, this patch moves that information into \nexception table removing the need for TRY byte code.I committed the above patches to the interpreter. They passes the test suite and\nfixes the above problem but it is a significant change still.Targeting as resolved against 1.5R5',?,BUG
213279,'Scope should not be cached through JavaMembers.classTable',Rhino,Core,igor,norrisboyd,'Rhino uses JavaMembers.classTable which is a static Hashtable to cache\nreflection information about Java classes. Currently the cache stores not only\nMethod and Field instances for a particular class, but also top level scope of\nthe first script that initializes a cache entry for a particular class. It not\nonly prevents scope objects from garbage collection but also allows to access\nobjects from this scope from different runtime invocation. \n\nThe following attached Java source demonstrate this incorrect exposure by\nexecuting 2 times\n\njava.lang.System.out.println.__proto__ === Function.prototype\n\nin 2 different scopes fully initialized with their own instances of the runtime\nlibrary objects.\n\nThe first execution produces the expected true result while the second gives\nfalse since cached JS wrapper for java.lang.System.out.println still points with\nits prototype to Function.prototype from the first scope.Created attachment 128148\nTest case as Java source\n\nTo run the test, compile the Test.java and run it. Currently it produces:\n\n~/tmp> java Test\nExecuting: java.lang.System.out.println.__proto__ === Function.prototype\nFirst execution result:  true\nSecond execution result: false\n\nwhile the expected resultis is true for both executions.Created attachment 128416\nPreliminary work: separation of reflection data and corresponding JavaScript wrappers.\n\nThe patch changes JavaMemebers to separate between Java fields and methods with\nthe same name and corresponding JavaScript wrappers.\n\nI added MemberFamily class to hold all members with the same name including\nsynthetic bean properties. In addition the class contains sharedWrapper field\nto hold a JS wrapper for the given Java name that does not require\ncorresponding Java object.  Internal hash tables in JavaMemebers now always\ncontain instances of this class as values instead of mixed bag of\nNativeJavaMethod, BeanInfo and Field instances.\n\nThe other notable change is that FieldAndMethods that is used to wrap Java\nfield and methods with the same name now uses delegation to call\nNativeJavaMethod in () or new context instead of extending from\nNativeJavaMethod. In this way a single shared NativeJavaMethod will be used to\nrepresent method part of all FieldAndMethods objects. In addition instances of\nFieldAndMethods corresponding to the same name static field and methods is also\nshared since neither field nor methods need java object in this case.\n\nNow the bug emphasis itself in presence of MemberFamily.sharedWrapper with\nexplicit scope references that is stored in a static cache of JavaMemberse and\na fix would require to store sharedWrapper in scope instead.Created attachment 130812\nMove NativeJavaPackage.TopLevelPackage into a separated source file NativeTopJavaPackage\n\nAnother preliminary patch. It moves internal NativeJavaPackage.TopLevelPackage\nclass into a separated source file under the new name NativeTopJavaPackage. The\nidea is to store a class cache there and pass it around to other classes that\nuses JavaMembers.Created attachment 130818\nSmall fixes for the previous patchI committed the previous patch.Created attachment 130832\nFix: store caches inside global scope\n\nThe patch adds new class, omj.GlobalScope that is supposed to serve as a global\nscope for the standard library and which stores previously static caches. \n\nThe class contains a static method get(Scriptable) to extract a class instance\nfrom a scope object. JavaMembers and FunctionObject is updated to use this\nmethod to access the caches. The method searches the prototype chain for\ninstance of GlobalScope and if it found, it is returned. If not, then a\nproperty __globalScope is queried for the class instance. If that does work, a\nnew allocated object is returned so  GlobalScope.get() will never return null.\n\nContext.initStandardObjects will create __globalScope property in the scope\nobject when explicitly passed scope is not an instance of GlobalScope. Another\nway to address compatibility would be to point explicit scope prototype to a\nnew allocated GlobalScope instance, but it may bring more issues if an\napplication assumes a particular structure of its global scope prototype chain.Created attachment 130834\nPrevious fix with indentation fixesI committed the fix.Trageting as resolved against 1.5R5',?,BUG
214594,'Wrong line number for exceptions in while(condition) in compiled mode',Rhino,Compiler,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.5a) Gecko/20030718\nBuild Identifier: \n\nWhen an error occurs while evaluating the condition of a JavaScript while or\ndo...while statement, the wrong line number is printed by the resulting error\nmessage. The line number printed is that of the last statement in the while\nstatement\'s body. This only happens when using optlevel 0 or above, optlevel -1\nprints the correct line number. I also checked for and if statements, but the\nproblem is limited to while and do...while.\n\nReproducible: Always\n\nSteps to Reproduce:\nSave the following as test.js:\n\n   while (x.y.z) {\n      a = 1;\n      b = 2;\n      c = 3;\n   }\n\njava -jar js.jar -f test.js\nActual Results:  \nReferenceError: \"x\" is not defined. (.../test.js; line 4)\n\nExpected Results:  \nReferenceError: \"x\" is not defined. (.../test.js; line 1)cc\'ing Igor -Created attachment 130725\nFix: propagate line number to moved condition  in IRFcatory.createLoop\n\nThe reason for the bug is that the parser did not propagate proper line number\nfor loop condition when it converts internally the while loop to do-while with\nan initial jump to the loop end. As a result JVM byte code for the condition\nwould inherit its line number from the last loop statement. \n\nThe bug does not affect the pure interpreter since the interpreter uses dynamic\ninformation from the last line number mark and there the condition would get\nproper number from the loop as additional goto to the loop end would not affect\nthe last line number mark.\n\nTo address this the patch adds a line mark to the parse tree before the\ncondition.I committed the fix.Trageting as resolved against 1.5R5',?,BUG
214608,'HEAD regression: no more access to public members of package private classes',Rhino,Core,igor,norrisboyd,'A work related to bug 201893 made the following regression as reported by Hannes\nWallnoefer in the comments at bug 201893#c6 :\n\n\nI think there are some problems with the patch you committed. I\'m no longer able\nto invoke public methods on non-public classes. The error message I get is:\n\nTypeError: undefined is not a function.\n\nWhich may serve as clue, because it\'s not that we get a security exception when\ninvoking the method, the method is simply not there.\n\nAlso, when trying to invoke a public static method on a non-public class, I get\nthe following message:\n\norg.mozilla.javascript.EvaluatorException: Java class \"java.lang.Object\" has no\npublic instance field or method named \"foo\".CC to Hannes WallnoeferCreated attachment 128945\nJava test case to check reflection support\n\nTo test, compile X.java, make all the resulting classes available to JVM and\nrun the following Java scripts in Rhino shell:\n\nprint(Packages.X.test().str())\nprint(Packages.X.test().str2())\n\nCurrenly only the first line works properly and prints TEST but the second line\ngives instead of printing TEST2:\n\nuncaught JavaScript exception: TypeError: str2 is not a function.\n\nNote that the second line is supposed to work only if SecurityManager allows to\naccess public methods of package-private classes, but even in that situation\nthe error should be about IllegalAccessException, not about non-existing\nfunction.Created attachment 128947\nFix: allow to reflect package-private classes in JavaMembers.lookupClass\n\nThe reason for the regression is that now JavaMembers.lookupClass never\nattempts to reflect package-private classes. But this is wrong since even with\nSecirutyManager installed JVM allows to call Class.getMethos()( and returns\nlist of all public methods in the class and its super classes.\n\nThe patch removes the restrictions while making JavaMembers.lookupClass much\nsimpler.Yep, patch works well for me!I committed the patch.Now with the patch committed Rhino shell prints TEST2 for\nprint(Packages.X.test().str2()) if access permissions allows access to public\nmethods of package-private classes and when not it prints:\n\njs: \"<command>\", line 1: While attempting to call \"str2\" in class \"MyTest\"\nreceieved java.lang.IllegalAccessException\n\nwhich is expected.Marking Verified per Comment #4Targeting as resolved against 1.5R5',?,BUG
214945,'finally not executed if try empty',Rhino,Compiler,okidoky,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.3b) Gecko/20021213\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.3b) Gecko/20021213\n\n(Appologies in advance if this bug was already reported.)\n\nWhen there is no code in a try block, then the finally block is not executed.\n\nReproducible: Always\n\nSteps to Reproduce:\ntry { }\nfinally { print(123 }\n\n\nActual Results:  \n(nothing)\n\nExpected Results:  \n123\n\nI tried this with the command line \'js\', which seems to default to interprete mode.\nWhen I do js -opt 9, I get the same results, so it looks like the compiler is\nalso affected.\nIn C\'s version \'SpiderMonkey\' does appear to work, and does print the 123 message.\n\nIf I add a semicolon, it works:\njs> try { ; } finally { print(123) }\n123Created attachment 129150\nFix: optimize away empty try only if finally absent or empty\n\nThe bug is triggered by an incorrect optimization in createTryCatchFinally of\nomj/IRFactory.java where it removes all try/catch/finally as long as try is\nempty. \n\nThe patch changes that to apply optimization only if finally is empty as well. \n\n\nIn principle the case of empty try with a non-trivial finally can be replaced\nby just the finally block instead of generating full code for try/catch/finally\nsupport but IMO it does not that frequent to bother.I committed the fix*** Bug 217591 has been marked as a duplicate of this bug. ***Trageting as resolved against 1.5R5',?,BUG
215923,'too shallow search for \"this\" when calling reflected Java methods',Rhino,Core,igor,norrisboyd,'When a prototype chain contains more then one wrapped Java object obtained\nthrough Context.toObject(), Rhino uses the first Java object as Java \"this\" when\nscripts calls methods found in other objects.\n\nFor example, the following code:\n\nvar proto1 = java.lang.Integer(1);\nvar proto2 = java.lang.Boolean(false);\nproto2.__proto__ = proto1;\n\nvar o = { __proto__: proto2 };\n\nvar ok = (false == o.booleanValue());\n\nok = ok && (1 == o.intValue());\n\nprint(ok);\n\nthrows an exception when it applies () to \"o.intValue\" instead of printing\n\"true\" at the end. It happens because during evaluating of \"o.intValue()\"\nintValue is located in Integer and then it is applied to a Boolean instance.  \n\nThis is rather inconsistent since Rhino should either not to look for prototype\nchain for Java this (so o.booleanValue() should fail) or look all the whole\nprototype chain until it finds one. The first behavior is restrictive even if\nadheres better to semantics of JS function calls while the second allows to\nbuild a prototype chain of Java objects to expose all their methods in a\nconvenient way.Created attachment 129655\nFix: search protype chain until an instance of Java \"this\" class is foundI cimmitted the fixTrageting as resolved against 1.5R5',?,BUG
217257,'decodeURIComponent() produces wrong result',Rhino,Core,lmb,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.3) Gecko/20030312\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.3) Gecko/20030312\n\nUnder Rhino 1.5R4.1, decodeURIComponent() overwrites everything before the first\n\'\%\' in its result.\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java Shell\n2. js>var u = \"http\%3a\%2f\%2fmozilla\%2ffoo.html\"; decodeURIComponent(u);\n\nActual Results:  \n://mozilla/foo.html\n\nExpected Results:  \nhttp://mozilla/foo.html\n\nI have fixed this bug on my system.  The problem is in\norg.mozilla.javascript.NativeGlobal.decode(Context, String, boolean).  Here is a\ncode snippet:\n\n                if (buf == null) {\n                    // decode always compress so result can not be bigger then\n                    // str.length()\n                    buf = new char[length];\n                    str.getChars(0, k, buf, 0);\n                    bufTop = k; // <- I added this line ***\n                }cc\'ing Igor -I committed the fix. Thanks for reporting this!Trageting as resolved against 1.5R5',?,BUG
217268,'Number.toFixed() gives wrong result in 1.5R4.1',Rhino,Core,lmb,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.3) Gecko/20030312\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.3) Gecko/20030312\n\nFor certain values, Number.toFixed() gives a wrong result.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java Shell\n2. js> Number(123.223456789).toFixed(12);\nActual Results:  \n123.223456788900\n\nExpected Results:  \n123.223456789000cc\'ing Igor -I\'ve tracked it down to org.mozilla.javascript.DToA.JS_dtoa(), possibly the most\narcane and unfathomable code I\'ve ever seen.  Good luck to whoever tries to fix\nthis...For convenience, here is the corresponding code from SpiderMonkey:\nhttp://lxr.mozilla.org/mozilla/source/js/src/jsdtoa.cCreated attachment 130680\nFix for DToA.roundOff\n\nThe reason for the bug is that after cutting all trailing \'9\' DToA.roundOff\nappended to the buffer last digit plus one instead of setting the last\ncharacter to that value.I committed the fix*** Bug 217965 has been marked as a duplicate of this bug. ***Trageting as resolved against 1.5R5',?,BUG
217346,'rhino bug in hex formatting of large unsigned ints',Rhino,Core,mda,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.5a) Gecko/20030728 Mozilla Firebird/0.6.1\nBuild Identifier: Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.5a) Gecko/20030728 Mozilla Firebird/0.6.1\n\n\nIn Rhino 15R5_pre,\n(4294967286).toString(16) == \'7fffffff.?\'\n\nIn SpiderMonkey, it is \'fffffff6\'\nthis is 2^32 - 10. \n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 130643\nFix: use BigInteger to represent integer part of the number\n\nThe EcmaScript standard does not define behavior of toString(i) where i != 10 :\n\n...\n15.7.4.2 Number.prototype.toString (radix)\n\t If radix is the number 10 or undefined, then this number value is\ngiven as an argument to the ToString operator; the resulting string value is\nreturned.\n\t If radix is an integer from 2 to 36, but not 10, the result is a\nstring, the choice of which is implementation-dependent.\n...\n\nso it is possible to claim that Rhino behavior is standard-compliant. But it is\nnot very useful compliance ;).\n\nThe reason for the bug is that the current code (translated from an initial C\nimplementation) for  DToA.JS_dtobasestr assumes that the integer part of the\nnumber would always fit int which is not the case for 4294967286. The patch\nchanges the code to use BigInteger.toString(base) if integer part does not fit\nlong and use Long.toString(value, base) if it does. \n\nThe patch also adds private declaration in few places for methods used only by\nthe class itself.I committed the fix.Trageting as resolved against 1.5R5',?,BUG
217379,'rhino NullPointerException with String.prototype.replace(re, func)',Rhino,Compiler,mda,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.5a) Gecko/20030728 Mozilla Firebird/0.6.1\nBuild Identifier: Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.5a) Gecko/20030728 Mozilla Firebird/0.6.1\n\nIn Rhino 1_5R5pre,\n\n   var re = /(\\s)?/g;\n   var s = \"foo\";\n   s.replace(re, function() {return \'\'});\n\nresults in the stack trace below.\nit works in SpiderMonkey.\nof course the code above is stupid, but it is a simplified version of\nnon-stupid but more complicated code that revealed the bug to me.\n\n-mda\n\nException in thread \"main\" java.lang.NullPointerException\n at org.mozilla.javascript.regexp.ReplaceData.findReplen(RegExpImpl.java:486)\n at org.mozilla.javascript.regexp.ReplaceData.doGlobal(RegExpImpl.java:361)\n at org.mozilla.javascript.regexp.RegExpImpl.matchOrReplace(RegExpImpl.java:186)\n at org.mozilla.javascript.regexp.RegExpImpl.replace(RegExpImpl.java:105)\n at org.mozilla.javascript.NativeString.execMethod(NativeString.java:244)\n at org.mozilla.javascript.IdFunction.call(IdFunction.java:78)\n at org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1195)\n at\norg.mozilla.javascript.gen.c2.call(/Users/mda/Sites/burstproject/turds/quicktest.js:3)\n at\norg.mozilla.javascript.gen.c2.exec(/Users/mda/Sites/burstproject/turds/quicktest.js)\n at org.mozilla.javascript.Context.evaluateReader(Context.java:806)\n at org.mozilla.javascript.tools.shell.Main.evaluateReader(Main.java:363)\n at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:354)\n at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:291)\n at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:283)\n at org.mozilla.javascript.tools.shell.Main.exec(Main.java:103)\n at org.mozilla.javascript.tools.shell.Main.main(Main.java:76) \n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 130709\nFix: use undefined for not matched parenthes\n\nThe code in RegExpImpl.findReplen did not take into account that a particular\nparenthesis pair can be null if it is not captured. The patch fixes that to\nsend undefined to the replace function for that case.I committed the fix.Trageting as resolved against 1.5R5',?,BUG
217584,'feature request: Rhino: missing feature, line-number information in all thrown exceptions',Rhino,Core,merten.schumann,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.2.1) Gecko/20021130\nBuild Identifier: \n\nHello,\n\nis it possible to implement methods like ECMAError::getLineNumber() in\nother exceptions thrown by Rhino (EvaluatorException, JavaScriptException)\ntoo? That would be very helpful in debugging or in general when exceptions\nappear. I saw EvaluatorException\'s message to include\n   \"<foo>, line 14\"\nwhich means, the line-number information was known at time of throwing the\nexception. A <ex>.getLineNumber() would allow me to implement/document\na well-defined way for a user how to find out where his script crashed ...\n\n   ~Merten\n\nReproducible: Always\n\nSteps to Reproduce:\n\n\n\n\n\nI would like to help implementing this feature by myself.\nIf this is possible, feel free to give me information about how to join the project.\n\nThis is just EvaluatorException.java according to ECMAException.java ...\n\n/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n *\n * The contents of this file are subject to the Netscape Public\n * License Version 1.1 (the \"License\"); you may not use this file\n * except in compliance with the License. You may obtain a copy of\n * the License at http://www.mozilla.org/NPL/\n *\n * Software distributed under the License is distributed on an \"AS\n * IS\" basis, WITHOUT WARRANTY OF ANY KIND, either express or\n * implied. See the License for the specific language governing\n * rights and limitations under the License.\n *\n * The Original Code is Rhino code, released\n * May 6, 1999.\n *\n * The Initial Developer of the Original Code is Netscape\n * Communications Corporation.  Portions created by Netscape are\n * Copyright (C) 1997-1999 Netscape Communications Corporation. All\n * Rights Reserved.\n *\n * Contributor(s):\n * Norris Boyd\n *\n * Alternatively, the contents of this file may be used under the\n * terms of the GNU Public License (the \"GPL\"), in which case the\n * provisions of the GPL are applicable instead of those above.\n * If you wish to allow use of your version of this file only\n * under the terms of the GPL and not to allow others to use your\n * version of this file under the NPL, indicate your decision by\n * deleting the provisions above and replace them with the notice\n * and other provisions required by the GPL.  If you do not delete\n * the provisions above, a recipient may use your version of this\n * file under either the NPL or the GPL.\n */\npackage org.mozilla.javascript;\n\n\n/**\n * The class of exceptions thrown by the JavaScript engine.\n */\npublic class EvaluatorException extends RuntimeException\n{\n private String sourceName;\n private int lineNumber;\n private int columnNumber;\n private String lineSource;\n\n /**\n  * Create an exception with the specified detail message.\n  *\n  * Errors internal to the JavaScript engine will simply throw a\n  * RuntimeException.\n  *\n  * @param detail a message with detail about the exception\n  */\n public EvaluatorException(String detail)\n {\n  super(detail);\n }\n\n /**\n  * Create an exception with the specified detail message.\n  *\n  * Errors internal to the JavaScript engine will simply throw a\n  * RuntimeException.\n  *\n  * @param nativeError the Scriptable object constructed for this error.\n           Scripts will get it as an argument to catch statement.\n  * @param sourceName the name of the source reponsible for the error\n  * @param lineNumber the line number of the source\n  * @param columnNumber the columnNumber of the source (may be zero if\n  *                     unknown)\n  * @param lineSource the source of the line containing the error (may be\n  *                   null if unknown)\n  */\n public EvaluatorException(String detail, String sourceName, int lineNumber, int\ncolumnNumber, String lineSource)\n {\n  super(detail);\n\n  this.sourceName=sourceName;\n  this.lineNumber=lineNumber;\n  this.columnNumber=columnNumber;\n  this.lineSource=lineSource;\n }\n\n /**\n  * Get the name of the source containing the error, or null\n  * if that information is not available.\n  */\n public String getSourceName()\n {\n  return sourceName;\n }\n\n /**\n  * Returns the line number of the statement causing the error,\n  * or zero if not available.\n  */\n public int getLineNumber()\n {\n  return lineNumber;\n }\n\n /**\n  * The column number of the location of the error, or zero if unknown.\n  */\n public int getColumnNumber()\n {\n  return columnNumber;\n }\n\n /**\n  * The source of the line causing the error, or zero if unknown.\n  */\n public String getLineSource()\n {\n  return lineSource;\n }\n}\n\nOne usage in DefaultErrorReporter.java would just be\n\npublic EvaluatorException runtimeError(String message, String sourceName,\n int line, String lineSource, int lineOffset)\n{\n return new EvaluatorException(generateErrorMessage(message, sourceName, line),\nsourceName, line, lineOffset, lineSource);\n}cc\'ing Igor -Created attachment 130589\nExtending JavaScriprException and EvaluatorException to include sourcefile/line information.\n\nThe patch extends Merten Schumann suggestion to cover EvaluatorException and\nJavaScriptException cases.\n\nNow all JavaScriptException are constructed with proper source file and line\ninformation and the only place where EvaluatorException is constructed without\nit is ScriptRuntime.throwAsUncheckedException where WrappedException (a\nsubclass of EvaluatorException) is created. But that is fine as the method is\ncalled to wrap reflection exceptions mostly and they are comming not from Rhino\nbut user-suplied Java functions.Merten Schumann wrote:\n\n> I would like to help implementing this feature by myself.\n> If this is possible, feel free to give me information about how to join the \n> project.\n\nIt is easy: just start sending patches (unified format is preferable) to Norris\nBoyd or preferably put them into bugzilla.\nI committed the fix. If the fix does not work, the bug can be reopened.I will get the latest drop next week and tryout the new exception features.\n\nI\'ve got actually an JavaScriptException which wraps an Error thrown by\njunit.framework.Assert.assertEquals(), this will be a good try if there\'s now a\nchance to get the line information.\n\nThanx for now!Created attachment 130644\nAdditional fix: use Context.getSourcePositionFromStack() to get source information in EvaluatorException(String detail) constructor\n\nThe initial patch would not allow to get script line that triggered\njunit.framework.Assert.assertEquals() since in Rhino CVS tip\nJavaScriptException is used to represent ONLY exceptions thrown by scripts via\nJS throw. The errors from user-supplied Java code called via reflection would\nbe wrapped into WrappedException which extends EvaluatorException. \n\nThe additional fix covers this case and would initialize source name and line\nnumber of the exception object to the script line that called Java code.I committed the additional fix.Merten: when you try the latest source, if everything is OK,\nplease mark this bug \"Verified\". If not, you can reopen it.\n\nThanks!grmpf, I think I have to wait for the latest sources to appear on the ftp server\n\nI cannot use cvs here at my place, the ugly firewall beast prevents it\nI don\'t have a cvs client which supports HTTP proxy or so.YEAH, IT WORKS! :-) (finally I got CVS running through the firewall)\n\nThere\'s now in almost every situations at least the line number information in\nJavaScriptException and WrappedException, that\'s very very useful.\n\nIgor, many thanx for adding this feature!\n\n   MertenJust a small correction is needed in JavaScriptException IMHO\n\nThe constructor should look like\n\n    public JavaScriptException(Object value, String sourceName, int lineNumber)\n    {\n        super(ScriptRuntime.toString(value));\n        this.value = value;\n        this.lineNumber = lineNumber;\n        this.sourceName = sourceName;\n    }\n\nThe lineNumber/sourceName assignments were missing ...\n\n   ~MertenThe correction from Merten Schumann is committed, thanks!Trageting as resolved against 1.5R5Looks like there will be Rhino 1.5R5 available soon, that would be nice. :)\n\nThanx again for implementing this feature!',?,RFE
217951,'instruction count reset during a call bytecode',Rhino,Core,bugzilla,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\nBuild Identifier: \n\nIn org.mozilla.javascript.Interpreter.interpret(...), the instruction count \ngets reset during the processing of Token.CALL bytecodes. I\'m not sure if this \nbehavior is intentional, but it differs from the behavior of the \nIcode_CALLSPECIAL bytecode. \n\nIn any case, I think the solution is to remove line 2322:\n\n   cx.instructionCount = instructionCount;\n\nwhich does not appear in the handler for the similar Icode_CALLSPECIAL bytecode.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Create a Context that observes the instruction counts\n2. run some Javascript code in an infinite loop that calls a function\n\nActual Results:  \nContext.observeInstructionCount() never gets called\n\n\nExpected Results:  \nContext.observeInstructionCount() should get called occasionallyCreated attachment 130714\nFix: removing instruction counter reset as suggested.I committed the fix.Rubber-stamp vrfy -Trageting as resolved against 1.5R5',?,BUG
218163,'Simple properties not handled correctly',Rhino,Core,njouve,norrisboyd,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1) Opera 7.11  [en]\nBuild Identifier: \n\nWhen you script a java bean, you cannot acces the bean properties for whom there \nare multiple methods having the name of the getter.\nFor instance if a bean has the property \"name\" and an additional getName(Locale \nlocale) method, the \"name\" property won\'t be available when scripting the bean \nusing Rhino.\n\nReproducible: Always\n\nSteps to Reproduce:\nHere is a TestCase exhibiting the problem:\n\npackage org.mozilla.javascript;\n\nimport java.io.StringReader;\nimport java.util.Locale;\n\nimport junit.framework.Assert;\nimport junit.framework.TestCase;\n\n/**\n *\n * Tests Case\n * \n * @author njouve\n * @since 3 sept. 03\n * \n * $Log$\n */\npublic class TestPropertyWithMultipleGetters extends TestCase {\n\n    /**\n     * Constructor for TestPropertyWithMultipleGetters.\n     * @param arg0\n     */\n    public TestPropertyWithMultipleGetters(String testName) {\n        super(testName);\n    }\n\n    /**\n     * Tests that a bean with a getter having an overloaded version \n     *\n     */\n    public void testPropertyHandlingWithMultipleGetters() {\n        try {\n            String propertyValueToSet = \"John Doe\";\n            Context ctx = new Context();\n            ctx = Context.enter(ctx);\n\n            Script script = ctx.compileReader(null, new StringReader(\"this.\nname=\\\"\" + propertyValueToSet + \"\\\"\"), \"\", 0, \"\");\n\n            TestBean testBean = new TestBean();\n\n            Scriptable thisObject = new WrapFactory().wrapNewObject(ctx, null, \ntestBean);\n\n            script.exec(ctx, thisObject);\n\n            Assert.assertEquals(propertyValueToSet, testBean.getName());\n        } catch (EvaluatorException e) {\n            e.printStackTrace();\n            fail(\"Expression should have been correctly evaluated\" + e.\ngetMessage());\n        } catch (Exception e) {\n            e.printStackTrace();\n            fail(e.getMessage());\n        }\n    }\n\n    /**\n     * This class is a bean that has a \"name\" property and an\n     * additional method having the same name as the getter but with an \nadditional\n     * parameter\n     * \n     *\n     * \n     * @author njouve\n     * @since 3 sept. 03\n     * \n     * $Log$\n     */\n    public static class TestBean {\n\n        public TestBean() {\n        }\n\n        private String name = null;\n        /**\n         * @return\n         */\n        public String getName() {\n            return name;\n        }\n\n        /**\n         * @param string\n         */\n        public void setName(String string) {\n            name = string;\n        }\n\n        /**\n         * @return\n         */\n        public String getName(Locale locale) {\n            return null;\n        }\n\n    }\n\n}\n\nActual Results:  \nThis test will fail with the current version, because an EvaluatorException is \nthrown when accessing the \"name\" property from javascript.\n\nExpected Results:  \nThe test should succeed, that is no exception should be thrown\n\nI \'ve found the offending lines in the core and I\'d like to sublit the \ncorrection.\nthe offending class is org.mozilla.javascript.JavaMembers\n\n -- Line 398 -- \n\n // Grab and inspect the getter method; does it have an empty parameter list,\n// with a return value (eg. a getSomething() or isSomething())?\nClass[] params;\nMethod[] getMethods = getJavaMethod.getMethods();\nClass type;\nif (getMethods != null &&\n    getMethods.length == 1 &&\n    (type = getMethods[0].getReturnType()) != null &&\n    (params = getMethods[0].getParameterTypes()) != null &&\n    params.length == 0)\n{\n\nIt should be replaced by :\n\n// Grab and inspect the getter method; does it have an empty parameter list,\n// with a return value (eg. a getSomething() or isSomething())?\nClass[] params;\nMethod[] getMethods = getJavaMethod.getMethods();\nClass type = null;\n// test each method in the set to found the only one having no parameter\nfor (int methodIdx = 0; methodIdx < getMethods.length; methodIdx++) {\n    Method testedMethod = getMethods[methodIdx];\n    if ((testedMethod.getReturnType() != null) &&\n\t(testedMethod.getParameterTypes() != null) &&\n\t(testedMethod.getParameterTypes().length == 0)) {\n\t    type = testedMethod.getReturnType();  \n\t    params = testedMethod.getParameterTypes();                          \n\t}\n\t\n}\nif (type != null)\n{Created attachment 130808\nThis is the TestCase showing the bugCreated attachment 130809\nThis is the modified version of the JavaMembers class that fixes the bugNicolas, could you provide a patch against CVS tip as JavaMembers there changed\ncompared with Rhino 1.5R4.* ?Created attachment 130896\nPatch for JavaMembers \n\ncvs diff against latest version of JavaMembers (1.40 at time of writing)Few notes for the above patch:\n\ndiff -r1.40 JavaMembers.java\n\nThis diff generates a patch in the default format but patches in unified format\nare more readable and resilient to source changes. Please use cvs diff -u\nor even \ncvs diff -U 5 \nto generate them.\n\n>            if ((method.argTypes != null) && (method.argTypes.length == 0)) {\nThe check (method.argTypes != null) is redundant here since it always holds even\nfor 0-arity methods.\n\n>                    if (method.argTypes.length == 0) {\nThis check is also redundant since it is already covered by the previous if.Created attachment 130948\nRe-written patch (with redundant checks removed) in unified format\n\nRedundant checks removed.\nUnified formatI committed Nicolas patch with some formating changes to make code to fit 80 colons.*** Bug 142100 has been marked as a duplicate of this bug. ***Trageting as resolved against 1.5R5',?,BUG
218440,'Compiled scripts should not contain references to scope',Rhino,Core,igor,norrisboyd,'Currently in Rhino a Script object generated by the the interpreter contain a\nreference to scope object as long as there is at least one regular expression\npresent in the script. It prevents the original scope from garbage collection if\nscript is executed against a new scope and can wrong references to be used when\nusing regular expressions. \n\nThe optimizer does not have this problem since it creates regexp objects during\nscript execution.Created attachment 130962\nTest case executing a script returning regexp literal twiceCreated attachment 131008\nAccess to scope independent compiled form of regexp\n\nOne way to fix the problem is to implement the optimizer logic in the\ninterpreter as well when regular expression is compiled when a function is\ncreated or when a script is executed. But it would mean that regexps are\nrecompiled each time script is executed. \n\nA better way would be to have an option to create scope-independent compiled\nregexp presentation and then wrap it into a Scriptable when a function is\ncreated and this is what the patch addresses. It splits newRegExp from\nRegExpProxy into compileRegExp and wrapRegExp where compileRegExp creates a\nself-contained object that does not have any references to scope and wrapRegExp\ngenerates a Scriptable wrap for it.Created attachment 131019\nFix: store only only compiled regexps in InterpretedScript \n\nThe patch is an extension of the previous fix which dresses compiled regexps\ninto Scriptable clothes only during script execution and function construction\nso InterpretedScript has no reference to scope.Created attachment 131030\nOptimizer changes: store compiled regexps in static variables\n\nSince compiled regexps is self-contained object, storing them as static fields\nin a generated class would not cause any memory leaks even if the generated\nclasses are produced by JS compiler and used as a part of an application. \n\nThis patch extends the previous one to include this optimization as well so\nregexp literals are compiled only once while their Scriptable wrappers are\ngenerated during function construction or script execution.I committed the fixTrageting as resolved against 1.5R5',?,DESIGN_DEFECT
219055,'Delay creation of script object for EcmaError until execution of script catch',Rhino,Core,igor,igor,'Currently Rhino always creates script object representing EcmaError for each\nEcmaError it throws.  But such object is only necessary if script contains a\ncatch statements that catches the exception. Moreover, if creation of such\nobject throws an exception on its own which is quite possible if script mutates\nError constructors, then Java application will get the secondary exception which\nis rather inconvenient.\n\nIn addition, such delayed creation of script object would allow to simplify\ninternal API since it removes need to pass a scope object argument if such\nobject currently is only necessary to construct script error instances.  Such\nsituation is present currently in code that implements script compilation and\nvarious ScriptRuntime routines.Created attachment 131344\nImplementation\n\nThe essential patch part moves creation of script object represented by\nNativeError to ScriptRuntime.getCatchObject and modifies EcmaError constructor\nto take explicit error name and message that will be used when constructing\nNativeError. The old form is preserved for compatibility but marked as\ndeprecated. \n\nThe rest of the patch updates code not to pass scope argument when throwing\nEcmaError instances which allowed to simplify many usages of the error related\nroutines. In addition patch moved functions to create EcmaError instances from\nNativeGlobal to ScriptRuntime to remove dependence on that class from optimizer\nand regexps packages which could allow at some point in future (probably a\ndistant point due to backward compatibility) to make the class package private.I committed the changes.Rubber-stamp vrfyTrageting as resolved against 1.5R5',?,IMPROVEMENT
220362,'= 0)',Rhino,Core,hannesw,igor,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.4) Gecko/20030624\nBuild Identifier: \n\nWhen a local function is compiled with both dynamic scope and opt-level >= 0, it\nonly keeps its local scope as long as execution stays within that local scope.\nOnce execution leaves the local scope, the function loses it.\n\nAs soon as either compileFunctionsWithDynamicScope is set to false or the\noptimization level is set to -1 on the Context, the function keeps the scope in\nwhich it was defined.\n\nThe following script reproduces the problem (I\'m also adding it as attachment)\n\n// creates a local function and calls it immediately\nfunction a() {\n  var x = \"A\";\n  var f = function() {\n    java.lang.System.err.println(x);\n  }\n  f();\n}\n\n// creates and returns a local function\nfunction b() {\n  var x = \"B\";\n  var f = function() {\n    java.lang.System.err.println(x);\n  }\n  return f;\n}\n\n\na(); // works\nvar f = b();\nf(); // doesn\'t work\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Run the attached script with optLevel >= 0 and\ncompileFunctionsWithDynamicScope = true.\n\nActual Results:  \nA\njs: \"/home/hannes/cvs/adele/apps/antville/global/Aspects.js\", line 14: uncaught\nJavaScript exception: ReferenceError: \"x\" is not defined.\n(/home/hannes/cvs/adele/apps/antville/global/Aspects.js; line 14)\n\nExpected Results:  \nA\nBCreated attachment 132193\ntestcase\n\nreproduces the bug when compiled with dynamic scopes and opt-level >= 0.The reason for the bug is that the optimizer did not check when appliing dynamic\nscope if a function is a nested one or is under the with block as the\ninterpreter does. I will fix that.Testcase added to JS test suite:\n\n      mozilla/js/tests/js1_5/Scope/regress-220362.jsCreated attachment 132315\nFix: ignore dynamic scope for nested functions and functions declared within the with statement.\n\nThe patch makes optimizer to behave in the same way as the interpreter does\nwith regard to dynamic scope: it ignores it for nested functions and functions\ndeclared under with statements. Now parser checks for such functions and set\nnew flag itsIgnoreDynamicScope in FunctionNode. The flag then checked both by\ninterpreter and optimizer during byte code generation.\n\nThe patch also changes slightly interaction between changing dynamic scope flag\nand interpreted Script instances. Currently the dynamic flag is read during\nscript execution but patch changes interpreter to behave exactly as the\noptimizer does: the dynamic flag only affect script compilation, changes in its\nvalue does not affect already compiled scripts.I committed the fix.Hannes, could you verify this bug for me? If it\'s fixed now, please\nmark this bug as \"Verified\". If not, you can reopen it; thanks -Thanks for the quick fix, and sorry for not testing it earlier (I\'m in the\nprocess of moving house).\n\nMy test-script is working correctly now in all settings, so the bug is fixed and\nI\'m marking it as verified. \n\nI noticed another problem, though. Local functions are now always compiled with\nstatic local scope, which is right. However, the dynamic scope is completely\nleft out. I have variables set in the dynamic scope which script  writers expect\nthem to be there - and rightly so, since they shouldn\'t have to care about scope\nimlementation internals. So I think the right layering of scopes in local\nfunctions would be:\n\n   local scope\n   dynamic scope\n   shared scope\n\nBasically, the dynamic scope would have to be squeezed in between the local and\nthe shared scope. I don\'t know enough about dynamic scope implementation to be\nable to tell how hard this would be to implement, but I\'d be willing to dig into\nit once I\'m back in the office. Regarding nested function scoping: are you sure that nested functions can not\naccess variables from denamic (or caller scope)? If so, do you have the same\nbehavior with interpreter and optimizer? A nested functions has the activation\nobject of its parent function as its scope and that activation object should\nhave the caller scope as its parent when dynamic scoping is on.\n\nNote that compilation phase does not create any function instances, it just\ntranslates JS source into either internal or JVM bytecode and makes it ready for\nexecution. Function instances are created during script execution and only at\nthis point scope comes into play.\n\nI also curious why do you need to use dynamic scope at all? \n\n\nNested functionIgor, sorry for my previous comment, and for not getting back to this earlier.\nIn fact, things are working correctly now. I must have mixed something up back\nthen. Thanks for the good work!*** Bug 229244 has been marked as a duplicate of this bug. ***Trageting as resolved against 1.5R5',?,BUG
220367,'NPE when accessing RegExp.$1 after matching /(a)|(b)/ against \"b\"',Rhino,Core,igor,igor,'The following script gives NullPointerException:\n\nvar regEx = /(a)|(b)/;\nvar t = regEx.test( \'b\');\nprint( \"RegExp.$1: \'\"+RegExp.$1+\"\'\");\n\nThe script should print instead:\n\nRegExp.$1: \'\'\n\nIn general NPE happens whenever after successful match one accesses a captured\ngroup that was not captured as one of the branches of |.Created attachment 132195\nFix: if in RegExpImpl.getParenSubString parens.get(i) is null, return emptySubstring\n\nIf a branch of | with capturing () does not match , then RegExpImpl.parens will\ncontain null for corresponding $<group-number> according to code in\nNativeRegExp.executeRegExp(). The current code does not check for a possible\nnull in RegExpImpl.parens when calling toString and the patch fixes that by\nmaking sure that getParenSubString return SubString.emptySubString in such\ncases.Testcases added to JS testsuite:\n\n  mozilla/js/tests/ecma_3/RegExp/regress-220367-001.js\n  mozilla/js/tests/ecma_3/RegExp/regress-220367-002.js\n\nThe first one checks only the match array |str.match(regEx)|;\nthe second one checks the global properties |RegExp.$1|, |RegExp.$2|.\nAs Igor reported, the second one crashes in the current Rhino shell.I committed the fixWith the fix, no longer crash on js/tests/ecma_3/RegExp/regress-220367-002.js.\nHowever, we\'re getting a discrepancy in Section 3 of the test:\n\n\n         Testcase ecma_3/RegExp/regress-220367-002.js failed:\n         Failure messages were: \n         Section 3 of test -\n         Expected value \'\', Actual value \'a\'\n\n\nFor convenience, here is the body of the test:\n\nvar re = /(a)|(b)/;\n\nre.test(\'a\');\n  status = inSection(1);\n  actual = RegExp.$1;\n  expect = \'a\';\n  addThis();\n\n  status = inSection(2);\n  actual = RegExp.$2;\n  expect = \'\';\n  addThis();\n\nre.test(\'b\');\n  status = inSection(3);\n  actual = RegExp.$1;\n  expect = \'\';\n  addThis();\n\n  status = inSection(4);\n  actual = RegExp.$2;\n  expect = \'b\';\n  addThis();\n\n\n\nFor some reason, Rhino is not clearing out the value of RegExp.$1\nIt continues to hold the value \'a\' from the previous re.test(). \n\nThis differs from both SpiderMonkey and IE6, as can be seen via\nthe following javascript: URL\n\njavascript: var msg = \'\'; var re = /(a)|(b)/; re.test(\'a\'); msg += \'$1= \' +\nRegExp.$1 + \'\\n\' +  \'$2= \' +  RegExp.$2 + \'\\n\\n\\n\'; re.test(\'b\'); msg +=  \'$1= \'\n+ RegExp.$1 + \'\\n\' +  \'$2= \' + RegExp.$2; alert(msg);Still getting the test failure mentioned in Comment #4 -reopening after wrong click on fixed buttonCreated attachment 137008\nFix: use Java array to store parenthesis results \n\nIn the patch I replaced parens array in RegExpImpl from ObjArray to SubString[]\nsince reuse of parens that ObjArray provides does not justify complexity of\ncode to clean up it. The problem with old version was missed reset of initial\nelements before calling ObjArray.setSize which was responsible for keeping the\nold elements.Fixing for realTrageting as resolved against 1.5R5',?,BUG
220584,'Script() result has no prototype and scope chains',Rhino,Core,igor,igor,'When Script object is called as a function, its result does not have properly\ninitialized prototype and scope chains so various Script.prototype methods\nincluding toString does not work.\n\nFor example, calling \nvar s = Script(\"1;\");\nprint(s.__proto__ != null)\nprint(s.__parent__ != null)\nprint(s)\n\ngives \nfalse\nfalse\njs: \"<command>\", line 3: uncaught JavaScript exception:\njava.lang.RuntimeException: org.mozilla.javascript.PropertyException:\nConstructor for \"TypeError\" not found.\n\ninstead of expected: \ntrue\ntrue\n\n1;\n\nThis is a semi-regression in rhino CVS compared with Rhino 1.5 Release 4.1 since\nthere the bug is only present in the interpreter.\n\nNote that calling Script as a constructor works without any problems.The propagation of the bug into the optimizer happens during changes to make\noptimizer to generate single class when made code for Script initialization\nshared between compiler and interpreter. Created attachment 132319\nFix: initialize scope and prototype for Script instances in NativeScript.jsConstructor\n\nIf Script is called as a constructor, it will get the proper parent and\nprototype from the generic code to initialize newly constructed objects but if\nit is called as a function, then it is the responsibility of the call\nimplementation to do the job.I committed the fixTestcase added to JS testsuite:\n\n      mozilla/js/tests/js1_5/Scope/regress-220584.js\n\nBefore Igor\'s fix, failed in Rhino exactly as described above.Trageting as resolved against 1.5R5',?,BUG
222635,'Memory leak with with activated debugger support',Rhino,Core,igor,igor,'When a debugger is attached to Rhino by Context.setDebugger, then a memory leak\noccur as all local variable references are kept in memory. To test, save\nTest.java and test.js from the following attachments and then compile Test.java\nand run:\n\njava Test test.js\n\nCurrently it prints ever increasing memory usage and then exit with OutOfMemory.\n\nThis is was originally reported by Dave Russo:\n\n-------- Original Message --------\nSubject: \trhino memory leak(?) when debugger is attached\n\n\nI think I\'ve run into a memory leak in Rhino and I\'d appreciate any \nhelp/advice you can give. \n\nI\'m using Sun\'s JVM 1.4.1 on Solaris 5.8 and I\'m getting an \"out of \nmemory\" exception when I run the following script inside our application \nthat embeds Rhino 1.5R4.1:\n\n    function fread(fileName) \n    { \n        var line =\n    \"1234567890123456789012345678901234567890123456789012333333333\"; \n        var str = \"\";\n\n        for (var i = 0; i < 1000; i++) { \n            str += line + fileName; \n        }\n\n        return (str); \n    }\n\n    for (var i = 0; i < 2000; i++) fread(\"package.xml\");\n\nI\'ve tried the latest Rhino tip and get the same results. \n\nWe\'ve embedded rhino in a command line application which sets a custom \n\"debugger\" (ShellDebugger) using:\n\n    cx.setDebugger(new ShellDebugger(), new ShellDebugContext());\n\nand sets optimization level to -1 using:\n\n    cx.setOptimizationLevel(-1);\n\nWe\'re doing this because to get accurate line number information and \nstack trace information when errors occur.  ShellDebugger and \nShellDebugContext do nothing other than push and pop DebugFrame\'s from a \nstack maintained in a ShellDebugContext.  When an exception occurs we \ncan display the call stack with file and line number information.\n\nIt\'s possible that the leak is in our embedding and *not* in Rhino (if I \nrun the script above using \"java -cp js.jar \norg.mozilla.javascript.tools.Shell\" there is not a problem.)\n\nHowever, even if I remove *all* processing from ShellDebugger and \nShellDebugContext in our embedding, I get the memory exception from \nJava.  In addition, if I remove the following block (via the \"false &&\") \nfrom org.mozilla.javascript.Interpreter, I don\'t get the exception:\n\n        if (false && debuggerFrame != null) {\n            if (argsDbl != null) {\n                args = getArgsArray(args, argsDbl, argShift, argCount);\n                argShift = 0;\n                argsDbl = null;\n            }\n            if (idata.itsFunctionType != 0 && !idata.itsNeedsActivation) {\n                useActivationVars = true;\n                scope = ScriptRuntime.initVarObj(cx, scope, fnOrScript,\n                                                 thisObj, args);\n            }\n            debuggerFrame.onEnter(cx, scope, thisObj, args);\n        }\n\nIs there any possibility that Interpreter has a memory leak when the \ndebugger is attached?  Any help would be appreciated.\n\nThanks,\n\ndaveCreated attachment 133503\nJava source for a simple Rhino embedding with debugger attachedCreated attachment 133505\ntest scriptCreated attachment 133506\nFix for omg/Interpreter.java: always pop activation record on function exit if debugFrame is not null.\n\n\nThe bug is regression since Rhino 1.5R3 and caused by my code to support\ndebugging of scripts that were loaded prior the debugger was attached. That\ncode forces creation of the activation object even for functions that otherwise\noptimize it away so the debugger would see local variable. But I forgot to\nupdate the part that releases the activation record and the patch addressed\nthat.I committed the patch: Dave Russo confirmed that his problem went away.Trageting as resolved against 1.5R5',?,IMPROVEMENT
223435,'Automatic conversion of JS functions into Java interfaces',Rhino,Core,igor,igor,'It would be nice if Rhino would automatically create JavaAdapter from JavaScript\nobject when calling Java methods if corresponding Java parameter is interface.\n\nFor example, currently to add an action listener to Swing button\nSwingApplication.js example uses:\n\n    button.addActionListener(new ActionListener({\n\tactionPerformed : function() {\n\t    numClicks += 1;\n\t    label.setText(labelPrefix + numClicks);\n\t}\n    }));\n\nBut it would be much simpler to write just\n\n    button.addActionListener({\n\tactionPerformed : function() {\n\t    numClicks += 1;\n\t    label.setText(labelPrefix + numClicks);\n\t}\n    });\n\nwhich would create the adapter wrapper automatically and similarly it would be\npossible to replace\n\nframe.addWindowListener(new WindowAdapter({\n    windowClosing : function() {\n\tjava.lang.System.exit(0);\n    }\n}) );\n\nby\n\nframe.addWindowListener({\n    windowClosing : function() {\n\tjava.lang.System.exit(0);\n    }\n});\n \nYet another usability extension would be to allow to pass JS function where\ncorresponding Java type is an interface with a single method. With this\nextension the first example becomes simply:\n\n    button.addActionListener(function() {\n    \tnumClicks += 1;\n\tlabel.setText(labelPrefix + numClicks);\n    });\n\nMoreover, with such extension one would get automatic proper binding for DOM\nevent listeners. Java bindings for DOM states that event listener should\nimplement EventHandler interface which contains single handleEvent method while\nDOM bindings for ECMAScript accepts arbitrary function.Created attachment 133959\nImplementing first proposal\n\nPatch implements the first proposal: it automatically creates adapter objects\nwhen calling Java methods and when corresponding argument type is interface.Created attachment 134210\nImplementing single-method interface to function map and disabling automatic wrapper creation.\n\n\nAutomatic creation of wrapper objects is dangerous feature since the wrapper\nobject is not available to JS so if one would register a listener through:\n\nvar listener = {\n    windowClosing : function() {\n\tjava.lang.System.exit(0);\n    }\n};\n\nframe.addWindowListener(listener);\n\nthen \n \nframe.removeWindowListener(listener);\n\nwould not work since a new wrapper for the listener object would be created.\n\nThe proper implementation should somehow store the wrapper so it would be\nreused and frame.removeWindowListener(listener) would work. Under JDK 1.2\nWeakHash can be used to store the mapping but it would make dependence on JDK\n1.2 too heavy when MS JVM still should be accounted for. (In fact, I know one\ncase when Rhino is used with JDK 1.1.8 for Solaris since later JDK needs to\nmuch memory...) \n\nFor single-method interface to function map such implementation is possible\nunder restriction that only BaseFunction instances would be allowed in such\nusage so BaseFunction can store the wrapping. Since all usable cases for the\nautomatic conversion involves BaseFunction, this is not a serious restriction. \n\nFor this reasons the new patch does not have any support for automatic wrapping\nof generic JS object but just implements Java interface to JS function mapping.\nThe patch does not create the standard adapter to take advantage of the fact\nthat the glue object passed to Java method is not visible to JS. It allows not\nto create NativeJavaObject for the glue itself that the standard Java adapter\nwould do. Since the glue need to support only interfaces, the patch uses\nspecial IFGlue class as a base for all generated code to minimize amount of\ngenerated code.\n\nIn addition, patch adds optimization to the current adapter code to remove\ncalling Context.enter/Context.exit when converting Java to JS arguments for\neach non-primitive type since the conversion can be done when Context instance\nis obtained for calling the function itself.Created attachment 134266\nUpdated patch: fixing wrong code generation for the glue class, updating documentation to refer to new facility and making function to interface conversion preferable.\n\nTo allow to write:\n\nvar t = java.lang.Thread(function f() { .... } )\n\nto mean to create a thread that will call f() in its run method and not create\nThread named by f.toString() the patch update makes conversion\nfunction->interface to weight 1 if interface contains single method.Changing the title:\n\nAutomatic conversion of JS object into JavaAdapter extending/implementing\narbitrary Java class would be sugar that is very easy to misuse. My initial\nintention was to have something that allow to simplify JS implementation of\nevent listening code in JS and the committed part took care about common case of\ninterfaces with single method. But in the rest of useful cases event listening\ninterfaces would have multiple methods with exactly the same signature like\nWindowListener, MouseListener etc. tand it is sufficient to provide sugar only\nfor this case.\n\nThus the idea would be allow to pass JS function to Java method not only when\ncorresponding Java type is an interface with single method but also for\ninterfaces with several methods with exactly the same signature. To distinguish\nbetween methods in JS the glue code would append method name as the last\nparameter. Since the signature for all methods are the same, the position of\nthis last parameter would be the same as well and one could write:\n\nframe.addWindowListener(function(event, methodName) {\n    if (methodName == \"windowClosing\") {\n        java.lang.System.exit(0);\n    }\n});\nCreated attachment 144564\nPass methodName as the last parameter\n\nThe patch changes the current glue code to pass the name of the called\ninterface method as the last parameter to JS function.\n\nThis is useful for debugging, for example, even without extending the\nconversion to interfaces with multiple methods with the same signature.Created attachment 144596\nImplementation of the last idea: allow to convert to interfaces with more the one method \n\nThe patch checks if all additional interface methods have the same signature,\nthen the conversion is allowed and the initial JS function will be called for\neach method.I committed the last patches which allows to mark bug as fixed',?,RFE
223451,'Unescaped, unbalanced parens in a regexp should cause SyntaxError',Rhino,Core,pschwartau,igor,'Unescaped, unbalanced parens in a regexp should cause a SyntaxError.\nThe same should also be true for unescaped, unbalanced brackets or braces.\n\nThis is the Rhino version of bug 223273 against SpiderMonkey.\nThere is a testcase for this at\n\n      mozilla/js/tests/ecma_3/RegExp/regress-223273.js\n\nIt is currently failing in the Rhino shell -> The same should also be true for unescaped, unbalanced brackets or braces.\n\nYes, to be fully ECMA-compliant. However, this differs from Perl, and\nSpiderMonkey has decided to go with Perl for backward compatibility.\nRhino might wish to do the same.\n\nSee bug 223273 comment 29 and following -Changing summary:\n\nfrom: \"Unescaped, unbalanced parens in a regexp should cause SyntaxError\"\n  to: \"Allow unescaped, unbalanced parens in a regexp?\"\n\n\nThis reflects what SpiderMonkey decided to do. If Rhino wants to\nremain in sync with SpiderMonkey and Perl, it should do the same,\neven though this is not ECMA-correct.OOPS! Changing summary back to:\n\n\"Unescaped, unbalanced parens in a regexp should cause SyntaxError\"\n\n\nI got mixed up - unescaped, unbalanced parens SHOULD cause a SyntaxError.\nWhere SpiderMonkey and Perl deviate from ECMA is in the treatment of\nunescaped, unbalanced right-brackets, and braces (both left and right).\n\nThe testcase above is failing in Rhino in two different sections:\n\n1. Unescaped, unbalanced right-parens are not generating a SyntaxError.\n   They should. (Sections 2, 4 of the above test).\n\n2. Unescaped, unbalanced braces (left and right) are generating SyntaxErrors\n   They should if Rhino wants to be in sync with SpiderMonkey and Perl\n   instead of ECMA. (Sections 21-24 of the above test).Typo above:\n\n> Unescaped, unbalanced braces (left and right) are generating SyntaxErrors.\n> They should if Rhino wants to be in sync with SpiderMonkey and Perl\n\nThey should NOT if Rhino wants to be in sync with SpiderMonkey and Perl -Created attachment 136985\nCheck for unbalanced ) and fix for ArrayIndexOutOfBoundsException\n\nCheck for unbalanced \')\' is done differently then in SM since rhino uses\nrecursive version of SM code while fix for ArrayIndexOutOfBoundsException is\njust a variation of my patch for bug 227705 in SM.The above ArrayIndexOutOfBoundsException is trivially triggered in Rhino with\nthe following regexp:\n/(?/\nas in :\njs> /(?/\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\n        at org.mozilla.javascript.regexp.NativeRegExp.parseTerm(NativeRegExp.javAssigning to selfI committed the fixTrageting as resolved against 1.5R5',?,DESIGN_DEFECT
224334,'Implement __defineGetter__ and __defineSetter__ in Rhino',Rhino,Core,igor,nobody,'It would be nice if Rhino would support at least some parts of SpiderMonkey\ngetter/setter functionality.Created attachment 144563\nPass methodName as the last parameter\n\nThe patch changes the current glue code to pass the name of the called\ninterface method as the last parameter to JS function.\n\nThis is useful for debugging, for example, even without extending the\nconversion to interfaces with multiple methods with the same signature.Comment on attachment 144563\nPass methodName as the last parameter\n\nAttachment for the wrong bug...Created attachment 198032\nimplementation for __defineGetter__ and __defineSetter__\n\nThis patch implements __defineGetter__ and __defineSetter__ functions in the\nObject prototype. Implementation in ScriptableObject is analogous to Java\ngetter/setter methods, but with a ScriptedGetterSlot class that uses\no.m.j.Function as getter/setter instead of o.m.j.MemberBox.\n\nDefining getters/setters in object initializers isn\'t implemented by this patch\nas I\'m a bit scared of messing with the Rhino parsing code.Comment on attachment 198032\nimplementation for __defineGetter__ and __defineSetter__\n\nThanks for the patch, it is quite resonable besides few hotspots and the need\nto replace Function by Callable. In Rhino 1.6R2 object can be called if it\nimplements just Callable, not Function interface. In this way host objects that\nwant to allow shortcuts like matrixInstance(i, j) spared from implementing\nFunction.constructior.\n\nAnd here are hotspots:\n\n>+++ src/org/mozilla/javascript/NativeObject.java\t2005-09-30 21:04:34.417942264 +0200\n>@@ -78,6 +78,8 @@\n>@@ -182,6 +184,12 @@\n>+          case Id_defineGetter:\n>+              defineGetter((String) args[0], (Function) args[1], 0);\n>+              return Undefined.instance;\n>+          case Id_defineSetter:\n>+              defineSetter((String) args[0], (Function) args[1], 0);\n>+              return Undefined.instance;\n\nIt is always necessary to check that args[0] exist and has necessary type to\nreport proper execption. ScriptRuntime.notAFunction is your friend here.\n\n>@@ -205,6 +213,10 @@\n>                 if (c==\'h\') { X=\"hasOwnProperty\";id=Id_hasOwnProperty; }\n>                 else if (c==\'t\') { X=\"toLocaleString\";id=Id_toLocaleString; }\n>                 break L;\n>+            case 16: c=s.charAt(8);\n>+                if (c==\'G\') { X=\"__defineGetter__\";id=Id_defineGetter; }\n>+                else if (c==\'S\') { X=\"__defineSetter__\";id=Id_defineSetter; }\n>+                break L;\n>             case 20: X=\"propertyIsEnumerable\";id=Id_propertyIsEnumerable; break L;\n>             }\n>             if (X!=null && X!=s && !X.equals(s)) id = 0;\n\nUse toolsrc/org/mozilla/javascript/tools/idswitch/Main.java to generate the\nstring switch code, see\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/toolsrc/org/mozilla/javascript/t\nools/idswitch/README. (I should definitely mention that in comments to\nIdScriptableObject)\n\n>+    public void defineGetter(String propertyName, Function getter, int attributes)\n>+    {\n...\n>+        addSlot(propertyName, propertyName.hashCode(), gslot);\n\n>+    }\n>+\n>+    public void defineSetter(String propertyName, Function setter, int attributes)\n>+    {\n....\n>+        addSlot(propertyName, propertyName.hashCode(), gslot);\n>+    }\n>+\nCheck that addSlot would return gslot and report error otherwise: it can happen\nif another thread modifies the object.> Thanks for the patch, it is quite resonable besides few hotspots and the need\n> to replace Function by Callable. \n\nThanks for the feedback. I knew the patch was sloppy in parts, but wanted to\nknow if the general direction was ok. I\'ll upload a revised patch shortly.Created attachment 198303\nRevised implementation of __defineGetter__ and __defineSetter__\n\nThis patch incorporates Igor\'s suggestions. \n\nOne remaining issue: Spidermonkey throws an error when setting a property that\nonly has a getter but no setter, while this code silently ignores the setting.\nShould we emulate spidermonkey behaviour here?Created attachment 198444\nImplementation to follow SpiderMonkey as close as possible.\n\nIn SpiderMonkey one can call __defineGetter__ and __defineSetter__\narbitrary number of times in arbitrary order. In addition the\nfunctions can be applied to already created properties. Rhino should\nfollow that and here is a patch to support it.\n\nThe patch unifies native and JS getters and setters and use casts to\ncheck if getter/setter is MemeberBox or Callable. With the patch one\ncan apply native or JS getters/setters in arbitrary order and even mix\nthem. That required to move optional delegate parameter for native\ngetter/setters to MemberBox.\n\nAs a consequence of the changes the usage of native\ngetters/setters is more strict. In particular the patch always passes\nthisObj as \"this\" for native methods without delegation where the\ncurrent code tries to search the prototype chain. But that usage is\nundocumented and was a leftover from times when Rhino used reflection\nto implement the runtime library and that search was necessary due to\nhacks in other places. With the patch the rules for all\ngetters/setters are the same.\n\nAnother undocumented feature removed by the patch is an option for setter to\ndeclare non-void return type which marks it as one-time initialization\nmethod. The current code uses it to implement lazy initialization of\nglobal properties.\n\nWith multiple defineGetter/defineSetter the semantics of the feature\nis no longer clear. For example, what should happen if one changes\ngetter for the property? Or what should happen if another thread\nchange the setter when initializer runs? Not to answer such questions I\nsimply removed the feature and instead added explicit support for\nLazilyLoadedCtor to ScriptableObject.Created attachment 198640\nNo more slot replaces\n\nThe previous version of the patch uses replacement Slot->GetterSlot to get room\nto store getter/setter. Although it works for this particular case, it would\nprevent for subclasses to implement their own slot search algorithms. The\nlatter is essential if we want to allow to use __defineGetter__ with array\nindexes and properties managed through IdScriptableObject. For example,\ncurrently the following would not define getter for array[0] and Math.sin since\nthe corresponding values are managed outside of ScriptableObject:\n\narray = [];\narray.__defineGetter__(0, function() { return  0; });\nMath.__defineGetter__(\'sin\', function() { return  0; });\n\nTo support this my current idea is to allow ScriptableObject subclasses to\nsupply there own Slot implementations which ScriptableObject would use to\nproperly store getters/setters. But that requires for Slot class to store\ngetter/setter itself and this is what this version of the patch does. \n\nTo avoid wasting memory for unused getter/setter the patch adds SlotExtra class\nwhich stores attributes together with getter and setter. When getter/setter are\nnull, the attributes objects are shared, so there is no memory increase\ncompared with the previous version and the extra object is created only when\none wants getter/setter.This patch doesn\'t include changes to allow Rhino to parse JavaScript files with getter and setter methods, correct? I am working on a project right now, and I\'m trying to modify Rhino to not throw syntax errors when someone uses the \"get propertyName() { },\" syntax in JS files. I just wanted to make sure this doesn\'t already do it (which it doesn\'t look like it does).Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433The most current patch causes at least one regression when applied to 1.6R4.  I haven\'t been able to figure out exactly where or why yet but it causes the following:\n\nvar a = [];\na.push(\"foo\");\n\nprint(a.length); // prints 1\nprint(a[0]); // prints undefined\nprint(typeof(a[0]) == \"undefined\"); // prints trueThe second-to-last patch dated 4-Oct-2005 does not contain the same regressions as the last patch.  The last patch has all the SlotExtra business that is complex enough that I was unable to get to the bottom of the issue.\n\nI can confirm that having run the full test suite against both an unpatched 1.6R4 and a patched version using the 4-Oct-2005 patch that several extra tests pass, including two of the js1_5/GetSet tests and a few miscellaneous tests that rely on the __defineXetter__ methods to be present (notably related to garbage collection).\n\nThus I would recommend committing the 4-Oct patch on the trunk.(In reply to comment #12)\n> Thus I would recommend committing the 4-Oct patch on the trunk.\n\nWell, I am surprised that the patch did not cause any regressions. As far as I can remember I had more trust in the last version. In any case, it seems my desire to spend a weekend or two on hacking  Rhino to close bugs like this would not realize. There are too much other things to do. So feel free to commit whatever that works. I tried to change the title of this bug to limit it to __defineGetter__ and __defineSetter__, which are implemented by the patch discussed.  There are other things that are not (changes to the parser to support \"get\" and \"set,\" __lookupGetter__ and __lookupSetter__) but this is a partial start.  So we could close this issue, commit the patch, and open new issues for the other aspects of this topic.  Or not; that\'s just my suggestion. :)  Anyway, I have insufficient privileges to change the title.I have committed a fix based on the second-to-last patch (attachment #198444).  (The patch was modified in part to deal with bug #359411.)  I\'ve tested it using my version of the test suite (see bug #353501) and gotten the following results:\n\nFixed (13): e4x/Regress/regress-354151-01.js, e4x/Regress/regress-354151-02.js, js1_5/Array/regress-315509-02.js, js1_5/GC/regress-311792-01.js, js1_5/GC/regress-311792-02.js, js1_5/GC/regress-312278.js, js1_5/GC/regress-313763.js, js1_5/GC/regress-325269.js, js1_5/GetSet/getset-004.js, js1_5/GetSet/getset-005.js, js1_5/GetSet/regress-366396.js, js1_5/Regress/regress-366288.js, js1_5/Regress/regress-366292.js\n\nRegressions (7): ecma/Expressions/11.10-2.js, ecma/Expressions/11.10-3.js, js1_5/Array/regress-99120-02.js, js1_5/GC/regress-203278-3.js, js1_5/Regress/regress-256501.js, js1_5/String/regress-314890.js, js1_5/String/regress-322772.js\n\nHowever, all 7 \"regressions\" went away when increasing the timeout-per-test to 10 seconds from 2 seconds, and results in previous runs varied, so I am satisfied this patch is working.\n\nI would like to change the title of this bug to \"implement __defineGetter__ and __defineSetter__\" and open a new bug regarding __lookupGetter__ and __lookupSetter__ and perhaps a third bug with the get and set keywords, but I lack the privileges to do that.  So I will leave this bug open, but it\'s partially fixed. :)I am closing this bug and have opened bug 368453 for __lookupGetter__ and __lookupSetter and bug 368455 for the \"get\" and \"set\" forms of this in object initializers.  If you\'re interested in this bug you might also be interested in bug 368452 (implement __noSuchMethod__).Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
225366,'Regexp pattern /[A]/i not matching \'a\'',Rhino,Core,pschwartau,igor,'This is the Rhino analogue of bug 225343 against SpiderMonkey:\n\njs> \'a\'.match(/[a]/i);\na                      <----------------------- correct\n\njs> \'a\'.match(/[A]/i);\nnull                   <----------------------- bug\n\n\n\nThe testcase for this bug is:\n\n      mozilla/js/tests/ecma_3/RegExp/regress-225343.jsCreated attachment 136896\nFix: Java version of Brendan\'s patch\n\nThis is pretty straightforward translation into Java of patch from attachment\n135748 .Assigning to selfI committed the patchMarking Verified FIXED. \n\nThe above testcase now passes in Rhino (interpreted and compiled mode) -Trageting as resolved against 1.5R5',?,BUG
225465,'Support for Object.prototype.toSource() and uneval()',Rhino,Core,igor,igor,'It would be nice if Rhino would support Object.prototype.toSource() and uneval()\nas defined in SpiderMonkey.Created attachment 135329\nImplementation\n\nThe patch follows SpiderMonkey semantics with regarding to toSource/uneval and\npasses the following tests that currently excluded from the test suite for\nRhino:\n\n#toSource tests\njs1_5/Regress/regress-44009.js\njs1_5/Object/regress-90596-001.js\njs1_5/Object/regress-96284-001.js\n\n#uneval tests\njs1_5/Object/regress-90596-002.js\njs1_5/Object/regress-96284-002.js\n\n\nThe implementation adds new method to ScriptableObject:\n\nprotected String toSourceImplementation(Context cx, Scriptable scope)\n\nwhich is called from Object.prototype.toSource() if thisObj is instance of of\nScriptableObject. If not, then toString() is used. In this way it was not\nnecessary to define separated toSource JS method in each and every standard\nobject, but rather simple overriding of toSourceImplementation was enough.\n\nIn the patch toSourceImplementation by default calls toString() and only\nNativeObject provides serialization in form of {name:value ...} so if the scope\nis not a subclass of NativeObject (which is the case of Rhino shell), then\nexecuting\n\nvar x = 1;\nprint(toSource())\n\nwould give [object global] rather then ({x:1}) as happens in SM.\n\nPerhaps it would make sense to follow SM in this area as well.Created attachment 135396\nuneval(-0) => -0 and someFunction.toSource(0) == someFunction.toSource(0)\n\nIn this version of the patch I changed toSourceImplementation(Context,\nScriptable scope) into toSource(Context, Scriptable scope, Object[] args) so\nBaseFunction can override toSource and get access to the original JS arguments\nand be fully on pair with SpiderMonkey:\n\nRhino 1.5 release 5 0000 00 00\njs> function f() { return 1; }\njs> print(f.toSource())\nfunction f() {return 1;}\njs> print(f.toSource(0))\n\nfunction f() {\n    return 1;\n}\n\njs> print(f.toSource(10))\n\n\t  function f() {\n\t      return 1;\n\t  }Created attachment 135407\nScriptableObject.toSource defaults to ({}) form\n\nI changed ScriptableObject.toSource not to return toString() but rather produce\n({}) form of enumeratable properties since in this way uneval would produce by\ndefault syntactically correct JS.I committed the latest patchCreated attachment 135413\nNo need to skip toSource/uneval tests in rhino-n.tests\n\nNow Rhino does not need to skip toSource/uneval tests from the test suiteIgor: thanks, I have checked in your patch for rhino-n.tests:\n\n[//d/JS_TRUNK/mozilla/js/tests] cvs ci rhino-n.tests\nChecking in rhino-n.tests;\n/cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\nnew revision: 1.56; previous revision: 1.55\ndone\n\n\nThe five tests involved now all pass in Rhino; marking Verified FIXED -Created attachment 135729\nFix to exactly match SM during nested toSource\n\nThe patch changes toSource applied for objects not to put () arround nested\nobjects so uneval({x:{y: 0}}) gives \n({x:{y:0}})\nand not \n({x:({y:0})}).\n\nIn this way Rhino matches SpiderMonkey and the test case for bug 225831 that\nrelies on a particular output of toSource() to simplify test code runs fine in\nRhino optimized mode.I committed the last fix as well.Trageting as resolved against 1.5R5',?,RFE
225817,'Support for fileName/lineNumber properties in Error objects',Rhino,Core,igor,igor,'It would be nice if Rhino would define fileName and lineNumber in error objects\nas SpiderMonkey does.Created attachment 135575\nFix to pass js1_5/Exceptions/regress-50447.js\n\nRhino CVS tip already contains code to put fileName and lineNumber properties.\nI added that code to ScriptRuntime.getCatchObject together with code to create\nJS Error objects from Java exceptions only when scripts catches exceptions. But\nit did not help to pass js1_5/Exceptions/regress-50447.js and the patch fixes\nthat so hopefully the patch makes Rhino matching SpiderMonkey behavior.Created attachment 135590\nFixing typo in the patch that caused js1_5/Object/regress-96284-001.js to fail\n\nThe SpiderMonkey test suite is awesome!I committed the fix, but I keep the bug open since I think it would be resonable\nto add fileName and lineNumber properties to JS objects representing caught Java\nexecptions.Created attachment 135705\nAdding fileName and lineNumber for Java execptions\n\nWith the patch when I run:\n\ntry {\n\tnull.value;\n} catch (e) {\n\tprint(format_ex(e));\n}\n\ntry {\n\tnew java.util.Vector(-1);\n} catch (e) {\n\tprint(format_ex(e));\n}\n\nfunction format_ex(e)\n{\n\treturn e.fileName+\":\"+e.lineNumber+\": \"+e.name+\": \"+e.message;\n}\n\nI get:\n\n/tmp/x.js:2: TypeError: Cannot read property \"value\" from null\n/tmp/x.js:8: JavaException: java.lang.IllegalArgumentException: Illegal\nCapacity: -1\n\nThe patch adds new exception constructor, JavaException and puts the original\njava exception as javaException property of the catch object so the following\nwould also works:\n\ntry {\n\tnew java.util.Vector(-1);\n} catch (e if JavaException) {\n\te.javaException.printStackTrace();\n}I commiteed the last patch.Created attachment 135706\nPatch to remove skipping of js1_5/Exceptions/regress-50447.js from test suite\n\nWith the patches committed the test cases passes fully OK.Thanks, Igor. Patch checked in for rhino-n.tests:\n\n[//d/JS_TRUNK/mozilla/js/tests] cvs ci rhino-n.tests\nChecking in rhino-n.tests;\n/cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\nnew revision: 1.57; previous revision: 1.56\ndone\n\n\nMarking Verified FIXED. Testcase js1_5/Exceptions/regress-50447.js\nabove now passes in the Rhino shell, in compiled/interpreted modes.Trageting as resolved against 1.5R5',?,RFE
225831,'Byte code generation: using dups instead of temporaries',Rhino,Core,igor,igor,'Currently to implement operations such as x += y, ++x and object and array\nliterals, {}, [], parser in Rhino generates nodes to hold temporary values.\nInterpreter in Rhino does not support more then 256 temporaries and silently\nrecycles them if their number exceeds 256. The following test case demonstrates\nthis interpreter limitation.\n\nIn principle by changing space taken by temporary index that can be resolved but\nit seems that eliminating such temporary nodes and using various forms of dup\noperations on stack would make generated byte code smaller and faster both for\ninterpreter and optimizer.Assigning to selfCreated attachment 135601\nTest case: it fails in interpreted mode\n\nThe test evaluates string of the form  ++(a[++f().x + ++f().x + ... + ++f().x])\nthat will expose recycling of temporaries in interpreter mode when there is\nmore then 255 ++f terms.Created attachment 135602\nFirst part: no more temporaries for post ++ and --\n\n\nThis is trivial part since the patch changes IR-Factory to always creates\nToken.INC/Token.DEC nodes for post ++ and --. Previously it happens only for\nchild nodes of ++ or -- where IRFactory.hasSideEffects() returns true but the\nrest of code in Rhino both in interpreter and optimizer modes contained full\nsupport for INC/DEC applied for arbitrary complex lvalue expression. Or did I\nmiss something?Igor: thank you for this testcase! I\'ve added it to the JS testsuite:\n\n      mozilla/js/tests/js1_5/Regress/regress-225831.js\n\n\nAs Igor indicates, it currently passes in Rhino compiled mode,\nbut fails in interpreted mode:\n\n\n*-* Testcase js1_5/Regress/regress-225831.js failed:\nBug Number 225831\nSTATUS: Stressing the byte code generator\nFailure messages were:\nFAILED!: [reported from test()] Section 1 of test -\nFAILED!: [reported from test()] Expected value \'11\', Actual value \'NaN\'Created attachment 135661\nTest case extension to cover post ++, {}, and [] operations.\n\nThe patch ads 3 more sections to the test case to cover post --, {} and []\noperations. Without the first fix all sections fails, but with the fix applied\nthe session 2 testing post-- passes.Igor: thanks, I checked in the extension to the test. But note that\nSpiderMonkey doesn\'t pass Section 4. The failure looks like this:\n\nExpected value =  \'({1:({a:1}), 2:({a:1}), 3:({a:1}), 4:({a:1}),  etc.\n  Actual value =  \'({1:{a:1}, 2:{a:1}, 3:{a:1}, 4:{a:1},          etc.\n\n\n\nRhino and SpiderMonkey seem to differ on how toSource() and uneval()\ntreat objects nested inside objects:\n\njs> var obj = { prop:({a:1}) };\n\n\n---------------------------------  RHINO  -----------------------------------\njs> obj.toSource();\n({prop:({a:1})})\n\njs> uneval(obj);\n({prop:({a:1})})\n\n\n------------------------------- SPIDERMONKEY  -------------------------------\njs> obj.toSource();\n({prop:{a:1}})\n\njs> uneval(obj);\n({prop:{a:1}})\n\n\nThat is, SpiderMonkey doesn\'t put the parens around the inner object.\nWhat should we do? Is this something that SpiderMonkey should change,\nor Rhino?I will change Rhino to much SM, so the test should use the version without inner\n(). So the test would be double-edge sword to check both bytecode generation and\ntoSource().Igor: thanks. I have checked in v 1.3 of the test, without the inner ()\'s:\n\nRCS file: /cvsroot/mozilla/js/tests/js1_5/Regress/regress-225831.js,v\nretrieving revision 1.2\ndiff -r1.2 regress-225831.js\n\n106c106\n< // build string of the form ({1:({a:1}), 2:({a:1}), ... N:({a:1})})\n---\n> // build string of the form ({1:{a:1}, 2:{a:1}, ... N:{a:1}})\n\n111c111\n<     arr[i] = i+\":({a:1}), \";\n---\n>     arr[i] = i+\":{a:1}, \";\n\n113c113\n<   arr[N] = N+\":({a:1})})\";\n---\n>   arr[N] = N+\":{a:1}})\";\n\n\n[//d/JS_TRUNK/mozilla/js/tests/js1_5/Regress] cvs ci regress-225831.js\nChecking in regress-225831.js;\n/cvsroot/mozilla/js/tests/js1_5/Regress/regress-225831.js,v  <--  regress-225831.js\nnew revision: 1.3; previous revision: 1.2\ndoneI created a branch in CVS templess_bytecode_225831 to put the code for the bug\nto merge it later when ready and committed the above patch there.It turned out that usage of dups or similar stack-based constructions require\nproper maintenance of in Interpreter.itsStackDept which is not the case now. It\nis not visible since the only consequence of it is wasted stack space but that\nwill be exposed through stack-based references.Created attachment 136047\nDifferent handling of \"if\" and \"?\"\n\nOne of the reasons of stack miscalculations is that current IRFactory reuse the\ncode for \"if\" statement when generation tree for \"?\". Since then/else parts of\n\"?\" places an object to stack while then/else of \"if\" suppose to keep stack the\nsame, so effectively byte code generation end up assuming 2 additional objects\non stack, not one, for each \"?\". \n\nThe problem presents in the optimizer as well, so class files claims more stack\nspace then necessary there also.\n\nPatch handles that via using Token.HOOK for parse subtree representing \"?\" and\nadding code to interpreter/optimizer to process that properly.\n\nPatch also adds missed stack adjustments for &&, ||, __proto__ and __parent__\nin Interpreter.\n\nI will committ the patch to the branch after regression testing.Created attachment 136127\ntempless switch\n\nAnother source for stack depth miscalculations is switch code, where stack was\nnot updated to account for IF jump.  The patch resolves via using 2 new byte\ncodes, Icode_DUPSECOND duplicating stack element one below top and\nIcode_IFEQ_POP which would pop additional stack element in case of successful\njump. In this way switch condition will be popped from the stack when done.\n\nTo prevent stack miscalculations, the patch adds explicit checks for expected\nstack change during code generation. The overhead of this self checking should\nbe very low.\n\nThe patch also adds one line fix to optimizer/Codegen to release switch\nregister after code for switches is generated.Created attachment 136171\ntempless op=\n\nThe patch changes generation of code for various op= to use dup commands\ninstead of saving lvalue into temporaries and then restoring it from\ntemporaries to store assignment result. In this way more compact code is\ngenerated both for interpreter and optimizer and IRFactory code for op= is\nsimplified since it is no longer necessary to apply optimization of loading\nnumbers and strings twice instead of using temporaries as DUP is the fastest\nway to duplicate even constant values. \n\nThe price for this is the need to support 2 additional node types, SETELEM_OP\nand SETPROP_OP, but most of the code for them is shared with SETELEM and\nSETPROP so the total code bloat is not that big.Created attachment 136223\nusings dups for [] and {}\n\nThe patch changes code to generate [] and {} to use dups instead of temporaries\nto get shorter byte code both for interpreter and optimizer. With the patch the\ntest case now passes in the interpreted mode.Created attachment 136228\nremoval of unused Node.cloneNode\n\nThe previous patches removes the need to to have Node.cloneNode so the patch\nremoves it.Created attachment 136453\ntempless calls in interpreter\n\nThe patch changes interpreter not to use temporaries to calculate both function\nreference and function this for function calls. The patch moved away the code\nto transform parsing tree in NodeTrandformer and instead adds necessary logic\nto interpreter. The code is moved to the OptTransformer so optimizer still uses\nit. \nThe patch changes few special interpreter byte codes that supported function\nthis calculations to place on the stack both function reference and its this.\nIn this way byte code for calls became more compact and faster.\n\nIt seems that direct code generation from non-transformed call subtree would\nshrink generated byte code in the optimizer as well but since various\noptimizations there depends on particular transformed tree structure I left it\nas is since the optimizer handles references properlyCreated attachment 136501\ntempless enum\n\nPatch adds new parse tree node, Token.ENUM_ID, to get id string from\nenumeration object that is used to implement \"for (x in y)\". In this way code\nto generate byte code to store the result of enumNext to compare it with null\nand assign to enum counter becomes unnecessary.Created attachment 136524\ntempless catch\n\nCurrently handling of the catch statement involves creation of 2 locals per\ncatch block, one to store catch object and another to hold catch scope during\nits setup. The second usage should use temporary instead since additional\ncatch, finally or with blocks can not appear between the initial creation of\nscope and creation of with object that uses it. So effectively it is a\ntemporary and as previous patches shows it could be eliminated.\n\nThe patch just does that via changing Token.NEWSCOPE nodes into\nToken.CATCH_SCOPE since the former was used only to support catch nodes. The\nnew node is responsible for populating properly the scope objects based on the\nexception thus eliminating the last temporary usage in the Interpreter and\nsimplifying catch parsing trees substantially.Created attachment 136546\nusing temporaries, not locals, to hold intermediate results in optimizer\n\n\nThe patch changes omj/optimizer/Block.java to use temporaries instead of locals\nto hold results of common this subexpressions since in the optimizer\ntemporaries are reused while locals are not unless special measures are taken. \n\n\nSince the previous patches changes moved creation of temporaries to static\nmethod in OptTransformer, the change removed the need to pass IRFactory\ninstance around Block and FatBlock and the patch removes it.Created attachment 136597\nreuse of locals\n\nTo allow reuse of additional locals that interpreter/optimizer has to allocate\nto support try/catch/finally and for (in) patch adds new parse node node,\nToken.LOCAL_BLOCK to indicate sequence of statements that needs new local. In\nthis way simple stack-like allocation of local slots in the interpreter\nprovides locals reuse and in the optimizer the locals can be treated in the\nsame way as temporaries and does not require initial preallocation.Created attachment 136602\nCheck for local overuse\n\nThe patch adds checks in Interpreter to throw an exception if number of locals\nexceeds 256 and switch to use activation if number of variables exceeds 256. In\nthis way silent reuse of locals would be avoided and interpreter limitations\nare exposed earlier.\n\nWithout the the patch js1_5/Regress/regress-226507.js would go to infinite loop\nwhen N there is increased to 257.Created attachment 136783\nFix for bug 225831\n\nThe patch adds new parse tree node type, Token.RETURN_POPV, to return the value\nstored by the last Token.POPV and updates interpreter/optimizer to support POPV\nfor functions and the new nodes. With this it in place NodeTransformer changes\ncode to return from finally to first store via POPV the result of the original\nreturn, then execute finally and then return the stored value fixing bug\n225831.\n\nThe patch does not depend on changes to avoid using temporaries during\nexpression evaluation as I initially expected but it does depend on the change\nto use recursion of NodeTransformer which is committed on the bug branch so log\nit here.Created attachment 136784\nCumulative patch\n\nCumulative patch to merger to HEADI committed the changeVerified FIXED.\n\nThe above testcase used to fail in both the compiled and interpreted\nmodes of Rhino. Now it passes in both -*** Bug 228446 has been marked as a duplicate of this bug. ***Trageting as resolved against 1.5R5*** Bug 273745 has been marked as a duplicate of this bug. ***I don\'t really understand in which version it is fixed/will be fixed. Target\nmilestone indicates 1.5R5 but I have the problem with 1.6R1.(In reply to comment #29)\n> I don\'t really understand in which version it is fixed/will be fixed. Target\n> milestone indicates 1.5R5 but I have the problem with 1.6R1.\n\nThat was fixed in 1.5R5. What is your test case? For example, the following case\npasses for me in either 1.5R5 or 1.6R1:\n\nvar N = 600;\nvar array = new Array(N);\n\nfor (var i = 0; i != N; ++i) {\n    array[i] = \'{index: \'+i+\', name: \"foo\'+i+\'\"}\';\n}\n\nvar script_text = \"[\"+array.join(\',\\n\')+\"]\";\n\nvar script = Script(script_text);\nvar tab = script();\n\njava.lang.System.out.println(uneval(tab[N - 1]));\nI think that you\'re right. I\'m using js inside htmlunit and I thought that I had\ncorrectly changed my classpath to use version 1.6R1. Testing again it seems to\nwork fine. Sorry for trouble.',?,IMPROVEMENT
225926,'Allow unescaped braces in regexp patterns, if not part of a quantifier?',Rhino,Core,pschwartau,igor,'The following testcase fails in Rhino:\n\n      mozilla/js/tests/ecma_3/RegExp/regress-188206.js\n\n\nThe failures all occur between sections 14 and 27 of the test.\nHere are comments from the testcase on these sections:\n\n\n116 /*\n117  * Misusing the {DecmalDigits} quantifier - according to ECMA,\n118  * but not according to Perl.\n119  *\n120  * ECMA-262 Edition 3 prohibits the use of unescaped braces in\n121  * regexp patterns, unless they form part of a quantifier.\n122  *\n123  * Hovever, Perl does not prohibit this. If not used as part\n124  * of a quantifer, Perl treats braces literally.\n125  *\n126  * We decided to follow Perl on this for backward compatibility.\n127  * See http://bugzilla.mozilla.org/show_bug.cgi?id=190685.\n128  *\n129  * Therefore NONE of the following ECMA violations should generate\n130  * a SyntaxError. Note we use checkThis() instead of testThis().\n131  */\n\n\nCurrently Rhino is correctly throwing an error according to ECMA.\nBut do we want to stay in synch with SpiderMonkey on this?I will look at itCreated attachment 136898\nFix: adjusted version of Roger Lawrence patch from attachment 128343\n\nRoger made a fix for Rhino in July and added it as\nhttp://bugzilla.mozilla.org/show_bug.cgi?id=190685#c13 .\n\nIt fails to apply due to my changes to make compiled form of regular expression\nscope-independent that caused some code movements that was too complex for the\npatch utility. This is the adjusted version.CC RogerI committed the fixTrageting as resolved against 1.5R5',?,RFE
226045,'RegExp toSource/toString return an invalid empty RE',Rhino,Core,pschwartau,igor,'SpiderMonkey recently changed the behavior of toString() and toSource()\nwhen applied to a RegExp object with an empty pattern. Do we want \nRhino to stay in synch?\n\nThis is the Rhino analogue of bug 225550 against SpiderMonkey.\nThe testcases for this are:\n\n      mozilla/js/testsecma_2/RegExp/properties-001.js\n      mozilla/js/testsjs1_2/regexp/toString.js\n\n\nHere is a comparison of the current SpiderMonkey and Rhino:\n\nRHINO:\n[/] java org.mozilla.javascript.tools.shell.Main\nRhino 1.5 release 5 0000 00 00\njs> (new RegExp).toString();\n//\njs> (new RegExp).toSource();\n//\n\n\nSPIDERMONKEY:\n[//d/JS_TRUNK/mozilla/js/src/WINNT4.0_DBG.OBJ] ./js\njs>\njs> (new RegExp).toString();\n/(?:)/\njs> (new RegExp).toSource();\n/(?:)/\n\n\nThe new approach lets eval() turn this string back into the empty regexp.\nThe old approach doesn\'t work, since \"//\" is a comment, not a regexp.Oops, those tests are\n\n      mozilla/js/tests/ecma_2/RegExp/properties-001.js\n      mozilla/js/tests/js1_2/regexp/toString.jsI will fix it.Created attachment 136232\nFix for NativeRegExp.toString()I committed the fixVerified FIXED.\n\nThe above testcases used to fail in both the compiled and interpreted\nmodes of Rhino. Now they pass in both -Trageting as resolved against 1.5R5',?,BUG
226517,'Finally is executed before return expression',Rhino,Compiler,igor,igor,'Currently Rhino executes finally block before evaluating return expression. For\nexample, the following test in Rhino shell prints \"FAILED\" because finally code\nwill be executed before (return_expression_was_calculated = true) is evaluated.\n\nvar ok;\n\nfunction test() \n{\n\t\n\tvar return_expression_was_calculated = false;\n\ttry {\n\t\treturn (return_expression_was_calculated = true);\n\t} finally {\n\t\tok = return_expression_was_calculated;\n\t}\n}\n\ntest();\n\nprint(ok ? \"OK\" : \"FAILED\")I will fix it in the scope of bug 225831   \tFxed as part of bug 225831Igor\'s testcase added to JS testsuite:\n\n      mozilla/js/tests/ecma_3/Statements/regress-226517.jsVerified FIXED.\n\nThe above testcase used to fail in both the compiled and interpreted\nmodes of Rhino. Now it passes in both -Trageting as resolved against 1.5R5',?,BUG
228336,'bug with braces in JavaScript regular expressions',Rhino,Core,pschwartau,igor,'This is the Rhino version of bug 228087 against SpiderMonkey.\nThe following regexp patterns are causing SyntaxErrors:\n\njs> re = /{1.*}/g;\njs: uncaught JavaScript exception: SyntaxError: Invalid quantifier {\n\njs> re = /{1[.!}]*}/g;\njs: uncaught JavaScript exception: SyntaxError: Invalid quantifier {\n\n\nThis is correct per ECMA-262 Ed. 3, which prohibits the use of unescaped\nbraces in regexp patterns unless they form part of a quantifier.\n\nHowever, as part of the SpiderMonkey RegExp rewrite (bug 85721), it was\ndecided to follow Perl and IE, and allow unescaped braces even if they\nare not part of a quantifier.\n\nSee bug 188206 comment 12; also bug 223273 comment 29 and following.\n\nIt looks like the RegExp parser is mistakenly identifying the above\nuse of braces as quantifiers (hence the SyntaxErrors), instead of\nthe non-quantifier, literal use of unescaped braces that we permit.\n\nThe testcase for this bug is \n\n      mozilla/js/tests/ecma_3/RegExp/regress-228087.js\n\nIt is currently failing in both the SpiderMonkey and Rhino shells -I will look at itCreated attachment 139194\nFix: Perl-compatible handling of {} and overflow checks in regexps\n\nThis is a Rhino version of Brandan\'s patch from attachment 138844, bug 228087\nplus code to fix overflow problem reported in bug 230216.I committed the fixTrageting as resolved against 1.5R5',?,BUG
229571,'String.replace is much slower than in rhino 1.5.3',Rhino,Core,yaar,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nBuild Identifier: Rhino v1.5.4.1\n\nExecuting s.replace(a, b) is ten times slower than in rhino 1.5.3.\n\nNote that when a is a match inside s, then execution time is the same. But if \na isn\'t there, then the performance is ten folds slower.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nvar a = new Array();\nfor (var i=0; i<10000; i++)\n\ta[i] = \'A\';\nvar s = a.join(\'\');\n\nvar t = java.lang.System.currentTimeMillis();\n//the test:\ns = s.replace(\'BBB\', \'AAA\');\ns = s.replace(\'BBB\', \'AAA\');\ns = s.replace(\'BBB\', \'AAA\');\ns = s.replace(\'BBB\', \'AAA\');\ns = s.replace(\'BBB\', \'AAA\');\njava.lang.System.out.println(\'time: \'+(java.lang.System.currentTimeMillis()-\nt));I will look at itCreated attachment 138417\nLess calculations in inner loops in regexps\n\nIt looks like the optimization for regexps starting with literal character to\nlook first for that character actually made thinks worse probably due to too\noften recalculations of invariant conditions at the beginning of each\nNativeRegExp.executeREBytecode invocation. \n\nThe patch reorganize the code to move this recalculations outside the main loop\nin NativeRegExp.matchRegExp and this refactoring speedup matching by factor of\n10 for trivial regexps.Created attachment 138472\nPatch update\n\nI added few more inlining/refactoring to gain in speed compared with the\nprevious patch.I committed the last fixWith the last tip committed Rhino CVS is 2 times faster then 1.5R3 with the\noriginal test case.Trageting as resolved against 1.5R5',?,IMPROVEMENT
230883,'when debug internal window with is closed, it remains in \"Window\" menu windows list.',Rhino,Core,san,igor,'User-Agent:       Mozilla/5.0 (compatible; Konqueror/3.1; Linux)\nBuild Identifier: \n\nIn Rhino debugger, files being debugged are opened as a JInternalFrames, and \ntheir list is maintained internally (caches) and also they appear in Window \nmenu. When user closes the window, there\'s no handler to remove it from cache \nand from menu. \n\nReproducible: Always\n\nSteps to Reproduce:\n1. Start JS debugger (org.mozilla.javascript.debugger.Main) \n2. Open several files. Note the list of files in \"Window\" menu. \n3. Close all windows with files. \n \nActual Results:  \nIn \"Window\" menu all windows are still listed. \n\nExpected Results:  \nThere must be empty list. \n\nThe cleanup code exists, but doesn\'t get called, as it is accidentally \nremoved.Created attachment 139020\npatchThe path is resonable, I will include it after testingCreated attachment 139138\nThe version of the previous patch against CVS tip\n\nThe patch version that applies without fuzz to Rhino CVS tip.I committed the patch, thanks Alex for spotting this!Trageting as resolved against 1.5R5',?,BUG
233274,'for/in loop goes through array elements in wrong order',Rhino,Core,hannesw,igor,'User-Agent:       \nBuild Identifier: \n\nWhen an array is built using an array literal and elements are added to the\narray later on (using array[x]=y or array.push(y)), looping through it with a\nfor-in loop goes through elements in wrong order. It seems the elements added\nlater are always processed first.\n\nReproducible: Always\nSteps to Reproduce:\nRhino 1.5 release 5 0000 00 00\njs> var array = [1, 2, 3];\njs> array.push(4);\n4\njs> for (var i in array) print(i);\n\nActual Results:  \n3\n0\n1\n2\n\nExpected Results:  \n0\n1\n2\n3Reassigning to Igor (hope that\'s ok ;-)Created attachment 140752\nFix: populate ids array in NativeArray with dense indexes first\n\nSince array literals in Rhino creates instances of NativeArray with the\ninternal dense array containing literal elements, the patch changes\nNativeArray.getIds to return ids array with dense indexes coming first and\nindexes for elements added later after that.I committed the fixTrageting as resolved against 1.5R5',?,BUG
234777,'NullPointerException when accessing indexed property of null object',Rhino,Core,ejsid,norrisboyd,'User-Agent:       \nBuild Identifier: 1.5R4\n\nWhen one try to access indexed property of null object NullPointerException is \nthrown. Note that this only ocurrs when index is given as a variable, in case \nof constant index, TypeErorr is thrown correctyl.\n\nReproducible: Always\nSteps to Reproduce:\nvar nullObj = null;\nvar index = 0;\n\ntry {x = nullObj[index]} catch (e) {Packages.java.lang.System.out.println\n(\"Catched error: \" + e};\n\nActual Results:  \nYou can see beautiful stack trace :)\njava.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptableObject.getProperty\n(ScriptableObject.java:1423)\n\tat org.mozilla.javascript.ScriptRuntime.getElem(ScriptRuntime.java:969)\n\tat org.mozilla.javascript.ScriptRuntime.getElem(ScriptRuntime.java:959)\n\tat org.mozilla.javascript.Interpreter.do_getElem(Interpreter.java:2770)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2050)\n\tat org.mozilla.javascript.InterpretedScript.call\n(InterpretedScript.java:62)\n\tat org.mozilla.javascript.InterpretedScript.exec\n(InterpretedScript.java:55)\n\tat org.mozilla.javascript.Context.evaluateReader(Context.java:820)\n\nExpected Results:  \nPrint message: Cached error: TypeError: cannot convert null to object\n\nThe reason of this bug is that when indexed property is accessed via variable \nindex getElem method is called directly without LHS value checking (see \ndo_getElem). Method getElem do perform LHS (parameter obj) check with implicit \ncast check (ClassCastException catch) which cannot detect null object, which in \neffect produces mentioned above NullPointerException.This is fixed for Rhino 1.5R5, with RC1 build I have for:\n\nvar nullObj = null;\nvar index = 0;\n\ntry {x = nullObj[index]} \ncatch (e) {\n\tPackages.java.lang.System.out.println(\"Catched error: \" + e);\n}\n\n\nCatched error: TypeError: Cannot read property \"0\" from null\n',?,BUG
236108,'Relicensing Rhino under the MIT license',Rhino,Core,igor,norrisboyd,'I think this should be resolved once and for all.CC Brendan and Gervase as well:\n\nNo matter what would be the outcome of the discussion about APL and other\nlicense schemas, I think at least MPL/LGPL/GPL should be put in place. \n\nFor practical matters I would suggest to finish this work first as gven the\nprevious experience any too generic question would rsult in nothing done.\n\nSo the question is: who should authorise this?We\'re thinking of relicensing under an MIT-X style license, which means there is\nno point in multi-licensing under copyleft licenses.  It\'s a break from\nMozilla\'s licensing policy to date, but one that we would like to make for\nRhino.  So I don\'t see any point in fixing this bug as summarized.  Here is a\ncounterproposal:\n\nIgor, from the emails with Cocoon folks, it sounds like you have no objection to\nan MIT-X-style license.  The ASL (not APL, my typo, sorry) is one such and it\nfits the bill for Apache projects using Rhino.  I\'ll follow up with Mitchell to\nmake sure it\'s the right license, and wait for agreement here.\n\nThen, we need to get agreement from all the copyright holders, as discussed with\nthe cocoon folks.  This is work.\n\nOnce everyone is agreed, we can morph this bug, make a special case in Mozilla\'s\nlicensing policy documents, and get on with relicensing.  Should be soon.\n\n/beChanging title to be more generic to reflect recent discussion.Created attachment 144038\nList of Rhino contributors from Steven Noels\n\nFrom Steven Noels email:\n\nOn 12 Mar 2004, at 22:57, Brendan Eich wrote:\n\n> Our CVS logs are open and complete (http://www.mozilla.org/cvs.html).\n>\n> You need to scour the CVS logs, not only for direct checkins, but especially\nalso for people checking in patches on behalf of others who originated those\npatches, but who lacked CVS access.  Gerv (cc\'d again) knows about this from\nour experience relicensing the bulk of Mozilla\'s source code, but I don\'t know\nhow much time and motivation (if any) he has to help, especially for the Cocoon\ntine of the fork.\n\n\nFolks, before going off to think about administrative procedures (finding real,\ncurrent email addresses, how to officially record consent...), I\'d like you to\ndo a brief sanity check of my current email address harvest from the CVS logs.\n\nThe format is a bit funny (it\'s a dump of a Python list), with the first field\ncontaining the to-be-contacted email address, the second one is the guy who\nactually committed, and then some administrative data (time of commit and\ntouched file). Please check attached file if it makes sense. I did automated\nscanning for email addresses - I hope I catched most if not all. There\'s a few\nduplicates and false hits in the list as well.\n\nA quick look shows me that about 45 people should be contacted, which still\nseems feasible.\n\nOn the code-side, some small progress has already been made in assembling a\ntask force for recruting JavaScript engine hackers. Batik, another ASF project\nwhich uses Rhino (the official version, that is, not our fork) might be\ninterested in the same relicensing effort as well, since they would now be\nobliged to not include Rhino in their shipping version anymore, and only refer\nto it in their documentation. So even if the code reintegration is a bit slow\nin the beginning, there\'s an incentive for both the Cocoon and Batik project to\nhave an ASF-shippable, MIT/X-licensed Rhino in the future.\n\nOh, in order to cut down on the recipient list: I\'d like to have some main\ncontact on the Mozilla side, and am happy to keep others posted if they want -\njust tell me who and what.(In reply to comment #2)\n> Igor, from the emails with Cocoon folks, it sounds like you have no objection to\n> an MIT-X-style license.  The ASL (not APL, my typo, sorry) is one such and it\n> fits the bill for Apache projects using Rhino.  I\'ll follow up with Mitchell to\n> make sure it\'s the right license, and wait for agreement here.\n\nYes, I have no objections and any of my contributions to Rhino can be relicensed\nunder MIT-X-style license. \n\nNow what exactly should it be? (In reply to comment #5)\n> (In reply to comment #2)\n> Yes, I have no objections and any of my contributions to Rhino can be relicensed\n> under MIT-X-style license. \n> \n> Now what exactly should it be? \n\nIgor, IIUC Brendan suggest a relicensing to ASL2.0, but wants to check with Mitchel. If he\'s OK with that, \nI\'ll proceed with putting up some page where people can check they effectively contributed to Rhino in \nthe past, and post their (dis)agreement - possibly as a comment on this entry. Seems like Bugzilla is an \nappropriate way to record votes.I looked through the attachment and I know some multiple emails are all due to\nsingle people:\n\nKurt Westerfeld: \'kurt@ManagedObjects.com\', \'kurt@managedobjects.com\',\n\'kurt@mosol.com\', \'kurt@westerfeld.com\', \'kurt@westerfield.com\',\n\'kwester@ManagedObjects.com\'\n\nNorris Boyd: \'nboyd@atg.com\', \'norris@netscape.com\'\n\nSteven Lobo: \'slobo@espial.com\', \'slobo@espialgroup.com\'\n\nIgor Bukanov: \'igor.bukanov@windriver.com\', \'igor@mir2.org\', \'igor@icesoft.no\'\n\nI\'m fine with the relicensing scheme. (In reply to comment #6)\n> (In reply to comment #5)\n> > (In reply to comment #2)\n> > Yes, I have no objections and any of my contributions to Rhino can be relicensed\n> > under MIT-X-style license. \n> > \n> > Now what exactly should it be? \n> \n> Igor, IIUC Brendan suggest a relicensing to ASL2.0, but wants to check with\nMitchel. \n\nSorry but I got another impression: the idea is to have MIT-X-style license\nwhich is compatible with MPL/GPL/LGPL/APL. Since APL 2 is not compatible with\nGPL (well, according to FSF and I prefer to trust FSF is that area), the license\ncan not be APL 2.0. \nAccording to:\nhttp://www.gnu.org/philosophy/license-list.html\n- the ASL 1.0 is incompatible with the GPL due to its advertising clause\n- the ASL 1.1 is incompatible with the GPL\n- the ASL 2.0 is incompatible with the GPL due to the patent clauses\n\nTherefore, none of these licenses have the four-way compatibility we seek.\n\nIt is true that the ASF claims the ASL 2.0 is compatible with the GPL; however,\nit\'s the copyright owner of the GPLed code who has (potential) standing to sue,\nwhoever they may be. As this issue is unclear, relicensing under the ASL 2.0 is\nprobably not the best choice.\n\nIf we want compatibility with MPL, GPL, LGPL and ASL, I would suggest the\ntraditional MIT license:\nhttp://www.opensource.org/licenses/mit-license.php\n\nIt has the advantage of compatibility, being a well-known name (saying \"X\nlicense\" these days can be confusing due to the recent XFree86 1.1 license\nissue), and simplicity.\n\nGervMechanism.\n\nIt is not sufficient to email all the people who have checked into the codebase.\nYou need to take into account:\n\n- Copyright in some of those people\'s contributions may be owned by their\nemployer or employers during the time they contributed. Their employers\ntherefore need to give permission.\n- Others without checkin access will have contributed; they may or may not be\nmentioned in checkin comments. They will be mentioned in bugs.\n\nGathering the list of people to ask is a time-consuming task.\n\nYou then need to put together an email, and send it out. Collect the bounces,\nand try and find new email addresses for those people. Deal with the replies,\nand keep track of who hasn\'t got back to you. Chase them up, over months if\nnecessary. \n\nOnce you have a hard core of uncontactables, you have to evaluate their\ncontributions by reading old bugs and patches, and see if it\'s still possible to\ngo ahead, and how much code you have to rewrite.\n\nYou do have one trump card. If the code is under the NPL or a license including\nthe NPL, the Mozilla Foundation can relicense it by decree, without a need for\npermission. You need to decide whether you want to do that, and risk annoying\npeople, or ask and risk getting a No.\n\nAnd, before you ask, I am happy to advise as necessary, but I would like to\nfinish one relicensing project (Mozilla) before starting another one. :-)\n\nGerv\nNow that I review email, I see that Brian Behlendorf did suggest MIT; probably I\nconfused things by suggesting ASL.  Thanks, Gerv.\n\nIf http://www.opensource.org/licenses/mit-license.php is agreeable (need\nMitchell here, her agreement is necessary), then we can settle this issue and\napproach the remaining copyright holders.\n\n/beYes, the MIT license does seem a good choice.  Looks OK to me.\n\nmitchell(In reply to comment #12)\n> Yes, the MIT license does seem a good choice.  Looks OK to me.\n\nGreat. Then I propose to go further down the road, contacting people and asking for a relicensing of \ntheir contributions to MIT. Thanks!Changing the title: I assume that there is agreement to change Rhino license to\nhttp://www.opensource.org/licenses/mit-license.php\n\nNow how it should be done practically? Assuming that copyright holders for a\nparticular file agrees to chnage the license, should the license header be\nchanged to the MIT license? But how then the the current copyright holder and\ncontributor information should be altered to fit MIT style? And since the\nlicense text is itself copyrighted, how should it be properly included?\n\n(In reply to comment #14)\n\n> But how then the the current copyright holder and\n> contributor information should be altered to fit MIT style?\n\nIIUC, they should be preserved.\n\nJust fyi: ASF licensing & (c) works slightly different. Contributors are required to sign a license \nagreement that makes sure their contributions become (c) ASF. We have a NOTICE or CREDITS file to \ncapture names of contributing entities which want to be credited explicitely.\n\nI don\'t know whether obtaining such an agreement from the old Rhino contributors should be part of \nthis relicensing operation, requiring contributors to \"give up\" (c) to the Mozilla Foundation. This of \ncourse would make future license changes a lot easier - but I understand that\'s not how Mozilla works.\n\n> And since the\n> license text is itself copyrighted, how should it be properly included?\n\n---------------\n\nCopyright (c) ???? <names of current copyright holders>\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and \nassociated documentation files (the \"Software\"), to deal in the Software without restriction, including \nwithout limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell \ncopies of the Software, and to permit persons to whom the Software is furnished to do so, subject to \nthe following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial \nportions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, \nINCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR \nPURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE \nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT \nOR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR \nOTHER DEALINGS IN THE SOFTWARE.\n\n--------\n\nWe might add some reference to that, stating the license is \"the MIT license\".\n\nThoughts?The license text isn\'t really itself copyrighted. The copyright line is for you\nto add the names of those who own the copyright on the software.\n\nWe could ask for copyright attribution at the same time - but it\'s an\nadministrative hurdle, and we\'d have to keep doing so going forward. It also\nmight hold up the process, particularly if people have moved employers. Whether\nwe do this or not is probably up to the person doing all the hard work :-)\n\nBTW, please don\'t anyone start contacting anyone until we\'ve drawn up a plan of\naction. :-) \n\nGerv\nSo Steven, are you willing to take a lead on this? Someone has to :-)\n\nGerv\n(In reply to comment #17)\n\n> So Steven, are you willing to take a lead on this? Someone has to :-)\n\nSure thing, Gerv, just had some busy days. Let me try and figure out some plan in the next few days.\nJust to ask, what exactly (if any) does this proposed lisence change do for\ncommercial usage of Rhino?\n> Just to ask, what exactly (if any) does this proposed license change do for\n> commercial usage of Rhino?\n\nIt removes requirements on the licensee, to the point where you have only to\npreserve the copyright and license notices in the source files.\n\n/beSteven: ping? ;-)\n\nGervPing and ricing the original issue one more time due to yet another comming\nRhino release:\n\n> No matter what would be the outcome of the discussion about APL and other\n> license schemas, I think at least MPL/LGPL/GPL should be put in place. \n> \n> For practical matters I would suggest to finish this work first as gven the\n> previous experience any too generic question would rsult in nothing done.\n> \n> So the question is: who should authorise this?\n\nDue to the nature of NPL As discussed above mozilla.org can relicense\nNPL-licensed files under MPL/LGPL/GPL trio and since it was done for the browser\ncodebase without asking contributors is it possible to apply such treatment to\nRhino sources? And who should say the final answer for this?Igor: yes, that\'s true. However, when adding the GPL and LGPL to the MPL, it was\nin some ways less contentious because we were not reducing the amount of\ncopyleft protection on the files. Using an MIT-based license would be reducing\nthe copyleft, which some contributors may not like. Therefore, you should\nprobably make sure you have support among major Rhino contributors before making\nthis move (you may already have this.)\n\nThe final say probably officially comes from Mitchell but if the module owners\nare all in agreement, you have a broad base of support, and given comment 12,\nyou should just go ahead with an MIT-like license.\n\nhttp://www.opensource.org/licenses/mit-license.php\n\nGerv(In reply to comment #23)\n> Igor: yes, that\'s true. However, when adding the GPL and LGPL to the MPL, it was\n> in some ways less contentious because we were not reducing the amount of\n> copyleft protection on the files. Using an MIT-based license would be reducing\n> the copyleft, which some contributors may not like. Therefore, you should\n> probably make sure you have support among major Rhino contributors before making\n> this move (you may already have this.)\n\nI guess I was not clear in my last comment: I simply suggest to replace NPL/GPL\nby MPL/LGPL/GPL tripple in all Rhino sources that carry one and fix license info\nin Rhino documentation. \n\nAt this point I simply do not care about MIT license switch: if somebody is\nwilling to do that, it is very welcome, but for me the ability to redestribute\nRhino under LGPL is useful for some particular reasons.\n\nSo I repeat the question:\n\nIs it OK to replace NPL/GPL by MPL/LGPL/GPL tripple in all Rhino sources that\ncarry such notice in the same way as it was done for the browser code base???\n\nAFAICS it could not hamper the switch to MIT licsense later since all files with\nNPL/GPL duo are copyrighted by Netscape so after the switch mozilla.org IMO can\nstill change the license at will.> AFAICS it could not hamper the switch to MIT licsense later since all files \n> with NPL/GPL duo are copyrighted by Netscape so after the switch mozilla.org \n> IMO can still change the license at will.\n\nmozilla.org has not, as far as I am aware, had Netscape\'s copyrights assigned to\nit, so this doesn\'t work. Even if it had, Netscape only retains copyright on the\nparts of the code it wrote - if I insert ten lines into a file that says \"(C)\nNetscape\" at the top, the copyright on those ten lines is still mine, not\nNetscape\'s.\n\nSo, switching Rhino to an MPL-based tri-license would in effect fork it, because\nif we wanted to MIT-license it, we could only do so for the last version that\nwas NPLed, and not for the latest version. Either that, or request permission\nfrom every contributor who contributed after the change to the tri-license.\n\nThe correct thing to do is for the Rhino module owners to choose a license\n(which I believe they have; the MIT one), make sure (in this case) that the\nmajor players are onside, and then relicense the code once and for all.\n\nIgor: does your urgency translate into being able to provide manpower for this\nprocess?\n\nGerv\n(In reply to comment #25)\n> > AFAICS it could not hamper the switch to MIT licsense later since all files \n> > with NPL/GPL duo are copyrighted by Netscape so after the switch mozilla.org \n> > IMO can still change the license at will.\n> \n> mozilla.org has not, as far as I am aware, had Netscape\'s copyrights assigned to\n> it, so this doesn\'t work. Even if it had, Netscape only retains copyright on the\n> parts of the code it wrote - if I insert ten lines into a file that says \"(C)\n> Netscape\" at the top, the copyright on those ten lines is still mine, not\n> Netscape\'s.\n> \n> So, switching Rhino to an MPL-based tri-license would in effect fork it, because\n> if we wanted to MIT-license it, we could only do so for the last version that\n> was NPLed, and not for the latest version. Either that, or request permission\n> from every contributor who contributed after the change to the tri-license.\n\nI see. But then here is my understanding of the situation.\n\n1. If a file contains NPL notice, then mozilla.org can at will change its\nlicense to anything. \n\n2. Using such power to change the license from NPL/GPL into MPL/GPL/LGPL trio is\nOK since it does not change the spirit of the license.\n\n3. It is not OK despite the legal possibility to change the license to MIT one\nunless ALL the contributors to a particular file agree about it since it does\nchange the essence of the license significantly.\n\nBut then I do not see how changing NPL/GPL into MPL/GPL/LGPL now would hamper\nthe the relicensing later under MIT license. If the intention is to get the\nagreement from all contributors in any case, then additional license step in\nbetween should not matter, right?\n\n> Igor: does your urgency translate into being able to provide manpower for this\n> process?\n\nNo: as I wrote I do not care about MIT license for Rhino. It is useful to have\nLGPL option for me since it would simplify packaging of Rhino together with LGPL\ncode in a comercial product. \n\nMIT license, of cause, would simplify the packaging even more but I do not see\nhow it would ever happen.> 3. It is not OK despite the legal possibility to change the license to MIT one\n> unless ALL the contributors to a particular file agree about it since it does\n> change the essence of the license significantly.\n\nThat\'s not quite right. It\'s legally fine to change the license; my _advice_ to\nthe maintainers of Rhino would be, to avoid splitting their community and losing\ncontributions or getting damaging PR, to make sure all they key contributors are\nhappy first. \n\nHowever, if the Rhino module owner does not want to do that, we can go ahead and\nchange straight to MIT without it.\n\nGerv\nI attach recent mails for records:\n\n-------- Original Message --------\nSubject: Re: [Fwd: Re: Licensing Question]\nDate: Fri, 27 Aug 2004 09:42:40 +0200\nFrom: Steven Noels <stevenn@outerthought.org>\nTo: Mitchell Baker <mitchell@mozilla.org>,\tBrendan Eich <brendan@meer.net>, Igor\nBukanov <igor@fastmail.fm>,\tshaver <shaver@mozilla.org>, Brian Behlendorf\n<brian@collab.net>,\tlegal@apache.org\nCC: Cocoon PMC List <pmc@cocoon.apache.org>\nReferences: <412E1318.6090404@meer.net> <412E45B5.9070900@mozilla.org>\n<412E5235.9080402@meer.net> <20040826145056.F30475@fez.hyperreal.org>\n<412E5EE3.9060900@mozilla.org>\n\nOn 27 Aug 2004, at 00:06, Gervase Markham wrote:\n\n> Brian Behlendorf wrote:\n>> ISTR the problem was that to relicense, we needed to track down all \n>> prior contributors and ask them to approve a relicense.\n>\n> That\'s not actually true. See the position outlined in the bug.\n> http://bugzilla.mozilla.org/show_bug.cgi?id=236108\n>\n> I said:\n>\n> \"That\'s not quite right. It\'s legally fine [due to the code being \n> NPLed] to change the license; my _advice_ to the maintainers of Rhino \n> would be, to avoid splitting their community and losing contributions \n> or getting damaging PR, to make sure all they key contributors are \n> happy first.\n>\n> However, if the Rhino module owner does not want to do that, we can go \n> ahead and change straight to MIT without it.\"\n>\n> So as far as I\'m concerned, we\'re awaiting a decision from the Rhino \n> module owner (I\'m not actually sure who that is) on this question. If \n> they say they have all the people they care about on-side, we can go \n> ahead and relicense. I can provide tools for that, and it\'s a mostly \n> automated job.\n\nThis change of plans has been added a few weeks ago, and I figure this \ncould be helpful, *if* the reintegration issue is tackled as well - \nwhich is still to be doubted upon.\n\nFrankly, the reason why I didn\'t pursue further efforts wrt. contacting \noriginal contributors (and their eventual employers) was partly because \nof a serious lack of time on my behalf, even though I did produce a \nlist of all email addresses to be contacted from Rhino\'s CVS log \nhistory \n(http://bugzilla.mozilla.org/attachment.cgi?id=144038&action=view).\n\nAlso, even though Gerv repeatedly offered his kind assistance with the \nprocess of contacting the original copyright owners, comments like \nhttp://bugzilla.mozilla.org/show_bug.cgi?id=236108#c26 left me wary on \nthe eventual success of such an effort.\n\nOn the issue of reintegration, I think I can safely state that no such \neffort is currently underway, and that this isn\'t likely to happen any \ntime soon - due to the complexity of the effort, the effect that Rhino \nitself has moved on since then, and that a few alternatives for the \nlibrary\'s functions are starting to appear in other venues \n(non-JavaScript-based continuations). However, the Rhino fork is still \nin heavy use by many Cocoon users - not all of them interested in doing \npure Java-based continuations nor in pursuing Groovy-based \ncontinuations ATM.\n\nWhile the issue of having a fork around is not to be applauded upon, \nhaving a MIT-licensed Rhino would at the very least still legalize the \nsituation, in the sense that we might then be able to safely import our \nfork into ASF CVS and work from there. However, I assume the \nrelicensing would happen for the current version of Rhino, which is not \nthe version the fork has been based upon, and I\'m pretty sure \nrelicensing can\'t go back in time.\n\n<off-topic>Optimistically thinking, and proposing something which has \nbeen commented upon already earlier, the chances for more people \nworking on Rhino, and perhaps offering continuations support in the \nofficial version so that our fork becomes obsolete, might increase if, \nfacilitated partly through the MIT-relicensing, Rhino would become part \nof the bigger and more Java-centric development community of \nApache.</off-topic>\n\nAh: I see Norris isn\'t on the recipients list - shouldn\'t he be made \naware of what we are conversing about?\n\n</Steven>\n-- \nSteven Noels                            http://outerthought.org/\nOuterthought - Open Source Java & XML            An Orixo Member\nRead my weblog at            http://blogs.cocoondev.org/stevenn/\nstevenn at outerthought.org                stevenn at apache.org\nFor the records:\n\n-------- Original Message --------\nSubject: Re: Rhino Licensing Question\nDate: Fri, 27 Aug 2004 08:49:18 -0400\nFrom: Norris Boyd <nboyd@atg.com>\nTo: Igor Bukanov <igor@fastmail.fm>\nCC: Steven Noels <stevenn@outerthought.org>,\tMitchell Baker\n<mitchell@mozilla.org>,\tBrendan Eich <brendan@meer.net>, shaver\n<shaver@mozilla.org>,\tBrian Behlendorf <brian@collab.net>, legal@apache.org,\nCocoon PMC List <pmc@cocoon.apache.org>\nReferences: <412E1318.6090404@meer.net> <412E45B5.9070900@mozilla.org>\n<412E5235.9080402@meer.net> <20040826145056.F30475@fez.hyperreal.org>\n<412E5EE3.9060900@mozilla.org>\n<AC9D07BF-F7FC-11D8-9CEA-000A958B684A@outerthought.org>\n<412F0925.2070608@fastmail.fm>\n\nYes, I\'d agree to change the license of Rhino source files with NPL/GPL \nlicense header to MIT-style license without contracting all the \ncontributors.\n\nI don\'t know the legal ins and outs, but seems like we\'d need the \napproval of someone from the Mozilla foundation who presumably inherited \nthe legal rights associated with being the \"Initial Developer\" from \nNetscape/AOL/Time Warner.\n\n--N\n\nIgor Bukanov wrote:\n\n> Hi, Norris!\n>\n> The issue about Rhino license \n> (http://bugzilla.mozilla.org/show_bug.cgi?id=236108) was resurrected \n> once again so I include you on on the list.\n>\n> Now the question is would you agree to change license of Rhino source \n> files that have NPL/GPL license header to MIT-style license without \n> contacting all the contributors?\n>\n> But I will ask John Schneider from AgileDelta if he would accept that \n> for E4X contribution.\n>\n> Regards, Igor\n>\n>\n> Steven Noels wrote:\n>\n>> On 27 Aug 2004, at 00:06, Gervase Markham wrote:\n>>\n>>> Brian Behlendorf wrote:\n>>>\n>>>> ISTR the problem was that to relicense, we needed to track down all \n>>>> prior contributors and ask them to approve a relicense.\n>>>\n>>>\n>>>\n>>> That\'s not actually true. See the position outlined in the bug.\n>>> http://bugzilla.mozilla.org/show_bug.cgi?id=236108\n>>>\n>>> I said:\n>>>\n>>> \"That\'s not quite right. It\'s legally fine [due to the code being \n>>> NPLed] to change the license; my _advice_ to the maintainers of \n>>> Rhino would be, to avoid splitting their community and losing \n>>> contributions or getting damaging PR, to make sure all they key \n>>> contributors are happy first.\n>>>\n>>> However, if the Rhino module owner does not want to do that, we can \n>>> go ahead and change straight to MIT without it.\"\n>>>\n>>> So as far as I\'m concerned, we\'re awaiting a decision from the Rhino \n>>> module owner (I\'m not actually sure who that is) on this question. \n>>> If they say they have all the people they care about on-side, we can \n>>> go ahead and relicense. I can provide tools for that, and it\'s a \n>>> mostly automated job.\n>>\n>>\n>>\n>> This change of plans has been added a few weeks ago, and I figure \n>> this could be helpful, *if* the reintegration issue is tackled as \n>> well - which is still to be doubted upon.\n>>\n>> Frankly, the reason why I didn\'t pursue further efforts wrt. \n>> contacting original contributors (and their eventual employers) was \n>> partly because of a serious lack of time on my behalf, even though I \n>> did produce a list of all email addresses to be contacted from \n>> Rhino\'s CVS log history \n>> (http://bugzilla.mozilla.org/attachment.cgi?id=144038&action=view).\n>>\n>> Also, even though Gerv repeatedly offered his kind assistance with \n>> the process of contacting the original copyright owners, comments \n>> like http://bugzilla.mozilla.org/show_bug.cgi?id=236108#c26 left me \n>> wary on the eventual success of such an effort.\n>>\n>> On the issue of reintegration, I think I can safely state that no \n>> such effort is currently underway, and that this isn\'t likely to \n>> happen any time soon - due to the complexity of the effort, the \n>> effect that Rhino itself has moved on since then, and that a few \n>> alternatives for the library\'s functions are starting to appear in \n>> other venues (non-JavaScript-based continuations). However, the Rhino \n>> fork is still in heavy use by many Cocoon users - not all of them \n>> interested in doing pure Java-based continuations nor in pursuing \n>> Groovy-based continuations ATM.\n>>\n>> While the issue of having a fork around is not to be applauded upon, \n>> having a MIT-licensed Rhino would at the very least still legalize \n>> the situation, in the sense that we might then be able to safely \n>> import our fork into ASF CVS and work from there. However, I assume \n>> the relicensing would happen for the current version of Rhino, which \n>> is not the version the fork has been based upon, and I\'m pretty sure \n>> relicensing can\'t go back in time.\n>>\n>> <off-topic>Optimistically thinking, and proposing something which has \n>> been commented upon already earlier, the chances for more people \n>> working on Rhino, and perhaps offering continuations support in the \n>> official version so that our fork becomes obsolete, might increase \n>> if, facilitated partly through the MIT-relicensing, Rhino would \n>> become part of the bigger and more Java-centric development community \n>> of Apache.</off-topic>\n>>\n>> Ah: I see Norris isn\'t on the recipients list - shouldn\'t he be made \n>> aware of what we are conversing about?\n>>\n>> </Steven>\n>\n>\nReplying to Norris\' email (which, for some reason, I didn\'t get as an email):\n\nIt\'s not about who is the Initial Developer, it\'s about who has a right to\narbitrarily relicense NPLed code. The Foundation inherited this right from\nNetscape, and we are happy to use it in this case to relicense Rhino under the\nMIT license.\n\nIf your statement \"I\'d agree to change the license.. to MIT-style license\nwithout contracting all the contributors\" is the voice of all the Rhino module\nowners (still, no-one has told me who they are and how many), then we can go ahead.\n\nThe person who wishes to do the work should contact me by email for\ninstructions, tips and scripts.\n\nGerv\nI\'m not sure Gerv is right about this.  I want to look at the actual language\nabout what we can do with code.  I\'m just back from vacaton this evening and\ndon\'t have the documents in front of me.  My recollection is that the Mozilla\nFoundation has the right to use the previously NPL\'d code under the MPL and of\ncourse to change the terms of the MPL.  But I don\'t recall anything that says\nthat Netscape\'s special rights under the NPL are somehow transferred to the\nMozilla Foundation.  \n\nI think this is what Gerv is saying.  Gerv, please correct me if you are saying\nsomething else.  \n\nMitchell I\'ve emailed Mitchell to clarify the situation.\n\nGerv(In reply to comment #32)\n> I\'ve emailed Mitchell to clarify the situation.\n> \n> Gerv\n\nGrev, did you get any information regarding the license issues?(In reply to comment #32)\n> I\'ve emailed Mitchell to clarify the situation.\n> \n> Gerv\n\nGerv, did you get any information regarding the license issues?Mitchell is of the view that the special NPL relicensing ability remains with\nNetscape. Netscape started a relicensing project for the Mozilla code - the\nquestion is whether that included Rhino or not. It\'s rather hard to say, as\nMitchell doesn\'t have all her old records any more. \n\nOn 29/08 she said she\'d have a look; I haven\'t heard back since. I\'m not\nsurprised - it\'s one of those open-ended jobs that never reaches the top of the\nlist ;-)\n\nPerhaps it would be best to assume that we need to seek permission from\neveryone. That\'s not necessarily as arduous as task as you might think. If\nsomeone still has the cycles to take this forward, they should email me to\ndiscuss it. We can at least work out the size of the problem.\n\nGerv(In reply to comment #35)\n\n> Perhaps it would be best to assume that we need to seek permission from\n> everyone. That\'s not necessarily as arduous as task as you might think. If\n> someone still has the cycles to take this forward, they should email me to\n> discuss it. We can at least work out the size of the problem.\n\nBut before any such process can start I think it is necessary to reach the\nconclusion on the following issues:\n\n1. Should the license change happen once for all files or is it OK to have a\nmixture? \n\n2. Exact license policy for the new source files and how the future\ncontributions to them has to be handled.\n\n3. License policy for contributions to the current sources with NPL/GPL headers.\nI.e. how exactly that has to be marked and documented?\n\nIf there is a conclusion on these issue I can add that to Rhino documentation\nand refer interested folks to it. \n\nIMO:\n\n> 1. Should the license change happen once for all files or is it OK to have a\n> mixture? \n\nOnce for all. A mixture will just confuse.\n\n> 2. Exact license policy for the new source files and how the future\n> contributions to them has to be handled.\n\nFuture contributions under the same licence. What else needs deciding?\n\n> 3. License policy for contributions to the current sources with NPL/GPL \n> headers. I.e. how exactly that has to be marked and documented?\n\nI don\'t understand the question.\n\nGerv(In reply to comment #37)\n> IMO:\n> \n> > 1. Should the license change happen once for all files or is it OK to have a\n> > mixture? \n> \n> Once for all. A mixture will just confuse.\n\nBut what if it would take many months to contact all contributors? And what if\nsomeone just say no for a small patch? \n\n> \n> > 2. Exact license policy for the new source files and how the future\n> > contributions to them has to be handled.\n> \n> Future contributions under the same licence. What else needs deciding?\n\nMPL pages at mozilla.org describe the procedure how the contribution should be\nmarked like \"Conributors\" section in the license header etc.. I guess MIT\nlicense instructions can follow the same rules, right?\n\n> \n> > 3. License policy for contributions to the current sources with NPL/GPL \n> > headers. I.e. how exactly that has to be marked and documented?\n> \n> I don\'t understand the question.\n\nThe question is what should happen if during process of contacting contribors\nfor some file someone submit a patch against the file? Should a separated MIT\nsection be added to the file or is it enough top state in a documentation that\nall contributions from the moment X are under MIT license?\n\nIgor> But what if it would take many months to contact all contributors? And what if\n> someone just say no for a small patch? \n\nThe trick here is to change your checkin policy to say \"people contributing code\nmust consent to a future relicensing.\" This freezes the problem at its current size.\n\n> > Future contributions under the same licence. What else needs deciding?\n> \n> MPL pages at mozilla.org describe the procedure how the contribution should be\n> marked like \"Conributors\" section in the license header etc.. I guess MIT\n> license instructions can follow the same rules, right?\n\nActually, the MIT license header doesn\'t have a Contributors section.\n\n> The question is what should happen if during process of contacting contribors\n> for some file someone submit a patch against the file?\n\nSee above :-)\n\nGervWhat came of this? its been over a year or two since this was a topic?From a practical point of view, the situation is that someone needs to step up and volunteer to take the time to do the work. I\'d be happy to advise them as how to proceed.\n\nGerv\nPerhaps we should close this issue. Rhino 1.6R5 was released on 2006-11-19 under MPL 1.1 which is compatible with Apache License. See:\n\nhttp://www.mozilla.org/rhino/download.htmlAgreed. Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.This should be marked 1.6R5.',?,CLEANUP
236117,'Context sealing API for Rhino',Rhino,Core,igor,igor,'Since changing Context parameters can significantly alter script execution, I\nsuggest to add to Context a new API to seal Context instance so any future\nattempt to change its parameters would throw an exception.\n\nIt would not only prevent bugs in applications but also allow to prevent\nsecurity breaches as currently Rhino has no protection against combined attack\nof untrusted Java and JavaScript code. For example, low-privileges jar executed\nas a part of untrusted script can call Context.exit/Context.enter to create\nContext without security controller and use to produce interpreted scripts\nhaving the same privileges as Rhino code.Targeting 1.5R5Created attachment 142684\nSealing implementation\n\nThe essential part of the patch is the following API:\n\n    /**\n     * Checks if this is a sealed Context. A sealed Context instance does not\n     * allow to modify any of its properties and will throw an exception\n     * on any such attempt.\n     * @see #seal(Object sealKey)\n     */\n    public final boolean isSealed()\n    {\n\treturn sealed;\n    }\n\n    /**\n     * Seal this Context object so any attempt to modify any of its properties\n     * including calling {@link #enter()} and {@link #exit()} methods will\n     * throw an exception.\n     * <p>\n     * If <tt>sealKey<tt> is not null, calling\n     * {@link #unseal(Object sealKey)} with the same key unseals\n     * the object. If <tt>sealKey<tt> is null, unsealing is no longer possible.\n\n     *\n     * @see #isSealed()\n     * @see #unseal(Object)\n     */\n    public final void seal(Object sealKey)\n    {\n\tif (sealed) onSealedMutation();\n\tsealed = true;\n\tthis.sealKey = sealKey;\n    }\n\n    /**\n     * Unseal previously sealed Context object.\n     * The <tt>sealKey<tt> argument should not be null and should match\n     * <tt>sealKey<tt> suplied with the last call to\n     * {@link #seal(Object)} or an exception will be thrown.\n     *\n     * @see #isSealed()\n     * @see #seal(Object sealKey)\n     */\n    public final void unseal(Object sealKey)\n    {\n\tif (sealKey == null) throw new IllegalArgumentException();\n\tif (this.sealKey != sealKey) throw new IllegalArgumentException();\n\tif (!sealed) throw new IllegalStateException();\n\tsealed = false;\n\tthis.sealKey = null;\n    }\n\nwith intendent usage like:\n\nprivate Object sealKey = new Object();\n\nContext cx = new Context();\ncustomize(cx);\ncx = Context.enter(cx);\ncx.seal(sealKey);\ntry {\n...\n} finally {\n    cx.unseal(sealKey);\n    Context.exit();\n}\n\nNow any attempt to call Context.enter/exit or modify Context parameters would\nfail unless sealKey is known so the trusted code still can call:\n\ncx.unseal(sealKey);\ntry {\n    cx.setOptimizationLevel(9);\n} finally {\n    cx.seal(sealKey);\n}\n\nAnother part of the patch is to make most of the read methods in Context final\nas additional protection against \"tailored\" Context objects.Created attachment 142827\nPatch without unrelated code\n\nThe patch from attachment 142684 is not compilable and included unrelated code\nfor bug 236193. This is a proper version.\n\nI also forgot to document another patch feature: new method\nContext.disableStaticContextListening() :\n\n\n    /**\n     * Disable notifications of listeners registered with\n     * {@link #addContextListener(ContextListener)} about Context events.\n     * All currently registered listeners will be removed and any subsequent\n     * call to {@link #addContextListener(ContextListener)} will throw an\n     * exception.\n     * <p>\n     * Embedding may use this method to prevent Context exposure to potentially\n\n     * untrusted code.\n     */\n    public static void disableStaticContextListening()\n    {\n\tsynchronized (staticListenersLock) {\n\t    disabledContextListening = true;\n\t    staticListeners = null;\n\t}\n    }\n\nAlthough Context.addContextListener is a convinient method, as any method\noperating on static data it can be exploited if an application allows to run\nuntrusted jars and using Rhino for internal purposes. In such cases the\napplication may be willing to drop convinience of Context.addContextListener\nfor a better porotection againt hosile code.I committed the last patch',?,RFE
236193,'Only active Context for compilation',Rhino,Compiler,igor,igor,'To prevent a security breach when untrusted script calls Interpreter.compile\nwith null for Context argument to construct Script instances without any\nassociated security domain I suggest to change Interpreter and optimizer/Codegen\nto use only currently entered Context as a source of SecurityController. \n\nIn addition, the interpreter to drop privileges should use SecurityController\nthat was used during compilation, not the current one in Context, to prevent\nexecuting of compiled scripts with different SecurityController implementation\nor even without it.Created attachment 142750\nImplementationI committed the attchment 142750Adding proper target milestone',?,IMPROVEMENT
237771,'toSource should be generic',Rhino,Core,igor,igor,'The current implementation of toSource in Rhino does not allow to transfer\nObject.prototype.toSource to be transfered to other objects since it uses Java\ninheritance to call a particular method and as such does not fit into prototype\npattern of JS. \n\nIn the current SM shell I have:\n\n\njs> var a = [1,2];\njs> a.toSource = Object.prototype.toSource\n\nfunction toSource() {\n    [native code]\n}\n\njs> a.toSource()\n({0:1, 1:2, toSource:function toSource() {[native code]}})\n\njs> Object.prototype.toSource == Array.prototype.toSource\nfalse\n\n\nwhile the same session in Rhino gives:\n\n\njs> var a = [1,2];\njs> a.toSource = Object.prototype.toSource\nfunction toSource() { [native code for Object.toSource, arity=0] }\n\njs>  a.toSource()\n[1, 2]\n\njs>  Object.prototype.toSource == Array.prototype.toSource\ntrueTargeting 1.5R5Created attachment 144116\nFix: explicitly define toSource for all interested objectsCreated attachment 144145\nFixing use of this in place of thisObj in the previous patch in NativeArrayI committed the fix',?,DESIGN_DEFECT
238649,'Removal of deprecated features after 1.5R5',Rhino,Core,igor,igor,'I think it make sense to remove deprecated features now after 1.5R5 release\nsince doing so gives more chances to discover about embedding that can not leave\nwithout them.Created attachment 146402\nRemoval of omj.NotAFunctionExceptionI committed the above patchCreated attachment 146405\nRemoval of ClassNameHelper and ClassRepository\n\nomj.optimizer.ClassCompiler provides much simpler API for script compilationCreated attachment 146406\nRemoval of ClassNameHelper and ClassRepository (without tabs)This was done long time ago.',?,CLEANUP
238699,'Context.compileFunction throws InstantiationException',Rhino,Compiler,rknight,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.0.3705; .NET CLR 1.1.4322)\nBuild Identifier: 1.5R5\n\nThe following code generates an InstantiationException:\n       Context context = Context.enter();\n       scope = context.initStandardObjects(null);\n       context.compileFunction(scope, \"function a() { return 123; }\", \"a\", 1, \nnull);\n\n\nReproducible: Always\nSteps to Reproduce:\nSee details.\nActual Results:  \nThe following exception was thrown:\njava.lang.RuntimeException: Unable to instantiate compiled \nclass:java.lang.InstantiationException: org.mozilla.javascript.gen.c1This is a regression indeed. It is pitty that 1.5R5 is already released so the\nfix will have to wait 1.5R5.1 (sometime later in June).Created attachment 144827\nFix: proper test for compilation mode\n\nAs a workaround, the optimization mode can be set to -1 or you can call\nContext.compileString/Context.compileReader which would give you Script where\nyou can call Script.exec: execution of script with single function will simply\ndefine that function in the scope object.I committed the fix',?,BUG
238823,'Context.compileFunction throws NullPointer exception',Rhino,Compiler,rknight,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.0.3705; .NET CLR 1.1.4322)\nBuild Identifier: 1.5R5\n\n(note a 1.5R5.1 patch fixing compileFunction must be applied - see bug 238699)\nCalling Context.compileFunction with a string that does not contain a function \nkey word (but is a valid expression) throws a NullPointer exception.\n\nReproducible: Always\nSteps to Reproduce:\nSee details\nActual Results:  \njava.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptOrFnNode.getFunctionNode\n(ScriptOrFnNode.java:81)\n\tat org.mozilla.javascript.Interpreter.compile(Interpreter.java:128)\n\tat org.mozilla.javascript.Context.compile(Context.java:2256)\n\tat org.mozilla.javascript.Context.compileFunction(Context.java:1222)compileFunction in Rhino should always be called with a source containing single\nJS function statement. I will make a patch to throw explicit\nIllegalArgumentException if the source does not fit this definition so the\ncompilation would not silently produce empty function or produce\nNullPointerException depending on Rhino version or compilation mode.Created attachment 144878\nThrow explicit IllegalArgumentException for bad inputCreated attachment 144880\nPatch update with the proper (hopefully!) check this timeI committed the fix.Proper target milestone',?,BUG
239068,'Scope of constructor functions is not initialized',Rhino,Core,igor,igor,'In current Rhino function properties of constructor objects of the standard Ecma\nobjects does not their scope initialized:\n\njs> Date.UTC.__parent__\nnull\njs> String.fromCharCode.__parent__\nnull\n\nSince the prototype of these functions is initialized from scope on the first\naccess, it leads to NullPointerException whenever getPrototype() is called for\nsuch functions:\n\njs>  Date.UTC.apply\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.ScriptableObject.getTopLevelScope(Unknown Source)\n        at org.mozilla.javascript.ScriptableObject.getClassPrototype(Unknown Source)\n        at org.mozilla.javascript.ScriptableObject.getFunctionPrototype(Unknown\nSource)\n        at org.mozilla.javascript.IdFunction.getPrototype(Unknown Source)\n\njs> String(String.fromCharCode)\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.ScriptableObject.getTopLevelScope(Unknown Source)\n        at org.mozilla.javascript.ScriptableObject.getClassPrototype(Unknown Source)\n        at org.mozilla.javascript.ScriptableObject.getFunctionPrototype(Unknown\nSource)\n        at org.mozilla.javascript.IdFunction.getPrototype(Unknown Source)\n\n\nThe bug was introduced in 1.5R2 when Rhino started to use IdScriptable\nimplementation for the standard objects.Created attachment 145015\nFix: proper initialization of scopeI committed the fix',?,BUG
242805,'Implementation of E4X',Rhino,E4X,igor,john.schneider,'Rhino shoould support E4X extensions to ECMAScript standard.You can not change the status of bugs you do not reported or own in bugzilla\nunless you have special priviliges. But it is strange that you could not attach\nanything. \n\nTo John:\n\nI reassigned the bug to you so you can change its status.John Schneider wrote:\n> Hi Igor,\n> \n> Thanks again. Attached is the final draft of the E4X specification. Sorry,\n> you didn\'t get a copy of this earlier. I sent one right after the final\n> draft went to ECMA for approval, but I think I only sent it to Norris at the\n> time. ECMA will post the final version on their web site once it is\n> approved. Please let me know if there\'s anything else I can do to help. \n\nI assume that until the uproval the draft can not be made public, right? \n\n> Do you know approximately when you might have time to start the E4X review\n> now that you have the spec? We were hoping to get any issues resolved and\n> have a version people could download and try out before the standard is\n> finalized in late June. \n\nWell, I can spend some time in June but would like to reiterate my suggesting\nabout splitting the changes in at least 2 parts, that is the parser changes and\nthe runtime. AFAICS the parser part is quite reasonable and can be included into\nRhino with simple exception throwing during code generation for e4x parse nodes. \n\nThen the runtime can be done added by parts together with the class compiler\nsupport. \nCreated attachment 152953\nA patch that adds the full E4X feature set to RhinoHi Igor,\n\nI\'m pleased to inform you that the patch adding the E4X feature set to Mozilla \nRhino is complete! The attached patch contains the recursive diffs of the \nsource code. Also, the full source code, object code and some examples may be \nfound at ftp://ftp.mozilla.org/pub/mozilla.org/js/e4x_preview.zip. \n\nThanks for all your assistance! You\'re comments and feedback have been very \nhelpful and have improved the quality of the submission substantially. I\'m \nanxious to see E4X included in Rhino 1.6! Please let me know if there\'s \nanything else I can do to assist.\n\n  Thanks!,\n\n  JohnReopening to have the bug open until the code end up in Rhino CVSCreated attachment 153531\nThe version of the previous patch against Rhino tip plus fixes\n\nThis is the version of E4X patch against Rhino tip. During porting I made the\nfollowing changes:\n\n1. There are no more static variables to hold prototypes for XML objects. This\nis rather verbose change since it introduces omj.xml.XMLLib and passes its\ninstances to XMLObject, Namespace and QName constructors. XMLLib holds the\ncurrent XML settings and initialization scope allowing to setup prototype\nchains for XML objects properly. \n\n2. New class omj.xml.XMLCtor implements all properties and methods of XML\nconstructor object which made unnecessary modifications in omj.IdFunction and\nsimplified XML code itself.\n\n3. New class omj.xml.XMLWithScope subclasses omj.NativeWith with XML-specific\nstuff which made changes to NativeWith unnecessary. \n\n4. Allow to pass the current test suite under JDK 1.1 without Apache classes\navailable. Previously JVM would try to access Apache classes on the first\nattempt to check for XML class instance. Under JDK 1.1 it leads to class\ninitialization. That in turn would initialize static variables which required\nto have XML classes. \n\n\nTo apply the patch pull Rhino sources from CVS, go to mozilla/js/rhino and run \n\n\npatch -p1 -i ....e4x_against_rhino_tip.diffCreated attachment 153932\nE4X patch without compilation dependencies on xbean.jar for core classes\n\nThis is the re-factored version of the previous patch that moves all code that\ndepends on xbean.jar classes into the separated top-level source dir\nxmlimplsrc.\n\nThe patch assumes that xbean.jar should be placed into jaralib/xbean.jar and\nnot into external/xbean.jar .\n\nThe attached file is gzipped diff so to apply it pull Rhino sources from CVS,\ngo to mozilla/js/rhino, and run \n\ngunzip ...e4x_against_rhino_tip.diff.gz | patch -p1I put Rhino sources with the last patch applied and compiled distribution at\nhttp://www.mir2.org/igor/e4x/ for now.\n\n\nCreated attachment 153951\nFixing missing xmlimplsrc/build.xml\n\nThe previous version of the patch did not include xmlimplsrc/build.xml which\nthis version fixes. In addition it will automatically download xbean.jar if it\nis not available during compilation with ant.\n\nAll the previous comments applies including the note that this is gzipped\nunified diff due to bugzilla restrictions on the patch size.I updated http://www.mir2.org/igor/e4x/ to reflect the last version of the patchCreated attachment 154234\nResolving compatibility issues\n\nThis version of the patch makes E4X-specific code compatible with Scriptable\nsemantic leading to less surprises in applications. It also include various\noptimizations to minimize number of created objects during XML property access.\n\n\nhttp://www.mir2.org/igor/e4x/ is updated with the rebuilt distribution of Rhino\nwith the patch applied.Created attachment 154394\nUsing Context to look for default namespace\n\n\nThe default xml statement in E4X associates the namespace with the current\nactivation scope. In the previous versions of the patch the current execution\nscope was used to set namespace objects. But it does not correspond to the\nactivation scope due to presence of with/catch statements. The patch addresses\nand passes Context instead of Scriptable to many functions expecting to search\nfor default namespace declaration.\n\nThe patch also renames get/put/has/delete methods in XMLScriptable into\ngetXMLProperty/putXMLProperty/hasXMLProperty/deleteXMLProperty to emphasis\nsemantical separation from Scriptable method.\n\nAs usual the attachment is gzippped diff and http://www.mir2.org/igor/e4x/\ncontains uncopressed version and prebuilt distributions.I think the last patch addresses all compatibility issues with the older Rhino\nand I will start merging it tomorrow, 2004-07-27 with Rhino tip.Created attachment 154570\nThe final patches: E4X syntax and runtime proxies\n\nThe previous drop was not the final story after all. I have already merged few\nnon-E4X-specific changes to Rhino CVS already and tag that version with\nBEFORE_E4X. \n\nThe version of the patch contains clear separation between E4X parsing and\nruntime support. The patch effectively contains all the necessary parser and\ncode generation changes plus proxies for E4X runtime support. The proxies are\nrepresented by only 2 classes, XMLLib and XMLObject in\norg.mozilla.javascript.xml and contain all the necessary hooks that E4X runtime\nhas to implement.  Patch touches quite a few runtime places to make efficient\nE4X support possible, mostly in the form of passing Context instances to most\nruntime methods and properly maintaining activation records.\n\nThe XML implementation itself is provided in the separated patch (see the next\nattachment).\n\nNote that the patch is a normal uncompressed diff.Created attachment 154571\nThe final patches: E4X runtimeI committed the last 2 patches: now Rhino CVS tip supports E4X!\n\nI keep the bug open for now since CVS does not include yet examples and\ndocumentation about E4X.\nI added the example demostrating E4X features from the initial E4X drop to Rhino\nCVS as  examples/E4X/e4x_example.js .\n\nBut it would be nice to populate the directory with more code.I added the example demostrating E4X features from the initial E4X drop to Rhino\nCVS as  examples/E4X/e4x_example.js .\n\nBut it would be nice to populate the directory with more samples.E4X test cases is now a part of js test suite that allows to mark the bug as fixed',?,RFE
243057,'enhancement - ability to assign to Java function result and default properties',Rhino,Compiler,mcbp223,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; T312461; YComp 5.0.0.0; .NET CLR 1.1.4322)\nBuild Identifier: \n\nThis report is a follow up of the newsgroup discussion \nhttp://groups.google.com/groups?hl=en&lr=&ie=UTF-8&oe=UTF-\n8&safe=off&frame=right&th=b21c4e09e133d24c&seekm=409C9F5A.2070208\%\n40fastmail.fm#link8\nand is a new feature request.\n\nIn MS JScript you can assign to a construction that looks like a function call, \nfor example in ASP:\n    Session.Value(\"foo\") = \"bar\";\nwhich at runtime could be translated by Rhino to\n    Session.jsSet_Value(\"foo\", \"bar\");\n\nThe rule is that a property will have n arguments for the getter, and n+1 \narguments for the setter; for the setter, the last argument is rhs.\n\nAlso in JScript you can write\n    Session(\"foo\") = \"bar\";\nwhich translates to the same thing, because Value is marked as default property.\n\nA solution to mark getters/setters as default could be to implement a new \nprefix, so the Java class to be scripted will have \n    Session.jsGetDefault_Value(String key)\nand\n    Session.jsSetDefault_Value(String key, Object val)\n\nWhen encountering a construct like\n    var str = Session(\"foo\")\nthe runtime could check first if Session is instanceof Callable. If it is not, \nit can continue the introspection with checking whether Session has a default \ngetter matching the number of arguments.\n\n\n\nReproducible: Always\nSteps to Reproduce:\n1. compile Session.Value(\"foo\") = \"bar\";\n\n\nActual Results:  \njsc reports: Invalid assignment left-hand side.\n\n\nExpected Results:  \nCheck if the Session object, a Java class provided by the programmer, has a \nsetter named jsSet_Value(String key, Object rhs);\n\n\nThings can get more complicated, for example consider a call to ADODB.Recordset\n    var str = rs(\"field\");\nthat should translate in\n    var str = rs.jsGetDefault_Fields().jsGetDefault_Item\n(\"field\").jsGetDefault_Value();With the introduction of RefCallable interface Rhino allows to define native\nfunctions that can be used as rvalue so one can define a native function foo so\nfoo() = bar or even foo() += q works.\n\nAs regarding the default option it is already doable throw overriding\nScriptable.get method so I close the bug as fixed.',?,RFE
244014,'Removal of code complexity limits in the interpreter',Rhino,Core,igor,igor,'Currently the interpreter bytecode limits code complexity in various ways. For\nexample, it restricts the size of jump offsets to 32K, the number of different\nstrings is limited to 64K per script and the number of arguments in function\ncalls can not exceed 64K.\n\nAlthough such limits are quite reasonable, they are occasionally hit especially\nwith automatically generated scripts. It would be nice if the interpreter would\nnot contain such restrictions.Created attachment 148816\nInterpreter bytecode without restrictions\n\nThe patch changes bytecode in 2 ways:\n\n1. To remove 32K limit on the size of jump offset the patch adds a hashtable\nfor jump offset that does not fit short. The jumpcode then checks if the offset\nis 0 then it uses the hashtable to lookup the jump target based on the jump pc.\nTo decrease code duplication the interpreter loop is reorganized to have all\njump-related code in one place.\n\n2. To remove 64K restriction on various indexes and counters a new prefix\nbytecode Icode_REG_IND* and Icode_REG_STR* are introduced. They preload string\nor index arguments of various instructions so the instructions themselves can\nuse already extracted value. The prefixes know how to deal with arbitrary int\nvalues and encode them accordingly.I committed the above patch as a series of smaller patches.',?,IMPROVEMENT
244492,'JavaScriptException to extend RuntimeException and common exception base',Rhino,Core,igor,igor,'Currently Rhino runtime can throw 3 different types of exceptions:\n\n1. JavaScriptException that is thrown by JavaScript throw statement.\n2. EcmaError that represents JavaScript runtime exception as specified by ECMA\nstandard.\n3. EvaluatorException that is thrown on compilation errors and as a wrapper for\nexceptions in Java functions.\n\nSince JavaScriptException extends Exception, it has to be always declared in the\nmethod signature. In principle this useful to provide a hint that a particular\nAPI can execute some JavaScript code. But in practice it does not work this way\nsince virtually any Rhino API method can cause indirect execution of JavaScript\ncode and in most such cases the API does not have \"throws JavaScriptException\"\ndeclaration.\n\nFor example, Context.toString(Object) executes toString function if it is\ndefined for the object and it can be defined with JavaScript. In addition any\nnative method including getters and setters can trigger JS execution and \"throws\nJavaScriptException\" is not included in Scriptable.get/Scriptable.put methods.\n\nFor this reason I suggest to change JavaScriptException to extend from\nRuntimeException so it would not be necessary to wrap it into artificial\nwrappers to circumvent lack of the exception declaration.\n\nSuch change will cause source compatibility error if Java code contains:\n\ntry {\n    ....\n} catch (RuntimeException ex) {\n    ...\n} catch (JavaScriptException ex) {\n    ...\n}\n\nbut this is trivially fixable in a forward and backward compatible way by\nchanging statement\'s order. \n\nIn addition for compiled classes with such code catch (JavaScriptException ex)\nwould not be reached so it may change program\'s semantics but at least the\nchange would be binary compatible.\n\nWith such change in place it would also make change to introduce a common base\nclass for all exceptions thrown by Rhino so it would be simple to process all\nsuch exceptions.Created attachment 149204\nJavaScriptException extends RuntimeException\n\nThe patch changes JavaScriptException to extend from RuntimeException and\nremoves various catch blocks for JavaScriptException that rethrow exception or\nignore it since it was not supposed to happen.I committed attachment 149204Created attachment 149347\nRhinoException as common exception root\n\nThe patch adds RhinoException as a common root for all exceptions for Rhino.\nThe class contains method to init/get script source location for the exception\nwhich is used by the rest of Exception classes.\n\nTo preserve binary compatibility I preserved the original source information\nmethods as a deprecated form.I committed the last patch.Proper target milestoneThe common root exception changes included also deprecation of PropertyException\nsince in common cases they were caught and rethrown as runtime exceptions by\nruntime or just caught and ignored. So I replaced throwing of PropertyException\nby  Context,reportRuntimeException and deprecated the class. \n\nBut that causes a compatibility problem during compilation since\nPropertyException extends Exception and no longer explicitly declared in Rhino\nAPI. So code containing catch (PropertyException ex) may not compile. To fix\nthat I commited a patch to extend PropertyException from RuntimeException to\nhave less suprises during Rhino upgrade. ',?,DESIGN_DEFECT
245882,'JavaImporter constructor',Rhino,Core,igor,igor,'Currently in Rhino importPackage and importCass are available when\nImporterTopLevel is a scope object. I suggest to add JavaImporter constructor to\nRhino that would construct explicit ImporterTopLevel objects. The constructor\nshould be initialized during Context.initStandardObjects call to allow in all\nscripts a usage like:\n\nvar Swing = new JavaImporter();\nSwing.importPackage(Packages.java.awt.event);\nSwing.importPackage(Packages.javax.swing);\nSwing.importClass(Packages.java.awt.EventQueue);\n\nand later:\n\nvar btn = new Swing.JButton()\netc.\n\nIn this way it would be possible to create ready-to-use aliases to package\ngroups in application without danger of namespace pollution.\n\nThe constructor should also allow to pass a list of packages/classes to import\nto simplify usage:\n\nvar Swing = new JavaImporter(Packages.java.awt.event,\n                             Packages.javax.swing,\n\t\t\t     Packages.java.awt.EventQueue);\n\nThe extension should be orthogonal to the current usage of ImporterTopLevel as\ntop scope object.Created attachment 150309\nImplementing JavaImporter\n\nSimultaneous usage of ImporterTopLevel as top scope and prototype object makes\nthe patch bigger then necessary. For example, it alters IdScriptable to avoid\nsetting parent scope to self causing infinite loops.Created attachment 150367\nAdditional fix: no hiding Object.prototype.constructor\n\nThe previous patch made JavaImporter a full-fetured host object constructor\nthat defines among others JavaImporter.prototype.constructor property.\n\nThis is problematic for ImporterTopLevel usage as top scope object as it makes\ntop-level constructor property to point to JavaImporter.prototype.constructor\nand not to Object.prototype.constructor.\n\nThis additional fix resolves the regression.Fixed: I committed both patches. \n\nWith the patch applied and \"with\" operator one can almost achive affect of\nglobal importPackage without adding package classes to the scope permanently:\n\nwith (new JavaImporter(Packages.java.awt.event)) {\n    var btn = new JButton();\n    ...\n}\n\nFixed: I committed both patches. \n\nWith the patch applied and \"with\" operator one can almost achive effect of\nglobal importPackage without adding package classes to the scope permanently:\n\nwith (new JavaImporter(Packages.java.awt.event)) {\n    var btn = new JButton();\n    ...\n}The example in comment 4 is wrong. A better way to demonstrate usability of\nJavaImporter is this code:\n\nvar SwingGui = JavaImporter(Packages.javax.swing,\n                            Packages.javax.swing.event,\n                            Packages.javax.swing.border,\n                            java.awt.event,\n                            java.awt.Point,\n                            java.awt.Rectangle,\n                            java.awt.Dimension);\n...\n\nwith (SwingGui) {\n    var mybutton = new JButton(test);\n    var mypoint = new Point(10, 10);\n    var myframe = new JFrame();\n...\n}Proper target milestoneCreated attachment 156272\nRegression fix\n\nThe patch (which I already committed) fixes regression reported by Merten\nSchumman:\n\nThe new implementation of importPackage/importClass assumed that thisObj should\nalways be ImporterTopLevel. But this is wrong when ImporterTopLevel is used as\ntop scope object to provide global import* functions since such scope can be a\npart of prototype chain.JavaImporter is an absolutely useful extension to Rhino IMHO, nice feature!\n   Merten',?,DESIGN_DEFECT
249471,'String index out of range exception',Rhino,Core,gustavo,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nBuild Identifier: \n\nWhen feeding the string \"-\" to the function \norg.mozilla.javascript.NativeGlobal.js_parseFloat I always get the following \nexception:\n\njava.lang.StringIndexOutOfBoundsException: String index out of range: 1\n        at java.lang.String.charAt(String.java:444)\n        at org.mozilla.javascript.NativeGlobal.js_parseFloat\n(NativeGlobal.java:296)\n        at org.mozilla.javascript.NativeGlobal.execMethod(NativeGlobal.java:171)\n        at org.mozilla.javascript.IdFunction.call(IdFunction.java:93)\n        at org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1442)\n        at org.mozilla.javascript.gen.c18._c3(commons.js:26)\n        at org.mozilla.javascript.gen.c18.call(commons.js)\n        at org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1442)\n        at org.mozilla.javascript.gen.c19._c5(customscripts.js:45)\n        at org.mozilla.javascript.gen.c19.call(customscripts.js)\n        at org.mozilla.javascript.optimizer.OptRuntime.callSimple\n(OptRuntime.java:268)\n        at org.mozilla.javascript.gen.c23._c0(<cmd>:1)\n        at org.mozilla.javascript.gen.c23.call(<cmd>)\n        at org.mozilla.javascript.gen.c23.exec(<cmd>)\n        at org.mozilla.javascript.Context.evaluateString(Context.java:1040)\n\nThe problem is with these lines:\n\n        if (c == \'+\' || c == \'-\')\n            c = s.charAt(++i);\n\nChanging them to:\n\n        if (c == \'+\' || c == \'-\')\n        {\n            if (len == 1)\n                return ScriptRuntime.NaNobj;\n            c = s.charAt(++i);\n        }\n\nsolves the problem.\n\n\n\nReproducible: Always\nSteps to Reproduce:Thanks for reporting this! Note that the additional check for len == 1 is not\nenough since it would not cover the case like \"    -\", it should be something\nlike (i + 1 != len). Patch in a moment.Created attachment 152149\nFixing parseFloat logic and Context usage cleanup.\n\nI changed number start detection code in parseFloat to check properly for lone\n+/- while making the code IMO more redable.\n\nIn addtion patch removes unused Context parameter from various functions in\nNativeGlobal including parseFloat which was remainder from pre IdFunction code.Fixed: I committed the above patchI forgot to mark bug as fixedAdding proper target milestone',?,BUG
252122,'double expansion of error message',Rhino,Core,icarr,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040707 Firefox/0.9.2\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040707 Firefox/0.9.2\n\nthe function undefWriteError in ScriptRuntime expands the message string then\ncalls typeError2 which expands the message again resulting in a confusing error\nmessage of the form:\n\nTypeError: Cannot set property \"repeat 1\" of undefined to \"Cannot set property\n\"caption\" of undefined to \"repeat 1\"\" (rule script#23)\n\ninstead of:\n\nTypeError: \"Cannot set property \"caption\" of undefined to \"repeat 1\" (rule\nscript#23)\n\nFix, remove the call to getMessage2 and pass the paramters straight to typeError2\n\npatch below\nIndex: ScriptRuntime.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v\nretrieving revision 1.181\ndiff -u -r1.181 ScriptRuntime.java\n--- ScriptRuntime.java\t8 Jun 2004 23:28:32 -0000\t1.181\n+++ ScriptRuntime.java\t19 Jul 2004 16:08:24 -0000\n@@ -2420,8 +2420,8 @@\n                                             : \"msg.undef.prop.write\";\n         String valueStr = (value instanceof Scriptable)\n                           ? value.toString() : toString(value);\n-        String msg = getMessage2(messageId, property, valueStr);\n-        return typeError2(messageId, valueStr, msg);\n+        // String msg = getMessage2(messageId, property, valueStr);\n+        return typeError2(messageId, property, valueStr);\n     }\n \n     public static RuntimeException notFoundError(Scriptable object, String\nproperty)\n\n\n\nReproducible: Always\nSteps to Reproduce:\n1.\n2.\n3.Thanks for spotting this, I will commit your patch to CVS sometime next week\nafter merging E4X extensions into Rhino.Forgotten status change: this was fixed in 1.6R1',?,CLEANUP
253323,'Assignment to variable \'decompiler\' has no effect in Parser',Rhino,Core,mcormier,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040707 Firefox/0.9.2\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040707 Firefox/0.9.2\n\nOn line 132 (as of version 1.82) of org.mozilla.javascript.Parser, the line reads:\n   this.decompiler = decompiler;\nThis assignment has no effect since there is no local variable named\n\'decompiler\', only the Parser field exists.  I suspect this is just old,\nharmless code since this.decompiler is initialized just a few lines before that,\nbut for clarity the line should be removed (or fixed if it should be initialized\nto something else!).\n\nReproducible: Always\nSteps to Reproduce:\n1.\n2.\n3.Thanks for spotting this! I committed the change to Rhino CVS.\nProper target milestone',?,BUG
254778,'Rhino treats label as separated statement',Rhino,Core,igor,igor,'Currently Rhino treats a JavaScript statement with a label as 2 separated\nstatements. This is visible in any syntax construction that is sensitive to\nnumber of statements. For example in Rhino shell the following prints ERROR!\ninstead of been silent:\n\nif (false)\n\tlabel: print(\"ERROR\");\n\nAnother example is the following syntactically correct fragment which currently\nfails with syntax errors instead of printing OK:\n\nif (true)\n\tlabel: print(\"OK\");\nelse \n\tlabel: print(\"ERROR\");Created attachment 155484\nFix: label code refactoring\n\nThe patch changes label logic to make the parser to check for all syntax errors\nrelated to label usage like duplicated labels, unknown labels in continue/break\nor continue label that does not point to a loop. After that IRFactory is asked\nto create proper labeled statements. \n\nThe refactoring simplified NodeTransformer noticeably and now all syntax errors\nare checked during parsing so NodeTransformer can always assume the correct\nparsing tree.I committed the fix',?,RFE
254915,'Broken \"this\" for name() calls (CVS tip regression)',Rhino,Core,igor,igor,'Consider this test case:\n\n/////////////////START/////////////////////////////////\nvar expect = \"something\";\n\nvar with_seed = new String(expect);\nwith_seed.valueOf2 = String.prototype.valueOf;\n\nvar value;\nwith (with_seed) {\n\twith (new Object) {\n\t\tvalue = valueOf2();\n\t}\n}\n\nif (value === expect) {\n\tprint(\"OK\");\n} else {\n\tprint(\"FAILED!\");\n}\n\t\n/////////////////END///////////////////////////////////\n\nWith CVS tip from 2004-08-09 instead of expected OK it generates:\n\njs: \"test.js\", line 12: uncaught JavaScript runtime exception: TypeError: Method\n\"valueOf\" called on incompatible object.\n\nThe reason for this is that during evaluation of valueOf2() inside the with\nstatement the code correctly locates valueOf2 in with_seed object. But then\nduring function call it uses the nearest with object (new Object in this case)\nas \"this\" for the function.Created attachment 155604\nFix: proper name lookup\n\nThe fix moves all the essential code from getNameFunctionAndThis into name() in\nScriptRuntime  where code has access to the proper scope information.\n\nI also removed no longer used ScriptRuntime.getBase and made setName to take an\nextra scope parameter for proper location of the top scope when bound argument\nis null.I committed the fix',?,BUG
255549,'JVM-dependent resolution of ambiguity when calling Java methods',Rhino,Core,igor,igor,'As of 2004-08-13 when calling overloaded Java methods Rhino does not implement\nproper ambiguity resolution as specified by LC3 specs, \nhttp://www.mozilla.org/js/liveconnect/lc3_method_overloading.html . \n\nConsider the following Java class which is based on example provided by Merten\nSchumann:\n\npublic class X\n{\n\tpublic static class Order1\n\t{\n\t\tpublic static int test(String[] array1, String[] array2, String s)\n\t\t{\n\t\t\treturn 1;\n\t\t}\n\n\t\tpublic static int test(String s1, String s2, String s)\n\t\t{\n\t\t\treturn 2;\n\t\t}\n\t}\n\n\tpublic static class Order2\n\t{\n\t\tpublic static int test(String s1, String s2, String s)\n\t\t{\n\t\t\treturn 2;\n\t\t}\n\n\t\tpublic static int test(String[] array1, String[] array2, String s)\n\t\t{\n\t\t\treturn 1;\n\t\t}\n\n\t}\n\n}\n\nAccording to LC3 the following calls\n\nPackages.X.Order1.test(\"x\", null, null)\nPackages.X.Order2.test(\"x\", null, null)\n\nshould call test(String, String, String) of X.Order1 or X.Order2 correspondingly\nsince test(String[], String[], String) is not applicable. But depending on\ncompiler and JVM in Rhino either the first line or the second line produces:\n\njs: \"test.js\", line 1: The choice of Java constructor test matching JavaScript\nargument types (string,null,null) is ambiguous; candidate constructors are: int\ntest(java.lang.String[],java.lang.String[],java.lang.String), int\ntest(java.lang.String,java.lang.String,java.lang.String)Created attachment 156055\nFix: proper ambiguity resolution\n\nThe reason for the bug is that NativeJavaMethod.findFunction tested the method\napplicability only if the search loop did not see any ambiguity yet. After that\nit would check methods only against ambiguity. Thus if JVM returns for X.Other\nclasses:\n\ntest(String[],String[],String)\ntest(String,String,String)\n\nthen code will reject the first as inapplicable and choose the second case. If\nthe order would be\n\ntest(String,String,String)\ntest(String[],String[],String)\n\nthen code will picks up first method as applicable and then see ambiguity when\ncalling second and report error.\n\nThe patch fixes that and changes loop to track all currently best fitted\nmethods instead of doing a separated search after.Created attachment 156056\nFix for the last fix\n\nThe previous patch contained broken counting of unprefered methods:\n   --worseCounr;\n\nThat should be \n    ++worseCount;I committed the fix.Many thanx for investigating/fixing this issue, Igor!!! :-)\nWill try it with next Rhino release ...\n   MertenMarking as verified since Merten Schumann confirmed that fix resolved original\nproblem.',?,BUG
255595,'Factory class for Context creation',Rhino,Core,igor,igor,'Problem: \n\nTo setup instruction counting or to override Context.FEATURE_* Rhino embedding\nshould subclass Context and then pass it explicitly to Context.enter to\nassociate it with the current thread. Unfortunately it does not work with\nJavaAdapter which calls Context.enter() in response to Java calls. If there is\nno Context instance associated with current thread, that would trigger use of\ndefault Context ignoring application wish for customization.\n\nSolution: \n\nA factory class that can be provided to Rhino runtime which will be used for\nContext creation.The initial implementation of factory API in the form of\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/src/org/mozilla/javascript/ContextFactory.java\nwas committed during spring 2004. The implementation not only allows for full\ncustomization of Context instances but also provide a way to run several\nindependent Rhino run times in one JVM. \nCreated attachment 156091\nFixing compatibility problems\n\nThe current implementation of ContextFactory introduced a couple of\ncompatibility problems:\n\n1. It started to require that when calling ScriptableObject.callMethod() a\nContext instance should be associated with the current thread. This is was done\nnot to worry about picking up proper ClassFactory.\n\n2. JavaAdapter also started to require to have active context during adapter\ncreation. This was done to select proper ContextFactory during calls to script\nmethods. This does not matter for ordinary adapter case since it is always\ncalled from a running script, but automatic function to Java interface can be\ncalled without it.\n\nTo solve this compatibility issues patch stores ContextFactory in the top scope\nwhen Context.initStandardObjects is called. In this way the factory is always\nreachable from function scope without the need to have active Context instance.I committed the fix but I will keep the bug assigned if more compatibility\nissues will pop up.Created attachment 156242\nFixing wrong assumption that Context.getFactory() != null\n\nThe previous patch introduces nasty regression reported by Merten.Schumann:\n\n> This simple stuff\n> \n>  public static void main(String args[]) throws Exception\n>  {\n>   Context cx=Context.enter();\n>   cx.initStandardObjects(null);\n>  }\n> \n> worked in former releases IMHO, now it throws\n> \n> java.lang.IllegalArgumentException\n> at\n> org.mozilla.javascript.ScriptableObject.associateValue(ScriptableObject.\n> java:1574)\n> at\n> org.mozilla.javascript.ScriptRuntime.initStandardObjects(ScriptRuntime.j\n> ava:127)\n> at org.mozilla.javascript.Context.initStandardObjects(Context.java:1108)\n> at org.mozilla.javascript.Context.initStandardObjects(Context.java:1075)\n> at de.rochade.srap.test.Snippet.main(Snippet.java:14) Exception in\n> thread \"main\" \n\nThe fix fixes that.The last fix is in CVS. The bug realy should stay open for some time.Done',?,DESIGN_DEFECT
255891,'Compatibility issue: non JS values stored as properties',Rhino,Core,igor,igor,'Although Rhino officially supported only objects of type Scriptable, String,\nNumber and Boolean, the public API did not check for that. In addition since\nduring method calls ScriptRuntime uses toObject on any non-Scriptable value and\nthat would wrap non-JS objects using LiveConnect, it was possible to call\nmethods on non JS values leading to the problem not been noticed.\n\nFor 1.6 I added explicit checks to throw exceptions about this incorrect usage,\nbut it turned out to be too problematic as was reported by Merten Schumann:\n\n-------- Original Message --------\nSubject: Re: Problem with ambiguous method - under Solaris, works in Windows\nDate: Tue, 17 Aug 2004 17:23:29 +0200\nFrom: Igor Bukanov <igor@fastmail.fm>\nTo: Merten Schumann <Merten.Schumann@asg.com>\n\nMerten Schumann wrote:\n> Hello Igor,\n> \n> sorry, found another issue with most current Rhino sources.\n> Just sending the message - although new topic - to you, if this is not\n> okay, give me a bang, but not too hard. :-)\n> \n> I think I run now into (from Kit.java) quite new method\n> \n> public static RuntimeException badTypeJS(Object x) throws\n> RuntimeException\n> {\n>  throw new IllegalArgumentException(\"Type \"+x.getClass().getName()+\" of\n> \"+x+\" is not valid JS type\");\n> }\n> \n> with my Rhino usage. I tried to make some code to reproduce it, it\'s\n> attached. Makes no sense this code, I just tried to change my existing\n> code to reproduce the problem but work in Not-Merten\'s-Environment :-).\n> \n> I think, it\'s no longer simply possible to just call methods on plain\n> Java objects which are available via property in a scope.\n\nYour code defines:\nScriptableObject.defineProperty(root, \"$$GlobalSnippet\",\n  new Snippet(\"global\"),\n   ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n\nwhich stores in root an object that is not Scriptable, Boolean, String \nor Number.\n\nBut such usage was never supported by Rhino, it should be changed to\n\nScriptableObject.defineProperty(root, \"$$GlobalSnippet\",\nContext.toObject(new Snippet(\"global\"), root),\n   ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n\nto work reliably even in older Rhino releases. Rhino 1.6 simply enforced \nthat hidden assumption.\n\nFor compatibility I will replace the error by warning reporting so your \nscripts would continue to work as is in 1.6 but the longer term advise \nis to upgrade your scripts.Created attachment 156352\nOriginal test case from Merten SchumannCreated attachment 156353\nFix: use warnings instead of errors to report non-JS typeI committed the patch: folks at helma.org confirmed that it worked for them.(In reply to comment #3)\n> I committed the patch: folks at helma.org confirmed that it worked for them.\n\nThat was comments for another bug, this should read:\n\nI committed the patch: Merten Schumann confirmed that it worked for him.\n',?,BUG
256317,'Bad references as syntax errors',Rhino,Core,igor,igor,'While working on code to implement function calls as reference to adress bug\n243057 I got impression that ECMAScript requires that all reference errors\nshould be runtime errors. So I added special parser/code generation support so\n++0 or 1 = 0 would only generate errors at runtime.\n\nBut as Brendan pointed out it is not so:\n\nBrendan Eich wrote:\n> Igor Bukanov wrote:\n> \n>> Hi!\n>>\n>> As far as I can see ECMAScript requires that ++0 should produce \n>> RuntimeError, not SyntaxError. So, for example, the following should \n>> be OK:\n>>\n>> var f = Function(\'++0\')\n>>\n>> and only during call to f RuntimeError should be generated. Microsoft \n>> JScript and KDE JavaScript implementation follows this while \n>> SpiderMonkey behaves much saner IMO and report SyntaxError during \n>> parsing. But does ECMA-267 allow this early error reporting?\n>>\n>> Regards, Igor\n> \n> \n> \n> Yes, explicitly so, per Section 16 of ECMA-262 Edition 3:\n> \n> An implementation may treat any instance of the following kinds of \n> runtime errors as a syntax error and therefore report it early:\n> \n> * Improper uses of return, break, and continue.\n> * Using the eval property other than via a direct call.\n> * Errors in regular expression literals.\n> * Attempts to call PutValue on a value that is not a reference (for \n> example, executing the assignment statement 3=4).\n> \n> The last is the one of interest here.\n> \n> /be\n\nFor this reason to make Rhino-as-syntax checker to detect more errors and to\nmatch saner SpiderMonkey behavior I suggest to report about invalid references\nduring parsing, not runtime.Created attachment 156608\nReport about invalid references during parsingI committed the patch.',?,IMPROVEMENT
256318,'NOT_FOUND and ScriptableObject.equivalentValues',Rhino,Core,igor,igor,'To implement special handling of equality operator \'==\' for XML objects the new\nmethod equivalentValues(Object value2) was added to ScriptableObject. The method\nshould return 3 possible values: true, false, noop where noop indicates that the\nobject does not have custom \'==\' for the given value.\n\nTo allow for this triple result currently the method return Boolean mapping noop\ninto null. This is all fine but rather inconsistent with XMLObject.addValues\nwhich uses Scriptable.NOT_FOUND to indicate that no custom addition operator is\navailable.\n\nFor consistency I suggest also use Scriptable.NOT_FOUND with equivalentValues\nand change return type to Object. In addition explicit Scriptable.NOT_FOUND\nindicates the intention more IMO clearly then generic null.Created attachment 156611\nNOT_FOUND as no operation tagI committed the fix',?,CLEANUP
256321,'Regression: no serialization for IdScriptableObject',Rhino,Core,igor,igor,'To simplify usage of IdScriptableObject during work on E4X implementation and to\nreduce the size of IdScriptableObject instances I added the internal class\nIdScriptableObject.PrototypeValues which stores all variables related to\nprototype id map.\n\nIn this way IdScriptableObject just needs one field, prototypeValues, to support\nid mapping for prototype objects. But I forgot about serialization: \nPrototypeValues does not implement Serializable which made IdScriptableObject\nand the wast majority of Rhino objects unserializable.Created attachment 156615\nFix: serialization restoration\n\nThe patch does not change PrototypeValues to implement Serializable interface.\nInstead it makes prototypeValues transient and during serialization of\nIdScriptableObject simply records number of prototype entries so when the\nobject is read its prototype map is restored with empty initial state.\n\nThus the patch assumes that there is no value in serialization of prototype\nentries and it OK to always rebuild them. But this is probably what the\napplication wants in any case.I committed the fix: if full serialization would be necessary (esoteric\nsituation AFAICS) the bug can be reopened but for now IdScriptableObject is\nserializable again.',?,BUG
256339,'Stackless interpreter',Rhino,Core,igor,igor,'Currently interpreter uses Java stack frame per each script frame. That limits\nscript recursion to the maximum depth of Java stack and since interpreter\nconsumes a lot of stack space for its local variables, a script that runs OK\nwith optimizer can cause StackOverflowException.\n\nSo the idea is to dynamically allocate space to hold local variables and\neliminate recursive usage of Java stack eliminating probably last limit in Rhino\non code complexity.\n\nThis should also allow to implement tail recursion optimization later and simply\nintegration of continuation patch to Rhino that was originally developed against\nRhino 1.5R2 by Christopher Oliver.Created attachment 156635\nImplementation\n\nThe patch adds the new internal class, State, and uses it to store the state of\nJS frames.\n\nThe patch wraps the current interpreter frame into additional loop that is used\nto transfer control between function and during stack unwind.\n\nThe patch tries to keep the overhead of additional indirection via caching in\nlocal variables frequently used runtime objects like stack and string table\nreferences etc.\n\nThe patch also takes advantage of the fact that catch and finally handlers are\nstatements in JS and expression stack should be empty when they executes. Thus\nit is possible to use a local variable to track stack references and\nsave/restore in to the state structure only during call/normal return\nimplementation.\n\nNote that PC counter should always be accessed through state since virtually\nall call to ScriptRuntime methods can throw catchable exceptions. So the patch\nintroduces some overhead but it also allow to simplify code since many helper\nfunctions now takes only State and Context arguments instead of stack, sdBl,\nscope etc lists.I run benchmarks from mozilla/js/benchmarks directory and on average the patch\nslows down the interpreter performance by less then 3\%. The previous comments are wrong: with the patch\nmozilla/js/benchmarks/all_bench.js runs faster by 2-3\% then without. In addition\nalthough mozilla/js/benchmarks/BenchPress.js runs slower, the difference is less\nthen 1\%.I committed the patch given the above results and the fact that with the patch\nscript recursion is really limited only by the amount of available memory.',?,IMPROVEMENT
256387,'toSource and XML objects',Rhino,Core,igor,igor,'It would be nice if XML objects would provide reasonable toSource implementationCreated attachment 156662\ntoSource implementation\n\nThe patch assumes that toXMLString always produces valid JS XML literal. \n\nThe patch also adds the indent argument to toXMLString to be implemented\nproperly later.Created attachment 156670\nExtending the previous patch to QName and NamespaceI committed the last patch',?,RFE
256389,'Proper CompilerEnvirons.isXmlAvailable()',Rhino,Core,igor,igor,'Currently CompilerEnvirons.isXmlAvailable() always return true ignoring\nContext.FEATURE_E4X flag. The method should return proper result and the class\nshould also provide a public setter to allow to customize CompilerEnvirons\nwithout using Context instance, for example, when using ClassCompiler.Created attachment 156663\nFix: check for Context.FEATURE_E4X and provide public setters\n\nThe patch implements sensitivity to Context.FEATURE_E4X and adds missing public\ngetters and setters for xmlAvailable, reservedKeywordAsIdentifier and\nallowMemberExprAsFunctionName.I committed the fix',?,BUG
256575,'Mistreatment of end-of-line and semicolon',Rhino,Core,igor,igor,'Rhino parser mistreats end-of-line and semicolon in several places:\n\n1. It consumes \';\' after \'}\' as a part of the statement. For example, it allows\nthe following code:\n\nif (condition) \n\twhile (condition2) { };\nelse \n\tsomeOtherCode;\n\nwhile in fact it should be rejected since while (condition2) { }; constitutes 2\nstatements, not one.\n\n2. It does not allow for postfix ++ and -- to follow multi-line expression. For\nexample, the following valid code is rejected:\n\n(\ni)++\n\n3. It does not generate SyntaxError if a statement that requires terminating\nsemicolon spans several lines does not have one and is followed by another\nstatement on the same line and auto-insert semicolon before the second\nstatement. I.e. while it correctly detects invalid code like:\n\n1 + 2 3\n\nit does not generate SyntaxError for\n1 +\n2 3Created attachment 156779\nTest case for shellCreated attachment 156784\nFix: refactoring of parser/tokenizer iteration\n\nTo fix the bug I decided to refactor the parsing and tokenizing interaction in\nthe following way:\n\n1. TokenStream is no longer responsible for storing pushed back token and\nalways read a token and return it. In addition TokenStream always return\nToken.EOL. \n\nTo compensate for this Parser gets few method like peekToken, consume token\netc. In addition Parser merge Token.EOL* token sequence into single\ntoken|TI_AFTER_EOL where TI_AFTER_EOL flag provides sensitivity for EOL. In\nthis way it became easier to track all eol issues and the end result is simpler\ncode in the parser that handles the test case correctly.\n\n2. The patch follows the SpiderMonkey practice and changes the parser to check\nfor well terminated statement in the single place at the end of\nstatementHelper. All statements that do not require the terminating semicolon\nsimply return from the function while those that do fall through to the\nsemicolon checks. In this way semicolon is consumed as the part of the\nstatement only if it is required.\n\nIn addition the code always autoinsert the semicolon after do-while loop to\nfollow SpiderMonkey (see bug 238945).\n\n3. The patch fixes mishandling of labeled blocks for decompiler. Now they are\ncorrectly preserved in the output source. \n\n4. The patch makes TokenStream package private and moves isJSLineTerminator to\nScriptRuntime as public method that regexp parser can use.\n\n5. The patch adds explicit ASSIGN_LSH, ASSIGN_ADD etc. tokens replacing\nASSIGNOP+op pair as it reduces code complexity.Test case run before the patch:\n\nFAILED: Postfix ++ and -- should be applicable to multiline operand like       (i\n        )++\nFAILED: Check for missed semicolon after the statement should be done even if\nthe statemen itself spans several lines and the following should produce\nSyntaxError:\n        1+\n        2 3\nFAILED: Semicolon after } should not be treated as a part of statement and the\nfollowing should produce SyntaxError:\nif (1)                                                     \n        while (0) { };                                     \nelse ;                                                     \n\nAfter the patch:\nAll is PASSED\nI committed the patch',?,BUG
256621,'throw statement: eol should not be allowed',Rhino,Core,igor,igor,'This is Rhino version of bug 256617 against SpiderMonkey:\n\nRhino accepts \nthrow \n<throw-expression>\n\nas a valid throw declaration while ECMAscript states that <eol> is not allowed\nbefore throw-expression.Created attachment 156844\nFix + consistent parser error message syntaxI committed the fix',?,SPEC
256691,'E4X: hasSimpleContent can return false for attribute names',Rhino,E4X,igor,igor,'Consider the following test case which is based on example from Richard McKinley:\n\nvar xml = <a attrname=\"something\"> <b> <c/> </b> </a> ;\nvar simple = xml.@attrname.hasSimpleContent();\nprint (simple);\n\nSince xml.@attrname is attribute this should print true in the shell. Instead it\nprints false. This is rather sensitive to the structure of <a>, even slight\nalterations restore the original behavior.\n\nThe bug is also visible in the following example:\n\nvar xml = <a attrname=\"something\"> <b> <c/> </b> </a> ;\nprint(xml.@attrname == \"something\");\n\nwhich prints false since xml == string can only be true if\nxml.hasSimpleContent() is true and that simple content equals to the string.Created attachment 156879\nFix: always assume simple content for attribute and text\n\nFor some reasons XmlCursor when it is recreated for the attribute attrname\nreturns true for toFirstChild call in the implementation of\nXML.hasSimpleContent(). It can be a bug in xmlbeans or something that I do get.\nIn any case the patch forces hasSimpleContent to return true for attribute and\npure text cursor fixing the problem.I committed the fix',?,BUG
256836,'Dynamic scope and nested functions',Rhino,Core,igor,igor,'The dynamic scope in the present form does not work with nested functions\ncreated by functions from shared scope.\n\nConsider the following modification of the example from\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/examples/DynamicScopes.java :\n\nvar x = \'sharedScope\';\nfunction f() { return x; }\nfunction initClosure(prefix) {\n    return function test() { return prefix+x; }\n}\nclosure = initClosure(\'nested:\');\n\nwhich adds closure variable to the shared scope initialized with the nested\nfunction.\n\nIf per-thread source is also modified to include call to closure:\n\nfunction g() { var x = \'local\'; return f(); }\njava.lang.System.out.println(g());\nfunction g2() { var x = \'local\'; return closure(); }\njava.lang.System.out.println(g2());\n\nthen the expected behavior for the program is to print \n\nsharedScope\nnested:sharedScope\nsharedScope\nnested:sharedScope\nsharedScope\nnested:sharedScope\nthread0\nnested:thread0\nthread1\nnested:thread1\nthread2\nnested:thread2\n\nsince the idea is that the variable x should be accessed from the thread scope\nboth in the case of f() and closure() calls.\n\nIn fact the program prints:\n\nsharedScope\nnested:sharedScope\nsharedScope\nnested:sharedScope\nsharedScope\nnested:sharedScope\nthread0\nnested:sharedScope\nthread1\nnested:sharedScope\nthread2\nnested:sharedScope\n\nwhich shows that closure() still access the shared scope while looking for x.\n\nThe reason for this is that dynamic scoping in the current form does not affect\nnested functions since they need to access their lexical scope which defines\nparent scope variables.\n\nThe proper solution for this would be to change the name lookup to patch the top\nscope dynamically. That is the name lookup when it reaches the top scope while\nlooking for the name in the scope chain should not look in the top scope but\nrather switch to the top dynamic scope.\n\nThen the question is what the top dynamic scope should be? The answer can be\nsimple: it is the top scope of the scope for the first JS stack frame.\n\nEffectively it would mean that that the name resolution when it reaches the top\nscope of the scope from the current JS stack frame should ignore it and instead\nlook for the name in the top scope of the first JS frame.\n\nBut then it does not make any sense to have per function flag and instead just\nassume one global settings that can always be on to do the right job.Created attachment 156967\nImplementation\n\nThe essential part of the patch is changes to ScriptRuntime.java. The patch\ntakes advantage of the fact that due to E4X-related changes the top scope of\nthe first JS frame is stored in Context and Context is passed to name lookup\nmethods so all the necessary information is readily available for dynamic\nalteration of scope chain lookup. \n\nIn addition patched code only switches to the dynamic top scope from the static\ntop scope only if static scope is present on the prototype chain of the dynamic\nscope. In this way only functions defined in the shared scope are affected and\ncalls across multiple private top-scope would not alter name lookup there.\n\nThen patch deprecates\nhasCompileFunctionsWithDynamicScope/setCompileFunctionsWithDynamicScope methods\nand points instead to Context.FEATURE_DYNAMIC_SCOPE. Note that the patch does\nnot change anything regarding setCompileFunctionsWithDynamicScope: the old code\nshould run as is including nested function problems. \n\nTo take advantage of this the application should explicitly overrides\nhasFeature to return true for Context.FEATURE_DYNAMIC_SCOPE as demonstrated in\nthe updated examples/DynamicScopes.java.Created attachment 156968\nDynamicScope example from the patch using new APIhttp://www.mir2.org/igor/rhino contains prebuild rhino distro with the patch appliedCreated attachment 157414\nImplementation update to reflect CVS changesI committed the patch: folks at helma.org confirmed that it worked for them',?,RFE
256865,' to be int.',Rhino,Core,igor,igor,'GCJ 3.3.* which shipped with resent Linux distributions can not compile Rhino as\nis since it crashes while compiling switch statements in ClasFileWriter. The\nreason for this is that the switch statements use byte constants and that is\nknown problem with GCJ which I believe was addressed only recently in GCJ CVS.\n\nTo simplify life for folks who would like to use Rhino with GCJ I suggest to\nimplement a workaround for this and change ByteCode.<constants> to have int\ntype. It would also require changing few prototype signatures in ClassFileWriter\nto accept int constants.Created attachment 156979\nImplementation\n\nBeyond changing ButeCode.<constant> to be int and fixing the signatures the\npatch also has to add \"0xFF &\" prefix in the single palce where ClassFileWriter\nchecks that itsCodeBuffer[] is ByteCode.TABLESWITCH.With the patch applied I can compile with gcj from GCC 3.3.3 shipped with Fedora-2:\n\nStep 1:\n\nfind src toolsrc \\\n  -name \\*.java \\\n  -not -path \'*/tools/debugger*\' \\\n  -not -name ConsoleTextArea.java \\\n  -not -name JSConsole.java \\\n| xargs gcj  -c -g -o js.o\n\nwhich generates single object file from all Rhino sources except Swing-dependent\nfiles in the debugger and shell.\n\nStep 2:\ngcj -o res.o -c \\\n  --resource org/mozilla/javascript/resources/Messages.properties \\\n  src/org/mozilla/javascript/resources/Messages.properties \n\nwhich compiles properties into res.o making\nResource.getBundle(org.mozilla.javascript.resources.Messages)\nto work.\n\nStep 3:\ngcj --main=org.mozilla.javascript.tools.shell.Main -o js js.o res.o\n\nwhich generates js executable.\n\nStep 4:\n\nIt runs!I committed the patchFixed',?,IMPROVEMENT
257128,'Interpreter and tail call elimination',Rhino,Core,igor,igor,'Given that interpreter do not use Java stack frames for JS (see bug 256339) it\nis only natural to support at least minimal form of tail call elimination so\ntail call recursion in JS would require only constant amount of memory.Created attachment 157149\nImplementation\n\nThe code generation of the patch is straightforward. It adds context flags to\nvisitExpression which defaults to 0 indicating generic context if node does not\nknow what to do about it. Then during generation of Token.RETURN the patch\ncalls visitExpression with ECF_TAIL flag to indicate the context. Then\nToken.COMMA, Token.HOOK, Token.AND and Token.OR preserve the flag for tail call\noperands and when Token.CALL gets the flag it uses Icode_TAIL_CALL instead of\nToken.CALL to indicate tail call.\n\nThe runtime part was more tricky since initially I tries to implement state and\nits stack arrays reuse. But this is too complex due to possible exceptions\nduring state reinitialization (see comments in the patch) )so at the end the\ndifference between tail and ordinary call in the patch is that the tail call\nrelease its parent and would transfer control on return to its grandparent\ninstead.Created attachment 157150\nJS test cae\n\nWithout tail call recursion eleimination the test case would create 20_000_000\nJS stack frames and even stackless interpreter would give up with OutOfMemory.\n\nWith the patch applied the test case finishes after about 45s on my Athlon\n1.2MHz Fedora box.Created attachment 157159\nImplementation2\n\nThe previous patch contains a bug: Interpreter.interpret would use initial\nstate to extract interpretation result but after tail call that state was never\nupdated with the result. The solution is to return the final state for the\nresult extraction.I committed the patch',?,IMPROVEMENT
257423,'Optimizer regression: this.name += expression generates wrong code.',Rhino,Compiler,igor,igor,'Consider the following example:\n\nfunction F()\n{\n\tthis.name = \"A\";\n\tthis.name += \"B\";\n}\n\nnew F();\n\nWith Rhino from CVS it produces with optimization mode 0 or greater:Created attachment 157408\nFix: it should ScriptRuntime.getObjectProp, not OptRuntime.thisGet\n\n\nE4X support added ScriptRuntime.getObjectProp which was equivalent to\nOptRuntime.thisGet but I forgot to update the code generation to call the new\nmethod.I cimmitted the fix(In reply to comment #0)\n> Consider the following example:\n> \n> function F()\n> {\n> \tthis.name = \"A\";\n> \tthis.name += \"B\";\n> }\n> \n> new F();\n> \n> With Rhino from CVS it produces with optimization mode 0 or greater:\n\nIt was cut, not paste for the bug output when copied the error output:\n\nException in thread \"main\" java.lang.NoSuchMethodError:\norg.mozilla.javascript.optimizer.OptRuntime.thisGet(Lorg/mozilla/javascript/Scriptable;Ljava/lang/String;Lorg/mozilla/javascript/Scriptable;)Ljava/lang/Object;\n        at org.mozilla.javascript.gen.c1._c1(/home/igor/s/x.js:4)\n        at org.mozilla.javascript.gen.c1.call(/home/igor/s/x.js)\n        at org.mozilla.javascript.BaseFunction.construct(BaseFunction.java:306)\n        at org.mozilla.javascript.ScriptRuntime.newObject(ScriptRuntime.java:2156)\n        at org.mozilla.javascript.gen.c1._c0(/home/igor/s/x.js:7)\n        at org.mozilla.javascript.gen.c1.call(/home/igor/s/x.js)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2864)\n        at org.mozilla.javascript.gen.c1.call(/home/igor/s/x.js)\n        at org.mozilla.javascript.gen.c1.exec(/home/igor/s/x.js)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:1179)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:389)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:376)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:313)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:305)\n        at org.mozilla.javascript.tools.shell.Main$1.run(Main.java:119)\n        at org.mozilla.javascript.Context.call(Context.java:498)\n        at org.mozilla.javascript.Context.call(Context.java:413)\n        at org.mozilla.javascript.tools.shell.Main.withContext(Main.java:155)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:96)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:77)\n\nNow the test works and prints nothing as expected',?,BUG
257425,'Regression: Context.toObject() should not require Context.initStandardObjects',Rhino,Core,igor,igor,'Currently Context.toObject implicitly requires prior call\nContext.initStandardObjects. That dependency should not exist. \n\nThe issue was reported by Hannes Wallnoefer at helma-dev@helma.org list:\n\nHannes Wallnoefer wrote:\n>... in Helma we\'re calling init() on the shared \n> global scope before calling initStandardObjects()  (in file \n> src/helma/scripting/rhino/RhinoCore.java):\n> \n>            global.init();\n>            global.initStandardObjects(context, false);\n> \n> With this, I get:\n> \n> Error: java.lang.IllegalStateException: Failed to find library scope\n> java.lang.IllegalStateException: Failed to find library scope\n>        at \n> org.mozilla.javascript.ScriptRuntime.getLibraryScope(ScriptRuntime.java:184) \n> \n>        at \n> org.mozilla.javascript.xml.XMLLib.extractFromScopeOrNull(XMLLib.java:46)\n>        at \n> org.mozilla.javascript.WrapFactory.wrapAsJavaObject(WrapFactory.java:148)\n>        at org.mozilla.javascript.WrapFactory.wrap(WrapFactory.java:104)\n>        at \n> helma.scripting.rhino.RhinoCore$WrapMaker.wrap(RhinoCore.java:980)\n>        at \n> org.mozilla.javascript.ScriptRuntime.toObject(ScriptRuntime.java:857)\n>        at \n> org.mozilla.javascript.ScriptRuntime.toObject(ScriptRuntime.java:817)\n>        at org.mozilla.javascript.Context.toObject(Context.java:1634)\n>        at helma.scripting.rhino.GlobalObject.init(GlobalObject.java:71)\n>        at helma.scripting.rhino.RhinoCore.<init>(RhinoCore.java:94)\n>        at \n> helma.scripting.rhino.RhinoEngine.getRhinoCore(RhinoEngine.java:134)\n>        at helma.scripting.rhino.RhinoEngine.init(RhinoEngine.java:79)\n>        at \n>\nhelma.framework.core.RequestEvaluator.initScriptingEngine(RequestEvaluator.java:86) \n> \n>        at \n> helma.framework.core.RequestEvaluator.run(RequestEvaluator.java:113)\n>        at java.lang.Thread.run(Thread.java:534)\n> \n> After looking at the code, I saw that init() expects \n> initStandardObjects() to have run already ...Created attachment 157409\nFix: return insist on library presense in ScriptRuntime.getLibraryScope\n\nTo allow for custom wrapping of objects in xml implementation WrapFactory\ncallsed XMLLib.extractFromScopeOrNull which in turns called\nScriptRuntime.getLibraryScope to find the scope where XML initialization\nhappens. But that method throwsed execption if it could not find the library.\n\nTo fix the bug I changed ScriptRuntime.getLibraryScope to return null if\nlibrary scope was not detected and renamed the method to\nScriptRuntime.getLibraryScopeOrNull.I committed the fix',?,DESIGN_DEFECT
258144,'Add option to set Runtime Class in classes generated by jsc',Rhino,Compiler,andymadigan,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040803 Firefox/0.9.3\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7) Gecko/20040803 Firefox/0.9.3\n\nI would like to have a way to specify which class main() calls in classes\ngenerated by jsc. I put a post on the mailing and followed Igor\'s suggestion.\nI\'ve made the changes in my latest CVS checkout (6 Sep 04) and run diff. Note\nthat I\'ve never run diff before so I probably did wrong. This patch adds a\n-runtime parameter to jsc. So for instance \"jsc -runime foo.bar foobar.js\" would\ngenerate a class that called main(Script sc, String[] args) in the class foo.bar\nwhere sc is an instance of the generated class. This is especially useful if you\nneed a special scope (e.g. ImporterTopLevel) for your script to run. Two public\napi methods in ClassCompiler were added and documented. (getRuntimeClass() and\nsetRuntimeClass()).\n\nReproducible: Always\nSteps to Reproduce:\nThis isn\'t a bug.Created attachment 157983\nGZipped Tar of diffs for patch.\n\nMain.diff is for org.mozilla.javascript.tools.jsc.Main, the other two are for\ntheir respective classes in org.mozilla.javascript.optimizer.(In reply to comment #1)\n> Created an attachment (id=157983)\n> GZipped Tar of diffs for patch.\n> \n> Main.diff is for org.mozilla.javascript.tools.jsc.Main, the other two are for\n> their respective classes in org.mozilla.javascript.optimizer.\n\nBut could you make single diff via \ncvs diff -uNB > mychanges.diff\n\nand then attach mychanges.diff to the bug?\n\nCreated attachment 158078\nDiff of my changes as requested\n\nThanks, I didn\'t know what command to use. One additional (and possibly\nimportant) note, the patch doesn\'t make sure that the runtime class specified\nexists.Created attachment 158096\nNo need to convert to slash form and cosmetics\n\nMy take on the above patch:\n\n1. There is no need to convert a class name in the dot form to the slash form.\nRhino class code generation library accepts that for long time (the slash form\nis required only in field and method signatures) but still there are few places\nwhere the slash form is used in class name context. \n\n2. I renamed runtimeClss to mainMethodClass which reflects the name semantics\nbetter. I keep although jsc option name as -runtime.\n\n3. Tabs are expanded to spaces.I committed the patch after renaming -runtime to -main-method-class as well.',?,RFE
258183,'catch (e if condition) does not rethrow of original exception',Rhino,Core,igor,igor,'Currently in Rhino when the conditional catch does not accept exception it is\nrethrown as JavaScriptException, not as the original exception. For example, while \n\neval(\'Bad JS Syntax\')\n\nwhen executed in the shell prints expected:\n\njs: \"<stdin>#1(eval)\", line 1: uncaught JavaScript runtime exception:\nSyntaxError: missing ; before statement\njs: Bad JS Syntax\njs: ......^\n\nthe following modification that is supposed to be semantically equivalent\nproduces different result:\n\njs> try {  eval(\'Bad JS Syntax\') }\n    catch (e if false) { }\njs: \"<stdin>\", line 3: exception from uncaught JavaScript throw: [object Error]\n\nIt  indicates that the exception is first wrapped into an script exception\nobject which is then rethrown as JavaScriptException.\n\nThe bug does not allow to classify exception properly in Java application in\ncase of catch (e if condition) blocks.Created attachment 158037\nCatch refactoring that fixes the bug among other things\n\n\n\n\n\n\nThe idea behind the patch is to to keep the original exception in a temporary\nand and special RETHROW to the parsed tree of catch (e if ..) to rethrow it.\nBut that allowed to move generation of script object representing generic\nexception to the catch itself and avoid issues with exception during catch\ngeneration: now they would bypass finally block if present.\n\nAll that adds up to hefty patch but anything that simplifies exception handling\ncode in interpreter and optimizer should be welcomed I guess.Created attachment 158043\nStress case for execption handling to verify the patchWith the patch I have for the initial problem:\n\njs> try {  eval(\'Bad JS Syntax\') }\n    catch (e if false) { }\njs: \"<stdin>#1(eval)\", line 1: uncaught JavaScript runtime exception:\nSyntaxError: missing ; before statement\njs: Bad JS Syntax\njs: ......^\n\nwhich execatly what is necessary.\n\n\nWith the patch I have for the initial problem:\n\njs> try {  eval(\'Bad JS Syntax\') }\n    catch (e if false) { }\njs: \"<stdin>#1(eval)\", line 1: uncaught JavaScript runtime exception:\nSyntaxError: missing ; before statement\njs: Bad JS Syntax\njs: ......^\n\nwhich exactly what is necessary.I committed the patch ',?,DESIGN_DEFECT
258207,'Exception name should be DontDelete',Rhino,Core,igor,igor,'According ECMAScript standard, section 12.4, the exception name in the catch\nobject should have DontDelete property. But in Rhino the name can be deleted and\nthe following test case fails with exception at runtime:\n\nvar ok = false;\n\ntry {\n\tthrow 1;\n} catch (e) {\n\tdelete e;\n\t++e;\n\tif (e === 2) {\n\t\tok = true;\n\t} \n}\n\nif (ok) {\n\tprint(\"SUCCESS\");\n} else {\n\tprint(\"FAILED\");\n}The patch in attachment 158043 for the bug 258183 contains one-line fix in\nScriptRuntime.newCatchScope that fixes the problem(In reply to comment #1)\n> The patch in attachment 158043 for the bug 258183 contains one-line fix in\n                         ^^^^^^^^^\nThat should be attchment 158037\n\nFixed: I committed the attachment 158037 for bug 258183 ',?,CLEANUP
258417,'java.lang.ArrayIndexOutOfBoundsException in org.mozilla.javascript.regexp.NativeRegExp',Rhino,Core,gilles.barnier,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: \n\nI exceeded a java.lang.ArrayIndexOutOfBoundsException.\nThe exception is raised at org.mozilla.javascript.regexp.NativeRegExp, when \naccessing gData.stateStack. I have noticed that the stateStack is a fixed size \narray, and there are no checks on its size when accessing it from the method\n    \n    executeREBytecode(REGlobalData gData, REMatchState x,\n                      char[] chars, int end)\n    in\n\n    case REOP_ALT:\n\n\n\n\nReproducible: Always\nSteps to Reproduce:\n1.\n2.\n3.\n\n\n\nExpected Results:  \ncheck array access and resize the array size if necessary.Could you post the full stack trace and sample script causing the exception? The\nstack size is precalculated during regexp parsing and index-of-bonds indicates\nthe bug in the parsing code.The array gData.stateStack is initialized in the function matchRegExp using the \nconstant:\n\n        final int INITIAL_STATESTACK = 20;\n\nWhile accessing this array from the function executeREBytecode in the case \nREOP_ALT, the array bonds are not checked and may raise an exception. \n\nUnfortunately, I cannot attach a simple example to reproduce the problem.(In reply to comment #2)\n> Unfortunately, I cannot attach a simple example to reproduce the problem.\n\nWhat about complex exemple? Without the example it would take too much time to\ntrace stack size miscalculation during parsing or improper stack head movements\nduring matching. Which in turn means the bug would not be fixed.\nIt happens in www.dmdata.dk while running the 4\'th <script> which is\n\nhttp://maerskdata.netminers.dk/tracker/dispatch.aspx?\naction=log&n=0.7196296599022292&nav=http\%3a\%2f\%2fwww.dmdata.dk\%2fdmd-index.htm\%\n3f_qpaq\%3d1&cid=maerskdata&ref=http\%3a\%2f\%\n\nBut it is simple to see that the array is accessed without a size check.\nFixed: I committed a patch to use linked list for state statck.\nCreated attachment 160912\nThis is the change in the code we made in order to make things work\n\nThe INITIAL_STATESTACK and INITIAL_BACKTRACK  have been set to 100;',?,BUG
258419,'copy paste bug in org.mozilla.javascript.regexp.NativeRegExp',Rhino,Core,gilles.barnier,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: \n\nNote the following lines in org.mozilla.javascript.regexp.NativeRegExp, method \nmatchRegExp, block (lines 2374-2376):\n\n        gData.backTrackStack = new REBackTrackData[INITIAL_BACKTRACK];\n        for (int i = 0; i < INITIAL_STATESTACK; i++)\n            gData.backTrackStack[i] = new REBackTrackData(x);\n\n\nReproducible: Always\nSteps to Reproduce:\n1.\n2.\n3.\n\n\n\nExpected Results:  \nSince the constants are equal (INITIAL_BACKTRACK and INITIAL_STATESTACK), there \nare no errors, but the for loop should be using INITIAL_BACKTRACK instead of \nINITIAL_STATESTACK.Created attachment 159110\nLinked list for backTrackStack\n\nRegexp code in Rhino is a translation of the C version in SpiderMonkey. The\ntranslation in many classes had to use quite costly Java constructions to\nfollow SM to the letter so changes in SM can easily be ported to Rhino. But\nsince regexp in SM is stabilized I think it is time to change Rhino to use more\nJVM-friendly constructions instead of fixing translation typos.\n\nFor this reason the patch replaces REBackTrackData[] backTrackStack by the\nlinked list of REBackTrackData to avoid issue with backTrackStack\ninitialization altogether and remove allocation of 20 REBackTrackData objects\nwhere most of them where unused for majority of regexp.I committed the fix',?,BUG
258844,'Continuation support in interpreter',Rhino,Core,igor,igor,'Since it turned out that the interpreter implementing calls to interpreted\nfunction and scripts without using Java stack does not add any overhead (see bug\n256339), it should be possible to add the continuation support to the\ninterpreter without slowing the scripts that do not use it.\n\nThe continuation support should provide the same level of functionality that \nChristopher Oliver patch against Rhino 1.5R4_pre brought so Cocoon\nhttp://cocoon.apache.org/ can use the new version without much efforts.Created attachment 158590\nInitial patch for experimentation\n\nThe initial path provides something to experiment with and includes:\n\n1. Continuation object that is available for scripts if \nContext.hasFeature(Context.FEATURE_INTERPRETER_CONTINUATIONS) returns true.\n\n2. Modifications to shell that adds -continuations flag to enable the feature\nand choose interpreter mode. I also added support for \"-opt -2\" to mean\n\"-continuations\".\n\n3. Interpreter changes to use \"new Continuation()\" (or just \"Continuation()\")\nto capture continuation. As with Christopher Oliver\'s patch the continuation\ncapture is lightweight and use lazy state coping but the implementation is much\nsimpler. The continuation share explicitly share vars but not internal locals\nor stack.\n\n4. Interpreter changes to restore the continuation. As with Christopher\nOliver\'s patch the control effectively returned to the place that captured\ncontinuation and then \"return result\" is executed. The control transfer\nrespects finally blocks and executes all of them that are found during stack\nunwind. The implementation allows for finally blocks during continuation\nrestore to throw exceptions or even execute continuation capture/restore with\ndefined behavior.\n\n5. Bugs.\n\n\nThinks to do:\n\n1. The patch does not contain any support for special catch\n(break|continue|return) statements since support for finally makes catch\n(break|return) unnecessary and for now catch (continue) has to use workaround.\nBut it would be nice to have some way to do re-initialization cleared by\nfinally when restoring continuation state.\n\n2. The patch do not have any support for interpretation across\nFunction.apply/call or across veal. \n\n3. There is no Java APO to restart continuation from Continuation object.Created attachment 158591\nTest to play with\n\nTo use the test -continuations should be passed to Rhino shellhttp://www.mir2.org/igor/rhino/ contains prebuilt rhino distro with the patch\napplied.Created attachment 158621\nUpdate of the initial patch to reflect CVS changes\n\nI committed few cleanups useful on their own from the patch to CVS tip to\nremove changes unrelated to continuation support from the patchCreated attachment 158637\nPatch update with debugger changes\n\nThe patch update includes changes to the debugger to allow to use debug GUI to\ndebug continuation scripts.\n\nTo test it, pass \"-continuations\" option to the debugger when invoking it:\n\njava -classpath js.jar \\\n    org.mozilla.javascript.tools.debugger.Main -continuationsCreated attachment 158640\ntest case to verify finally behaviorCreated attachment 158681\nUpdate to allow external continuation restart\n\nThe patch update that allows to call stored Continuation from Java application\nto restore its execution. For example, in Java one can use the following code\nto check that \"Object value\" is continuation and restart it passing the string\n\"Hello\" to the restoration point: \n\nif (value instanceof Function) {\n\tFunction f = (Function)value;\n\tif (\"Continuation\".equals(f.getClassName())) {\n\t\tf.call(cx, scope, null, new Object[] { \"Hello\" });\n\t}\n}\n\nNote that the valid scope has to be passed to f.call as it is uses to\ninitialize the execution top scope.Note on Context.FEATURE_INTERPRETER_CONTINUATIONS:\n\nCurrently the patch uses the feature only to initialize \"Continuation\" object\nduring the initialization of the standard host objects in\nContext.initStandardObjects(). It means that the feature should be set before\nany calls to Context.initStandardObjects(). The simplest way to do it is to\ndefine ContextFactory like in:\n\nclass MyFactory extends ContextFactory\n{\n    public boolean hasFeature(Context cx, int featureIndex)\n    {\n        // Turn on maximim compatibility with MSIE scripts\n        switch (featureIndex) {\n            case Context.FEATURE_INTERPRETER_CONTINUATIONS:\n                return true;\n        }\n        return super.hasFeature(cx, featureIndex);\n    }\n}\n\n\nand then set MyFactory as the global factory before any calls to\nContext.initStandardObjects, perhaps in some static block:\n\n     static {\n         // Initialize GlobalFactory with custom factory\n         ContextFactory.initGlobal(new MyFactory());\n     }Created attachment 158735\nUpdate to sync with CVS tipCreated attachment 158864\nUpdate with cheap restart\n\nThe patch changes continuation capture/restore logic to avoid calls frame\nduplication on stack rewind. The implementation follows implementation paper of\nSISC, http://sisc.sourceforge.net/sisc.ps.gz and during capture simply marks\nall the necessary stack frames as frozen. Then only when the frame is about to\nbe used for script execution  it is cloned. In this way during rewind it is\nnecessary to clone only the last frame that gets control.\n\nIn this way captured continuations can be used for multiple freeze/restore and\nthat would be cheap since in case of no finally frame would only be copied only\non normal return to frozen frame.I updated http://www.mir2.org/igor/rhino/ with rhino build using the patch from\nattachment 158864One \"minor\" thing: make Interpreter.CallFrame implement Serializable, otherwise \nthe continuations won\'t be serializable.\nAnother minor thing: if FEATURE_INTERPRETER_CONTINUATIONS is on, make sure \nScriptableOutputStream excludes \"Continuation\" and \"Continuation.prototype\" in \nexcludeStandardObjectNames()Created attachment 158872\nFinally not being respected\n\nI still see that a \"finally\" block enclosing continuation capture is not being\nrespected. If you try the attached script \"Finally not being respected\" you\'ll\nsee what I mean. Of course, if it\'d make implementation more complex or have\nhigher runtime overhead, then we might as well document this behavior as a\nfeature.(In reply to comment #14)\n> Created an attachment (id=158872)\n> Finally not being respected\n> \n> I still see that a \"finally\" block enclosing continuation capture is not being\n> respected. If you try the attached script \"Finally not being respected\" you\'ll\n> see what I mean. Of course, if it\'d make implementation more complex or have\n> higher runtime overhead, then we might as well document this behavior as a\n> feature.\n\nThis is by design: Continuation capture the state at the point of call to the\ncurrent function. Thus on restore the jump will be there, not to the point that\ncalled Continuation. If you change the example to:\n\nfunction captureContinuation()\n{\n    return Continuation();\n}\n\n\nvar out=java.lang.System.out;\nfunction x()\n{\n  try\n  {\n    return captureContinuation();\n  }\n  finally\n  {\n     out.println(\"finally\");\n  }\n}\n\nvar cc = x();\nout.println(cc);\nif(cc instanceof Continuation)\n{\n  cc(\"You won\'t see finally again\");\n}\n\n \nit should work.\nCreated attachment 158878\nUpdate with serialization support\n\nSince CallFrame can store in CallFrame.stack Interpreter.DBL_MARK which is\nObject it still would not be serializable even with \"implements Serializable\".\nAs a simple fix I changed DBL_MARK to be an instance of UniqueTag to ensure\nthat deserialization would map the tag back to UniqueTag.DOUBLE_MARK. It has\nadditional benefit of better debug printouts for DBL_MARK. \n\nA better solution would be to add custom read/write methods to write only used\ndata from the stack but due to potential sharing of CallFrame vars arrays it is\nnot trivial. For now DOUBLE_MARK should be good enough.Created attachment 158896\nMore serialization changes\n\nI made Interpreter.ContinuationJump to implement Serializable since class\ninstances can be stored in frame locals. \n\nhttp://www.mir2.org/igor/rhino/ is updated with binary with this patchApplying the \"More serialization changes\" patch to CVS HEAD complains about \nalready applied patches to\n\ntoolsrc/org/mozilla/javascript/tools/debugger/Dim.java\ntoolsrc/org/mozilla/javascript/tools/debugger/Main.java\ntoolsrc/org/mozilla/javascript/tools/shell/Global.java\ntoolsrc/org/mozilla/javascript/tools/shell/Main.java\n\nI guess you have already committed these to CVS...(In reply to comment #18)\n> Applying the \"More serialization changes\" patch to CVS HEAD complains about \n> already applied patches to\n> \n> toolsrc/org/mozilla/javascript/tools/debugger/Dim.java\n> toolsrc/org/mozilla/javascript/tools/debugger/Main.java\n> toolsrc/org/mozilla/javascript/tools/shell/Global.java\n> toolsrc/org/mozilla/javascript/tools/shell/Main.java\n\nAre you sure about that? I just checked with CVS tip and the cjanges are not\nthere. In addition I was able to apply the patch cleanly:\n\n~/w/js/rhino/tip> patch -p1 -i ~/s/cont.diff \npatching file src/org/mozilla/javascript/ContextFactory.java\npatching file src/org/mozilla/javascript/Context.java\npatching file src/org/mozilla/javascript/Continuation.java\npatching file src/org/mozilla/javascript/Interpreter.java\npatching file src/org/mozilla/javascript/ScriptRuntime.java\npatching file src/org/mozilla/javascript/serialize/ScriptableOutputStream.java\npatching file src/org/mozilla/javascript/UniqueTag.java\npatching file toolsrc/org/mozilla/javascript/tools/debugger/Dim.java\npatching file toolsrc/org/mozilla/javascript/tools/debugger/Main.java\npatching file toolsrc/org/mozilla/javascript/tools/shell/Global.java\npatching file toolsrc/org/mozilla/javascript/tools/shell/Main.javaCreated attachment 158984\nUpdate to reflect CVS changes\n\nI committed UniqueTag.DOUBLE_MARK and few debugger/shell changes from the patch\nto Rhino CVS since they are useful on their own. So yo test the patch either\napply it to the latest CVS tip or use http://www.mir2.org/igor/rhino/I committed the last patch to Rhino CVS. I will keep the bug open until some\ndocumentation would be written. \n\nOn the otehr to imlemement possible sysntax sugar or to allow for continuations\nto cross eval() and Function.prototype.(apply|call)() boundaries a separated\nbugs should be filed.(In reply to comment #21)\n> I committed the last patch to Rhino CVS. \n\nGreat news. Thanks for all the work on it, Igor! I\'m constantly testing it \nagainst a prototype system I have here that I have built around continuation-\nsupporting Rhino, and so far everything is peachy (altough I must admit I don\'t \nuse more advanced stuff like multiple restarts, or restarting a continuation \nfrom inside a script).Created attachment 161607\nContinuations by default\n\nThe patch enables support for Continuation object in the interpreter by default\nand removes Context.FEATURE_INTERPRETER_CONTINUATIONS since the testing shows\nthat it works OK. If necessary, the application can disable continuations\nsupport by removing Continuation from the scope after calling\nContext.initStandardObjects()\n\nIn addition patch allows to specify -2 which is turned into -1 for\ncompatibility with the original Rhino+Continuations fork.I committed the last patchOk, here\'s a problem: I invoke call() on a Continuation object from Java in a \nfreshly created context to restart a continuation that was previously serialized \nin another JVM and now deserialized. I receive this:\n\njava.lang.NullPointerException\n\tat org.mozilla.javascript.Interpreter$ContinuationJump.<init>(Interpreter.java:\n291)\n\tat org.mozilla.javascript.Interpreter.restartContinuation(Interpreter.java:\n2190)\n\tat org.mozilla.javascript.Continuation.call(Continuation.java:63)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:290)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2780)\n\tat org.mozilla.javascript.Interpreter.restartContinuation(Interpreter.java:\n2174)\n\tat org.mozilla.javascript.Continuation.call(Continuation.java:63)\n...\n\nNote that there are two invocations of Interpreter.restartContinuation on the \nstack after I call Continuation.call. At first glance, it seems that the problem \nis that null is being passed as the \"CallFrame current\" argument of the \nContinuationJump constructor in Interpreter.java:2190. It is then assigned to \nthe local variable \"chain2\" in the said constructor (line 287), and a little bit \nlater dereferenced (\"chain2.frameIndex\", line 291).\n\nIs it okay at all to restart a continuation from Java code using call() on \nContinuation?Created attachment 161853\nFix for the problem from the above comment(In reply to comment #25)\n> Is it okay at all to restart a continuation from Java code using call() on \n> Continuation?\n\nYes, this is how it supposes to work. I commited the fix for comment 25Thanks, works like charm.Here\'s a curious problem that we\'re seeing lately on continuation restarts:\n\njava.lang.ArrayIndexOutOfBoundsException: -1\n          at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2942)\n          at org.mozilla.javascript.Interpreter.restartContinuation(Interpreter.\njava:2196)\n          at org.mozilla.javascript.continuations.Continuation.\ncall(Continuation.java:75)\n          at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.\njava:301)\n          ...\n\nI\'ve tried figuring out how could it happen, but to no avail. Do you have any \nidea? I\'m sorry I can\'t provide you with more specific information at the moment \n- if you need additional information, please ask and I\'ll see what can I do. It \nhappens in a rather big environment, and so far I was unfortunately not \nsuccessful in reducing it into a reproducible testcase...(In reply to comment #30)\n> Here\'s a curious problem that we\'re seeing lately on continuation restarts:\n> \n> java.lang.ArrayIndexOutOfBoundsException: -1\n>           at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2942)\n...\n> \n> I\'ve tried figuring out how could it happen, but to no avail. Do you have any \n> idea? \n\nIt indicates that stack tracking code in Interpreter.interpret is wrong\nsomewhere. To track that down try to do the following:\n\n1. Add printout like the following before the line 2942:\nif (stackTop < 0) {\nSystem.out.println(\"BAD STACK!!!\");\nSystem.out.println(\"STACK CONTENT:\");\nfor (int ii = 0; ii != stack.length; ++ii) {\n  System.out.println(\"stack[\"+ii+\"]=\"+stack[ii]);\n}\nfor (int ii = 0; ii != stack.length; ++ii) {\n  System.out.println(\"stack[\"+ii+\"]=\"+stack[ii]);\n}\nSystem.out.println(\"Line: \"+getIndex(iCode, frame.pcSourceLineStart));\nSystem.out.println(\"Source: \"+idata.itsSourceFile);\n}\n\nThen check the script source before the line: is it close to continuation\ncapture point?Ok, here\'s a problem: we use continuations to store interpreter state, and also \nuse a top-level continuation to stop the interpreter after it captured its \nstate. The problem is that whenever we execute the top-level continuation, all \nof the finally blocks get executed, i.e. see this console session:\n\njs> c = new Continuation();\n[object Continuation]\njs> try { c(); } finally { java.lang.System.out.println(\"x\"); }\nx\n\nThis is rather undesirable for us - we don\'t want to have finally blocks \nexecuted when we terminate the interpreter using the top-level continuation. It \nis also arguable whether they should execute in the calling code whenever a \ncontinuation is resumed by being called. Is this a feature or a bug? (I can not \ndecide...)(In reply to comment #32)\n> This is rather undesirable for us - we don\'t want to have finally blocks \n> executed when we terminate the interpreter using the top-level continuation. It \n> is also arguable whether they should execute in the calling code whenever a \n> continuation is resumed by being called. Is this a feature or a bug? (I can not \n> decide...)\n\nThis is the feature. Continations are by design very similar to exceptions\nexcept they can in addition to unwinding stack also rewind it. So continuations\nhas to execute finally blocks. Otherwise when exactly finally block should be\ncalled given that continuations can restored multiple times? \n\nDuring initial work on continuations I though of adding \"initially\" block like in:\n\ntry {\n  main_code\n} initially {\n  init_code\n} finally {\n  clenup_code\n}\n\nwhich would execute init_code whenever the control reaches main_code either\nthrough normal flow or via continuation jump. Thus one can write:\n\ntry {\n  use_db_connection ane jump out_in through continuations\n} initially {\n  db_connection = create_db_connection();\n} finally {\n  db_connection.close();\n}\n\nBut that turned out to be extremely complex to implement correctly. In addition\nthere is a simple workaround for that like in:\n\ndb_connection = create_db_connection();\ntry {\n  ...\n  // after possible continuation control transfer\n  if (db_connection == null) {\n    db_connection = create_db_connection();\n  }\n\n  use_db_connection ane jump out_in through continuations\n} finally {\n  db_connection.close();\n  db_connection = null;\n}\n\nNow if you need full freeze/restore, then it is NOT continuations and can be\nimplemented on the base of continuation mashinery pretty easily via special\nmarker function. Then your native code would have to implement its own\nfinalization, but that is a different story and bug.(In reply to comment #33)\n> (In reply to comment #32)\n\nOne more thing: the test case from attachment 158640 shows the intended behavior\nof continuations which is in this case to print:\n\nfinally\nresult=1\ni=1\nB Restore\nfinally\nresult=1\ni=2\nMarking as fixed: new issues with continuations should be reported as separated bugs',?,RFE
258958,'Lookup of excluded objects in ScriptableOutputStream doesn\'t traverse prototypes/parents',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.50 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nWhen ScriptableOutputStream looks up the object to exclude from serialization, \nit doesn\'t use ScriptableObject.getProperty() but rather Scriptable.get(). As a \nresult, objects contained in the prototype or parent scope of the reference \nscope cannot be found for exclusion.\n\nReproducible: Always\nSteps to Reproduce:\nCompile and run the following class:\npublic class TestJavaScript2\n{\n    public static void main(String[] args) throws Exception\n    {\n        Context ctx = Context.enter();\n        try\n        {\n            ScriptableObject scope1 = new NativeObject();\n            ctx.initStandardObjects(scope1);\n            ScriptableObject scope2 = new NativeObject();\n            scope2.setPrototype(scope1);\n            new ScriptableOutputStream(new ByteArrayOutputStream(), scope2); \n        }\n        finally\n        {\n            Context.exit();\n        }\n    }\n}\n\nActual Results:  \njava.lang.IllegalArgumentException: Object for excluded name Object not found.\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.\naddExcludedName(ScriptableOutputStream.java:91)\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.\nexcludeStandardObjectNames(ScriptableOutputStream.java:128)\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.\n<init>(ScriptableOutputStream.java:78)\n\tat javascript.TestJavaScript2.main(TestJavaScript2.java:26)\nException in thread \"main\" \n\nExpected Results:  \nSilently succeedCreated attachment 158623\nPatch for fixing the bugCreated attachment 158631\nThe test case as standalone Java programI committed the patchMilstone info and marking as verified: the patch indeed made the tst case to work',?,BUG
258959,'ScriptableInputStream doesn\'t use Context\'s applicationClassLoader to resolve classes',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.50 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nScriptableInputStream doesn\'t use Context\'s applicationClassLoader to resolve \nclasses. As a result, in systems that set and use Context\'s \napplicationClassLoader property, deserialized Scriptable\'s might end up getting \ndeserialized with incorrect classes.\n\nReproducible: Always\nSteps to Reproduce:Created attachment 158624\nThe patch for the proposed enhancementCreated attachment 158628\nCompatibility fixes\n\nCompatibility fixes\n\nA couple of changes to the patch:\n\n1. Removal of assumption that Context.getCurrentContext() is not null. In\nprinciple if an application do not wrap serialization code into\nContext.(enter|exit) pair, then it can be considered buggy, but I would not be\nsurprised if ScriptableInputStream is constructed before calling\nContext.enter() somewhere.\n\n2. 3-arg form of Class.forName() is JDK 1.2 feature and to remain compatible\nwith the most widely deployed JVM (JDK 1.1.4-compatible JVM from Microsoft) I\nchanged that to use ClassLoader.loadClass method.Created attachment 158630\nMaking the last patch compilableI committed the last patch.\n\n',?,DESIGN_DEFECT
261278,'Strict mode',Rhino,Core,igor,igor,'It would be nice to have a strict mode in Rhino that would at least throw an\nexception for missing var declarations.Created attachment 159895\nImplementation\n\n\nThe patch adds Context.FEATURE_STRICT_MODE feature and -strict flag to Rhino\nshell that would report a runtime error for assignments to undeclared variables\nand calling eval with anything but string.With the patch I have in Rhino shell:\n\n~/rhino/tip> java -jar build/rhino1_6R1/js.jar -strict\nRhino 1.6 release 1_pre_RC2 2004 09 23\njs> x = 1\njs: \"<stdin>\", line 1: Attempt to assign non-existing name \"x\" in the strict\nmode. It could indicate a missing variable statement.\njs> eval(0)\njs: \"<stdin>\", line 2: Calling eval() with anything other than a primitive\nstring value is not allowed in the strict mode.\njs> \n\nCreated attachment 163697\nSTRICT_MODE -> STRICT_VARS + STRICT_EVAL\n\n\nThe patch splits Context.FEATURE_STRICT_MODE into Context.FEATURE_STRICT_VARS\nand Context.FEATURE_STRICT_EVAL\n\nIn this way the Rhino embeddings will be immune from extending strict mode\nnotion to other areas like disabling automatic semicolon insertion. But the\npatch keeps -strict flag in the shell to mean all currently implemented\nstrictness.I committed the relevant patches.',?,RFE
262447,'NullPointerException in ScriptableObject.getPropertyIds',Rhino,Core,igor,igor,'Ugo Cei reported a bad bug in ScriptableObject.getPropertyIds:\n\n\n-------- Original Message --------\nSubject: Re: Using reflection with Rhino \"beans\"\nDate: Fri, 1 Oct 2004 15:40:28 +0200\nFrom: Ugo Cei <ugo.cei@gmail.com>\nReply-To: Ugo Cei <ugo.cei@gmail.com>\nTo: Igor Bukanov <igor@fastmail.fm>\nReferences: <mailman.1096543021.23721.mozilla-jseng@mozilla.org>\t\n<415BFB7D.9000809@fastmail.fm>\t <3c15c967041001011978e6e94d@mail.gmail.com>\t\n<415D2D5D.8030508@fastmail.fm>\n\nIf I do that, I get an NPE:\n\njava.lang.NullPointerException\n\tat\norg.mozilla.javascript.ScriptableObject.getPropertyIds(ScriptableObject.java:1441)\n\tat org.mozilla.javascript.JavaAdapter.getObjectFunctionNames(JavaAdapter.java:266)\n\tat org.mozilla.javascript.JavaAdapter.getAdapterClass(JavaAdapter.java:292)\n\tat org.mozilla.javascript.JavaAdapter.js_createAdpter(JavaAdapter.java:190)\n\tat org.mozilla.javascript.JavaAdapter.execIdCall(JavaAdapter.java:120)\n\tat org.mozilla.javascript.IdFunctionObject.call(IdFunctionObject.java:121)\n\tat org.mozilla.javascript.Context.call(Context.java:500)\n\tat org.mozilla.javascript.ScriptableObject.callMethod(ScriptableObject.java:1495)\n\tat org.mozilla.javascript.ScriptableObject.callMethod(ScriptableObject.java:1466)\nimport junit.framework.TestCase;\n\nHere\'s a simple JUnit testcase that demonstrates the problem:\n\nimport org.mozilla.javascript.Context;\nimport org.mozilla.javascript.Scriptable;\nimport org.mozilla.javascript.ScriptableObject;\nimport org.mozilla.javascript.Wrapper;\n\npublic class RhinoTest extends TestCase {\n\n    private final String source = \"function PropertyHello() {\\n\" +\n    \"this.message = \'hello world\';\\n\" +\n    \"}\\n\" +\n    \"PropertyHello.prototype.sayHello = function() {\\n\" +\n    \"    return this.message;\\n\" +\n    \"}\\n\" +\n    \"PropertyHello.prototype.getMessage = function() {\\n\" +\n    \"       return this.message;\\n\" +\n    \"}\\n\" +\n    \"PropertyHello.prototype.setMessage = function(message) {\\n\" +\n    \"       this.message = message;\\n\" +\n    \"}\";\n\n    public void testAdapter() {\n        Context jsContext = Context.enter();\n        Scriptable scope = jsContext.initStandardObjects();\n        jsContext.evaluateString(scope, source, \"<cmd>\", 1, null);\n        Scriptable obj = jsContext.newObject(scope, \"PropertyHello\");\n        Object adapter = ScriptableObject.callMethod(scope, \"JavaAdapter\",\n                new Object[] { obj });\n        Object bean = ((Wrapper) adapter).unwrap();\n        assertNotNull(bean);\n    }\n}Created attachment 160743\nTest case as standalone Java sourceCreated attachment 160744\nFix\n\nThe desire not to allocate ObjToIntMap was too strong when I added that code.I committed the fix.',?,BUG
262687,'Rhino does not compile with JDK 1.5',Rhino,Core,bugzilla,igor,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.3) Gecko/20041001\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.3) Gecko/20041001\n\nJDK 1.5 introduced a new constructor which causes an ambiguity when compiling\nrhino. I will attach a patch to fix the problem.\n\nReproducible: Always\nSteps to Reproduce:\n1. compile rhino with JDK 1.5\n\nActual Results:  \ncompile errorCreated attachment 160909\nPatch to fix JDK1.5 compile problem\n\nThis new constructor causes the compile problems:\n\npublic CodeSource(URL url, CodeSigner[] signers)\n\n[...]\n\n    Since: 1.5\n\nThe patch states which constructor to use.I committed the fix.',?,BUG
263934,'XMLList assign produces bogus result',Rhino,E4X,igor,nobody,'-------- Original Message --------\nSubject: Found a few E4X bugs\nDate: Fri, 30 Jul 2004 16:47:40 -0700\nFrom: John Schneider <john.schneider@agiledelta.com>\nReply-To: <john.schneider@agiledelta.com>\nOrganization: AgileDelta, Inc.\n\nDescription: Replacing a list item with a new list that contains that item\ncauses incorrect result.\n\nTest case:\n\n\tvar x = <x>\n\t\t\t<b>two</b>\n\t\t\t<b>three</b>\n\t\t  </x>;\n\n\t// insert <a> element in from of first <b> element\n\tx.b[0] = <a>one</a> + x.b[0];\n\n\tprint(x);\n\nExpected:\n\n\t<x>\n\t\t<a>one</a>\n\t\t<b>two</b>\n\t\t<b>three</b>\n\t</x>\n\nActual:\n\n\t<x>\n\t\t<a>one</a>\n\t\t<a>one</a>\n\t\t<b>three</b>\n\t</x>Wrong bug to resolveI found a similar problem when appending elements using the += operator. The\nproblem only appears if there are space characters between tags in the existing\nlist and XML.ignoreWhitespace is set to false. Here\'s how to reproduce it in\nRhino shell:\n\njs> XML.ignoreWhitespace = false;\nfalse\njs> var xml = <a> <b/><b/></a>;\njs> xml.b += <c/>;\n<b/>\n<b/>\n<c/>\njs> print(xml);\n<a>\n  <b/>\n</a>\njs>\n\nThe expected result from print(xml) would be \n\n<a>\n  <b/>\n  <b/>\n  <c/>\n</a>\n\nNote that if I leave away the space char in the original XML literal, or don\'t\nset XML.ignoreWhitespace to false, the result is as expected. If I add more\nspaces, I get other bogus results. \n\nShould I file a new bug for this? Are there any insights on the original bug,\nsuch as where to look, and if this is a Rhino or a XMLBeans bug?Marking as fixed: new issues should be reported as bugsI \"fixed\" the wrong bug.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This issue is fixed in the coming non-XMLBeans implementation of E4X, or at least the first issue is.  The test in comment #2 gives output other than that suggested, but I\'m not sure which is right.  The output given is:\n\n<a>\n\n  <b/>\n  <b/>\n  <c/>\n</a>\n\nI\'d have to carefully go back to the pretty-printing part of the spec to see whether the extra newline is appropriate given the presence of a non-empty text node in there.My reading of ECMA357 2nd ed. 10.2.1 is that the output in comment 6 is correct, thus I am closing this bug as fixed (if XMLBeans is not present, of course; see bug 355677).Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
263935,'Bogus namespace match with qualified name',Rhino,E4X,igor,nobody,'-------- Original Message --------\nSubject: Found a few E4X bugs\nDate: Fri, 30 Jul 2004 16:47:40 -0700\nFrom: John Schneider <john.schneider@agiledelta.com>\nReply-To: <john.schneider@agiledelta.com>\nOrganization: AgileDelta, Inc.\n\nDescription: Qualified names specifying all names in no namespace, match all\nnames in all namespaces\n\nTest case:\n\n\tvar ns1 = new Namespace(\"http://www.ns1.com\");\n\tvar ns2 = new Namespace(\"http://www.ns2.com\");\n\tvar none = new Namespace();\n\tvar x = <x/>\n\tx.foo = \"one\";\n\tx.ns1::foo = \"two\";\n\tx.ns2::foo = \"three\";\n\tx.bar = \"four\";\n\n\t// print all names in no namespace \n\tprint(x.none::*);\n\t\t\t\n\nExpected:\n\n\t<foo>one</foo>\n\t<bar>four</bar>\n\nActual:\n\n\t<foo>one</foo>\n\t<ns1:foo xmlns:ns1=\"http://www.ns1.com\">two</ns1:foo>\n\t<ns2:foo xmlns:ns2=\"http://www.ns2.com\">three</ns2:foo>\n\t<bar>four</bar>\n\t\n-------------------------Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Rhino now processes this correctly if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
263936,'Bogus list element replace',Rhino,E4X,igor,nobody,'-------- Original Message --------\nSubject: Found a few E4X bugs\nDate: Fri, 30 Jul 2004 16:47:40 -0700\nFrom: John Schneider <john.schneider@agiledelta.com>\nReply-To: <john.schneider@agiledelta.com>\nOrganization: AgileDelta, Inc.\n\nDescription: Replacing an element with a list that contains a text node,\nchanges the text node into an element.\n\nTest case:\n\n\tvar x = <x>\n\t\t\t<a>one</a>\n\t\t\t<b>three</b>\n\t\t  </x>;\n\n\t// insert a text node \"two\" between elements <a> and <b>\n\tx.a += XML(\"two\");\n\n\tprint(x);\n\nExpected:\n\n\t<x>\n\t\t<a>one</a>\n\t\ttwo\n\t\t<b>three</b>\n\t</x>\n\t\nActual:\n\n\t<x>\n\t\t<a>one</a>\n\t\t<a>two</a>\n\t\t<b>three</b>\n\t</x>Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the upcoming native-DOM implementation of E4X; see bug 355677.Rhino now passes the regression test in mozilla/js/tests/e4x/Regress/regress-263936.js if XMLBeans is not present.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
263978,'cannot run xalan example with Rhino 1.5 release 5',Rhino,Core,tony.wong,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\nBuild Identifier: \n\nI have encountered the same problem as mentioned in the quoted URL. The Rhino \n1.5 release 5 gives a \"Line number can not be negative: -1\" error when execute \nXSL with javascript.\n\nReproducible: Always\nSteps to Reproduce:\n1.\n2.\n3.I guess this is a bug in BSF that supplied the wrong argument to Rhino API.\nPreviously Rhino converted -1 to 0 but since 1.5R5 Rhno throws\nIllegalArgumentException instead.Created attachment 162254\nFix: restoring compatibility with BSF usageI committed the patch: incompatibility with BSF are too annoying to ignore it',?,BUG
264369,'\' not  compliant with 10.2.1.1 of ECMA 357',Rhino,E4X,kthomas,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7a) Gecko/20040219\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7a) Gecko/20040219\n\nSpec says \na. If (c == \"<\"), let r be the result of concatenating r and the string\"&lt;\"\nb. Else if (c == \">\"), let r be the result of concatenating r and the string \"&gt;\"\nc. Else if (c == \"&\"), let r be the result of concatenating r and the string \"&amp;\"\n\nRhino is not obeying b.\n\n\n\nReproducible: Always\nSteps to Reproduce:\n1. Execute this code:\n\nx = <a/>;\nchars = \"<>&\";\nx.b = chars;\n\n2. Inspect x.toXMLString()\n\n\nActual Results:  \n<a>\n  <b>&lt;>&amp;</b>\n</a>\n\nExpected Results:  \n<a>\n  <b>&lt;&gt;&amp;</b>\n</a>\n\nI believe that if < is autoescaped, > should be also. Otherwise we\'re breaking\npeople\'s XML (and not complying with ECMA 357 10.2.1.1, I think). \n\nAs a side issue, I think ECMA 357 10.2.1.1 should have gone all the way and\nspecified escaping all of the XML illegals, including \' and \".  Otherwise a lot\nof illegal XML gets created.  As it now stands, ECMA 357 and XInclude\n(text-mode) are out of agreement. I think it would be good if they agreed on how\nto handle all 5 XML illegals.Please file Rhino bugs against the Rhino bugzilla.mozilla.org product.\n\n/be(In reply to comment #0)\n\n> As a side issue, I think ECMA 357 10.2.1.1 should have gone all the way and\n> specified escaping all of the XML illegals, including \' and \".  Otherwise a lot\n> of illegal XML gets created.  As it now stands, ECMA 357 and XInclude\n> (text-mode) are out of agreement. I think it would be good if they agreed on how\n> to handle all 5 XML illegals.\n\nWhy do you think that \', \", and > are illegal? Here is a mail from Eric Vasilik\nthat I got when investigating the issue (Rhino uses http://xmlbeans.apache.org/\nto implement E4X and directly call xmlText method there): \n\n\n\n-------- Original Message --------\nSubject: RE: No escape for \'>\' ?\nDate: Fri, 15 Oct 2004 11:31:46 -0700\nFrom: Eric Vasilik\nReply-To: user@xmlbeans.apache.org\nTo: <user@xmlbeans.apache.org>\n\nI do not believe that \"<a>&lt;>&amp;</a>\" is invalid.  The \'>\' character\ndoes not need to be escaped.  Here is the BNF for char data from the XML\nspec.\n\n[14]    CharData    ::=    [^<&]* - ([^<&]* \']]>\' [^<&]*) \n\nIt requires that there are no un-escaped \'&\' or \'<\' characters, as well\nas the CDATA terminating character sequence.\n\n- Eric\n\n\n> -----Original Message-----\n> From: Igor Bukanov [mailto:igor@fastmail.fm]\n> Sent: Friday, October 15, 2004 6:10 AM\n> To: user@xmlbeans.apache.org\n> Subject: No escape for \'>\' ?\n> \n> Hi!\n> \n> It seems that xmlText() does not escape \'>\'. For example,\n> xmlCursor.xmlText() when xmlCursor points to a XML fragement\n<a>TEXT</a>\n> where TEXT is \"<>&\" produces  instead of the expected\n> <a>&lt;&gt;&amp;</a>\n> the following invalid XML:\n> <a>&lt;>&amp;</a>\n> \n> Regards, Igor\nReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the upcoming DOM-only (non-XMLBeans) version of E4X support.  See bug 355677.Rhino now passes this test if XMLBeans is not present (see bug 355677).Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
264637,'InterpretedFunction memory footprint could be lighter',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.54 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nThe boolean flag \"evalScriptFlag\" in the class InterpretedFunction could be \nmoved to InterpretedData. This would make InterpretedFunction (of which one \ninstance is created per declared function per script execution) lighter, on \nexpense of InterpretedData (of which one instance is created per declared \nfunction per script parsing).\n\nWith support for continuations in 1.6, it is also important to be able to stub \nout as much of the objects representing an interpreted function as possible when \nserializing interim state, and reconnect to the already present shared instances \nupon deserialization. It is therefore important to push as much of the immutable \nstate as possible to InterpreterData class - I will likely follow up with \nproposals for further reductions in InterpretedFunction\'s base class, \nNativeFunction. \n\nReproducible: Always\nSteps to Reproduce:Created attachment 162289\npatch for moving evalScriptFlag from InterpretedFunction class to InterpreterData classI committed the patch: it is sufficiently simple not to cause any problems.Created attachment 162381\nPatch to remove NativeFunction.(version|argNames|argCount)\n\n\nThe patch replaces version|argNames|argCount fields in NativeFunction by\ngetLanguageVersion()|getParamCount()|getParamAndVarCount()|getParamOrVarName(int\n\nindex) abstract methods.\n\nFor the interpreted mode the methods are then trivially implemented in\nInterpretedFunction using information stored in InterpreterData. \n\nFor the class compilation mode patch adds code to generate methods\'\nimplementations using data embedded in the generated class file. In this way\nfor the class compiler the patch not only removes 3 fields from each function\ninstance but also avoids the construction of argNames array replacing the\nbytecode to initialize it by the bytecode to do the switch over var index. \n\nThe patch also replaces extending from NativeFunction in\nNativeScript|NativeRegExpCtor classes by the proper extending from BaseFunction\n\nwhich was a oversight left from pre-1.5R5 reorganization of code generation.(In reply to comment #3)\n> Created an attachment (id=162381)\n> Patch to remove NativeFunction.(version|argNames|argCount)\n> \n\nWow - this indeed sounds as a great improvement. \n\nA coworker who\'s intensively working on JavaScript apps will probably kick in \nlater today to work with it, so any glaring bugs should become apparent rather \nquickly. I myself have been running some tests with it, and so far it looks \nokay.\n\nNow, risking that I\'ll come across as becoming too greedy, I assume \n\"functionName\" in BaseFunction could also undergo a similar treatment of being \nreplaced with an abstract getFunctionName() method, couldn\'t it? The function \nname is either calculable from other data (FieldAndMethods, overloaded case of \nNativeJavaMethod*, NativeJavaConstructor, InterpetedFunction) or fixed \n(NativeRegExpCtor) in lots of subclasses.\n\n[*] Of course, it also has a constructor with explicit name, but that could \nreally be handled by a separate subclass named \"NamedNativeJavaMethod\" or \nsomething similar - note the case of NativeJavaMethod that takes Method[] as \nargument (and by inference, all instances of FieldsAndMethods class) don\'t need \nthe functionName field as they directly use the Java method name as their name.\nCreated attachment 171502\nPatch to replace BaseFunction.functionName by BaseFunction.getFunctionName()The patch was committed some time ago.',?,IMPROVEMENT
266418,'Can not serialize regular expressions',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.54 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nAn attempt to serialize a regular expression (i.e. as part of a continuation) \nwill fail since the classes org.mozilla.javascript.regexp.RECompiled and org.\nmozilla.javascript.regexp.RECharSet (defined in file NativeRegExp.java) are not \nserializable.\n\nReproducible: Always\nSteps to Reproduce:\nExecute the following snippet of Java code:\n\nContext cx = Context.enter();\nScriptableObject s1 = new NativeObject();\ncx.initStandardObjects(s1);\ncx.compileString(\"var x = /^\\\\s*(.*)/;\", \"\", 1, null).exec(cx, s1);\nnew ScriptableOutputStream(new ByteArrayOutputStream(), s1).writeObject(s1.\nget(\"x\", s1));\nActual Results:  \nThe following exception was thrown:\n\njava.io.NotSerializableException: org.mozilla.javascript.regexp.RECompiled\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1054)\n\tat java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1332)\n\tat java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1304)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1247)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n\tat Test.main(Test.java:31)\n\nExpected Results:  \nsilently succeedCan somebody reassure me that regexp literals occurring in a script using the /.\n../ syntax are stored inside inside InterpretedData, so if I\'m taking care to \nstub InterpretedData instances in serialization, they won\'t get serialized at \nall, and this problem only arises if a regexp is dinamically constructed by a \nscript. Right?Created attachment 163670\nPatch to make NativeRegExp serializable \n\nThe patch adds \"impelments Serializable\" to classes representing compiled\nregexps and ads proper synchronization for code to initialize RECharSet lazily.(In reply to comment #1)\n> Can somebody reassure me that regexp literals occurring in a script using the /.\n> ../ syntax are stored inside inside InterpretedData, so if I\'m taking care to \n> stub InterpretedData instances in serialization, they won\'t get serialized at \n> all, and this problem only arises if a regexp is dinamically constructed by a \n> script. Right?\n\nAlthough its true that compiled scripts are stored in the InterpreterData, they\nstill will be serialized even if InterpreterData would be stubbed.\n\nInterpreterFunction during initialization wraps the compiled regexps as\nNativeRegExp to store them in InterpreterFunction.functionRegExps and that\nforces serialization.\n\nI committed the fix.(In reply to comment #3)\n\nWould it be possible to add some kind of public accessor to InterpeterData.\nitsRegExpLiterals, either through the DebuggableScript interface or some other \nway? That way I could access its elements to create stubs for them too.\n',?,DESIGN_DEFECT
271401,'JS prototypes for superclasses with ScriptableObject.defineClass',Rhino,Core,djgredler,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0\n\nClasses that extend ScriptableObject cannot use polymorphism to define\nJavaScript-accessible properties and functions, because\nFunctionObject.getMethodList(Class) uses Class.getDeclaredMethods() instead of\nClass.getMethods() whenever it can, apparently as an optimization. The reason\nthat getDeclaredMethods() is faster is that they are fundamentally different\nmethods: getDeclaredMethods() excludes inherited methods, but getMethods()\nincludes them. So for example if I have:\n\npublic class A extends ScriptableObject {\n  public String jsGet_name() {\n    return \"A\";\n  }\n}\n\npublic class B extends A {\n}\n\nthen as far as the JavaScript is concerned, an instance of B does not have a\nproperty \"name\". Unless, of course, calling getDeclaredMethods() fails with a\nSecurityException, in which case FunctionObject will use getMethods(), and\ninstances of B *will* have a property \"name\".\n\nReproducible: Always\nSteps to Reproduce:\n1. Create a Java class A that extends ScriptableObject and has a JavaScript\nattribute \"att\".\n2. Create a Java class B that extends A.\n3. In JavaScript, create an instance of B and try to access inherited attribute\n\"att\".\n\nActual Results:  \nThe attribute \"att\" cannot be found comes back as undefined.\n\nExpected Results:  \nThe attribute \"att\" should have been found via polymorphism, in class A.Marking as invalid:\n\nScritableObject use getDeclaredMethods by design to allow to implement host\nobjects that follow prototype-based inheritance of JavaScript runtime. To get\nwhat you need to set the prototype chain of B.prototype to A.prototype in JS.\nFor example, use something like:\n\n\npublic class A extends ScriptableObject {\n  \n  public getClassName() { return \"A\"; }\n  \n  public String jsGet_name() {\n    return \"A\";\n  }\n}\n\npublic class B extends A {\n  public getClassName() { return \"B\"; }\n}\n\n....\n\nScriptableObject.defineClass(scope, A.class);\nScriptableObject.defineClass(scope, B.class);\n\nScriptableObject.getClassPrototype(scope, \"B\").\n\tsetPrototype(ScriptableObject.getClassPrototype(scope, \"A\"));\n\t\n\nNow in JS the following would work:\n\nvar b = new B();\nprint(b.name); // should call jsGet_name\n\nprint(b instanceof B); // should print true\nprint(b instanceof A); // should also print true\n\nNote also that comments in FunctionObject refer to the fact that some JVMs with\nSecurityManager installed getDeclaredMaethods() may throw an exception while\ngetMethods() works so as a workaround code calls getMethods() and strip\nsuper-class only methods.My complaint is that:\n1) getDeclaredMethods() is used if possible (it should never be used)\n2) if getMethods() is used, super-class methods are stripped (they should always\nbe included)\n\nI don\'t think super-class methods should ever be excluded, thus I don\'t think\ngetDeclaredMethods should ever be used. I don\'t see the sense in only allowing\naccess to declared methods, not inherited methods. That\'s the whole point of\nJava: polymorphism.\n\nMy use case is HttpUnit, by the way. HTMLElement extends ScriptableObject, and\nDocument extends HTMLElement. I don\'t understand why I need to override a\nproperty in Document that is already defined in HTMLElement. It\'s nonsensical in\nan OO world.\n> \n> My use case is HttpUnit, by the way. HTMLElement extends ScriptableObject, and\n> Document extends HTMLElement. I don\'t understand why I need to override a\n> property in Document that is already defined in HTMLElement. It\'s nonsensical in\n> an OO world.\n\nScriptableObject machinery is intended to support JavaScript prototype-based\ninheritance which is very different from class-based inheritance og Java. \n\nI also think that using ScriptableObject as a base for \nDOM objects is not a very idea. It is much better IMO to create something\nsimilar to NativeJavaObject+dependable classes to create a special wrapper for\nJava DOM. In at least one Java-based browser it allowed to emulate all MSIE-5.5\nspecific peculiarities and shortcuts for DOM.I think I understand what you\'re saying, but let me ask a couple of questions\njust to make sure:\n\n> ScriptableObject machinery is intended to support JavaScript\n> prototype-based inheritance which is very different from class-based\n> inheritance of Java.\n\nGiven that the two inheritance mechanisms are fundamentally different, would it\nbe ludicrous to maybe map from one to the other automatically when\nScriptableObject.defineClass() gets called? So the setting of the prototypes\nwould occur automatically based on the inheritance tree of the Java class\nspecified. Maybe even do this optionally be adding a boolean parameter to\ndefineClass(). It may be a stupid question, given that you think this is the\nwrong way to solve our problem, regardless.\n\n> I also think that using ScriptableObject as a base for DOM objects is\n> not a very [good] idea.\n\nWhy is this not the best way to do it? What problem was ScriptableObject meant\nto solve if not this one?\n\n> It is much better IMO to create something similar to\n> NativeJavaObject + dependable classes to create a special wrapper\n> for Java DOM.\n\nBy \"dependable classes\" do you mean NativeJavaArray, NativeJavaClass,\nNativeJavaMethod, etc?\n\n> In at least one Java-based browser it allowed to emulate all\n> MSIE-5.5 specific peculiarities and shortcuts for DOM.\n\nWell, that\'s what we\'re trying to do, ultimately :) What browser was this? Is\nthe code open?\n\nThanks for clarifying all this!\n(In reply to comment #4)\n> \n> Given that the two inheritance mechanisms are fundamentally different, would it\n> be ludicrous to maybe map from one to the other automatically when\n> ScriptableObject.defineClass() gets called? So the setting of the prototypes\n> would occur automatically based on the inheritance tree of the Java class\n> specified. Maybe even do this optionally be adding a boolean parameter to\n> defineClass(). \n\nOriginally ScriptableObject was heavily used to implement the standard\nECMAScript objects like Array, Data, Math etc where automatic Java inheritance\nwould bring more harm then explicit prototype chain manipulation due to numerous\nspecial cases. Later it was replaced by explicit string switches to gain\nsignificantly in performance and reduce memory consumption. \n\nNow Rhino does not use ScriptableObject support for jsGet_ etc internally and it\nis intended as a simple way for applications to create host objects that\nresemble the standard objects. Thus automated support for inheritance chain\nwould indeed lead to less surprises in application code and would not affect\nRhino internals but then somebody has to write the code.\n> \n> > I also think that using ScriptableObject as a base for DOM objects is\n> > not a very [good] idea.\n> \n> Why is this not the best way to do it? What problem was ScriptableObject meant\n> to solve if not this one?\n\nYou already have implementation of DOM interfaces in Java, right? In this case\nyou would end up with js_ wrapper methods that would simply call their\ncounterpart in Java DOM world.\n\nBut even if you create JS-only implementation, then JavaScript bindings would\noften require (as far as I remember) direct access to JS arguments array forcing\nto use generic jsFunction_xxx(Context cx, Scriptable thisObj, Object[] args,\nFunction funObj) form with manual type conversion. Plus the fact that Rhino does\nnot pass scope argument can cause problems when access to that argument is\nrequired to get the right frame reference.\n\nAnd memory consumption/initialization time is much higher since you would need\nto store all those constructor/prototype objects in the scope which even with\nlazy initialization is costly.\n\n> \n> > It is much better IMO to create something similar to\n> > NativeJavaObject + dependable classes to create a special wrapper\n> > for Java DOM.\n> \n> By \"dependable classes\" do you mean NativeJavaArray, NativeJavaClass,\n> NativeJavaMethod, etc?\n\nIt is not that bad, you need just a copy of NativeJavaObject, JavaMemebers and\nNativeJavaMethod. Then you can strip from the copies any support for static\nfunctions and public fields simplifying code significantly. Then if you have\nJava implementation of HTMLSomething interfaces it would be simple to implement,\nfor example, collection mapping from a[i] into a.item(i) or provide various\naliases for methods.\n\n> \n> > In at least one Java-based browser it allowed to emulate all\n> > MSIE-5.5 specific peculiarities and shortcuts for DOM.\n> \n> Well, that\'s what we\'re trying to do, ultimately :) What browser was this? \n\nICEbrowser, www.icesoft.com (Declaimer: I worked for them in past)\n\n>Is the code open?\n> \n\nNope.> It is not that bad, you need just a copy of NativeJavaObject,\n> JavaMemebers and NativeJavaMethod. Then you can strip from the\n> copies any support for static functions and public fields\n> simplifying code significantly. Then if you have Java\n> implementation of HTMLSomething interfaces it would be simple to\n> implement, for example, collection mapping from a[i] into a.item(i)\n> or provide various aliases for methods.\n\nDo you have any examples of doing this? All the examples on the website use\neither the Scriptable interface, or the default implementation,\nScriptableObject. I can\'t find any examples of doing it the way you mention.\n\nAlso, has it been absolutely ruled out to provide a DOM implementation in Rhino\nitself, since most JavaScript is used to manipulate HTML documents? It just\nseems that many projects that use Rhino have to roll their own DOM host objects,\nand it would be much easier to pool resources and effort and have just one\nimplementation.\nSorry, I can not provide examples. And you are right that this not documented.\nAnd certanly DOM implementation in Rhino would be extremely welcome. But it\nwould remain like that until somebody writes it. \n\nUnfortunately I can not help with this much since besides the lack of time a\nsomewhat traumatic experience of trying to support all MSIE 5 quirks few years\nago lead to inevitable desire to avoid writing anything related to Java\nimplementation of MSIE DOM ;)\nCreated attachment 168021\nmap Java inheritance to JS prototype-based inheritance\n\n> Now Rhino does not use ScriptableObject support for jsGet_ etc\n> internally and it is intended as a simple way for applications\n> to create host objects that resemble the standard objects. Thus\n> automated support for inheritance chain would indeed lead to\n> less surprises in application code and would not affect Rhino\n> internals but then somebody has to write the code.\n\nI\'m attaching a patch that does just this. This is my first time tinkering with\nRhino internals, so please advise as to possible improvements.Comment on attachment 168021\nmap Java inheritance to JS prototype-based inheritance\n\n> \n>+        // Map Java inheritance to JS prototype-based inheritance.\n>+        Class superclass = clazz.getSuperclass();\n>+        if (superclass != null) {\n>+            String name = superclass.getName();\n>+            Scriptable superProto = ScriptableObject.getClassPrototype(scope, name);\n>+            if (superProto != null) {\n>+                proto.setPrototype(superProto);\n>+            }\n>+        }\n>+\n\nThat does not work since the name of Java class and the name of constructor\nobject also known as JS \"class\" object (like String, Date, Array etc.) are\nunrelated and you need the later here. But to get that you need an instance of\nthe superclass to be able to call getClassName on it. \n\nOne possibility would be to have a version of defineClass that loops through\nthe parent chain defining the necessary classes if that is not already done.Created attachment 168034\nmap Java inheritance to JS prototype-based inheritance\n\nI didn\'t realize the the class name was not the Java class name in that\ncontext. Here\'s another patch, let me know what you think. It changes the\ndefineClass API so that it returns the class name of the prototype defined,\nwhich wouldn\'t break existing code but might still be a no-no. Let me know.Reopening as enhancment and changing the titleComment on attachment 168034\nmap Java inheritance to JS prototype-based inheritance\n\n>+        Class superClass = clazz.getSuperclass();\n>+        if (superClass != null && !superClass.isAssignableFrom(Object.class)) {\n\nThat should be superClass != ScriptableObject.class or since x.class leads to\nsignificant class file bloat:\nsuperClass != ScriptRuntime.ScriptableObjectClass\nsince the recursion should stop on ScriptableObject(In reply to comment #10)\n> Created an attachment (id=168034)\n> map Java inheritance to JS prototype-based inheritance\n> \n> I didn\'t realize the the class name was not the Java class name in that\n> context. Here\'s another patch, let me know what you think. It changes the\n> defineClass API so that it returns the class name of the prototype defined,\n> which wouldn\'t break existing code but might still be a no-no. \n\nIt would break binary compatibility plus it changes the method semantic\nsignificantly which is no go. I suggest to add one more signature of defineClass\nwith int flag field with explicit flag constants which would also take care\nabout sealed.\n\nRegards, IgorCreated attachment 168056\nmap Java inheritance to JS prototype-based inheritance\n\nHmm, I wasn\'t aware of the x.class overhead... This project seems to be pretty\nperformance-conscious, from this and other things I have seen in the code :) I\nchanged the statement in question to the following:\n\n+\t if (superClass != null &&\n+\t     superClass != ScriptRuntime.ObjectClass &&\n+\t     superClass != ScriptRuntime.ScriptableObjectClass) {\n\nI\'m leaving the check for null and ObjectClass in because of the\nClass.getSuperclass() contract (from Javadoc):\n\n> Returns the <code>Class</code> representing the superclass of the\n> entity (class, interface, primitive type or void) represented by\n> this <code>Class</code>.  If this <code>Class</code> represents\n> either the <code>Object</code> class, an interface, a primitive\n> type, or void, then null is returned.  If this object represents\n> an array class then the <code>Class</code> object representing the\n> <code>Object</code> class is returned.> It would break binary compatibility plus it changes the method\n> semantic significantly which is no go. I suggest to add one more\n> signature of defineClass with int flag field with explicit flag\n> constants which would also take care about sealed.\n\nI tend to dislike numeric flag fields, since using simple booleans\nis usually much clearer. Do you have anything against just adding a\ndefineClass(Scriptable,Class,boolean,boolean) method?(In reply to comment #15)\n> > It would break binary compatibility plus it changes the method\n> > semantic significantly which is no go. I suggest to add one more\n> > signature of defineClass with int flag field with explicit flag\n> > constants which would also take care about sealed.\n> \n> I tend to dislike numeric flag fields, since using simple booleans\n> is usually much clearer. \n\nWell, it is more clear at the definition side but at the caller side trying to\nfigure out what defineClass(..., false, true) for example would mean is harder.\n\n> Do you have anything against just adding a\n> defineClass(Scriptable,Class,boolean,boolean) method?\n\nI do not have anything against that, the idea of using int was just a suggestion\nin case a third boolean would be necessary. But then perhaps a whole new\ndefineClass should be defined.(In reply to comment #14)\n> Created an attachment (id=168056)\n> map Java inheritance to JS prototype-based inheritance\n> \n> Hmm, I wasn\'t aware of the x.class overhead... \n\nTry to compare the size of compiled\nclass Foo\n{\n    Class bar() { return \"\".getClass(); }\n}\n\nand \n\nclass Foo\n{\n    Class bar() { return String.class; }\n}\n\nThen multiply that by 50 or so cases where Rhino would need to access Class objects.\n\n...\n> I\n> changed the statement in question to the following:\n> \n> +\t if (superClass != null &&\n> +\t     superClass != ScriptRuntime.ObjectClass &&\n> +\t     superClass != ScriptRuntime.ScriptableObjectClass) {\n> \n> I\'m leaving the check for null and ObjectClass in because of the\n> Class.getSuperclass() contract (from Javadoc):\n> \n> > Returns the <code>Class</code> representing the superclass of the\n> > entity (class, interface, primitive type or void) represented by\n> > this <code>Class</code>.  If this <code>Class</code> represents\n> > either the <code>Object</code> class, an interface, a primitive\n> > type, or void, then null is returned.  If this object represents\n> > an array class then the <code>Class</code> object representing the\n> > <code>Object</code> class is returned.\n> \n\nNote that the code before already created an instance of your class and casted\nit to Scriptable so the check for null is not necessary since the class is not\nObject. \n\nBut you are right that lone superClass != ScriptRuntime.ScriptableObjectClass is\nnot enough since defineClass should work with any class as long as it implements\nScriptable. Which tells me that the check should be something like:\n\n> +\t if (ScriptRuntime.ScriptableClass.isAssignableFrom(superClas)) {What is the next version of Rhino going to be? 1.6R2? For the @since javadoc tag...The next version would be 1.6R1.1 but that would include strictly bug fixes so\nit is OK to use @since 1.6R2\nCreated attachment 168061\nmap Java inheritance to JS prototype-based inheritance\n\nAlright, here\'s a patch that maintains backward compatibility in the API by\nadding a new method that allows inheritance mapping from Java-world to\nJavaScript-world. It also makes use of the\nScriptRuntime.ScriptableClass.isAssignableFrom(superClass) check. Let me know\nwhat you think.The patch is OK, I will commit it after regression testing.I committed the patch after replacing tabs by spaces. > I committed the patch after replacing tabs by spaces.\n\nSounds good! I guess I can claim to have contributed to the Mozilla project now? ;)',?,IMPROVEMENT
271545,'XML() does not create empty text nodes',Rhino,E4X,igor,igor,'Werner Sharp wrote:\n> \n> In the appendChild behavior below, it looks like Rhino is treating \"new\n> XML()\" different than \"new XML(\"\")\".  The same issue appears when doing...\n> \n> x = new XML();\n> x.a = \"foo\";\n> print (x.toXMLString());\n> x = new XML(\"\");\n> x.a = \"foo\";\n> print (x.toXMLString());\n> \n> The first case creates \"<a>foo</a>\" while the second case does not.Here is a relevant section of ECMA 357:\n\n13.4.2 The XML Constructor\nSyntax\n       new XML ( [ value ] )\n...\nSemantics\nWhen the XML constructor is called with no arguments or a single argument value,\nthe following steps are taken:\n    1. If value is null, undefined or not supplied, let value be the empty string\n...Changing the title: the actual bug is that while XML() creates true leaf empty\ntext object which should ignore attempts to add xml child to it, the resulting\nXML(\"\") does allow child insertion.\n\nNote that XML(nonEmptyStringWithoutXMLMarkup) behaves properly and creates text\nnode which ignore any attempt to add a child to it.Changing title one more time:\n\nThe bug is that while XML(\"\") does create empty text node, XML() creates\nnon-leaf object.\nI added e4x/Regress/regress-271545.js to the test suite which currently generates:\n\nBug Number 271545\nSTATUS: XML(\"\") should create empty text node\nFailure messages were:\nFAILED!: Section 1 of test -\nFAILED!: Expected value:\nFAILED!: \nFAILED!: Actual value:\nFAILED!: <a>foo</a>\nFAILED!: \nCreated attachment 166960\nFix: make XML() equivalent to XML(\"\")I committed the fix',?,BUG
274311,'Can you add all of the shell commands to the help() menu?',Rhino,Core,sk,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en) AppleWebKit/125.5.5 (KHTML, like Gecko) Safari/125.12\nBuild Identifier: Feature Request:  Add new shell commands (\"serialize\", etc.) to help() menu?\n\nCan you add all of the shell commands to the help() menu?\n\nReproducible: Always\nSteps to Reproduce:\n1.  Start the JavaScript shell.\n2.  Type help();\nActual Results:  \n\"serialize\" and other newer commands not listed.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Created attachment 266007\nShell and command line help\n\nI have added a patch for shell help and updated the command line help.Committed patch:\n\nChecking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.27; previous revision: 1.26\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Global.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java,v  <--  Global.java\nnew revision: 1.43; previous revision: 1.42\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\nnew revision: 1.72; previous revision: 1.71\ndone\n',?,IMPROVEMENT
274467,'Add JavaScript stack trace to exceptions',Rhino,Core,djgredler,igor,'It would be nice to have a JavaScript stack trace in exceptions thrown by Rhino,\nmaybe in EcmaError. Right now EcmaError has sourceName, lineNumber, columnNumber\nand lineSource, but it would be nice to have this data for each call on the\nstack at the time of the error. This would make it much easier for applications\nthat embed Rhino to debug their problems.Do you use the default compile-to-jvm-classes mode in Rhino? In that case the\nstandard Java printStackTrace should provide information about error locations\nin script.\n\nOn the other hand if you use pure interpretation (optimization level == -1),\nthen Java printStackTrace is useless indeed.Well, our production system is using Rhino in interpreted mode, since it relies \non continuations. A detailed stack trace would be nice indeed. I understand it \nmight be hard to generate, as several invocations of Interpreter.interpret() can \nbe on the Java stack, interweaved with calls to Java methods on host objects \nthat call back into interpreted JavaScript functions, so it\'s possible this call \nstack should be maintained in a thread local. Now, instad of updating it on each \nmethod call, an optimization would be to actually only maintain a stack of top \nframes for Interpreter.interpret() invocations when they transition into Java \ncode - the top frame in Interpreter().interpret() call would get pushed on it \nprior to calling a native Java function, and popped from it upon return. On \nexception, the current interpret() would first generate a trace from its own \nframes walking the parentFrame chain starting from its top frame, and then do \nthe same for all the other top frames found on the thread local stack.Just a heads-up, I\'ve started working on this; should be done soon. I think I \nfound an elegant way to embed the functionality.Created attachment 173850\nImplementation for the full JavaScript stack trace in Java stack traceCreated attachment 173851\nA small testcase showing the new functionality\n\nPlace it into a package named \"test\"Created attachment 173853\nOutput of the test program\n\nYou can see two JavaScript stack trace elements:\n\n...\nat script(bar:3)\n...\nat script(foo:2)\n...\n\nbelonging to two nested invocations of the interpreter interleaved with Java\nstack trace elements.To observations about the patch:\n\n1. It introduces the dependency on JDK 1.4 via direct call to\nThroawable.initCause(). Please avoid it. \n\n2. It makes constructions of RhinoException instances significantly heavier even\nwhen users use class compiler. I think storing just reference to CallFrameHolder\nduring construction should be enough to print the stack trace if necessary.\n\n\n(In reply to comment #7)\n> To observations about the patch:\n> \n> 1. It introduces the dependency on JDK 1.4 via direct call to\n> Throawable.initCause(). Please avoid it. \n> \n\nI had to add it so the stack trace is recreated in order for the causes to be \nreflected in the annotated stack trace as well. I further inspected where is it \ncalled from, and I can get around it by making captureJavaScriptStackTrace() \npackage-private, and make sure it\'s called from Kit.initCause when it is invoked \nwith a RhinoException.\n\n> 2. It makes constructions of RhinoException instances significantly heavier \neven\n> when users use class compiler. I think storing just reference to \nCallFrameHolder\n> during construction should be enough to print the stack trace if necessary.\n\nMy only problem with that is that the locations CallFrame objects point (and \nactually the CallFrame objects referred to in the CallFrameHolder) at the time \nthe exception is printed can be significantly different than when the exception \nwas created. As a remedy for class compiler case, the \ncaptureJavaScriptStackTrace() could check for cx.interpreterLineCounting == null \nand shortcut the whole dump-to-string-writer business.\n\nHope it\'ll be acceptable with these changes.(In reply to comment #8)\n> > 2. It makes constructions of RhinoException instances significantly heavier \n> even\n> > when users use class compiler. I think storing just reference to \n> CallFrameHolder\n> > during construction should be enough to print the stack trace if necessary.\n> \n> My only problem with that is that the locations CallFrame objects point (and \n> actually the CallFrame objects referred to in the CallFrameHolder) at the time \n> the exception is printed can be significantly different than when the exception \n> was created.\n\nBut then both holder and frame can be stored or the holder can be cloned to get\na frozen copy. Not all exceptions get their stack trace printed and it does not\nsound right to execute all the code to produce a string with nicely formated trace.\n\n> \n> Hope it\'ll be acceptable with these changes.\n\nSure.\nCreated attachment 173902\nAnother take, now with freezing frames\n\nOkay, I think I understood the concept of freezing call frames and call frame\nholders objects and cloning them on-demand. Here\'s a new version that should\nkeep the lightweight construction of the exception - only the frame holder is\nstored, with all holders and frames reachable from it frozen. I\'ll attach a new\ntestcase where the trace is printed from an entirely different interpreter\nsession, and it works nicely. I even managed to make the printing process as\nlightweight as possible, by implementing a special filtering PrintStream and\nPrintWriter for the purpose, so no buffering/reparsing of the printed stack\ntrace is required.Created attachment 173904\nA small testcase showing the functionalityCreated attachment 173905\nOutput of the test program(In reply to comment #10)\n> Created an attachment (id=173902) [edit]\n> Another take, now with freezing frames\n> \n> Okay, I think I understood the concept of freezing call frames and call frame\n> holders objects and cloning them on-demand. Here\'s a new version that should\n> keep the lightweight construction of the exception - only the frame holder is\n> stored, with all holders and frames reachable from it frozen. \n\nYou do not need to freeze frames! Your code to print stack trace just uses idata\nand parentFrame, but that would not change during the following calculations in\nthe Interpreter.interpret. In fact, to print stack trace you just need the heads\nof CallFrame chains from each Interpreter invocation on Java stack. So it seems\nthe exception constructor can  calculate the depth of CallFrameHolder chain,\nallocate CallFrame array, fill it with heads of CallFrame chains and store that\nin the exception.Created attachment 173940\nImprovement over the last one - eliminated nearly duplicated code for PrintWriter/PrintStream\n\nI improved the last night\'s version slightly. There are no longer two separate\nclasses for printing the stack trace (one PrintStream subclass and one\nPrintWriter subclass) with nearly identical code. I kept only the PrintWriter\none, and when printing to a PrintStream is required, I wrap it in an output\nstream writer and print writer first. I really wish Sun engineered PrintStream\nand PrintWriter so that they implement a common interface declaring all of\ntheir print...() method. Actually, I\'m not the only one to wish for this as\nwitnessed on: http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=5035587(In reply to own comment #13)\n> (In reply to comment #10)\n> > Created an attachment (id=173902) [edit] [edit]\n> > Another take, now with freezing frames\n> > \n> > Okay, I think I understood the concept of freezing call frames and call frame\n> > holders objects and cloning them on-demand. Here\'s a new version that should\n> > keep the lightweight construction of the exception - only the frame holder is\n> > stored, with all holders and frames reachable from it frozen. \n> \n> You do not need to freeze frames! Your code to print stack trace just uses idata\n> and parentFrame,\n\nThat is, of cause, wrong, since the code uses pcSourceLineStart which would\nchange. So with the above it is necessary to capture array of lines per each\nInterpreterFarme that with CallFrame linked list would provide stack trace\ninformation. \n\nNow that does not sound particularly better then frame freezing since the later\nwould avoid allocating of any objects if there are no exception handlers in the\nInterpreter.interpret.\n\nOn the other hand the exception origin information may only change if the\nexception is caught in Interpreter.interpret or bellow. If the catch handler\nbelongs to the Java code, then its execution would not change the interpreter\ndata in all practical cases. And if it is Interpreter.interpreter that prepares\nto execute catch code in JS, then it can explicitly force construction of stack\ninformation.\n\nThus the idea would be in the exception constructor to store only the current\nCallFrameHolder. Then the exception should contain a method to force creation of\nstack trace. Interpreter would call the method when preparing to execute the\ncatch handler in the script. Rhino embedding may also call this method if it\ncatches RhinoException and plans to do something smart with it besides printing\nstack-related information immediately.(In reply to comment #15)\n> \n> On the other hand the exception origin information may only change if the\n> exception is caught in Interpreter.interpret or bellow. If the catch handler\n> belongs to the Java code, then its execution would not change the interpreter\n> data in all practical cases. And if it is Interpreter.interpreter that \nprepares\n> to execute catch code in JS, then it can explicitly force construction of \nstack\n> information.\n> \n> Thus the idea would be in the exception constructor to store only the current\n> CallFrameHolder. Then the exception should contain a method to force creation \nof\n> stack trace. Interpreter would call the method when preparing to execute the\n> catch handler in the script. Rhino embedding may also call this method if it\n> catches RhinoException and plans to do something smart with it besides \nprinting\n> stack-related information immediately.\n\nWell, I\'m not seeing this either as being particularly better than frame \nfreezing. There\'s again the issue of an exception stack trace being generated \nforcibly even if it might happen that it will never be printed. Also, it exposes \nan implementation detail to an \"advanced\" embedder - he must remember to call \nthe generator method. Granted, this can only be an issue if the embedder happens \nto call an interpreted function/script from the catch block. Frame freezing code \ntakes care of all corner cases in a self-contained way, and I don\'t think \nthere\'s a big cost difference between taking a snapshot of locations for the \nstack trace in the interpreter catch handler vs. making clones of frames in the \ninterpreter if it recovers from the exception. Especially since the code for \nmanagement of freezing is already in place, and doing a forcible capture would \nrequire RhinoException to cache a string containing the printed trace. \nTherefore, frame freezing looks like a more elegant solution to me, but then I\'m \na rather new to the Rhino code and I accept that you have more insight into it.(In reply to comment #16)\n> Well, I\'m not seeing this either as being particularly better than frame \n> freezing.\n\nFrame freezing would lead to frame cloning if the exception is caught inside\nInterpreter.interpret and this is not exactly cheap operation. With a few nested\nscript frames on top of try /catch in JS generating the stack may be cheaper\nthen cloning the frames. \n\n> There\'s again the issue of an exception stack trace being generated \n> forcibly even if it might happen that it will never be printed. \n> Also, it exposes \n> an implementation detail to an \"advanced\" embedder - he must remember to call \n> the generator method. Granted, this can only be an issue if the embedder happens \n> to call an interpreted function/script from the catch block.\n\nThat would not affect the capturing information. The only case when it would\nmatter is when the handler would return somehow the exeception object back to\nthe script before printing the stack trace. But that require to wrap execption\nbefore sending it to JS and Rhino can call the method itself in the wrapping\ncode. Since code to generate the catch object for native exception would go\nthrough the same path, it would add that forcefull stack creation only in one place.\n\n> Frame freezing code \n> takes care of all corner cases in a self-contained way.\n\nRight, but that requires a lot more code then the original patch and that does\nnot seems justifiable.\n\n> and I don\'t think \n> there\'s a big cost difference between taking a snapshot of locations for the \n> stack trace in the interpreter catch handler vs. making clones of frames in the \n> interpreter if it recovers from the exception. Especially since the code for \n> management of freezing is already in place, and doing a forcible capture would \n> require RhinoException to cache a string containing the printed trace. \n> Therefore, frame freezing looks like a more elegant solution to me, but then I\'m \n> a rather new to the Rhino code and I accept that you have more insight into it.\n\nCreated attachment 173956\nYet another try without frame freezing\n\nOkay, here\'s another try - no frame freezing,\nRhinoException.generateStackTrace() called when a frame was found that can\nhandle the exception, just before StateLoop is continued. generateStackTrace()\nalso called in printStackTrace() (does nothing if it was already called before)\nso it handles the case where the exception bubbles up into Java code where the\ntrace is printed without it ever being handled at all in the interpreter.\n\nHow does it look now?Comment on attachment 173956\nYet another try without frame freezing\n\n> \n>             for (;;) {\n>                 if (exState != EX_NO_JS_STATE) {\n>                     boolean onlyFinally = (exState != EX_CATCH_STATE);\n>                     indexReg = getExceptionHandler(frame, onlyFinally);\n>                     if (indexReg >= 0) {\n>+                        if(throwable instanceof RhinoException) {\n>+                            ((RhinoException)throwable).generateStackTrace();\n>+                        }\n>                         // We caught an exception, restart the loop\n>                         // with exception pending the processing at the loop\n>                         // start\n>                         continue StateLoop;\n>                     }\n\nThat is not right as it would force stack trace for finally as well and would\nmiss the case of class compiler between interpreter frames. I suggest to put\nthe check to WrapFactory before calls to WrapFactory.wrapAsJavaObject.\n\nOtherwise the patch is OK.I just wanted to send a big \"Thank You\" to Attila for working on this! Much\nappreciated!(In reply to comment #20)\n> I just wanted to send a big \"Thank You\" to Attila for working on this! Much\n> appreciated!\n\nWell, I thank you for the appreciation. However, I\'ve come under a rather heavy \nload on my pay job, so I\'m not sure if I can keep working on it. If it really \nonly requires a finishing touch or two, maybe Igor can take it over. Lacking \nthis, I might be able to return to it in, like, two weeks.Created attachment 174490\nDuplicate only mutable information etc.\n\nChanges from the previous version:\n\n1. In the new version RhinoException constructor duplicates the information\nthat can change during the following execution. Then the captured immune data\nare used to augment the native stack trace with script information when\nrequested.\n\nIn particular the patch stores in RhinoException the array of top CallFrame\ninstances from each interpreter invocation and array of\nCallFrame.pcSourceLineStart from all CallFrame instances from all interpreter\ninvocations. It is relatively lightweight and should not impose noticable\nperformace penalty if stack is not printed.\n\n2. I replaced CallFrameHolder by a stack of top frames from each interpreter\ninvocation. In this way there is no need to create an additional object per\neach interpreter invocation and creation of array of top frames is simplified.\n\n3. The previous version depended on the fact that JVM would call\nPrintWriter.println() to print stack entries. Since there is no any guaranty\nthat it would stay that way on any JVM where Rhino could run, I changed that to\nexplicit parsing of the stack trace. To make life even I renamed the\ninterpreter loop routine to interpreterLoop to have a simple tag to look for.Created attachment 174503\nBetter stack trace\n\n1. Stack trace includes function name when available.\n\n2. Patch tries to decrease the number of various Interpreter.interpret calls\nbefore the real interpretation can start. It makes the interpreter\ninitialization slightly faster and stack trace looks more clear.Created attachment 174504\nTest output with the last patchI committed the last patch.Created attachment 175806\nPatch for wrapping unchecked exceptions from Java method invocations\n\nRecently we had a problem with a NPE occurring in a Java method - it wasn\'t\nwrapped into WrappedException and subsequently we did not see the interpreter\nscript stack traces. This is because unchecked throwables aren\'t wrapped into\nInvocationTargetException. I changed the relevant code in MemberBox.java to\nwrap all exceptions (checked and unchecked) into WrappedException. BTW, this is\nnow consistent with how JavaMembers.get() and JavaMembers.put() work - they\nalso wrap all exceptions into WrappedException, not just\nInvocationTargetException.Created attachment 175807\nPatch for wrapping unchecked exceptions from Java method invocations\n\nSorry, uploaded a wrong file previouslyHm... For some reason, before I added the patch Bugzilla showed me an option to \nreopen the bug, now it doesn\'t.I committed the last patch.Created attachment 182046\nPatch for adding a \"rhinoException\" property to error objects\n\nThe wrapped exception carrying the embedded script stack trace can become\ninaccessible to the calling Java code if the script catches and rethrows\nexceptions. I.e.\n----------------------------------------------------\ntry\n{\n    new java.io.FileInputStream(\"nonexistant file\");\n}\ncatch(e)\n{\n    throw e;\n}\n----------------------------------------------------\n\nThe Java code invoking the interpreter won\'t be able to retrieve the\nWrappedException that carries the script stack trace. It can only retrieve the\nunderlying e.javaException using code similar to this:\n\n----------------------------------------------------\nThrowable terminationCause;\ntry\n{\n    script.exec(cx, scope);\n}\ncatch(JavaScriptException e)\n{\n    terminationCause = e;\n    Object val = e.getValue();\n    if(val instanceof Scriptable)\n    {\n\tObject njo = ScriptableObject.getProperty(((Scriptable)val),\n\"javaException\");\n\tif(njo instanceof NativeJavaObject)\n\t{\n\t    val = njo;\n\t}\n\tif(val instanceof NativeJavaObject)\n\t{\n\t    Object t = ((NativeJavaObject)val).unwrap();\n\t    while(t instanceof InvocationTargetException)\n\t    {\n\t\tt = ((InvocationTargetException)t).getCause();\n\t    }\n\t    if(t instanceof Throwable)\n\t    {\n\t\tterminationCause = (Throwable)t;\n\t    }\n\t}\n    }\t \n}\ncatch(Throwable t)\n{\n    terminationCause = t;\n}\n----------------------------------------------------\n\nI\'m attaching a patch that\'d add another property to the JavaScript error\nobject, named \"rhinoException\" that\'d contain the originating RhinoException.\nIn my above code that attempts to extract the underlying exception from the\nJavaScriptException, I could then obtain the RhinoException by calling\nScriptableObject.getProperty with \"rhinoException\" instead of \"javaException\".\nThat way, I could still properly log exceptions with script stack trace even\nwhen the script does a try-catch-rethrow.',?,CLEANUP
274996,'Exceptions with multiple interpreters on stack may lead to ArrayIndexOutOfBoundsException',Rhino,Core,thomas.hentschel,igor,'In a scenario where multiple rhino interpreters are on the Java stack, and an\nexception is thrown during the execution of Java code (thru LiveConnect), an\nArrayOutOfBoundException may occur. The attached (junit) test reproduces the\nscenario in two ways: The 1st test succeeds, but the line number information for\nthe outer interpreter is corrupted, the 2nd test throws the\nArrayIndexOutOfBoundsException:\n\n---\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in inner\nline 4 [null]\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in outer1\nline 827 [null]\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in inner\nline 4 [null]\n\njava.lang.ArrayIndexOutOfBoundsException\n  at org.mozilla.javascript.Interpreter.getShort(Interpreter.java:1411)\n  at\norg.mozilla.javascript.Interpreter.getSourcePositionFromStack(Interpreter.java:1817)\n  at org.mozilla.javascript.Context.getSourcePositionFromStack(Context.java:2297)\n  at org.mozilla.javascript.EvaluatorException.<init>(EvaluatorException.java:59)\n  at org.mozilla.javascript.WrappedException.<init>(WrappedException.java:78)\n  at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1604)\n  at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:191)\n  at org.mozilla.javascript.NativeJavaMethod.call(NativeJavaMethod.java:202)\n  at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2646)\n  at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:57)\n  at\nrhinotestcase.ArrayOutOfBoundsRhinoTest.testArrayOutOfBoundsError2(ArrayOutOfBoundsRhinoTest.java:81)\n---\n\nThe attached patch fixes this behavior for me:\n---\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in inner\nline 4 [null]\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in outer1\nline 3 [null]\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in inner\nline 4 [null]\norg.mozilla.javascript.WrappedException: WrappedException of \"oops\" in outer2\nline 2 [null]\n---\n\nThe test was run against 1.5R5, with the .optimizer package removed.Created attachment 168920\nthe test to reproduce the problem (needs junit...)\n\nadded test case to reproduce problemCreated attachment 168921\npatch\n\na patch that solves the problem for meCreated attachment 168923\nthe test again (forgot to include the src)The bug is already fixed in Rhino 1.6R1 as a part of work on bug 258844',?,BUG
277537,'isXMLName() should be properly implemented',Rhino,E4X,Martin.Honnen,igor,'When I try\n  isXMLName(String.fromCharCode(8364) + \'1\')\nwith Rhino 1.6 release 1 2004 11 30 it yields true while I think the character\nwith Unicode 8364 (it is the Euro symbol \'?\') is not allowed as the first\ncharacter in an XML name, not even allowed in there at all.The problem with isXMLName doesn\'t seem to be restricted to that particular\ncase, here are some tests where Rhino all yields true while the result should be\nfalse I think:\n\nRhino 1.6 release 1 2004 11 30\njs> isXMLName(String.fromCharCode(8364) + \'1\')\ntrue\njs> isXMLName(\'-el\')\ntrue\njs> isXMLName(\'1el\')\n\nSo changing summary.\n\nHmm, I have just looked at the source and indeed the implementation currently is\n\n    public boolean isXMLName(Context cx, Object name)\n    {\n        // TODO: Check if qname.localName() matches NCName\n\n        return true;\n    }\n\nso obviously this is a known issue.Changing the title to reflect the real nature of the bug: currently isXMLName()\nin Rhino simply returns true.\n\nCreated attachment 171078\nFix: just follow E4X 13.1.2.1 and http://w3.org/TR/xml-names11/#NT-NCNameCreated attachment 171174\nPatch change to work around jikes compiler bugI committed the fix(In reply to comment #0)\n> When I try\n>   isXMLName(String.fromCharCode(8364) + \'1\')\n> with Rhino 1.6 release 1 2004 11 30 it yields true while I think the character\n> with Unicode 8364 (it is the Euro symbol \'\') is not allowed as the first\n> character in an XML name, not even allowed in there at all.\n\nBTW, according to http://www.w3.org/TR/xml11#NT-NameStartChar the characters\nwithin [#x2070-#x218F] are allowed as first XML name character so ? (8364 or 0x\n20ac) is allowed(In reply to comment #6)\n \n> according to http://www.w3.org/TR/xml11#NT-NameStartChar the characters\n> within [#x2070-#x218F] are allowed as first XML name character so ? (8364 or 0x\n> 20ac) is allowed\n\nOnly that E4X edition 1 (ECMA-357) only refers to XML 1.0 and Namespaces for XML\nbut not to XML 1.1 and in XML 1.0 the Euro character \'?\' is not allowed (inside\nnames).\n\nHave you now implemented isXMLName following the rules of the XML 1.1\nspecification? That will break compatibility between Spidermonkey E4X and Rhino\nE4X then as I think Spidermonkey attempts to implement XML 1.0 rules.(In reply to comment #7)\n> \n> Have you now implemented isXMLName following the rules of the XML 1.1\n> specification? That will break compatibility between Spidermonkey E4X and Rhino\n> E4X then as I think Spidermonkey attempts to implement XML 1.0 rules.\n\nYou are right, I just followed XML 1.1 rules while E4X refer to XML 1.0. Now\nrules in XML 1.0, http://w3.org/TR/2004/REC-xml-20040204/#NT-Name , are much\nmore complex then in XML 1.1 and implementing them directly would lead to a huge\nbloat. \n\nNote that it is not possible AFAICS to use java.lang.Character methods directly\nsince in JDK 1.4 they refer to Unicode 3.0, in JDK 1.5 they refer to Unicode 4.0\nwhile XML 1.0 uses Unicode 2.0. In a sense following XML 1.1 is much simpler but\nnot E4X-compliant.\nHi.\n\nWhile the number of distinct ranges that cover the XML 1.0 name characters is greater than that of XML 1.1 name characters, using a lookup table where each bit represents a character in plane 0 shouldn\'t be too much of a bloat.  For example, see the arrays:\n\nhttp://svn.apache.org/viewcvs.cgi/xmlgraphics/batik/trunk/sources/org/apache/batik/xml/XMLCharacters.java?rev=216064&view=markup\n\nand the methods to look up the arrays:\n\nhttp://svn.apache.org/viewcvs.cgi/xmlgraphics/batik/trunk/sources/org/apache/batik/xml/XMLUtilities.java?rev=216064&view=markup\n\nthat are used in Batik.  You\'re welcome to use the arrays for Rhino (barring any licence complications).',?,BUG
277767,'parent() of XML object yields undefined but should be null if no parent exists',Rhino,E4X,Martin.Honnen,nobody,'Section 9.1.1 Internal Properties and Methods of the E4X specifications says\nabout the [[Parent]] property:\n  \"The value of the [[Parent]] property must be either an XML object or null.\"\nThe method parent of an XML object maps directly to that internal property as\nthe specifications says:\n  \"When the parent method is called on an XML object x, the following step is taken:\n!!!1. Return x.[[Parent]]\"\nthus I think if an XML object has no parent then Rhino should return null when\ncalling object.parent().\nRhino (Rhino 1.6 release 1 2004 11 30) however returns undefined which is a bug.\n\nTest case to be run in the Rhino shell:\n\nvar xhtml = <html xmlns=\"http://www.w3.org/1999/xhtml\"></html>;\n\'xhtml.parent() === null: \' + (xhtml.parent() === null) + \'\\r\\n\' +\n\'xhtml.parent() === undefined: \' + (xhtml.parent() === undefined)\n\nyields \n\nxhtml.parent() === null: false\nxhtml.parent() === undefined: true\n\nbut should yield\n\nxhtml.parent() === null: true\nxhtml.parent() === undefined: falseReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the coming DOM-only E4X implementation.  See bug See bug 355677, I mean (sorry, typo). :)See test e4x/XML/13.4.4.11.js section 2.  Rhino now passes this test if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
277935,' failed assert',Rhino,E4X,igor,igor,'Assignments like \"msg..s = something\" triggers failed assert exception at\nruntime instead of proper syntax error during compile time. For example, the\nfollowing test case:\n\nvar msg =  <foo><bar><s/></bar></foo>\nmsg..s = \"foo\"\n\nleads to:\n\nException in thread \"main\" java.lang.IllegalStateException: FAILED ASSERTION\n        at org.mozilla.javascript.Kit.codeBug(Kit.java:432)\n        at org.mozilla.javascript.xmlimpl.XMLName.set(XMLName.java:130)\n        at org.mozilla.javascript.ScriptRuntime.refSet(ScriptRuntime.java:1516)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2828)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2164)\n        at\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\n\n...\n\nIt was originally reported by ant_petra@hotmail.com :\n\n-------- Original Message --------\nSubject: E4X FAILED ASSERTION in Kit.codeBug(Kit.java:425)\nDate: 11 Jan 2005 04:08:17 -0800\nFrom: ant <ant_petra@hotmail.com>\nOrganization: http://groups.google.com\nNewsgroups: netscape.public.mozilla.jseng\n\nIs it valid to try to modify the contents of an XML element selected\nwith the dot-dot operator?\n\nFor example, using the msg defined below, if i try:\n\nmsg..s = \"foo\"\n\nI get an assertion failed, whereas specifying the full path works fine:\n\nmsg.soap::Body.ns::reverse.s = \"foo\"\n\nThanks for any help.\n\n...ant\n\nComplete details are:\n\njs> msg\n<soapenv:Envelope\nxmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\nxmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\nxmlns:xsd=\"http://www\n.w3.org/2001/XMLSchema\"\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n<soapenv:Header/>\n<soapenv:Body>\n<p728:reverse xmlns:p728=\"http://ejbs\">\n<s>petra</s>\n</p728:reverse>\n</soapenv:Body>\n</soapenv:Envelope>\njs> soap = new Namespace(\"http://schemas.xmlsoap.org/soap/envelope/\")\nhttp://schemas.xmlsoap.org/soap/envelope/\njs> ns = new Namespace(\"http://ejbs\")\nhttp://ejbs\njs> msg..s = \"foo\"\njava.lang.IllegalStateException: FAILED ASSERTION\nat org.mozilla.javascript.Kit.codeBug(Kit.java:425)\nat org.mozilla.javascript.xmlimpl.XMLName.set(XMLName.java:130)\nat\norg.mozilla.javascript.ScriptRuntime.refSet(ScriptRuntime.java:1516)\nat\norg.mozilla.javascript.Interpreter.interpret(Interpreter.java:2828)\nat\norg.mozilla.javascript.Interpreter.interpret(Interpreter.java:2164)\nat\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\nat\norg.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:304)\nat\norg.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2769)\nat\norg.mozilla.javascript.Interpreter.interpret(Interpreter.java:2145)\nat\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\nat\norg.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:149)\nat\norg.mozilla.javascript.Context.evaluateString(Context.java:1220)\nat\norg.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:453)\nat\norg.mozilla.javascript.tools.shell.Main.processSource(Main.java:341)\nat\norg.mozilla.javascript.tools.shell.Main.processFiles(Main.java:160)\nat\norg.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:83)\nat org.mozilla.javascript.Context.call(Context.java:540)\nat\norg.mozilla.javascript.ContextFactory.call(ContextFactory.java:414)\nat org.mozilla.javascript.tools.shell.Main.exec(Main.java:140)\nat org.mozilla.javascript.tools.shell.Main.main(Main.java:112)I added the test case for the bug:\n\ne4x/Regress/regress-277935.jsCreated attachment 170928\nFix: check during parsing for .. in assignmentsI committed the fix',?,BUG
278701,'Minimised windows don\'t indicate that breakpoints have been hit',Rhino,Core,james.eggleston,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: rhino1_5R5\n\nThe debugger normally brings hidden windows to the front when a breakpoint is \nhit, which informs the user that their script is frozen. \n\nHowever, if the window is minimised to the task bar (not simply underneath \nother windows), then the user receives no feedback that their script has hit a \nbreakpoint. In our use case, this means that the system is frozen at the \nbreakpoint, but the user does not realise this. \n\n(I guess this is subjective; it could be argued that if the user has minimised \ntheir window, they don\'t want any feedback?)\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Attach a debug session to a Rhino engine with any script containing a \nfunction definition\n2. Set a breakpoint in that function\n3. Minimise the window\n4. Execute the function so that the break point is hit\n\nActual Results:  \nThe breakpoint is hit, but the debugger window does not show any feedback. The \nthread of execution never returns to the program that passed the command to the \nRhino engine. \n\nExpected Results:  \nI would like the debugger window to unminimise itself, or possible start \nflashing on the toolbar, drawing the users attention to it. \n\nWe have altered our version to get the desired behaviour... \n\nThe following code, added to the EnterInterrupt class definition in \ntoolsrc/org/mozilla/javascript/tools/debugger/Main.java, does what I\'d like to \nsee happen (starting with the code at line numbers 1957):\n\n1957: // raise the debugger window\n      int state = db.getExtendedState();\n      if (state == Frame.ICONIFIED)\n      {\n         db.setExtendedState(Frame.NORMAL);\n      }\n1958: db.toFront();Created attachment 191196\nImplementation as a patchCreated attachment 191199\nCompilable version of the patchI committed the patch',?,RFE
280047,'Not implementing Scriptable in Undefined',Rhino,Core,igor,igor,'Currently in a few places Rhino code contains checks like:\n\nif (x instanceof Scriptable && x != Undefined.instance) {\n   do_something()\n}\n\nIf Undefined would not implement Scriptable, that code would be reduced to simple:\n\nif (x instanceof Scriptable) {\n   do_something()\n}\n\nThe additional benefit is code reduction in Undefined.java since the class would\nonly need to implement Serializable interface and declare Undefined.instance method.\n\nClearly it would be incompatible with code that directly uses Undefined, but\nsince the class is not a part of public API, I suggest to try  this.Created attachment 172569\nImplementationI committed the patch after tagging the code in CVS as\nbefore_simpler_undefined_280047 to be able to remove patch if too many\ncompatibility problems happens.Igor,\n\nI recently updated to the latest CVS Rhino code, and started seeing a lot of\nwarnings reported:\n\nRHINO USAGE WARNING: Missed Context.javaToJS() conversion:\nRhino runtime detected object org.mozilla.javascript.Undefined@11adeb7 of class\norg.mozilla.javascript.Undefined where it expected String, Number, Boolean or\nScriptable instance. Please check your code for missig Context.javaToJS() call.\n\nThe problem in this case is that the error doesn\'t even come from Java code, but\nrather from a JavaScript invocation.  In one case, I invoke the contructor on\none of my ScriptableObject sub-classes, which takes three parameters:\n\n   public void jsConstructor(String a, String b, int c) {\n      // ...\n      if (c == 0) {\n         // Assume not specified in JavaScript\n      }\n   }\n\nMy understanding (correct me if I\'m wrong) is that you are allowed to omit later\narguments, thereby implementing many constructors as one (you can\'t have two\ndifferent constructors).  In any case, it worked just fine prior to your fix --\nomitting the \'c\' parameter from JavaScript resulted in an undefined value, which\nwould result in a value of zero for \'c\', which I would handle in the constructor.\n\nWas my understanding wrong?  Is there anything I should do to make this work? \nShould Rhino be fixed to handle such cases?',?,DESIGN_DEFECT
280629,'When using the debugger within another program the only way to close it is kill the JVM (System.exit(0))',Rhino,Core,bugzilla,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.1.4322)\nBuild Identifier: \n\nWe use the rhino debugger as part of a bigger process and just upgraded from \n1.5 to 1.6\n\nIn version 1.5 there used to be an API Main.dispose() that closes the UI and \nits threads.\n\nSomewhere along the line the API disappeared and now the only possible way to \nclose\nthe debugger is with System.exit(). The problem is that we need to keep the JVM \nto run well after\nthe debugger is used and currently when the program exits it hangs waiting for \nthe debuggers (we sometime start several of those)\nwindows to close.\n\nCurrently we modified the code of org.mozilla.javascript.tools.debugger.Main\nto include at line 248:\n\npublic void close()\n    {\n      debugGui.dispose();\n    }\n    \n\n\nReproducible: Always\n\nSteps to Reproduce:\nstart the debugger in the following way:\n\n    mDebugger = new org.mozilla.javascript.tools.debugger.Main(\"JavaScript \nDebugger\");\n\n    mDebugger.attachTo(ContextFactory.getGlobal());\n\n    // Inform the debugger of the global execution scope\n    mDebugger.setScopeProvider(new ScopeProvider()\n    {\n      public Scriptable getScope()\n      {\n        return mRootScope;\n      }\n    });\n    mDebugger.pack();\n    mDebugger.setSize(800, 600);\n    mDebugger.setVisible(true);\n\nActual Results:  \nThe program can never exit and waits for the debugger window. And there is now \nway to close it using API.To be precise: prior Rhino 1.6R1 the main Main class in the debugger extended\njavax.swing.JFrame and so all methods from JFrame were available. In Rhino 1.6R1\ndebugger underwent reorganization to support debugging of independent Rhino\nruntimes and as the result Main class extends just Object and so dispose method\nis no longer available.\n\nFor compatibility with the previous Rhino releases few methods from JFrame were\nadded to Main during pre-release testing, but dispose was not on that list. So I\nadd it now.\n\nNote also that dispose method in 1.5R5 would not break the association between\nRhino runtime and the debugger objects so even after the method call scripts\nwould continue to be executed in much slower debugging mode. Created attachment 173103\nCompatibility patch to add Main.disposeI committed the fix',?,BUG
281067,'ThreadLocal in Context prevents class unloading',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.54 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nI have an environment where most of the system (including Rhino) is hot-\nreloadable. The classes are loaded through a particular java.net.URLClassLoader, \nand upon detecting a change, the class loader is thrown away, and a new one is \ncreated, allowing for the classes to be reloaded. However, a small issue in \nRhino\'s Context class prevents the throwaway class loader (and all the classes \nit loads) from being garbage collected, resulting in memory leak over time.\n\nThe issue is the ThreadLocal \"Context[] storage\". Since the type of the value in \nThreadLocal is org.mozilla.javascript.Context[], the class org.mozilla.\njavascript.Context will remain permanently loaded, and will keep the class \nloader from being garbage collected -- we\'re utilizing a permanent set of \nthreads, actually they\'re created by JMS sessions, so we can\'t just terminate \nand restart the threads to get rid of the stuck thread locals. However, there is \na brilliantly simple solution - store an Object[] instead of Context[] in the \nthread local. Granted, we sacrifice a bit of static type safety, but Rhino will \nno longer prevent the class loader that loaded it from being garbage collected.\nPatch on the way.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 173365\nThe patch that solves the problem\n\nPatch attachedI thought that Java used week references to store ThreadLocal in Thread\ninstances. Apparently it does not which also means that even with the patch\nafter Rhino reloading all those ThreaLocal instances from reloaded Rhino classes\nwould stuck in memory forever.\n\nOf cause it is much better then forever stuck Rhino classes themselves so I will\ncommit the patch after regression testing. I committed the patch. \n\nBTW, since you repeatedly reload Rhino classes, did the patch address memory\nleak completely on your JVM? Or do you still see some leaks like the one\ndescribed in \nhttps://bugzilla.mozilla.org/show_bug.cgi?id=243305#c9 ?(In reply to comment #3)\n> \n> BTW, since you repeatedly reload Rhino classes, did the patch address memory\n> leak completely on your JVM? Or do you still see some leaks like the one\n> described in \n> https://bugzilla.mozilla.org/show_bug.cgi?id=243305#c9 ?\n\nI\'ll run it through a profiler now (been profiling all day :-) ). However, what \nyou say is certainly true - the ThreadLocal object and the Object[] will get \nstuck in the thread\'s local table... Hm... maybe in the end I\'ll really have to \nintroduce a feature for perodically shutting down and recreating the JMS \nsessions...(In reply to comment #3)\n> I committed the patch. \n> \n> BTW, since you repeatedly reload Rhino classes, did the patch address memory\n> leak completely on your JVM? Or do you still see some leaks like the one\n> described in \n> https://bugzilla.mozilla.org/show_bug.cgi?id=243305#c9 ?\n\nNo, I see no leaks now. As a matter of fact, Thread indeed holds the ThreadLocal \nobjects using weak references. However, weak references are defeated if the \nvalue - directly or indirectly - refers back strongly to the key. In the case \nwith storing a Context[], we had a strong reference from value to key via the \npath value = Context[] instance -> Context[].class -> Context.class -> Context.\nthreadLocalCx = key. Storing an Object[] instead of Context[] solved it for good \n:-). Provided the array element is null (which is easy by using a Context.exit() \nin a finally block), the ThreadLocal object can be fully garbage collected after \nthe Context class is unloaded.Thinking about it, I believe it\'d be necessary to provide a comment around \n\"storage = new Object[1];\" explaining why do we use it instead of Context[] - \nit\'s not immediately apparent, and some otherwise well-meaning soul (who comes \nto maintain it sometime in the future after we all moved along) unsuspectingly \nrewrites it back to Context[]...(In reply to comment #5)\n> As a matter of fact, Thread indeed holds the ThreadLocal \n> objects using weak references. However, weak references are defeated if the \n> value - directly or indirectly - refers back strongly to the key. In the case \n> with storing a Context[], we had a strong reference from value to key via the \n> path value = Context[] instance -> Context[].class -> Context.class -> Context.\n> threadLocalCx = key.\n\n\nBut why the reference from Context.threadLocalCx prevents in your case Rhino\nclasses from garbage collection? If ThreadLocal value is reachable from Thread\nonly through week reference, it should allow to GC classes as long as the last\nstrong reference to them and their class loader is gone.(In reply to comment #7)\n> \n> But why the reference from Context.threadLocalCx prevents in your case Rhino\n> classes from garbage collection? If ThreadLocal value is reachable from Thread\n> only through week reference, it should allow to GC classes as long as the last\n> strong reference to them and their class loader is gone.\n\nNo, only the keys in the WeakHashMap are weakly reachable (in our case, the \nThreadLocal object). The values in WeakHashMap are strongly reachable. And if \nthe value is a Context[], it\'ll establish a strong reference to the ThreadLocal \nkey, as outlined in comment #5, preventing it to be GC-ed for the lifetime of \nthe thread.(In reply to comment #8)\n>... only the keys in the WeakHashMap are weakly reachable (in our case, the \n> ThreadLocal object). The values in WeakHashMap are strongly reachable. And if \n> the value is a Context[], it\'ll establish a strong reference to the ThreadLocal \n> key, as outlined in comment #5, preventing it to be GC-ed for the lifetime of \n> the thread.\n\nI will add then comments about using Object[], not Context[] after I will finish\nwith bug 281247.',?,IMPROVEMENT
281247,'JDK compatibility via special class',Rhino,Core,igor,igor,'Rhino core supports JDK 1.1 compatibility to be able to run under MS JVM. To\ntake advantage of more recent JDK Rhino uses reflection. That introduce overhead\nin the vast majority of Rhino embeddings and clutter code with verbose\npreparations for reflection calls.\n\nI suggest to replace that by a special compatibility interfaces and use\nreflection only once to initialize it.Created attachment 173524\nVMBridge implementation\n\nThe patch introduces the new abstract class, omj.VMBridge, with methods to\nimplement the following functionality:\n\n1. Context.(enter|exit|call)\n2. Access to thread-local classloader\n3. Access to java.lang.reflect.AccessibleObject API to mark method as\naccessible.\n\nThere are 2 implementations, omj.jdk11.VMBridge_jdk11 and\nomj.jdk13.VMBridge_jdk13. The code for jdk13 case can run under JDK 1.2 but\nsince support for JDK 1.2 is not on the agenda and in future features like\njava.lang.reflect.Proxy could be used by Rhino I explicitly referred to JDK 1.3\nin the class name.\n\nDuring initialization Rhino loads jdk11 case only if it failed to create an\ninstance of omj.jdk13.VMBridge_jdk13. In addition for additional Rhino also\ntries to load initially omj.VMBridge_custom class which Rhino embedding can\nprovide if necessary.Created attachment 173550\nComments and cleanup\n\nChanges from the previous version:\n\n1. Comments including reference to the recent changes by Attila Szegedi in bug\n281067.\n\n2. VMBridge instance variable is moved from Context to the class itself since\nit is not only Context that uses it.Created attachment 173593\nPatch to commit\n\nIn this version I removed no longer used Class constants in ScriptRuntime.I committed the last version of the patch',?,IMPROVEMENT
281537,'ScriptRuntime.toNumber warns on Undefined',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.54 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nScriptRuntime.toNumber() will print a warning \n\n\"RHINO USAGE WARNING: Missed Context.javaToJS() conversion: Rhino runtime \ndetected object org.mozilla.javascript.Undefined@165d905 of class org.mozilla.\njavascript.Undefined where it expected String, Number, Boolean or Scriptable \ninstance. Please check your code for missig Context.javaToJS() call\"\n\nNow, according to ECMA 9.3 Undefined is a perfectly convertible to a number, as \nNaN. I don\'t think the warning should be logged, esp. since other toXxx methods \ndon\'t log a warning on Undefined.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 173769\nThe patch to solve this bugOf course, it\'s possible that #280047 will also address this.The message is just a bug caused by implementing bug 280047. \n\nThanks for spotting this!Created attachment 173775\n2-loop pattern in toNumber/toBoolean\n\nThe above patch was OK, but I would like toNumber and toBoolean to follow the\nsame double-loop pattern that is used in few other places in ScriptRuntime to\nhave smaller and easier to follow code.(In reply to comment #4)\n> Created an attachment (id=173775) [edit]\n> 2-loop pattern in toNumber/toBoolean\n> \n> The above patch was OK, but I would like toNumber and toBoolean to follow the\n> same double-loop pattern that is used in few other places in ScriptRuntime to\n> have smaller and easier to follow code.\n\nThat loop isn\'t double, it\'s a plain single loop :-)\n\nAnyway, I get what you\'re doing in there - it\'s a clever way to guarantee that \nif the method ever returns, the return value is a number, regardless of what \ndoes the Scriptable.defaultValue(NumberClass) return. Of course, an offending \nScriptable returning \"this\" could force the interpreter into an infinite loop ..\n.(In reply to comment #5)\n> That loop isn\'t double, it\'s a plain single loop :-)\n\nOf cause, it was not \"double-loop\" but rather no more then 2 times executed loop ;)\n\n> \n> Anyway, I get what you\'re doing in there \n\nIt is not me but rather the initial creators of Rhino who put such loop as\noptimization in some of Rhino methods. \n\nThe loop is not necessary if the code would check for Scriptable first. But then\nthe overhead of \"instanceof Scriptable\" check would occur in the majority of\ncases. The loop allows to run the most common case of Number for toNumber and\nBoolean for toBoolean while avoiding duplicating code for the checks.\n\nI committed the fix.',?,SPEC
282447,'NPE trying to report error when trying to convert null to primitive type',Rhino,Core,szegedia,igor,'User-Agent:       Opera/7.54 (Windows NT 5.0; U)  [en]\nBuild Identifier: \n\nWhen null is attempted to be passed as a parameter argument to a Java method \ntaking primitive type, Rhino attempts to report this as error. However, the \nerror reporting itself fails with:\n\njava.lang.NullPointerException\n        at org.mozilla.javascript.NativeJavaObject.\nreportConversionError(NativeJavaObject.java:896)\n        at org.mozilla.javascript.NativeJavaObject.\ncoerceTypeImpl(NativeJavaObject.java:505)\n...\n\nI won\'t bother submitting a patch for this, as it\'s trivial. Just change \"value.\ntoString()\" to \"String.valueOf(value)\" in NativeJavaObject.\nreportConversionError() method.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 174470\nThe fix\n\nIt is nice to be able to press \"Diff\" link ;)Created attachment 174471\nThe fix with commentsI committed the fix, thanks for reporting it!',?,BUG
282595,'Patch for BeanProperties to work with several setters for one BeanProperty.',Rhino,Core,juerg,igor,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; de-de) AppleWebKit/125.5.6 (KHTML, like Gecko) Safari/125.12\nBuild Identifier: \n\nI\'ve modified the way BeanProperties are handled by org.mozilla.javascript.JavaMembers:\nInstead of only one setter, the class can define several setters with different parameters. All the defined \nsetters for one property are uninfied in one NativeJavaMethod. In addition to that, the setter with the \nsame parameter type as the return type of the getter is selected as the main setter. The main setter is \nresponsible for setting a BeanProperty to the value null. Otherwise, the call to the NativeJavaMethod \nthat unifies several setters would be ambigous (e.g. a setter with parameter of class String and one of \nclass Object).\n\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 174588\nBeanProperties patchPatch comments:\n\n1. Cosmetics: please remove all tabs and try to fit lines to 80 chars limit.\n\n2. I would suggest to keep the old implementation if there is only one setter.\nThe idea of using NativeJavaObject for multiple setters is a nice one, but for\nthe common case of single setter it would create 2 additional objects per setter\nand that is not good.\n\n1. I\'m sorry for the tabs and the 80 chars limit, that\'s my default setting here and I didn\'t notice. I\'ll \nadapt to the Rhino style.\n\n2. How do you mean it would generate two objects for one setter? If there\'s only one setter, mainSetter \nand setter actually point to the same object, so only one NativeJavaMethod is used. And I would prefer \nallways use this approach, as otherwise one cannot guarantee that the behavior for how parameters are \nconverted will allways be exactly the same (or at least I\'m not sure about this, I\'m not deeply enough \ninto Rhino...). But one thing I wonder: The NativeJavaMethod that wrapps all setters in one should \nalready exist somewhere anyway. So wouldn\'t it make more sense to reuse that one instead of creating \na new one?(In reply to comment #3)\n> 2. How do you mean it would generate two objects for one setter? If there\'s\nonly one setter, mainSetter \n> and setter actually point to the same object, so only one NativeJavaMethod is\nused. \n\nIn the case of the single setter BeanProperty stored only MemberBox. The patch\nchanges that to NativeJavaMethod containing the one-element array of MemberBox\nwith the original MemberBox. It is 2 additional objects.\n\n> And I would prefer \n> allways use this approach, as otherwise one cannot guarantee that the behavior\nfor how parameters are \n> converted will allways be exactly the same (or at least I\'m not sure about\nthis, I\'m not deeply enough \n> into Rhino...). But one thing I wonder: The NativeJavaMethod that wrapps all\nsetters in one should \n> already exist somewhere anyway. So wouldn\'t it make more sense to reuse that\none instead of creating \n> a new one?\n\nThis is a very good idea :). And then there is no need to create the main setter\nif NativeJavaMethod.call would be split into part serach part and a static\nmethod to apply Java call to MemberBox. Then the static method can be applied to\nthe main setter directly.\nFunny I didn\'t notice this before. I changed my code, it became much simpler and closer to what was \nthere before. The formating should be alright this time too.Created attachment 174616\nUpdated Patch\n\nThe new patch that includes the discussed changes.Marking as fixed: the last changes are in Rhino CVS now.',?,DESIGN_DEFECT
282617,'Problems with serialization of Undefined',Rhino,Core,mcormier,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0\n\nThis might be related to the changes for bug #280047.\n\nMy use case is two applications, one being a \"scripting host\", the other sending\nJavaScript to the first one (over RMI) to evaluate.  The relevant part of the\ninterface is trivial and looks like:\n\n  public interface RemoteScriptingHost extends Remote {\n    public Object eval(String expr) throws RemoteException;\n  }\n\nMy problem is when RMI unmarshals the return value and it\'s undefined, I get an\nexception like:\n\njava.rmi.UnmarshalException: error unmarshalling return; nested exception is: \n\tjava.io.InvalidClassException: org.mozilla.javascript.Undefined; local class\nincompatible: stream classdesc serialVersionUID = 9195680630202616767, local\nclass serialVersionUID = 940272108611353017\n\nBoth applications are launched from the same code base, so I know the versions\nof Undefined match exactly.  Maybe the class needs an explicit serialVersionUID?\n\nReproducible: Always\n\nSteps to Reproduce:Do you use identical JVMs (vendor and version) on both sides?Yes, we\'re talking two instances of the same VM (Sun HotSpot Client 1.4.2_06)\nrunning on the same PC.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This was fixed in CVS HEAD, serial version ID 9195680630202616767 was added manually to the class. It\'ll show up in the next release',?,DESIGN_DEFECT
286251,'initFunction can be called twice',Rhino,Core,gilles.barnier,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\nBuild Identifier: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.0.3705)\n\n      While surfing to the following page:\n\n \n\n      <html>\n\n      <body>\n\n      <form name=\"form1\" method=\"get\">\n\n      First Name <input type=\"text\" name=\"firstName\" value=\"John\"><br>\n\n      Last Name <input type=\"text\" name=\"lastName\" value=\"Doe\"><br>\n\n        <input type=\"submit\" value=\"Submit>>\" name=\"submit\">\n\n      </form>\n\n      <div id=\"div1\"></div>\n\n      <script>\n\n      <!--\n\n      function window.onload()\n\n      {\n\n         document.getElementById(\"div1\").innerText = \"onload triggered\"; \n\n      }\n\n      //-->      \n\n      </script>\n\n      </body>\n\n      </html>\n\n \n\n      The Rhino javascript engine will enter into an infinite loop.\n\n      This is due to an incorrect function parse tree because of a redundant \ninitialization.\n\n      The source of the problem is in the function method at \norg.mozilla.javascript.parser.\n\n      The problematic code is:\n\n \n\n        Node pn = nf.initFunction(fnNode, functionIndex, body, syntheticType);\n\n        if (memberExprNode != null) {\n\n            pn = nf.initFunction(fnNode, functionIndex, body, syntheticType);\n\n \n\n            pn = nf.createAssignment(Token.ASSIGN, memberExprNode, pn);\n\n            if (functionType != FunctionNode.FUNCTION_EXPRESSION) {\n\n                // XXX check JScript behavior: should it be createExprStatement?\n\n                pn = nf.createExprStatementNoReturn(pn, baseLineno);\n\n            }\n\n        }\n\n      \n\n      As you can see in the code, the initFunction can be called twice. The \nhtml example above leads to that redundant initialization.\n\n      We suggest removing the second call to the function method.\n\n\n\nReproducible: Always\n\n\n\n\nThe MIT License\n\nCopyright (c) 2005 VERITAS Operating Company \n\n \n\nPermission is hereby granted, free of charge, to any person obtaining a copy of \nthis software and associated documentation files (the \"Software\"), to deal in \nthe Software without restriction, including without limitation the rights to \nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies \nof the Software, and to permit persons to whom the Software is furnished to do \nso, subject to the following conditions:\n\n \n\nThe above copyright notice and this permission notice shall be included in all \ncopies or substantial portions of the Software.\n\n \n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR \nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, \nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER \nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, \nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE \nSOFTWARE.Created attachment 177503\nFix as patchI committed the fix, thanks for discovering it!',?,BUG
288027,'XMLList object should be instanceof XML',Rhino,E4X,Martin.Honnen,inonit,'Section 13.4.3.10 [[HasInstance]] ( V ) in the E4X specification says that the\ninternal HasInstance method of the XML constructor is special, it should yield\ntrue for both XML and XMLList objects:\n  \"The XML constructor has a more elaborate [[HasInstance]] method than other\nfunction objects. The XML constructor [[HasInstance]] method is defined such\nthat given an XML object or an XMLList object x, the expression x instanceof XML\nwill return true.\"\nRhino doesn\'t implement that currently it seems, as the test case\n\nvar xmlListObject1 = new XMLList(\'<god>Kibo</god>\');\nvar xmlListObject2 = new XMLList(\'<god>Kibo</god><devil>Xibo</devil>\');\n\nprint(\"xmlListObject1 instanceof XML: \" + (xmlListObject1 instanceof XML));\nprint(\"xmlListObject2 instanceof XML: \" + (xmlListObject2 instanceof XML));\n\nyields\n\nRhino 1.6 release 1 2004 11 30\njs> load(\'mozillaBugs/e4x/XMLListInstanceofXML1.js\');\nxmlListObject1 instanceof XML: false\nxmlListObject2 instanceof XML: false\n\nwhile Spidermonkey yields\n\njs> load(\'mozillaBugs/e4x/XMLListInstanceofXML1.js\');\nxmlListObject1 instanceof XML: true\nxmlListObject2 instanceof XML: true\n\nSo this is a bug in Rhino.Created attachment 178802\ntest case to be run in the Rhino or Spidermonkey shellReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Created attachment 254219\nproposed testcase\n\nBob, for your review ...Submitter\'s test now passes if XMLBeans is not present.  See bug 355677.(In reply to comment #3)\n\n> Bob, for your review ...\n\nDavid, did you file the bug to add review flags to Rhino product\'s components?\nNo, I\'m a bit behind on my queue.  I\'ll get caught up as soon as I can ... sorry.Comment on attachment 254219\nproposed testcase\n\nRequesting review with our brand-new mechanism for same. :)Comment on attachment 254219\nproposed testcase\n\n>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n> *\n\nI prefer the mode line be kept separate from the license block in case Gerv \nor someone needs to do bulk edits of the license headers some time in the\nfuture.\n\n...\n\n> *\n> * The Original Code is Rhino code, released\n> * May 6, 1999.\n> *\n> * The Initial Developer of the Original Code is\n> * Netscape Communications Corporation.\n> * Portions created by the Initial Developer are Copyright (C) 1997-2000\n> * the Initial Developer. All Rights Reserved.\n\nNetscape has nothing to do with this and the copyright is wrong. I would prefer\nwe use the boilerplate in <http://lxr.mozilla.org/mozilla/source/js/tests/e4x/template.js>\n\n...\n\n>START(\"13.4.3.10 - XML Constructor [[HasInstance]]\");\n>\n>BUG(288027);\n>\n>var xmlListObject1 = new XMLList(\'<god>Kibo</god>\');\n>var xmlListObject2 = new XMLList(\'<god>Kibo</god><devil>Xibo</devil>\');\n>\n>TEST(1, true, xmlListObject1 instanceof XML);\n>TEST(2, true, xmlListObject2 instanceof XML);\n>\n>END();\n\nmissing end of line.\n\nI think this should be located at e4x/XML/13.4.3.10.js\n\nIf it is alright with you, I\'ll make these edits and check it in.Created attachment 256634\nRe-licensed testCreated attachment 256635\nRenamed testComment on attachment 256635\nRenamed test\n\napproved with minor nits:\n\n1. I didn\'t mean to remove the mode line, just not make it part of the license block. I\'ve gone ahead and added it back in the version I am checking in.\n\n2. The person who filed the bug and/or came up with the original testcase in the bug usually gets the contributor attribution, although the person who creates the actual js test suite version of the test can also get contributor attribution. I\'ve gone ahead and added Martin back to the contributor list to the version I am checking in.\n\n/cvsroot/mozilla/js/tests/e4x/XML/13.4.3.10.js,v  <--  13.4.3.10.jsAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
289117,' in descendants',Rhino,E4X,Martin.Honnen,nobody,'I have a test case I will upload next that has an XML initializer with XHTML\nmarkup. When I iterate with for each over the descendants of the XML object the\nfirst descendant showing up has nodeKind() \'text\' and toString()\n\'<xml-fragment/>\' which is very odd, the first descendant should be the XHMTL\n<head> element.\n\nHere is the result of running the test case I am going to upload with Rhino (1.6\nrelease 1 2004 11 30):\n\njs> load(\'mozillaBugs/e4x/descendantOddity1.js\');\nnodeKind(): text\ntoString(): <xml-fragment/>\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::head\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::title\n\nnodeKind(): text\ntoString(): XHTML example\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::body\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::p\n\nnodeKind(): text\ntoString(): Kibology for all\n\nEverything is fine besides that odd text node. The correct output with\nSpidermonkey is:\n\njs> load(\'mozillaBugs/e4x/descendantOddity1.js\')\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::head\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::title\n\nnodeKind(): text\ntoString(): XHTML example\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::body\n\nnodeKind(): element\nname(): http://www.w3.org/1999/xhtml::p\n\nnodeKind(): text\ntoString(): Kibology for allCreated attachment 179703\ntest case to be run with Rhino or Spidermonkey shellCC Bob Clary to include the test to the suite\n\nTo Martin:\n\nUntil bug 288433 would be resolved and Rhino get a new bug owner I suggest to CC\nBob Clary <moz@bclary.com> whenever you would have a test case that can go to\nthe mozilla JS test suite. I hope Bob would not mind it.sure, cc me on anything you want done related to js qa or the test library.\n\nChecking in 13.4.4.12-1.js;\n/cvsroot/mozilla/js/tests/e4x/XML/13.4.4.12-1.js,v  <--  13.4.4.12-1.js\ninitial revision: 1.1\nReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the upcoming non-XMLBeans implementation of E4X for Rhino.  See bug 355677.Rhino now passes test e4x/XML/13.4.4.12-1.js if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
289294,'Infinite loop during a script compilation',Rhino,Compiler,denis,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.3) Gecko/20040910\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.3) Gecko/20040910\n\nIf I turn the Feature FEATURE_MEMBER_EXPR_AS_FUNCTION_NAME to TRUE like in your\nexample in\nhttp://www.mozilla.org/rhino/apidocs/org/mozilla/javascript/ContextFactory.html\nand i try to compile a script like that: \"function window.onload(){....}\"\nRhino enters in an infinite loop.\nI used Rhino1.6R1.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Take the examples RunScript2\n2. Copy/Past the code from\nhttp://www.mozilla.org/rhino/apidocs/org/mozilla/javascript/ContextFactory.html\nin  the file named: MyFactory.java\n3. Add at the beginning of RunScript2.java the lines:\n      static {\n         // Initialize GlobalFactory with custom factory\n         ContextFactory.initGlobal(new MyFactory());\n     }\n4. Try to execute the following script at the command line:\n     > java RunScript2 \"function window.onload(){return 2;}\"\n\n\n\nActual Results:  \nInfinite loop \n\nExpected Results:  \nAn exception because it\'s not ECMA script compatible\nOr execute the method if you want be like IEThis has been fixed for some time already.',?,BUG
289603,'Update rhino-n.tests to eliminate spidermonkey only tests',Rhino,Core,bclary,bclary,' Created attachment 180098\npatchChecking in rhino-n.tests;\n/cvsroot/mozilla/js/tests/rhino-n.tests,v  <--  rhino-n.tests\nnew revision: 1.58; previous revision: 1.57\n',?,TEST
290034,'Cannot catch in JavaScript the original exception thrown by a host object implemented in Java (ScriptableObject subclass)',Rhino,Core,fernando.olcoz,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.1.4322)\nBuild Identifier: \n\nIt seems there is an inconsistent behaviour between an Object implemented in \nJavaScript and a host object implemented in Java when it comes to throwing \nexceptions.\n?What is the contract a Java host object must honor in order to simulate the \nJS \"throw\" keyword and being catched in JS \"unmodified\"? In 1.5R5, it worked \nthrowing a JavaScriptException(), but in 1.5R6 the JavaScriptException is \nplaced inside a WrappedException.\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Consider the following script:\n\n// examples/problem-ok.js\nfunction JSCounter(n)\n{\n    this.n = n;\n    \n    this.count = function() {\n        if (n > 100) {\n            throw java.lang.IllegalStateException(\"Greater than 100\");\n        }\n        return n++;\n    };\n}\n\nvar c = new JSCounter(100);\ntry {\n    print(c.count());\n    print(c.count());\n}\ncatch (e) {\n    print(e);\n    if (e.javaException) {\n        // NEVER ENTERS HERE\n        print(e.javaException);\n    }\n}\n\nExecuting the script above produces the following, expected, output:\njs> load(\"examples/problem-ok.js\")\n100\njava.lang.IllegalStateException: Greater than 100\n\n2.Create a modified version of the supplied Counter host object that throws an \nexception when the count exceeds the 100 threshold:\n\n// Counter.java\n// ...\n    public int jsGet_count() {\n        if (count > 100) {\n            throw new IllegalStateException(\"Greater than 100\");\n        }\n        return count++;\n    }\n// ...\n\n3.Run the following script, that uses the host object above:\n\n// examples/problem.js\n\ndefineClass(\"Counter\");\n\nvar c = new Counter(100);\ntry {\n    print(c.count);\n    print(c.count);\n}\ncatch (e) {\n    print(e);\n    if (e.javaException) {\n        // ALWAYS ENTERS HERE\n        print(e.javaException);\n    }\n}\n\n4.Running the above script yields the following result:\njs> load(\"examples/problem.js\")\n100\nJavaException: java.lang.IllegalStateException: Greater than 100\njava.lang.IllegalStateException: Greater than 100\n\nActual Results:  \nThe host object implemented in Java is unable to reproduce the \"throw\" keyword \nbehaviour.\n\nExpected Results:  \nThere should be some way to write a host object in Java with members able to \nmimic the JS throw keyword.Created attachment 180479\nProposed change to ScriptRuntime.java\n\nThis proposed change works for me:\n\n    public static Scriptable newCatchScope(Throwable t,\n\t\t\t\t\t   Scriptable lastCatchScope,\n\t\t\t\t\t   String exceptionName,\n\t\t\t\t\t   Context cx, Scriptable scope)\n    {\n\tObject obj;\n\tboolean cacheObj;\n\n\t// *** BEGIN\n\t// FO: Check whether t is a WrappedException that\n\t// contains a JavaScriptException; if so, unwrap\n\tif (t instanceof WrappedException) {\n\t    Throwable innerExc = ((WrappedException)t).getWrappedException();\n\t    if (innerExc instanceof JavaScriptException) {\n\t\tt = innerExc;\n\t    }\n\t}\n\t// *** END\n\t    \n      getObj:\n// rest of method unchangedAn approach that works for me is:\n\n1. Host objects which wish to mimic the \"throw\" keyword behaviour in any of \nits members throw a JavaScriptException(originalException).\n\n2. ScriptRuntime.newCatchScope(...) checks the passed Throwable is a \nWrappedException wrapping a JavaScriptException. In that case unwraps the \nJavaScriptException and proceeds as usual.\nCreated attachment 187353\nBetter fix: JavaScriptException should not be wrappedI committed the fixCreated attachment 208287\nNew testcase that fails with current solution, and a proposed new solution',?,DESIGN_DEFECT
290715,'assignment of XMLList to named property of XML object causes exception in XML beans: Can\'t move/copy/insert a whole document',Rhino,E4X,Martin.Honnen,nobody,'Here is the test case:\n\nvar god = <god><name>Kibo</name></god>;\nprint(god);\n\ngod.name = <><prename>James</prename><nickname>Kibo</nickname></>;\nprint(god);\n\nRhino prints out the XML of god but then throws an exception on the assigment:\n\nRhino 1.6 release 1 2004 11 30\njs> load(\'mozillaBugs/e4x/listAssignment1.js\')\n<god>\n  <name>Kibo</name>\n</god>\njava.lang.IllegalArgumentException: Can\'t move/copy/insert a whole document.\n        at org.apache.xmlbeans.impl.store.Splay.complain(Splay.java:833)\n        at\norg.apache.xmlbeans.impl.store.Splay.checkInsertionValidity(Splay.java:867)\n        at org.apache.xmlbeans.impl.store.Cursor.copyXmlImpl(Cursor.java:2446)\n        at org.apache.xmlbeans.impl.store.Cursor.copyXml(Cursor.java:2410)\n        at org.mozilla.javascript.xmlimpl.XML.copy(XML.java:711)\n        at org.mozilla.javascript.xmlimpl.XML.moveSrcToDest(XML.java:661)\n        at org.mozilla.javascript.xmlimpl.XML.insertChild(XML.java:759)\n        at org.mozilla.javascript.xmlimpl.XML.doPut(XML.java:1001)\n        at org.mozilla.javascript.xmlimpl.XML.putXMLProperty(XML.java:1327)\n        at\norg.mozilla.javascript.xmlimpl.XMLObjectImpl.ecmaPut(XMLObjectImpl.java:233)\n        at\norg.mozilla.javascript.ScriptRuntime.setObjectProp(ScriptRuntime.java:1428)\n        at\norg.mozilla.javascript.ScriptRuntime.setObjectProp(ScriptRuntime.java:1420)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2753)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2164)\n        at\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\n        at\norg.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:149)\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:1251)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:443)\n\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:427)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:364)\n        at org.mozilla.javascript.tools.shell.Global.load(Global.java:171)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n        at java.lang.reflect.Method.invoke(Unknown Source)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:174)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:393)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:3026)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2164)\n        at\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:304)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2769)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2145)\n        at\norg.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:140)\n        at\norg.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:149)\n        at org.mozilla.javascript.Context.evaluateString(Context.java:1220)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:453)\n\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:341)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:160)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:83)\n        at org.mozilla.javascript.Context.call(Context.java:540)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:414)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:140)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:112)\njs: \"C:\\SomePath\\mozillaBugs\\ex\\listAssignment1.js\", line 4: uncaught JavaScript\nruntime exception: TypeError\n: Can\'t move/copy/insert a whole document.\n\nI am using the latest XML Beans from Apache, 1.0.4, but tried with 1.0.3 too\nwith the same result.\n\nSpidermonkey runs the sample without problems and prints\n\n<god>\n  <prename>James</prename>\n  <nickname>Kibo</nickname>\n</god>\n\nas the XML after the assigment. Brendan says that is the correct behaviour, see\nthe newsgroup thread\n<http://groups-beta.google.com/group/netscape.public.mozilla.jseng/browse_frm/thread/5d4b24cf9016e3c6/461803abf820d4de#461803abf820d4de>\nin jseng.Created attachment 180961\ntest case to be run in Rhino or Spidermonkey shellBob, I am adding you to CC so that you can add a test case to the test suite as\nsuggested a while ago by Igor.Martin\'s test added to:\n\n/cvsroot/mozilla/js/tests/e4x/Types/9.1.1.2.js,v  <--  9.1.1.2.js\nnew revision: 1.4; previous revision: 1.3\nReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Created attachment 227697\nMinimalist patch\n\nI haven\'t done the best possible job of analyzing this bug, but I ran across a related one and patched my local copy with the attached patch.  It turns out it also fixes the provided test case.  Not sure whether it handles all possible cases.Validated that the patch indeed fixes the exception with the testcase; committed it. Thanks.',?,BUG
291591,'Rhino has differing behaviour to spidermonkey, and does not conform to ECMA262',Rhino,Core,simon.place,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Win98; en-US; rv:1.8b2) Gecko/20050417 Firefox/1.0+\nBuild Identifier: \n\nline terminators included in string incorrectly\n\nReproducible: Always\n\nSteps to Reproduce:\n1.see results for interactive session log.\n2.\n3.\n\nActual Results:  \nRhino 1.6 release 1 2004 11 30\njs> a=\"a\\\na\"\na\na\njs> a\na\na\njs> a=\"a\njs: \"<stdin>\", line 4: unterminated string literal\njs: a=\"a\njs: ...^\njs: \"<stdin>\", line 4: syntax error\njs: a=\"a\njs: ...^\njs: \"<stdin>\", line 4: Compilation produced 2 syntax errors.\njs> a[2]\na\njs> a[1]\n\n\njs> a.charCodeAt(1)\n10\njs>\n\n\nExpected Results:  \nline terminator should not of been included in the string.Created attachment 191112\nFix: follow SpiderMonkey and C/C++ in \\<LineTerminator> in stringsI committed the fix',?,BUG
291927,'XML.prototype.replace does not work as expected',Rhino,E4X,lipp,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\n\nThe replace method does not work as expected, see below.\n\nReproducible: Always\n\nSteps to Reproduce:\nRun this:\n\nvar root = <root>text</root>;\n\nprint (root.toXMLString());\nprint (root.child(0).toXMLString());\nroot.replace (0, \"new text\");\nprint (root.toXMLString());\n\nActual Results:  \n<root>text</root>\ntext\n<root/>\n\n\nExpected Results:  \n<root>text</root>\ntext\n<root>new text</root>Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the upcoming non-XMLBeans implementation of Rhino E4X; see bug 355677.Created attachment 254033\nproposed testcaseThe results under Rhino without XMLBeans now match the submitter\'s expected results.  See bug 355677.Comment on attachment 254033\nproposed testcase\n\nditto the issues in bug 288027. Since you are working on tests which are identifiable with definite sections in the spec, I think they should be named accordingly... e4x/XML/13.4.4.32-01.js. I prefer using 01,02, etc just for sorting sake in case we ever have more than 9 subtests.\n\nDavid, again, if the changes to the license block, etc. are ok with you, I\'ll go ahead and check in the modified version. Thanks for taking the time to do this. I _really_ do appreciate it.Created attachment 256636\nFixed license and filenameComment on attachment 256636\nFixed license and filename\n\n+ with Michael added as contributor. Sorry I have missed reviewing this test. I am checking it in now./cvsroot/mozilla/js/tests/e4x/XML/13.4.4.32-01.js,v  <--  13.4.4.32-01.js\ninitial revision: 1.1\nAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
291930,'Setting ignoreComments to false discards contents if document starts with comment',Rhino,E4X,lipp,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\n\nIf ignore comments is set to false, a comment preceeding the root node causes\nthe content of the XML (besides the comment) to be ignored.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRun this:\n\nXML.ignoreComments = false;\nvar root = new XML(\"<!-- Sample --> <root/>\");\n\nprint (root.toXMLString());\n\nActual Results:  \n<!-- Sample -->\n\nExpected Results:  \n<!-- Sample --> <root/>Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433The XMLBeans implementation does as the reporter indicates, while the new DOM implementation (see bug 355677) blows up with a ClassCastException.\n\nHowever, reporter\'s \"expected results\" are also wrong; this call should in fact result in a SyntaxError (see ECMA357 10.3.1).\n\nI will patch the DOM code to generate the SyntaxError correctly.Have checked in the fix for this.Created attachment 254301\nProposed testcaseCreated attachment 256637\nFixed license and filename\n\nDon\'t know if this really pertains to a spec section or not.Created attachment 256638\nRe-renamed file :) ... to fit existing conventionComment on attachment 256638\nRe-renamed file :) ... to fit existing convention\n\napproved with nits: modeline and contributor attribution. I\'ve kept the initial developer info as you modified it but would really appreciate it after today if you can just take the normal boilerplate from the e4x/template.js file and modify that. \n\n/cvsroot/mozilla/js/tests/e4x/XML/regress-291930.js,v  <--  regress-291930.jsBob:  I\'m not following what you mean here in terms of (a) initial developer info and (b) modifying the normal boilerplate from the e4x/template.js file.  I was working off what Gerv says in bug 329257 comment 8.  As for (a) it would seem presumptuous for me to represent myself (or a bug reporter) as \"Mozilla Foundation.\"  As for (b) the two look the same to me but I may have missed something. :)\n\nI have several more tests sitting in my queue so I wanna get \'em right so that I can avoid the dreaded nits on batch #2. :)\n\nI understand the other two nits (mode and contributor list), and it seems you like my new filenams, so we\'re most of the way there ...From my point of view, it\'s not that you are representing yourself as the Mozilla Foundation but how much ownership you want to claim on a test. For example, someone else files a bug with a testcase and you do the clerical work of wrapping it in the test framework. Are you the original author? I don\'t consider myself to be one when I do that (although I am an Corporation employee and probably shouldn\'t be one in any circumstance). Whenever I create tests I use the template.js, use the Foundation as the original and list the other people involved in filing the bug, creating the original test cases as the contributors and leave myself out of the loop altogether.\n\nI don\'t know that it matters, but if you are consciously doing it for a specific reason and it is ok with Gerv, then go head but if you don\'t care then I would prefer to just use the normal boilerplate from template.js in each directory so there is one less difference for us to worry about.Bob:  I hear you on the first part and I\'m happy to list the bug reporter as the author of the original code (for example).  It just seems odd to list Mozilla Foundation as the developer of that code when a bug reporter contributed the test as part of a bug report and I integrated it into the test framework and neither of us is affiliated with Mozilla (except in spirit).  Gerv seems to indicate that the initial contributor ought to depend on who submits the code: \"So if the files are your own work, then you are the Original Author.\"  \n\nSeveral Rhino files do this -- when I wrote my original license parser, it was the first time I realized that we didn\'t put \"Netscape Communications Corporation\" in every file.  No Rhino files list the Foundation (or none did when I did my initial license parsing code).  So that combined with Gerv\'s comment is where I\'ve taken my guidance from so far.\n\nBut I am not a license ideologue and will do whatever we decide we do. :)  I even have the process automated so that I can emit the license with the appropriate parameters via a command-line script.  But my two cents are that saying that the Foundation is the author of the code just to make our housekeeping easier isn\'t taking the license seriously enough, even if I\'m not a license stickler.  And I feel even worse about it if the author wasn\'t me.I don\'t think I am being flippant with regard to the license. Perhaps I worded my expression of my position unclearly.\n\nI guess it depends on how you place yourself in relation to the Foundation and whether you consider the Foundation separate from the Project and the Community. Are you positioned like IBM where they _are separate_ and clearly mark everything they touch and claim separate ownership or do you consider yourself as much a part of the Foundation as Gerv or Frank simply because you are a member of the community and wish the Foundation to be the clear owner?\n\nFinally, when more than one person is involved in the creation through the filing of the bug report, the creation of the initial testcase etc, it is the community (and therefore in my opinion the Foundation) that is the original author and not the person who did the labor of putting it altogether in a single file.\n\nIf this is too much trouble, just mark the bug with a in-testsuite? and I\'ll do the clerical work for Rhino the same way I have for SpiderMonkey.\n\nIf Gerv wishes to make the final call I\'ll abide by that.\n(In reply to comment #11)\n> I guess it depends on how you place yourself in relation to the Foundation and\n> whether you consider the Foundation separate from the Project and the\n> Community. \n\nI\'m happy to hear what the Foundation considers itself.  The Foundation is a legal entity and I don\'t pay any dues or whatever so I don\'t really consider myself a \"part\" of it so much as a \"supporter\" or even a \"fan.\"  But I suppose I could. :)\n\nI mean (strangely enough) I also had an experience where I ran a rather large volunteer organization and I know that some volunteers referred to us as \"us\" and some volunteers referred to us as \"you,\" and so I recognize that this is open to interpretation.\n\n> Are you positioned like IBM where they _are separate_ and clearly\n> mark everything they touch and claim separate ownership or do you consider\n> yourself as much a part of the Foundation as Gerv or Frank simply because you\n> are a member of the community and wish the Foundation to be the clear owner?\n\nNo, my position (which is open to change) is that the license says what it says.  If it said \"owner\" I\'d happily sign it over.  But it says \"developer\" and that is just not true (unless I decide I and patch contributors are all part of the Foundation, which I am also open to as I mentioned).  And that makes me feel ... guilty?  Of course, being such a PITA makes me feel guilty, too.  Can you tell I was raised [gratuitous religious affiliation redacted]?\n\n> Finally, when more than one person is involved in the creation through the\n> filing of the bug report, the creation of the initial testcase etc, it is the\n> community (and therefore in my opinion the Foundation) that is the original\n> author and not the person who did the labor of putting it altogether in a\n> single file.\n\nWhether community = Foundation is way beyond my expertise here.  I\'m just a n00b. :)  Lemme know what y\'all think.\nLet\'s not create a storm in a teacup; it\'s five lines of code.\n\nGiven the way the code was created, either: \"Original Developer: David Caldwell; Contributor: Michael Lipp\" or the reverse would be entirely reasonable. Choose whichever one you think best reflects the truth of what happened.\n\nI don\'t think that it would be appropriate to give the Foundation as the original developer. People who are employed by the Foundation or Corporation do so because the Foundation is actually the copyright owner - but that is not the case for you. The attribution of Original Developer is a matter of copyright law, not a matter of community affiliation or otherwise.\n\nHope that helps sort things out :-)\n\nGerv(In reply to comment #13)\n> Let\'s not create a storm in a teacup; it\'s five lines of code.\n\nHopefully many more to come, though I am sure the volume in js/rhino will exceed that in js/tests. :)\n\n> Given the way the code was created, either: \"Original Developer: David\n> Caldwell; Contributor: Michael Lipp\" or the reverse would be entirely\n> reasonable. Choose whichever one you think best reflects the truth of what\n> happened.\n\nI think in the future I will list the person who submitted the original test case as the original developer unless it needs to be completely rewritten.  I\'ll be a contributor (unless they write it using the test framework, in which case I will be nothing).\n\nBob:  I\'ve got about six more of these in my directory; I haven\'t looked at them for a while so don\'t remember why they didn\'t get submitted in the first batch but I imagine I\'ll get to them soon.\n\nThanks, everyone. :)Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
291937,'appendChild appends element instead of text \"node\"',Rhino,E4X,lipp,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\n\nWhen calling appendChild with a String argument, it should be appended as \"text\"\nnode, even if the string looks like XML\n\nReproducible: Always\n\nSteps to Reproduce:\n// Run this:\n\nvar root = <root/>\nvar s = \"<text/>\";\nroot.appendChild (s);\nprint (root.toXMLString());\n\nActual Results:  \n<root>\n  <text/>\n</root>\n\n\nExpected Results:  \n<root>&lt;text/&gt;</root>Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug is fixed in the upcoming non-XMLBeans Rhino E4X implementation.  See bug 355677.Results match submitter\'s expected results if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
292324,'ArrayIndexOutOfBoundsException while compiling a script',Rhino,Compiler,szegedia,igor,'User-Agent:       Opera/8.0 (Windows NT 5.0; U; en)\nBuild Identifier: \n\nAn attempt to compile the attached script will throw an \nArrayIndexOutOfBoundsException in the interpreter. \n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Paste the attached function definition into a Rhino console (you might have \nto do it twice as first time it will complain \"java.io.IOException: Not enough \nstorage is available to process this command\" - ignore it, and paste the \nfunction code once more)\n2.\n3.\n\nActual Results:  \nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: 1024\n        at org.mozilla.javascript.Interpreter.recordJump(Interpreter.java:1524)\n        at org.mozilla.javascript.Interpreter.addGoto(Interpreter.java:1456)\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:\n719)\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:\n652)\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:\n673)\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:\n652)\n        at org.mozilla.javascript.Interpreter.generateICodeFromTree(Interpreter.\njava:502)\n        at org.mozilla.javascript.Interpreter.generateFunctionICode(Interpreter.\njava:493)\n        at org.mozilla.javascript.Interpreter.\ngenerateNestedFunctions(Interpreter.java:577)\n        at org.mozilla.javascript.Interpreter.generateICodeFromTree(Interpreter.\njava:498)\n        at org.mozilla.javascript.Interpreter.compile(Interpreter.java:455)\n        at org.mozilla.javascript.Context.compileImpl(Context.java:2220)\n        at org.mozilla.javascript.Context.compileString(Context.java:1284)\n        at org.mozilla.javascript.Context.compileString(Context.java:1273)\n        at org.mozilla.javascript.Context.evaluateString(Context.java:1129)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:453)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:341)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:160)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:83)\n        at org.mozilla.javascript.Context.call(Context.java:528)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:414)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:140)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:112)\n\n\nExpected Results:  \nShould have silently compiled the function.Created attachment 182153\nA function definition that causes the Rhino to crash\n\nA trivial change to the script, i.e. rewriting\n\n    f2(\"a0=\" + a0);\n\nto\n\n    f2(\"a0=\");\n\nor even\n \n    var x = \"a0=\" + a0;\n    f2(x);\n\nwill make the compilation succeed. So, while it can be worked around, it should\nbe fixed as there\'s no guarantee that the compiled code is correct if the\nscript compiler otherwise has a bug.*** Bug 296959 has been marked as a duplicate of this bug. ***(In reply to comment #2)\n> *** Bug 296959 has been marked as a duplicate of this bug. ***\n\nOn this second page with description of bug 296959 there is proposed solution\nfor it.Created attachment 185596\nCommittable patch, based on the fix proposed by hauserx@gmail.com\n\nThanks a lot - I transformed your proposal into a committable patch. Hopefully\nsooner or later a Rhino committer will come along and commit it to CVS.Created attachment 185597\nCommittable patch, based on the fix proposed by hauserx@gmail.com\n\nForget the previous one, mistakenly attached whole Interpreter.java instead of\njust the diff :-[There is a bug in the patch i have proposed, it should be:\n\n            int capacity = itsData.itsICode.length;\n            int capacityNeeded = offsetSite+2;\n            if( capacity<capacityNeeded) {\n                increaseICodeCapasity( capacityNeeded-itsICodeTop);\n            }\n                                                      ^^^^^^^^^^^\nInstead of:\n\n            int capacity = itsData.itsICode.length;\n            int capacityNeeded = offsetSite+2;\n            if( capacity<capacityNeeded) {\n                increaseICodeCapasity( capacityNeeded-capacity);\n            }\n                                                      ^^^^^^^^ (In reply to comment #6)\n> There is a bug in the patch i have proposed, it should be:\n> \n>             int capacity = itsData.itsICode.length;\n>             int capacityNeeded = offsetSite+2;\n>             if( capacity<capacityNeeded) {\n>                 increaseICodeCapasity( capacityNeeded-itsICodeTop);\n>             }\n>                                                       ^^^^^^^^^^^\n\nNote that the version of patch from Attila already contains the proper fix.(In reply to comment #5)\n> Created an attachment (id=185597) [edit]\n> Committable patch, based on the fix proposed by hauserx@gmail.com\n> \n\nI committed the patch.',?,BUG
293958,'\"(100.0 * Number.MIN_VALUE).toPrecision (12);\" fails',Rhino,Core,sweeks,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.6) Gecko/20050223 Firefox/1.0.1\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.6) Gecko/20050223 Firefox/1.0.1\n\nThe statement causes StringIndexOutOfBoundsException.\n\nReproducible: AlwaysCreated attachment 188968\nFix for the bug\n\nI\'ve fixed this -- I refactored the stripping of trailing zeroes into a\nseparate method, as it is performed from more than one place.\n\nThere are still some rough edges with my CVS access, so I can\'t commit this\nmyself at the moment.Any objections to me committing this?(In reply to comment #2)\n> Any objections to me committing this?\n\nNot an objection, but rather observation: the patch makes some cases where Rhino\ncurrently hits the exception to go to infinite loop due to other bugs in DTOA\ncode. Fixing those bugs can trigger redesign of the whole code and in a longer\nterm the patch can be irrelevant.(In reply to comment #3)\n> Not an objection, but rather observation: the patch makes some cases where \nRhino\n> currently hits the exception to go to infinite loop due to other bugs in DTOA\n> code. Fixing those bugs can trigger redesign of the whole code and in a longer\n> term the patch can be irrelevant.\n\nHm - I was unaware of these other bugs. Regardless, until those other bugs are \nfixed, the current patch would still improve the existing situation, wouldn\'t \nit? So the question is, do you see sense in committing this patch until the \nother bugs are tackled? (Your observation would suggest your opinion is that it \ndoes not, but you weren\'t explicit about it :-) )Created attachment 194151\nA better fix for the bug\n\nThe original fix for the bug was itself buggy -- an occurrence of the \"!=\"\noperator should have been \"==\" instead :-[Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Committed the fix to CVS.',?,BUG
298786,'Infinite loop when compiling with optimization',Rhino,Core,mcbp223,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; T312461; YComp 5.0.0.0; .NET CLR 1.1.4322; .NET CLR 2.0.50215)\nBuild Identifier: \n\nRhino compiler gets in a infinite loop when \ncompiled with -opt greather than zero, for this file: \n\n------------------------------?------------ \n// file infloop.js \nfunction infLoop(inStr) { \n  var i = -1; \n  while ((i = inStr.indexOf(\"\%\")) != -1) { \n    inStr = inStr.replace(\"\%\", \"\"); \n  } \n\n  return inStr; \n}\n\nvar str = infLoop(\"abc\%def\"); \n------------------------------?------------ \n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. save the above code in a file (infloop.js)\n2. java -cp js.jar org.mozilla.javascript.tools.jsc.Main -opt 1 infloop.js\n\nActual Results:  \nCompiler hangs, with processor at 100\%.\nIf compiled with -opt 0 the compilation succeeds and a class file is generated.\n\n\n\nTested and reproduced with 1_5R5 and 1_6R1.\n\nIn 1_5R5 the loop is in the class\norg.mozilla.javascript.optimizer.Optimizer\nin\n    private static void\n    typeFlow(OptFunctionNode fn, Block theBlocks[])\n\nI did not debug with 1_6R1 sources but I assume it is in the same place.Created attachment 187339\nFix\n\nAFAICS this one-line fix is enough to fix the optimizer issue that caused the\nbug. But since the bug was in Rhino since the first public release and survived\nall the changes during last 5 years I am very reluctant to commit the fix\nwithout really good testing.I committed the patch.(In reply to comment #2)\n\nI still have some infinite loops when I set \nContext.FEATURE_MEMBER_EXPR_AS_FUNCTION_NAME true and I use the feature, both \nin the compiler and at runtime. Should this go in a separate bug report?(In reply to comment #3)\n> (In reply to comment #2)\n> \n> I still have some infinite loops when I set \n> Context.FEATURE_MEMBER_EXPR_AS_FUNCTION_NAME true and I use the feature, both \n> in the compiler and at runtime. Should this go in a separate bug report?\n\nDo you see this with latest CVS tip as well? It contains a few fixes in this\narea. If yes, then file a bug indeed.',?,BUG
299539,'Bad bytecode for function assignments',Rhino,Core,igor,igor,'From a message that Mike C. posted to netscape.public.mozilla.jseng:\n\nHi,\nI am trying to use the new refGet/refSet features in 1_6R1, but I get an\nerror when trying to load the generated class.\n\nExample:\n// file rassign.js\nSession(\"foo\") = \"bar\";\n\n-------------------------\njava -cp js.jar org.mozilla.javascript.tools.jsc.Main rassign.js\n\njava -cp .;js.jar rassign\n\nException in thread \"main\" java.lang.VerifyError: (class: rassign, method:\n_c0 s\nignature:\n(Lrassign;Lorg/mozilla/javascript/Context;Lorg/mozilla/javascript/Scri\nptable;Lorg/mozilla/javascript/Scriptable;[Ljava/lang/Object;)Ljava/lang/Obj\nect;\n) Incompatible argument to function\n-------------------------\n\nIf I decompile the generated class and I recompile it with Sun\'s javac\n(after converting the DUP instructions in the function exec() to a Java\naccepted call), the class gets loaded correctly.\n\nTested with JRE 1.4.2 and 1.5.Created attachment 188127\nFixI committed the fix(In reply to comment #2)\n> I committed the fix\n\nThanks for your quick response.\n\nThere\'s one more problem that leaves the Context.scratchRefTarget unpopped, I \nthink in \n    ScriptRuntime.callRef() \nthe call to \n    storeScriptable(cx, thisObj); \nshould be changed to \n    ref.pushTarget(cx, ref, thisObj);\nif later on in the generated class you\'ll use ref.popTarget().\n\nAlso you might want to mark this bug as related to 243057.(In reply to comment #3)\n> (In reply to comment #2)\n> > I committed the fix\n> \n> Thanks for your quick response.\n> \n> There\'s one more problem that leaves the Context.scratchRefTarget unpopped, I \n> think in \n>     ScriptRuntime.callRef() \n> the call to \n>     storeScriptable(cx, thisObj); \n> should be changed to \n>     ref.pushTarget(cx, ref, thisObj);\n> if later on in the generated class you\'ll use ref.popTarget().\n\nThis is not applicable to the CVS head. After 1.6R1 the Ref was changed not to\npass the target argument there. It simplified the implementation for the price\nof forcing Ref objects to store the target themselves.\n\n*** Bug 301488 has been marked as a duplicate of this bug. ***',?,BUG
299613,'Runtime support for function-results-as-lvalue',Rhino,Core,igor,igor,'Currently Rhino has very limited runtime support for implementing\nfunction-results-as-lvalue. In particular it requires to subclass BaseFunction\nto override its callRef method. This is very inconvenient since to support the\nnotion like\n\nfoo() = bar\n\nwhere foo is a host object implementing Scriptable interface one forced to\nextend BaseFunction witch could force significant refactoring.\n\nThe idea would be to introduce a new interface that extends Callable to denote\nan object where () can return an lvalue represented as Ref subclass in Rhino.Created attachment 188183\nImplementation\n\nThe patch adds RefCallable interface extending Callable and updates code\ngeneration/runtime to call refCall method in the new interface when necessary.\nAnother important consequence of the patch is that it changes implementation of\n\"()\" operator to require only Callable interface, not Function for its target.\nIn this way host objects that needs to support cases like:\n\nmatrix(0, 1) = 1; \nmatrix(1, 2) = matrix(0, 1);\nmatrix(0, 1) += 10;\n\nwould just need to implement RefCallable in addition to Scriptable and not\nworry about implementing Function.construct which is not necessary in this\ncase.(In reply to comment #1)\n\nI was wondering if RefCallable should extend Callable or can be just an \nindependent interface, to make it even more flexible.\n\nAnyway if you can keep this change - and test only for Callable/RefCallable \nwhere you used to test for Function or BaseFunction - will help a lot in \nembeddings, sometimes Function is too heavyweight.I committed the patch',?,RFE
302501,'constructor property shouldn\'t be readonly',Rhino,Core,norrisboyd,norrisboyd,'Test case:\n\nfunction f() { }\nfunction g() { }\nf.prototype.constructor = g;\nprint(f.prototype.constructor == g);\n\nShould print \"true\".Fix:\n\nIndex: BaseFunction.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/BaseFunction.java,v\nretrieving revision 1.54\ndiff -u -r1.54 BaseFunction.java\n--- BaseFunction.java\t6 Feb 2005 01:56:46 -0000\t1.54\n+++ BaseFunction.java\t28 Jul 2005 14:07:58 -0000\n@@ -407,9 +407,7 @@\n     private void setupDefaultPrototype()\n     {\n         NativeObject obj = new NativeObject();\n-        final int attr = ScriptableObject.DONTENUM |\n-                         ScriptableObject.READONLY |\n-                         ScriptableObject.PERMANENT;\n+        final int attr = ScriptableObject.DONTENUM;\n         obj.defineProperty(\"constructor\", this, attr);\n         // put the prototype property into the object now, then in the\n         // wacky case of a user defining a function Object(), we don\'t\n\nChecking in BaseFunction.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/BaseFunction.java,v  <--  B\naseFunction.java\nnew revision: 1.55; previous revision: 1.54\ndone',?,BUG
303460,'Enhance Rhino\'s shell to execute compiled script .class files from command line',Rhino,Core,pcbeard,igor,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en) AppleWebKit/412.6 (KHTML, like Gecko) Safari/412.2\nBuild Identifier: \n\nRhino provides an ahead of time compiler that creates a .class file that encapsulates a compiled \nJavaScript. Currently the only EASY way to run these directly from the command line is like this:\n\njsc script.js\njava script\n\nIt would be nice to be able to load multiple scripts into the same shell like this:\n\njsc script1.js script2.js script3.js\njs script1.class script2.class script3.class\n\nThis would let you use a mixture of interpreted and compiled scripts.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 191627\nPatch to Main.java to execute compiled script .class files.(In reply to comment #1)\n> Created an attachment (id=191627) [edit]\n> Patch to Main.java to execute compiled script .class files.\n> \n\n3 problems:\n\n1. The patch ignore requested security restrictions: Use\nSecurityController.createLoader(cx.getApplicationClassLoader(), securityDomain),\nnot new DefiningClassLoader()!\n\n2. The does not report errors properly. That has to be done in the same way as\nevaluateScript does. \n\n3. The patch does not handle urls which shell allows to use for scripts.Created attachment 191748\nPatch to Main.java to execute compiled script .class files. v2\n\nUpdated the patch to address your requirements. Added a new method,\nevaluateCompiledScript(), which maps errors in a similar way to\nevaluateScript(), and also supports URLs. We might want to revisit\nprocessFileSecure() to always map filenames to URLs, rather than going through\na code path that almost always generates a MalformedURLException.Created attachment 191750\nPatch to Main.java to execute compiled script .class files. v3\n\nThis version correctly computes the name of the class using the leaf name of\nthe URL path.Created attachment 191875\nPatch version with uniform treatment of file/url guessing\n\nI changed the patch to treat file-or-url arguments uniformly both for *.js and\n.class. The new version assumes that the argument is URL if it includes \':\' or\nfilename if it does not.My only concern was that on DOS/Windows, absolute path names will always include a \':\' character, and \nwill thus take the exception when failing to convert to a URL...Perhaps ensuring that there\'s at least 2 or more characters in the string in front of the \':\' character would \nbe better. Or comparing against a list of known URL schemes. What was wrong with my approach of \nassuming path, then validating with File.exists()?(In reply to comment #7)\n> Perhaps ensuring that there\'s at least 2 or more characters in the string in\nfront of the \':\' character would \n> be better.\n\nRight, I forgot about Windows paths. It is enough to assume that protocol should\nbe at least 2 chars IMO as with one-letter protocols c:yyy would be inherently\nambiguous.\n\n> What was wrong with my approach of \n> assuming path, then validating with File.exists()?\n\nWhen security manager prevents accessing file system calling File.exist would\nthrough sn exception even if the URL can be accessed.\nCreated attachment 192672\nWindows paths are paths and execution cleanup.\n\n1. The patch assume that path is URL if protocol is at least 2 letter long.\n\n2. The patch uses shared code to read both source and compiled scripts and for\nscript execution using explicit Context.compileString to get Script from the\nsource.I committed the last patch. It would be nice to extend it to extract script\nclass name from the bytecode itself to allow package names in the compiled\nscripts and to detected class/source based on the file context, not name, but\nthat is for a separated bug.',?,RFE
303572,'Need access to underlying RhinoException in rethrown error objects',Rhino,Core,szegedia,szegedia,'User-Agent:       Opera/8.01 (Windows NT 5.0; U; en)\nBuild Identifier: \n\nThere\'s a situation where scripts catch and then selectively rethrow exceptions:\n\ntry\n{\n    ...\n}\ncatch(e)\n{\n    if(e instanceof JavaException && e.javaException.class.name == \"com.foo.\nValidationException\")\n    {\n        ...\n    }\n    else\n    {\n        throw e;\n    }\n}\n\nNow, when the thrown exception is some internal Rhino exception, i.e. TypeError, \nits stack trace will be lost after the throw -- the Java code invoking the \nscript will ultimately get a JavaScriptException with the error object \nconstructed in the catch clause. I\'d suggest that similar to the nonstandard \n\"javaException\" field, the error object should also have an also nonstandard  \n\"rhinoException\" field for these exceptions. Then the Java code invoking the \nscript could do the following to ensure it logs the root cause exception \nregardless of how many times it is caught and rethrown in the script:\n\nThrowable terminationCause;\ntry\n{\n    script.exec(...);\n    terminationCause = null;\n}\ncatch(JavaScriptException e)\n{\n    terminationCause = e;\n    Object val = e.getValue();\n    if(val instanceof Scriptable)\n    {\n        Object njo = ScriptableObject.getProperty(((Scriptable)val), \n                \"rhinoException\");\n        if(njo instanceof NativeJavaObject)\n        {\n            val = njo;\n        }\n        else\n        {\n            njo = ScriptableObject.getProperty(((Scriptable)val), \n                \"javaException\");\n            if(njo instanceof NativeJavaObject)\n            {\n                val = njo;\n            }\n        }\n    }\n    if(val instanceof NativeJavaObject)\n    {\n        Object t = ((NativeJavaObject)val).unwrap();\n        while(t instanceof InvocationTargetException)\n        {\n            t = ((InvocationTargetException)t).getCause();\n        }\n        if(t instanceof Throwable)\n        {\n            terminationCause = (Throwable)t;\n        }\n    }\n}\ncatch(Throwable t)\n{\n    terminationCause = t;\n}\nif(terminationCause != null)\n{\n    logger.error(\"Script failed\", terminationCause);\n}\n\nI\'ll attach a patch\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 191702\nThe patch that implements the feature\n\nI\'ve attached the patch that implements the feature. If nobody objects until\nMonday, I\'ll commit it then.Committed the patch.',?,DESIGN_DEFECT
304451,'RHINO shell runCommand passes closing quote of argument to command',Rhino,Core,michael.giroux,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.10) Gecko/20050716 Firefox/1.0.6\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.10) Gecko/20050716 Firefox/1.0.6\n\nSee example below -- from the output generated by the cmd.exe you can see that\nthe javascript shell runCommand passed the closing quote of the second argument\non to cmd.exe as part of the argument.  The quote should have been removed.\n\njs> runCommand(\"cmd.exe\", \"/c echo hello\")\nhello\"\n\nThis causes some commands to fail.  See example below:\nRhino 1.6 release 1 2004 11 30\njs> runCommand(\"cmd.exe\", \"/c dir /on\")\nParameter format not correct - \"\"\".\n1\njs>\n\nIn the example above, the effective command was: dir /on\"\nThis caused cmd.exe to issue the parameter format error.\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java -jar js.jar\n2. js> runCommand(\"cmd.exe\", \"/c echo hello\")\n\nThe output that is echoed to console will include the closing quote following hello.\n\nActual Results:  \nResults vary depending on what te executable does with the invalid argument.\n\nExpected Results:  \nThe closing quote on the argument string should be removed before invoking the\ndesired command.Hello.\nAn appropriate argument list of \"cmd\" is as follows.\n# Maybe, even windows is similar though it is OS/2. \n\nrunCommand(\'cmd\', \'/c\', \'echo hello\')\nrunCommand(\'cmd\', \'/c\', \'dir /on\')\n\nvar opt = { args: [\'BOOKSHELF\', \'HELP\'], output: \'\' }\nrunCommand(\'cmd\', \'/c\', \'env.cmd\', opt)\nThanks, I see what i\'ve done wrong.\n\nPerhaps in a future update. the javadocs for runCommand could be updated to make\nit more obvious to those of us who might overlook the subtle difference in the\nsyntax.  Perhaps include the example that is shown in this message.\n\nMichaelI added examples with runCommand usage on Windows to Rhino docs, see\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/docs/shell.html .',?,BUG
305323,'Rhino fails to select the appropriate overloaded method',Rhino,Core,szegedia,szegedia,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; en) Opera 8.02\nBuild Identifier: \n\nNote: this might be related to Bug 13415.\n\nWhen Rhino needs to select from overloaded methods, and the declared types of \nmethods are are (String, String, String) and (String, Object, Object), and the \nactual types are (java.lang.String, java.lang.String, org.mozilla.javascript.\nNativeJavaObject wrapping java.lang.String), it will find the choice ambigous.\n\nReproducible: Always\n\nSteps to Reproduce:\nRun this example:\n\npublic class RhinoReflectionTest\n{\n    public static void assertEquals(String s1, String s2, String s3)\n    {\n        System.err.println(\"s\");\n    }\n    \n    public static void assertEquals(String s1, Object o2, Object o3)\n    {\n        System.err.println(\"o\");\n    }\n    \n    public static void main(String[] args) throws Exception\n    {\n        Context cx = Context.enter();\n        Script s = cx.compileString(\n                \"Packages.test.RhinoReflectionTest.assertEquals(\\\"\\\", \\\"\\\", new \njava.lang.String());\", \"\", 1, null);\n        ScriptableObject scope = cx.initStandardObjects();\n        s.exec(cx, scope);\n    }\n}\nActual Results:  \nException was thrown:\n\norg.mozilla.javascript.EvaluatorException: The choice of Java constructor \nassertEquals matching JavaScript argument types (string,string,java.lang.String) \nis ambiguous; candidate constructors are: \n    class java.lang.String assertEquals(java.lang.String,java.lang.Object,java.\nlang.Object)\n    class java.lang.String assertEquals(java.lang.String,java.lang.String,java.\nlang.String) (#1)\n\n\nExpected Results:  \nSuccesfully execute, printing \"s\".The problem is in NativeJavaObject.getConversionWeight that deviates from LC3 \nmethod overloading specification <http://www.mozilla.org/js/liveconnect/\nlc3_method_overloading.html> in point 3.3.6.1. Namely, if the method\'s declared \nargument type is java.lang.String, it will return \"2\" even if the passed \nNativeJavaObject is an instance of java.lang.String, where LC3 3.3.6.1 says that \nthe first in the order of preference of conversions for NativeJavaObject should \nbe \"Any interface or class that is assignment-compatible with the Java object \nobtained by unwrapping the JS object, i.e. the unwrapped JavaObject is an \ninstanceof() the Java argument type.\"Created attachment 193289\nfix for the bug\n\nAttached a fix for the bug. Basically, I moved the instanceOf check to be\nearlier than the if(to == String.class) check, so it\'s compliant with LC3. I\'m\nnot aware if this will break anything, nor am I aware if it was written\nintentionally this way in the first place. So, I\'d appreciate some peer review\nbefore committing the patch.I was reviewing potential side-effects of this patch, but the NativeJavaObject.\ngetConversionWeight() method I modified is only used from NativeJavaMethod.\npreferSignature() [it was fixed exactly for it] and from NativeJavaMethod.\ncanConvert(). canConvert() only checks if the returned value is less than \nCONVERSION_NONE, so the patch can have no effect on it. So I\'m fairly confident \nthis shouldn\'t break anything.Committed the patch to CVS.',?,BUG
305753,'NativeJavaMethod objects have incorrect parent when using parent scopes',Rhino,Core,szegedia,igor,'User-Agent:       Opera/8.02 (Windows NT 5.0; U; en)\nBuild Identifier: \n\nI\'m using a shared scope -- all scopes have it as their prototype. The \nClassCache is associated with the shared scope. Yet, when the Java binding \nmachinery creates new instances of NativeJavaMethod in JavaMembers.lookupClass(\n), the newly created NativeJavaMethod objects will have the NativeJavaObject\'s \nparent scope as their parent scope. However, this parent scope is temporary and \nshould get garbage collected, while the NativeJavaMethod persists in the \nClassCache associated with the shared scope, and holds a strong reference to the \ntemporary scope.\n\nAs a solution, I propose that ClassCache stores the information about the scope \nit is associated with (i.e. the shared scope), and JavaMembers are created \nagainst that scope.\n\nReproducible: AlwaysCreated attachment 193687\nPatch that fixes the bug\n\nAttached a patch that fixes the bug. Also note I fixed the return value of\nClassCache.associate()Created attachment 193688\nSame patch, but with corrected formatting of opening brace\n\nAttached again - one opening brace was misplaced. I\'ll commit it early friday\nif there are no objections to it.(In reply to comment #0)\n> As a solution, I propose that ClassCache stores the information about the scope \n> it is associated with (i.e. the shared scope), and JavaMembers are created \n> against that scope.\n> \n\n\nHere is some history behind ClassCache. Before its introduction Rhino stored\ncached instances of various objects for LiveConnect support in static variables.\nThat was wrong leading not only to memory leaks but also potential security\nbreaches via accessing independent runtime objects through __parent__/__proto__\nproperties.\n\nDuring the transition from static to ClassCache I hoped to separate caching of\nJava reflection helper with their JavaScript wrappers. In this way it would be\npossible to share ClassCache between independent scopes and save memory since\nwrappers would be created only when necessary (it was actual for the project I\nworked).\n\nThe idea was to create extremely lightweight version of NativeJavaMethod which\nwould be created each time when one need to accesses, for example, println, in\njava.lang.System.out. Then the wrapper for System.out would store only reference\nto small reflection helper object for println function without any scope refs\nallowing to cache that between independent scopes. \n\nMoreover, with some code generation tuning that wrapper object would be\nunnecessary in most cases since in\njava.lang.System.out.println() the wrapper is not visible and can be avoided\ncompletely.\n\nThe problem was with code like java.lang.System.out.println.foo = \"bar\" that\nLiveConnect allowed. It requires to store properties in wrappers persistently\nand I was never able to come up with simple solution without using weak\nhashtables which were not available on the JVM for the project.\n\nGiven that it is only right to store scope in ClassCache and document that\nsharing of ClassCache between scopes are not allowedand NEVER was.\n(In reply to comment #3)\n> \n> Given that it is only right to store scope in ClassCache and document that\n> sharing of ClassCache between scopes are not allowedand NEVER was.\n> \n\nSorry, I couldn\'t parse from what you wrote whether my patch is okay. :-) \n\nI\'m not sharing ClassCache between scopes -- I\'m having a \"master\" scope \n(scope_0) that is a prototype to multiple subscopes (scope_1...scope_n). The \nlookup of \"associated values\" in ScriptableObject is such that ClassCache.\nget(scope_1) == ... == ClassCache.get(scope_n) == ClassCache.get(scope_0). \nStrictly speaking, that ClassCache belongs to scope_0. Actually, I find it OK \nthis way, as the Function prototype (which is the prototype object of \nNativeJavaMethod objects) also lives in scope_0 (it is the one that has all \nstandard objects initialized in it). \n\nIt\'d be rather inefficient if each scope_i (i > 0) would have its own \nClassCache, as that\'s mean each would need to do reflective discovery on its \nown, and these scopes are continually created and destroyed on 50 threads as \nthey process their work units.(In reply to comment #4)\n> \n> Sorry, I couldn\'t parse from what you wrote whether my patch is okay. :-) \n\nThe patch is OK and fixes the real bug! What I wanted to say is that sharing of\nClassCache instances between *unrelated* scopes never worked since ClassCache\ndoes refer scope reference through NativeJavaMethod as you pointed out. In fact\nfor thos reason I would even sugest to add a new ClassCache(scope) constructor\nand deprecate default constructor/associate method there.\n(In reply to comment #5)\n> for thos reason I would even sugest to add a new ClassCache(scope) constructor\n> and deprecate default constructor/associate method there.\n> \n\nWill do -- for now I just committed the existing patch. As usual, there are some \nurgencies that need to be tended to in my paid work (you can tell that I \ndiscovered this bug while hunting for memory leaks with a profiler -- this was \nsort of a memory leak although fortunately not an unbounded one, but bound by \nthe total number of Java methods the scripts invoke), as it retained lots of \nparent scopes that were supposed to get garbage collected), so I\'ll get around \nto beautifying the solution a bit later.Closing this: potential improvments can go to a separated bug.',?,BUG
306258,'Can not compile using Ant scripts under JDK 1.5',Rhino,Core,igor,igor,'Currently invoking Ant to compile under JDK 1.5 produces:\n\njavac: target release 1.1 conflicts with default source release 1.5Created attachment 194112\nFix: using source=\"1.3\"  for javac task in AntI committed the fix',?,BUG
306268,'Decompilation of E4X dot query is broken',Rhino,E4X,igor,igor,'Patches from Olinda Spider (pat@mcnerthney.com):\n\nHere is another patch that fixes the displayed, decompiled output of\nthe E4X dot query operator.  It was missing the terminating right\nparathesis.\n\n--- rhino1_6R2pre-org/src/org/mozilla/javascript/Parser.java\n+++ rhino1_6R2pre-new/src/org/mozilla/javascript/Parser.java\n@@ -1702,6 +1702,7 @@\n                 decompiler.addToken(Token.DOTQUERY);\n                 pn = nf.createDotQuery(pn, expr(false),\nts.getLineno());\n                 mustMatchToken(Token.RP, \"msg.no.paren\");\n+                decompiler.addToken(Token.RP);\n                 break;\n\n               case Token.LB: \n\n\nHere is another patch that fixes the displayed, decompiled output of\nthe E4X dot query operator.  It was missing the terminating right\nparathesis.\n\n--- rhino1_6R2pre-org/src/org/mozilla/javascript/Parser.java\n+++ rhino1_6R2pre-new/src/org/mozilla/javascript/Parser.java\n@@ -1702,6 +1702,7 @@\n                 decompiler.addToken(Token.DOTQUERY);\n                 pn = nf.createDotQuery(pn, expr(false),\nts.getLineno());\n                 mustMatchToken(Token.RP, \"msg.no.paren\");\n+                decompiler.addToken(Token.RP);\n                 break;\n\n               case Token.LB:(In reply to comment #0)\n> Patches from Olinda Spider (pat@mcnerthney.com):\n\nWrong cut and paste, the fkirst patch was:\n\n--- rhino1_6R2pre-org/src/org/mozilla/javascript/Decompiler.java\n+++ rhino1_6R2pre-new/src/org/mozilla/javascript/Decompiler.java\n@@ -783,6 +783,10 @@\n                result.append(\"..\");\n                break;\n\n+            case Token.DOTQUERY:\n+                result.append(\".(\");\n+                break;\n+\n            case Token.XMLATTR:\n                result.append(\'@\');\n                break;\nCreated attachment 194129\nCumulative patchI committed the fix',?,BUG
306308,'JS function as Java interface via reflect.Proxy',Rhino,Compiler,igor,igor,'Currently the automatic conversion of JavaScript function to Java interface is\nimplemented through generation of Java class implementing the interface. This is\nsimilar to JavaAdapter code. In general it works nicely but still there are\nlimitations:\n\n1. It requires the permission to create a class loader which may not be granted\nto the application or applet.\n\n2. The class loader requires that its parent loader must have access to both\nRhino classes and the interface in question. It may not be possible with loading\ninterfaces dynamically.\n\n3. On some JVMs it causes memory leak.\n\nAll this problems can be addressed using java.lang.reflect.Proxy which is\navailable since JDK 1.3. Thus I suggest to use it for function->interface\nconversion. \n\nIt would have another benefit of making feature available with smalljs.jar as\nthe code would no longer depend on class generation library.\n\nIdeally it would be nice to use java.lang.reflect.Proxy for JavaAdapter as well\nwhen it needs to implement only interfaces without subclassing Java classes, but\nthat is for separated bug.Created attachment 194160\nImplementation\n\nNot to introduce dependency on JDK 1.3-only feature in Rhino core I factored\nout that through JVMBridgeI committed the implementation.',?,DESIGN_DEFECT
306419,'Add serialVersionUID to Serializable',Rhino,Core,igor,igor,'Currently Rhino lacks serialVersionUID in almost all classes directly or\nindirectly implementing Serializable interface. It may prevent reading of\nserialized objects written with different JVM.\n\nWe should add the missing serialVersionUID declarations.Created attachment 194293\nImplementationI committed the fix: now ejc complains only about missed serialVersionUID when\ncompiling the downloaded classes for the debugger GUI.',?,DESIGN_DEFECT
306584,'crashes parsing .jsp page with javascripts',Rhino,Core,igorv,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)\nBuild Identifier: \n\nThe page could be reflected correctly in MS IE 6.0.29 as well as Mozilla \nFireFox\n\nthe complete stacktrace below :\njava.lang.ArrayIndexOutOfBoundsException: -1\n     [java]     at org.mozilla.javascript.Interpreter.getIndex\n(Interpreter.java:1752)\n     [java]     at org.mozilla.javascript.Interpreter.getPatchedStack\n(Interpreter.java:2197)\n     [java]     at org.mozilla.javascript.RhinoException.generateStackTrace\n(RhinoException.java:206)\n     [java]     at org.mozilla.javascript.RhinoException.printStackTrace\n(RhinoException.java:223)\n     [java]     at java.lang.Throwable.printStackTrace(Throwable.java:451)\n     [java]     at \ncom.meterware.httpunit.javascript.JavaScript$JavaScriptEngine.handleScriptExcep\ntion(JavaScr\nipt.java:201)\n     [java]     at \ncom.meterware.httpunit.javascript.JavaScript$JavaScriptEngine.performEvent\n(JavaScript.java:\n175)\n     [java]     at com.meterware.httpunit.scripting.ScriptableDelegate.doEvent\n(ScriptableDelegate.java:56)\n     [java]     at com.meterware.httpunit.WebResponse$Scriptable.load\n(WebResponse.java:689)\n     [java]     at com.meterware.httpunit.javascript.JavaScript.load\n(JavaScript.java:89)\n     [java]     at \ncom.meterware.httpunit.javascript.JavaScriptEngineFactory.load\n(JavaScriptEngineFactory.java\n:58)\n     [java]     at com.meterware.httpunit.RequestContext.runScripts\n(RequestContext.java:44)\n     [java]     at com.meterware.httpunit.WebWindow.getResponse\n(WebWindow.java:122)\n     [java]     at com.meterware.httpunit.WebClient.getResponse\n(WebClient.java:113)\n     [java]     at bughost.bughostLoginTest.testLogin(bughostLoginTest.java:90)\n     [java]     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n     [java]     at sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n     [java]     at sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n     [java]     at bughost.bughostLoginTest.main(bughostLoginTest.java:17)\n\n\n\n\nReproducible: Alwaysrhino version used : rhino1_6R2Created attachment 194439\nFixI committed the fix',?,BUG
309029,'Exception when evaluating recursive function',Rhino,Core,udittmer,igor,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en-us) AppleWebKit/312.5 (KHTML, like Gecko) Safari/312.3\nBuild Identifier: \n\nThe attached program defines a recursive JS function and tries to invoke it from within a Scope. It runs \nfine with Rhino 1.5R5, but fails with 1.6R2 with:\nException in thread \"main\" org.mozilla.javascript.EcmaError:\n\tReferenceError: \"addOne\" is not defined. (addOne#1)\n\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 196512\nprogram that exhibits the bugCreated attachment 196514\nFix\n\nSometime during 1.6R1 development the parser/code generator started to forget\nthat they were called from Context.compileFunction.I committed the fix.',?,BUG
309957,'or operator || yields true for expression \"test\" || 1 but should yield \"test\"',Rhino,Core,Martin.Honnen,nobody,'Test with the Rhino shell looks as follows:\n\nRhino 1.6 release 2 2005 09 19\njs> \"test\" || 1\ntrue\n\nResult in thise case should be the value of the first operand, the string value\n\"test\".\n\nI have selected \"Version 1.6R1\" in bugzilla but the bug is in R1 and R2, only\nbugzilla does not have to seem updated to allow filing bugs on 1.6R2.\n\nI have now also tried Rhino 1.5 release 5 2004 03 25 but see the bug there too.\n\nBug was reported in\n<http://groups.google.com/group/netscape.public.mozilla.jseng/browse_frm/thread/859fb9f749d0f6cc/65e8f561028358a5?hl=en#65e8f561028358a5>Created attachment 197419\nFix\n\nHere is the patch to fix broken static optimizations in the parser.*** Bug 317684 has been marked as a duplicate of this bug. ****** Bug 312780 has been marked as a duplicate of this bug. ***Wondering whether Igor should still be default assignee for Rhino bugs...  Atilla is heir apparent.\n\n/be(In reply to comment #4)\n> Wondering whether Igor should still be default assignee for Rhino bugs... \n> Atilla is heir apparent.\n\nSee bug 288433.\n\nAlthough the situation is not as bad as I indicated in the bug regading my relations with Rhino and I still hope to find some time to commit few patches laying in bugzilla. The problem is that it requires to run the test suite. But this is time-consuming as quite a few recent tests runs for very long time or non-applicable to Rhino so rhino-n.tests has to be properly updated.\n\nIf somebody would address it, that would be nice.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Problem still seems to be in Rhino R1.6 release 2 (Ie the current version,\nI down loaded it yesterday).\n109 || 16 comes to true in Rhino but web browsers show it as 109 \nhttp://www.cs.ucl.ac.uk/staff/W.Langdon/demo_309957.htmlCommitted the patch to CVS, will be in 1.6R3.\n\nWorks correctly for me:\n\nbefore:\n=======\njs>109 || 2;\ntrue\njs> x = 109;\n109\njs> x || 2; \ntrue\n\nafter:\n======\njs> 109 || 2;\n109\njs> var x = 109;\njs> x || 2;\n109\n',?,BUG
310323,'Array extras: forEach, indexOf, filter, map, some, every',Rhino,Core,norrisboyd,norrisboyd,'Rhino version of SpiderMonkey bug 290592.\n\nImplement the array extras as described in\nhttp://developer.mozilla.org/en/docs/New_in_JavaScript_1.6#Array_extras.Fixed:\n\nChecking in NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  Na\ntiveArray.java\nnew revision: 1.67; previous revision: 1.66',?,RFE
310342,'Static counterparts for generic methods in String and Array',Rhino,Core,igor,nobody,'Rhino should add a static counterpart of generic methods of Array.prototype and\nString.prototype as described in\nhttp://developer.mozilla.org/en/docs/New_in_JavaScript_1.6#Array_and_String_generics\n.\n\nThis is Rhino version of SpiderMonkey bug 304828.Created attachment 197740\nImplementation\n\nThe patch adds all generic methods from SpiderMonkey sources to String and\nArray constructors. \n\nIn addition I moved the code from ScriptRuntime.applyOrCall to convert argument\nto thisObj into separated ScriptRuntime.getThisFromArgs. Patch use it to\nimplement generic calls and thisObj extraction in NativeArray.iterativeMethods\nadded as a part of fix for bug 310323.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433I tried to merge the patch in but it has conflicts with more recent changes. So it will take more work to integrate.This functionality was implemented in 1.7R1 I believe.',?,RFE
310482,'Javascript compiler (JSC) is broken in rhino1_6R2',Rhino,Compiler,ericfu88,igor,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.10) Gecko/20050716 Firefox/1.0.6\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.10) Gecko/20050716 Firefox/1.0.6\n\nRunning the example in the documentation and got the following error. It works\non previous versions.\n\nC:\\Scripting\\rhino1_6R2\\test>java -classpath .;..\\js.jar\norg.mozilla.javascript.tools.jsc.Main -extends ScriptIntf Script1.js\nException in thread \"main\" java.lang.IllegalStateException: Stack underflow: -1\n        at org.mozilla.classfile.ClassFileWriter.badStack(ClassFileWriter.java:1476)\n        at org.mozilla.classfile.ClassFileWriter.add(ClassFileWriter.java:753)\n        at\norg.mozilla.javascript.JavaAdapter.generateEmptyCtor(JavaAdapter.java:624)\n        at\norg.mozilla.javascript.JavaAdapter.createAdapterCode(JavaAdapter.java:350)\n        at\norg.mozilla.javascript.optimizer.ClassCompiler.compileToClassFiles(ClassCompiler.java:194)\n        at org.mozilla.javascript.tools.jsc.Main.processSource(Main.java:267)\n        at org.mozilla.javascript.tools.jsc.Main.main(Main.java:70)\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java -classpath .;..\\js.jar org.mozilla.javascript.tools.jsc.Main -extends\nScriptIntf Script1.js\n\n\n\nActual Results:  \nException in thread \"main\" java.lang.IllegalStateException: Stack underflow: -1\n        at org.mozilla.classfile.ClassFileWriter.badStack(ClassFileWriter.java:1476)\n        at org.mozilla.classfile.ClassFileWriter.add(ClassFileWriter.java:753)\n        at\norg.mozilla.javascript.JavaAdapter.generateEmptyCtor(JavaAdapter.java:624)\n        at\norg.mozilla.javascript.JavaAdapter.createAdapterCode(JavaAdapter.java:350)\n        at\norg.mozilla.javascript.optimizer.ClassCompiler.compileToClassFiles(ClassCompiler.java:194)\n        at org.mozilla.javascript.tools.jsc.Main.processSource(Main.java:267)\n        at org.mozilla.javascript.tools.jsc.Main.main(Main.java:70)\n\n\nExpected Results:  \nNO errors.Created attachment 197892\nFixI committed the fix.',?,BUG
312702,'Feature for limiting call stack depth in interpeter',Rhino,Core,szegedia,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; en) Opera 8.50\nBuild Identifier: \n\nRhino interpreted mode uses its own stack structure on Java heap instead of the \nJava stack. A too deep stack (i.e. one due to an infinite recursion) in \ninterpreter will eventually consume all memory, leading to a global \nOutOfMemoryError that will affect the operation of the entire VM. In contrast, \nbytecode-compiled functions use the Java stack and an infinite recursion will \nonly cause a StackOverflowError that won\'t affect other parts of the VM.\n\nWe need a feature for specifying a maximum interpreter stack depth in Context.\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 199795\nThe patch that implements the feature\n\nI\'ve attached a patch that implements the feature. Please comment on it -- if\nit goes uncommented for a week I\'ll commit it.Comment on attachment 199795\nThe patch that implements the feature\n\n>+    public final void setMaximumInterpreterStackDepth(int max)\n>+    {\n>+        if(optimizationLevel != -1) {\n>+            throw new IllegalStateException(\"Cannot set maximumInterpreterStackDepth when optimizationLevel != -1\");\n>+        }\n>+        if(max < 1) {\n>+            throw new IllegalArgumentException(\"Cannot set maximumInterpreterStackDepth to less than 1\");\n>+        }\n>+        maximumInterpreterStackDepth = max;\n>+    }\n\nYou need to add a line like:\n\tif (sealed) onSealedMutation();\n\nbefore assigning Context.maximumInterpreterStackDepth to ensure that sealed\nContext instances are not modifiable. See other setXXX methods in Context.\n\nOtherwise the patch is OK.Ok, committed the patch with addition of \n\n        if(sealed) onSealedMutation();\n',?,RFE
314163,'E4X XML object constructed from an XML Beans XmlObject is not consistent with a literal (inline) E4X XML object, proprosed fix is supplied',Rhino,E4X,peter.rodgers,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.12) Gecko/20050920 Firefox/1.0.7 SUSE/1.0.7-0.1\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.12) Gecko/20050920 Firefox/1.0.7 SUSE/1.0.7-0.1\n\nThe following test attempts to append an XML object to an existing XML object (x). Two different constructors are used to create the XML child (y).\nCreating from an E4X literal produces an XML object that is not consistent with construction from an XmlObject this results in an IllegalArgumentException\nfor the E4X operation x.* += y2;\n\nTest Case\n---------------------------------\n\nimportPackage(Packages.org.apache.xmlbeans);\nimportPackage(Packages.java.lang);\n\nx= <a><b>test</b></a>;\n\n//y1 is an XML literal - uses XML(String) constructor\ny1= <c>hello</c>;\nxo=y1.getXmlObject();\nSystem.out.println(\"y1\\n\");\nSystem.out.println(y1.toXMLString());\nxo.dump();\n\nx.* += y1;\n\n//y2 is identical but constructed from an XmlObject.\nxo=XmlObject.Factory.parse(\"<c>hello</c>\");\ny2= new XML(xo);\nxo=y2.getXmlObject();\nSystem.out.println(\"y2\\n\");\nSystem.out.println(y2.toXMLString());\nxo.dump();\n\n//This should not throw an exception.\nx.* += y2;\n\nSystem.out.println(\"result\\n\");\nSystem.out.println(x.toXMLString());\n\n-----------------------------------\n\nFails with java.lang.IllegalArgumentException - Can\'t move/copy/insert a whole document.\n\norg.apache.xmlbeans.impl.store.Cursor.complain() line:145\norg.apache.xmlbeans.impl.store.Cursor.checkInsertionValidity() line:155\norg.apache.xmlbeans.impl.store.Cursor._copyXml() line:1513\norg.apache.xmlbeans.impl.store.Cursor.twoLocaleOp() line:1903\norg.apache.xmlbeans.impl.store.Cursor.twoLocaleOp() line:1881\norg.apache.xmlbeans.impl.store.Cursor.copyXml() line:1926\norg.mozilla.javascript.xmlimpl.XML.copy() line:711\norg.mozilla.javascript.xmlimpl.XML.moveSrcToDest() line:661\norg.mozilla.javascript.xmlimpl.XML.insertChild() line:759\norg.mozilla.javascript.xmlimpl.XML.insertChild() line:770\norg.mozilla.javascript.xmlimpl.XML.appendChild() line:1940\norg.mozilla.javascript.xmlimpl.XML.setChildren() line:2742\norg.mozilla.javascript.xmlimpl.XML.putXMLProperty() line:1274\norg.mozilla.javascript.xmlimpl.XMLObjectImpl.ecmaPut() line:233\norg.mozilla.javascript.ScriptRuntime.setObjectProp() line:1430\norg.mozilla.javascript.ScriptRuntime.setObjectProp() line:1422\norg.mozilla.javascript.gen.c2._c0() line:14\norg.mozilla.javascript.gen.c2.call()\norg.mozilla.javascript.ContextFactory.doTopCall() line:337\norg.mozilla.javascript.ScriptRuntime.doTopCall() line:2755\norg.mozilla.javascript.gen.c2.call()\norg.mozilla.javascript.gen.c2.exec()\n\n\nIn XML.java the XScriptAnnotation bookmark is set on the document *element* when constructed from a literal and on the *start* document when constructed from XmlObject.\n\nLiteral Constructor..\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java#388\n\nXmlObject Constructor...\nhttp://lxr.mozilla.org/mozilla/source/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java#233\n\nTo be consistent the XmlObject constructor should be changed to ...\n\nstatic XML createFromXmlObject(XMLLibImpl lib, XmlObject xo)\n    {\n        XScriptAnnotation anno;\n        XmlCursor curs = xo.newCursor();\n    if (curs.currentTokenType().isStartdoc())\n        {\n            curs.toFirstContentToken();\n        }\n        try {\n            anno = new XScriptAnnotation(curs);\n            curs.setBookmark(anno);\n        } finally {\n            curs.dispose();\n        }\n        return new XML(lib, anno);\n    }\n\n\nWith this change the test succeeds.\n\nHaving worked with a patched version for several weeks we have seen no side-effects of this change to the XmlObject constructor.\n\nReproducible: Always\n\nSteps to Reproduce:\nTest supplied in details.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433This bug may have been fixed by the patch for bug 290715.  In any case, the provided test case works now (when running with XMLBeans, but see bug 355677 for a new non-XMLBeans E4X implementation).  Closing as FIXED.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
316993,'bad(?) assertion in rhino 1.6R2 Interpreter.java',Rhino,Core,d-russo,igor,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; Texas Instruments; SV1; .NET CLR 1.1.4322)\nBuild Identifier: rhino 1.6R2\n\nI have some very large scripts which result in the traceback below.  I have not been able to create a small test case.  However, if I?m reading the code for recordJump() and increaseICodeCapasity() correctly, recordJump() should be calling increaseICodeCapasity with deltaCapacity + 1 rather than just deltaCapacity:\n\n?         increaseICodeCapasity() asserts that itsICodeTop + delta > itsData.itsICode.length, but \n\n?         recordJump() calls increaseICodeCapasity() with a delta that is with respect to (itsICodeTop + 1)\n\n\nMaking the change below prevents the assertion for me, but I can?t say if this is an appropriate patch.  From original recordJump:\n\n        int deltaCapacity = offsetSite + 2 - itsData.itsICode.length;\n        if (deltaCapacity > 0) {\n            increaseICodeCapasity(deltaCapacity);\n        }\n\n \n\nI changed this to:\n\n        int deltaCapacity = offsetSite + 2 - itsData.itsICode.length;\n        if (deltaCapacity > 0) {\n            increaseICodeCapasity(deltaCapacity + 1);\n        }\n\n \n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. run rhino in interprested mode on the wrong size scripts\n2.\n3.\n\nActual Results:  \nI get the following assertion violation from the interpreter: \n\njava.lang.IllegalStateException: FAILED ASSERTION\n\n        at org.mozilla.javascript.Kit.codeBug(Kit.java:477)\n\n        at org.mozilla.javascript.Interpreter.increaseICodeCapasity(Interpreter.java:1707)\n\n        at org.mozilla.javascript.Interpreter.recordJump(Interpreter.java:1529)\n\n        at org.mozilla.javascript.Interpreter.addGoto(Interpreter.java:1459)\n\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:722)\n\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:655)\n\n        at org.mozilla.javascript.Interpreter.visitStatement(Interpreter.java:655)\n\n        at org.mozilla.javascript.Interpreter.generateICodeFromTree(Interpreter.java:505)\n\n        at org.mozilla.javascript.Interpreter.generateFunctionICode(Interpreter.java:496)\n\n        at org.mozilla.javascript.Interpreter.generateNestedFunctions(Interpreter.java:580)\n\n        at org.mozilla.javascript.Interpreter.generateICodeFromTree(Interpreter.java:501)\n\n        at org.mozilla.javascript.Interpreter.compile(Interpreter.java:458)\n\n        at org.mozilla.javascript.Context.compileImpl(Context.java:2213)\n\n        at org.mozilla.javascript.Context.compileReader(Context.java:1246)\n\n        at org.mozilla.javascript.Context.compileReader(Context.java:1218)\n\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:1160)\n\n        at config.Shell.evaluateReader(Shell.java:556)\n\n        at config.Shell.processFile(Shell.java:387)\n\n        at config.Shell.load(Shell.java:865)\n\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\n        at java.lang.reflect.Method.invoke(Method.java:585)\n\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:142)\n\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:405)\n\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3084)\n\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2250)\n\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:163)\n\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:1163)\n\n        at config.Shell.evaluateReader(Shell.java:556)\n\n        at config.Shell.processFile(Shell.java:387)\n\n        at config.Shell.load(Shell.java:865)\n\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\n        at java.lang.reflect.Method.invoke(Method.java:585)\n\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:142)\n\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:405)\n\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3084)\n\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2250)\n\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:149)\n\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:337)\n\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2755)\n\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:160)\n\n        at org.mozilla.javascript.Context.evaluateReader(Context.java:1163)\n\n        at config.Shell.evaluateReader(Shell.java:556)\n\n        at config.Shell.processFile(Shell.java:387)\n\n        at config.Shell.exec(Shell.java:537)\n\n        at config.Shell.main(Shell.java:1004)Created attachment 203660\nfix and cleanup\n\nPatch to cleanup goto generation while fixing 100\% bogus assertion.I committed the fix',?,BUG
318305,'ScriptOrFnNode class reports bad end line number',Rhino,Core,strem_ro,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8) Gecko/20051111 Firefox/1.5\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8) Gecko/20051111 Firefox/1.5\n\n67:     public final int getEndLineno() { return baseLineno; }\n\n\n\nReproducible: Always\n\nActual Results:  \nThe getEndLineno() method returns the base line number\n\nExpected Results:  \nThe getEndLineno() method should return the end line numberCreated attachment 207236\nfixReassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Thanks for the patch - fixed in CVS HEAD. Will be in the next release.*** Bug 347339 has been marked as a duplicate of this bug. ***',?,BUG
319614,'Sealing breaks lazy loading',Rhino,Core,lipp,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.7.12) Gecko/20050922 Fedora/1.0.7-1.1.fc4 Firefox/1.0.7\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.7.12) Gecko/20050922 Fedora/1.0.7-1.1.fc4 Firefox/1.0.7\n\nAs described in the tutorial, I have created my ScriptableObject standardsObject. Then I have created a new ScriptableObject, set the standardsObject as prototype and the parent as null. Now I seal.\n\nWhen my script tries to access java (java.lang.System.out.println...) I get an exception because Rhino tries to (lazily) create the \"java\" property (although conceptually it is predefined, i.e. already there) in a sealed context.\n\nI might work around this by creating the \"java\" property before sealing. Does anybody know how I can do this?\n\n\nReproducible: AlwaysIt\'s rhino 1.6r2.I came across this issue when playing with serialization and sealed scopes in Rhino 1.6 release 2 2005 09 19.\n\nAttempting to serialize objects when you have a sealded scope also fails because RegExp wasnt loaded and it therefore tries to load it at serialization time. (btw: Serialization in 1.6R2 will also fail because of a different problem with XML objects as documented in bug 323054 - interestingly you get a different exception in relation that bug when the top scope is sealed.)\n\nBased on what I read in the post:\nhttp://groups.google.com/group/netscape.public.mozilla.jseng/browse_thread/thread/2a21bd205a960a6e/d4e48e157697f9d2?q=scopes&rnum=3#d4e48e157697f9d2\nI discovered that if you \'mention\' the object before sealing the top scope it will force it to be loaded for example evaluating something like\nvar forceLoad=java;\nbefore sealing the scope is a workaround.Created attachment 208255\nZip that contains code to demonstrate issue\n\nThis zip contains code that demonstrates the issue & workaround with 3 scenarios. In each scenario an attempt is made to use \'java\' object, and then code in java tries to serialise a function from a scope below the sealed one.\n\nIn scenario 1 the workaround I mentioned is employed so no errors are shown.\n\nThe second shows the error when there is no workaround for accesing java and RegExp.\n\n(The third shows what happens when we dont create dummy XML objects to get around bug 323054. Could that bug be related to this in some way?)\n\nThe output I got from running the example code (on java 1.4.2_06 on Windows) is also included in a txt file.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433I\'m suffering from this as well, but there\'s no easy way to get around it. We could define a separate mutation operation that replaces an object with a semantically identical another one, but again, it\'d open tricky backdoors and defeat the purpose of sealing as the software couldn\'t really figure out that the replacement object is semantically identical to the replaced one.\n\nFor now, I\'m working around it by serializing the topmost (shared, therefore instantiated only once) scope into a ByteArrayOutputStream (a \"/dev/null\" type OutputStream would suffice too :-) ), thus triggering loading of all lazy objects. \n\nAs I said, I\'m affected by this as well, but still I\'m inclined to mark this a \"Won\'t fix\" - sealing is a feature that if you live with, has such side effects, and you should be prepared for them.Serializing the scope to cause loading is a nice idea, but it is a hack. If this is the only way to achieve the desired effect without opening security holes, sealObject() should do it automatically.\n\nI don\'t think that a user should have to live with the problem. Lazy loading is a purely internal optimization of the interpreter, it should not change observable behaviour.+1\n\n\"Wont fix - because its difficult and high risk but low priority and theres a workaround\" is one thing and justifiable, but \"wont fix - cos \'stuff happens\' so live with it\" is just poor form mate.\n\nI mean while we are at it why not just mark ALL the bugs \"Won\'t fix\" - after all Rhino is a scripting implementation that if you live with, has lots of bugs, and you should be prepared for them.\n\nAnd if you are going to leave it unfixed, then the distributions documentation should indicate the issue clearly as well as the workaround and the reasons for not fixing it. People shouldnt have to spend hours wondering what they did wrong before they finally stumble across this bug report here in Bugzilla.\n\nbtw: Is there a way to disable lazy loading altogether?(In reply to comment #7)\n> +1\n> \n> \"Wont fix - because its difficult and high risk but low priority and theres a\n> workaround\" is one thing and justifiable, but \"wont fix - cos \'stuff happens\'\n> so live with it\" is just poor form mate.\n\nIt\'s not \"stuff happens\", but rather \"conflicting requirements\" leading to a code implementation that produces likewise \"conflicting behavior\". Note that I\'m not defending the status quo, merely explaining it.\n\n> I mean while we are at it why not just mark ALL the bugs \"Won\'t fix\" - after\n> all Rhino is a scripting implementation that if you live with, has lots of\n> bugs, and you should be prepared for them.\n\nOkay, you made your point. Anyway, when I said that I\'m inclined towards not fixing it, I didn\'t say I\'d refuse any fixes. I don\'t have time to fix this at the moment, but I\'ll gladly review any patch that you submit and commit it if it is good. I\'m not trigger-happy to mark fixable issues that people really need as \"won\'t fix\", so expect it to remain open for a good while.\n\nMichael\'s proposal for triggering construction of any lazily-loaded objects from sealObject() would be a working idea. Making the lazy loading optional is an even better idea.\n\n> \n> And if you are going to leave it unfixed, then the distributions documentation\n> should indicate the issue clearly as well as the workaround and the reasons for\n> not fixing it. People shouldnt have to spend hours wondering what they did\n> wrong before they finally stumble across this bug report here in Bugzilla.\n> \n> btw: Is there a way to disable lazy loading altogether?\n> \n\nNot that I know of.Just ran into this too, in the case of E4X.\n\nI noticed that if I sealed a scope, then did\n  context.evaluateString(scope, \"<foo/>\", \"<cmd>\", 1, null)\nI\'d get the\n  \"Cannot modify a property of a sealed object: XML.\"\nexception.\n\nBut more problematically, if you do than make the same call\nagain,\n   context.evaluateString(scope, \"<foo/>\", \"<cmd>\", 1, null)\nRhino hangs in an infinite recursion involving\nLazilyLoadedCtor.getProperty().\n\n(This is with today\'s CVS build.)\n\nAs it sounds this won\'t be fixed soon, might I suggest\na note about this issue on the \"sealed scopes\" section of\nthe docs?\n  http://www.mozilla.org/rhino/scopes.html\nIt took me a while to figure out what was wrong; this\nmight save others some time...\n\nChanging priority to P5 based on recent bug triage.Created attachment 345581\ninitialize ctors before sealing\n\nLooping through property slots and initializing all LazilyLoadedCtors to fix this problem.*** Bug 370231 has been marked as a duplicate of this bug. ***Attila: I was trying to understand why you hesitated to solve this bug one way or other. IMO losing the benefit of lazy constructor loading is an acceptable compromise when object sealing is used so I committed my patch. Please let me know if you disagree. \n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.138; previous revision: 1.137\ndone(In reply to comment #13)\n> Attila: I was trying to understand why you hesitated to solve this bug one way\n> or other.\n\nI just didn\'t have time to do it. I said that I\'d welcome a solution, specifically \"Michael\'s proposal for triggering construction of any lazily-loaded objects\nfrom sealObject() would be a working idea.\" in comment #8.\n\nI\'m actually fairly relieved that this is fixed finally - a big thank you :-) (for all the other hard work in Bugzilla over the past few days, too.)',?,IMPROVEMENT
320812,'Cannot create XML object from Java',Rhino,E4X,lipp,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.8) Gecko/20051111 Firefox/1.5\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.8) Gecko/20051111 Firefox/1.5\n\nThe code\n\nScriptable xo = cx.newObject (scope, \"XML\");\n\n(with scope = cx.initStandardObjects(null)) fails because Context.topLevelScope is null. According to the doc, this call should work, however.\n\nReproducible: AlwaysIt is Context.topCallScope which is null, of course.Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433When I do this:\n\nContext cx = Context.enter();\nScriptable scope = cx.initStandardObjects(null);\ncx.newObject(scope, \"XML\");\n\nI get:\n\nException in thread \"main\" org.mozilla.javascript.EcmaError: TypeError: Not Parsable as XML\n\tat org.mozilla.javascript.ScriptRuntime.constructError(ScriptRuntime.java:3226)\n\tat org.mozilla.javascript.ScriptRuntime.constructError(ScriptRuntime.java:3216)\n\tat org.mozilla.javascript.ScriptRuntime.typeError(ScriptRuntime.java:3232)\n\tat org.mozilla.javascript.xmlimpl.XML.createFromJS(XML.java:384)\n\tat org.mozilla.javascript.xmlimpl.XML.jsConstructor(XML.java:3043)\n\tat org.mozilla.javascript.xmlimpl.XMLObjectImpl.execIdCall(XMLObjectImpl.java:546)\n\tat org.mozilla.javascript.IdFunctionObject.call(IdFunctionObject.java:124)\n\tat org.mozilla.javascript.BaseFunction.construct(BaseFunction.java:310)\n\tat org.mozilla.javascript.Context.newObject(Context.java:1462)\n\tat org.mozilla.javascript.Context.newObject(Context.java:1433)\n\tat Test.main(Test.java:10)\n\nSo, it looks like it fails differently than you said. Can you provide a stack trace that you got? And provide the Rhino version? Also, what docs say that this should work?This code executes correctly in the coming DOM (non-XMLBeans) E4X implementation (see Bug 355677).  Hope my attempt to link the two above works.This code now works if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
321938,'XML and XMLList literals don\'t decompile correctly',Rhino,E4X,stryker330,stryker330,'The following example should explain the problem clearly enough:\n\nParser.parse() the following:\n\n<{tagname} {attributename}={attributevalue}>{content}</{tagname}>\n\nDecompiler.decompile() result:\n\nnew .XML\"<\"{tagname}\" \"{attributename}\"=\"{attributevalue}\">\"{content}\"</\"{tagname}\">\"\n\nThis is clearly wrong and won\'t eval.Created attachment 207235\nfix\n\nSimple fix.Reassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\nSorry, I have troubles creating a reproducible testcase. I tried this:\n\nString s = new Parser(new CompilerEnvirons(), null).parse(\"<something att=\\\"value\\\">content</something>\", \"x\", 1).toString();\nSystem.out.println(Decompiler.decompile(s, Decompiler.ONLY_BODY_FLAG, new UintMap()));\n\nBut got:\n\nException in thread \"main\" java.lang.RuntimeException\n\tat org.mozilla.javascript.Decompiler.decompile(Decompiler.java:796)\n\tat Test.main(Test.java:18)\n\nSo, could you provide me with a working code that reproduces the problem? I could then evaluate your patch against it.Hmm it\'s been a while since I\'ve messed around with Rhino code, so I don\'t remember exactly how parse and decompile are supposed to be used, but here\'s a testcase:\n\nfunction f(){x=<a>b</a>}\nf\n\nEnter those 2 lines in the shell and you\'ll get this for output:\n\nfunction f() {\n    x = new .XML\"<a>b</a>\";\n}\n\nwhich of course isn\'t right and can\'t be eval-ed.Thanks, I was able to test the patch with this test code. It\'s committed to CVS now, will be included in 1.6R3',?,BUG
321967,'default xml namespace doesn\'t decompile correctly',Rhino,E4X,stryker330,nobody,'Parsing and decompiling:\n\ndefault xml namespace = x;\n\nresults in:\n\ndefaultxmlnamespace = x;Created attachment 207233\nfix\n\nThis is the first time I\'ve tried submitting a patch in bugzilla - is it working?Reassigning to please_see_bug_288433@eml.cc pending resolution of bug 288433Yuh-Ruey Chen, you want to request reviews on your patches...  see http://www.mozilla.org/hacking/life-cycle.html\n\nIgor, who\'s the right reviewer for this code?(In reply to comment #3)\n> Yuh-Ruey Chen, you want to request reviews on your patches...  see\n> http://www.mozilla.org/hacking/life-cycle.html\n> \n> Igor, who\'s the right reviewer for this code?\n\nCurrently no one. I have no interest working on Rhino and it seems that other folks with the write access to CVS do not want to bother either.Brendan, do you know if there is anyone competent to review this code?Perhaps Attila is willing.  Not sure.\n\n/beCommitted a patch similar to the submitted one.  Added a test case to my CVS working directory; looking into how to get it added to mozilla/js/tests.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
323054,'Creating a ScriptableOutputStream throws IllegalArgumentException: Object for excluded name XML not found',Rhino,Core,ahpublicaddress,szegedia,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.7.7) Gecko/20050414 Firefox/1.0.3\nBuild Identifier: Rhino 1.6 release 2 2005 09 19\n\nThe exception is thrown when attempting to create the ScriptableOutputStream:\n\nie:\nScriptableOutputStream scriptableOs = new ScriptableOutputStream(outputStream,scope);\n\njava.lang.IllegalArgumentException: Object for excluded name XML not found.\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.addExcludedName(ScriptableOutputStream.java:91)\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.excludeStandardObjectNames(ScriptableOutputStream.java:131)\n\tat org.mozilla.javascript.serialize.ScriptableOutputStream.<init>(ScriptableOutputStream.java:78)\n\tat RhinoSerializationBug.run(RhinoSerializationBug.java:45)\n\nThis error is not present in 1.6R1. A workaround is to create \'dummy\' objects and prototypes for XML and XMLList.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Enter a context, create the standard objects, and then evaluate a script that creates/defines something - a function say (fwiw: I originally noticed this trying to serialize a Continuation).\nie:\nfunction example() { return 42; }\n\n2. Back in java get the Function you created in the javascript from the scope, create a ScriptableOutputStream around a normal FileOutputStream.\n\n3. In 1.6R2 this throws the exception. In 1.6R1 it does not and you can write the Function to the stream.\n\nTo demonstrate the workaround, follow the steps above, but in addition to the function, also create dummy objects for XML, XMLList and their prototypes. ie:\nvar XML = new Object(); XML.prototype=new Object();\nvar XMLList = new Object(); XMLList.prototype=new Object();\nfunction example() { return 42; }\n\n\n\nExpected Results:  \nNot thrown the exception\n\nIll try and attach some code and its output that reproduces the problem.Created attachment 208206\nJava code demonstrating the bug\n\nZip contains src for a class that demonstrates the issue, and a txt file that shows output produced when run against 1.6R2 and 1.6R1This happens when you use rhino without Apache XML Beans library on the classpath. For now, either add it to the classpath, add a fake XML and XMLImpl objects to the scope, create a subclass of ScriptableOutputStream that\'ll override the relevant method and swallow the exception:\n\n    public void addExcludedName(String name)\n    {\n        // Workaround for mysterious cases when \"XML\" global object is not \n        // found.\n        try\n        {\n            super.addExcludedName(name);\n        }\n        catch(IllegalArgumentException e)\n        {\n            logger.debug(e.getMessage());\n        }\n    }\n\nI was bitten by this myself in my own application that uses Rhino... I have committed a fix for this in the CVS -- next release will no longer suffer from this problem.Marking as resolved per comment 2.',?,BUG
324006,'/foo/.constructor != RegExp what is wrong',Rhino,Core,mguillemot,mguillemot,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.12) Gecko/20050915 Firefox/1.0.7\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.12) Gecko/20050915 Firefox/1.0.7\n\nRhinon behaves differently than Firefox (or IE) when comparing a regexp constructor to the RegExp function:\n\n/foo/.constructor == RegExp // true for FF or IE but false for Rhino 1.6R2\n\nReproducible: Always\n\nSteps to Reproduce:\nprint /foo/.constructor == RegExp\nActual Results:  \nfalse\n\nExpected Results:  \ntrue\n\norg.mozilla.javascript.regexp.NativeRegExpCtor should perhaps override equivalentValues?Reassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\n\nYou\'re right - ECMA-262 15.10.6.1 says \"The initial value of RegExp.prototype.constructor is the builtin RegExp constructor.\"\n\nI added this property, so now\n\n/foo/.constructor == RegExp\n\nand\n\nRegExp.prototype.constructor == RegExp\n\nare both true. This is now fixed in CVS and will be in 1.6R3. \n',?,BUG
326563,'ScriptableObject putProperty errorneously sets preexisting property in current scope',Rhino,Core,lmcgee,szegedia,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\nBuild Identifier: rhino1_6R2\n\n/**\n     * Puts a named property in an object or in an object in its prototype chain.\n     * <p>\n     * Seaches for the named property in the prototype chain. If it is found,\n     * the value of the property is changed. If it is not found, a new\n     * property is added in <code>obj</code>.\n     * @param obj a JavaScript object\n     * @param name a property name\n     * @param value any JavaScript value accepted by Scriptable.put\n     * @since 1.5R2\n     */\n    public static void putProperty(Scriptable obj, String name, Object value)\n    {\n        Scriptable base = getBase(obj, name);\n        if (base == null)\n            base = obj;\n// for behavior described in javadoc, this should be \n// base.put(name,base,value);\n\n        base.put(name, obj, value);\n    }\n\n    /**\n     * Puts an indexed property in an object or in an object in its prototype chain.\n     * <p>\n     * Seaches for the indexed property in the prototype chain. If it is found,\n     * the value of the property is changed. If it is not found, a new\n     * property is added in <code>obj</code>.\n     * @param obj a JavaScript object\n     * @param index a property index\n     * @param value any JavaScript value accepted by Scriptable.put\n     * @since 1.5R2\n     */\n    public static void putProperty(Scriptable obj, int index, Object value)\n    {\n        Scriptable base = getBase(obj, index);\n        if (base == null)\n            base = obj;\n// for behavior described in javadoc, this should be \n// base.put(index,base,value);\n        base.put(index, obj, value);\n    }\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Define top-level object named \'parent\'\n2. Define property \'x\' in \'parent\'.\n3. Assign value of 123 to \'x\' using ScriptableObject.put(\"x\",parent,123);\n4. Create object \'child\' with parent specified as \'parent\' (both prototype and scope).\n5. Invoke ScriptableObject.putProperty(\"x\",child,247);\n6. Upon execution, parent::x = 123 and child::x=247.\n7. Per javadoc, expected results should be:\n parent::x = 247 and child::x should NOT exist.\n\nActual Results:  \nProperty existing in parent scope is not changed.  Instead, local property is set.  This is inconsistent with javadoc.\n\n\nIf I am using this incorrectly, please advise as to the appropriate use.  However, adhering to examples, it would appear that we\'ve uncovered a major bug here.Reassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\n\nScriptableObject.putProperty() is meant to implement the [[Put]] operation as defined in ECMAScript specification 8.6.2.2. That is, it\'ll never set a property in the prototype, *assuming* the class of the prototype correctly implements the three-arg put().\n\nThere\'s a part of the ECMA specification that in Rhino can\'t be determined solely through the Scriptable interface -- namely, the [[ReadOnly]] attribute required for the [[CanPut]] suboperation of the [[Put]] operation as defined in ECMA-262 8.6.2.3. That\'s why it\'s delegated to the prototype\'s put(), which in all Scriptable implementations that support the notion of readonly-ness should set the property on its argument *provided* it itself doesn\'t define the property as [[ReadOnly]].\n\nIn plain English, proto.put(name, obj, value) should set obj.name=value *except* if proto.name is [[ReadOnly]], in which case it must be a no-op. \n\nScriptableObject and subclasses correctly implement this.\n\nThe only error is in the documentation - I\'ll rephrase it.Corrected documentation in CVS HEAD',?,BUG
328924,'Impossible to use the debugger from outside the omj.tools.debugger package',Rhino,Core,cam,cam,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8) Gecko/20051224 Debian/1.5.dfsg-3 Firefox/1.5\nBuild Identifier: \n\nMany classes/methods from the omj.tools.debugger package are either package protected or private, resulting in it being impossible to usefully use the debugger outside of the Main class.\n\nI am currently trying to migrate Batik from using Rhino 1.5R4.1 to 1.6R2.  Batik\'s SVG browser program Squiggle uses the debugger, and to integrate it nicely it would modify the debugger\'s menu bar slightly.  In 1.6R2 the Main class is separated from the debugger frame class (now SwingGui), and since the debugGui field in Main is package protected, it cannot be accessed from my class that extends the Main so that it can modify the menu.\n\nI would create my own, separate debugger class that used a Dim and a SwingGui object, but these two classes are also package protected and thus can\'t be reused.  To work around this, I would need to duplicate all of the classes in\nomj.tools.debugger, which is obviously sub-optimal.\n\nI request that \'dim\' and \'debugGui\' be made protected in omj.tools.debugger.Main.\n\nThanks,\n\nCameron\n\nReproducible: Always\n\nSteps to Reproduce:Created attachment 214130\nPatch to expose debugger classes\' useful fields as protected.\n\nThis patch does the following:\n\n  * exposes \'dim\' and \'debugGui\' in omj.tools.debugger.Main (as well as many\n    other things in the debugger package) as protected, thereby making the\n    debugger classes more useful outside their package.\n  * adds the ability to detach the debugger from a ContextFactory and later\n    attach it to a different one.\n  * cleans up and comments the debugger classes.\n\nPlease let me know your thoughts.Created attachment 214133\nPatch to expose debugger classes\' useful fields as protected.\n\nSlightly updated.Since it\'s not so clear what the important changes are from the patch, they are:\n\n  * Package protected fields/methods made protected.\n  * Non-trivial methods modified: Dim.attachTo\n  * Non-trivial methods added: Main.detach, Dim.detach, Dim.disposeReassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\n\nIgor: so who can review this? CC\'ing all the Rhino peers mentioned on mozilla.org/owners.html but I have no idea if any of them are active.\n\nCameron: you probably want to keep an eye on bug 288433.(In reply to comment #5)\n> Igor: so who can review this? \n\nSorry, but I do not know.\n\nI have roughly reviewed this patch, and it looks okay to me. The only modifications I\'d ask you to do would be to change protected fields to private fields, and provide public getter/setter methods for them. I\'m aware that this likely also means modifying existing debugger implementation sources as they probably conveniently relied on the fact that they can access those fields directly, but I\'d say that if we want to touch this, then let\'s do it the right way, all the way. Would you be comfortable with doing this additional requirement?And while you\'re at it, add your name to the \"contributors\" section of each file you modified.Created attachment 223640\nPatch that cleans up the debugger.\n\nOk, the patch is now updated to make all of the protected things private, and getters added where appropriate, except for some fields in SwingGui.java that I have reverted to being package protected, since there are a number of mutually dependent classes in that file and I don\'t think it would hurt to leave them accessing each others\' innards.(In reply to comment #9)\n> Ok, the patch is now updated to make all of the protected things private, and\n> getters added where appropriate, except for some fields in SwingGui.java\n\nOkay, that\'s SwingGui. On the other hand, I noticed that the majority of fields in Dim.java are still protected instead of private. Is there a justification for that?Created attachment 223654\nPatch that cleans up the debugger.\n\nMy mistake, new patch with all protected members cleared out.Last patch committed to CVS',?,DESIGN_DEFECT
329257,'Rhino optimizer cannot handle namespace prefix in E4X dot query',Rhino,E4X,mrdon,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.1) Gecko/20060124 Firefox/1.5.0.1\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.1) Gecko/20060124 Firefox/1.5.0.1\n\nWhen using filtering an xmllist, I cannot filter using the ns:: syntax without Rhino throwing an exception.  The workaround is to declare the default namespace prior to the statement then namespace prefixes aren\'t required.\n\nReproducible: Always\n\nSteps to Reproduce:\nThe query that caused this:\n\nvar paramInfo100 = nestInfo.ns12::ParameterAvailabilityInfo.(ns12::ParameterID == 100);\nActual Results:  \njava.lang.RuntimeException: Bad tree in codegen\norg.mozilla.javascript.WrappedException: Wrapped java.lang.RuntimeException: Bad tree in codegen (/data/brownd/dev/current/server/soaptest/dist/foo/runtests.js#23)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1776)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:191)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:393)\n\n\n\nThe workaround is this:\n\ndefault xml namespace = ns12;\nvar paramInfo100 = nestInfo.ParameterAvailabilityInfo.(ParameterID == 100);Reassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\n\nConfirmed.  Bug exists in both XMLBeans and DOM implementations of E4X.  Here\'s a more complete testcase:\n\nvar ns12 = new Namespace(\"foo\");\nvar nestInfo = <a xmlns=\"foo\">\n\t<ParameterAvailabilityInfo>\n\t\t<ParameterID>10</ParameterID>\n\t\t<PowerOfTen>1</PowerOfTen>\n\t</ParameterAvailabilityInfo>\n\t<ParameterAvailabilityInfo>\n\t\t<ParameterID>100</ParameterID>\n\t\t<PowerOfTen>2</PowerOfTen>\n\t</ParameterAvailabilityInfo>\n\t<ParameterAvailabilityInfo>\n\t\t<ParameterID>1000</ParameterID>\n\t\t<PowerOfTen>3</PowerOfTen>\n\t</ParameterAvailabilityInfo>\n</a>\nvar paramInfo100 = nestInfo.ns12::ParameterAvailabilityInfo.(ns12::ParameterID == 100);\nTEST(1, 2, Number(paramInfo100.PowerOfTen));\n\ndefault xml namespace = ns12;\nvar paramInfo100 = nestInfo.ParameterAvailabilityInfo.(ParameterID == 100);\nTEST(2, 2, Number(paramInfo100.PowerOfTen));\n\nOutput:\n\nFAILED!: Section 1 of test -\nFAILED!: Expected value:\nFAILED!: 2\nFAILED!: Actual value:\nFAILED!: 0\nFAILED!: \nPASSED! 2\n\nAssigning to myself.First, my test case was wrong.  This bug actually does *not* exist in either the XMLBeans or the DOM implementations of E4X, unless the optimizer is on.  In other words, if the optimization level is set to 0 or 1, the error above results; otherwise, the test works as expected.\n\nChanging title to clarify the bug.  To the submitter: an alternative workaround to using the default namespace is to run with optimization off.\n\nReassigning this bug to \"nobody\" as I have not tackled the optimizer yet.  I\'ll attach a revised testcase that exercises the bug (but works correctly with optimization level -1).Created attachment 254415\ntest case to exercise the bugYou didn\'t use the normal tri-license boiler-plate on the test. I\'m not sure we can check it into the tree otherwise. CCd Gerv for more info.Indeed. David: is there a particular reason you chose MPL/GPL dual rather than the standard MPL/LGPL/GPL tri-license? If not, please could you replace this boilerplate text with the standard text from:\nhttp://www.mozilla.org/MPL/boilerplate-1.1/\n?\n\nThanks :-)\n\nGervWell, I\'ve got 5 license-related bugmails noting a variety of problems with potential test checkins, but hopefully it\'s OK if I answer them all here. :)\n\nI wrote a script to parse out the Rhino license text from all the source files and make sure it was consistent, etc.  And then I added the ability to generate the license boilerplate for my contributions (or the contributions of others, since I sometimes check in patches that others write, and I use their names on them).\n\n* Rhino\'s got the dual license, so that\'s why my boilerplate has that.  I can take a look at modifying my program to emit a different boilerplate for mozilla/js/tests/ and will do that.\n\n* My \"Netscape Communications Corporation\" version of the license seems to be from an earlier version of the program, before I realized that some files had a  different copyright notice (IIRC, most files in Rhino have NCC, including many created long after that would have made sense, so I originally thought \"the original code\" referred to the whole project for that reason).\n\n* I can get rid of the emacs header or whatever it is (the \'mode\' thing); I think it\'s a bit strange to have in the source tree to begin with.  A substantial portion of the Rhino files have it and a substantial portion do not.  Again, an earlier version of the program before I noticed that it was \"optional.\"\n\n* As for naming the files (Bob suggests I name them after ECMA spec. sections) I just noticed (in my laborious journeys through the E4X tests) that many E4X tests that come out of bugs end up in the Regress/regress-xxxxxx.js part of the tree even if they pertain to an identifiable portion of the spec (and even if they emit a message identifying a spec section), but some don\'t (they\'re added to the relevant section of the tree).  I may have been assuming too much -- i.e., assuming there was a reason for that -- so I thought I would defer the decision on where they belonged in the tree to Bob.  There\'s also a related process reason on my end -- I\'m keeping all my conformance tests that are not in the tree in a single directory, which is somewhat easier than sprinkling them throughout the tree.  But of course I could still name the file after a spec section.\n\nSo anyway, I\'m happy to make all of these changes myself and re-submit, but I\'d want to do it the \"right\" way (update my license boilerplate generation script) which will make it probably take a bit longer (the first time).  I also don\'t mind someone else making the changes on my behalf and committing the files with the alterations.  I\'m going to mess with my script anyway (for future contributions) so unless there\'s a desire to get these in the tree right away there\'s nothing to be gained by spending the additional cycles making the changes for me. :)For Rhino code, you are right - the MPL/GPL is the correct license. Apologies for not noticing this. For Mozilla code, please use the tri-license.\n\nThe fields in the boilerplate should be filled in appropriately for you, not just copied. So if the files are your own work, then you are the Original Author, and so on. See http://www.mozilla.org/MPL and linked pages for guidance on what to put.\n\nIt\'s fine to have an Emacs header; many files have it.\n\nI\'m not qualified to comment on file naming.\n\nGerv\nIssue(In reply to comment #8)\n> For Rhino code, you are right - the MPL/GPL is the correct license. Apologies\n> for not noticing this. For Mozilla code, please use the tri-license.\n> \n\nJust attempting to further clarify: tests living in js/tests are not Rhino code (they aren\'t even included in the Rhino distribution). They\'re common test code for all JS implementations, thus they\'re generic Mozilla code and should display the tri-license.What would be a good thing to call \"the original code\" in this instance?\n\n\"The Original Code is _____________.  ... The Initial Developer of the Original Code is ...\"\"The Original Code is a JavaScript test case.\" would serve fine. Often we just put \"The Original Code is mozilla.org code.\"\n\nGerv\nCreated attachment 256639\nFixed license and filename\n\nI chose something similar (and already started uploading) based on Bob\'s advice (which I originally missed) in another bug.Comment on attachment 256639\nFixed license and filename\n\napproved with nits: modeline, contributor.\n\n/cvsroot/mozilla/js/tests/e4x/Regress/regress-329257.js,v  <--  regress-329257.js*** Bug 378552 has been marked as a duplicate of this bug. ***Tested in recent releases and master branch, dot queries with namespaces are now working with opt-level > 0.',?,BUG
329908,'readFile should throw an error if the file being requested does not exist',Rhino,Core,cedwards,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en) AppleWebKit/417.9 (KHTML, like Gecko) Safari/417.8\nBuild Identifier: \n\nCalling readFile with a non-existent file currently returns an empty string; it should thow an IOException if the file does not exist.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. run \"print(readFile(\"doesnotexist\"))\n2.\n3.\n\nActual Results:  \nan empty string is returned\n\nExpected Results:  \nIOException if the file is not foundReassigning to the reporter as I have neither interest nor time for Rhino.\n\nSee also bug 288433.\n\nCreated attachment 293996\ntrivial patch\n\nAnything else needed?Perfect.  Thanks!Committed a slightly modified patch.\n\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Global.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java,v  <--  Global.java\nnew revision: 1.55; previous revision: 1.54\ndone',?,DESIGN_DEFECT
334900,'uneval() doesn\'t work for E4X literals',Rhino,E4X,levy,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.8.0.1) Gecko/20060111 Firefox/1.5.0.1\nBuild Identifier: \n\nuneval() produces invalid syntax for functions that contain E4X literals.\nAppears to be a bug in Parser.java.\n\nReproducible: Always\n\nSteps to Reproduce:\njs> s = uneval(function() { return <parbuckle/>; });\n(function () {return new .XML\"<parbuckle/>\";})\n\n\n\nActual Results:  \neval(s) produces syntax error\n\nExpected Results:  \nResult of uneval should be\n(function () {return new XML(\"<parbuckle/>\");})\nor perhaps\n(function () {return <parbuckle/>;})\n\n\n\nOnly happens if E4X literal is inside a function block.\nFor instance, this works:\n\njs> uneval({ widget: <parbuckle/>})\n({widget:<parbuckle/>})Created attachment 219257\nPatch to Parser.java\n\nA fix for this example, which now produces \n  new XML(\"...\")\nfor the XML literal.The above fix still doesn\'t correct the problem if the\nXML contains {} expressions\n\njs> uneval(function(){ return <foo>{2+2}</foo> })\n(function () {return new XML(\"<foo>\"{2 + 2}\"</foo>\");})\n\nSo perhaps uneval shouldn\'t use the XML constructor at all, but\njust reproduce the original:\n(function () { return <foo>{2 + 2}</foo>; })\n\nBut I\'m not that familiar with Rhino...\nIs there some other reason for using the XML & XMLList\nconstructors here?  Any suggestions on the right solution?\nIssue has now been fixed (as of 1.6R3).',?,BUG
335992,'Could you make XMLLibImpl Serializable',Rhino,E4X,randomfletch,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.8.0.2) Gecko/20060308 Firefox/1.5.0.2\nBuild Identifier: Rhino 1.6RC2\n\nCurrently it\'s not possible to serialize any E4X objects because org.mozilla.javascript.xmlimpl.XMLLibImpl isn\'t serializeable. It would be very useful if it were.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Create a script using E4X e.g. var xml = <xml/>;\n2. Try to serialize the xml variable\n3. java.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XMLLibImpl is thrown.\n\nActual Results:  \njava.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XMLLibImpl is thrown.\n\nExpected Results:  \nNo serialization exceptions.\n\nI\'m getting this error specifically trying to serialize a continuation that references an XML variable.Example:\n\nRhino 1.6 release 2 2005 09 19\njs> var xml = <xml/>;\njs> serialize(xml, \"xml.ser\");\norg.mozilla.javascript.WrappedException: Wrapped java.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XMLLibImpl (<stdin>#3)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1693)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:157)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:405)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3084)\n        at script(<stdin>:3)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2250)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:149)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:337)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2755)\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:160)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:477)        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:341)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:153)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:83)\n        at org.mozilla.javascript.Context.call(Context.java:528)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:447)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:136)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:114)\nCaused by: java.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XMLLibImpl\n        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1054)        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1332)\n        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1304)\n        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1247)\n        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1052)        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:278)\n        at org.mozilla.javascript.tools.shell.Global.serialize(Global.java:277)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:324)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:142)\n        ... 15 more\njs>                                                                             Ah, these continue popping up with continuations - just recently I discovered that NativeWith isn\'t serializable either, so serializing a continuation that has a with statement or a catch statement in its control flow path was also impossible...\n\nAnyway, fixed it in CVS - will be in 1.6R3',?,DESIGN_DEFECT
340561,'.prototype should not be DontEnum',Rhino,Core,Christian.Birkl,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)\nBuild Identifier: \n\nCurrently (1.6R2) ECMA test case \"GlobalObjects\", \"15.1.2.1-1.js\" failes.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Execute ECMA test \"GlobalObjects\", \"15.1.2.1-1.js\"\n\nActual Results:  \nPROPS = \"\"\n\nExpected Results:  \nPROPS = \"prototype\"\n\nAs of ECMA spec 15.3.5.2 an instance of function should have property propertype marked as DontDelete. Rhino currently initialises it with:\n\nattr = (isPrototypePropertyImmune) ? DONTENUM | READONLY | PERMANENT : DONTENUM;\n\nWhich - in any case - results in DONTENUM. A wild guess (which actually makes the test pass) is to change this line to:\n\nattr = (isPrototypePropertyImmune) ? DONTENUM | READONLY | PERMANENT : PERMANENT;\n\nBut I\'m not sure if \"isPrototypePropertyImmune\" means \"this object is not _the_ Function object but _a_ Function object\".Hm... I believe the correct solution is\n\nattr = isPrototypePropertyImmune ? READONLY | PERMANENT : PERMANENT;\n\nI fixed this in CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
340682,'E4X Objects not serializable',Rhino,E4X,randomfletch,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.0.4) Gecko/20060508 Firefox/1.5.0.4\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.0.4) Gecko/20060508 Firefox/1.5.0.4\n\nThis bug is related to bug 335992. Running the same test in the shell (i.e. var xml = <xml/>; serialize(xml, \"xml.ser\"); after the 335992 fix throws a  java.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XML$XScriptAnnotation.\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. start up the js shell\n2. type: \"var xml = <xml/>;\" and press enter\n3. type: \"serialize(xml, \"xml.ser\");\" and press enter\n\nActual Results:  \norg.mozilla.javascript.WrappedException: Wrapped java.io.NotSerializableExceptio\nn: org.mozilla.javascript.xmlimpl.XML$XScriptAnnotation (<stdin>#3)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:17\n05)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:157)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:405)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:308\n2)\n        at script(<stdin>:3)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2248)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.j\nava:158)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:3\n37)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:275\n5)\n\nExpected Results:  \nsuccessful serialization of E4X object.Created attachment 224696\npatch to make this test case work\n\nthis patch makes XScriptAnnotation serializable which makes the test mentioned in this bug work.The bigger problem is that Apache XmlBeans is very serialization-unfriendly. XScriptAnnotation extends XmlBookmark which has a field of type XmlMark. The only class implementing XmlMark in XmlBeans is Annotation, and it is not serializable either. So, I think that while this patch will solve this particular problem, sooner or later we\'ll stumble across another serialization problem that won\'t be possible to fix within Rhino, but only within XmlBeans...Committed the fix, with addition of explicit serialVersionUID.(In reply to comment #2)\n> The bigger problem is that Apache XmlBeans is very serialization-unfriendly.\n> XScriptAnnotation extends XmlBookmark which has a field of type XmlMark. The\n> only class implementing XmlMark in XmlBeans is Annotation, and it is not\n> serializable either. So, I think that while this patch will solve this\n> particular problem, sooner or later we\'ll stumble across another serialization\n> problem that won\'t be possible to fix within Rhino, but only within XmlBeans...\n\nYup. Guess we\'ll find out if we can deal with them piecemeal or whether some rearchitecting is required. I\'m planning to use E4X quite heavily so I\'ll raise / patch issues as I find them.',?,DESIGN_DEFECT
342807,'Could set line number/source file in thrown JavaScript Errors',Rhino,Core,pdavis,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.3) Gecko/20060504 Fedora/1.5.0.3-1.1.fc5 Firefox/1.5.0.3 pango-text\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.3) Gecko/20060504 Fedora/1.5.0.3-1.1.fc5 Firefox/1.5.0.3 pango-text\n\nThe JavaScript Error object created when \"new Error(msg)\" is used can set the variables lineNumber and fileName in the error object if they are passed as the 2nd and 3rd arguments of the Error constructor. (see org.mozilla.javascript.NativeError)\nIs there a burning reason that they aren\'t set automatically (other than being outside the Ecma spec)?\nThese values are useful when debugging a script that is throwing errors.\n\n\nReproducible: AlwaysOk, I implemented this in CVS HEAD. Since the objects resulting from the ECMA-defined \"new Error(msg)\" would now have additional non-ECMA properties, to enable the behaviour I defined a new feature,\n\nContext.FEATURE_LOCATION_INFORMATION_IN_ERROR\n\nYou need to have a Context that returns true for hasFeature(Context.FEATURE_LOCATION_INFORMATION_IN_ERROR) in order for this behaviour.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
343976,'Java classes do not construct bean properties if no matching set and get/is',Rhino,Core,marcello,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.8.1a3) Gecko/20060526 BonEcho/2.0a3\nBuild Identifier: Rhino CVS\n\nIt seems as if classes with either setFoo or getFoo but not both will not create beans.  I ran into this problem when working with HttpServletResponse:\nhttp://tomcat.apache.org/tomcat-5.0-doc/servletapi/javax/servlet/http/HttpServletResponse.html\n\nIt has a setStatus() method but no getStatus() method, so I cannot write response.status = response.SC_OK without getting an exception:\norg.mozilla.javascript.EvaluatorException: Java class \"javax.servlet.http.HttpServletResponse\" has no public instance field or method named \"status\".\n\nIf I write response.setStatus(response.SC_OK) it works fine.  \n\nFurther testing revealed that this seems to be a bug in the JavaMembers.reflect() if either a get or set method is missing for a particular property.\n\nI propose that if only a get method is visible, the property is defined as readonly and if only a set method is visible, the property should at least have a setter method.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Add the following Java class to your java classpath:\npublic class Foo {\n\n    public Foo() {\n    }\n    \n    public void setA(Object o) {\n        System.out.println(\"setA \"+o);\n    }\n    public Object getA() {\n        System.out.println(\"getA \");\n        return null;\n    }\n    public void setB(Object o) {\n        System.out.println(\"setB \"+o);\n    }\n    public Object getC(Object o) {\n        System.out.println(\"getC \");\n        return null;\n    }\n\n}\n\n2. Write a javascript that tests this:\nvar foo = new Packages.Foo();\nvar Rhino = { log: function (msg) {\n  print(\"Rhino.log : \"+msg+\"\\n\");\n}};\ntry {\n\tfoo.a = 1;\n} catch (ex) { Rhino.log(ex) }\ntry {\n\tfoo.b = 2;\n} catch (ex) { Rhino.log(ex) }\ntry {\n\tfoo.c = 3;\n} catch (ex) { Rhino.log(ex) }\ntry {\n\tRhino.log(\'a: \'+foo.a);\n} catch (ex) { Rhino.log(ex) }\ntry {\n\tRhino.log(\'b: \'+foo.b);\n} catch (ex) { Rhino.log(ex) }\ntry {\n\tRhino.log(\'c: \'+foo.c);\n} catch (ex) { Rhino.log(ex) }\n\n3. Run it\nActual Results:  \nsetA 1.0\nRhino.log: InternalError: Java class \"Foo\" has no public instance field or method named \"b\".\nRhino.log: InternalError: Java class \"Foo\" has no public instance field or method named \"c\".\ngetA \nRhino.log: a: null\nRhino.log: b: undefined\nRhino.log: c: undefined\n\nExpected Results:  \nthe foo.b = 2 line should not get an error, and the Rhino.log(\'c:\' +foo.c) line should print null instead of undefined.Created attachment 228553\nJava class demonstrating problemCreated attachment 228556\nPotential fix?\n\nI had made a mistake in my earlier post, if there is a get function and no set function, it did function correctly (I simply had written my get function in Foo.java incorrectly!).\n\nHowever, the original problem (a set method but no get method) still applies.  This patch fixes the problem for me.Reviewed and committed the fix - will be in 1.6R3(In reply to comment #3)\n> Reviewed and committed the fix - will be in 1.6R3\n> \n\nNow I\'m experiencing a similar problem on 1.6R3! Now, when you have both the setter and the getter, the property is not added to the members. Stepping through the reflect() method, it seems that when the iteration encounters a getter, it registers the property with the \"toAdd\" map, but then, when it encounters the setter, it overrides it with a BeanProperty that holds a null getter.\nCreated attachment 233039\nPatch to fix the bean property regression\n\nThis patch should fix the problem in JavaMembers that results in some bean properties not being exposed properly in NativeJavaObjects.Ok, I commited your fix to CVS HEAD - actually refactored it a bit, as there was some code duplication in there (for looking up both getXxx and isXxx), other than that I didn\'t change it. Thank you again, and give it a try sometime.\n',?,BUG
344501,'Can\'t step into/put breakpoint in functions that are tail called in the debugger',Rhino,Core,gil.tayar,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.4) Gecko/20060508 Firefox/1.5.0.4\nBuild Identifier: 1.6R2\n\nWhen running a js program using the debugger, and putting a breakpoint or trying to step into a function which is called by another function, the source line in which the debugger _thinks_ it is in is stuck in the call to the nested function.\n\nI have downloaded 1.6R2 and 1.6R1 and it happens on both of them. It\ndoes _not_ happen on 1.5R5. \n\nReproducible: Always\n\nSteps to Reproduce:\nGiven this simple program (in foo.js):\nfunction foo (page)\n{\n  var x = 1;\n  ++x;\n  ++x;\n  ++x;\n  return true;\n\n}\n\n  function zoo(page)\n  {\n    var z = 1;\n    z++;\n    z++;\n    return foo(page);\n  }\n\n  zoo(\'ssss\');\n\nI run the Rhino debugger using:\n\njava -cp js.jar org.mozilla.javascript.tools.debugger.Main foo.js\n\nNow I click on step into repeatedly. The first one enters zoo, which is\ngood. Once I get to the\n\nreturn foo(page);\n\nline and continue clicking on step into, then the debugger does the\nstep, but the current line stays on the \"return foo...\" line. The same thing happens if I try and put a breakpoint in the function foo and click \"Go\" - it gets stuck on the \"return foo...\" line.\n\nActual Results:  \nThe debugger does the\nstep, but the current line stays on the \"return foo...\" line. The same thing happens if I try and put a breakpoint in the function foo and click \"Go\" - it gets stuck on the \"return foo...\" line.\n\nExpected Results:  \nThe debugger should step into the function, or if a breakpoint is set, should stand on that line.What does this have to do with JSD or Venkman?Hrm... maybe this bug /is/ about Rhino.(In reply to comment #2)\n> Hrm... maybe this bug /is/ about Rhino.\n> \n\nIt is.I found the problem, although fixing it is above my means:\n\nthe problem is in functions which are called via tail calls (Icode_TAIL_CALL in the code).\n\nIn the code that executes the Icode_TAIL_CALL (\"Interpreter.interpret\"), it says this:\n\n                if (op == Icode_TAIL_CALL) {\n                    // Release the parent\n                    exitFrame(cx, frame, null);\n\nSince you do tail call elimination, the debugger also exits the frame, and thus does not \"know\" about the entry into the function.\n\nI worked around this by eliminating tail call optimization (by commenting out the assigment in the code below, in the function Interpreter visitExpression):\n\n                    if (type == Token.CALL) {\n                        if ((contextFlags & ECF_TAIL) != 0) {\n                            //type = Icode_TAIL_CALL;\n                        }\n                    }\nJust to make sure I am understood about the nature of the bug. If you change function zoo in the example code in the first comment to:\n\nfunction zoo(page)\n  {\n    var z = 1;\n    z++;\n    z++;\n    foo(page);\n    z++\n  }\n\nthen the debugger will gladly step into the foo function. No problem.\n\nThe change is that now the call to foo is not a tail call, and thus no problem.I\'m going to mark this as invalid since it wasn\'t a bug in our code. ->INVALID(In reply to comment #6)\n> I\'m going to mark this as invalid since it wasn\'t a bug in our code. ->INVALID\n> \n\nCould you explain why this is invalid and why it isn\'t a bug in the code? My last comment showed where in the code _exactly_ the problem is. It may be that I wasn\'t clear enough, in which case I would gladly try again.Created attachment 245455\nFixes this bug without disabling tail call optimization by calling exitFrame() before initFrame()\n\nI looked into this a bit. It is true that disabling tail call optimization solves the problem. However, the problem is not with tail call optimization itself, but a tiny bug in how it is done. The problem is that the new stack frame is created before the old one is popped, so the debugger first sees the onEnter() for the new frame, and immediately afterwards the onExit() for the old one, which results in the new frame being popped and the old one being kept as current.\n\nThis simple patch for Interpreter.java fixes the problem without disabling tail call optimization by calling exitFrame() before initFrame(). \n\nHowever, this still results in a \"hole\" in the stack frame context combobox, which may be confusing. Maybe the right thing to do is to disable tail call optimization when the debugger is on, but I don\'t know if this information is always easily available at compile time.Comitted Hannes\' patch to CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
350580,'[PATCH] importPackage Ambiguous import error fix',Rhino,Core,lgawron,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.6) Gecko/20060728 Firefox/1.5.0.6\nBuild Identifier: Rhino 1.6R2 (R3 also)\n\nOriginally reported at: \nhttp://groups.google.com/group/netscape.public.mozilla.jseng/browse_frm/thread/9551fca1f6200746/4c8cf0604bcd79ca?lnk=gst&q=ambiguous+import&rnum=1#4c8cf0604bcd79ca\n\nquote:\n\nAttached is a patch to fix importPackage to not import the\nsame package more than once.  This fixes an error that\nshows up if a call to importPackage is encountered twice\nbefore classes from the package actually get referenced.\n\nI encountered this error while working with a flowscript\n(Cocoon\'s name for javascript+continuations) for a set of\nCocoon forms.  Quickly starting more than one instance of\na form triggers this bug.\n\nThe patch replaces a comparison using \'=\' between two\nNativeJavaPackage\'s with a comparison using string equality.\nThis effectively compares the package names instead of\nchecking for object identity.\n\nThe other thing which we might need to check is that the\ntwo NativeJavaPackage\'s both use the same classloader.\nI would appreciate it if somebody more knowledgeable of\nRhino internals could sanity check this patch. \n\n\nReproducible: Couldn\'t ReproduceCreated attachment 235905\npatch file\n\nthis is the original patch posted by Tim Larson on 2005-03-22 to jseng news list. It is truly a one liner.Created attachment 241937\npatch using equals() on NativeJavaPackage\n\nActually, this is a bit problematic, as you can have a border case where the two NativeJavaPackage objects are for the same package but loaded through different class loaders. The real solution is to implement equals() and hashCode() on the NativeJavaPackage so that it compares both the name and the class loader, see attached patch -- comments welcome.Committed patch to CVS HEADAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
351664,'Rethrown JavaScriptException\'s toString() returns \"[object Error]\"',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.0.6) Gecko/20060728 Firefox/1.5.0.6\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.0.6) Gecko/20060728 Firefox/1.5.0.6\n\nWhen rethrowing an error in JavaScript, the resulting exception\'s toString() and getMessage() return \"[object Error]\" instead of the original error message. \n\nThe reason is that the implementation of o.m.j.JavaScriptException.details() is too defensive: It doesn\'t even try to call ScriptRuntime.toString() with the wrapped value object out of fear of generating another exception. I\'m adding a patch that always invokes ScriptRuntime.toString(), and catches RuntimeExceptions that may be thrown to fall back to ScriptRuntime.defaultObjectToString().\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the following script:\ntry { a.b } catch (e) { throw e; }\nActual Results:  \nexception from uncaught JavaScript throw: [object Error]\n\n\nExpected Results:  \nexception from uncaught JavaScript throw: ReferenceError: \"a\" is not defined.Created attachment 237122\npatch for o.m.j.JavaScriptException.details()\n\nThis patch renders the original exception while being fairly defensive about not generating new exceptions.is this for use in eclipse? if so, can the exception be an untrusted js object?> is this for use in eclipse? if so, can the exception be an untrusted js object?\n\nI\'m sorry, I don\'t understand these questions. If you look at the patch, it\'s pretty simple: It just tries to call ScriptRuntime.toString() with the thrown object, and if that fails find a better string representation for it.This problem doesn\'t just affect *rethrown* JavaScript errors; it affects even the simplest program that simply does \"throw new Error(\'urk\');\".  You\'ll never get to see the message (\'urk\') in your JavaScript stacktrace.\n\n(This is especially annoying in the embedded Rhino in the new Java 6, because in that case there\'s absolutely no way to get a reference to the original JS Error object; the ScriptException has no reference to the JavaScriptException object; all you have is the ScriptException.)Fix committed to CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.Reopening as I still see the following from a java stack trace with current Rhino HEAD:\n\norg.mozilla.javascript.JavaScriptException: [object Error]\n\nThe script being: throw new Error(\'foo\');Created attachment 376909\nnew patch that handles NativeError\n\nnew patch that explicitly calls toString() for NativeError instances. Also, try to avoid triggering a RuntimeException for NativeErrors.Checking in src/org/mozilla/javascript/JavaScriptException.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaScriptException.java,v  <--  JavaScriptException.java\nnew revision: 1.25; previous revision: 1.24\ndone',?,BUG
352319,'Can\'t restart a continuation from a catch block',Rhino,Core,szegedia,igor,'When  attempting to restart a continuation that is captured from a catch block, an exception is thrown. The problem is in function enterActivationFunction() in ScriptRuntime.java line 2844:\n\nNativeCall call = (NativeCall)activation;\n\nit is invoked from Interpreter.java line 2852 that says \n\nScriptRuntime.enterActivationFunction(cx, frame.scope);\n\nthis throws a ClassCastException, because frame.scope is a NativeWith created by the catch(e) block instead of a NativeCall.\n\nAttached are two files (TestContinuation.java and TestContinuation.js) that jointly reproduce the problem. Note that you won\'t get the root cause ClassCastException when you run it because it\'ll trigger interpret()\'s exception handler that\'ll later run into a NPE because the continuation\'s stack wasn\'t restored properly. However, it is the ClassCastException that is the root cause of the problem.\n\nMy guess is that rewriting Interpreter.java line 2852 so that it doesn\'t specify frame.scope but instead walks the parent chain until it finds a NativeCall would help. Changing the signature of ScriptRuntime.enterActivationFunction to accept NativeCall instead of a generic Scriptable would also help enforce the practice.Created attachment 237950\nTestcase to reproduce the problemI try to check this during the weekend. Catches are tricky.I\'ve committed a fix. If you wish, you can check the diff of Interpreter.java revisions 1.310 and 1.312The committed patch breaks the JS-to-bytecode compiler. The problem is that code generated by o.m.j.optimizer.Codegen needs to be adapted as well. Currently it throws a java.lang.NoSuchMethodError, because it still calls the method with the old (Context, Scriptable) signature.Which method are we talking about?Ok, since I don\'t wish to touch the optimizer, and because I don\'t want to break classes pregenerated with a jsc from an earlier Rhino release, I switched back to the earlier method signature.Sorry, I edited this out of my comment. I\'m talking about ScriptRuntime.enterActivationFunction(), for which an invoke with the old signature is generated at line 1372 of optimizer/Codegen.java. Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
352346,'\' in the text content',Rhino,E4X,Martin.Honnen,nobody,'This test with the shell of Rhino 1.6 R 4 (and XML beans 1.0.4)\n\nRhino 1.6 release 4 2006 09 09\njs> var xmlList = <><![CDATA[<strong>Kibo & Xibo</strong>]]></>;\njs> xmlList[0].nodeKind()\ntext\njs> xmlList.toXMLString()\n<strong>Kibo & Xibo</strong>\n\nshows that the toXMLString method fails to properly escape \'<\' and \'>\' and \'&\' in the text content in the XML list. Result should be\n\n&lt;strong&gt;Kibo &amp; Xibo&lt;/strong&gt;\n\ninstead as Spidermonkey does.\n\nIn terms of the XML specification escaping \'>\' as \'&gt;\' is not a must but for symmetry and clearness usually \'>\' is escaped. \'<\' and \'&\' however must be escaped so Rhino has a bug there.I have looked the E4X specification (2nd edition) and it clearly requires toXMLString to always escape \'<\', \'>\', \'&\' for text nodes respectively element content. The requirement is in section 10.2.1.1 EscapeElementValue.\n\nThe Rhino E4X implementors of toXMLString however have choosen not do do any escaping on text nodes as\n<http://lxr.mozilla.org/mozilla/source/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java#2897>\nsimply checks\n\nif (curs.isText())\n{\n  result = curs.getChars();\n}\n\nand that getChars method of the XmlCursor in XML beans does not seem to be intended to give you XML markup with proper escaping but rather plain text:\n<http://xmlbeans.apache.org/docs/1.0.4/reference/org/apache/xmlbeans/XmlCursor.html#getChars()>\n\nSo this bug is not specific to text nodes in XMLList objects but simply happens when toXMLString is directly called on an XML object of node kind \'text\'.Ok, any idea for a patch? Just escape the return value of \"curs.getChars()\" in\n\nif (curs.isText())\n{\n  result = curs.getChars();\n}\n\nwould do? Does XmlBeans or Rhino already have code for XML escaping somewhere?(In reply to comment #2)\n> Ok, any idea for a patch? Just escape the return value of \"curs.getChars()\" in\n> \n> if (curs.isText())\n> {\n>   result = curs.getChars();\n> }\n> \n> would do? \n\nIt would be start, at least as this bug is concerned. E4X wants toXMLString called on an attribute to apply escaping too so that would need to be fixed too.\n\n> Does XmlBeans or Rhino already have code for XML escaping somewhere?\n\nRhino has\n<http://lxr.mozilla.org/mozilla/source/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java#508>\ndumpNode which then makes uses of cursor.xmlText in some cases. Using that it might be possible to at least get well-formed stuff from toXMLString(). It does not look as if XML beans escpapes \'>\', XML does not require that, but the E4X specification spells out that \'>\' should be escaped as \'&gt;\'.\n\nAnd I am more guessing what might help than really understanding the XML beans API.\n\nAre those guys that implemented E4X for Rhino no longer interested in maintaining/fixing it? The file lists contributors \n  Ethan Hugg\n  Terry Lucas\n  Milen NankovThis bug is fixed in the upcoming non-XMLBeans implementation of E4X for Rhino.  See bug 355677.The submitted test case gives the submitter\'s expected results if XMLBeans is not present.  See bug 355677.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
353002,'Outdated Information on BSF, Update Requested, Text Suggestion Enclosed',Rhino,Core,Rony.Flatscher,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\n\n<http://www.mozilla.org/rhino/bsf.html> should be altered as a new version of BSF (2.4.0) is about to be released which takes care of the incompatibility Rhnio introduced to it quite some time ago. Also there is a package which contains a binary (jar) file that incorporates all changes for 2.4.0 already (BSF4Rexx), such that people could extract it from there.\n\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Just go to <http://www.mozilla.org/rhino/bsf.html> and read it ;)\n\nActual Results:  \n<!-- You should add the following text at the end of the document: -->\n\n\n<p>You may find a pre-built BSF incorporating these changes (and all that will make up the new version 2.4.0) in the BSF4Rexx-package at <a href=\"http://wi.wu-wien.ac.at/rgf/rexx/bsf4rexx/current/\">http://wi.wu-wien.ac.at/rgf/rexx/bsf4rexx/current/</a>. (BSF4Rexx \nallows Java to easily invoke <a href=\"http://www.RexxLA.org>\">REXX</a> and <a href=\"http://www.ooRexx.org\">ooRexx (Open Object Rexx)</a> scripts. For ooRexx the BSF4Rexx support allows ooRexx programmers\nto use all Java classes and Java objects, as if they were (weakly) typed ooRexx classes and objects. In addition it allows to script/automate <a href=\"http://www.OpenOffice.org\">OpenOffice.org</a> in a platform independent manner using its Java-APIs with the help of BSF.)\n</p>\n\n<h2 id=\"bsf-new-RC2\">New BSF version 2.4.0 pending</h2>\n\n<p>As of 2006-09-16 the BSF team is about to release version 2.4.0, which resolves this issue with the new distribution. \nRelease candidate 2 (RC2) will be voted upon for release for the beginning of October 2006. News (and an updated WWW-site)\nwill be found at <a href=\"http://jakarta.apache.org/bsf/\">http://jakarta.apache.org/bsf/</a>.\n</p>\n\n\n\nExpected Results:  \nIndex: mozilla-org/html/rhino/bsf.html\n===================================================================\nRCS file: /cvsroot/mozilla-org/html/rhino/bsf.html,v\nretrieving revision 1.5\ndiff -u -r1.5 bsf.html\n--- mozilla-org/html/rhino/bsf.html\t29 Nov 2004 14:32:11 -0000\t1.5\n+++ mozilla-org/html/rhino/bsf.html\t16 Sep 2006 21:37:17 -0000\n@@ -39,6 +39,18 @@\n If you want to use later releases of Rhino, then as of time of writing, 2004-11-29, you have to either build BSF from <a href=\"http://jakarta.apache.org/site/cvsindex.html\">Apache\'s CVS</a> or use pre-built binaries since BSF project has not yet released an official version incorporating all the necessary changes to work with Rhino 1.5R4 or later.\n </p>\n \n+<p>You may find a pre-built BSF incorporating these changes (and all that will make up the new version 2.4.0) in the BSF4Rexx-package at <a href=\"http://wi.wu-wien.ac.at/rgf/rexx/bsf4rexx/current/\">http://wi.wu-wien.ac.at/rgf/rexx/bsf4rexx/current/</a>. (BSF4Rexx \n+allows Java to easily invoke <a href=\"http://www.RexxLA.org>\">REXX</a> and <a href=\"http://www.ooRexx.org\">ooRexx (Open Object Rexx)</a> scripts. For ooRexx the BSF4Rexx support allows ooRexx programmers\n+to use all Java classes and Java objects, as if they were (weakly) typed ooRexx classes and objects. In addition it allows to script/automate <a href=\"http://www.OpenOffice.org\">OpenOffice.org</a> in a platform independent manner using its Java-APIs with the help of BSF.)\n+</p>\n+\n+<h2 id=\"bsf-new-RC2\">New BSF version 2.4.0 pending</h2>\n+\n+<p>As of 2006-09-16 the BSF team is about to release version 2.4.0, which resolves this issue with the new distribution. \n+Release candidate 2 (RC2) will be voted upon for release for the beginning of October 2006. News (and an updated WWW-site)\n+will be found at <a href=\"http://jakarta.apache.org/bsf/\">http://jakarta.apache.org/bsf/</a>.\n+</p>\n+\n <p><a href=\"index.html\">back to top</a>\n </body>\n </html>\n\nMy name is Rony G. Flatscher and I am one of the committers for the Apache BSF project. Also I am the author of BSF4Rexx (a package that bridges Java and Rexx with the help of BSF).\n\nBSF is slated to be released at version 2.4.0 right before the ApacheCon US which will take place in the second week of October 2006.Done. Checked into cvs Rhino source for next release, and to website. Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.Hi there,\n\nseems to be o.k.\n\nMaybe one interesting new development: since two months there is a beta available for BSF version 3.0, which is an opensource implementation of JSR-223, i.e., the Java 1.6 scripting framework. However, BSF 3.0 is usable starting with Java 1.4 (!). The current version of BSF 3.0 beta can be found at: <http://people.apache.org/~antelder/bsf/3.0-beta1/>.\n\nRegards,\n\n---rony\n',?,CLEANUP
353300,'Mising String function localeCompare',Rhino,Core,mguillemot,szegedia,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-GB; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; en-GB; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\n\nThe String function localeCompare described in ECMA-262 is missing (http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf, p. 101).\nThis function works in Firefox 1.5.\n\nReproducible: Always\n\nSteps to Reproduce:\n\"some string\".localeCompare(\"some other string\")\nActual Results:  \nTypeError: Cannot find function localeCompare.\n\nExpected Results:  \nnegative, positive or 0 result depending on the compared strings1. rhino is a java impl of javascript, if you\'re testing with firefox, unless you\'re really creative you aren\'t using rhino\n2. you didn\'t provide a testcase, there\'s a url field, you could have filled it in\n3. you didn\'t provide an attachment, you could have attached a xpcshell js testcase, or a jsshell js testcase, or an html file testcase\n4. it works for me using javascript:navigator.userAgent\nMozilla/5.0 (X11; U; SunOS i86pc; en-US; rv:1.8.0.4) Gecko/20060613 Firefox/1.5.0.4Why INVALID? I could understand INCOMPLETE but not INVALID.\n\nFirefox was only here only an example. localeCompare is defined in ECMA-262 which Rhino implements or am I wrong?your build id should have been the output of build() from the rhino shell. there\'s no indication that you actually were testing rhino. ideally steps to reproduce would have said to use the java command to test it.\n\nwe get misfiled bugs often and this one had very little indication that you were actually dealing w/ rhino.\n\nbtw rhino isn\'t very heavily developed, so i hope you\'re planning to patch this yourself.The original poster is right - localeCompare is missing from Rhino. Will fix it.Created attachment 240138\nPatch\n\nAttached a patch if someone wants to review it before committingThis is resolved in CVS HEAD nowAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
353493,'[PATCH] New code has line endings inconsistent with rest of source tree',Rhino,Core,inonit,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\nBuild Identifier: Rhino HEAD 20-Sep-2006 10:20AM EDT\n\nSorry to be the line endings police, but we\'ve now got another source file with spurious CR/LF endings checked into CVS (which when checked out on DOS results in CR-CR-LF).  I\'ve attached a version that fixes it.\n\nThe file, for example, opens as double-spaced in NetBeans when checked out using a DOS-based CVS client on Windows.\n\nReproducible: AlwaysCreated attachment 239345\nVersion of StandardTests with LF instead of CR/LF line endingsThe problem also affects the following files:\n\nCHANGELOG\nsrc/org/mozilla/javascript/PolicySecurityController.java\nsrc/org/mozilla/javascript/SecurityUtilities.java\nCreated attachment 239659\nversion of CHANGELOG with LF rather than CR/LF line endingsCreated attachment 239660\nVersion of PolicySecurityController.java with LF instead of CR/LF line endingsCreated attachment 239661\nVersion of SecurityUtilities.java with LF rather than CR/LF line endingsThis is very strange - looking at these files locally, they indeed have CR/LF in them. This is especially strange since I\'m creating them using Eclipse on Mac OS X... I\'ll try to figure out whether I can convince Eclipse into saving new files using LF endings -- this should be the default behavior on Mac anyway...Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,IMPROVEMENT
353501,'[PATCH] Rhino test driver requires JUnit to run, jsDriver.pl is slow',Rhino,Core,inonit,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\nBuild Identifier: Rhino HEAD 20-Sep-2006 11:07AM EDT\n\nAttila Szegedi mentioned in the newsgroup (http://groups.google.com/group/mozilla.dev.tech.js-engine/browse_thread/thread/843e89123a051ce7/#) a push to more quality control on the Rhino codebase.  He has created a JUnit-based suite of tests (in the testsrc/ directory) that essentially emulate jsDriver.pl (read the post for the reasoning; I can confirm that running the tests with jsDriver.pl is amazingly slow, and was difficult to get right on a Cygwin installation because of pathname issues).\n\nI\'m creating an enhancement request because I plan to create a test driver that is a Java command-line application and mirrors the behavior of jsDriver.pl.  I\'ll factor shared implementation code out of StandardTests.java to be used by both, and submit it as a patch, and we can evaluate.  I may try for some basic Ant integration as well.\n\nReproducible: AlwaysCreated attachment 240095\nPatch which creates Java port of jsDriver.pl, fixes some JUnit issuesComment on attachment 240095\nPatch which creates Java port of jsDriver.pl, fixes some JUnit issues\n\nThe attached patch duplicates the contents of StandardTests.java, possibly for several reasons (bug # 353493, use of CVS keywords, heavily edited file).  The added lines are the \"correct\" lines and all lines after the second package statement must (of course) be deleted.Building on Attila\'s work on quality control and testing, I\'ve \nsubmitted a patch for Rhino (filed under bug #353501) that does \nthe following:\n\n*\tBuilds on Attila\'s JUnit test suite\n\n\t*\tFixes a bug in which scripts that have compile-time errors are \n\t\tnot reported as failures\n\n\t*\tMakes it possible to configure the location of the test library \n\t\tand the timeout interval\n\n\t*\tIntegrates it with the Ant build.xml file\n\n*\tProvides a command-line Java port of jsDriver.pl which can run the \n\ttests in the JavaScript Test Library,\n\n\t*\tProduces an HTML output file that resembles the jsDriver.pl \n\t\toutput file\n\n\t*\tProvides configuration options that are compatible with the \n\t\tjsDriver.pl options, like the ability to include/exclude certain \n\t\ttests and the ability to specify the location of the tests and the \n\t\toutput destination.  Is command-line compatible with jsDriver.pl \n\t\t(at least the options that are documented on the man page), but \n\t\tignores several command-line options (what Java to use, shell \n\t\tpath, etc.).\n\n*\tIntegrates the Java port of jsDriver.pl with the Ant build system\n\nI am open to suggestions and feedback; I submit my patch humbly. :)  \nIn order to finish the implementation, I made some choices that we \ncould revisit.  Here are some I can think of:\n\n*\tI made little effort to target any particular version of the JRE \n\tand did no testing other than on my local setup.  I did refrain from \n\tusing the JDK 1.5 language enhancements, so the code is uglier than \n\tit need be in some places.\n\n*\tI pretty blindly followed conventions from jsDriver.pl without \n\tcritically evaluating them.  It\'s quite possible that there are \n\timprovements that could be made.\n\n\t*\tFor example, the output HTML links to bug numbers (as jsDriver.pl \n\t\tdoes), but these appear to be mostly SpiderMonkey bugs (at least \n\t\tat a glance).  It\'s possible that this check should be omitted, or \n\t\tthat Rhino bug numbers should be embedded in a properties file in \n\t\tthe mozilla/js/rhino part of the CVS tree (and then we could flag \n\t\ttest failures with no bug numbers?), or something.\n\n\t*\tI\'m not in love with the HTML page itself.\n\n*\tOne area where the Java port (as well as Attila\'s JUnit suite) \n\tdiffers from the original is that it doesn\'t launch a separate \n\tinstance of the Java runtime for each test.  This leads to a \n\tsubstantial speed increase (about 1.5 seconds per test on my \n\tworkstation, which adds up fast).  In theory, though, this could \n\tcause differences between the results of jsDriver.pl and the Java \n\tport (for example, if a script modified Java system properties).  \n\tDoes anyone know whether there are any tests like this in practice?\n\nAlthough I left the timeout at 60 seconds in deference to Attila\'s \noriginal choice, I recommend running with a much lower timeout (e.g., \n1 second) because the tests then run in a manageable length of time, \nand are more stable (some of the tests that eventually fail with \nOutOfMemoryError, etc., won\'t use up so much if you don\'t give them \ntime).  It would be better to allow per-test configuration of whether \nto fork a new VM, and timeout, and things like that, but that\'s \nanother patch. :)\n\nI couldn\'t get the patch exactly right for various reasons, so I \napologize -- the file StandardTests.java needs to be manually edited \nafter applying the patch, by deleting everything after the second \npackage statement (it\'ll be clear if you see it).\n\nI\'m happy to discuss thoughts.\n\n-- David Caldwell\nhttp://www.inonit.com/\nCreated attachment 240146\nPatch which applies correctly\n\nFixes the issue in which StandardTests.java became corrupted after applying patch and needed to be fixed manually.  I think.Created attachment 246074\nPatch which handles other failure cases\n\nThis patch fixes some other possible modes of failure of tests so that they are correctly recorded as failures rather than successes.I have committed the patch (or rather a modified version of it that works and includes proper license headers)Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,TEST
355677,'Rhino E4X depends on Apache XMLBeans',Rhino,E4X,inonit,inonit,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7\nBuild Identifier: Rhino HEAD 6-Oct-2006 7:34a EDT\n\nAs Attila discussed in the newsgroup (http://groups.google.com/group/mozilla.dev.tech.js-engine/browse_thread/thread/1a4eae00d18140c1/477f6da30df203e0?tvc=2&q=new+rhino+maintainer#477f6da30df203e0), ideally Rhino\'s E4X support would not depend on the XMLBeans library from Apache.  Currently it does, hence this issue.\n\nReproducible: Always\n\n\n\n\nI have begun work on a local branch of the codebase from which I am slowly removing calls to the XMLBeans library.Created attachment 242132\nSnapshot of current work\n\nFeedback welcome; this is the current state of things with all XMLBeans calls removedCreated attachment 242865\nSnapshot 2006-Oct-19\n\nContinuing to refactor, fixed a couple of regressions, better, more accurate namespace handling, still more refactoring to doCreated attachment 246076\nZipped snapshot\n\nAll references to XMLBeans have been removed\nMore bugs fixed\nThis build passes 16 tests that the present implementation fails, but fails 9 that the present implementation passes.Right now the DOM-only port requires JDK 1.5, as it uses the getUserData/setUserData methods of the DOM Node class, which don\'t exist in the 1.4 distributions.  It uses other methods specific to 1.5 also, but the get/setUserData would be the most difficult to remove, in my judgment.\n\nThere would be ways to emulate this functionality (big Hashtable, weak references, maybe?) but I haven\'t investigated it.  I will if people think there will be a big demand for 1.4 JDKs running a non-XMLBeans E4X.\n\nMy current thought is to deprecate the XMLBeans implementation and move it to the deprecatedsrc tree; I don\'t see a lot of value in actually _maintaining_ two E4X implementations.  I am open to thoughts there as well.Well, I\'d certainly want Rhino to remain runnable on 1.4 JREs. Would adding an external XML parser that supports the newer DOM spec (i.e. Xerces) to classpath get around the problem?Yeah, I wasn\'t going to disallow running on pre-1.5 JREs, but one possibility is to say \"you can only use the XMLBeans implementation on pre-1.5 JREs.\"  I haven\'t looked into Xerces or the endorsed standards rigamarole or that sort of thing, so I guess I\'ll have to do more detailed study in order to figure out what the possibilities are.Created attachment 252983\nPatch which shows proposed pluggability mechanism\n\nFirst, this patch will also attempt to reapply a patch to testsrc which I already applied and I don\'t know what will happen, but it shouldn\'t affect building the main distribution jar. :)\n\nAnyway, this patch shows the proposed pluggability mechanism for E4X.  It adds a method to Context and ContextFactory asking them to provide an instance of the new XMLLib.Factory class which is then used to instantiate the XMLLib in ScriptRuntime when called upon.  The default rule for the moment is to use XMLBeans if it\'s in the classpath (to minimize surprises for existing users) and to use the new DOM implementation if JDK 1.5+ is being used.  (Attila, per your comments, I am considering backporting this to 1.4 but we can discuss further.)  The important thing is whether we approve of the strategy here before I commit the uberpatch.  There are also included proposed buildfile changes as well.\n\nThere is still a substantial amount of quality control to be done on the new implementation, but it continues to narrowly lead the old implementation in the conformance tests.Just to clarify the above, we use XMLBeans in the classpath, DOM if it XMLBeans is absent and JDK 1.5+, and neither if neither condition is true.Created attachment 253124\nZipped snapshot\n\nYou may want to apply the previous patch (which takes care of changes to other classes, like Context etc.) and then unzip this over top of it.\n\nThis implementation is getting close to \'commit\' status.  It now fixes 19 bugs from the XMLBeans implementation with only two regressions:\n\nFixed (19): e4x/Namespace/regress-283972.js, e4x/Regress/regress-263934.js, e4x/Regress/regress-263936.js, e4x/Regress/regress-264369.js, e4x/Regress/regress-291937.js, e4x/Regress/regress-352346.js, e4x/TypeConversion/10.1.1.js, e4x/TypeConversion/10.1.2.js, e4x/XML/13.4.4.11.js, e4x/XML/13.4.4.12-1.js, e4x/XML/13.4.4.13.js, e4x/XML/13.4.4.27.js, e4x/XML/13.4.4.28.js, e4x/XML/13.4.4.32-1.js, e4x/XML/13.4.4.38.js, e4x/XML/13.4.4.39.js, e4x/XML/13.4.4.9.js, e4x/XML/regress-336921.js, e4x/XMLList/13.5.4.10.js\n\nRegressions (2): e4x/GC/regress-280844-1.js (Xerces DOM stack overflow when processing namespace for XML tree 5000 nodes deep), e4x/Regress/regress-350629.js (Regular expression issue with namespace prefixes.)\n\nOne of the two regressions is probably wrong -- it actually exercises what appears to be a RegExp bug in Rhino (having to do with greediness) because this E4X emits the attributes under consideration in a different order than XMLBeans, and thus fails the test.\n\nThe other is a stack overflow when processing an XML document that is 5,000 layers deep.  Not a showstopper. :)\n\nOn the other hand, passing those 19 tests will also wipe out 9 Bugzilla issues when this is committed.\n\nExisting users won\'t be affected, as the XMLBeans implementation will still be available.  They will only become affected when they remove XMLBeans from their classpath.  At least for now (in the future, I\'d think we\'d make this implementation the default).(In reply to comment #7)\n> Anyway, this patch shows the proposed pluggability mechanism for E4X. It adds\n> a method to Context and ContextFactory asking them to provide an instance of\n> the new XMLLib.Factory class which is then used to instantiate the XMLLib in\n> ScriptRuntime when called upon.  The default rule for the moment is to use\n> XMLBeans if it\'s in the classpath (to minimize surprises for existing users)\n> and to use the new DOM implementation if JDK 1.5+ is being used.  (Attila, per\n> your comments, I am considering backporting this to 1.4 but we can discuss\n> further.)  The important thing is whether we approve of the strategy here\n> before I commit the uberpatch.  \n\nHaving XML implementation configurable at ContextFactory/Context level is perfectly okay. As for JDK 1.5 -- wouldn\'t it be better if you enabled the DOM implementation for JDK 1.4 as well when there\'s no XmlBeans around? Isn\'t it possible that some programs would use only such a subset of features that doesn\'t run into a NoSuchMethodError on JDK 1.4? If it is, then it\'d be a pity to preemptively disable it. Also (I\'m reiterating my point from an earlier comment here) if it\'s not a JDK 1.5 issue per se, but rather the fact that your code relies on a more advanced DOM spec implementation that happens to be included with JDK 1.5 but not 1.4, then a 3rd party DOM XML parser on the classpath providing the newer spec itself would solve the problem on 1.4 JDKs too. Rhino - up to 1.6R5 - was 1.1 compliant. I plan to kick it up to 1.3 with the next release, but would really prefer to not introduce real 1.5 dependencies yet (i.e. not compiling with <javac target=\"1.5\"> if possible for now), so we don\'t get references to StringBuilder instead of StringBuffer etc. Of course, only if it doesn\'t inconvenience the implementation too much.>Also (I\'m reiterating my point from an earlier\n>comment here) if it\'s not a JDK 1.5 issue per se, but rather the fact that your\n>code relies on a more advanced DOM spec implementation that happens to be\n>included with JDK 1.5 but not 1.4, then a 3rd party DOM XML parser on the\n>classpath providing the newer spec itself would solve the problem on 1.4 JDKs\n>too.\n\nI have never played with this, but my understanding is that it\'s more complicated than that, and we\'d need to screw around with the endorsed standards mechanism, etc.  (Or the bootclasspath.)  When we load a DOM class (like org.w3c.dom.Document), it seems to me like it\'ll use the JRE\'s version no matter what we do, even if a newer implementation were sitting on the classpath.  So org.foo.supermodern.DocumentImpl might implement the new version of the DOM spec, but the E4X code is still going to use the org.w3c.dom.Document instance loaded by the JRE.  I think this limitation is what the java.endorsed.dirs business is supposed to get around, but I haven\'t looked at it closely enough to completely understand it.  And one of my goals here is to get reasonably close to zero-config (I am hoping I don\'t have to explain java.endorsed.dirs to people in the installation documentation, and there are usage scenarios -- like shared servers -- where people might not have the ability to alter them).\n\nInteresting point about gambling with NoSuchMethodError.  Value judgment there -- I think I\'d rather have it not start than work partially and then fail spectacularly.  But I see your point and am open to convincing.  I am guessing it would be hard to avoid the 1.5 dependencies at the moment; there are 20 compilation errors when one compiles under 1.4.\n\nToo many unknowns and \"I am guessing\"s at the moment -- I haven\'t really investigated the feasibility of just manually backporting it, haven\'t looked into java.endorsed.dirs, so I ought to stop until I can say something more useful. :)Thinking about it more I think you might be right -- that if a user didn\'t build from source (but rather used a precompiled version) that contained bytecode that called out to new DOM methods, and then was using a JAXP-compliant parser that produced objects that implemented all the methods expected by the bytecode, it might work.  My brain\'s getting a little twisted into knots here, as I\'ve never tried to do anything so cavalier as update an interface on my build platform and then an implementation on my deployment platform and hope it would work.  But in this case it might. :)  I\'ll try to get a test done to convince myself.  It still suffers from the requires-VMwide-config problem, I think, though I guess I need to look into JAXP more and see what can be done at runtime -- again thinking of the shared server scenario.OK, I can confirm that merely putting Xerces on the classpath is *not* enough to be able to use DOM Level 3 at runtime under JDK 1.4.  However, using the java.endorsed.dirs system property to allow the Xerces versions of the APIs to be loaded at runtime (and override the JDK\'s classes) *does* work.  (As would presumably copying the Xerces xml-apis.jar into [JDK]/jre/lib/endorsed; see http://java.sun.com/j2se/1.4.2/docs/guide/standards/, although that doesn\'t mention that you actually have to *create* the endorsed directory, but it isn\'t there in my JDK).\n\nSo I\'ll code something in that looks for the DOM3 classes rather than the JDK version in order to determine whether to instantiate this implementation.  Still on the horizon would be back-porting to DOM2 if it seems worth the effort.I have placed the new implementation in the tree.  Unless an implementation class for E4X is specified on the Context object, the XMLBeans implementation is used if XMLBeans are available on the classpath.  The new implementation is used otherwise, as long as DOM Level 3 is available.  Otherwise, the results are unpredictable.\n\nThere will be some cleanup perhaps with those sorts of edge cases (and also tightening up the build process).  But I wanted to commit this to the tree because it appears to work better than the XMLBeans implementation already, and existing clients won\'t immediately be affected because XMLBeans is still used by default, and it was becoming difficult to maintain my own fork of the codebase (see, e.g., my committing the entire Rhino source tree this morning trying to update my own repository).\n\nDespite fixing many regressions, there are still things to fix about the new implementation, so I\'ll get to work on those.Thanks for your great work, David! I tried it out, and the new implementation (without xbean.jar in the classpath) seems to work well, but as soon as I put xbean.jar in the classpath, I get\n\nReferenceError: \"XML\" is not defined.\n\nIs this some oddity with my build (I have a slightly patched tree), or are other people seeing the same?Created attachment 254168\nOne test case for comment 15\n\nHaven\'t been able to reproduce this.  Attached is a test I ran with XMLBeans 2.2.0 and JDK 1.6:\n\nOutput without xbean.jar on classpath:\n\n$ $jdk/bin/java -classpath `cygpath -wp $RHINO/build/commit/dist/js.jar` org.mozilla.javascript.tools.shell.Main e4x-hello.js       xmlbeans: false\ncontext class: org.mozilla.javascript.xmlimpl.XMLLibImpl\n<foo/>\n\n\nAnd with:\n\n$ $jdk/bin/java -classpath `cygpath -wp $RHINO/build/commit/dist/js.jar:/opt/java/apache/xmlbeans/2.2.0/lib/xbean.jar` org.mozilla.javascript.tools.shell.Main e4x-hello.js\nxmlbeans: true\ncontext class: org.mozilla.javascript.xml.impl.xmlbeans.XMLLibImpl\n<foo/>\n\nSuspicions:\n\n1.  You didn\'t put jsr173_1.0_api.jar on classpath.  Though I didn\'t either -- I can\'t explain why it worked anyway. :)\n\n2.  Given your custom build, perhaps something has happened to Context or ContextFactory (two classes with which you might well be munging).\n\nSince I happen to know you\'ve been playing with LazilyLoadedCtor, you may want to do what we talked about in bug 369342 and *not* swallow exceptions (maybe dumping their stack trace instead) and see whether something more helpful than the ReferenceError spits out.Thanks for your help. The first problem was simply that I had cvs-updated my local copy without the -d option, so the directories for the newly deprecated Xmlbeans implementation never got created. And in fact I didn\'t have the jsr 173 jar file in the classpath. Shame on me, next time I\'ll dig some more before asking. But I agree that LazilyLoadedCtor should produce some kind of message on failure.No shame here. :)  It\'s good to know what\'s happening out there -- extra impetus to fix bug 369342, for example.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
357819,'Rhino 1.6R4 is not available from the Maven2 repositories',Rhino,Core,julien.ponge,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\n\nThe latest version of Rhino that is available through the Maven2 repositories is 1.6R3: http://repo1.maven.org/maven2/rhino/js/. New releases of Rhino should be made quickly available though the Maven2 repositories, as a growing base of projects use Maven2 and gather their dependencies through it.\n\nReproducible: AlwaysI notice 1.6R5 is there now.  Is this bug \"fixed?\"  If not, do you have suggestions on the best way to do it?I confirm that this has been fixed now, there must have been some lag when I reported this :-)Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,OTHER
358058,'JavaScript debugger\'s text source editor allows tab key presses',Rhino,Core,longstrb,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 1.0.3705)\nBuild Identifier: \n\nJavaScript debugger\'s text source editor allows tab key presses.  Source editor is read-only and should not allow any keypress actions.  Check and fix for all key press actions.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Debug a script.\n2. Please cursor in source text and press the TAB key.\n3. Results in modified source text.Created attachment 244412\nProposed patch\n\nPatch proposed by Bradley in private mailI committed the proposed patch to CVS HEADAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
359358,'java.lang.VerifyError on a[i]++ when optimizationLevel=1',Rhino,Compiler,christophe.marton,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\n\nWhen using optimizationLevel=1 (works well with optimizationLevel<=0)\n\nThe following script fails with:\njava.lang.VerifyError: (class: org/mozilla/javascript/gen/c1, method: _c1 signature: (Lorg/mozilla/javascript/gen/c1;Lorg/mozilla/javascript/Context;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla/javascript/Scriptable;[Ljava/lang/Object;)Ljava/lang/Object;) Expecting to find ob\n\n\nfunction f() {\n\tvar i=0;\n\tvar a=[];\n\ta[0]=1;\n\treturn (a[i]++);\n}\n\nf();\n\n\nNote:\n- a[0]++ works well, only a[i]++ crashes\n- fails only inside a method, works well called directly.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nExecute the following script:\n\nfunction f() {\n\tvar i=0;\n\tvar a=[];\n\ta[0]=1;\n\treturn (a[i]++);\n}\n\nf();Created attachment 248899\nTestcase for reproducing the problem\n\nI can confirm this is a bug - I\'ve tested it with both JVM 1.4.2 and JVM 1.5.0. I\'ve attached a testcase to reproduce the problem. I unfortunately don\'t know any of the optimizer internals -- I notified Norris Boyd in e-mail; hopefully he\'ll have time to take a look at it.I\'ve taken a look at it and have a proposed fix, but need review from Igor.Created attachment 258325\nProposed patchFixed:\n\nChecking in Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.243; previous revision: 1.242\ndone\nChecking in OptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/OptRuntime.java,v  <--  OptRuntime.java\nnew revision: 1.35; previous revision: 1.34\ndone\nChecking in Optimizer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java,v  <--  Optimizer.java\nnew revision: 1.50; previous revision: 1.49\ndone\n\nNote the eventual fix is different from the proposed patch.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
359359,'i-- returns void when OptimizationLevel=1',Rhino,Compiler,christophe.marton,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\n\nwhen using OptimizationLevel=1, i-- returns void instead of the expected number in the following script:\n\nfunction zeros(i) {\n  var a=[];\n  while((i--)>0) {\n      a[i]=0; \n  }\n  return a;\n}\n\nfunction g() {\n\treturn zeros(10);\n}\n\ng();\n\nThe error message is:\n\nRHINO USAGE WARNING: Missed Context.javaToJS() conversion:\nRhino runtime detected object void of class java.lang.Class where it expected String, Number, Boolean or Scriptable instance. Please check your code for missing Context.javaToJS() call.\n\n\nNote:\n- calling g() is required to reproduce the problem, calling zeros(10) at top level works well.\n- Works well with optimizationLevel=0, returns \"0,0,0,0,0,0,0,0,0,0\".\n\n\nReproducible: AlwaysCreated attachment 248902\nTestcase for reproducing the problem\n\nI can confirm this is a bug. I\'ve attached a testcase to reproduce the problem. I unfortunately don\'t know any of the optimizer internals -- I notified Norris Boyd in e-mail; hopefully he\'ll have time to take a look at it.Created attachment 259425\nProposed patch\n\nProposed patch for this bug and bug 359358.Fixed:\n\nChecking in Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.243; previous revision: 1.242\ndone\nChecking in OptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/OptRuntime.java,v  <--  OptRuntime.java\nnew revision: 1.35; previous revision: 1.34\ndone\nChecking in Optimizer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java,v  <--  Optimizer.java\nnew revision: 1.50; previous revision: 1.49\ndoneAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
359411,'LazilyLoadedCtor is not serializable',Rhino,Core,matt,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en) AppleWebKit/418.9 (KHTML, like Gecko) Safari/419.3\nBuild Identifier: \n\nI have a compiled Function object (which should be Serializable), but when I try to write it to an ObjectOutputStream, I get a NotSerializableException because of a LazilyLoadedCtor reachable by it somewhere.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Compile a script into a Function object.\n2. Attempt to serialize the Function.\n\nActual Results:  \njava.io.NotSerializableException: org.mozilla.javascript.LazilyLoadedCtor\n\nExpected Results:  \nCompiled JavaScript Function is serialized.Fixed in CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
360568,'Make swing debugger easier to subclass and extend',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1) Gecko/20060601 Firefox/2.0 (Ubuntu-edgy)\nBuild Identifier: Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1) Gecko/20060601 Firefox/2.0 (Ubuntu-edgy)\n\nThe Swing based Rhino debugger has improved a lot from 1.5 to 1.6, but some things in SwingGui still have package-private access, so it is almost impossible to subclass/extend the SwingGui class outside its package.\n\nI have extended the debugger gui to add a tree of script files and a list of functions for the current file on the left. In order to do this, I had to add two new protected methods to the SwingGui class.\n\nshowFileWindow(String, int) is used to display a script resource and move it to the front, optionally selecting a line. This is called both when the debugger moves to a new stop line, and a file is opened via window menu or function list.\n\nupdateFileWindow(Dim.SourceInfo) is called when the code of a source file has been updated. \n\nMaybe to really add extensibility it would be necessary to turn FileWindow (and possibly a few other classes) into public static inner classes, but for the time being, I chose to go with the minimal set of changes that was necessary.\n\nReproducible: AlwaysCreated attachment 245456\nAdds a few protected methods for subclasses to hook inCreated attachment 245458\nscreenshot of extended rhino debugger\n\nThis is a screenshot of the rhino debugger extended with a file tree/function list on the left side.\n\nThe code for it requires the patched SwingGui class and can be found here:\nhttp://adele.helma.org/source/viewcvs.cgi/helma/src/helma/scripting/rhino/debug/HelmaDebugger.java?cvsroot=hopThanks. Committed to CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
360964,'Native array push is really slow',Rhino,Core,james,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1) Gecko/20060601 Firefox/2.0 (Ubuntu-edgy)\nBuild Identifier: Rhino 1.6 R4\n\nThe code below shows a hundred fold speed difference between the push function and setting array elements directly. Furthermore, when running push some calls do execute quickly and some don\'t.\n\nThis looks like some kind of simple optimisation problem in the push function, I\'ve had a look but can\'t spot quite what it is....\n\n\nReproducible: Always\n\nSteps to Reproduce:\nvar iMax = 100, jMax = 1000;\nvar sys = java.lang.System;\nvar t0 = sys.currentTimeMillis ();\n\nvar x = [];\nfor (var i = 0; i < iMax; i++) {\n\tfor (var j = 0; j < jMax; j++) {\n\t\tx.push ({});\n\t}\n\tsys.out.print (\'.\');\n}\n\nvar t1 = java.lang.System.currentTimeMillis ();\njava.lang.System.out.println (t1 - t0);\n\nvar x = [], n = 0;\nfor (var i = 0; i < iMax; i++) {\n\tfor (var j = 0; j < jMax; j++) {\n\t\tx [n++] = {};\n\t}\n\tsys.out.print (\'.\');\n}\n\nvar t2 = java.lang.System.currentTimeMillis ();\njava.lang.System.out.println (t2 - t1);\n\nActual Results:  \nThe first line of dots are slow and appear erraticaly. The second line appear very quickly.\n\n....................................................................................................36170.0\n....................................................................................................352.0\n\n\nExpected Results:  \nBoth lines should appear quickly and show short (< 1 second) times.The problem here seems to be the lookup of the Array.push function property. The slot allocation mechanism in ScriptableObject scales really badly for dense arrays, because it completely fills the slot array without leaving any gaps. Now if a function property or other non-index property is looked up, ScriptableObject.getSlotPosition() searches from the property\'s hashcode value until it finds either the slot in question or a null slot. If the first n thousand slots are occupied by array elements, this causes a lot of useless looping.\n\nI created an experimental patch that warps the hash/slot index to leave a free slot every 500 elements. With this, push() is roughly half as fast as direct element access for very large arrays.\n\nMaybe the right solution would be to always store numeric Array properties in the dense array in NativeArray (how common are sparse arrays, really?), or separate the array elements from other properties by some other means. \nCreated attachment 246156\nImproves performance of demo script by leaving gaps in dense array slot allocationIs there a good reason not to just use a Java HashMap for this?I don\'t know for sure, but I guess the reasons were performance considerations and keeping order for numeric array elements. \n\nI think the easiest way to fix this would be to use chaining instead of linear probing (see <http://en.wikipedia.org/wiki/Hash_table#Open_addressing_versus_chaining>). I\'ll see if I can come up with a patch.\"I don\'t know for sure, but I guess the reasons were performance considerations\nand keeping order for numeric array elements.\"\n\nFWIW, this doesn\'t prevent numeric array elements getting out of order... eg:var \n\na = {};\na [0] = 0;\na [2] = 2;\na.b = \'b\';\na.n = \'n\';\na [1] = 1;\nfor (var i in a) java.lang.System.out.println (\'\'+i\');\n\n0\nn\n2\n1\nb\nCreated attachment 246454\nImplement slot table using chaining instead of linear probing\n\nHere\'s a patch that implements the ScriptableObject slot table using chaining rather than linear probing for hash collisions. I\'ve been using it for a few days locally and also run the test suite on it without any noticable problems. From my testing, performance is quite a bit better for large objects/arrays, and pretty much unchanged (maybe a hint slower, but almost unmeasurable) for small ones.Created attachment 248648\nImplement slot table using chaining instead of linear probing\n\nContains a few fixes and improvements over the previous patch:\n* Actually check integer index in slot lookup (!!!) This caused numeric slots to get lost in sparse arrays.\n* Make Slot.next transient. This should preserve serialization compatibility, and should be ok since the slot table is newly built upon deserialization (haven\'t actually tested).\n* Unify the two local getSlot() methods, no real need for the static one.\n* Only use REMOVED object for lastAccess cache, we never actually use it in the slot table.\n* Various fixes in replacing setterSlot: Check for slot identity, set wasDeleted on old slot, break the loop when done.Hannes,\n\nas you seem to be familiar with ScriptableObject\'s hashing code, I\'d like to ask whether you see any reason why couldn\'t we just simply use a HashMap in the ScriptableObject implementation? \n\nIn fact, we could go one step further and introduce a sort of a \"MapFactory\" somewhere (probably pluggable into the Context object), so people could plug in whatever map implementations they want, i.e. \n- the Trove <http://trove4j.sourceforge.net/> THashMap, to restore open-addressing implementation if they\'re unsatisfied with HashMap\'s strategy\n- TreeMap if they\'d want ordering guarantees in \"for\"\n- LinkedHashMap if they\'d want weaker ordering guarantees\n(In reply to comment #8)\n> as you seem to be familiar with ScriptableObject\'s hashing code, I\'d like to\n> ask whether you see any reason why couldn\'t we just simply use a HashMap in the\n> ScriptableObject implementation? \n\nThat would normally seem like the way to go. But from a gut level, I\'d hesitate to make such a big change at a spot that is so central to Rhino. For example, this might affect those people using the small-footprint version of Rhino in an environment where memory or cpu performance are scarse. So the goal of my patch was to fix the problem but change as little as possible otherwise.\n\n> In fact, we could go one step further and introduce a sort of a \"MapFactory\"\n> somewhere (probably pluggable into the Context object), so people could plug in\n> whatever map implementations they want\n\nThat would definitely be interesting to experiment with, and to compare it with the current implementation. I don\'t think it would be useful for me to have as a permanent feature, but maybe it would be for others.(In reply to comment #9)\n> (In reply to comment #8)\n> > as you seem to be familiar with ScriptableObject\'s hashing code, I\'d like to\n> > ask whether you see any reason why couldn\'t we just simply use a HashMap in the\n> > ScriptableObject implementation? \n> \n> That would normally seem like the way to go. But from a gut level, I\'d hesitate\n> to make such a big change at a spot that is so central to Rhino. For example,\n> this might affect those people using the small-footprint version of Rhino in an\n> environment where memory or cpu performance are scarse. So the goal of my patch\n> was to fix the problem but change as little as possible otherwise.\n> > In fact, we could go one step further and introduce a sort of a \"MapFactory\"\n> \n> That would definitely be interesting to experiment with, and to compare it with\n> the current implementation. I don\'t think it would be useful for me to have as\n> a permanent feature, but maybe it would be for others.\n\nTo satisfy both of these efficiently you could create a factory for the default Scriptable implementation. Then you can have a hand-crafted version if you want, or one which uses java libraries and things like map factories internally. I\'d definitely like to see this kind of flexibility in Rhino...\n\nJamesThe patch for bug 224334 that has been committed breaks my patch. Since the problem with linear probing in ScriptableObject.java persists, I\'ll work on a new, updated patch when I have time.Created attachment 254164\nNew implementation for slot table using chaining instead of linear probing\n\nThis is a rewrite of my previous patch adapted to recent changes in ScriptableObject. Running the test suite over it with 5 second timeout, I got the same results as with CVS HEAD, with performance slightly improved.David: adding you to CC list, maybe you are interested in looking into this.I get a compile error building with the 2007-02-06 07:13 PDT patch:\n\n    [javac] Compiling 112 source files to /home/norris/rhino/mozilla/js/rhino/build/classes\n    [javac] /home/norris/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java:2293: cannot find symbol\n    [javac] symbol  : variable tableSize\n    [javac] location: class org.mozilla.javascript.ScriptableObject\n    [javac]                 int insertPos = getSlotIndex(tableSize, slot.indexOrHash);\n    [javac]                                              ^\n    [javac] 1 error\nCreated attachment 267488\nUpdated version of previous patch\n\nThe definition of int tableSize was removed in revision 1.120 of ScriptableObject. This new patch puts it in again. From a quick test I did, everything looks ok.Patch committed on both 1.6R6 branch and trunk. \n\nThe idea of switching to HashMap is good, but that\'s more of a task for next release rather than this release. \nCreated Bug 383592 for the future enhancement of using HashMap in ScriptableObject.',?,IMPROVEMENT
361067,'NullPointerException in shell when attempting to run compiled script using syntax: (new Packages.test())()',Rhino,Core,joshstaiger,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.8) Gecko/20061025 Firefox/1.5.0.8\nBuild Identifier: Rhino 1.6 release 5 Pre 2006 11 17\n\nI see the following in the Rhino shell when trying to execute a compiled script on the classpath by entering \"(new Packages.test())()\"\n\nException in thread \"main\" java.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptRuntime.getValueFunctionAndThis(ScriptRuntime.java:2019)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:2950)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2254)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:161)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:340)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2758)\n\tat org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:172)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:503)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:367)\n\tat org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n\tat org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n\tat org.mozilla.javascript.Context.call(Context.java:536)\n\tat org.mozilla.javascript.ContextFactory.call(ContextFactory.java:450)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\n\nI\'m not sure if using this syntax is Khosher or not, but in either case the shell should handle it gracefully without completely bombing out.\n\nReproducible: Always\n\nSteps to Reproduce:\n/home/jstaiger$ cat test.js\njava.lang.System.out.println(\"Hello, world!\");\n/home/jstaiger$ java org.mozilla.javascript.tools.jsc.Main test.js\n/home/jstaiger$ ls *.class\ntest.class\n/home/jstaiger$ echo $CLASSPATH\n.;/rhino/mozilla/js/rhino/build/rhino1_6R5pre/js.jar\n/home/jstaiger$ java org.mozilla.javascript.tools.shell.Main\nRhino 1.6 release 5 Pre 2006 11 17\njs> var testScript = new Packages.test()\njs> testScript()\nHello, world!\njs> (new Packages.test())()\nException in thread \"main\" java.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptRuntime.getValueFunctionAndThis(ScriptRuntime.java:2019)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:2950)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2254)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:161)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:340)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2758)\n\tat org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:172)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:503)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:367)\n\tat org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n\tat org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n\tat org.mozilla.javascript.Context.call(Context.java:536)\n\tat org.mozilla.javascript.ContextFactory.call(ContextFactory.java:450)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\n\nActual Results:  \nException in thread \"main\" java.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptRuntime.getValueFunctionAndThis(ScriptRuntime.java:2019)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:2950)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2254)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:161)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:340)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2758)\n\tat org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:172)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:503)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:367)\n\tat org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n\tat org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n\tat org.mozilla.javascript.Context.call(Context.java:536)\n\tat org.mozilla.javascript.ContextFactory.call(ContextFactory.java:450)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\n\n\nExpected Results:  \nThe shell should handle this statement gracefully.Indeed, this looks like it is a bug - what\'s interesting is that this works:\n\nvar x = new Packages.test();\nx();\nFixed: \n\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.263.2.2; previous revision: 1.263.2.1\ndone\n',?,BUG
361574,'Typo in Parser.java',Rhino,Core,ispeters,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.8) Gecko/20061110 Firefox/1.5.0.8\nBuild Identifier: 1.6.1\n\nLine 353 of org.mozilla.javascript.Parser refers to \"mag.too.deep.parser.recursion\", which I assume should be \"msg.too.deep.parser.recursion\" since a grep of the source returns no other hits for \"mag\" but many hits for \"msg\".\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Unzip source\n2. find -type f | xargs grep mag\n3. find -type f | xargs grep msg\n\nActual Results:  \nStep 2 returns only one hit that isn\'t a comment, step 3 returns ~300 hits.\n\nExpected Results:  \nIf \"mag.too.deep.parser.recursion\" were correct, I\'d expect to find \"mag\" elsewhere in the source but I don\'t.  I assume it\'s a typo since \"msg\" makes sense, and the a and s keys are near each other.Created attachment 246329\nPatch fixing typoCommitted. Also fixed the typo in Messages.properties -- without it your patch would cause Rhino not to find the message.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,CLEANUP
361616,'toLocaleUpperCase/toLocaleLowerCase is not supported',Rhino,Core,greatyan,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\n\ntoLocaleUpperCase/toLocaleLowerCase is not supported in NativeString.\n\nReproducible: AlwaysFixed in CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
363058,'Provide JavaScript-only stack trace from RhinoException',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1) Gecko/20060601 Firefox/2.0 (Ubuntu-edgy)\nBuild Identifier: \n\nWhen running with the optimizer enabled, Rhino produces \"mixed\" stack traces automatically, since javascript resources are actually compiled to java classes. In interpreter mode, Rhino makes some effort to include the script stack into stack traces (see Interpreter.getPatchedStack()). \n\nMixed stack traces are very useful, but I have found that an even greater blessing for script writers are script only stack traces which only include JavaScript stack information, excluding the Java stuff. After all, JavaScript is a full, autonomous language environment, so it deserves its own stack trace.\n\nIdeally, I think RhinoExceptions stack traces should have two parts, similar to the way nested exceptions are dumped: The first part with only the Javascript stack, followed by the full (possibly nested) Java stack trace. As an example (this is as it is implemented in Helma): \n\nhelma.scripting.ScriptingException: ReferenceError: \"xxx\" is not defined. (/home/hannes/gobi/code/Comment/Comment.js#35)\n        at /home/hannes/gobi/code/Comment/Comment.js:35\n        at /home/hannes/gobi/code/Page/PageCore.js:339\n        at /home/hannes/gobi/code/Page/PageMacros.js:452\n        at /home/hannes/gobi/code/HopObject/macros.js:10\n        at /home/hannes/gobi/code/Global/WikiMarkup.js:26\n        at /home/hannes/gobi/code/Page/PageCore.js:505\n        at /home/hannes/gobi/code/Page/PageCore.js:492\n        at /home/hannes/gobi/code/Page/Page.js:277\nFull trace: org.mozilla.javascript.EcmaError: ReferenceError: \"xxx\" is not defined. (/home/hannes/gobi/code/Comment/Comment.js#35)\n        at org.mozilla.javascript.ScriptRuntime.constructError(ScriptRuntime.java:3226)\n        at org.mozilla.javascript.ScriptRuntime.constructError(ScriptRuntime.java:3216)\n        at org.mozilla.javascript.ScriptRuntime.notFoundError(ScriptRuntime.java:3289)\n        at org.mozilla.javascript.ScriptRuntime.name(ScriptRuntime.java:1570)\n        at org.mozilla.javascript.gen.c64._c2(/home/hannes/gobi/code/Comment/Comment.js:35)\n        at org.mozilla.javascript.gen.c64.call(/home/hannes/gobi/code/Comment/Comment.js)\n        at org.mozilla.javascript.optimizer.OptRuntime.callProp0(OptRuntime.java:119)\n \n\nReproducible: AlwaysCreated attachment 247811\nRhinoException.getScriptStackTrace() methods to get JS-only stack dumps\n\nAdds public getScriptStackTrace() methods to org.mozilla.javascript.RhinoException. Going further, the RhinoException.printStackTrace() methods could be adapted to include this information in stack traces.This patch looks good, however we might have an (admittedly exotic, but neverthless possible) case where we have mixed compiled and interpreted code on the stack. This is because we can have systems where scripts are compiled in contexts with different optimization levels. So, you\'d have to combine the two approaches: first allow the interpreter to patch the stack, then extract from it the patched entries + entries for Java frames coming from sources that end in .js.Created attachment 251061\nRhinoException.getScriptStackTrace() now working with mixed interpreted/compiled stacks\n\nI\'ve rewritten the patch to work for mixed compiled/interpreted stacks. Because the Interpreter.CallFrame class is private this is a bit more complex than I\'d like. Interpreter.getScriptStack(RhinoException) now generates a java.util.List containing the interpreted script stack fragments, which are then inserted at the right place by RhinoException.getScriptStackTrace().Committed patch:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.320.2.2; previous revision: 1.320.2.1\ndone\nChecking in src/org/mozilla/javascript/RhinoException.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/RhinoException.java,v  <--  RhinoException.java\nnew revision: 1.3.2.1; previous revision: 1.3\ndone\n',?,CLEANUP
366550,'increment and decrement operators don\'t work for global vars with dynamic scopes',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1.1) Gecko/20060601 Firefox/2.0.0.1 (Ubuntu-edgy)\nBuild Identifier: \n\nScriptRuntime.nameIncrDecr() is currently not aware of dynamic scopes. When ++ or  -- is applied to a global variable in the dynamic scope, a ReferenceError is thrown. \n\nReproducible: AlwaysCreated attachment 251067\nFixes this bug by calling checkDynamicScope() when parent scope is null\n\nSince ScriptRuntime.nameIncrDecr() now needs the current Context in order to know whether dynamic scopes are enabled, it now takes a Context parameter. The old signature is deprecated but still left in place for backwards compatibility.\n\n(I also fixed two unrelated javadoc @link tags since Intellij pointed me to it. Sorry if this is confusing.)Can you explain why you need to test for\n\nif (cx.useDynamicScope && scopeChain.getParentScope() == null)\n\ninstead of \n\nif (cx.useDynamicScope)\n\nor even better\n\nif (cx.hasFeature(Context.FEATURE_DYNAMIC_SCOPE))\n\n?Also, it is not completely clear to me when should a dynamic scoping lookup be performed. Namely -- is dynamic scoping the property of the current context, or the property of the function? Functions have a \"dynamic scoping\" flag that is set to true if their *compiling* Context was set to have dynamic scoping. I think that in light of this, ScriptRuntime.nameIncrDecr() should maybe instead have a boolean flag that\'s set to true if the invoking function was compiled in a Context that had dynamic scopes.\n\nActually, I\'m coming to believe that dynamic scope is more trouble than it is worth. For one thing, it\'s non-ECMA. Back in the day, I used to think it\'s a nice (even if non-ECMA compliant) feature, especially since I had a system using a shared scope with global functions that was set as the prototype of per--thread scopes. I believe (correct me if I\'m wrong) that most people use dynamic scopes in this exact setting. I did however reach the conclusion that having such global shared prototype scopes is not such a good idea -- the performance impact of just defining those global functions in each of your scripts instead is negligable. Even if you use a shared prototype scope, you can do it without dynamic scopes feature -- you just need to remember to explicitly qualify access to global variables with \"this\" withing the body of these global functions. If I had it my way, I\'d declare the dynamic scopes to be a deprecated feature, and just educate the users about how to live without it.(In reply to comment #2)\n> Can you explain why you need to test for\n> \n> if (cx.useDynamicScope && scopeChain.getParentScope() == null)\n> \n> instead of \n> \n> if (cx.useDynamicScope)\n\nWe\'re walking down the scope chain, and only the last, top level scope is replaced by the dynamic scope (which must have the static top level scope as its prototype). Calling ScriptRuntime.checkDynamicScope with anything else than the static top scope as second argument would be wrong.\n\n> or even better\n> \n> if (cx.hasFeature(Context.FEATURE_DYNAMIC_SCOPE))\n\ncx.useDynamicScope is merely a \"proxy\" field for cx.hasFeature(Context.FEATURE_DYNAMIC_SCOPE). It is set in ScriptRuntime.doTopCall() and used in various places in ScriptRuntime.(In reply to comment #3)\n> Also, it is not completely clear to me when should a dynamic scoping lookup be\n> performed. Namely -- is dynamic scoping the property of the current context, or\n> the property of the function? Functions have a \"dynamic scoping\" flag that is\n> set to true if their *compiling* Context was set to have dynamic scoping. \n\nI think the confusion comes from the fact that there are two ways to enable dynamic scopes: the old, deprecated way, and the current way. The old way worked via setting Context.setCompileFunctionsWithDynamicScope() and was indeed a compile-time feature. The problem is that it didn\'t work with nested functions, so it was replaced by the current solution, which checks whether to use dynamic scopes at various places in ScriptRuntime.\n\n> Actually, I\'m coming to believe that dynamic scope is more trouble than it is\n> worth. For one thing, it\'s non-ECMA. Back in the day, I used to think it\'s a\n> nice (even if non-ECMA compliant) feature, especially since I had a system\n> using a shared scope with global functions that was set as the prototype of\n> per--thread scopes. I believe (correct me if I\'m wrong) that most people use\n> dynamic scopes in this exact setting. I did however reach the conclusion that\n> having such global shared prototype scopes is not such a good idea -- the\n> performance impact of just defining those global functions in each of your\n> scripts instead is negligable. Even if you use a shared prototype scope, you\n> can do it without dynamic scopes feature -- you just need to remember to\n> explicitly qualify access to global variables with \"this\" withing the body of\n> these global functions. If I had it my way, I\'d declare the dynamic scopes to\n> be a deprecated feature, and just educate the users about how to live without\n> it.\n\nPlease don\'t! Helma applications often grow to several hundred kB of Javascript code, and compiling everything 20 or 40 times instead of just once would simply cause them to stop working under load. \n\nWe have been using dynamic scopes for years and never really had a big problem, except the nested function problem with the old approach, and, well, this bug now. You can blame me for not switching to the new approach earlier, Partly it had to do with the fact that I was confused myself, just see bug #347154 for some of that. \n\nRegarding ECMA, it\'s true that this setup is obviously not described in the spec, but saying that it is non ECMA-compliant is a bit far-fetched, too. I don\'t think ECMA specifies how the top level scope object should be implemented, and to the outside, the prototyped dynamic scope behaves exactly as defined in the spec. I\' saying this to the best of my knowledge without having looked at the spec recently, but I could check if this is an issue.(In reply to comment #5)\n\n> > these global functions. If I had it my way, I\'d declare the dynamic scopes to\n\n> > be a deprecated feature, and just educate the users about how to live without\n\n> > it.\n\n> \n\n> Please don\'t! Helma applications often grow to several hundred kB of Javascript\n\n> code, and compiling everything 20 or 40 times instead of just once would simply\n\n> cause them to stop working under load. \n\n> \n\n\nNo worries -- I\'m not interested in wrecking significant efforts of people who built their own systems atop of Rhino :-) As a matter of fact, you wouldn\'t need to *compile* everything repeatedly, just *execute* a once-compiled script in every new top-level scope. That\'d just create new Function objects, but their code is already compiled (either into InterpreterData instance or into a Java class). It\'s still more overhead than not even creating new Function objects at all, but the complexity of your scope setup gets reduced in turn. Yes, it\'s a tradeoff, and what I\'d want to do is teach the people about the existence of this tradeoff, so they can choose one way or the other.  \n\n> Regarding ECMA, it\'s true that this setup is obviously not described in the\n\n> spec, but saying that it is non ECMA-compliant is a bit far-fetched, too. I\n\n> don\'t think ECMA specifies how the top level scope object should be\n\n> implemented, and to the outside, the prototyped dynamic scope behaves exactly\n\n> as defined in the spec. I\' saying this to the best of my knowledge without\n\n> having looked at the spec recently, but I could check if this is an issue.\n\n> \n\n\nThe ECMA spec is very explicit regarding how is a name to be resolved against a scope chain. With dynamic scopes, a function defined in the prototype object resolves names differently based on where it is invoked from. As I see it, people are using this mainly to avoid having to write a lot of \"this.\" qualifiers in the functions in the prototype object. I wouldn\'t have problems with it if this behaviour were encapsulated within a special implementation of Scriptable - in that case you could claim that the object behaves like that on the \"inside\" while retaining spec-compliant behaviour on the \"outside\". What I have issues with is that the concept of dynamic scopes is being present in the ScriptRuntime.\n\nRegardless, for the time being, I\'ll commit your patch -- it\'s a good solution for the problem within the constraints of the current implementationPatch committed to CVS HEAD.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,DESIGN_DEFECT
367385,'[Fix] defineClass\'s inheritance mapping is broken for abstract class subclasses',Rhino,Core,stevekweiss,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)\nBuild Identifier: Rhino 1.6R5\n\nBug 333168 has the description.  Attached is a proposed patch, based on the second proposal in 333168\'s bug report.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 251947\nPatch proposalFix committed to CVS HEAD.*** Bug 333168 has been marked as a duplicate of this bug. ***Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
367707,'Building Rhino without E4X implementation',Rhino,Core,sameera,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.1) Gecko/20061208 Firefox/2.0.0.1\nBuild Identifier: Rhino 1.6R1\n\nIt is required in some instances to build Rhino without the E4X implementation. If there is a option to build Rhino without E4X then the user can add a customized E4X implementation to the classpath and use it. \n\nWe(www.wso2.org) use rhino in Apache Axis2 (Web service engine) to enable JavaScript web services and we have our own e4x implementation that uses Apache Axiom instead of XMLBeans. Since Axis2 uses Axiom, our E4X implementation improves performance of Axis2. Therefore we have a requirement to build rhino without e4x and then add our e4x implementation to the classpath.\n\nWhat I suggest is to add a seperate ant target to the build.xml which build Rhino without E4X.\n\nReproducible: Didn\'t try\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 252288\nattachement contains a proposed ant target to build Rhino without E4XDo you change Rhino source in order to integrate your E4X implementation?  I\'d think that what you\'d want would be to be able to plug in your implementation rather than the XMLBeans one (or the coming DOM one), regardless of whether the XML-related classes remain in the JAR file, right?In org.mozilla.javascript.ScriptRuntime class, the variable \'XML_INIT_CLASS\' is used to hold a reference to the class XMLLibImpl which is used to load the e4x related classes. It currently has \'org.mozilla.javascript.xmlimpl.XMLLibImpl\' hard coded. One option is to make it configurable, so that other e4x implementations can be plugged in by configuring that variable.  \n\nSecond option is to remove the default \'org.mozilla.javascript.xmlimpl.XMLLibImpl\' and the containing package from the classpath. This enables users to put another implementation (eg: axiom, dom based...) of E4X with the same package structure to the classpath.\n\nI chose the second option because it requires minimal changes (adding a separate ant target to the build.xml). The E4X implementation based on Apache Axiom is available at https://wso2.org/repos/wso2/wsf/javascript/rhino/. Maven is used to build js-axiom.jar(E4X impl based on Axiom) this building process uses temporarily hosted js-core.jar (Rhino without E4X related classes). The js-core.jar is hosted only for testing purposes. if you want to plug a dom impl then what you have to do is to follow the same package structure and specifically the \'org.mozilla.javascript.xmlimpl.XMLLibImpl\' class and then put it in to the classpath. \n\nThis option results in two jar files. One js-core and the other is js-e4x-impl.\n\n\nI apologize if you\'ve already explored this, but couldn\'t this be fixed in your situation by putting your E4X implementation ahead of js.jar in your classpath?\n\nAlso, does \'smalljar\' meet your needs?\n\nIn any case, unless someone strongly objects, the next version of E4X support will provide a pluggability mechanism for the Context to decide its E4X implementation.  So under that scenario, you\'d rename your classes (i.e., choose a different package name) and use the pluggability mechanism to select your implementation.  Once your E4X implementation were repackaged, you could just change your way of instantiating the Contexts and use the \"default\" build.\n\nThat said, I\'m not saying it doesn\'t make sense to revamp how Rhino is built (and try to come up with some organized way of managing these \"optional\" packages).  There are \'jar\' and \'smalljar\' presently but there are a bunch of things (the soon-to-be-two E4X implementations, the class generation library) that could be packaged optionally, either by building several JAR files by default or by switching them on or off either via Ant properties or some other mechanism.  I personally would just want to avoid a proliferation of Ant targets for each yes/no combination of include-or-don\'t-include.\n\nI personally would tend to err on the side of simplicity and not trying to save a bunch of size on the JAR file, but that\'s just my view.OK, I think I\'ve found your answer for now -- you can build the JAR file without the XMLBeans implementation by setting the property without-xmlimpl, either at the command line or in your build.local.properties or ... however you want to do it.  This causes the xmlimplsrc/build.xml compile step not to get executed.\n\nI haven\'t tested this, but unless I don\'t understand how Ant works, ...\n\nWe could document this better.A couple of comments.\n\n1. I do believe the -Dwithout-xmlimpl=true option to Ant would do the trick on older releases.\n\n2. I have revised the xmlimplsrc/build.xml to respond to two properties (and tested them):\n\na. -Dno-e4x=true:  Will cause E4X not to be built, like -Dwithout-xmlimpl=true used to (and still does)\n\nb. -Dno-xmlbeans=true:  Will not build the old XMLBeans-based implementation of E4X (but will build the new DOM one).\n\nSubmitter should also note one change to the XMLLib class committed along with the fix for bug 355677.  The library used to be responsible for quoting attributes inside curly braces, but now the interpreter takes on that responsibility.  Of course submitter is encouraged to use the new pluggability API for E4X but the previous solution will work as well.\n\nClosing as FIXED.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
368019,'regular expression (regex) parses /[/]/ incorrectly',Rhino,Compiler,watts.chris,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.1) Gecko/20061204 Firefox/2.0.0.1\nBuild Identifier: js-1.6R2\n\nIf you have an html page that contains javascript code of:\n\n<script>\nmyregex = /[/]/;\n</script>\n\nthen you get an error of expected \';\'.\n\nAs far as I am aware [/] is valid for regular expressions in javascript (it works in IE6 & Firefox).\n\n\nA work around is:\n<script>\nmyregex = /\\//;\n</script>\n\nor\n\n<script>\nmyregex = new RegEx(\"[/]\");\n</script>\n\nReproducible: Always\n\nSteps to Reproduce:\nUsed htmlunit (http://htmlunit.sf.net) to parse page containing the following script:\n<script>\nmyregex = /[/]/;\n</script>\nActual Results:  \nERROR com.gargoylesoftware.htmlunit.ScriptEngine  - error: message=[missing ; before statement] sourceName=[http://localhost:6060/sms/JavaScript/common.js] line=[1] lineSource=[var testRegex = /[/]/;] lineOffset=[20]\n\nExpected Results:  \nNo error?\"/\" is the opening and closing character of the regular expression literal, to use it within an expression you must escape it with a backslash.  This is not a work-around, but expected behavior.  This is specified by ECMA-262 in section 7.8.5 (the syntax productions)We support the IE quirk that allows unescaped backslash in character class, contra ECMA-262 Edition 3. The following works for me in Firefox 2 and the js shell built from the 1.8 branch, 1.8.0 branch, and trunk:\n\nmyregex = /[/]/;\n\nReporter, can you please attach a testcase and give the exact user agent in which it fails for you?\n\n/beThe source of the bug report (and therefore the user agent) is HtmlUnit:\n\nhttps://sourceforge.net/tracker/?func=detail&atid=448266&aid=1640568&group_id=47038\n\nJust curious: Is this a difference between spidermonkey and rhino or does firefox pre-process the quirk?May I post this test case using Rhino 1.6R5:\n\n----------------------------------------------------------\n        final Context cx = Context.enter();\n        final Scriptable scope = cx.initStandardObjects();\n        cx.evaluateString( scope, \"myregex = /[/]/;\", \"source1\", 1, null);\n        Context.exit();\n----------------------------------------------------------Problem is occurring because of following while loop in readRegExp() method of org.mozilla.javascript.TokenStream.java class.\n\nwhile ((c = getChar()) != \'/\') {\n    if (c == \'\\n\' || c == EOF_CHAR) {\n        ungetChar(c);\n        throw parser.reportError(\"msg.unterminated.re.lit\");\n    }\n    if (c == \'\\\\\') {\n        addToString(c);\n        c = getChar();\n    }\n\n    addToString(c);\n}\n\n\nI am not an expert in Regular Expression so can\'t say whether it is a bug or not. But I am facing problem because of this. I am developing a testing tool using HtmlUnit for one of our clients and he is having following code in his JavaScripts.\n\nif( str.match(/[*+-./]/) ) \n\nI have requested him to change the scripts. But that script is part of a framework and lot of applications depend on that framework. If the request is rejected then I will have to handle it in above mentioned code.\n\nI am thinking of pushing \'[\' (and may be \'(\') on stack and consuming \'/\' if stack is not empty. Do I need to handle anything more than this? I know that it will work in my case but is it generic enough? If it is then I will post updated code here.\n\nThanks & Regards,\nSudhan\n\nSudhan Moghe:  I don\'t think your comment is correctly associated with the rest of this bug, you should probably file a new bug.\n\nThanksYes, it is.\nWhat I have posted is the code from Rhino that is parsing the regex.\nmy case is \n\nif( str.match(/[*+-./]/) ) \n\nwhich is similar to \n/[/]/\n\nas you can see from the rhino code, parsing of regex stops when it encounters second \'/\'. \nAfter this point parser expects \')\' in my case and \';\' in the case reported in the bug. But it encounters \']\' and throws error.\n\nYou should escape your \"/\" with a \"\\\".  This is not a bug.(In reply to comment #8)\n> You should escape your \"/\" with a \"\\\".  This is not a bug.\n\nWait, we changed SpiderMonkey to match IE JScript and *not* require a backslash for this case. Why tell Rhino users to pound sand?\n\nThis is obviously a misfiled Rhino bug. ES4 matches the de-facto standard and I\'m sure Rhino owners/peers will track that.\n\n/be(In reply to comment #8)\nI am not saying that it is a bug but the problem is that the JavaScript is not under my control and I can not modify it to escape \'/\'.\nI am developing a testing tool using HtmlUnit which internally uses Rhino. And my tool wont work unless this issue is fixed. I can handle it as I have suggested in Comment #5. I just wanted to know whether that is a proper handling or do I need to handle more cases? And what are the chances of that getting included in Rhino code.\n\nThanks & Regards,\nSudhan\n\nIf Rhino maintainers don\'t want to include this per default to respect Ecma spec, then what do you think of an additional feature option in Context to allow it?Recommend that Rhino match SpiderMonkey and other browser engines, and anticipate JS2/ES4, by allowing unescaped / in character class.\n\n/beI think that tracking open brackets would work as you suggested in Comment #5. If you have patched the code already and can post a patch, it\'d be appreciated.Created attachment 314351\nPatch handling / with []\n\nThis patch fixes the problem for me and doesn\'t break any additional tests from the junit-all target (as already said, a good state of the tests would help to avoid regression and discover issues fixed as side effects)Fixed.',?,BUG
368323,'Global class\'s runCommand suffers from Bad file descriptor IOExceptions on extra close() calls',Rhino,Core,krouskop+mozillabugzilla,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.8.0.9) Gecko/20070102 Ubuntu/dapper-security Firefox/1.5.0.9\nBuild Identifier: Rhino 1.6 release 5\n\nWhen using the org.mozilla.javascript.tools.shell.Global.runCommand method (via calls to \"runCommand(...)\" in the Rhino shell), after a number of calls, an IOException (bad file descriptor) occurs.\n\nExample stack trace for when this Exception occurs:\norg.mozilla.javascript.WrappedException: Wrapped java.io.IOException: Bad file descriptor (runCommandBug.js#10)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1693)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:160)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:408)\n        at org.mozilla.javascript.optimizer.OptRuntime.callName(OptRuntime.java:97)\n        at org.mozilla.javascript.gen.c1._c0(runCommandBug.js:10)\n        at org.mozilla.javascript.gen.c1.call(runCommandBug.js)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:340)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2758)\n        at org.mozilla.javascript.gen.c1.call(runCommandBug.js)\n        at org.mozilla.javascript.gen.c1.exec(runCommandBug.js)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:503)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:425)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:391)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:382)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n        at org.mozilla.javascript.Context.call(Context.java:528)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:450)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\nCaused by: java.io.IOException: Bad file descriptor\n        at java.io.FileInputStream.close0(Native Method)\n        at java.io.FileInputStream.close(FileInputStream.java:245)\n        at org.mozilla.javascript.tools.shell.Global.runProcess(Global.java:774)\n        at org.mozilla.javascript.tools.shell.Global.runCommand(Global.java:536)\n        at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:585)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:145)\n        ... 18 more\n\n(Line 774 is the line with errProcess.close():\n\n  } finally {\n      if (errProcess != null) {\n          errProcess.close();\n      }\n  }\n\n)\n\nLooking in to this, my best guess (I wish I could provide insight that was more certain than a guess...) is that following the call to .close() done in the pipe() method, the errProcess stream gets cleaned up, and its underlying file descriptor is destroyed, thus this exception on this later (second) call to close().\n\nIf this call to errProcess.close() is commented out, the same exception would occur, but via the call to in.close() on line 744: (\n\n  pipe(false, in, inProcess);\n  in.close();\n\n)\n\nI suspect (though didn\'t actually encounter) this exception could also happen on line 769\'s call to outProcess.close().\n\nReproducible: Always\n\nSteps to Reproduce:\nrun \"rhino runCommandBug.js\", where the file runCommandBug.js consists of:\n\nvar i = 0;\nwhile (true) {\n\n    i += 1;\n\n    print(\"\\nA - \" + i);\n    runCommand(\"ls\", \"-w\", \"0\");\n\n    print(\"\\nB - \" + i);\n    runCommand(\"ls\", \"-w\", \"1\");\n\n}\nActual Results:  \nIOException (\"Bad file descriptor\") would occur around the 30th iteration of the loop. (Sometimes the exception would not occur until after several hundred iterations though.)\n\nExpected Results:  \nException-free execution\n\nEnvironment information:\n\n$ java -version\njava version \"1.5.0_06\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_06-b05)\nJava HotSpot(TM) 64-Bit Server VM (build 1.5.0_06-b05, mixed mode)\n\n$ cat /proc/version\nLinux version 2.6.15-27-amd64-generic (buildd@king) (gcc version 4.0.3 (Ubuntu 4.0.3-1ubuntu5)) #1 SMP PREEMPT Fri Dec 8 17:50:54 UTC 2006\n\n\n===\n\nPossible workaround:\n\nI am using a patched version of the Global class, based on the source from rhino1_6R5.zip, which seems to be working fine for me. Below is a diff between my patched version and the original:\n\ndiff toolsrc/org/mozilla/javascript/tools/shell/Global.java.orig toolsrc/org/mozilla/javascript/tools/shell/Global.java\n744c744,746\n<                             in.close();\n---\n>\n>                             closeAndIgnoreBadFileDesciptor(in);\n>\n769c771\n<                         outProcess.close();\n---\n>                         closeAndIgnoreBadFileDesciptor(outProcess);\n774c776\n<                     errProcess.close();\n---\n>                     closeAndIgnoreBadFileDesciptor(errProcess);\n793a796,809\n>     static void closeAndIgnoreBadFileDesciptor(InputStream stream)\n>             throws IOException {\n>\n>         try {\n>             stream.close();\n>         }\n>         catch (IOException e) {\n>             final String msg = e.getMessage();\n>             if (! msg.startsWith(\"Bad file descriptor\") )\n>                 throw e;\n>         }\n>\n>     }\n>Could you package this up as a patch and attach it?Created attachment 267275\nrunCommandBug.js file described in my original comment that exposes this issueCreated attachment 267276\nPatch file to fix the \"bug\" with Global.java\n\nPatches Global.java revision 1.43 from CVS:\n\n$ cvs status Global.java\n===================================================================\nFile: Global.java       Status: Locally Modified\n\n   Working revision:    1.43\n   Repository revision: 1.43    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java,vNote - this bug does seem to be environment specific. Running with the latest code in CVS, and with Java 6 / Ubuntu 7.04, I\'m no longer able to exploit this bug.\n\n$ java -version\njava version \"1.6.0_01\"\nJava(TM) SE Runtime Environment (build 1.6.0_01-b06)\nJava HotSpot(TM) 64-Bit Server VM (build 1.6.0_01-b06, mixed mode)\n\n$ cat /proc/version\nLinux version 2.6.20-16-generic (root@king) (gcc version 4.1.2 (Ubuntu 4.1.2-0ubuntu4)) #2 SMP Wed May 23 00:30:47 UTC 2007\n\n--\n\nHOWEVER, if I try running it using Java 5 again (even under Ubuntu 7.04), I AM able to still exploit the bug. Generally I get the bad IOException around 75 iterations through. The stack trace is slightly different than originally reported (this is accounted for by the fact the code in CVS has changed since I originally reported this) but it\'s the same underlying problem.\n\nI\'ve attached a patch for Global.java (CVS revision 1.43) which solves the problem under Java 5 (and continues to work fine under Java 6).I don\'t really like just swallowing the exception, even if we check the message to ensure it\'s the right exception. \n\nLooking at the code I believe I can see code paths that will close a stream more than once. Note that pipe will close either its 2rd or 3rd argument, and PipeThread calls pipe. Yet we have close called in runProcess on those streams as well. Perhaps there is a race condition with the termination of the PipeThread that causes this not to fail every time.I came across this bug as well. It\'s thread related, so that\'s why it doesn\'t show up all the time, or in all environments. This script reproduces it on my environment, after about half a dozen times through the loop, although it varies greatly.\n\nThe solution sent by Adam addresses the symptom and not the cause. I wouldn\'t put it into production (sorry Adam :)\n\n<code>\nwhile (true) {\n    runCommand(\"echo\");\n}\n</code>\n\nOS: CentOS release 4.5 (Final)\nJRE: 1.5.0_06 and 1.6.0_03\nRhino: 1.6R7\n\norg.mozilla.javascript.WrappedException: Wrapped java.io.IOExescriptor\n        at org.mozilla.javascript.Context.throwAsScriptRuntim57)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.\n        at org.mozilla.javascript.FunctionObject.call(Functio\n        at org.mozilla.javascript.optimizer.OptRuntime.callNa97)\n        at org.mozilla.javascript.gen.c1._c0(Unknown Source)\n        at org.mozilla.javascript.gen.c1.call(Unknown Source)\n        at org.mozilla.javascript.ContextFactory.doTopCall(Co93)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(Scr4)\n        at org.mozilla.javascript.gen.c1.call(Unknown Source)\n        at org.mozilla.javascript.gen.c1.exec(Unknown Source)\n        at org.mozilla.javascript.tools.shell.Main.evaluateSc\n        at org.mozilla.javascript.tools.shell.Main.processFil46)\n        at org.mozilla.javascript.tools.shell.Main.processFil\n        at org.mozilla.javascript.tools.shell.Main.processSou\n        at org.mozilla.javascript.tools.shell.Main.processFil\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run\n        at org.mozilla.javascript.Context.call(Context.java:5\n        at org.mozilla.javascript.ContextFactory.call(Context\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.\n        at org.mozilla.javascript.tools.shell.Main.main(Main.\nCaused by: java.io.IOException: Bad file descriptor\n        at java.io.FileInputStream.close0(Native Method)\n        at java.io.FileInputStream.close(FileInputStream.java\n        at org.mozilla.javascript.tools.shell.Global.runProce\n        at org.mozilla.javascript.tools.shell.Global.runComma\n        at sun.reflect.GeneratedMethodAccessor1.invoke(Unknow\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DesorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.\n        ... 18 more\nJust a few comments...\n\nFirst - to Josh - I don\'t believe this is thread related. Unless runCommand launches new threads (which I do NOT believe to be the case), my code snippet runs exclusively in a single thread and I believe yours does as well.\n\nNow regarding a proper solution:\n\nI agree with Norris that my solution of swallowing the exception is not the ideal solution, and I certainly hope the patch I provided does NOT get incorporated into base code. I can (however) attest to the fact that I\'ve been using a version of Rhino with the patch to run a script that backups my company\'s servers on a nightly basis since January and have yet to have any problems -- so if someone is in a pinch, I heartily recommend patching and using without worry. Alternatively, based on my testing, you could also simply move to Sun\'s Java 6 VM and also be fine w/ stock Rhino.\n\nA real solution should be to avoid the second calls to close(). A hack-ish way to do this might be to wrap the stream with a proxy that would track if close has been called and only pass on a close call once. The less hack-ish approach (but would be more work, and require better working knowledge of Rhino than I currently have) would be to re-wrote the code so the path to closing twice never occurs.\n\nAlso, note, that I believe two calls to close() can occur without an Exception occurring (again, I don\'t believe this is thread/race-condition related). I believe the problem is that underlying the stream, their should be a file descriptor. If, after the first call to close(), the association between the file descriptor and the stream is released, the second call to close() raises the exception. But, I do not believe that the first call always breaks the association (hence why a second close() call does not always fail.)Created attachment 284416\nFix to bug, refactored\n\nI refactored the code so that an erroneous additional call to close() is not possible. close() was being called inside pipe() so there was no need to call it in runProcess() as well. The code is cleaner due to the lack of nesting of try{} blocks. In general this excessive nesting should be avoided anyway, and the function was in need of refactoring IMO.Thanks for your comments Adam.\nI was able to reproduce bug with my code and environment with jdk1.6.0.03.\n\nThe 2nd call to close was always being done, but most of the time it happened inside the PipeThread class where it was suppressed.  Every once in a while the other thread finished first and the IOException propagated out of runProcess(). Hence this was a race condition and so was a thread issue.\n\nThanks again, and cheers!\nCreated attachment 284424\nBug fix, cleaner\n\nPlease use this instead of earlier patch I submitted. The variable declares are cleaner in this one.Fixed: \n\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Global.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java,v  <--  Global.java\nnew revision: 1.45; previous revision: 1.44\ndone\n',?,BUG
368452,'Implement __noSuchMethod__ in Rhino',Rhino,Core,inonit,norrisboyd,'See bug 196097 for SpiderMonkey.  Basically this implements a default handler when methods are invoked on an object that do not exist, which supports various programming techniques.I\'ve started investigating this.  Looks like it should require no codegen changes, just some trickery to finesse the existing call code.Created attachment 254987\nThis patch implements __noSuchMethod__\n\nThis doesn\'t break any new tests and passes the noSuchMethod test already written.Checked in Bob\'s change:\n\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <-- ScriptRuntime.java\nnew revision: 1.257; previous revision: 1.256\ndone\nAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
368453,'Implement __lookupGetter__ and __lookupSetter__ in Rhino',Rhino,Core,inonit,norrisboyd,'Currently, __defineGetter__ and __defineSetter__ are working but the lookup-related methods are not implemented.  This prevents various functional programming techniques, like \"decorating\" an existing method with a join point (like in aspect-oriented programming, for example).I\'m investigating this.  Started to code a fix.Created attachment 255016\nPatch that implements __lookup[SG]etter__\n\nRan this against test suites with no new failures and fixed one test case (js1_5/GetSet/getset-006.js)Fixed:\n\nChecking in NativeObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeObject.java,v  <--  NativeObject.java\nnew revision: 1.44; previous revision: 1.43\ndone\nChecking in ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.118; previous revision: 1.117\ndone\n\nBTW, the test for this is js1_5/extensions/getset-006.js. Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
368455,'Implement \"get\" and \"set\" getter/setter forms in object initializers in Rhino',Rhino,Core,inonit,norrisboyd,'SpiderMonkey allows the definition of getter and setter functions in an object initializer.  See, e.g., http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Guide:Creating_New_Objects:Defining_Getters_and_Setters\n\nRhino would gain compatibility by adding this feature as well.  On the other hand, it would require modifying Rhino\'s parser, which has been described recently (and not-so-recently) as a frightening proposition.Created attachment 254086\nPatch to add get/set syntax to object literals.Apologize for not getting to this yet.  It\'s in the queue and I want to be careful with it, given that the last patch I committed (bug 224334) turned out to have some issues ...Created attachment 254858\nRevised patch with compile path supported and a decompiler bug fixed.Created attachment 254870\nAdded my name to contributors\n\nI keep forgetting to add myself to the source files.(In reply to comment #3)\n> Created an attachment (id=254858) [details]\n> Revised patch with compile path supported and a decompiler bug fixed.\n> \n\nAlmost good - you must keep the ScriptRuntime.newObjectLiteral() method with the old signature as well for backward compatibility. Developers can compile scripts to .class files offline with \"jsc\" command line utility, and we strive to preserve binary compatibility of the ScriptRuntime\'s public API, so scripts compiled to .class files with earlier Rhino continue working with a later version. Of course, you can have the old signature version delegate to new signature version, and you can mark the old signature version deprecated.Created attachment 254965\nAdded compat version of NativeFunction.newObjectLiteral\n\nAdded a backward compatible version of NativeFunction.newObjectLiteral based on a comment from Attila that got attached to bug 369525,Created attachment 254966\nAdded deprecated\n\nI keep forgetting details...Fixed in cvs:\n\nChecking in Decompiler.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Decompiler.java,v  <--  Decompiler.java\nnew revision: 1.22; previous revision: 1.21\ndone\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.319; previous revision: 1.318\ndone\nChecking in Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.109; previous revision: 1.108\ndone\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <-- ScriptRuntime.java\nnew revision: 1.258; previous revision: 1.257\ndone\nChecking in Token.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Token.java,v  <--  Token.java\nnew revision: 1.37; previous revision: 1.36\ndone\nChecking in optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.244; previous revision: 1.243\ndone\n\nOnly change from Bob\'s patch was to remove the @Deprecated annotation since\nwe haven\'t been requiring JDK 1.5 to compile.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
369342,'LazilyLoadedCtor uses Undefined.instance as default value instead of Scriptable.NOT_FOUND',Rhino,Core,hannesw,inonit,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1.1) Gecko/20060601 Firefox/2.0.0.1 (Ubuntu-edgy)\nBuild Identifier: \n\nThis bug slipped in with the patch for bug #224334. When LazilyLoadedCtor fails to build the constructor for some reason (for example when the XML constructor can\'t be created because xbean.jar is not in the classpath), it returns Undefined.instance instead of Scriptable.NOT_FOUND.\n\nOne place where this causes trouble is in ScriptableOutputStream constructor, which expects standard object names to return either NOT_FOUND, or an instance of Scriptable.\n\njava.lang.IllegalArgumentException: Object for excluded name XML is not a Scriptable, it is org.mozilla.javascript.Undefined\n        at org.mozilla.javascript.serialize.ScriptableOutputStream.addOptionalExcludedName(ScriptableOutputStream.java:101)\n        at org.mozilla.javascript.serialize.ScriptableOutputStream.excludeStandardObjectNames(ScriptableOutputStream.java:168)\n        at org.mozilla.javascript.serialize.ScriptableOutputStream.<init>(ScriptableOutputStream.java:84)\n\nAs far as I can see, the easy fix for this would be to simply return Scriptable.NOT_FOUND instead of Undefined.instance at the very end of LazilyLoadedCtor.buildValue().\n\nReproducible: AlwaysI believe I agree.  Attila and I are appalled that the fix for bug 224334 swallows all those exceptions, too, and I told him I\'d patch it.  Thanks for picking this up and I\'ll try to get a fix on the trunk ASAP.Created attachment 267479\nSuggested patch?\n\nHannes, is this basically the change you\'re proposing? I also changed another \nUndefined.instance to Scriptable.NOT_FOUND for the exception case.Yes, that\'s exactly the patch I have in my local copy. Sorry for not posting it.Committed patch:\n\nChecking in LazilyLoadedCtor.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/LazilyLoadedCtor.java,v  <--  LazilyLoadedCtor.java\nnew revision: 1.24; previous revision: 1.23\ndone\n',?,CLEANUP
369536,'Assignment to XML property removes attributes',Rhino,E4X,inonit,nobody,'Not sure what all the cases are, but the following test fails:\n\nvar x = <foo><bar id=\"1\">bazOne</bar><bar id=\"2\">bazTwo</bar></foo>;\nTEST_XML(1, \"<bar id=\\\"2\\\">bazTwo</bar>\", x.bar[1]);\nx.bar[1] = \"bazTwoChanged\";\nTEST_XML(2, \"<bar id=\\\"2\\\">bazTwoChanged</bar>\", x.bar[1]);\n\n... with output:\n\nFAILED!: Section 2 of test -\nFAILED!: Expected value:\nFAILED!: <bar id=\"2\">bazTwoChanged</bar>\nFAILED!: Actual value:\nFAILED!: <bar>bazTwoChanged</bar>\n\nThis bug exists in both the new DOM and old XMLBeans implementations of E4X.What\'s the name of the testcase? You might be able to infer the relevant part of the E4X spec from it.I handwrote the test above. :)  It was based on a bit of XML processing I was doing here that generated unexpected results.  It seems instinctively to me that the attributes should not disappear.  I think the relevant sections of the E4X spec are the [[Put]] internal methods of XML and XMLList.  I traced through their logic in ECMA357 and was able to convince myself (after several iterations) that the test above is correct and the bug is valid.\n\nWhat I meant by \"all the cases\" is I\'m not sure what parts of the above test are essential to generate the failure.  Does bar have to be a child element?  Does bar have to be accessed by index?  Does the index have to be non-zero?  Etc.  Don\'t know what portion of the E4X code is implicated, though I am guessing it is something that wasn\'t rewritten from XMLBeans to DOM or it wouldn\'t fail on both ...Created attachment 254344\nproposed testcase\n\nTestcase for exercising this bug.  Should I include license boilerplate in these?Committed the fix.(In reply to comment #3)\n> \n> Should I include license boilerplate in these?\n\nyes, please.\n\nCreated attachment 254411\ntest with licenseditto lack of tri-license on the test. Gerv?Created attachment 256640\nFixed license and filenameComment on attachment 256640\nFixed license and filename\n\napproved with modeline nit:\n\n/cvsroot/mozilla/js/tests/e4x/Regress/regress-369536.js,v  <--  regress-369536.jsAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
369860,'RegExp: non capturing group doesn\'t working correctly (?:xxx)',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.1) Gecko/20061204 Firefox/2.0.0.1\nBuild Identifier: 1.6R5\n\nRhino RegExp doesn\'t behave correctly (at least not like RegExp in Firefox or in Java). It seems that not capturing group is not interpreted correctly.\n\nReproducible: Always\n\nSteps to Reproduce:\nvar re = new RegExp(\"(?:<script.*?>)(.*)<\\/script>\")\nvar t = \'foo <script>boo();</script>bar\'\nvar r = re.exec(t)\nif (r[1] != \"boo();\")\n\tthrow \"Bad result: \" + r[1]\nelse\n\tprintln(\"ok\")\n\n\n\n\nSadly the RegExp is too tighly binded to String what makes impossible to just define own version of RegExp based on Java 1.4 regexAnother example from Rhino 1.7:\n\nvar str = \"<xy\";\nvar matches = str.match(/(?:<<)xy/);\nprint(matches.join(\", \"));\n\nmatches should be null but is actually [\"<xy\"].\n\nMake the group a capturing group and things work as expected.\n\nvar str = \"<xy\";\nvar matches = str.match(/(<<)xy/);\nprint(matches.join(\", \"));My patch in pull request #19 ( https://github.com/mozilla/rhino/pull/19 ) will fix this bug.I merged Masami\'s pull request.*** Bug 448443 has been marked as a duplicate of this bug. ****** Bug 543663 has been marked as a duplicate of this bug. ***',?,BUG
370400,'Rhino should support const keyword',Rhino,Core,bjervis,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.7) Gecko/20060926 Ubuntu/breezy-security Firefox/1.5.0.7\nBuild Identifier: Rhino 1.6R5\n\nAnother JS 1.5 feature that RHino needs.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Start Rhino shell\n2. enter \'const foo = 5;\'\n3.\nActual Results:  \nParse error.\n\nExpected Results:  \nShould work and protect foo from assignment.I\'m working on a fix for this.Created attachment 255242\nThis is a PARTIAL patch to this bug.\n\nI will lay odds that this patch will crash if opt level is > -1.  Do not integrate this patch.  I just want comments on the semantics and the changes in interfaces.FYI, bug 229756 reports the lack of write-once semantics in SpiderMonkey\'s const.\n\n/beCreated attachment 256211\nThis is a full patch\n\nThis completes the implementation of const.  There are a couple of validation tests that were failing always before (because they used const in them).  These tests (js1_5/String/regress-354541-02.js and js1_5/String/regress-354541-04.js) now fail only on -opt -1 but pass on opt >= 0.  Modifying the source to use \'var\' instead of const exhibits the same behavior even without my changes.  I therefore conclude that these failures are unrelated to my changes.Created attachment 256706\nConstProperties.java\n\nThe diff stuff didn\'t includes this new file (it goes in src/org/mozilla/javascript).  Sorry I missed this earlier.Bob, please see comment 4.\n\n/beThe referenced tests are now in js1_5/extensions/ due to the use of Script. Does Rhino even support Script? Brendan, I can change the use of const in the tests to var if that would fix the problem.Changing const to var does not change the test outcome (I tried that to isolate the cause).  Rhino does support Script, but these tests only work correctly on the compiled-thru-Java cde path.  The stand-alone interpreter gets theanswer wrong.  I traced the interpreted code path thru to the Script constructor and it appeared that it used the global scope as it\'s scope, and not the local scope of the caller (which is what the tests assume).\n\nI just confirmed a bug in the existing patches.  For compiled code path, assigning to const declared variables at function scope does not seem to work.  The compile itself will crash in org.mozilla.javascript.optimizer.BodyCodegen.generateExpression with an Unexpected node type 151 error.  I\'m working on an updated patch that fixes this case.Created attachment 259915\nUpdated const patch that fixes problems with const in functions.\n\nThis patch fixes the previously noted bug in the original patches.Checked in patch:\n\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ConstProperties.java,v\ndone\nChecking in ConstProperties.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ConstProperties.java,v  <--  ConstProperties.java\ninitial revision: 1.1\ndone\nChecking in Decompiler.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Decompiler.java,v  <--  Decompiler.java\nnew revision: 1.23; previous revision: 1.22\ndone\nChecking in IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.103; previous revision: 1.102\ndone\nChecking in InterpretedFunction.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/InterpretedFunction.java,v  <--  InterpretedFunction.java\nnew revision: 1.54; previous revision: 1.53\ndone\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.320; previous revision: 1.319\ndone\nChecking in InterpreterData.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/InterpreterData.java,v  <--  InterpreterData.java\nnew revision: 1.55; previous revision: 1.54\ndone\nChecking in NativeCall.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeCall.java,v  <--  NativeCall.java\nnew revision: 1.35; previous revision: 1.34\ndone\nChecking in NativeFunction.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeFunction.java,v  <--  NativeFunction.java\nnew revision: 1.64; previous revision: 1.63\ndone\nChecking in NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.69; previous revision: 1.68\ndone\nChecking in Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.110; previous revision: 1.109\ndone\nChecking in ScriptOrFnNode.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptOrFnNode.java,v  <--  ScriptOrFnNode.java\nnew revision: 1.20; previous revision: 1.19\ndone\nChecking in ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <-- ScriptRuntime.java\nnew revision: 1.259; previous revision: 1.258\ndone\nChecking in ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.119; previous revision: 1.118\ndone\nChecking in Token.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Token.java,v  <--  Token.java\nnew revision: 1.38; previous revision: 1.37\ndone\nChecking in TokenStream.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/TokenStream.java,v  <--  TokenStream.java\nnew revision: 1.66; previous revision: 1.65\ndone\nChecking in optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.245; previous revision: 1.244\ndone\nChecking in optimizer/OptFunctionNode.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/OptFunctionNode.java,v  <--  OptFunctionNode.java\nnew revision: 1.33; previous revision: 1.32\ndone\nChecking in resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.68; previous revision: 1.67\ndone\nAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,RFE
373897,'JavaAdapter classes cannot access protected methods in superclass',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1.2) Gecko/20060601 Firefox/2.0.0.2 (Ubuntu-edgy)\nBuild Identifier: \n\nJavaAdapters currently cannot access protected methods declared in their superclasses. Since accessing and overriding protected methods is one key benefit of creating subclasses via JavaAdapters, I think this is something we should get right. \n\nThe problem is that NativeJavaClass only knows about public methods. I guess this is correct for most cases when the class is used from the \"outside\", so the right way to fix it may be to perform/trigger protected method lookup only from the JavaAdapter class.\n\nReproducible: AlwaysOops, the problem has nothing to do with NativeJavaClass, since JavaAdapter uses the superclass\'s java.lang.Class instance directly (in JavaAdapter.createAdapterCode()). However, it uses getMethods(), which only returns public methods, so the effect is the same. Created attachment 258676\nTest script for protected java method access\n\nThis script tests access to protected java.util.Hashtable.rehash() method both from a JavaAdapter extending Hashtable, and on a plain Hashtable instance from the outside.Created attachment 258677\nPatch to allow access to protected methods in JavaAdapter superclasses\n\nThis patch makes protected methods in JavaAdapter superclasses callable to and overridable by JavaScript code.\n\nThe overriding part is easy, basically I just implemented a JavaAdapter.getOverridableMethods() method that includes protected methods to the list of potentially overridden methods.\n\nThe invokability part is harder, because we can\'t tell if the JS code trying to invoke a protected method belongs to the JavaAdapter or not (or at least I wouldn\'t know how to do that, and I think it would be overkill). My solution is to pass a boolean isAdapter argument to the NativeJavaObject constructor that will result in protected methods being exposed to JS in addition to just public ones. Thus, protected methods in JavaAdapter superclasses will be generally available to JS code. To me this seems acceptable. \n\nAdding the isAdapter flag to NativeJavaObject also allowed me to clean up the serialization code, although I haven\'t tested the new code yet.Hello,\n\nI\'ve run into this issue, apart from the JavaAdapter use case. In my case, I want to place the \'this\' object on the scope, and call a protected superclass method from a script. For example:\n\nContext context = Context.enter();\nScriptable scope = new ImporterTopLevel(context);\nscope.put(\"test\", scope, this);\n...\nScript script = context.compileString(scriptString, \"PreprocessScript \", 161, null);\nscript.exec(context, scope);\n\nHere \'scriptString\' defines a js function that includes a call to \'this\': \n\ntest.someProtectedSuperclassMethod();\n\nWhen I run this code, even after applying the above patch, the protected method can\'t be found (because my call stack quite appropriately constructs a NativeJavaObject with \'isAdapter\' = false). Simply changing the WrapFactory.wrapAsJavaObject() method to pass isAdapter as \'true\' works fine, but is clearly not appropriate for the general case.\n\nI\'d like to propose that the concept of \'isAdapter\' not be conflated with the concept of \'exposePrivateSuperclassMethods\". I think what\'s called for in my use case is some way to either evaluate a script (or exec a compiled script) with the *option* of wrapping my Native Objects such that I can get at the protected members - else some way of placing my java objects on the scope with a hint as to how to wrap them later on when the time comes.\n\nThanks.Committed patch:\n\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\nnew revision: 1.105.2.1; previous revision: 1.105\ndone\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\nnew revision: 1.62.2.1; previous revision: 1.62\ndone\nChecking in src/org/mozilla/javascript/NativeJavaClass.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaClass.java,v  <--  NativeJavaClass.java\nnew revision: 1.48.2.1; previous revision: 1.48\ndone\nChecking in src/org/mozilla/javascript/NativeJavaObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaObject.java,v  <--  NativeJavaObject.java\nnew revision: 1.78.2.1; previous revision: 1.78\ndone\n',?,DESIGN_DEFECT
374918,'String primitive prototype wrongly resolved when used with many top scopes',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.2) Gecko/20060601 Firefox/2.0.0.2 (Ubuntu-edgy)\nBuild Identifier: \n\nthe protoype of a string primitive is always resolved to the one in the context\'s top call scope rather than to the one in the executing code\'s top scope.\n\nThe provided unit test illustrates the problem.\n\nI suppose that ScriptRuntime.toObjectOrNull shouldn\'t use getTopCallScope(cx) but look at cx.lastInterpreterFrame.scope. The change can\'t be done directly as CallFrame is a private class of Interpreter.\nIf it\'s ok to make changes like removing the private modifier of CallFrame I can look at providing a patch.\n\nReproducible: Always\n\nSteps to Reproduce:\npublic void testStringPrimitivePrototypeScope()\n{\n\tContext cx = Context.enter();\n\tScriptable scope1 = cx.initStandardObjects();\n\tScriptable scope2 = cx.initStandardObjects();\n\tString str2 = \"function f() { String.prototype.foo = \'from 2\'; \\n\"\n\t\t+ \"var s1 = new String(\'s1\');\\n\"\n\t\t+ \"if (s1.foo != \'from 2\') throw \'s1 got: \' + s1.foo;\\n\" // works\n\t\t+ \"var s2 = \'s2\';\\n\"\n\t\t+ \"if (s2.foo != \'from 2\') throw \'s2 got: \' + s2.foo;\\n\" // fails\n\t\t+ \"}\";\n\tcx.evaluateString(scope2, str2, \"source2\", 1, null);\n\t\n\tscope1.put(\"scope2\", scope1, scope2);\n\t\n\tString str1 = \"String.prototype.foo = \'from 1\'; scope2.f()\";\n\tcx.evaluateString(scope1, str1, \"source1\", 1, null);\n\t\n\tContext.exit();\n}Yep, it seems right -- ScriptRuntime.toObjectOrNull() should have a \"Scriptable scope\" parameter that it passes to ScriptRuntime.toObject() instead of defaulting to getTopCallScope(cx). Problem is, ScriptRuntime.toObjectOrNull() is called from no less than 18 locations, so reviewing the possible side-effects of the fix will take a while. Will ask Norris if he can comment on it...Sorry to take a while to respond.\n\nI dug up the original change that introduced the topCallScope changes:\n\n--------\ndate: 2004/08/09 11:00:46;  author: igor\%mir2.org;  state: Exp;  lines: +1 -4\nTop call scope tracking changes:\n\nSince E4X implementation needs to know the activation scope for tracking of default namespaces, previously an elaborated schema was added to set/restore the activation scope which relied on the fact that scrip and function with activation record should always call special entry/exit functions.\n\nBut that does not work for functions without activation records since they never call any special entry/exit pairs. So if application call such function directly, the function would not store its top scope anywhere and the E4X subsystem would not be able to get E4X library object.\n\nThe patch fixes with introduction of 2 functions, hasTopCall and doTopCall to ScriptRuntime and adding the following code prefix to each implementation of Callable.call that can start execution of script code:\n\n    public Object call(Context cx, Scriptable scope,\n                       Scriptable thisObj, Object[] args)\n        throws JavaScriptException\n    {\n// Prefix start\n        if (!ScriptRuntime.hasTopCall(cx)) {\n            return ScriptRuntime.doTopCall(this, cx, scope, thisObj, args);\n        }\n// Prefix end\n        ...\n\nIn this way there is always registered top scope during script execution and the previous elaborated schema became unnecessary so I reverted that part to almost pre-E4x state.\n----------\n\nThis change log brings up the question of whether changing ScriptRuntime.toObjectOrNull would break some of the E4X implementation. Frankly I don\'t know much about E4X so I can\'t comment. \n\nThe problem with the proposed change of using cx.lastInterpreterFrame.scope is\nthat it doesn\'t work for compiled mode. It\'s not clear, Attila, if you were intending to use lastInterpreterFrame or not. \n\nI frankly didn\'t intend for two sets of scopes initialized with initStandardObjects to ever be mixed in the same JS object graph. It\'s certainly non-ECMA since those objects are defined to be global by ECMA. What\'s the use case? (In reply to comment #2)\n> The problem with the proposed change of using cx.lastInterpreterFrame.scope is\n> that it doesn\'t work for compiled mode. It\'s not clear, Attila, if you were\n> intending to use lastInterpreterFrame or not. \n\nNo - that\'s what the submitter of the bug proposed, but since that wouldn\'t work in compiled code I specifically intended to change the signature of toObjectOrNull() so it works uniformly regardless of execution mode.\n\n> \n> I frankly didn\'t intend for two sets of scopes initialized with\n> initStandardObjects to ever be mixed in the same JS object graph. It\'s\n> certainly non-ECMA since those objects are defined to be global by ECMA. What\'s\n> the use case? \n> \n\nNot sure. You\'re right in saying this is quite unintended use of the API, so we might want to avoid jumping the gun. Marc, can you provide us with a real-world use case for this?\nIn HtmlUnit we simulate the browser(s) behaviour and in this case you have one scope per (html) page but one page can be accessed from an other one (for instance frames).\nThe provided unit case illustrates such a problem we had making the JavaScript generated by Google WebToolkit working with HtmlUnit.This seems like an important case.\n\nAttila\'s approach should work, but it does look like a lot of plumbing to get\nall the scope values passed around appropriately. \n\nLooking at the E4X default namespace implementation, I see ScriptRuntime.setDefaultNamespace and searchDefaultNamespace. From reading this code I think the problem of multiple top-level scopes would affect this code as well.Just out of curiosity, anyone has any idea how does this work in browsers with cross-page scripting within a frame? I.e. Mark, how would typical browsers (I always have to smile at this, since I\'m using a *very* nontypical one - Opera on Mac OS X :-) ) run a browser-adapted version of your above testcase?You mean how they handle the scopes? No idea but this is a current practice for js frameworks to play with these multiple scopes (even in Opera).\n\nWith multiple scopes I have an other issue with eval that I will first bring to the mailing list.I took another look at this. I don\'t see any way to fix this short of redoing a lot of deep plumbing that also has impacts on E4X stuff I don\'t understand well. \n\nI think we should punt on this for the soon-to-be-released Rhino 1.6R6 and look at it again when we have more time to shake out bugs.Does the time come where you have \"more time to shake out bugs\"? ;-)Created attachment 300079\njs1_7/regress/regress-414553.js\n\nProposed regression testComment on attachment 300079\njs1_7/regress/regress-414553.js\n\nAttached to wrong bug, sorry.FYI, this appears to apply to Number.prototype, as well.Any progress on this issue? It seems that our workaround (a hack) doesn\'t work anymore with current Rhino from CVS, meaning that we\'ll have problem to benefit from the progress made in Rhino.Created attachment 338310\nPatch fixinig this bug in primitive prototype resolution\n\nThis patch fixes this bug and contains unit tests demonstrating it both in compiled and interpreted modes.\nI guess that other places than the ones fixed should make usage of the new methods to get object properties that correctly resolve primitive prototypes, but I\'m not able to judge it.\nThe test suite junit-all causes a lot of error when I run it (with or without this patch), therefore I can\'t get any information from it.Can a Rhino committer apply this patch (if it considered as good) or post a comment (if there is a problem with it)?In fact the problem is more important than I found initially and my patch fixes only one case.\n\nFollowing example shows the problem:\n        final Context cx = ContextFactory.getGlobal().enterContext();\n        final Scriptable scope1 = cx.initStandardObjects();\n        final Scriptable scope2 = cx.initStandardObjects();\n\n        String scriptScope1 = \"String.prototype.foo = function() { return \'from 2\'; }\\n\"\n            + \"var s2 = \'s2\';\\n\";\n\n        String scriptScope2 = \"var s2Foo = scope2.s2.foo();\\n\"\n            + \"if (s2Foo != \'from 2\') throw \'s2 got: \' + s2Foo;\\n\"; // fails\n\n        cx.evaluateString(scope2, scriptScope2, \"source2\", 1, null);\n\n        scope1.put(\"scope2\", scope1, scope2);\n\n        cx.evaluateString(scope1, scriptScope1, \"source1\", 1, null);\n\n        Context.exit();\n\nThe JS code fails because no function foo can be found in s2. My previous patch doesn\'t help here because the current scope when the function is called is still scope1.\n\nThis means that a String (or any primitive) can\'t be saved in a Slot just as java.lang.String but must be wrapped to save the (top?) scope of its creation.\n\nI can work on a patch for that, but I\'d like first feedback from some Rhino committer.Created attachment 347600\nJava test class\n\nAttaching a simplified version of your test code. As I expected, String and number prototypes are consistent across scopes when wrapped in JS objects via String() and Number constructors. So I guess a viable strategy for implementing cross-scope safety would be to introduce a mode where primitives are always wrapped in objects.Primitive aren\'t objects and therefore wrapping them in JS objects would introduce a lot of failures.\n\nYour test (in fact it\'s not a unit test) doesn\'t test exactly the same thing and only test for the default optimization level.\n\nIn fact the number of cases to handle is far higher than illustrated by this test: primitive have to be wrapped as well before to get assigned to a property, before to be transmitted as arg to a function, when returned by a function, in array constructor, in object constructor, ...\n\nI\'ll  attach the test cases with which I\'m working.Created attachment 347736\nSet of unit tests illustrating different cases that need to be handle\n\nThe attached tests cover different cases where the scope need to be saved together with the primitive value.\n\nThe last 3 tests pass with current code base and are just here to ensure that modification to primitives don\'t break basic funtionalities.\n\nNote that it is important to consider special numbers 0 and 1 as they are handled differently than other values.Comment on attachment 338310\nPatch fixinig this bug in primitive prototype resolution\n\nobsolete because incomplete as explained in a previous commentDoes everyone still agree that my original idea of modifying ScriptRuntime.toObjectOrNull signature to take a \"Scriptable topLevelScope\" argument, and then propagating the change through the code is the way to go?I don\'t agree. This was what I\'ve done in a first time but this is not enough: you need to know which scope has to be taken and this is not necessarily the current one. To be more precise, it is not possible to know which scope it is if it hasn\'t be saved together with the primitive. Just think of a primitive that is placed as property of some object (or of the top scope) and that is used later but accessed from an other scope.\nThe attached tests handle this case too.Comment on attachment 347736\nSet of unit tests illustrating different cases that need to be handle\n\nOOPS, these requirements go far beyond what browsers do. Sorry. Marking as obsolete. More later.Adding a ScriptRuntime.toObjectOrNull signature with a scope argument might be a good idea for itself for those cases where a scope is already available, which is the case in a few usages of that method, even if it doesn\'t fix this problem. \n\nAs for this bug, as Marc said it looks like we need to store the prototype reference (I think it\'s the prototype and not actually the scope that matters) with primitive values. It\'s rather obvious to me that the best way to do this is to always store numbers, strings and booleans using Rhino\'s NativeNumber, NativeString, and NativeBoolean wrapper classes. Primitives are converted to objects a lot anyway (each time you invoke a method on a string, for example), so primitives and their object counterparts really look and behave more like the same thing anyway. (I remember there was a time when primitives weren\'t converted to objects automatically when calling a method on them - can anybody remember what language version that was and if it still matters?)\n\nAs for the differences between primitives and object wrappers, the best way to handle this would probably be to use subclasses for one or the other, so the (JS) typeof or instanceof operators could look for that using a simple (Java) instanceof. Any other difference between primitives and object wrappers that we\'d need to take care of?\n\nSince I guess storing prototype/parent scope info with each primitive would likely result in decreased performance and increased memory usage and most embeddings would not need it, I think it might be wise to implement this as Context feature which is disabled by default, but we can look at that when we have a working patch. It\'s also possible the spared conversion between primitives and object wrappers helps performance in real world scenarios.\n\nWhat do you think?(In reply to comment #24)\n> Adding a ScriptRuntime.toObjectOrNull signature with a scope argument might be\n> a good idea for itself for those cases where a scope is already available,\n> which is the case in a few usages of that method, even if it doesn\'t fix this\n> problem.\n\nRight.\n\n> As for this bug, as Marc said it looks like we need to store the prototype\n> reference (I think it\'s the prototype and not actually the scope that matters)\n> with primitive values. It\'s rather obvious to me that the best way to do this\n> is to always store numbers, strings and booleans using Rhino\'s NativeNumber,\n> NativeString, and NativeBoolean wrapper classes. Primitives are converted to\n> objects a lot anyway (each time you invoke a method on a string, for example),\n> so primitives and their object counterparts really look and behave more like\n> the same thing anyway. \n\nThey don\'t. Consider these examples:\n\nif(false) { ... }\nif(new Boolean(false)) { ... }\n\nif(\"\") { ... }\nif(new String(\"\")) { ... }\n\nif(0) { ... }\nif(new Number(0)) { ... }\n\n> Since I guess storing prototype/parent scope info with each primitive would\n> likely result in decreased performance and increased memory usage and most\n> embeddings would not need it, I think it might be wise to implement this as\n> Context feature which is disabled by default, but we can look at that when we\n> have a working patch. It\'s also possible the spared conversion between\n> primitives and object wrappers helps performance in real world scenarios.\n> \n> What do you think?\n\nI\'m getting to a point where I\'m feeling anxious about this whole thing. As an ol\' rule of thumb, if the architectural complexity starts to look too hairy, that\'s usually a good indication we\'re heading in the wrong direction. And it starts to look hairy to me. \n\nMarc originally said the problem is that \"the protoype of a string primitive is always resolved to the one in the context\'s top call scope rather than to the one in the executing code\'s top scope.\" From my understanding of that problem statement, if the \"top scope of the executing code\" were always passed to the toObjectOrNull, instead of relying on a thread local (current context\'s current top level scope), that\'d solve the problem by breaking the assumption that any scope that\'s active within a Context ultimately has getCurrentContext().getTopLevelScope() as its ancestor.\n\nThat\'s not the same as tracking the \"prototype of the primitive\". Note that this concept is actually not even well defined. A better defined one would be \"prototype of the corresponding object type for a primitive as per active scope at the point of the primitive creation\".\n\nWhich promptly raises another question: when is a primitive created?\nWhen is boolean literal true, or number 42 created? Does evaluation of an expression, i.e. (i == 42) result in a new instance of true/false being created, or does it return an intrinsic true/false value? The problem is that not every occurrence of a primitive value is a separate instance. You can\'t even really talk about primitive values being instances.\n\nFinally, The semantics of sharing objects between Contexts that use different global standard object instances is totally out of the ECMA spec, and if allowed, is completely implementation dependent. From point of view of the spec, these are two different programs. Therefore, if we want to embrace this, we need to make sure that we get it right and don\'t shoot ourselves in the foot (or make it easy for other people to do so).\n\nHonestly, I\'m still fairly anxious about breaking the invarant stating that \"any scope that\'s active within a Context ultimately has getCurrentContext().getTopLevelScope() as its ancestor\". \n\nOn the mailing list, I suggested Marc to try a different solution using a shared scope for the frameset HTML, with all standard objects in it, and use separate scopes for individual frames, with each frame-scope setting the shared scope as its prototype. I believe that\'d make his use case work, and we wouldn\'t need to change anything.Created attachment 347763\nPatch fixing primitive prototype problem as currently occuring in HtmlUnit\n\nHere is the smallest patch that:\n- illustrates 2 cases where Rhino behaviour is wrong\n- fixes these 2 cases passing a scope parameter to a new ScriptRuntime.toObjectOrNull method\n\nI haven\'t changed the methods calling ScriptRuntime.toObjectOrNull without scope parameter when my unit test doesn\'t show the need for it. This makes this patch smaller and should increase the chance that it gets applied quickly.I\'ve followed a wrong way for a far too long time (in fact this bug is really too old). I apologize for the time you\'ve lost trying to understand my incorrect requirements. I don\'t know at which point I\'ve made a wrong test in my browser that gave me an incorrect understanding of the situation, but the fact is that the situation is far easier to handle than I feared (see comment#26).\n\nAttila was mostly right (not concerning frames and shared scope but this is an other point that I will answer on the mailing list): NO information about the \"origin\" scope needs to be saved, only the current top scope matters (which means that for the same variable x, x.foo may evaluate to different values depending on the scope where the call is performed).Last note: reworking the code base to use PrimitiveXxxx to store primitives (what is not needed, see previous comment), I had to perform different refactorings of Rhino code base. If there is interest for it, I can extract 2 patches that:\n- use a \"Stack\" object to hide the Object[] and double[] in Interpreter.java\n- add methods isPrimitiveXxxx() in ScriptRuntime and use them instead of direct instanceof tests\nI think that these changes make the code more readable, easier to debug and the first one can make work on \"death by double\" easier. Let me know if you would welcome such changes.I\'ve patched in the patch from #26. It seems like a fine change to make. I tweaked one part of the change to reduce copied code. The resulting change \npasses the regression tests. I\'m fine with accepting this change; any objections from others?Fine with me. One place that should also call the new ScriptRuntime.toObjectOrNull with scope argument is in FunctionObject.java at line 238. That code just changed to ignore the local scope variable in the fix to bug 461138 a few days ago.(In reply to comment #30)\n> Fine with me. One place that should also call the new\n> ScriptRuntime.toObjectOrNull with scope argument is in FunctionObject.java at\n> line 238. That code just changed to ignore the local scope variable in the fix\n> to bug 461138 a few days ago.\n\nThanks, I made that change and reran the unit test for bug 461138 to ensure that  the fix didn\'t regress that issue.(In reply to comment #30)\n> Fine with me. One place that should also call the new\n> ScriptRuntime.toObjectOrNull with scope argument is in FunctionObject.java at\n> line 238. That code just changed to ignore the local scope variable in the fix\n> to bug 461138 a few days ago.\n\nHannes,\n\ncan you provide a unit test that shows the need for it? I thought too in a first time that changes needed to be made at many other places but as long as this need it not demonstrated by unit tests, I believe that it is better not to change it.(In reply to comment #32)\n> (In reply to comment #30)\n> > Fine with me. One place that should also call the new\n> > ScriptRuntime.toObjectOrNull with scope argument is in FunctionObject.java at\n> > line 238. That code just changed to ignore the local scope variable in the fix\n> > to bug 461138 a few days ago.\n> \n> Hannes,\n> \n> can you provide a unit test that shows the need for it? I thought too in a\n> first time that changes needed to be made at many other places but as long as\n> this need it not demonstrated by unit tests, I believe that it is better not to\n> change it.\n\nNope, but using the new toObjectOrNull() signature just reestablishes the state before the fix for bug 461138 - calling toObject() with the available scope object as argument. So I think your argument works in the other direction - unless we have real evidence, we should go back to the behaviour we had for the past several years.The change is indeed needed, but invoking that it is the case because this is the behaviour that we had for the past several years is... hmm, not very constructive.\n\nThis is a very special case where a FunctionObject takes a Scriptable as parameter, gets invoked with a primitive and wants to look at properties of the prototype. No idea if this ever gets used.\n\nNo matter, this should be tested and fixed. Here is the test case showing the need for this:\n\n\tpublic static class MyObject extends ScriptableObject {\n        @Override\n\t\tpublic String getClassName()\n\t\t{\n\t\t\treturn \"MyObject\";\n\t\t}\n\t\t\n\t\tpublic Object readPropFoo(final Scriptable s) {\n\t\t\treturn ScriptableObject.getProperty(s, \"foo\");\n\t\t}\n\t}\n\n\t/**\n     * Test that FunctionObject use the right top scope to convert a primitive to an object\n     */\n    @Test\n    public void functionObjectPrimitiveToObject() throws Exception {\n    \tfinal String scriptScope2 = \"function f() { String.prototype.foo = \'from 2\'; \\n\"\n            + \"var s2 = \'s2\';\\n\"\n            + \"var s2Foo = s2.foo;\\n\"\n            + \"var s2FooReadByFunction = myObject.readPropFoo(s2);\\n\"\n            + \"if (s2Foo != s2FooReadByFunction) throw \'s2 got: \' + s2FooReadByFunction;\\n\"\n            + \"}\";\n\n        // define object with custom method\n        final MyObject myObject = new MyObject();\n        final String[] functionNames = { \"readPropFoo\" };\n        myObject.defineFunctionProperties(functionNames, MyObject.class, ScriptableObject.EMPTY);\n\n        final String scriptScope1 = \"String.prototype.foo = \'from 1\'; scope2.f()\";\n        \n    \tfinal ContextAction action = new ContextAction()\n    \t{\n    \t\tpublic Object run(final Context cx)\n    \t\t{\n    \t        final Scriptable scope1 = cx.initStandardObjects(new MySimpleScriptableObject(\"scope1\"));\n    \t        final Scriptable scope2 = cx.initStandardObjects(new MySimpleScriptableObject(\"scope2\"));\n\n    \t        scope2.put(\"myObject\", scope2, myObject);\n    \t        cx.evaluateString(scope2, scriptScope2, \"source2\", 1, null);\n\n    \t        scope1.put(\"scope2\", scope1, scope2);\n\n    \t        return cx.evaluateString(scope1, scriptScope1, \"source1\", 1, null);\n    \t\t}\n    \t};\n    \tUtils.runWithAllOptimizationLevels(action);\n    }Well, if your test backs my assumption i guess it\'s all the better. Thanks Marc!Thanks, I added the extra unit test code and have submitted the change to the branch and CVS head.Cool!\n\n@Norris:\n- in comment #39 you write that \"The resulting change passes the regression tests\". How do you run the tests? For me there are still a large number of failing standard tests and this makes very difficult to know whether changes introduce regression or not. The build servers seems to have the same results as I have.\n\n- answers to comment #28?(In reply to comment #37)\n> Cool!\n> \n> @Norris:\n> - in comment #39 you write that \"The resulting change passes the regression\n> tests\". How do you run the tests? For me there are still a large number of\n> failing standard tests and this makes very difficult to know whether changes\n> introduce regression or not. The build servers seems to have the same results\n> as I have.\n\nFirst, everything passes for me off of Rhino1_7R2_BRANCH. There are some failures on CVS HEAD due to problems introduced by the AST API. \n\nI\'m running the tests using the approach in https://developer.mozilla.org/en/Running_the_Rhino_tests, and then running the JUnit tests from Eclipse. \n\nI just checked for new tests in mozilla/js/tests, and there were 16 new tests that fail. I\'ll update the skip list for these. I think you are right when you said in a separate thread that we should move to a list of tests to run rather than a list of tests to skip to avoid this problem.\n\n> \n> - answers to comment #28?\n\n- use a \"Stack\" object to hide the Object[] and double[] in Interpreter.java\n\nI\'m worried that the performance of a stack object will be less than the direct reference to the array objects. \n\n- add methods isPrimitiveXxxx() in ScriptRuntime and use them instead of direct\ninstanceof tests\n\nAgain, worried about performance impacts, although less so than the first. I suppose a good JVM will inline the methods.Norris,\n\nI\'ve tried to run the tests as you do and I didn\'t get any error either. I think that there is a major problem here and I have opened a special issue for that:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=464898\n\nConcerning the performance. I couldn\'t notice any significant difference while running all the tests locally with a version of Rhino that had not only these 2 changes, but that used new classes to save JavaScript primitives. It doesn\'t really surprise me: modern JVM are good enough to optimize execution of such code.\n\nWhat would be for you a sufficient proof that the performance is not impacted?Thanks to Marc and all of the committers for looking into this!!(In reply to comment #39)\n> Norris,\n> \n> I\'ve tried to run the tests as you do and I didn\'t get any error either. I\n> think that there is a major problem here and I have opened a special issue for\n> that:\n> https://bugzilla.mozilla.org/show_bug.cgi?id=464898\n> \n> Concerning the performance. I couldn\'t notice any significant difference while\n> running all the tests locally with a version of Rhino that had not only these 2\n> changes, but that used new classes to save JavaScript primitives. It doesn\'t\n> really surprise me: modern JVM are good enough to optimize execution of such\n> code.\n> \n> What would be for you a sufficient proof that the performance is not impacted?\n\nI\'ve been using the benchmarks from http://ejohn.org/projects/javascript-engine-speeds/ to test performance. If there\'s noticeable change in those, then I think we\'re fine. \n\nNote I\'m normally not so persnickety about things, but the inner loop of the interpreter is a real hotspot, and even just adding code that pushes us over certain codesize limits can make Rhino interpreter 2X slower.(In reply to comment #41)\n> ...\n> I\'ve been using the benchmarks from\n> http://ejohn.org/projects/javascript-engine-speeds/ to test performance. If\n> there\'s noticeable change in those, then I think we\'re fine. \n\nOk, I\'ll try it. Do you know where the whole sources of these tests can be downloaded at once? Many links are now broken.Hmm. You\'re right that these benchmarks don\'t seem to be available anymore. I\'ll mail you a zip file of what I have saved.John Resig is subscribed to the Rhino mailing list -- maybe just ask him where did the tests go?I already mailed him this morning but no answer until now (in fact I think that he is subscribed to the bugzilla issues too).I had just mailed him as well.',?,BUG
375081,'ScriptRuntime.initStandardObjects() throws NullPointerException when no E4X implementation available',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1.2) Gecko/20060601 Firefox/2.0.0.2 (Ubuntu-edgy)\nBuild Identifier: \n\nWhen none of the standard E4X implementations are available (e.g. Java 1.4 without XmlBeans), ScriptRuntime.initStandardObjects() throws a NullPointerException. A simple check for null allows Rhino to run without E4X support.\n\nReproducible: Always\n\nSteps to Reproduce:\n~/j2sdk1.4.2_10/bin/java -jar build/rhino1_6R6pre/js-head.jar \n\nActual Results:  \nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.ScriptRuntime.initStandardObjects(ScriptRuntime.java:184)\n        at org.mozilla.javascript.Context.initStandardObjects(Context.java:1140)\n        at org.mozilla.javascript.ImporterTopLevel.initStandardObjects(ImporterTopLevel.java:107)\n        at org.mozilla.javascript.tools.shell.Global.init(Global.java:108)\n        at org.mozilla.javascript.tools.shell.Global$1.run(Global.java:98)\n        at org.mozilla.javascript.Context.call(Context.java:559)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:496)\n        at org.mozilla.javascript.tools.shell.Global.init(Global.java:95)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:158)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)Created attachment 259409\nAdd a check to prevent NullPointerExceptionSorry, I didn\'t see this one and independently discovered and fixed it.  My patch is slightly different but awfully similar. :)Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
375682,'eval(\'function () { }\') results in undefined',Rhino,Core,norrisboyd,norrisboyd,'Executing \n  eval(\'function () { }\') \nresults in undefined rather than the value of the function. \n\nAdditionally, \n  eval(\"if (1) function() { } else function (a) { };\")\nshould result in the parameterless function rather than undefined.Fixed for interpretive mode only:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.318; previous revision: 1.317\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\nnew revision: 1.67; previous revision: 1.66\ndone\nTested with compiled mode and it already works correctly on both test cases above.\n\nMarking fixed.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
376632,'Documentation needed for a few of the JSC arguments',Rhino,Compiler,robert.flaherty,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.1)\nBuild Identifier: \n\nThe destination directory is really what I\'m using, but I thought I\'d include the others as well.\n\nHelp: -help || -h || --help\nMain: -main-method-class\nDestDir: -d\n\n\nReproducible: AlwaysFixed:\n\nChecking in Messages.properties;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.27.2.1; previous revision: 1.27\ndone\n',?,CLEANUP
376831,'Function.prototype is enumerable, but should not be.',Rhino,Core,lehni,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en) AppleWebKit/419 (KHTML, like Gecko) Safari/419.3\nBuild Identifier: HEAD\n\nFunction.prototype does not have the DONTENUM flag set, but it should. The attached patch contains a fix for this.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nfor (var i in Function)\n    java.lang.System.out.println(i + \": \" + Function[i]);\n\n\nActual Results:  \nprototype: function () {\n    [native code, arity=0]\n}\n\nExpected Results:  \nNot printed anything.Created attachment 260940\nfunction prototype patchCommitted to CVS. Thanks.Actually, the proposed patch also adds DONTENUM to function object prototype properties, which runs counter to the following ECMA rule:\n\n15.3.5.2 prototype\nThe value of the prototype property is used to initialise the internal [[Prototype]] property of a newly created object before the Function object is invoked as a constructor for that newly created object. This property has the attribute { DontDelete }.\n\nI\'ve committed a newer change that gets the right behavior for 15.3.5.2 and 15.3.3.1.\n\nAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
377777,'Don\'t lose precision on a java.lang.Long passed to a long parameter',Rhino,Core,norrisboyd,norrisboyd,'Currently a primitive long works but a java.lang.Long doesn\'t. Here\'s a shell session with debugging on to show overloading behavior:\n\njs> var l = java.lang.Long.parseLong(\"1111111111111111\", 16)\n ----- Found first applicable java.lang.Long.parseLong(java.lang.String,int) for arguments (string,number)\n ----- Calling java.lang.Long.parseLong (java.lang.String,int) for arguments (string,number)\n ----- Returned 1229782938247303441 actual = class java.lang.Long expect = long\n ----- Wrapped as 1229782938247303441 class = class java.lang.Long\njs> var L = new java.lang.Long(l)\n ----- Found first applicable java.lang.Long.(long) for arguments (number)\n ----- Rejecting (all current bests better) java.lang.Long.(java.lang.String) for arguments (number)\njs> java.lang.Long.bitCount (l)\n ----- Found java.lang.Long.bitCount(long) for arguments (number)\n ----- Calling java.lang.Long.bitCount(long) for arguments (number)\n ----- Returned 16 actual = class java.lang.Integer expect = int\n ----- Wrapped as 16 class = class java.lang.Integer\n16\njs> java.lang.Long.bitCount(L)\n ----- Found java.lang.Long.bitCount(long) for arguments (java.lang.Long)\n ----- Calling java.lang.Long.bitCount(long) for arguments (number)\n ----- Returned 14 actual = class java.lang.Integer expect = int\n ----- Wrapped as 14 class = class java.lang.Integer\n14\njs>\n\nHowever, with my proposed change, I get\n\njs> var l = java.lang.Long.parseLong(\"1111111111111111\", 16)\n ----- Found first applicable java.lang.Long.parseLong(java.lang.String,int) for arguments (string,number)\n ----- Calling java.lang.Long.parseLong(java.lang.String,int) for arguments (string,number)\n ----- Returned 1229782938247303441 actual = class java.lang.Long expect = long\n ----- Wrapped as 1229782938247303441 class = class java.lang.Long\njs> var L = new java.lang.Long(l)\n ----- Found first applicable java.lang.Long.(long) for arguments (number)\n ----- Rejecting (all current bests better) java.lang.Long.(java.lang.String) for arguments (number)\njs> java.lang.Long.bitCount(L)\n ----- Found java.lang.Long.bitCount(long) for arguments (java.lang.Long)\n ----- Calling java.lang.Long.bitCount(long) for arguments (number)\n ----- Returned 16 actual = class java.lang.Integer expect = int\n ----- Wrapped as 16 class = class java.lang.Integer\n16Fixed:\n\nChecking in NativeJavaObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaObject.java,v  <-- NativeJavaObject.java\nnew revision: 1.77; previous revision: 1.76\ndone\nAdding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
378580,'Runtime error when Rhino E4X attribute expression evaluates to empty string',Rhino,E4X,inonit,inonit,'Rhino 1.6 release 6 Pre 2007 04 06\njs> var attribute = \"\";\n\njs> var element = <x a={attribute}/>\n[Fatal Error] :1:25: Element type \"x\" must be followed by either attribute specifications, \">\" or \"/>\".\njs: \"<stdin>\", line 3: uncaught JavaScript runtime exception: TypeError: Cannot parse XML: Element type \"x\" must be followed by either attribute specifications, \">\" or \"/>\".\n\njs> var attribute = \"a\";\n\njs> var element = <x a={attribute}/>\n[ no error ]Checking in fix on HEAD that passes the above test.Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
378790,'Add JS 1.5 strict mode.',Rhino,Core,bjervis,roshanj,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1) Gecko/20061010 Firefox/2.0\nBuild Identifier: \n\nRhino should support JS 1.5 strict mode as an option.  (Patch on its way).\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.\n\n\n\nThis is a new feature request that affects a bunch of specific cases.Created attachment 262804\nA patch that implements much of \'strict mode\'\n\nThis defines two new FEATURE\'s: FEATURE_STRICT_MODE, which implements most of strict mode.  FEATURE_STRICT_VARS already implements one of the checks (and is separate from the new FEATURE_STRICT_MJODE, so technically you have to set them both to get the full effect).  There is also a FEATURE_WARNING_AS_ERROR that will cause warnings to be treated as errors in all cases.\n\nThere is a new command line flag for the Shell: -fatal_warnings to enable FEATURE_WARNING_AS_ERROR.  Also -strict now enables FEATURE_STRICT_MODE as well.\n\nNote that FEATURE_WARNING_AS_ERROR will cause warnings to be treated as errors even if you do not enable warnings (with, for example, the -w flag on the Shell).\n\nThe parts of strict mode that are not implemented are: \n\n1. Some of the deprecated stuff was never supported by Rhino to begin with, so nothing was done to deprecate non-supported things.\n2. For the return-without-value warnings, the code to check for whether a function falls through the bottom without a return statement is incomplete.  SpiderMonkey and Rhino have very different representations for switches and catch clauses than does Rhino.  I copied the SpiderMonkey checking code and patched up the differences for everything but those cases.  Thus, some switch statements (those with a default case, for example) that might otherwise warn about falling through will not warn.  Similarly with try/catches that have no finally clause.  The code for checking the individual catch clauses is missing.Hi Bob.  I was just going through the old E-mails about this earlier today, interestingly enough.  I\'ve been thinking about refactoring the Context \"features\" into a separate class.  \n\nThis was inspired by the E4X implementation factory stuff, which doesn\'t neatly map onto a true-false model.  Strict mode maps better but it would make sense to have various aggregations that could be handled as a single object.  In another bug (I forget which offhand) there\'s a discussion about making the property mapping logic pluggable.  The code would not only get pretty ugly, the FEATURE_XXX motif doesn\'t cover well anything where there are more than two (or a potentially open-ended) number of options.\n\nI know you\'ve just been through this code, and just through doing some implementation based on it.  What are your thoughts?  Backward compatibility would be pretty easy to maintain, in that any Context/ContextFactory that overrode the current feature provision method would end up using a hidden Features implementation that delegated to that method, but everybody else could start implementing the new method.  But if I were to do this, it might at this point make sense to do it now -- before this patch is applied and adds even more features.\n\nThoughts?Bob, I reviewed your patch and had some changes that I made, all relatively \nminor. I attached the changes. \n\nI haven\'t yet looked at the more complex parts of the code in detail.\n\nDavid, I\'m just now seeing your post and I\'ll think about that.\nCreated attachment 262834\nstrictMode2.patchDavid, \n\nWhere is the E4X implementation factory so I can take a look? It\'s in Context and ContextFactory; see getE4xImplementationFactory in both of those (supplying a default implementation in ContextFactory).\n\nIt introduces a couple of problems with the current layout (and one can think of analogous ones for analogous situations).\n\nFirst, someone can set FEATURE_E4X to true, but then fail to provide an E4X implementation, or vice-versa.  Especially in the former case, this means we can\'t trust FEATURE_E4X in our code (and you\'ll find in the initStandardObjects stuff that we in fact don\'t).  In the latter case, at least there\'s a sensible treatment (if FEATURE_E4X is false despite the presence of a factory, just don\'t use E4X).\n\nSecond, there are presently two implementations of E4X but there is at least some indication there may be a third floating around somewhere (some discussion on the newsgroup or in Bugzilla, I forget where, about how to compile without E4X because someone was using a hack to get their own in the classpath) and the intention is to allow people to plug in their own implementations.  Thus, there is no easy binary way to specify the desired implementation factory as a series of boolean features.Since we\'ve moved far afield from a discussion of implementing strict mode, I\'m going to move my followup questions to an email thread. \n\nChecked in Bob\'s partial implementation of strict mode while we discuss the feature feature :-)\n\nChecking in src/org/mozilla/javascript/CompilerEnvirons.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/CompilerEnvirons.java,v  <--  CompilerEnvirons.java\nnew revision: 1.16; previous revision: 1.15\ndone\nChecking in src/org/mozilla/javascript/Context.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\nnew revision: 1.255; previous revision: 1.254\ndone\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.104; previous revision: 1.103\ndone\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.55; previous revision: 1.54\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.111; previous revision: 1.110\ndone\nChecking in src/org/mozilla/javascript/ScriptOrFnNode.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptOrFnNode.java,v  <-- ScriptOrFnNode.java\nnew revision: 1.21; previous revision: 1.20\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.261; previous revision: 1.260\ndone\nChecking in src/org/mozilla/javascript/regexp/NativeRegExp.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java,v <--  NativeRegExp.java\nnew revision: 1.101; previous revision: 1.100\ndone\nChecking in src/org/mozilla/javascript/regexp/RegExpImpl.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/RegExpImpl.java,v  <--  RegExpImpl.java\nnew revision: 1.35; previous revision: 1.34\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.69; previous revision: 1.68\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\nnew revision: 1.70; previous revision: 1.69\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java,v  <--  ShellContextFactory.java\nnew revision: 1.10; previous revision: 1.9\ndone\nSince I updated my local Rhino from CVS I get these errors:\n\njava.lang.IllegalArgumentException: 11\n\tat org.mozilla.javascript.ContextFactory.hasFeature(ContextFactory.java:284)\n\tat org.mozilla.javascript.Context.hasFeature(Context.java:2142)\n\tat org.mozilla.javascript.CompilerEnvirons.initFromContext(CompilerEnvirons.java:72)\n\tat org.mozilla.javascript.Context.compileImpl(Context.java:2301)\n\tat org.mozilla.javascript.Context.compileReader(Context.java:1309)\n\tat org.mozilla.javascript.Context.compileReader(Context.java:1281)\n\tat org.mozilla.javascript.Context.evaluateReader(Context.java:1223)\n\t...\n\nIt turns out that CompilerEnvirons.initFromContext asks for both FEATURE_STRICT_MODE and FEATURE_WARNING_AS_ERROR, but ContextFactory.hasFeature does not return a value for these and throws an IllegalArgumentException instead.\n\nI am not sure if this is the right place to report this, or if I should open a new bug.\n\nThe patch is simple:\n\nIndex: ContextFactory.java\n===================================================================\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ContextFactory.java,v\nretrieving revision 1.24\ndiff -r1.24 ContextFactory.java\n278a279,281\n> \n>           case Context.FEATURE_STRICT_MODE:\n>               return false;\n279a283,285\n>           case Context.FEATURE_WARNING_AS_ERROR:\n>               return false;\n> \nI committed the patch.Reassign to Roshan to finish up the strict mode work.Created attachment 265858\nPath for no return value feature\n\nThe patch adds the missing features of Strict Mode to the code that is currently in the repository. This patch adds the check for final-return-value on javascript functions.\n\nI have added cases that handle try-catch blocks and switch statements over Bob\'s previous patch.\n\nRoshanCreated attachment 266826\nUpdated patch for return checks\n\nThis patch should address most of the requirements for return value checks for strict mode. \n\njs> function contrived(x) {\n  while ( x < 10) {\n    if ( x < 5) {\n      return;\n    }\n    x = x + 1;\n  }\n \nif (x == 100)\n  return x;\n else\n   return x + 1;\n}\njs: warning: \"<stdin>\", line 23: return statement is inconsistent with previous usage\njs:   return x;\njs: ..........^\njs: warning: \"<stdin>\", line 26: function contrived does not always return a value\njs: }\njs: ^\n\nThere are two possible warnings per function:\n 1) The first inconsistent return statement of a function is flagged. Subsequent returns are not flagged. (I can flag all the subsequent returns if you choose)\n 2) Overall if the function can have an error if there is any reachable return statement with a value and the function can end in some way (by a return or by dropping off the end) without a value.\n\nBoth warnings can be issued independent of each other:\n\njs> function contrived(x) {\n  while(true) {\n    if (x > 10)\n      return;\n    x = x + 1\n  }\n  return 1;\n}\njs: warning: \"<stdin>\", line 15: return statement is inconsistent with previous usage\njs:   return 1;\njs: ..........^\n\nThe second warning is not issued here because the reachability analysis sees that the while loop will never break.\n\nHere is the other case:\n\njs> function (x) {\n  if (x < 10)\n    return 1;\n}\njs: warning: \"<stdin>\", line 16: anonymous function does not always return a value\njs: }Committed Roshan\'s changes with some modifications. I also updated some other\nstrict mode checks:\n\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.56; previous revision: 1.55\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.112; previous revision: 1.111\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.262; previous revision: 1.261\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.70; previous revision: 1.69\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.26; previous revision: 1.25\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\nnew revision: 1.71; previous revision: 1.70\ndone\n',?,RFE
379104,'new Date(2007,5,0) should reflect May 31, 2007, not June 1, 2007',Rhino,Core,jag-mozilla,nobody,'Created attachment 263102\nFix bug in handling day-of-month value in Date constructor, UTC function\n\nThere\'s a small bug in NativeData.java in how the Date constructor and the UTC function handle the value for the day-of-month component. Currently both map anything less than 1 to 1. According to ECMA-262 (3rd), section 15.9.1.12 step 8, the value should simply be added as-is.\n\nSee also bug 9523 and change 3.19 to jsdate.c\n\nNote that bug 9523 didn\'t update the date_UTC(...) function, I\'ll file a bug on that shortly.\n\nThe Date constructor bug was found and fixed by Ilya Frank <ifrank@danger.com>, a colleague of mine at Danger Inc. Based on that I discovered and fixed the UTC function version of the bug.See bug 363578 for fixing the UTC function in jsdate.c.Created attachment 263106\nSame, but with most of the shared code factored outComment on attachment 263106\nSame, but with most of the shared code factored out\n\nLooks okay. Also a nice refactoring to eliminate some code duplication.Committed the patch to CVS.Cool! Thanks for checking this in. Is there a test we can/should update?Adding target milestone of 1.6R6 based on the date this bug was resolved FIXED.',?,BUG
379377,'JavaScript 1.7 Generators and Iterators for Rhino',Rhino,Compiler,norrisboyd,norrisboyd,'Implement JavaScript 1.7 Generators for Rhino \n\nSee http://developer.mozilla.org/en/docs/New_in_JavaScript_1.7 and the SpiderMonkey bug 326466Set target milestone.+ Roshan\n\nCreated attachment 266907\nPatch that implements generators for interpretive modeCreated attachment 266909\nNew file: NativeGenerator.javaPrevious patches are now obsolete; latest code is checked into CVS.Committed changes for Iterator support:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.324; previous revision: 1.323\ndone\nChecking in src/org/mozilla/javascript/NativeGenerator.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeGenerator.java,v  <--  NativeGenerator.java\nnew revision: 1.2; previous revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeIterator.java,v\ndone\nChecking in src/org/mozilla/javascript/NativeIterator.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeIterator.java,v  <--  NativeIterator.java\ninitial revision: 1.1\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.266; previous revision: 1.265\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.75; previous revision: 1.74\ndone\nChecking in testsrc/base.skip;\n/cvsroot/mozilla/js/rhino/testsrc/base.skip,v  <--  base.skip\nnew revision: 1.3; previous revision: 1.2\ndone\nThis has now been implemented in the latest trunk changes.',?,RFE
379379,'JavaScript 1.7 Block scope with \"let\" for Rhino',Rhino,Compiler,norrisboyd,norrisboyd,'Implement the JavaScript 1.7 feature for block scope with \"let\". See http://developer.mozilla.org/en/docs/New_in_JavaScript_1.7#Block_scope_with_let and bug 336378.Set target milestone.Committed changes to mainline for 1.7R1. Rhino now implements block scope.',?,SPEC
379382,'JavaScript 1.7 Destructuring Assignment for Rhino',Rhino,Compiler,norrisboyd,norrisboyd,'Support JavaScript 1.7 destructuring assignment for Rhino. See http://developer.mozilla.org/en/docs/New_in_JavaScript_1.7#Destructuring_assignment and bug 336379.Set target milestone.This has now been implemented in the trunk.',?,RFE
380005,'Date to String conversion code in NativeDate class is not thread-safe',Rhino,Core,gxue,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.8.0.11) Gecko/20070312 Firefox/1.5.0.11\nBuild Identifier: 1.6R1\n\nClass org.mozilla.javascript.NativeDate class uses static java.text.DateFormat instances (members: timeZoneFormatter,localeDateTimeFormatter,localeDateFormatter, localeTimeFormatter) to convert date/time values to string. However DateFormat instances are not thread-safe (check JDK documentation). This results in occasional runtime exceptions when expressions containing date->string conversion are evaluated concurrently.\n\nSee Steps to Reproduce for sample code that demonstrates this problem. This code evaluates an expression \n   \"Date:\" + date_var\nin 20 concurrent threads. The test code occasionally gives an ArrayIndexOutOfBoundsException.\n\nReproducible: Sometimes\n\nSteps to Reproduce:\n1.Run the following test code, preferrably on a multi-CPU machine. I\'ve reliably reproduced this on a dual-Intel P4 2.8GHZ machine running Windows 2003 Server, against JRE version 1.5.0_07\n\n2. The program occasionally dumps an exception. See Actual Results for stack. This happens about 1 out of 5 runs in my test. \n\n---- Test Code  ----\n\nimport java.util.Random;\nimport org.mozilla.javascript.Context;\nimport org.mozilla.javascript.Scriptable;\n\npublic class DateConversionTest\n{\n\t\n\tpublic static void main(String[] args) throws Exception\n\t{\n\t\t// Run 10 threads\n\t\tfor ( int i = 0; i < 20; i++ )\n\t\t{\n\t\t\tThread t = new TestThread();\n\t\t\tt.start();\n\t\t}\n\t}\n\t\n\tstatic class TestThread extends Thread\n\t{\n        public void run() \n        {\n        \tContext cx;\n        \tScriptable scope;\n    \t\tcx = Context.enter();\n    \t\tscope = cx.initStandardObjects();\n\n    \t\tRandom rand = new Random();\n\n    \t\tfor (int i = 0; i < 1000; i++)\n    \t\t{\n        \t\tint year = rand.nextInt(10) + 1990;\n        \t\tint month = rand.nextInt(12) + 1;\n        \t\tint day = rand.nextInt(28) + 1;\n        \t\tint hour = rand.nextInt(24);\n        \t\tint minute = rand.nextInt(60);\n        \t\tint sec = rand.nextInt(60);\n        \t\t\n            \tString expr = \"\\\"Date: \\\" + new Date( \" + \n            \t\tyear + \",\" + month + \",\" + day + \",\" + hour + \",\" + minute + \",\" + sec + \")\"; \n        \t\tcx.evaluateString( scope, expr, \"\", 1, null );\n    \t\t}\n    \t\t\n    \t\tContext.exit();\n        }\t\t\n\t}\n\t\n}\n\nActual Results:  \nException: \n\nException in thread \"Thread-14\" java.lang.ArrayIndexOutOfBoundsException: 22\n        at sun.util.calendar.BaseCalendar.getCalendarDateFromFixedDate(Unknown Source)\n        at java.util.GregorianCalendar.computeFields(Unknown Source)\n        at java.util.GregorianCalendar.computeFields(Unknown Source)\n        at java.util.Calendar.setTimeInMillis(Unknown Source)\n        at java.util.Calendar.setTime(Unknown Source)\n        at java.text.SimpleDateFormat.format(Unknown Source)\n        at java.text.SimpleDateFormat.format(Unknown Source)\n        at java.text.DateFormat.format(Unknown Source)\n        at org.mozilla.javascript.NativeDate.date_format(NativeDate.java:1054)\n        at org.mozilla.javascript.NativeDate.execIdCall(NativeDate.java:201)\n        at org.mozilla.javascript.IdFunctionObject.call(IdFunctionObject.java:121)\n        at org.mozilla.javascript.ScriptableObject.getDefaultValue(ScriptableObject.java:577)\n        at org.mozilla.javascript.NativeDate.getDefaultValue(NativeDate.java:84)\n        at org.mozilla.javascript.ScriptRuntime.add(ScriptRuntime.java:2290)\n        at org.mozilla.javascript.gen.c2708._c0(:1)\n        at org.mozilla.javascript.gen.c2708.call()\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:304)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2769)\n        at org.mozilla.javascript.gen.c2708.call()\n        at org.mozilla.javascript.gen.c2708.exec()\n        at org.mozilla.javascript.Context.evaluateString(Context.java:1220)\n        at DateConversionTest$TestThread.run(DateConversionTest.java:61)\n\n\nExpected Results:  \nNo exception\n\nUse an instance of DateFormat per thread. Or synchronize code that accesses the static DateFormat instances.Fixed: \n\nChecking in NativeDate.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeDate.java,v  <--  NativeDate.java\nnew revision: 1.65.2.1; previous revision: 1.65\ndone\n\nI just synchronized access to the static DateFormat instances. Norris - thanks for the fix. Did this fix make it into the 1.6R6 release? Thanks, Gary',?,DESIGN_DEFECT
381180,'__lookupGetter__ finds a function even when it should not (similarly for __lookupSetter__)',Rhino,Core,roshanj,roshanj,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3\nBuild Identifier: 1.6R6\n\njs> function A() { this.foo_ = \'a\'; }\njs> A.prototype.__defineGetter__(\'foo\', function() {return this.foo_})\njs> new A().foo\na\njs> function B() { this.foo_ = \'b\' }\njs> B.prototype = new A();\n[object Object]\njs> new B().foo\nb\njs> B.prototype.__defineSetter__(\'foo\', function(f) {this.foo_ = f})\njs> new B().foo\njs> var b = new B()\njs> b.foo_\nb\njs> b.foo\njs> b.__lookupGetter__(\'foo\')\n\nfunction () {\n    return this.foo_;\n}\n\n\n\"__lookupGetter__ is returning a getter defined on a prototype even when there is a setter (and no getter) defined on the object itself.  I\'m pretty sure that the converse for __lookupSetter__ does the same thing. \"\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.\nActual Results:  \nThis should not happen:\n\njs> b.foo\njs> b.__lookupGetter__(\'foo\')\n\nfunction () {\n    return this.foo_;\n}\n\nExpected Results:  \n__lookupGetter__ should fail\n\nThe same happens on __lookupSetter__Added target milestone of 1.6R6.Assigning to Roshan.Created attachment 265308\nBug Patch\n\nHere is a proposed patch.Fixed:\n\nChecking in ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.122.2.2; previous revision: 1.122.2.1\ndone\n',?,BUG
381819,'Rhino tests broken due to change in shell.js locations.',Rhino,Core,bclary,nobody,'Created attachment 265886\npatch v1\n\nBug 379779 created a new top level shell.js to consolidate common code however the Rhino test driver did not include this script which resulted in multiple failures when running the JavaScript Test suite in Rhino.\n\nThis patch adds the top level shell.js to the helper list as well as excludes the template.js files which are not actual test files.Patch checked in:\n\nChecking in org/mozilla/javascript/drivers/ShellTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/ShellTest.java,v  <--  ShellTest.java\nnew revision: 1.2; previous revision: 1.1\ndone\n',?,TEST
382098,'E4X attribute literals broken',Rhino,E4X,martin,inonit,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3\nBuild Identifier: CVS 2007-05-26\n\nConsider the following test program, \"test.js\":\n\na=1\n\nb=<xml><element attr={a}>{2}</element></xml>\nprint(b)\n\nc=<xml><element attr={1}>{2}</element></xml>\nprint(c)\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java -jar js.jar -opt -1 test.js\n2. java -jar js.jar -opt 0 test.js\n\nActual Results:  \nCase 1): Code for \'b\' works, \'c\' breaks.\nCase 2): Both \'b\' and \'c\' break.\n\nTypeError: Cannot parse XML: Open quote is expected for attribute \"{1}\" associated with an  element type  \"attr\".\n\n\nif one would print what is actually send to org.mozilla.javascript.xmlimpl.XMLLibImpl.parse(), one would see\n\nCase 1): <xml><element attr=\"1\">2</element></xml> [correct]; and\n         <xml><element attr=1>2</element></xml>   [missing quotes]\n\nCase 2): <xml><element attr=1>2</element></xml>   [missing quotes]; and\n         <xml><element attr=1>2</element></xml>   [missing quotes]Created attachment 266180\nThe \"test.js\" fileI\'ll take a look at this, since I\'m hacking around in the code right now.  Case 1 corresponds to the bug I received via private mail but have not filed in Bugzilla.  Case 2 I have not yet seen.Sorry--we collided. This is the same bug that Adam de Boor submitted the patch for. I tested it and committed his fix. Let me know if you want to back out that change.\n\nFixed:\n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <-- \nInterpreter.java\nnew revision: 1.320.2.4; previous revision: 1.320.2.3\ndone\nChecking in Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <-- \nParser.java\nnew revision: 1.112.2.2; previous revision: 1.112.2.1\ndone\n\nPatch from Adam de Boor <adeboor@google.com>. Did you check it in on the branch or trunk or both?Just the branch. I held off checking in on the trunk once I got the message that you were looking at the issue.\n\nOK, I am working off of the branch and I seem to be seeing the changes.  I may have checked out after you checked in, which mystified me for a little while (I was running cvs update and getting nothing).  Now that I\'ve fixed my big global problem (see bug 388643), I\'m digging into the details.',?,BUG
382457,'Java variable argument support',Rhino,Core,norrisboyd,norrisboyd,'Java5 varg support:\n\nJava5 varg methods can be called with varg style from JavaScript. The relevant\nchanges are in MemberBox, NativeJavaClass and NativeJavaMethod. \n\nSee bug 382340.Changes submitted.\n\nChecking in MemberBox.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/MemberBox.java,v  <--  MemberBox.java\nnew revision: 1.15; previous revision: 1.14\ndone\nChecking in NativeJavaClass.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaClass.java,v  <--  NativeJavaClass.java\nnew revision: 1.48; previous revision: 1.47\ndone\nChecking in NativeJavaMethod.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaMethod.java,v  <--  NativeJavaMethod.java\nnew revision: 1.58; previous revision: 1.57\ndone\nChecking in VMBridge.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/VMBridge.java,v  <--  VMBridge.java\nnew revision: 1.5; previous revision: 1.4\ndone\nChecking in jdk11/VMBridge_jdk11.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk11/VMBridge_jdk11.java,v  <--  VMBridge_jdk11.java\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in jdk13/VMBridge_jdk13.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk13/VMBridge_jdk13.java,v  <--  VMBridge_jdk13.java\nnew revision: 1.4; previous revision: 1.3\ndone\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java,v\ndone\nChecking in jdk15/VMBridge_jdk15.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java,v  <--  VMBridge_jdk15.java\ninitial revision: 1.1\ndone\nChecking in build.xml;\n/cvsroot/mozilla/js/rhino/build.xml,v  <--  build.xml\nnew revision: 1.43; previous revision: 1.42\ndone\nChecking in src/build.xml;\n/cvsroot/mozilla/js/rhino/src/build.xml,v  <--  build.xml\nnew revision: 1.9; previous revision: 1.8\ndone\nSet target milestone.',?,RFE
383164,'Javascript error required for Generators that return',Rhino,Core,roshanj,roshanj,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3\nBuild Identifier: 1.6R6\n\nA generator that returns a values must be flagged by an error;.\n\nfunction (x) {\n yield x;\n return x+1;\n}\n\nMust be flagged by an error. \n\nReproducible: AlwaysCreated attachment 267320\nPatch: adds required errors\n\nThe patch adds the required error messages. These errors are flagged all the time (not just on strict mode). \n\nStrict mode warnings have been extended to do reachability analysis that accommodates mismatched uses of yield and value-returns.\n\njs> function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: \"<stdin>\", line 2: generator function foo returns a value\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: .......................................................................^\njs: \"<stdin>\", line 2: Compilation produced 1 syntax errors.Committed patch on date: 2007/06/06 14:32:39 and enabled test.\n\nMarking fixed. ',?,BUG
383356,'Yield Statements are reported as not being side effects when strict mode is enabled',Rhino,Core,roshanj,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3\nBuild Identifier: 1.7r1\n\njs> function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: \"<stdin>\", line 2: generator function foo returns a value\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: .......................................................................^\njs: warning: \"<stdin>\", line 2: Code has no side effects\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: .......................................................................^\njs: warning: \"<stdin>\", line 2: Code has no side effects\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: ....................................................................................^\njs: warning: \"<stdin>\", line 2: function foo does not always return a value\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: ......................................................................................^\njs: \"<stdin>\", line 2: Compilation produced 1 syntax errors.\n\nThe side effect warnings are not required\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 267323\nFixes the warning message\n\nError output\n\njs> function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: \"<stdin>\", line 2: generator function foo returns a value\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: .......................................................................^\njs: warning: \"<stdin>\", line 2: function foo does not always return a value\njs: function foo(x) { var a = 10; x =x + 1; if(x < 1) { return x; } yield x; yield x + 1; }\njs: ......................................................................................^\njs: \"<stdin>\", line 2: Compilation produced 1 syntax errors.Committed Roshan\'s patch:\n\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.59; previous revision: 1.58\ndone\n',?,CLEANUP
383461,'Const redeclaration errors should be TypeErrors, not SyntaxErrors',Rhino,Compiler,norrisboyd,nobody,'SpiderMonkey:\n\njs> try { eval(\"const x=3; var x=4;\"); } catch (ex) { e = ex; }\nTypeError: redeclaration of const x\njs> e instanceof TypeError\ntrue\n\nRhino:\njs> try { eval(\"const x=3; var x=4;\"); } catch (ex) { e = ex; }\nSyntaxError: Redeclaration of const x.\njs> e instanceof SyntaxError\ntrue\njs> e instanceof TypeError\nfalseFixed on both 1.6R6 branch and mainline.',?,CLEANUP
386176,'Allow inspection of JS code without compiling and evaluating it',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.4) Gecko/20061201 Firefox/2.0.0.4 (Ubuntu-feisty)\nBuild Identifier: \n\nCurrently, Rhino does not provide a way to parse and inspect JavaScript code without actually compiling and evaluating it. \n\nReproducible: AlwaysCreated attachment 270174\nimplements Parser.parseTokens() \n\nThis patch adds two parseTokens() methods to org.mozilla.javascript.Parser that transform JS code into a token array. I have made the org.mozilla.javascript.Token class instantiable for this purpose. This doesn\'t affect the normal compilation/evaluation functionality in any way.Any chance to see this patch (or something similar) applied in next Rhino version?I\'m fine with it. My only question is whether such a linear token stream is sufficient for all purposes. Just recently I had to do some editing on the AST produced by Rhino (and then regenerate source code from it after editing), and it appears to me that it\'s easier to work with a tree structure.I see it as well as a first step opening up access to the parsing results and I would be interested in method allowing to modify the AST before it gets executed / compiled.Marking as closed as per Norris\' and Steve Yegge\'s Parser/AST refactoring.',?,RFE
386997,'Need to support \'debugger\' statement',Rhino,Core,bjervis,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3\nBuild Identifier: \n\nThe \'debugger\' statement is a useful debugging tool.  We should recognize it in user source and do something useful in a JavaScript debugger.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Take any working script and add \'debugger;\' as a statement\n2.\n3.\nActual Results:  \nParse error\n\nExpected Results:  \nNormal execution (with \'debugger\' behaving like a no-op).  A debugger should stop and report a breakpoint hit or some equivalent message.Created attachment 271087\nPartal patch for \'debugger\' statement.\n\nThis is a partial patch.  It parses the \'debugger\' statement and inserts a bytecode for it in the interpreted code path (and does nothing in the compiled path).  I have sent mail to Norris to get his opinion on how we should plumb this through to the DebugFrame interface.Created attachment 271769\nFull patch implementing \'debugger\' statement\n\nThis revises the debugger support to include actual hitting of breakpoints within the debugger itself.Checked in proposed patch: \n\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.107; previous revision: 1.106\ndone\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.328; previous revision: 1.327\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.117; previous revision: 1.116\ndone\nChecking in src/org/mozilla/javascript/Token.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Token.java,v  <--  Token.java\nnew revision: 1.41; previous revision: 1.40\ndone\nChecking in src/org/mozilla/javascript/TokenStream.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/TokenStream.java,v  <--  TokenStream.java\nnew revision: 1.68; previous revision: 1.67\ndone\nChecking in src/org/mozilla/javascript/debug/DebugFrame.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/debug/DebugFrame.java,v  <--  DebugFrame.java\nnew revision: 1.10; previous revision: 1.9\ndone\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.249; previous revision: 1.248\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/debugger/Dim.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Dim.java,v  <--  Dim.java\nnew revision: 1.13; previous revision: 1.12\ndone\n',?,RFE
387694,'More reportMatch changes to generalize tests',Rhino,Compiler,norrisboyd,bclary,'I\'ve been implementing block scope (let), and needed to use the reportMatch \nfunction to generalize tests for both SpiderMonkey and Rhino error messages.\n\nSee attached patch. If don\'t see any issues with the patch I can commit it.Created attachment 271860\nPatch for changes to testsI did a quick look and it looks fine, but can we hold off for a day or so? I am hopefully in the final stages of getting regression and fix detection working for Spidermonkey and don\'t want to mess up the failure messages at the moment.\n\nAs soon as I get the regression and fix detection working, I\'ll review and check in. Ok?Sounds good, thanks!Bob, \n\nCan I commit these changes yet?\n\nThanks,\nNorrisI\'m running a set of shell tests on 1.8.1, 1.9.0 with this patch applied. I\'ll let you know in ~hour?Great, thanks.Comment on attachment 271860\nPatch for changes to tests\n\nresults look fine. please go ahead and check in.Fixed: \n\nChecking in js1_7/block/regress-348685.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-348685.js,v  <-- \nregress-348685.js\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in js1_7/block/regress-349507.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-349507.js,v  <-- \nregress-349507.js\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in js1_7/block/regress-350279.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-350279.js,v  <-- \nregress-350279.js\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in js1_7/block/regress-351497.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-351497.js,v  <-- \nregress-351497.js\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in js1_7/block/regress-352212.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-352212.js,v  <-- \nregress-352212.js\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in js1_7/block/regress-352609.js;\n/cvsroot/mozilla/js/tests/js1_7/block/regress-352609.js,v  <-- \nregress-352609.js\nnew revision: 1.4; previous revision: 1.3\ndone',?,TEST
389278,'NPE with regexp /(?:.)\\1/',Rhino,Core,norrisboyd,nobody,'Executing\n\n   \"Mississippi\".split(/(?:.)\\1/)\n\nCauses a NPE at org.mozilla.javascript.regexp.REGlobalData.parens_index(NativeRegExp.java:2735)Fixed: https://github.com/mozilla/rhino/commit/c9005a11f2410aa77e7345dd4369e14c49e911dc',?,BUG
391349,'Exception on startup on JDK 1.4',Rhino,Core,norrisboyd,norrisboyd,'Created attachment 275764\nProposed patch\n\nfrom newsgroup:\n\nI run into this problem today when runing Rhino on JDK 1.4 on Mac:\n\njava.lang.NoSuchMethodError: java.lang.reflect.Method.isVarArgs()Z\nat org.mozilla.javascript.jdk15.VMBridge_jdk15.isVarArgs\n(VMBridge_jdk15.java:48)\n\nIt seems that VMBridge_jdk15 is used although I am on 1.4.\n\nLooking at VMBridge\'s code for deciding which one to use, I saw that  \nit loops through these and tries to instantiate them:\n\norg.mozilla.javascript.VMBridge_custom\norg.mozilla.javascript.jdk15.VMBridge_jdk15\norg.mozilla.javascript.jdk13.VMBridge_jdk13\norg.mozilla.javascript.jdk11.VMBridge_jdk11\n\nAnd for some reason it seems to be able to instantiate VMBridge_jdk15  \non 1.4 and is happy.\n\nI then looked at VMBridge_jdk15 and did not see any condition that  \nshould prevent it from being able to do so. Or should the missing  \nisVarArgs() be enough a reason for it to not load?\n\nIs it just me, or is this currently broken for 1.4?\n\nJ?rg \n\nAttaching proposed fix from J?rg from later in the same thread.Fixed:\n\nChecking in src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java,v  <--  VMBridge_jdk15.java\nnew revision: 1.1.4.1; previous revision: 1.1\ndone\nCreated attachment 275780\nUpdated patch, handling all exceptions correctly\n\nThe proposed patch works for me. But I think it should be done differently since org.mozilla.javascript.Kit.newInstanceOrNull does not handle NoSuchMethodException. I am actually not sure anymore why it works, I guess a SecurityException is thrown, which newInstanceOrNull handles.\nSo here a new version that throws exceptions handled by newInstanceOrNull and also uses the strategy proposed by Attila.Okay, I\'ve redone the change based upon the latest patch. The new candidate is now at ftp://ftp.mozilla.org/pub/mozilla.org/js/rhino1_6R7-candidate2.zip. Please try it out.\n\nChecking in src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java,v  <--  VMBridge_jdk15.java\nnew revision: 1.1.4.2; previous revision: 1.1.4.1\ndone\nIt appears that the old patch is still in place in CVS. This should be updated, since its result is not handled correctly by newInstanceOrNull. Is there a reason for waiting with this?Thanks for asking -- I\'d committed to the branch for 1.6R7 but not to the trunk for 1.7R1. I\'ve now checked it into the trunk:\n\nChecking in src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java,v  <--  VMBridge_jdk15.java\nnew revision: 1.5; previous revision: 1.4\ndone\nCan you tell me which build will include this fix?\nThanks.This fix is already in 1.6R7. See http://www.mozilla.org/rhino/download.html.I have tried 1.6R7 but seems the issue still can reproduce. I saw the same NoSuchMethodError.\n\nI will try againIt\'s my mistake,it works.\nThank you.',?,BUG
391350,'Incorrect type inference for array and object literals',Rhino,Compiler,norrisboyd,norrisboyd,'Created attachment 275765\nProposed patch\n\nThe program\n\nfunction f() {\n  var x = {a:1,b:2};\n  return x.a;\n}\nprint(f());\n\nwill print \"undefined\" for optimization level 1 instead of 1 due to the optimizer incorrectly assuming the object literal in the tree is an operator with two number type operands that must thus produce a number.Fixed:\n\nChecking in src/org/mozilla/javascript/optimizer/Block.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Block.java,v  <--  Block.java\nnew revision: 1.37.4.1; previous revision: 1.37\ndone\n',?,BUG
392308,'bad StopIteration instanceof behavior',Rhino,Core,norrisboyd,norrisboyd,'The final send() or next() is throwing a StopIteration\nas expected, but I can\'t seem to catch it with a catch guard:\n\n// SpiderMonkey:\nfunction testStop() {\n  function yielder() {\n    print(\"before\");\n    yield;\n    print(\"after\");\n  }\n  try {\n    var gen = yielder();\n    var result = gen.next();\n    gen.send(result);\n  } catch (x if x instanceof StopIteration) {\n    print(\"iteration terminated normally\");\n  } catch (x2) {\n    print(\"unexpected throw: \" + x2);\n  }\n}\njs> testStop()\nbefore\nafter\niteration terminated normally\n\n// same code on Rhino:\nfunction testStop() {\n  function yielder() {\n    print(\"before\");\n    yield;\n    print(\"after\");\n  }\n  try {\n    var gen = yielder();\n    var result = gen.next();\n    gen.send(result);\n  } catch (x if x instanceof StopIteration) {\n    print(\"iteration terminated normally\");\n  } catch (x2) {\n    print(\"unexpected throw: \" + x2);\n  }\n}\njs> testStop()\nbefore\nafter\nunexpected throw: [object StopIteration]\n\nThanks,\n\n-steveFixed:\n\nChecking in NativeIterator.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeIterator.java,v  <--  NativeIterator.java\nnew revision: 1.5; previous revision: 1.4\ndone\nCreated attachment 276801\njs1_7/extensions/regress-392308.js\n\nI put this in extensions due to the conditional catch clause.Great, works for Rhino.can you stamp the test + and I\'ll check it in.What do you mean \"stamp the test\"? I did try it out for Rhino and it works.Great. I meant + the review, or I can just remove the request. Minor anal bugzilla moment.Comment on attachment 276801\njs1_7/extensions/regress-392308.js\n\nLooks good to meSorry--I didn\'t even know about that feature. I hope I did it right :-)That was fine. :-)\n\nChecking in regress-392308.js;\n/cvsroot/mozilla/js/tests/js1_7/extensions/regress-392308.js,v  <--  regress-392308.js\ninitial revision: 1.1\n',?,DESIGN_DEFECT
392310,'send(undefined) on newborn generator shouldn\'t cause error',Rhino,Core,norrisboyd,norrisboyd,'SpiderMonkey:\n\njs> function yielder() {\n  print(\'before ye yield\');\n  yield;\n  print(\'after ye yield\');\n}\n\njs> var gen = yielder();\njs> gen.send(undefined);\nbefore ye yield\n\nI.e. (per http://developer.mozilla.org/en/docs/New_in_JavaScript_1.7),\ncalling send(undefined) on a newborn generator is equivalent to calling\nnext() to start it.\n\nRhino:\n\njs> gen.send(undefined)\njs: \"<stdin>\", line 44: uncaught JavaScript runtime exception:\n  TypeError: Attempt to send value to newborn generatorChecking in NativeGenerator.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeGenerator.java,v  <--  NativeGenerator.java\nnew revision: 1.6; previous revision: 1.5\ndone\nCreated attachment 276798\njs1_7/geniter/regress-392310.jsCreated attachment 276827\nregress-392310.js\n\nUpdated proposed test to match Rhino error output.Checking in regress-392310.js;\n/cvsroot/mozilla/js/tests/js1_7/geniter/regress-392310.js,v  <--  regress-392310.js\ninitial revision: 1.1\n',?,BUG
392481,'Feature request: selectively allowing access to non-public Java methods and fields',Rhino,Core,donnamalayeri,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.8.1.6) Gecko/20070725 Firefox/2.0.0.6\nBuild Identifier: Rhino 1.6R7_branch\n\nThe requested feature is to add a option to allow accessing non-public Java methods and fields. This is useful for debugging and unit-testing.  The feature will off by default, but subclasses of the Rhino ShellContextFactory class can override this behavior to allow access to non-public members.\n \n\nReproducible: Always\n\nSteps to Reproduce:\nn/a\nActual Results:  \nn/a\n\nExpected Results:  \nn/aCreated attachment 277165\nAdds a new option for accessing non-public Java membersChecking in src/org/mozilla/javascript/Context.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\nnew revision: 1.259; previous revision: 1.258\ndone\nChecking in src/org/mozilla/javascript/ContextFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ContextFactory.java,v  <--  ContextFactory.java\nnew revision: 1.26; previous revision: 1.25\ndone\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\nnew revision: 1.66; previous revision: 1.65\ndone\nChecking in JavaAcessibilityTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/JavaAcessibilityTest.java,v  <--  JavaAcessibilityTest.java\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java,v\ndone\nChecking in PrivateAccessClass.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java,v  <--  PrivateAccessClass.java\ninitial revision: 1.1\n',?,IMPROVEMENT
392593,'Wrong type for arguments object',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.6) Gecko/20060601 Firefox/2.0.0.6 (Ubuntu-edgy)\nBuild Identifier: \n\nThe \"arguments\" object available within function execution should be a \"normal\" object not an own type.\n\nThis leads currently to errors for instance for typeof or toString() (see unit test in attached patch)\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.\n\n\n\n[seems I can\'t attach a patch here. I try to open the issue first and attach then]Created attachment 277086\nPatch for arguments object including unit testany comment on bug and provided patch?Could you point out why is the current behaviour a problem?\n\nExtracted from the unit test in the provided patch;\n\n// 1: Rhino fails here as it returns Arguments\nfunction f() {\n  var t = typeof arguments;\n  if (t != \'object\') throw \'Failed: got \' + t;\n}\nf();\n\n// 2: Rhino fails here too. Again \"Arguments\" where it should be \"Object\"\n\nfunction f() {\n  var t = arguments.toString();\n  if (t != \'[object Object]\') throw \'Failed: got \' + t;\n}\nf();\nAh, okay, ECMA-262 section 10.1.8 actually prescribes:\n\n\"The value of the internal [[Prototype]] property of the arguments object is the original Object \nprototype object, the one that is the initial value of Object.prototype\"\n\nSo this is indeed a bug against the ECMA spec.Your patch changes it from IdScriptableObject to NativeObject, but doesn\'t address the problem that \"callee\", \"length\", and \"caller\" were provided on the arguments object via the IdScriptableObject mechanism.Isn\'t this already handled because NativeObject extends IdScriptableObject? (I haven\'t checked)Created attachment 298637\nProposed patch\n\nIn my testing Rhino only fails \"// 2\" on comment #4. \n\nThe expression \n\n(function () { return arguments.__proto__ === Object.prototype; })() \n\nis true on both Rhino and SpiderMonkey, so I\'m hoping the attached patch is sufficient to fix this. Comments?Norris, I\'ll show my ignorance of some of the Rhino implementation here, but is it safe to further subclass a class that is already subclassing IdScriptableObject? Will the IDs from the superclass (NativeObject) coexist peacefully with IDs in the subclass (Arguments)?The problem is the usage models are different. \"Object\" has a constructor and defines a prototype, but \"arguments\" is an object that has Object.prototype as its prototype. So we don\'t want all the NativeObject features in this case.\n\nNorris, your patch seems ok to me. \n\nI don\'t remember how I got the failing result for \"// 1\" on comment #4, it\'s long ago. No matter.Committed my patch:\n\nChecking in src/org/mozilla/javascript/Arguments.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Arguments.java,v  <--  Argu\nments.java\nnew revision: 1.32; previous revision: 1.31\ndoneCool!\n\nAnd the unit test?Created attachment 300005\necma/ExecutionContexts/10.1.8-3.js\n\nProposed test for typeof arguments.Comment on attachment 300005\necma/ExecutionContexts/10.1.8-3.js\n\nflipping type so it can be viewed.Comment on attachment 300005\necma/ExecutionContexts/10.1.8-3.js\n\n>\n>var SECTION = \"10.1.8-2\";\n>var VERSION = \"ECMA_1\";\n>startTest();\n>var TITLE   = \"Arguments Object\";\n>\n>var expected = \"object\";\n>var actual = (function () { return typeof arguments; })();\n>reportCompare(expected, actual, \"typeof arguments == object\");\n>\n>writeHeaderToLog( SECTION + \" \"+ TITLE);\n\nnit: move the writeHeaderToLog to just below the var TITLE.  r+ with that.Change made, test committed to cvs. Thanks for the quick review!',?,DESIGN_DEFECT
392825,'ClassShutter doesn\'t prevent access through Java reflection APIs',Rhino,Core,norrisboyd,norrisboyd,'In my application users can write there own scripts for calculation\npurposes. In order to prepare them a set of basic functionality (read\nout of db or something like that) I wrote some java classes. At java\nside, I put an object of these classes to the scope in each case. My\nproblem is, that the user has the possibility to create new objects of\nany class he likes.\n\nTo avoid that the user imports java packages inside a script I did the\nfollowing:\n\nScriptableObject.deleteProperty(scope, \"Packages\");\nScriptableObject.deleteProperty(scope, \"java\");\nScriptableObject.deleteProperty(scope, \"JavaImporter\");\n\nAdditionally, I defined a ClassShutter object, implementing its only\nmethod like\n\npublic boolean visibleToScripts(String fullClassName) {\n        return false;\n\n}\n\nand setting this via\n\nContext cx = Context.enter();\ncx.setClassShutter(new MyClassShutter());\n\nBut there is still one problem remaining.\n\nEverything works fine except when the user uses statements in his\nscript like\n\nmyObj.getClass().getClassLoader().loadClass(\"path.to.some.package.MyClass\").newInstance();\n\nwhere myObj is a object I put in the scope.\nIn that case - unlike statements like \"new\nPackages.some.package.MyClass()\" - MyClassShutter is never asked and\nso, there is a big security leakage!\n\nDoes anyone know how I could avoid that? I simply want the user not to\nbe allowed to load or use any other object unless the ones I put in the\nscope for him.\n\nRegards,\nMatthiasFixed:\n\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  Ja\nvaMembers.java\nnew revision: 1.62.2.1.2.1; previous revision: 1.62.2.1\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properti\nes,v  <--  Messages.properties\nnew revision: 1.70.2.1.2.1; previous revision: 1.70.2.1\ndone\n\nTest case demonstrating correct behavior with fix:\n\n[rhino] cat testShutter.js\nvar prohibited = arguments[0]; // script argument\nvar shutter = new Packages.org.mozilla.javascript.ClassShutter({\n  visibleToScripts: function(name) {\n    var result = name != prohibited;\n    print(\"visibleToScripts(\"+name+\") = \"+result);\n    return result;\n}});\nshutter.visibleToScripts(\"myTest\");\nvar cx = Packages.org.mozilla.javascript.Context.getCurrentContext();\ncx.setClassShutter(shutter);\n\nvar s = new java.lang.String(\'hi\');\nvar obj = s.getClass().getClass().forName(\"java.lang.SecurityManager\").newInstan\nce();\n[rhino] java -jar build/rhino1_6R7/js.jar testShutter.js\nvisibleToScripts(myTest) = true\nvisibleToScripts(java.lang.String) = true\nvisibleToScripts(java.lang.Class) = true\nvisibleToScripts(java.lang.SecurityManager) = true\n[rhino] java -jar build/rhino1_6R7/js.jar testShutter.js java.lang.SecurityMana\nger\nvisibleToScripts(myTest) = true\nvisibleToScripts(java.lang.String) = true\nvisibleToScripts(java.lang.Class) = true\nvisibleToScripts(java.lang.SecurityManager) = false\njs: Access to Java class \"java.lang.SecurityManager\" is prohibited.\njs: org.mozilla.javascript.EvaluatorException: Access to Java class \"java.lang.S\necurityManager\" is prohibited.',?,DESIGN_DEFECT
393785,'Incorrect strict mode warnings for undefined properties',Rhino,Compiler,norrisboyd,norrisboyd,'From mozilla.dev.tech.js-engine:\n\nI am trying to use the FEATURE_WARNING_AS_ERROR flag, and in general\nit is helping me avoid common errors. One thing I can\'t figure out is\nthis error:\n\nReferenced to undefined property \"times\" (file:/data/tomcat/webapps/\nmyna/shared/js/profiler.js#107)\n\n106:       var my = arguments.callee;\n107:       if (!my.times) my.times = {}\n108:       var curLabel = element.label;\n\nThe other common variants cause the same error:\nif (my.times === undefined)\nif (typeof my.times === \'undefined\') \n\nFor comparison, Here\'s SpiderMonkey\'s behavior:\n\njs> if (o.foo) print(3)\njs> if (o.foo == \"undefined\") print(3)\ntypein:4: strict warning: reference to undefined property o.foo\njs> if (typeof o.foo == \"undefined\") print(3)\n3Fixed in Rhino, which now suppresses warnings for undefined property o.p for the following constructs: \ntypeof o.p, if (o.p), if (!o.p), if (o.p == undefined), if (undefined == o.p)\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.332; previous revision: 1.331\ndone\nChecking in src/org/mozilla/javascript/NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.74; previous revision: 1.73\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.275; previous revision: 1.274\ndone\nChecking in src/org/mozilla/javascript/Token.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Token.java,v  <--  Token.java\nnew revision: 1.43; previous revision: 1.42\ndone\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.255; previous revision: 1.254\ndone\nChecking in src/org/mozilla/javascript/optimizer/OptTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/OptTransformer.java,v  <--  OptTransformer.java\nnew revision: 1.32; previous revision: 1.31\ndone\n',?,CLEANUP
393794,'__proto__ not set when used in object literal',Rhino,Core,neilmix,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.6) Gecko/20070725 Firefox/2.0.0.6\nBuild Identifier: \n\nvar x = { foo: \"bar\" }\nvar y = { __proto__: x };\ny.foo; // should be \"bar\", but is undefined\n\nI believe this is fixed with a simple edit to ScriptRuntime.java, line 3297:\n\n    if (isSpecialProperty((String)id)) {\n        specialRef(object, (String)id, cx).set(cx, value);\n    } else {\n        ScriptableObject.putProperty(object, (String)id, value);\n    }\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Checking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.309; previous revision: 1.308\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/393794.doctest,v\ndone\nChecking in testsrc/doctests/393794.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/393794.doctest,v  <--  393794.doctest\ninitial revision: 1.1\ndone',?,BUG
393848,'Need better error message for methods that exceed 64K',Rhino,Compiler,norrisboyd,norrisboyd,'From newsgroup:\n\nUsing Rhino to compile a big JS script to .class file, at the run time, I\'ve got below exception.\nSomeone said that it occurs when a too big javascript file is given to Rhino.\nAny solution?\n\nrhino-run:\n     [java] Exception in thread \"main\" java.lang.ClassFormatError: Invalid method Code length 83259 in class file com/sun/lzplayer/Precompiled_JS_Runtime\n     [java]     at java.lang.ClassLoader.defineClass1(Native Method)\n     [java]     at java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n     [java]     at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)\n     [java]     at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)\n     [java]     at java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n     [java]     at java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n     [java]     at java.security.AccessController.doPrivileged(Native Method)\n     [java]     at java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n     [java]     at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n     [java]     at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)\n     [java]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)\n     [java]     at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n     [java]     at java.lang.Class.forName0(Native Method)\n     [java]     at java.lang.Class.forName(Class.java:164)\n     [java]     at org.mozilla.javascript.tools.shell.Global.getClass(Global.java:296)\n     [java]     at org.mozilla.javascript.tools.shell.Global.loadClass(Global.java:273)\n     [java]     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n     [java]     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n     [java]     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n     [java]     at java.lang.reflect.Method.invoke(Method.java:585)\n     [java]     at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:145)\n     [java]     at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:408)\n     [java]     at org.mozilla.javascript.optimizer.OptRuntime.callName(OptRuntime.java:97)\n     [java]     at org.mozilla.javascript.gen.c1._c0(/home/openlaszlo/orbit/build/gen/run.js:2)\n     [java]     at org.mozilla.javascript.gen.c1.call(/home/openlaszlo/orbit/build/gen/run.js)\n     [java]     at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:340)\n     [java]     at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2758)\n     [java]     at org.mozilla.javascript.gen.c1.call(/home/openlaszlo/orbit/build/gen/run.js)\n     [java]     at org.mozilla.javascript.gen.c1.exec(/home/openlaszlo/orbit/build/gen/run.js)\n     [java]     at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:503)\n     [java]     at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:425)\n     [java]     at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:391)\n     [java]     at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:382)\n     [java]     at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n     [java]     at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n     [java]     at org.mozilla.javascript.Context.call(Context.java:528)\n     [java]     at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:450)\n     [java]     at org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n     [java]     at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\n     [java] Java Result: 1\n\nThank you in advance,\nHyok \n--------------\n\nNeed a better error message for this case.Created attachment 278400\nbig.js - a test case\n\nAttaching test caseCreated attachment 278401\npatch for better error report\n\nPossible patch for bug.Fixed (in a different approach than patch):\n\nChecking in src/org/mozilla/classfile/ClassFileWriter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/classfile/ClassFileWriter.java,v  <--  ClassFileWriter.java\nnew revision: 1.45; previous revision: 1.44\ndone\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.254; previous revision: 1.253\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.82; previous revision: 1.81\ndone\n',?,CLEANUP
396117,'getParamOrVarConst: compatibility with previous version',Rhino,Compiler,biehlmann,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; InfoPath.2; .NET CLR 2.0.50727)\nBuild Identifier: Rhino 1.6R7\n\nabstract class NativeFunction declare the following abstract method\nprotected abstract boolean getParamOrVarConst(int index);\nwhich was not defined in previous versions (1.R5 and before)\nso any \"compiled\" code with version up to 1.R5 failed when running with version 1.R6 and after with the error \"java.lang.AbstractMethodError: org.mozilla.javascript.NativeFunction.getParamOrVarConst(I)Z\"\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. compile a script with version 1.R5 and below\n2. save the result in a file\n3. replace the js.jar with a version 1.R6 or above\n4. load the file saved in step 2, and try to execute\nActual Results:  \nfailed with error \"java.lang.AbstractMethodError: org.mozilla.javascript.NativeFunction.getParamOrVarConst(I)Z\"\n\n\nExpected Results:  \ncompatibiliy of \"compiled code\"\n\nnot declare getParamOrVarConst(int index); as an abstract method but just as a protected methodFixed in CVS HEAD:\n\n    Checking in src/org/mozilla/javascript/NativeFunction.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeFunction.java,v  <--  NativeFunction.java\n    new revision: 1.68; previous revision: 1.67\n    done\n',?,SPEC
396700,'Array.map inconsistent behavior when called with 2 arguments',Rhino,Core,dr.bobik+mozdev,nobody,'User-Agent:       Mozilla/5.0 (compatible; Konqueror/3.5; Linux) KHTML/3.5.6 (like Gecko) (Kubuntu)\nBuild Identifier: Rhino 1.6 release 7\n\nArray.map when called with two arguments, the second being an empty string, ignores the second argument and uses the `this\' object of the current scope instead. \nThis doesn\'t happen when the second argument is either an empty array ([]) or (new String(\'\')), and is inconsistent with the code on http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Global_Objects:Array:map#Compatibility\n\n\nReproducible: Always\n\nSteps to Reproduce:\njs> [0].map( function(){return this.toString();}, \'\');\n\n\nActual Results:  \n-> prints [object global]\n\nExpected Results:  \nshould return a 1 element array containing the empty string (prints as empty string, but may be verified by attaching a call to toSource() )\n\njs> [0].map( function(){return this.toSource();}, []);\n-> prints [] (correctly)\n\njs> [0].map( function(){return this.toSource();}, new String(\'\'));\n-> prints (new String(\"\")) (also correctly)Spidermonkey (JavaScript-C 1.6 pre-release 1 2006-04-04) does behave correctly, as described above.Fixed in CVS HEAD -- had to pass the thisObj argument through ScriptRuntime.toObject() to make sure primitives get promoted to object.\n\n    Checking in src/org/mozilla/javascript/NativeArray.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\n    new revision: 1.75; previous revision: 1.74\n    done\nAttila, \n\nAfter this change we\'re now getting a failure with the code\n\nArray.prototype.some.call(\"foobar\", function(c) {return c == \'x\'}, undefined)\n\nwhich results in \"false\" for SpiderMonkey, but results in the error \n\nuncaught JavaScript runtime exception: TypeError: Cannot convert undefined to an object.\n\nfor Rhino.Fixed: \n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.77; previous revision: 1.76\ndone\n',?,SPEC
396900,'can\'t do destructuring bind in a let',Rhino,Compiler,norrisboyd,norrisboyd,'Executing\n\n   let ([x, y] = [3, 4]) {}\n\nresults in\n\njava.lang.IllegalStateException: FAILED ASSERTION\n    at org.mozilla.javascript.Kit.codeBug(Kit.java:480)\n    at org.mozilla.javascript.NodeTransformer.visitLet(NodeTransformer.java:420)\n    at org.mozilla.javascript.NodeTransformer.transformCompilationUnit_r(NodeTransformer.java:293)\n    at org.mozilla.javascript.NodeTransformer.transformCompilationUnit(NodeTransformer.java:85)\n    at org.mozilla.javascript.NodeTransformer.transform (NodeTransformer.java:63)\n    at org.mozilla.javascript.Interpreter.compile(Interpreter.java:482)\n    at org.mozilla.javascript.Context.compileImpl(Context.java:2355)\n    at org.mozilla.javascript.Context.compileString (Context.java:1360)\n    at org.mozilla.javascript.Context.compileString(Context.java:1349)\n    at com.google.gse.rnr.util.shell.Main.loadScriptFromSource(Main.java:437)\n    at com.google.gse.rnr.util.shell.Main.processSource (Main.java:363)\n    at com.google.gse.rnr.util.shell.Main.processFiles(Main.java:179)\n    at com.google.gse.rnr.util.shell.Main$IProxy.run(Main.java:100)\n    at org.mozilla.javascript.Context.call(Context.java:588)\n    at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:506)\n    at com.google.gse.rnr.util.shell.Main.exec(Main.java:162)\n    at com.google.gse.rnr.util.shell.Main.main(Main.java:140)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke (Method.java:597)\n    at com.google.gse.rnr.util.console.main(console.java:59)\nException in thread \"main\" java.lang.reflect.InvocationTargetException\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke (Method.java:597)\n    at com.google.gse.rnr.util.console.main(console.java:59)\nCaused by: java.lang.IllegalStateException: FAILED ASSERTION\n    at org.mozilla.javascript.Kit.codeBug(Kit.java:480)\n    at org.mozilla.javascript.NodeTransformer.visitLet (NodeTransformer.java:420)\n    at org.mozilla.javascript.NodeTransformer.transformCompilationUnit_r(NodeTransformer.java:293)\n    at org.mozilla.javascript.NodeTransformer.transformCompilationUnit(NodeTransformer.java :85)\n    at org.mozilla.javascript.NodeTransformer.transform(NodeTransformer.java:63)\n    at org.mozilla.javascript.Interpreter.compile(Interpreter.java:482)\n    at org.mozilla.javascript.Context.compileImpl(Context.java :2355)\n    at org.mozilla.javascript.Context.compileString(Context.java:1360)\n    at org.mozilla.javascript.Context.compileString(Context.java:1349)\n    at com.google.gse.rnr.util.shell.Main.loadScriptFromSource( Main.java:437)\n    at com.google.gse.rnr.util.shell.Main.processSource(Main.java:363)\n    at com.google.gse.rnr.util.shell.Main.processFiles(Main.java:179)\n    at com.google.gse.rnr.util.shell.Main$IProxy.run(Main.java :100)\n    at org.mozilla.javascript.Context.call(Context.java:588)\n    at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:506)\n    at com.google.gse.rnr.util.shell.Main.exec(Main.java:162)\n    at com.google.gse.rnr.util.shell.Main.main(Main.java:140)\n    ... 5 more+bclary: This is a test case not covered by the current JavaScript tests\n\nFixed:\n\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.javanew revision: 1.67; previous revision: 1.66\ndone\nChecking in src/org/mozilla/javascript/NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.76; previous revision: 1.75\ndone\n/cvsroot/mozilla/js/tests/js1_7/block/regress-396900.js,v  <--  regress-396900.js\ninitial revision: 1.1\n',?,BUG
397035,'Incorrect behavior for destructuring assignment in Iterator',Rhino,Compiler,norrisboyd,norrisboyd,'I\'m going through the examples on the mozdev site.\nThis seems like it should work:\n\njs> var obj = { width: 3, length: 1.5, color: \"orange\" };\njs> for (let [name, value] in Iterator(obj)) { print(\"name: \" + name + \", value: \" + value)}\n\nIt\'s based on the example in \"Looping across objects\".  It doesn\'t ever execute the block. Same behavior if you leave out the Iterator() call and just say:\n\nfor (let [name, value] in obj) {...}Fixed:\n\nChecking in NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.77; previous revision: 1.76\ndone\n',?,SPEC
397036,'NPE with FEATURE_ENHANCED_JAVA_ACCESS',Rhino,Core,norrisboyd,norrisboyd,'Turning on FEATURE_ENHANCED_JAVA_ACCESS breaks a bunch\nof our unit tests; they\'re generally failing on line ScriptableObject:1483\n-- obj.getParentScope() is throwing a NullPointerException.\n\nI\'ve been trying to isolate the failure cases, since the exception tends\nto be thrown in fairly complex code.  The first one I found is this:\n\njs> new java.io.File(\'\').getClass().getMethods()\n[Ljava.lang.reflect.Method;@f894ce\n\nYou can call getMethods() on the class object returned by getClass(),\nbut with FEATURE_ENHANCED_JAVA_ACCESS, it can\'t find the\ngetMethods() method:\n\njs> new java.io.File(\'\').getClass().getMethods()\njs: \"<stdin>\", line 2: uncaught JavaScript runtime exception: TypeError: Cannot find function getMethods.What was going on was a java.lang.SecurityException: \"Can not make a java.lang.Class constructor accessible\" was getting thrown. So I\'ve restructured the new code for dealing with getting access to privates to handle SecurityExceptions and just use accessible members.\n\nI ran with Context.FEATURE_ENHANCED_JAVA_ACCESS set to true over the regression suite and it turned up a set of cases where a NPE was thrown because a bad scope object was passed down from ScriptRuntime.newCatchScope. I fixed that and tightened up the case where a ClassCache isn\'t found (which was what was happening with the invalid scope that later resulted in the NPE. \n\nFixed:\n\nChecking in src/org/mozilla/javascript/ClassCache.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ClassCache.java,v  <--  ClassCache.java\nnew revision: 1.16; previous revision: 1.15\ndone\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\nnew revision: 1.68; previous revision: 1.67\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <-- ScriptRuntime.java\nnew revision: 1.277; previous revision: 1.276\ndone\n',?,BUG
397497,'File example compiler warning for Vector/Generics',Rhino,Core,petermichaux,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.7) Gecko/20070914 Firefox/2.0.0.7\nBuild Identifier: \n\nLine 141 is\n\n        Vector v = new Vector();\n\nand for Java 1.5 should be\n\n\n        Vector<String> v = new Vector<String>();\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Fixed',?,CLEANUP
397680,'Need to support Context.observeInstructionCount for compiled mode',Rhino,Compiler,norrisboyd,nobody,'from mozilla.dev.tech.js-engine:\n\n> 3. stopping the script in higher optimized code is impossible under\n> the current rhino conditions. I can use the Thread.stop() method but\n> am reluctant to do so as it is unsafe. Is it possible to have a stop()\n> or interrupt() function to stop execution of a malicious script thats\n> running in highly optimized  context ?\n\nYou\'re right that this is a feature request and a good one. The right\nway to do this is to implement Context.observeInstructionCount for\ncompiled mode. There would need to be some way to indicate to the\ncompiler that you\'d like to observe the count, and then compile in\ncallbacks from the generated Java classes at key points (backwards\njumps, function returns) that increment a counter by some value that\napproximates the count of executed Java instructions. The runtime\ncould then monitor these like is already done for interpreted scripts.http://groups.google.com/group/mozilla.dev.tech.js-engine/browse_thread/thread/3211633206991a7eCreated attachment 283434\nA Patch for Codegen.java\n\nthe function addInstructionCount adds a call in the compiled call to ScriptRuntime to append the number of instructions that is appropriateCreated attachment 283435\nPatch to ScriptRuntime.java\n\nAdded the function that is being called by the compiled class - and adds the instruction count that is given by the argument.Created attachment 283437\nPAtch to compilerEnviros.javaCreated attachment 283438\nPAtch to Context.javaI changed the approach a bit and added some additional supporting code. \n\nCommitted:\n\nChecking in src/org/mozilla/javascript/CompilerEnvirons.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/CompilerEnvirons.java,v  <--  CompilerEnvirons.java\nnew revision: 1.17; previous revision: 1.16\ndone\nChecking in src/org/mozilla/javascript/Context.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\nnew revision: 1.261; previous revision: 1.260\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.278; previous revision: 1.277\ndone\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.256; previous revision: 1.255\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/jsc/Main.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/jsc/Main.java,v  <--  Main.java\nnew revision: 1.14; previous revision: 1.13\ndone\nChecking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.32; previous revision: 1.31\ndone\n',?,RFE
397882,'Array.forEach incompatibility',Rhino,Core,dr.bobik+mozdev,nobody,'User-Agent:       Mozilla/5.0 (compatible; Konqueror/3.5; Linux) KHTML/3.5.6 (like Gecko) (Kubuntu)\nBuild Identifier: Rhino 1.6 release 7 2007 08 30\n\nThe behavior differs from that specified in http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Global_Objects:Array:forEach#Description\nas well as from what spidermonkey does, in the case when the array contains undefined elements.\n\nReproducible: Always\n\nSteps to Reproduce:\njs> var a = (new Array(2)); a.forEach( function (e, i, a) { a[i] = i; } ); a.toSource();\n\n\nActual Results:  \nprints [0, 1]\n\nExpected Results:  \nthe array should consist of two undefined elements, as per the documentation and consistently with spidermonkey.Fixed in CVS HEAD:\n\n    Checking in src/org/mozilla/javascript/NativeArray.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\n    new revision: 1.74; previous revision: 1.73\n    done\n',?,SPEC
398450,'Update test to handle Rhino errors',Rhino,Compiler,norrisboyd,bclary,'Created attachment 283420\nPatch for test\n\njs1_7/block/regress-352616.js needs to be updated to handle Rhino as well as SpiderMonkey error messages./cvsroot/mozilla/js/tests/js1_7/block/regress-352616.js,v  <--  regress-352616.js\nnew revision: 1.2; previous revision: 1.1\n',?,TEST
399347,'The JSC and Shell tools choke on UTF-8 BOM',Rhino,Core,robert.flaherty,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.1)\nBuild Identifier: 1.6R7\n\nSeveral places in the code use classes/constructors for URL/file streams/readers which use the default encoding.  I think specs at least default to UTF-8, or if not (in the case of IE) only do UTF-8.  Anyway, here are the things to search on which will get you to the offending areas:\n\n- \"new FileReader\", drop use of this class totally\n- \"new InputStreamReader\", always pass in an encoding\n- \"Kit.readStream\", check the use of what gets passed in and returned\n- \"Kit.readReader\", check the use of what gets passed in and returned\n\nExample changes I had to make (jsc/Main, shell/Main, shell/Global):\n- \"new FileReader(f)\" to \"new InputStreamReader(new FileInputStream(f), \"UTF-8\")\"\n- \"new InputStreamReader(is)\" to \"new InputStreamReader(is, \"UTF-8\")\"\n- \"result = new String(data)\" to \"result = new String(data, \"UTF-8\")\"\n\nI would assume a good behavior across all of Rhino would be to try to get an encoding from the charset header when a URL is used.  If that doesn\'t exist or it is a file, default to UTF-8.  I didn\'t go the distance in shell/Main.readFileOrUrl to parse the Content-Type header if its\' a URL, but the comment \"XXX: Use \'charset=\' argument of Content-Type if URL?\" alludes to this already.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Create any JS file in Notepad and save as UTF-8.\n2. Run JSC and Shell on it.\n3.\nActual Results:  \nBoth will choke saying that they encountered an illegal character.\n\nExpected Results:  \nClean parse.You\'re referring to RFC 4329, right? Yes, this is justified -- I can see how we\'d want to be conformant with that... However, we need to think about some additional implications though first. I\'m late for my morning gym, but will elaborate more in few hours.Okay. So, we have the following cases:\n\n1. Source message has explicit charset parameter in its Content-type. We use the explicit charset. No-brainer.\n\n2. Source message has Content-type application/javascript or application/ecmascript. We use the RFC 4329 section 4.2. \"Character Encoding Scheme Detection\" to detect the charset.\n\n3. Source message has Content-type text/javascript or text/ecmascript. I have no idea what to do here. RFC 4329 7.1 and 8.1 both say \"Encoding considerations: The same as the considerations in section 3.1 of [RFC3023].\" RFC 3023 is the XML media types RFC, I happen to know this one rather well. In section 3.1 it says:\n\n--- quote ---\nConformant with [RFC2046], if a text/xml entity is received with the charset parameter omitted, MIME processors and XML processors MUST use the default charset value of \"us-ascii\"[ASCII].  In cases where the XML MIME entity is transmitted via HTTP, the default charset value is still \"us-ascii\". (Note: There is an inconsistency between this specification and HTTP/1.1, which uses ISO-8859-1[ISO8859] as the default for a historical reason. Since XML is a new format, a new default should be chosen for better I18N. US-ASCII was chosen, since it is the intersection of UTF-8 and ISO-8859-1 and since it is already used by MIME.)\n--- quote ends ---\n\nSo, we have several strategies for text/* content type. We can assume us-ascii, (RFC 3023 would mandate we do that) we can assume ISO-8859-1 in case the URL scheme is http or https, or we can assume UTF-8. Since text/javascript and text/ecmascript content types are obsoleted anyway, I\'d suggest we fall back on us-ascii when we encounter these content types without an explicit charset. I believe that\'s the intent of RFC 3023 (and of RFC 4329 too, since it delegates to it).\n\n4. Source has no associated content type (i.e. comes from a local file from a filesystem that has no concept of content types). I\'d say this should be left to the application, and provide Rhino API for app to specify the content type and/or charset. \n\nIn the special case where the application is either jsc or shell, we just assume application/javascript to be the content type when file extension is .js and application/ecmascript when the file extension is .es, and maybe introduce a \"-encoding\" command line switch (similar to the one javac has) for explicitly specifying a different charset.\n\nHow does all of this sound?Ok, I added the following functionality to Rhino shell:\n\n1. An -enc command line argument, i.e. \"-enc utf-8\" is now supported to specify default encoding.\n2. When source is read from an URL and it has a \";charset=\" declaration in Content-type, that is used.\n3. When source is read from an URL without charset declaration in content type, or is read from a local file, then RFC 4329 4.2.2. logic is used to automatically recognize UTF-32LE, UTF-32BE, UTF-8, UTF-16LE, and UTF-16BE encodings.\n4. If no encodings can be automatically recognized, the command line \"-enc\" value is used, if it exists.\n5. If -enc does not exist, but the source is a URL and content type is application/*, UTF-8 is assumed\n6. If -enc does not exist, but the source is a URL and content type is text/*, US-ASCII is assumed\n7. In the remaining case (source is local file, no encoding was autodetected, and no -enc parameter was specified), we use file.encoding system property as the character encoding.\n\nConsole input is handled more simply:\n1. if there is -enc, it is used\n2. Otherwise, file.encoding system property is used as the character encoding.    Checking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\n    new revision: 1.36; previous revision: 1.35\n    done\n    RCS file: /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ParsedContentType.java,v\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/ParsedContentType.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ParsedContentType.java,v  <--  ParsedContentType.java\n    initial revision: 1.1\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java,v  <--  ShellContextFactory.java\n    new revision: 1.12; previous revision: 1.11\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\n    new revision: 1.77; previous revision: 1.76\n    doneAdditionally, shell no longer chokes on BOM:\n\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\n    new revision: 1.78; previous revision: 1.77\n    done\n\nI still need to look into adding the same smarts to jsc.Okay, I extracted intelligent character encoding handling into a separate class used by both shell and jsc.\nI also added -encoding switch to jsc, and renamed it from -enc to -encoding in shell too. The reason is that javac uses \"-encoding\" as well.\n\n    Checking in toolsrc/org/mozilla/javascript/tools/jsc/Main.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/jsc/Main.java,v  <--  Main.java\n    new revision: 1.16; previous revision: 1.15\n    done\n    RCS file: /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/SourceReader.java,v\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/SourceReader.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/SourceReader.java,v  <--  SourceReader.java\n    initial revision: 1.1\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\n    new revision: 1.37; previous revision: 1.36\n    done\n    Checking in toolsrc/org/mozilla/javascript/tools/shell/Main.java;\n    /cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java,v  <--  Main.java\n    new revision: 1.79; previous revision: 1.78\n    done',?,IMPROVEMENT
399348,'Improve performance of NativeArray methods using dense representation',Rhino,Core,norrisboyd,nobody,'I\'ve been looking a little at John Resig\'s JavaScript speed tests (http://ejohn.org/apps/speed/). Rhino could do better on a number of those tests. Yesterday I checked in a change to Rhino that improves the performance of Array.prototype.shift on those tests by a factor of 755! \n\nThe change I made is relatively simple. Previously all array operations were implemented in terms of abstract getters and setters that looked up each element in either a dense Object[] array or in the normal JavaScript hashtables. I changed the previous dense array storage to grow for dense allocation patterns and then I added specialized implementations of some of the Array built-in functions, including shift. Here\'s the new shift code:\n\n    private static Object js_shift(Context cx, Scriptable thisObj,\n                                   Object[] args)\n    {\n        if (thisObj instanceof NativeArray) {\n            NativeArray na = (NativeArray) thisObj;\n            if (na.denseOnly && na.length > 0) {\n                synchronized (na) {\n                    na.length--;\n                    Object result = na.dense[0];\n                    System.arraycopy(na.dense, 1, na.dense, 0, (int)na.length);\n                    na.dense[(int)na.length] = NOT_FOUND;\n                    return result;\n                }\n            }\n        }\n        // pre-existing code that handles elements in either dense or hashtable...\n\nSo now for most array usages the shift is performed using System.arraycopy as it should be rather than a loop over a set of gets and puts. \n\nThat\'s great, you say, but why are you posting? I\'m looking for volunteers to convert these remaining methods of NativeArray:\n\n     *      toStringHelper\n     *      js_join\n     *      js_reverse\n     *      js_sort\n     *      js_splice\n     *      js_concat\n     *      indexOfHelper\n     *      iterativeMethod(In reply to comment #0)\n>      *      js_join\n\nHere goes js_join and js_sort is coming.\nCreated attachment 284447\njs_joinCreated attachment 284456\nTest case results from running with first patch\n\nRegression tests had a few failures (see attached). I don\'t know if it\'s related, but you should check the \"denseOnly\" boolean variable before doing the specialized dense code. Then you can just use NativeArray\'s length property and avoid calling getLengthProperty. \n\nIn addition to undefined, you should also compare against NOT_FOUND, which is a special value meaning the key is not defined.\n\nThen you should be able to accumulate your results in a StringBuilder, which will avoid all the object creation overhead of having partial results in String objects.\n\nThanks!Created attachment 284474\n2nd attempt\n\nFigured how to run the tests ;-)\n\ndenseOnly wasn\'t involved: dense being null on large array creation was the cause.\n\nI didn\'t change the string building yet. StringBuilder is Java 5, is it ok to use it?(In reply to comment #4)\n> I didn\'t change the string building yet. StringBuilder is Java 5, is it ok to\n> use it?\n\nGood catch, thank you. We\'re continuing to support JDK 1.4 for a while longer, so you\'re right not to use StringBuilder.\n\nI did change to use StringBuffer. Change committed:\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.71; previous revision: 1.70\ndone\nAlternatively, we can use retrotranslator. \n\nI can set up our build.xml so that we create both a js.jar for use with JDK 1.5 and above, and an alternative js-14.jar that is js.jar treated with retrotranslator. Retrotranslator operates on a bytecode level, provides a JDK 1.4 replacement for 1.5 core JDK classes and methods, and replaces references to them to references to its private replacements of them.\n\nWe\'re following this practice with FreeMarker 2.4 as well, and for now it seems to work like charm, see <http://retrotranslator.sourceforge.net/>\n\nWhat do you think? I\'d love to be able to use 1.5! Go for it.Created attachment 284603\njs_sort\n\nA minimal js_sort for denseOnly NativeArrays. (I\'d like to investigate whether using Arrays.sort would be faster.)\n\njs_splice is near ready (I\'m benchmarking it).Created attachment 284620\njs_splice\n\nsplice is now 55x faster (according to js-speed tests \"Array (de)construction, splice\") bringing it on par with shift/unshift.\n\nArray Construction, []:16384:0:4.85:0:156:17.442184438303535\nArray Construction, new Array():16384:0:1.41:0:32:5.049442413461974\nArray Construction, push:16384:203:213.2659574468085:187:329:29.35513932835981\nArray Deconstruction, pop:128:219:219.42391304347825:187:312:20.135384466077408\nArray Construction, unshift:128::63375:63375:63375:NaN\nArray Deconstruction, shift:128::61829:61829:61829:NaN\nArray Construction, splice:128::63000:63000:63000:NaN\nArray Deconstruction, splice:128::62375:62375:62375:NaN\nArray Construction, []:32768:0:0.62:0:16:3.0543229837214154\nArray Construction, new Array():32768:0:0.47:0:16:2.687250105835542\nArray Construction, push:32768:203:205.6734693877551:187:250:20.124240658123316\nArray Deconstruction, pop:256:203.5:209.46875:156:234:9.781780189935292\nArray Construction, unshift:256::62641:62641:62641:NaN\nArray Deconstruction, shift:256::63344:63344:63344:NaN\nArray Construction, splice:256::62890:62890:62890:NaN\nArray Deconstruction, splice:256::65640:65640:65640:NaN\nArray Construction, []:65536:0:0.63:0:16:3.1031264781497288\nArray Construction, new Array():65536:0:0.31:0:16:2.1820896295787557\nArray Construction, push:65536::207.95876288659792:187:250:20.186586679945226\nArray Deconstruction, pop:512::211.02105263157895:141:235:10.880373651445652\nArray Construction, unshift:512::63219:63219:63219:NaN\nArray Deconstruction, shift:512::62781:62781:62781:NaN\nArray Construction, splice:512::63297:63297:63297:NaN\nArray Deconstruction, splice:512::64734:64734:64734:NaN\nArray Construction, []:131072:0:0.47:0:16:2.687250105835542\nArray Construction, new Array():131072:0:0.47:0:16:2.687250105835542\nArray Construction, push:131072::215.89247311827958:187:313:27.59665321768573\nArray Deconstruction, pop:1024::217.23655913978496:156:422:27.035563474424137\nArray Construction, unshift:1024::64438:64438:64438:NaN\nArray Deconstruction, shift:1024::66796:66796:66796:NaN\nArray Construction, splice:1024::63360:63360:63360:NaN\nArray Deconstruction, splice:1024::62875:62875:62875:NaNCommitted with some modifications; it appeared that \"Array Deconstruction, splice\" wasn\'t going through the dense path. Christophe, if you could review my changes it\'d be appreciated...\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.72; previous revision: 1.71\ndone\n\nOn my machine I got 754X speedup on splice with these changes.\n\n\"sort\" was only improved by 9\%, but that\'s probably because the bulk of the work was already done on a dense array even before the change. It would be interesting to see if Arrays.sort were faster.Created attachment 284666\nPerf test for sortCreated attachment 284747\nMisc changes on js_join and js_splice\n\nAbout js_sort: running your test I get a 2x-3x speed-up (running it directly into shell).Created attachment 284773\nsort now uses Arrays.sort instead of heapsort, 46\% speed-up (compared to my previous js_sort patch)\n\nSo, using Arrays.sort and a Comparator leads to better performance.\nNorris, I measured at last the 9\% improvement you previously mentioned (I figure another process skewed my previous runs).\nBut something is worrying me: 1.6R7 seems way faster (regarding Array.sort) than HEAD. Is it a build problem on my side?Created attachment 285486\njs_reverse for dense arrays\n\njs_reverse, 16x fasterCreated attachment 285487\ntest for js_reverseI had spare time to check-out 1.6R7 from the CVS and run Norris\' perf test for sort and now I\'m sure: there is a 2x slowdown between 1.6R7 and HEAD. I profiled several runs but to no avail (I think it\'s not specific to js_sort).\n\nIf you apply my second patch for js_sort you\'ll get an overall 2x faster sort which will only bring back HEAD on par with 1.6R7.\n\nI\'m still ready to work on the remaining methods. I\'ll take indexOfHelper (and iterativeMethod next) if nobody already took it.The 2x slowdown appears with rev 1.321 of Interpreter.java (when adding support for generators). Is the interpretLoop method now too large for some HotSpot optimisations to happen ?Thanks for tracking this down. What\'s the benchmark you\'re running to see the slowdown?Created attachment 285737\nBenchmark with which I got the slowdown\n\nIt\'s the benchmark you provided to me (I only reduced the number of iterations to make hunting the slowdown practical). On my machine it takes 5s with r1.320 and 10s with r1.321.(In reply to comment #18)\n> The 2x slowdown appears with rev 1.321 of Interpreter.java (when adding support\n> for generators). Is the interpretLoop method now too large for some HotSpot\n> optimisations to happen ?\n> \n\nThis is really weird. There\'s nothing apparent here that\'d trigger this sort of a slowdown. I don\'t think it\'s a HotSpot deficiency. It rather sounds like a CPU cache overflow. What CPU and OS are you testing on? Also, are you just switching Interpreter.java between runs, or moving the date timestamp of your whole local CVS copy to match those revisions?Pentium M 1.73GHz / XP SP 2 / Sun JDK 1.6\nI also thought about bad cache misses.\n\nWith the CVS HEAD I\'ve got the slowdown. Bringing back my whole working CVS copy down to 2007-06-06 I\'ve got the slowdown. One day earlier, hallelujah, \"full\" speed. So I diff\'d the two versions til I noticed that commenting out the three new cases in interpretLoop does the trick (or replacing Interpreter.java as a whole).\n\nFYI Intepreter.class is (1.320) 64372 bytes long and 66682 bytes long in 1.321... there\'s 64K in between...\n\n(In reply to comment #22)\n> Pentium M 1.73GHz / XP SP 2 / Sun JDK 1.6\n> I also thought about bad cache misses.\n\nAny idea what\'s your CPU L1 and L2 cache size?\n\n> With the CVS HEAD I\'ve got the slowdown. Bringing back my whole working CVS\n> copy down to 2007-06-06 I\'ve got the slowdown. One day earlier, hallelujah,\n> \"full\" speed. So I diff\'d the two versions til I noticed that commenting out\n> the three new cases in interpretLoop does the trick (or replacing\n> Interpreter.java as a whole).\n> \n> FYI Intepreter.class is (1.320) 64372 bytes long and 66682 bytes long in\n> 1.321... there\'s 64K in between...\n\nYep, although that shouldn\'t matter, really. There\'s a limitation that a single method can\'t exceed 64K in bytecode, but that\'s all... Okay, I\'ll try to run the tests on hardware available to me: a MacBook Pro with Intel Core Duo and an iMac G5 -- two radically different architectures. Will be curious what\'ll happen.L1: 32kB/32kB (instruction/data)\nL2: 2MB\n\nI just tried to take Interpreter.java 1.321 and to extract some methods from somes cases of the big switch in interpretLoop... And I get the good perfs.\n\nI just ran the test on AMD Turion X2 TL-56 (L1 : 2x128k; L2 : 2x512k) / Vista + JRE 1.6:\nwith 1.7pre1 and 1.6R7 from ftp.mozilla.org: 1.7 is 4x slower (14s vs 3.5s) than 1.6r7!Running the jvm in interpreter mode (java -Xint) results in 1.7pre1 being faster than 1.6R7. It may be a CPU instruction cache problem: is the jitted code inside the loop too large? (\"keep your loops tight\" :-))I just checked in code for concat. 54X speed improvement.\n\nAs far as the interpreter speed issue, sounds like it would be worth factoring some code out of the interpreter loop, perhaps into ScriptRuntime. Christophe, did you have some suggested code to move elsewhere?Created attachment 285969\nDense array optimization for indexOfHelper. 4x improvement.\n\nI got a 4x improvement with this perf test:\n\nvar a = [];\nfor (var i=0; i < 10000; i++) {\n  a[i] = i;\n}\nvar d = new Date();\nfor (var i=0; i < 1000; i++) {\n  a.indexOf(9999);\n  a.lastIndexOf(0);\n}\nprint((new Date()) - d);Optimizing iterativeMethod for dense arrays seems to lead no gain: the iteration cost is negligible compared to the function invocations cost.\nFurthermore iterativeMethod suffers from the interpretLoop slowdown. It may be interesting to give another try at iterativeMethod once interpretLoop fixed.\n\nFYI I used this test:\n\nvar a = [];\nfor (var i=0; i < 10000; i++) {\n  a[i] = i;\n}\nfunction allTrue() {\n  return true;\n}\nfunction allFalse() {\n  return false;\n}\n\nvar d = new Date();\nfor (var i=0; i < 100; i++) {\n  a.every(allTrue);\n  a.some(allFalse);\n  a.map(allTrue);\n  a.filter(allTrue);\n  a.filter(allFalse);\n}\nprint((new Date()) - d);\n\nConcerning the interpreter speed issue, I\'ll give it a look to see what makes much sense to me to factor out -- during my experiments I extracted code rather randomly.(In reply to comment #29)\n> Optimizing iterativeMethod for dense arrays seems to lead no gain: the\n> iteration cost is negligible compared to the function invocations cost.\n> Furthermore iterativeMethod suffers from the interpretLoop slowdown. It may be\n> interesting to give another try at iterativeMethod once interpretLoop fixed.\n\nOne thing that struck me with iterativeMethod is that we might want to replace the switch/case in it with a strategy pattern: declare an interface for bodies of respective case statements, and create a new object of an anonymous inner class implementing that interface, then pass it to the iterator loop. That way, we allow the HotSpot to perform optimizations -- it might detect the call site is mostly monomorphic (i.e. code mostly runs foreach) and inline it -- even for a single iteration over a fairly big array. It can do none of these with a switch statement. Created attachment 286000\nstaged interpretLoop\n\nOkay: here is a quick and dirty hack of interpretLoop. It leads to 4x speed improvement on the sort perf test and a 2x on iterativeMethod test.\n\n(So, with my patch for using Arrays.sort and Comparator, we get an overall 8x on sort (4x compared to 1.6r7).)\n\nI have extracted in interpretLoopCore the handling of all the simple opcodes (ie: no control flow opcodes, no register loading opcodes).\n\nBTW what I mean by \"dirty\":\n\tprivate static int interpretLoopCore(Context cx, final CallFrame frame, final Object DBL_MRK, final Object undefined, final boolean instructionCounting, final int INVOCATION_COST, String stringReg, int indexReg, Object[] stack, double[] sDbl, Object[] vars, double[] varDbls, byte[] iCode, int stackTop, int op)\n\nThere\'s some obvious clean up to do :-)\n\nIs it okay with you to continue in this way?(In reply to comment #31)\n> One thing that struck me with iterativeMethod is that we might want to replace\n> the switch/case in it with a strategy pattern: declare an interface for bodies\n> of respective case statements, and create a new object of an anonymous inner\n> class implementing that interface, then pass it to the iterator loop. That way,\n> we allow the HotSpot to perform optimizations -- it might detect the call site\n> is mostly monomorphic (i.e. code mostly runs foreach) and inline it -- even for\n> a single iteration over a fairly big array. It can do none of these with a\n> switch statement. \n\nI thought of it but didn\'t give it a try because I benchmarked a (faulty) iterativeMethod without anything inside the loop except the method call and there was no difference. It was before I modified Interpreter.java. Must retry...Thanks...\n\nHere are my quick numbers on the iterativeMethod timing test (see comment #29):\n1.6R7: 5831\n1.7R1pre: 15668\n1.7R1pre with patch from comment #32: 6713\n\nI\'m concerned about the call overhead for invoking interpretLoopCore in the inner loop. I tried adding looping in interpretLoopCore, and that got the numbers down into the 6500\'s, but still well above the 5800\'s from 1.6R7. \n\nI\'ll look at it some more.\nAs an additional datapoint, I ran a comparison between the current sources and 1.6R7, but with -Xint option that disables any compilation/jitting in the JVM. The two timings are very close, so Christophe is right that it has to do with something not working for us in compilation with the JVM.\n\n[rhino] java -Xint -jar build/rhino1_7R1pre/js.jar -opt -1 iterativeMethod.js 79574\n[rhino] java -Xint -jar /home/norris/rhino/mozilla/js/rhino/build/rhino1_6R7/js.jar -opt -1 iterativeMethod.js\n78910\nCreated attachment 290672\nRhino 1.7 -XX:+PrintCompilation traceCreated attachment 290673\nRhino 1.6R7 -XX:+PrintCompilation traceI ran the tests on the sun server jvm with -XX:+PrintCompilation to trace the jitting.\n\nNow it\'s clear that it\'s not a cache problem: interpretLoop don\'t get jitted anymore.Thanks--using -XX:+PrintCompilation is an easy way to see the problem. Using that approach, I played around with pulling pieces out of interpretLoop until it was jitted again. I\'ve committed those changes:\n\nChecking in Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.340; previous revision: 1.339\ndone\n\nI\'m marking this bug FIXED now, as all the original array methods have been\noptimized or at least examined and determined that a dense array specialization\nlikely wouldn\'t make much difference.',?,IMPROVEMENT
399958,'Global Security Controller is not checked in Context.compileImpl method',Rhino,Core,songguoq,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.1.7) Gecko/20070914 Firefox/2.0.0.7\nBuild Identifier: 1.6R7\n\nCurrent implementation of Context.compileImpl method (in 1.6R7) only checks security controller in the current context instance. Ideally, it should check for global security controller as well.\n\nThe following lines: \n\n        if (securityDomain != null && securityController == null) {\n            throw new IllegalArgumentException(\n                \"securityDomain should be null if .....\");\n        }\n\nshould be changed to\n\n        if (securityDomain != null && getSecurityController() == null) {\n            throw new IllegalArgumentException(\n                \"securityDomain should be null if.....\");\n        }\n\nand getSecurityController() is already defined in Context:\n\n    SecurityController getSecurityController()\n    {\n        SecurityController global = SecurityController.global();\n        if (global != null) {\n            return global;\n        }\n        return securityController;\n    }\n\n\nReproducible: AlwaysThanks - fixed it in CVS HEAD.\n\nChecking in src/org/mozilla/javascript/Context.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\nnew revision: 1.262; previous revision: 1.261\ndone\n',?,IMPROVEMENT
400031,'Fix for Bug 352319 broken when context has debugger attached.',Rhino,Core,kruland,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)\nBuild Identifier: 1.6R7\n\nI took the example code attached to Bug 352319 and attached a trivial debugger to the context.  When I execute the example code it blows up in Interpreter.enterFrame.\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 285116\nSource to reproduce the bug.\n\nThis is exactly the source from Bug 352319 except for the addition of a simple debugger to the context.  The debugger source is included in the tgz.I have played around with Rhino 1.6R7 and found the following code change to Interpreter.java fixes the problem.  Unfortunately, I don\'t have a deep enough understanding if this patch is correct or if it breaks anything else.\n\n*** rhino1_6R7-rlg/src/org/mozilla/javascript/Interpreter.java\t2008-02-06 16:05:49.000000000 -0600\n--- rhino1_6R7/src/org/mozilla/javascript/Interpreter.java\t2008-02-06 16:16:41.000000000 -0600\n***************\n*** 4074,4080 ****\n                  // block (\"catch\" implicitly uses NativeWith to create a scope \n                  // to expose the exception variable).\n                  for(;;) {\n!                     if(scope instanceof NativeCall || scope instanceof NativeObject) {\n                          break;\n                      } else {\n                          scope = scope.getParentScope();\n--- 4074,4080 ----\n                  // block (\"catch\" implicitly uses NativeWith to create a scope \n                  // to expose the exception variable).\n                  for(;;) {\n!                     if(scope instanceof NativeCall) {\n                          break;\n                      } else {\n                          scope = scope.getParentScope();\n+szegedia@freemail.hu\n\nAttila, can you comment on the proposed patch?I\'ll need to spend some time on understanding it -- I myself only have incomplete understanding of how interpreter code works, so I\'ll want to stare a bit at it; probably tomorrow morning (europaish time)I\'m looking into this now.Committed a (slightly  modified) patch -- looping just while we\'re encountering NativeWith. The problem seemed to be that top-level invocation of a Script object (which is also a function) won\'t get a NativeCall object even when it should be activatable (i.e. because a DebugFrame is created by a debugger for it, or because of a top-level try/catch or with statement.\n\n    Checking in src/org/mozilla/javascript/Interpreter.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\n    new revision: 1.342; previous revision: 1.341\n\n',?,BUG
400159,'Make org.mozilla.javascript.Synchronizer act on native Java objects when available',Rhino,Core,irony.delerium,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en) AppleWebKit/419.3 (KHTML, like Gecko) Safari/419.3\nBuild Identifier: Rhino 1.6r6\n\nSynchronizer acts on JS object (Scriptable) for synchronization; this means using the Java primitives for synchronization (notify, wait, notifyAll) as well when operating in a threaded context is difficult to impossible. Patch included to change Synchronizer so that when a NativeJavaObject is found, it is unwrapped before synchronizing against it.\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the following in the JS shell provided by Rhino:\n----\nvar o = new java.lang.Object();\nspawn(function() {\n  var f = sync(function() {\n    this.wait();\n    print(\"Hello world!\");\n  });\n  f.apply(o, []);\n});\nvar p = sync(function() {\n  this.notify();\n});\np.apply(o, []);\n\n\nActual Results:  \nException in thread \"Thread-1\" org.mozilla.javascript.WrappedException: Wrapped java.lang.IllegalMonitorStateException: current thread not owner (<stdin>#11)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1757)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:170)\n        at org.mozilla.javascript.NativeJavaMethod.call(NativeJavaMethod.java:243)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3237)\n        at script(<stdin>:11)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2394)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n        at org.mozilla.javascript.Synchronizer.call(Synchronizer.java:78)\n        at org.mozilla.javascript.ScriptRuntime.applyOrCall(ScriptRuntime.java:2234)\n\n\nExpected Results:  \nThe script should have printed \"Hello world!\" to the console.Created attachment 285242\nPatch for Synchronizer.java - change the object used in the \"synchronized {}\" block\n\nThis changes the target of synchronization in org.mozilla.javascript.Synchronizer from the Scriptable representing \"this\" in JavaScript to the underlying Java object if one is available.Fixed in CVS HEAD:\n\n    Checking in src/org/mozilla/javascript/Synchronizer.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Synchronizer.java,v  <--  Synchronizer.java\n    new revision: 1.8; previous revision: 1.7\n    done\n',?,RFE
401561,'0) can cause functions to execute in wrong scope',Rhino,Compiler,dgreenspan,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en; rv:1.8.1.8) Gecko/20071010 Camino/1.5.2\nBuild Identifier: 1.6r7\n\nWhen opt>0, Rhino performs a global \"direct-call\" optimization on code it generates, which changes the caller/callee contract for any functions optimized.  As a result, calling these functions indirectly or from a different Script causes the function execution to use the caller\'s scope(!), not the callee\'s (lexical) scope.\n\nReproducible: Always\n\nSteps to Reproduce:\n// This code runs correctly when opt<=0, fails when opt>0.\n// Note the *correct* behavior is to throw an exception.\n// The *incorrect* behavior is to print a number.\n\n// Can test with java -classpath js.jar org.mozilla.javascript.tools.shell.Main -opt 1 bugtest.js\n\n// bugtest.js:\n\n// This function should never work (no x in lexical scope)\nfunction getX() { return x; }\n\nglobal = this;\n(function() {\n  var x = 12345;\n  (function() {\n\n    // indirect call, not direct-call-optimized,\n    // uses this scope\'s parent instead of getX\'s parent\n    java.lang.System.out.println(global[\"getX\"]());\n    // Result: if opt <= 0, \"x not found\"\n    // if opt > 0, prints \"12345.0\" !!\n\n  })();\n})();\n\n// call site triggers direct-call optimization of getX;\n// remove this line and the bug doesn\'t manifest!\nfunction neverCalled() { getX(); }\n\nActual Results:  \nprints \"12345.0\"\n\nExpected Results:  \nReferenceError: \"x\" is not defined.\n\nI discovered this bug because my application uses a shared global scope with multiple \"sub-scopes\" (http://www.mozilla.org/rhino/scopes.html : \"Sharing Scopes\"), and some functions are copied from a sub-scope to the global scope.  I realized I had a Rhino bug when some really weird stuff happened when class-file optimization was turned on, *but* only in the presence of a particular never-called function declaration.  I doubted for a while that the bug could be reproduced in a js file without special scope stuff, but then I found another way to fool the direct-call optimizer.\n\nI\'m guessing that direct-call optimization is triggered when a function is declared but the function object doesn\'t \"flow\" anywhere (and the function is called somewhere else in the script).  I honestly don\'t know exactly what the optimization does, but it seems to remove the call to \"getParentScope\" at the beginning of the optimized function, putting the burden of determining the scope on the caller.  If any call-site doesn\'t get the memo, it breaks (the function runs with an erroneous scope).  The function object corresponding to a top-level function declaration thereby becomes defective, as far as I can tell, while still being accessible as a property of the global object.That\'s a weird bug. Thanks for the excellent analysis!Fixed at last:\n\nhttps://github.com/mozilla/rhino/commit/e37f2ff37b3a145d9ee6ee4703947cb6ed22718f',?,BUG
402331,'In a compiled iterator \"this\" points to an instance of RuntimeGeneratorState',Rhino,Compiler,mozilla.bugs,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\nBuild Identifier: CVS HEAD\n\nThe code below works in interpreted mode and fails in compiled mode.\n\na = [1,2];\na.__iterator__ = function() { yield [0, this[0]]; yield [1, this[1]]}\nfor(i in a) i;\n\nIt throws this exception:\norg.mozilla.javascript.EvaluatorException: \nJava class \"org.mozilla.javascript.optimizer.OptRuntime$RuntimeGeneratorState\" has no public instance field or method named \"0\".\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Set target milestone to 1.7R1.Fixed:\n\nChecking in Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.260; previous revision: 1.259\ndone\nChecking in OptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/OptRuntime.java,v  <--  OptRuntime.java\nnew revision: 1.38; previous revision: 1.37\ndone\n',?,BUG
403604,'Continuation support missing in Rhino 1.7 (cvs HEAD)',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.8.1.8) Gecko/20071022 Ubuntu/7.10 (gutsy) Firefox/2.0.0.8\nBuild Identifier: \n\nCurrent CVS HEAD seems to be missing continuation support - the Continuation function is not defined.\n\nReproducible: Always\n\nSteps to Reproduce:\nhannes@x20:~/cvs/rhino$ java -jar build/rhino1_7R1pre/js.jar -opt -1\nRhino 1.7 release 1 Pre 2007 11 13\njs> Continuation\njs: \"<stdin>\", line 2: uncaught JavaScript runtime exception: ReferenceError: \"Continuation\" is not defined.\njs>Fixed:\n\ncvs ci -m \"Fix for Bug 403604 ? Continuation support missing in Rhino 1.7 (cvs HEAD)\" -l \"/Rhino/src/org/mozilla/javascript/LazilyLoadedCtor.java\"\n    Checking in src/org/mozilla/javascript/LazilyLoadedCtor.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/LazilyLoadedCtor.java,v  <--  LazilyLoadedCtor.java\n    new revision: 1.26; previous revision: 1.25\n    done\n\n\nNorris or David -- can you confirm that the fix is indeed valid? It looks like the problem was caused by introduction of LazilyLoadedCtor.buildValue() in its 1.23 revision. I\'m not 100\% sure I understand the code, but it does seem to me that it was wrong the way it was, and my change indeed fixed the issue. I just checked, and although the Continuation constructor is now defined again, continuations aren\'t working. \n\nI tested various CVS snapshots narrow in the cause, and it looks like continuation support  was broken on 2007-11-02 (cvs update -D 2007-11-02 still works, 2007-11-03 doesn\'t). There were two major commits by Norris Boyd on that day, I think it\'s the first one which is to blame.\n\nI\'ll attach a little continuation test script shortly.Created attachment 293857\nSimple test case for continuations\n\nA simple test case for continuations. It should print \"got: ok\". With current CVS HEAD; it prints nothing, i.e. the continuation in there but doesn\'t work.Created attachment 293865\nPatch fixes continuation support\n\nOk, the problem seems to be that (for whatever reason) continuations simply don\'t work with LazilyLoadedCtor. This patch undos that change made in revision 1.281 of ScriptRuntime.java from 2007/11/02 and continuations are working again.\n\nI\'m not sure whether the change Attila committed to LazilyLoadedCtor.java is still needed. I\'ve left it in for now, as it don\'t seem to be any problems with it, but maybe somebody with more grasp should look again.Created attachment 293872\nPatch to make continuations work with LazilyLoadedCtor\n\nThe problem is really trivial actually. LazilyLoadedCtor expects the static init() method to take three arguments: the context, scope and sealed flag. Continuation.init() only took the last two, so it failed.Thanks, I committed the patch.',?,IMPROVEMENT
404211,'Multiple competing function definitions leads to chaotic results',Rhino,Core,bimargulies,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\nBuild Identifier: 1.6R7\n\nDefining a JavaScript class in Java:\n\nIf you mistakenly try to define multiple overloads of a JavaScript method via multiple jsFunction_foo functions, there is no diagnosis, and unpredictable results. One of the function will end up as the function-of-record, but which one depends on the JVM version or the phase of the moon.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Define class with jsFunction_send() and jsFunction_send(String x)\n2. write code to call it from JavaScript\n\nActual Results:  \nNo diagnosis and unpredictable results.\n\nExpected Results:  \nA diagnosis. Or at least some rule to determine which function gets the prize.Yes, we should report an error.Fixed: \n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.133; previous revision: 1.132\ndone\nI think the committed fix breaks getter/setter definitions when both jsGet_* and jsSet_* methods are defined for a property. I have methods jsGet_status and jsSet_status to defina a read/write property named status and get the following: \n\norg.mozilla.javascript.EvaluatorException: Invalid method \"jsSet_status\": name \"status\" is already in use. (/home/hannes/svn/helma-ng/modules/helma/rhino.js#24)\n        at org.mozilla.javascript.DefaultErrorReporter.runtimeError(DefaultErrorReporter.java:109)\n        at org.mozilla.javascript.Context.reportRuntimeError(Context.java:922)\n        at org.mozilla.javascript.Context.reportRuntimeError(Context.java:978)\n        at org.mozilla.javascript.Context.reportRuntimeError2(Context.java:948)\n        at org.mozilla.javascript.ScriptableObject.buildClassCtor(ScriptableObject.java:1159)\n        at org.mozilla.javascript.ScriptableObject.defineClass(ScriptableObject.java:998)\n        at org.mozilla.javascript.ScriptableObject.defineClass(ScriptableObject.java:931)\n        at org.helma.javascript.RhinoEngine.defineHostClass(RhinoEngine.java:108)\n        ....\nCreated attachment 327950\nFix definition of getters and setters\n\nThis patch fixes the problem with jsGet_ and jsSet_ described in comment #3. I just moved the check for conflicts down below the block that handles jsGet_ and jsSet_. Since now the method name and property name are required to coexist for longer, I renamed variable name to methodName and always use propName when referring to the property name.Created attachment 328845\nA simpler and less obtrusive patch\n\nThis patch is much simpler than the previous one. We\'re simply moving up the continue statement to where the setterPrefix is detected, simplifying the code and avoiding the duplicate method check at the same time.Thanks for finding and fixing this. I\'ve submitted your patch.I\'m migrating from rhino 1.6R7 to rhino 1.7R2 and I\'m getting the following error:\n\nInvalid method \"jsGet_tagName\": name \"tagName\" is already in use\n\nI have a class with the method jsGet_tagName and this getter method is redefined in one subclass.\nI\'m getting the error while redefining the subclass.\n\nIn rhino 1.6R7 everything works fine.\n\nCould be a bug related with this issue?',?,BUG
404484,'destructuring assignment does not work for constants',Rhino,Core,mozilla.bugs,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\nBuild Identifier: CVS HEAD\n\nDestructuring assignment works fine for \"var\" and \"let\" but not for \"const\".\n\nReproducible: Always\n\nSteps to Reproduce:\nconst [a, b] = [1, 2];\nActual Results:  \na and b are defined as consts whose values are \"undefined\".\n\n\nExpected Results:  \na and b are defined as consts and a == 1 and b == 2.My understanding of the compiler work is that:\n const [a, b] = [1, 2]; \nis transformed in:\n  const a, b;\n  {\n    let $0 = [1, 2];\n    a = $0[0];\n    b = $0[1];\n  }Set target milestone to 1.7R1.Fixed: \n\nChecking in IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFa\nctory.java\nnew revision: 1.113; previous revision: 1.112\ndonethanks',?,BUG
404817,'ContextFactory.enter results in new contexts that don\'t have their factory slot set!',Rhino,Core,bimargulies,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\nBuild Identifier: 1.6R7\n\nI just traced through ContextFactory.enter. I see it create a brand new context, but never put the factory into the slot. So, later calls to retrieve it return null, and their may be other ill effects.\n\nI\'m using Sun 1.5 (rev 14).\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Call enter() on a context factory object.\n2. Trace in debugger and see that a new object is being created.\n3. Look at the new object.\nActual Results:  \n\'factory\' is null.\n\nExpected Results:  \nfactory is the factory(!).From newsgroup:\n\nWell, yeah. I remember once reviewing this myself and it turns out  \nthat Context.enter() doesn\'t set factory, and other parts of the code  \nactually rely on factory == null to assume the context is meant to  \noperate with the global factory.  That\'s an admittedly really ugly  \ndesign in there. I think it originates from times when there was no  \nsuch thing as a pluggable context factory. Then someone introduced  \nthem, but retained this unfortunate anomaly. We\'ll really need to  \naddress this sometime... In the meantime, factory == null means the  \nContext actually uses the global (static) ContextFactory instance  \nsettings.\n\nAttila. I wasn\'t quite clear.\n\nI experienced this when using the enter method of a specific factory. As per step 1 above, I created a brand new context factory, I called enter on it, it created a new context, and it left the parent slot null. So, this is not about the invisible default global factory.\n\nYes, sadly this is a real bug. I\'ve looked into this over the weekend, but it\'s unfortunately not too trivial to fix. As I said, the original implementation of the ContextFactory concept used a duality: factory was null for global factory, otherwise it was set. There is some subtly different behaviour based on whether factory is null or not, as originally there was no ContextFactory.enter() (I added that recently to support certain Spring interceptor patterns for opening and closing a factory bound context), but factory-bound contexts could only exist within a ContextFactory.call(ContextAction) invocation.\n\nI\'ve started on fixing this -- as the first step, I made the \"factory\" field final and also rejecting null in the constructor. That will establish a good invariant (context always has a non-null factory) as a starting point. I\'m sorry that I can\'t offer you a quick fix for this one. I\'m really eager to fix it though, as I have software myself where I rely on ContextFactory.enter(). It\'s just puzzling that I didn\'t notice this myself earlier...This is fixed on CVS HEAD now. I had to rework the internals quite a lot, but I believe we now have a much cleaner code.\n\nI also deprecated the static Context.enter() methods, favoring ContextFactory.enterContext() instead. Also, ContextFactory.enter() is now deprecated because it is misnamed -- you aren\'t enterint a context factory, you\'re entering a context. Therefore, ContextFactory.enterContext() followed by Context.exit() is the preferred way of doing things now (and of course,  ContextFactory.call()).Thanks. I\'ll clean up my code to take advantage as soon as it releases into the mvn repo.Thanks for fixing this, Attila. I struggled a quite a bit with the old code, and I think things are much better and clearer now. Since it took me a long time to figure things out with the old code, I\'m writing this down for the record (and for myself and anybody who may be interested :-)\n\nIn the old code, calling ContextFactory.enter() only caused makeContext() to be called on the specific factory, but didn\'t cause the Context.factory field to be set to the factory. Context.factory was only set during calls of one of the Context.call() methods, causing Context.enter() and Context.exit() to be no-ops while the ContextAction was running. \n\nSo what we lose with this fix is \"protection\" against erroneous calls to Context.enter()/Context.exit() during execution of the Context.call() methods, but I don\'t think this was worth the complexity. If we did want that feature back, we could implement it by adding a new field to tell whether we are currently executing Context.call(), but I don\'t really this is needed.\n\nAnd now for the reason I\'m writing this: Our code uses ContextFactory.exit(), which has gone. Since this was a public method and actually did something different from Context.exit() until now, I think it should stay and just be deprecated, just like ContextFactory.enter(). I\'ll upload a patch after lunch :-)(In reply to comment #6)\n> \n> And now for the reason I\'m writing this: Our code uses ContextFactory.exit(),\n> which has gone. Since this was a public method and actually did something\n> different from Context.exit() until now, I think it should stay and just be\n> deprecated, just like ContextFactory.enter(). I\'ll upload a patch after lunch\n> :-)\n\nNo need to -- I already added it back. Thanks for pointing this out and have a nice lunch :-)',?,BUG
405558,'The throw statement does not seem to behave properly.',Rhino,Compiler,anasir,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\nBuild Identifier: js 1.5(7)\n\nHere is some java code I wrote to test Rhino. I want to be able to throw an IllgalArgumentException from the javascript, but I found that I could not even execute a basic throw statement.\n\nContext ctx = Context.enter();\nctx.evaluateString(null, \"throw \'42\'\", null, 0, null);\nContext.exit();\n\nThe variations of the throw statement I have tried are:\nthrow (\'e\')\nthrow new java.lang.IllegalArgumentException()\nthrow new Packages.java.lang.IllegalArgumentException()\nthrow \'42\'\n\nAll of the above gives me a NullPointerException.\n\njava.lang.NullPointerException\n\tat org.mozilla.classfile.ClassFileWriter.addPush(ClassFileWriter.java:894)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1628)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1556)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateBodyCode(Codegen.java:1222)\n\tat org.mozilla.javascript.optimizer.Codegen.generateCode(Codegen.java:288)\n\tat org.mozilla.javascript.optimizer.Codegen.compileToClassFile(Codegen.java:161)\n\tat org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:71)\n\tat org.mozilla.javascript.Context.compileImpl(Context.java:2343)\n\tat org.mozilla.javascript.Context.compileString(Context.java:1348)\n\tat org.mozilla.javascript.Context.compileString(Context.java:1337)\n\tat org.mozilla.javascript.Context.evaluateString(Context.java:1193)\n\tat com.istnet.script.ScriptingTest.testScriptException(ScriptingTest.java:202)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat junit.framework.TestCase.runTest(TestCase.java:164)\n\tat junit.framework.TestCase.runBare(TestCase.java:130)\n\tat junit.framework.TestResult$1.protect(TestResult.java:110)\n\tat junit.framework.TestResult.runProtected(TestResult.java:128)\n\tat junit.framework.TestResult.run(TestResult.java:113)\n\tat junit.framework.TestCase.run(TestCase.java:120)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:228)\n\tat junit.framework.TestSuite.run(TestSuite.java:223)\n\tat org.junit.internal.runners.OldTestClassRunner.run(OldTestClassRunner.java:35)\n\tat org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Code attached.\n2.\n3.\nActual Results:  \njava.lang.NullPointerException\n\tat org.mozilla.classfile.ClassFileWriter.addPush(ClassFileWriter.java:894)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1628)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1556)\n\tat org.mozilla.javascript.optimizer.BodyCodegen.generateBodyCode(Codegen.java:1222)\n\tat org.mozilla.javascript.optimizer.Codegen.generateCode(Codegen.java:288)\n\tat org.mozilla.javascript.optimizer.Codegen.compileToClassFile(Codegen.java:161)\n\tat org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:71)\n\tat org.mozilla.javascript.Context.compileImpl(Context.java:2343)\n\tat org.mozilla.javascript.Context.compileString(Context.java:1348)\n\tat org.mozilla.javascript.Context.compileString(Context.java:1337)\n\tat org.mozilla.javascript.Context.evaluateString(Context.java:1193)\n\tat com.istnet.script.ScriptingTest.testScriptException(ScriptingTest.java:202)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat junit.framework.TestCase.runTest(TestCase.java:164)\n\tat junit.framework.TestCase.runBare(TestCase.java:130)\n\tat junit.framework.TestResult$1.protect(TestResult.java:110)\n\tat junit.framework.TestResult.runProtected(TestResult.java:128)\n\tat junit.framework.TestResult.run(TestResult.java:113)\n\tat junit.framework.TestCase.run(TestCase.java:120)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:228)\n\tat junit.framework.TestSuite.run(TestSuite.java:223)\n\tat org.junit.internal.runners.OldTestClassRunner.run(OldTestClassRunner.java:35)\n\tat org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n\n\n\nExpected Results:  \nI\'d like the code to throw some kind of exception in the JVM space.The NullPointerException actually seems to result from passing null for sourceName, the third argument to Context.evaluateString(). We either should throw a NullPointerException right away, or use some dummy source name such as \"<anonymous>\".\n\nYou also should pass a scope object as first argument to evaluateString(), otherwise you\'re goint to get strange errors (again, we really need some argument checking here...). The easiest way to create a standard scope object is to use Context.initStandardObjects(). \n\nSee http://www.mozilla.org/rhino/tutorial.html for more on embedding Rhino.Fixed by internally assigning name \"unnamed script\" when null is passed as the script name.\n\n    Checking in src/org/mozilla/javascript/Context.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\n    new revision: 1.266; previous revision: 1.265\n\n',?,IMPROVEMENT
405654,'Execution exits interpreter on Function.apply and Function.call',Rhino,Core,szegedia,szegedia,'when f.apply() or f.call() are invoked from the interpreter, the interpreter will call into Java code for IdFunctionObject.call() which will initiate another interpreter loop in case f is an interpreted function. This breaks continuations captured within the f.apply() or f.call().\n\nThe interpreter loop should recognize the special cases of Function.apply and Function.call, and if they are invoked on an InterpretedFunction within the same security domain, then execute the applied/called function within the current interpreter loop.Unfortunately, this gets worse. apply() and call() are not the only cases of a JS->Java->JS transition. \n\nThere is the case of a JS-aware Java object, or a JavaAdapter being passed to Java code. However, since these require that the developer explicitly meddle with Java-specific functionality, we can accept this as a limitation. \n\nHowever, there are further pure-JS cases as well, namely all JS 1.6 array iterator methods: Array.every(), Array. filter(), Array. forEach(), Array. map(), Array. some(). It is clearly not feasible to treat these as special cases in the interpreter. It might be possible to provide an implementation of them written in JS, and when someone needs continuations support through these invocations, then redefine them using\n\n Array.prototype.every = function(fun /*, thisp*/)\n {\n    var len = this.length;\n    if (typeof fun != \"function\")\n      throw new TypeError();\n\n    var thisp = arguments[1];\n    for (var i = 0; i < len; i++)\n    {\n      if (i in this &&\n          !fun.call(thisp, this[i], i, this))\n        return false;\n    }\n\n    return true;\n  };\n\nand similar -- code seen here was lifted from <http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Objects:Array:every>\n\nAlso, unrelated to these, exotic stuff, like invoking apply on apply itself etc. clearly won\'t work as expected...cvs ci -m \"Fix for Bug 405654 ? Execution exits interpreter on Function.apply and Function.call\" -l \"/Rhino/src/org/mozilla/javascript/BaseFunction.java\" \"/Rhino/src/org/mozilla/javascript/ScriptRuntime.java\" \"/Rhino/src/org/mozilla/javascript/Interpreter.java\"\n    Checking in src/org/mozilla/javascript/BaseFunction.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/BaseFunction.java,v  <--  BaseFunction.java\n    new revision: 1.65; previous revision: 1.64\n    done\n    Checking in src/org/mozilla/javascript/ScriptRuntime.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\n    new revision: 1.284; previous revision: 1.283\n    done\n    Checking in src/org/mozilla/javascript/Interpreter.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\n    new revision: 1.338; previous revision: 1.337\n    done\n\n',?,IMPROVEMENT
407374,'Destructuring assignment isn\'t threadsafe',Rhino,Core,mozilla.bugs,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\nBuild Identifier: CVS HEAD\n\nI have a function with destructured parameters\n(eg function(a, [b]) {...}).\n\nThis function is called from several threads and the b (in this example) appears to be shared :-(\nIf I rewrite my functions without destructured parameters (eg function(a, ab) { const b = ab[0]; ... } it solves the problem.\n\nCompiled & interpreted mode.\n\nReproducible: Always\n\nSteps to Reproduce:\nfunction f(a, [b]) { \n    java.lang.Thread.sleep(2000);\n    print(a + \";\" + b);\n}\nspawn(f, [1, [2]]);\nspawn(f, [3, [4]]);\nActual Results:  \n3;4\n1;4\n\nExpected Results:  \n3;4\n1;2Additional information: b is set in the top level scope.Created attachment 292241\nproposed patch\n\nThis patche makes the destructuring assignment to set properties in the current scope.Thanks for the patch. Committed:\n\nChecking in Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.123; previous revision: 1.122\ndone\n',?,IMPROVEMENT
409702,'JavaAdapter causes VerifyError with some abstract classes',Rhino,Core,inonit,nobody,'This is a regression sometime since 1.6R5.\n\nHere is at least one that fails, running with JDK 1.6 in interpreted mode.  (Results are similar with JDKs 1.4-1.5, but the error messages are not as good.  Same with running with different values for optimization.)\n\nJava:\npackage override;\n\npublic abstract class WithFinal {\n\tpublic WithFinal() {\n\t}\n\t\n\tpublic abstract void a();\n\t\n\tpublic abstract void b();\n\t\n\tpublic static abstract class Subclass extends WithFinal {\n\t\tpublic final void a() {\n\t\t}\n\t}\n}\n\nRhino shell:\nvar instance = new JavaAdapter(\n\tPackages.override.WithFinal.Subclass,\n\t{\n\t\tb: function() {\n\t\t}\n\t}\n);\nprint(instance);\n\nOutput with Rhino 1.6R5:\nadapter1@18ee9d6\n\nWith Rhino 1.6R7:\nException in thread \"main\" java.lang.VerifyError: class adapter1 overrides final method a.()V\n        at java.lang.ClassLoader.defineClass1(Native Method)\n        at java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n        at org.mozilla.javascript.DefiningClassLoader.defineClass(DefiningClassLoader.java:62)\n        at org.mozilla.javascript.JavaAdapter.loadAdapterClass(JavaAdapter.java:466)\n        at org.mozilla.javascript.JavaAdapter.getAdapterClass(JavaAdapter.java:317)\n        at org.mozilla.javascript.JavaAdapter.js_createAdpter(JavaAdapter.java:193)\n        at org.mozilla.javascript.JavaAdapter.execIdCall(JavaAdapter.java:123)\n        at org.mozilla.javascript.IdFunctionObject.call(IdFunctionObject.java:127)\n        at org.mozilla.javascript.BaseFunction.construct(BaseFunction.java:313)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3281)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2394)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:393)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:2834)\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:173)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:524)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:446)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:412)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:403)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n        at org.mozilla.javascript.Context.call(Context.java:577)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:503)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)Sorry, I should have explicitly added that the same result occurs with HEAD.Fixed both in branch and head. Also added regression test.',?,BUG
410725,'New test for Iterator constructor',Rhino,Compiler,norrisboyd,nobody,'Bob, I created a new test to catch some cases I was missing in Rhino that escaped the regression suite.Bob, can you take a look at integrating this into the test suite?where?Created attachment 295359\njs1_7/geniter/iterator-ctor.js\n\nHere\'s the test case (thought I had attached it when I created the bug)Created attachment 295372\njs1_7/extensions/iterator-ctor.js\n\nSince it uses uneval, I prefer to put it in extensions although that is kind of mute at the moment since only SpiderMonkey and Rhino support js17 anyway. Would putting the test in extensions work for Rhino?\n\nI went ahead and added this bugnumber to the test, to make it easier to find this bug and added a See devmo.\n\nminor nit: misspelled constructor\n\nnit: you didn\'t include the description in the reportCompare calls. Apart from their use visually to illustrate the specific test which failed, I use the description to distinguish individual cases when trying to compare results to known failures. In this cases the different calls to reportCompare(true, flag).\n\nSpiderMonkey on the 1.8 and trunk fail the last test.\n\njstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell description: uneval(iteratorToArray(new Iterator(obji,true))) expected: [-1, -2] actual: [\"__iterator__\", \"a\", \"b\"] reason: Expected value \'[-1, -2]\', Actual value \'[\"__iterator__\", \"a\", \"b\"]\' \n\n\njstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell description: uneval(iteratorToArray(new Iterator(obji,true))) flag expected: true actual: -1 reason: Type mismatch, expected type boolean, actual type number Expected value \'true\', Actual value \'-1\' \n\nI\'m not really clear as to the distinction between Iterator(...) and new Iterator(...). Igor, what say you? bug in test or bug in SpiderMonkey?(In reply to comment #4)\n> Created an attachment (id=295372) [details]\n> js1_7/extensions/iterator-ctor.js\n> \n> Since it uses uneval, I prefer to put it in extensions although that is kind of\n> mute at the moment since only SpiderMonkey and Rhino support js17 anyway. Would\n> putting the test in extensions work for Rhino?\n\nThat\'s fine. The uneval was just a convenient way to compare the resulting arrays against an expected result. Do you have any better way to do the comparison? Like you say, it doesn\'t really matter much at the moment at least.\n\n> \n> I went ahead and added this bugnumber to the test, to make it easier to find\n> this bug and added a See devmo.\n\nThanks\n\n> \n> minor nit: misspelled constructor\n> \n> nit: you didn\'t include the description in the reportCompare calls. Apart from\n> their use visually to illustrate the specific test which failed, I use the\n> description to distinguish individual cases when trying to compare results to\n> known failures. In this cases the different calls to reportCompare(true, flag).\n\nThanks, that makes sense. I have to admit that I wish the test framework would just throw an exception that would have line numbers in the stack trace (does SpiderMonkey keep track of that?) but that\'s a bigger issue :-)\n\n> \n> SpiderMonkey on the 1.8 and trunk fail the last test.\n> \n> jstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell\n> description: uneval(iteratorToArray(new Iterator(obji,true))) expected: [-1,\n> -2] actual: [\"__iterator__\", \"a\", \"b\"] reason: Expected value \'[-1, -2]\',\n> Actual value \'[\"__iterator__\", \"a\", \"b\"]\' \n> \n> \n> jstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell\n> description: uneval(iteratorToArray(new Iterator(obji,true))) flag expected:\n> true actual: -1 reason: Type mismatch, expected type boolean, actual type\n> number Expected value \'true\', Actual value \'-1\' \n\nYes, the SpiderMonkey trunk behavior makes more sense that what I\'m testing for here. I thought I did everything compatible with SpiderMonkey but either I made a mistake or SpiderMonkey behavior has changed (I haven\'t rebuilt SpiderMonkey in some time).\n\nFeel free to check in the test as it works with SpiderMonkey and I\'ll make Rhino compatible.\n\n> \n> I\'m not really clear as to the distinction between Iterator(...) and new\n> Iterator(...). Igor, what say you? bug in test or bug in SpiderMonkey?\n> (In reply to comment #4)\n> SpiderMonkey on the 1.8 and trunk fail the last test.\n> \n> jstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell\n> description: uneval(iteratorToArray(new Iterator(obji,true))) expected: [-1,\n> -2] actual: [\"__iterator__\", \"a\", \"b\"] reason: Expected value \'[-1, -2]\',\n> Actual value \'[\"__iterator__\", \"a\", \"b\"]\' \n> \n> \n> jstest: js1_7/extensions/iterator-ctor.js bug:  result: FAILED type: shell\n> description: uneval(iteratorToArray(new Iterator(obji,true))) flag expected:\n> true actual: -1 reason: Type mismatch, expected type boolean, actual type\n> number Expected value \'true\', Actual value \'-1\' \n> \n> I\'m not really clear as to the distinction between Iterator(...) and new\n> Iterator(...). Igor, what say you? bug in test or bug in SpiderMonkey?\n\nnew Iterator(obj, flag) always constructs a default iterator that iterates over the properties of the object obj and returns a sequence of property keys (flag is true) or a sequence of [key, value] pair (flag is false). There is no lookup of __iterator__ method here. As such the test case is wrong and [\"__iterator__\", \"a\", \"b\"] is the correct result as obji contains these 3 properties. \n\nIterator(obj, flag) is a converter to iterator. The call *looks* for __iterator__ property and is roughly equivalent to the following:\n\nlet (iter = obj.__iterator__) iter ? iter.call(obj, flag) : new Iterator(obj, flag)\n\nexcept it properly deals with XML objects and has a special support for native objects that provides own implementation of the iterator protocol.Thanks Igor!\n\n/cvsroot/mozilla/js/tests/js1_7/extensions/iterator-ctor.js,v  <--  iterator-ctor.js\ninitial revision: 1.1\n',?,TEST
411539,'Generalize some tests for Rhino and Spidermonkey',Rhino,Compiler,norrisboyd,nobody,'Created attachment 296184\npatch for mozilla/js/tests directory\n\nSee attachment for a collection of changes to js/tests to enable those tests to cover both SpiderMonkey and Rhino.It appears to be ok with the exception of js1_7/regress/regress-352797-02.js \n\nit should have the expect be a regexp as well.\nvar expect = /No Crash/;\n\nWant to go ahead and make that change and check it in?(In reply to comment #1)\n> It appears to be ok with the exception of js1_7/regress/regress-352797-02.js \n> \n> it should have the expect be a regexp as well.\n> var expect = /No Crash/;\n\nThanks, good catch\n\n> \n> Want to go ahead and make that change and check it in?\n> \n\nDone: \n\nChecking in js1_7/extensions/regress-355052-01.js;\n/cvsroot/mozilla/js/tests/js1_7/extensions/regress-355052-01.js,v  <--  regress-355052-01.js\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in js1_7/extensions/regress-355052-02.js;\n/cvsroot/mozilla/js/tests/js1_7/extensions/regress-355052-02.js,v  <--  regress-355052-02.js\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in js1_7/extensions/regress-355052-03.js;\n/cvsroot/mozilla/js/tests/js1_7/extensions/regress-355052-03.js,v  <--  regress-355052-03.js\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in js1_7/regress/regress-352797-02.js;\n/cvsroot/mozilla/js/tests/js1_7/regress/regress-352797-02.js,v  <--  regress-352797-02.js\nnew revision: 1.5; previous revision: 1.4\ndone\nChecking in js1_7/regress/regress-352870-03.js;\n/cvsroot/mozilla/js/tests/js1_7/regress/regress-352870-03.js,v  <--  regress-352870-03.js\nnew revision: 1.3; previous revision: 1.2\ndone\n\n',?,TEST
411895,'Creating E4X XML objects is 2000x slower than SpiderMonkey',Rhino,E4X,inonit,nobody,'From the newsgroup.  Since the infrastructures for SpiderMonkey and Rhino are so different, it\'s not clear that it would be easy to improve this performance differential, but investigating it seems sensible.\n\nFrom: Massimiliano Mirra <hyperstr...@gmail.com>\nNewsgroups: mozilla.dev.tech.js-engine.rhino\nSubject: performance problem with e4x\nDate: Fri, 11 Jan 2008 03:50:47 -0800 (PST)\n\nI came across this while writing a templating engine for Helma.\n\n\"js.jar\" is built from a fresh cvs.mozilla.org checkout,\n\"js-noxmlbeams.jar\" is the same without\norg/mozilla/javascript/xml/impl/xmlbeans/ (thus using\n.../javascript/xmlimpl/), \"js\" is spidermonkey 1.8, java is j2se6,\ntime is in msecs:\n\nbard@yokai:/tmp/w/seethrough_helma$ java -Djava.compiler=NONE -jar\njs.jar -opt 9 e4x_bm.js\ntimes per run: 10000\nrun #0 total time: 42596\nrun #1 total time: 48355\nrun #2 total time: 51056\nrun #3 total time: 52297\nbard@yokai:/tmp/w/seethrough_helma$ java -Djava.compiler=NONE -jar js-\nnoxmlbeans.jar -opt 9 e4x_bm.js\ntimes per run: 10000\nrun #0 total time: 38487\nrun #1 total time: 45523\nrun #2 total time: 43726\nrun #3 total time: 46889\nbard@yokai:/tmp/w/seethrough_helma$ js e4x_bm.js\ntimes per run: 10000\nrun #0 total time: 18\nrun #1 total time: 6\nrun #2 total time: 19\nrun #3 total time: 6\nbard@yokai:/tmp/w/seethrough_helma$ cat e4x_bm.js\nfunction bm(fn, times) {\n    times=times||100;\n    var start=Date.now();\n    for(var i=0;i<times;i++)\n        fn();\n    return (Date.now() - start);\n}\n\nvar runs = 4;\nvar times = 10000;\n\nprint(\'times per run: \' + times);\n\nfor(var i=0;i<runs; i++) {\n    var total = bm(function(){ <test/> }, times);\n    print(\'run #\' + i + \' total time: \' + total);\n}Performing some unscientific instruction sampling (i.e., pausing Rhino\nwhile running your test in the debugger and looking at the stack), it\nlooks like we\'re spending most of our time in\ncom.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse().\nSo I don\'t have much idea how to improve this short of switching to\nyet another XML parser.\n\nI did notice that we were creating a DocumentBuilder from scratch\nevery time, so I created a simple DocumentBuilder pool. This saved\nabout 23\% on your test case, which is a nice speedup but still leaves\nus a couple of orders of magnitude slower than SpiderMonkey for this\ncase. \n\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor.java,v  <--  XmlProcessor.java\nnew revision: 1.10; previous revision: 1.9\ndone\n\n(In reply to comment #1)\n> Performing some unscientific instruction sampling (i.e., pausing Rhino\n> while running your test in the debugger and looking at the stack), it\n> looks like we\'re spending most of our time in\n> com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse().\n> So I don\'t have much idea how to improve this short of switching to\n> yet another XML parser.\n\nIn the fine tradition of speaking and demonstrating foolishness rather\nthan staying silent and just giving the impression of it, I\'ll ask, is\nthere any chance XML objects could be created at parse time and then\ncloned as necessary?  I\'ve played with that in Erlang\n(http://hyperstruct.net/2007/6/26/literal-xml-in-erlang-with-parse-transform-2)\nand while I\'m not familiar with Spidermonkey internals,\nhttp://lxr.mozilla.org/mozilla/source/js/src/jsparse.c#6204 makes me\nthink that something similar might be going on.\n\n> I did notice that we were creating a DocumentBuilder from scratch\n> every time, so I created a simple DocumentBuilder pool. This saved\n> about 23\% on your test case, which is a nice speedup but still leaves\n> us a couple of orders of magnitude slower than SpiderMonkey for this\n> case.\n\nActually my test case went from ~50 seconds to ~8.  In my book that\'s\nmore than \"nice\". :-)\n(In reply to comment #2)\n> is\n> there any chance XML objects could be created at parse time and then\n> cloned as necessary?\n\nIt\'s certainly possible.  It\'s possible it won\'t help much, or that it would even hurt -- that the actual String parsing is not the bottleneck here.  The underlying XML parser controls whether cloning is going to be faster than parsing a document from a String.  And we are pretty much required to treat that as a black box because an application can replace the default XML parser using JAXP.  Xerces is undoubtedly the most common case, though (and then probably Crimson, which used to be the JDK\'s native parser, but I don\'t know what version they switched).Added at patch at github https://github.com/mozilla/rhino/pull/9\n\nThe patch from bug 411895#1 works fine in a singlethreaded context, but kills performance\nin a multithreaded situationen, because the creation of the DocumentBuilder\nnow takes place inside the synchronized method.\n\nThis patch, uses a ConcurrentLinkedQueue to\nbuffer/cache multiple instances of DocumentBuilder. When\ngetDocumentBuilderFromPool is called, the queue is checked for an available\nbuilder, if none is available, one is created, but outside any\nlocks/synchronized objects. When returnDocumentBuilderToPool is called, the\nbuilder is inserted into the pool.\n\nThe approach is simple, and has the potential drawback, that eventually, there will be\nas many DocumentBuilders left in the pool, as there ever was a concurrent need\nto use. However, in many multithreaded applications, this will be what is\nneeded. In singlethreaded applications there will only be a single\ndocumentBuilder created, and the overhead of using a ConcurrentLinkedQueue is\nneglible.\n\n(Please pull the patch from github - thanks).I just ran the test script again and compared to a recent Spidermonkey build it is now 4x slower on Java 6 server HotSpot VM and 2x slower on Java 7 server VM. This is independent from the patch linked in the previous comment btw, so whatever dragged Rhino down seems to have been fixed elsewhere.',?,IMPROVEMENT
412247,'Allow to customize toBoolean conversion',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.11) Gecko/20071204 Ubuntu/7.10 (gutsy) Firefox/2.0.0.11\nBuild Identifier: \n\nECMA describes precisely that not null Object should be converted to true but this causes a problem when using Rhino to simulate Firefox behavior for document.all.\n\nRhino should give the possibility to configure if ECMA rules should be respected (default) or if Scriptable#getDefaultValue should be called on the object.\n\nThis is a critical requirement for us (HtmlUnit).\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 296926\npatch adding Context.FEATURE_NON_ECMA_TO_BOOLEAN and related unit test\n\nThis patch adds the feature Context.FEATURE_NON_ECMA_TO_BOOLEAN providing the feature we need to customize boolean conversion.\nIt contains the appropriate unit test.I posted to the mozilla.dev.tech.js-engine group and they referred me to bug 248549. There\'s a whole mechanism in SpiderMonkey for handling code that uses object detection on document.all that is deeper than just ToBoolean conversions. \n\nI\'ll think about how we approach this, but the right fix is more complex and probably should involve some special flag on host objects.Bug 248549 has a Calvin and Hobbes reference, yay!\n\nSpeaking seriously -- I couldn\'t fully understand the issue here as the bugreport escalated into an argument about principles and ideals. \n\nHtmlUnit people: would your proposed patch be sufficient to handle document.all, or do you envision you\'ll need other bits and pieces of support?\n\nI\'m willing to commit this patch, except I was thinking whether it would make more sense to introduce FEATURE_HTML_USER_AGENT as a generic flag to enable non-ECMA quirks found in HTML user agents instead of now adding FEATURE_NON_ECMA_TO_BOOLEAN, and then in future adding other flags for further quirks we discover down the road. Requests for other non-ECMA behaviour mostly reported via HtmlUnit people could also be implemented in such a way that they\'re enabled only when this feature is on (iteration order in for loop, unescaped / in character class in regex, etc.)\nWith the possibility to customize toBoolean I\'ll be able to handle \"if (document.all)\" and redefining the Boolean constructor I should be able to handle Boolean(document.all) without any change in Rhino itself.\n\nI can\'t say if a general FEATURE_HTML_USER_AGENT feature would make sense or not. In the case of this issue, it requires additional work for Rhino user and the feature doesn\'t bring anything alone. If I correctly understand the comments concerning unescaped / in character class in regex, it should be made the default. Concerning the properties order, ECMA doesn\'t forbid to make it the default (and so does my patch in https://bugzilla.mozilla.org/show_bug.cgi?id=412928). At the end the boolean conversion is the only point that I currently see concerned by FEATURE_HTML_USER_AGENT.\nI think a flag is the wrong approach for this problem. The issue is that you only want the special behavior for document.all, not all objects. Additionally, SpiderMonkey/Firefox evaluate (typeof document.all) -> \"undefined\", which your patch doesn\'t address. \n\nInstead, to match the SpiderMonkey/Firefox behavior we need a special host object flag that can indicate that the object needs to be treated specially. The object defined in your embedding to be returned by document.all would set this flag and get the special behavior. Other objects would behave normally. Marc, is your host object implementing document.all a subclass of ScriptableObject? I think the easiest way to have host objects define this flag would be to add a new boolean method on ScriptableObject with a default implementation you could override.Seems that you\'ve investigated it further than me: I didn\'t know (typeof document.all) -> \"undefined\".\n\nYes we implement ScriptableObject, a public or protected method on it to address current issue would be perfect for us.Created attachment 298707\nPatch implementing ScriptableObject.avoidObjectDectection\n\nWith proposed patch, and with a throwaway change for NativeDate.avoidObjectDetection to return true, Rhino\nhas the following behavior:\n\njs> var obj = {d:new Date()};\njs> obj.d ? true : false\nfalse\njs> if (obj.d) print(true); else print(false);\nfalse\njs> typeof obj.d\nundefined\njs> obj.d.getHours()\n9\n\nI\'ll test this and commit it unless someone objects.This is fine for me.\n(I have just checked and confirm that Boolean(x) - the missing part of the document.all problem - can be customized without any change within Rhino).Checked in:\n\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--\nScriptRuntime.java\nnew revision: 1.289; previous revision: 1.288\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <-\n-  ScriptableObject.java\nnew revision: 1.126; previous revision: 1.125\ndone(In reply to comment #8)\n> This is fine for me.\n> (I have just checked and confirm that Boolean(x) - the missing part of the\n> document.all problem - can be customized without any change within Rhino).\n> \n\nBut you still need this change, right?Yes, I need it too as I can\'t change it from \"outside\".\n\nThanks.> Specifically, the expression\n>     document.all ? true : false\n> results in false, but the expression\n>     Boolean(document.all)\n> results in true.\n\nRight, this is what required by ECMAScript specs. Javascript\nimplements both primitive boolean value and Boolean object wrapper. In\nlogical operations objects are being downcasted first to primitives\nwith Boolean(false) resulting in true in many circumstances. Try this\nfor instance in any browser:\n\n<script>\n var b1 = false;\n var b2 = new Boolean(false);\n\n /*1*/ window.alert(b1 ? \'true\':\'false\'); // false\n /*2*/ window.alert(b2 ? \'true\':\'false\'); // true\n</script>\n\nThe moral is that you never ever use Boolean wrapper for Javascript\nexcept one very particular situation which is not presented here.\n\nIn your case document.all returns undefined which is in Boolean\nconstructor context equal to Boolean(false) which is situation /*2*/\nin the sample above.\n\nSo the options are either to break Rhino compatibility with ECMAScript\nor to use the right style of boolean operations. I actually highly\nsurprised that on\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=412247\npeople seem ready to rather patch Rhino like no big problem which is\nsorry to say but IMO a total nonsense.\n\nIt is especially strange because in Java itself there are primitive boolean false/true as well as Boolean wrapper.\nYet it is requested to break the standard-compliant behavior for emulated Firefox so it would be equal to the actual Firefox behavior in order to (OP quote) \"simulate Firefox behavior for document.all\".\n\nSorry guys, either I\'m completely off the loop here or some participants are. I am ready to accept that I am.\n(In reply to comment #12)\n> Yet it is requested to break the standard-compliant behavior for emulated\n> Firefox so it would be equal to the actual Firefox behavior\n\nSorry:\n\n\"so it would be NOT equal\"(In reply to comment #12)\n> So the options are either to break Rhino compatibility with ECMAScript\n> or to use the right style of boolean operations. I actually highly\n> surprised that on\n> https://bugzilla.mozilla.org/show_bug.cgi?id=412247\n> people seem ready to rather patch Rhino like no big problem which is\n> sorry to say but IMO a total nonsense.\n\nActually, I see what we\'re doing here as a third option. We\'re breaking ECMAScript compatibility *only for host objects that explicitly request it*. So all current Rhino users should notice no change, and HtmlUnit can emulate Firefox behavior. You can argue that Firefox did the wrong thing in the way it implements document.all, but that ship has sailed and now HtmlUnit (and, by extension, Rhino) can best serve its users by emulating this behavior. Otherwise HtmlUnit is devalued as a testing tool.(In reply to comment #14)\n> (In reply to comment #12)\n> > So the options are either to break Rhino compatibility with ECMAScript\n> > or to use the right style of boolean operations. I actually highly\n> > surprised that on\n> > https://bugzilla.mozilla.org/show_bug.cgi?id=412247\n> > people seem ready to rather patch Rhino like no big problem which is\n> > sorry to say but IMO a total nonsense.\n> \n> Actually, I see what we\'re doing here as a third option. We\'re breaking\n> ECMAScript compatibility *only for host objects that explicitly request it*. So\n> all current Rhino users should notice no change, and HtmlUnit can emulate\n> Firefox behavior. You can argue that Firefox did the wrong thing in the way it\n> implements document.all, but that ship has sailed and now HtmlUnit (and, by\n> extension, Rhino) can best serve its users by emulating this behavior.\n> Otherwise HtmlUnit is devalued as a testing tool.\n\nCan anyone explain me what is the \"implementation\" of document.all in Firefox and what is exactly wrong with it? On my Firefox 2.0.0.11 it does the same thing all browsers did before: reports undefined for missing DOM feature.\n\n<script>\nalert(document.all === undefined); // true\nalert(document.FooBar === undefined); // true\n</script>\n\nI re-read the whole thread I see no bugs whatsoever - just OP that considers ECMAScript-compliant ternary expression as \"a bug\" so requesting to hack the engine. If there is not time to read ECMAScript 3rd ed. specs, please read my detailed post with explanations and samples at mozilla.dev.tech.js-engine: \nhttp://groups.google.com/group/mozilla.dev.tech.js-engine/msg/2884dfb8c781fa8d \nbtw after knowing the real production algorithm one may realize that any DOM patches do not solve the OP\'s problem: one still has to break the JS engine as well (condition expression production in ternary).You really seem to miss the point here. Just try following in your browser\n\njavascript:void(alert(document.all.foo))\n\nwhen an element has id=\"foo\", you will get it and otherwise you will get undefined, and not Error: document.all has no properties.\n(In reply to comment #16)\n> You really seem to miss the point here. Just try following in your browser\n> \n> javascript:void(alert(document.all.foo))\n> \n> when an element has id=\"foo\", you will get it and otherwise you will get\n> undefined, and not Error: document.all has no properties.\n\nThat is not what this bug is about, at least not as reported and discussed here or at http://groups.google.com/group/mozilla.dev.tech.js-engine/browse_frm/thread/69052055fba8f606\n\nMaybe this is why it is so convoluted in both cases, because two groups or people are discussing two completely different issues at once.\n\n[1]\nThis initial \"bug\" - which is not a bug at all - is about behavioral difference in Javascript between primitive boolean values and Boolean object wrapper, in the particular in the ternary operator.\n\nvar condition = Boolean(false);\ncondition ? doTrue() : doFalse();\n\nwill branch onto doTrue on any ECMAScript-compliant engine including Gecko. There is nothing to \"fix\" here whatsoever. If anyone gets surprised by the result then the only advise could be to read ECMAScript specs. If Boolean wrapper is really needed then a quick \"guardian fix\" could be in explicit downcasting into primitive before any boolean comparisons:\n\nvar condition = Boolean(false);\n!condition ? doTrue() : doFalse();\n\nnow goes to doFalse \"as expected\"\n\n[2]\nThe second issue is that in BackCompat (Quirk) mode Gecko partially emulates document.all.ElementID getter to meet some corporate customers ultimatum. This emulation is effective in BackCompat mode only but not in CSS1Compat mode.\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n<html>\n<head>\n<meta http-equiv=\"Content-Type\"\n content=\"text/html; charset=iso-8859-1\">\n<title>Demo</title>\n<script type=\"text/javascript\">\nfunction init() {\n window.alert(\'document mode: \'+document.compatMode);\n window.alert(document.all); // undefined\n window.alert(document.all.Demo); // HTML element\n}\nwindow.onload = init;\n</script>\n</head>\n<body>\n<h1 id=\"Demo\">Demo for BackCompat mode</h1>\n</body>\n</html>\n\nat the same time\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01//EN\">\n<html>\n<head>\n<meta http-equiv=\"Content-Type\"\n content=\"text/html; charset=iso-8859-1\">\n<title>Demo</title>\n<script type=\"text/javascript\">\nfunction init() {\n window.alert(\'document mode: \'+document.compatMode);\n window.alert(document.all === undefined); // true\n try {\n  window.alert(document.all.Demo);\n }\n catch(e) {\n  window.alert(e.message);\n  // no such property exception\n }\n}\nwindow.onload = init;\n</script>\n</head>\n<body>\n<h1 id=\"Demo\">Demo for CSS1Compat mode</h1>\n</body>\n</html>\n\nThis way it is indeed rather illogical picture: for BackCompat mode Gecko still reports document.all as undefined, yet document.all.ElementID is usable.\n\nIf someone doesn\'t like such behavior then one may file a bug like \n\"document.all in BackCompat mode should reported as object\"\n\nI still missing any relevance of the issue [2] to the actual programming. The feature test is always must be done on the early stage and if \"document.all\" is reported as missing, why in name anyone will try to use it later so getting any troubles? That besides that problem as such is only exposed in quirk mode which is a very strange mode for Gecko: how anyone may make a compatible layout with quirk mode, so one client applying W3C model and other applying IE model?\n\nAn any case the bug title is misleading and 3/4 of the discussion is about the issue [1] above and not about [2]\n(In reply to comment #17)\n\n> [2]\n> The second issue is that in BackCompat (Quirk) mode Gecko partially emulates\n> document.all.ElementID getter to meet some corporate customers ultimatum. This\n> emulation is effective in BackCompat mode only but not in CSS1Compat mode.\n\nBy the way due to the same ultimating requirement Gecko in BackCompat emulating another IE feature: all ID\'ed HTML elements being procreated as global Javascript variables.\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n<html>\n<head>\n<meta http-equiv=\"Content-Type\"\n content=\"text/html; charset=iso-8859-1\">\n<title>Demo</title>\n<script type=\"text/javascript\">\nfunction init() {\n window.alert(document.compatMode); // BackCompat\n window.alert(Demo); // HTMLElement\n}\nwindow.onload = init;\n</script>\n</head>\n<body>\n<h1 id=\"Demo\">Demo for BackCompat mode</h1>\n</body>\n</html>\n\nIs it planned to patch toBoolean for it as well?\n\n\n(In reply to comment #18)\n> [snip]\n> \n> Is it planned to patch toBoolean for it as well?\n> \n\nNo.\nComplete fix for bug 412247 - Allow to customize toBoolean conversion\nFix misspelling in method name (!) and correct support for Boolean(expr).\n\nChecking in src/org/mozilla/javascript/NativeBoolean.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeBoolean.java,v  <-- NativeBoolean.java\nnew revision: 1.34; previous revision: 1.33\ndone\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <-- ScriptRuntime.java\nnew revision: 1.290; previous revision: 1.289\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.127; previous revision: 1.126\ndone\n',?,RFE
412433,'compiler doesn\'t parse the regular expression correctly.',Rhino,Core,ohad.serfaty,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\nBuild Identifier: \n\nwhen trying to execute the String.split function on this argument : /[/?,/&]/ , rhino fails when it tries to parse the regular expression string\n\nReproducible: Always\n\nSteps to Reproduce:\n\tpublic void testMaleformedJavascript2()\n\t{\n\t\tContext context = Context.enter();\n\t\tScriptableObject scope = context.initStandardObjects();\n\t\tcontext.evaluateString(scope, \"\\\"\\\".split(/[/?,/&]/)\", \"\", 0, null);\n\t\tContext.exit();\n\t}\nActual Results:  \nno failure\n\nExpected Results:  \nfailure',?,BUG
412467,'Iterator value escapes from array comprehension',Rhino,Compiler,norrisboyd,nobody,'Created attachment 297203\ntestArrayComprehensionScope.js\n\nThe value of the iterand (is that a word?) in an array comprehension must be scoped to the array comprehension. This currently is not true in Rhino.\n\nThe attached test case demonstrates the problem.Norris, I can make that into js1_7/iterable/testArrayComprehensionScope.js if you like. And \"iterand\" has some fairly common usage whether its a real word or not ;-)(In reply to comment #1)\n> Norris, I can make that into js1_7/iterable/testArrayComprehensionScope.js if\n> you like.\n\nThat would be great, thanks!\n\n> And \"iterand\" has some fairly common usage whether its a real word or\n> not ;-)\n\nI guess computer terms have never been constrained by any dictionary!\n\nFixed in CVS: \n\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <-- \nNode.java\nnew revision: 1.71; previous revision: 1.70\ndone\nChecking in src/org/mozilla/javascript/NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v \n<--\n  NodeTransformer.java\nnew revision: 1.80; previous revision: 1.79\ndoneI went ahead an renamed the test to match the existing pattern.\n/cvsroot/mozilla/js/tests/js1_7/iterable/regress-412467.js\ninitial revision: 1.1\nI checked out and successfully ran the test. Thanks!',?,IMPROVEMENT
412755,'Provide better error message when a function is not found',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.11) Gecko/20071204 Ubuntu/7.10 (gutsy) Firefox/2.0.0.11\nBuild Identifier: \n\nthe error messages for \n  var a = {}; a.foo() // -> Cannot find function foo.\nand\n  var a = {foo: 1}; a.foo() // -> foo is not a function, it is java.lang.Double.\n\ndon\'t tell on which object function foo could not be found (here [object Object] which is not that useful, but this is only an example).\n\nAttached patch improves these error messages.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 297520\nPatch with unit test improving the error messagesFixed, accepting patch with some modifications:\n\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--\nScriptRuntime.java\nnew revision: 1.288; previous revision: 1.287\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properti\nes,v  <--  Messages.properties\nnew revision: 1.85; previous revision: 1.84\ndoneThanks.\n\nCan you explain your modifications. This would help to provide patch that better comply to Rhino \"style\". Particularly:\n- why didn\'t you include the unit test?\n- why did you remove the final keywords?',?,CLEANUP
413838,'Incorrect ScriptRuntime.eq(Object, Object) implementation',Rhino,Core,vyacheslav.soldatov,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; ru; rv:1.8.1.10) Gecko/20071128 Fedora/2.0.0.10-2.fc7 Firefox/2.0.0.10\nBuild Identifier: 1_6R7\n\nIn case of arguments (Wrapper, Wrapper) this method invokes following code:\n                if (x instanceof Wrapper && y instanceof Wrapper) {\n                    return ((Wrapper)x).unwrap() == ((Wrapper)y).unwrap();\n                }\n\nbut should invoke:\n                if (x instanceof Wrapper && y instanceof Wrapper) {\n                    return eq(((Wrapper)x).unwrap(), ((Wrapper)y).unwrap());\n                }\nThis bug may appearances, by example, if we have in current scope two equals wrapped string objects. It may be if the object is returned from another object. In this case the operator a == b returns false instead of true, but the operation a.equals(b) returns true. It not appears if we will use code\n(\"\" + a) == (\"\" + b) which casts the objects to real strings.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Create two equals wrapped strings (x = \"aaa\", y = \"aaa\") and put them into top level scriptable as indexed properties.\n2. execute script \"x == y\"\nActual Results:  \nfalse\n\nExpected Results:  \ntrue\n\nThe unit test by example of reproduce:\n/**\n * TestEq.java (24.01.2008)\n */\n\npackage com.uupdate.script.js;\n\nimport java.io.IOException;\nimport java.io.StringReader;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport org.mozilla.javascript.Context;\nimport org.mozilla.javascript.NativeJavaObject;\nimport org.mozilla.javascript.Script;\nimport org.mozilla.javascript.Scriptable;\nimport org.mozilla.javascript.tools.shell.Global;\n\nimport junit.framework.TestCase;\n\n/**\n * @author Vyacheslav Soldatov\n *\n */\npublic class TestEq extends TestCase {\n    /**\n     * The scripting context.\n     */\n    private Context context;\n\n    /**\n     * The constructor.\n     */\n    public TestEq() {\n        super();\n    }\n\n    /**\n     * @param name the test case name.\n     */\n    public TestEq(final String name) {\n        super(name);\n    }\n\n    /**\n     * @see junit.framework.TestCase#setUp()\n     */\n    @Override\n    protected void setUp() throws Exception {\n        context = Context.enter();\n    }\n\n    /**\n     * Tests \'==\' operator.\n     * @throws IOException comilation exception.\n     */\n    public void testEq() throws IOException {\n        Map<String, String> map = new HashMap<String, String>();\n        map.put(\"x\", new String(\"aaa\"));\n        map.put(\"y\", new String(\"aaa\"));\n\n        Scriptable scriptable =  new NativeJavaObject(new Global(), map, Map.class);\n        Object obj = compileScript(\"get(\'x\') == get(\'y\');\").exec(context, scriptable);\n        assertEquals(Boolean.TRUE, obj);\n    }\n\n    /**\n     * Tests \'equals\' work.\n     * @throws IOException comilation exception.\n     */\n    public void testEquals() throws IOException {\n        Map<String, String> map = new HashMap<String, String>();\n        map.put(\"x\", new String(\"aaa\"));\n        map.put(\"y\", new String(\"aaa\"));\n\n        Scriptable scriptable =  new NativeJavaObject(new Global(), map, Map.class);\n        Object obj = compileScript(\"get(\'x\').equals(get(\'y\'));\").exec(context, scriptable);\n        assertEquals(Boolean.TRUE, obj);\n    }\n\n    /**\n     * @param script the script body.\n     * @return compiled script. \n     * @throws IOException \n     */\n    private Script compileScript(final String script) throws IOException {\n        return context.compileReader(new StringReader(script), \"Unit test body\", 0, null);\n    }\n    /**\n     * @see junit.framework.TestCase#tearDown()\n     */\n    @Override\n    protected void tearDown() throws Exception {\n        Context.exit();\n    }\n}The proposed change won\'t work:\n\njs> var a = new java.util.HashMap();\njs> var b = new java.util.HashMap();\njs> a == b\nRHINO USAGE WARNING: Missed Context.javaToJS() conversion:\nRhino runtime detected object {} of class java.util.HashMap where it expected String, Number, Boolean or Scriptable instance. Please check your code for missing Context.javaToJS() call.\nfalse\n\nThe problem is that a Wrapper doesn\'t necessarily wrap a value that can be handled by the Rhino runtime (which is why we have Wrappers in the first place).  So passing the unwrapped values to eq() can cause the problem above. \n\nWhat if we just make this change instead:\n                if (x instanceof Wrapper && y instanceof Wrapper) {\n                    return ((Wrapper)x).unwrap().equals(((Wrapper)y).unwrap());\n                }\n?IMHO, eq(obj1, obj2) should be invoked only for primitive types and string, but should be invoked eq(obj1, obj2) certainly.\nBecause the method eq(obj1, obj2) correctly and accurately handles any situations when arguments have different types, by example:\nnew java.lang.String(\"1\") == new java.lang.Integer(1); //should be true\nand any other.\n\nBy example, following fix can be used:\n.......\n                if (x instanceof Wrapper && y instanceof Wrapper) {\n                \tObject obj1 = ((Wrapper)x).unwrap();\n                \tObject obj2 = ((Wrapper)y).unwrap();\n\n                \tif (isPrimitiveOrString(obj1) && isPrimitiveOrString(obj2)) {\n                \t\treturn eq(obj1, obj2);\n                \t}\n\n                    return obj1 == obj2;\n                }\n.......\nwhen\n    private static boolean isPrimitiveOrString(final Object obj) {\n    \treturn\n    \t\t(obj instanceof Number)\n    \t\t|| (obj instanceof String)\n    \t\t|| (obj instanceof Boolean);\n    }\nLooking at this more, I checked out the relevant ECMA section:\n\n11.9.3 The Abstract Equality Comparison Algorithm\nThe comparison x == y, where x and y are values, produces true or false. Such a comparison is\nperformed as follows:\n1. If Type(x) is different from Type(y), go to step 14.\n2. If Type(x) is Undefined, return true.\n3. If Type(x) is Null, return true.\n4. If Type(x) is not Number, go to step 11.\n5. If x is NaN, return false.\n6. If y is NaN, return false.\n7. If x is the same number value as y, return true.\n8. If x is +0 and y is ?0, return true.\n9. If x is ?0 and y is +0, return true.\n10. Return false.\n11.If Type(x) is String, then return true if x and y are exactly the same sequence of characters (same\nlength and same characters in corresponding positions). Otherwise, return false.\n12. If Type(x) is Boolean, return true if x and y are both true or both false. Otherwise, return false.\n13.Return true if x and y refer to the same object or if they refer to objects joined to each other (see\n13.1.2). Otherwise, return false.\n14. If x is null and y is undefined, return true.\n15. If x is undefined and y is null, return true.\n- 56 -\n16.If Type(x) is Number and Type(y) is String,\nreturn the result of the comparison x == ToNumber(y).\n17.If Type(x) is String and Type(y) is Number,\nreturn the result of the comparison ToNumber(x) == y.\n18. If Type(x) is Boolean, return the result of the comparison ToNumber(x) == y.\n19. If Type(y) is Boolean, return the result of the comparison x == ToNumber(y).\n20.If Type(x) is either String or Number and Type(y) is Object,\nreturn the result of the comparison x == ToPrimitive(y).\n21.If Type(x) is Object and Type(y) is either String or Number,\nreturn the result of the comparison ToPrimitive(x) == y.\n22. Return false.\n\nSince \"joined\" objects in step 13 refers only to function objects, we don\'t have the normal \"host object\" escape clause I would have expected. That means we can\'t implement something more than object identity in the case of two objects. I think the current implementation is correct as the same Java object could have two different wrappers.Yes, formally it is right. The java.lang.String is the java object and should be handled as punkt 13.\nBut see please example:\njs> var a = \"\";\njs> var b = \"\";\njs> a == b; //good result\ntrue\njs> var map1 = new java.util.HashMap();\njs> var map2 = new java.util.HashMap();\njs> map1.put(\"key\", a);\nnull\njs> map2.put(\"key\", b);\nnull\njs> map1.get(\"key\") == map2.get(\"key\"); //not good result because this is equals with a==b\nfalse\njs> \n\nIn last string the result of map1.get(\"key\") is the variable a, and result of map2.get(\"key\") is the variable b. If we directly compare them then result will \'true\' and if we compare them as results of operation get from corresponding map, the result will \'false\'. This is result of conversation rhino objects to java objects and back.\nThis is a cause. Two ways there are for resolving of this situation.\n1. Changing of implementation of work with java objects and methods. All returned values if they are primitive should be not wrapped.\n2. Wrapped java primitives should have a bihaviour like as corresponding native rhino primitive.\n\nIMHO second approach is more simple and natural.Thanks, that\'s a much more motivating example. The machinery of wrapping and unwrapping JavaScript primitives interferes with the normal comparison semantics.\n\nI\'ve submitted your proposed change with minor changes.',?,BUG
414098,'etter__ on array indexes',Rhino,Core,matthieu.riou,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9a8) Gecko/2007100620 GranParadiso/3.0a8\nBuild Identifier: rhino1_7R1\n\nAs discussed on the Rhino mailing-list with Norris Boyd:\n\nOn Jan 25, 10:02 am, Norris Boyd <norrisb...@gmail.com> wrote:\n> On Jan 25, 12:34 am, Matthieu Riou <matthieu.r...@gmail.com> wrote:\n> \n> > Rhino supports the __define[GS]etter__ as in SpiderMonkey, which is\n> > great! However, it doesn\'t work on arrays (even though it does work on\n> > SM):\n> \n> > js> a = [1,2,3]\n> > js> a.__defineGetter__(1, function() { print(\"masked!\"); });\n> > js> a[1]\n> > 2\n> \n> > This is somewhat understandable as arrays indexing has a few more\n> > specificities when compared to regular properties. However I think\n> > this is still an interesting feature.\n> \n> Agreed. If SpiderMonkey implements it, then Rhino not implementing it\n> was just an oversight.\n\nPatch to come as an attachment.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 299377\nAdds defineGSetter functionality to array indexes\n\nLet me know if there\'s anything wrong with the patch. I haven\'t found any problem after some testing but I\'m not 100\% familiar with the Rhino codebase yet.(In reply to comment #1)\n> Created an attachment (id=299377) [details]\n> Adds defineGSetter functionality to array indexes\n> \n> Let me know if there\'s anything wrong with the patch. I haven\'t found any\n> problem after some testing but I\'m not 100\% familiar with the Rhino codebase\n> yet.\n> \n\nThere are a set of optimizations I put in a couple of months ago for direct access to a dense representation of an array by many Array \"methods\". Look at js_reverse for a simple example. Note that if \"denseOnly\" is set, the method assumes that it can operate only against a Object[], resulting in huge speedups. \n\nI tried calling reverse on an array with a getter:\n\njs> a = [1,2,3]\n1,2,3\njs> a.reverse()\n3,2,1\njs> a\n3,2,1\njs> a.__defineGetter__(1, function() { print(\"masked!\"); });\njs> a[1]\nmasked!\njs> a.reverse()\nException in thread \"main\" java.lang.IllegalStateException\n        at org.mozilla.javascript.ScriptRuntime.getTopCallScope(ScriptRuntime.java:2968)\n...\n\nI didn\'t try to track down the cause of the exception. I think it makes sense to set \"denseOnly\" to false if a getter or setter is defined on the array, causing Rhino to drop back to using getters and setters for access to all array values.\n\nSorry for the late reply, I haven\'t received any notification from Bugzilla so I saw your comment only recently.\n\nFirst, I\'ve tried to set denseOnly to false as soon as __defineGetter__ or __defineSetter__ was called but that didn\'t fix the error. But it did improve the situation (more on that later).\n\nThe error is caused by a bug in ScriptableObject on line 1982 and 2065 where a call to the topCallScope is made where, I think, the function parent scope should be used. Like this:\n\n  Function f = (Function)getterObj;\n  Context cx = Context.getContext();\n  return f.call(cx, f.getParentScope(), start, \n                ScriptRuntime.emptyArgs);\n\nWith this modification, the error doesn\'t occur anymore and everything looks fine.\n\nHowever after more testing functions like pop() started behaving strangely, with the underlying property value being used instead of the getter value. Like this:\n\njs> a=[1,2,3];\njs> a.__defineGetter__(1, function() { return 55; });\njs> a.pop()\n3\njs> a.pop()\n2\n\nThe last pop should logically have returned 55. But setting denseOnly to false when __define[GS]etter__ in the way you mentioned fixed this.\n\nSo with these two additional fixes I\'ve been able to run sessions like the following:\n\njs> a=[1,2,3];\n1,2,3\njs> var foo = 44;\njs> a.__defineGetter__(1, function() { return foo + 10; });\njs> a\n1,54,3\njs> a.reverse();\n3,54,1\njs> a.forEach(function(e) { print(e); });\n3\n54\n1\njs> a.join(\' - \');\n3 - 54 - 1\njs> a.sort();\n1,54,54\njs> a[2]=3;\n3\njs> a\n1,54,3\njs> a.pop();\n3\njs> a.pop();\n54\n\nThe result to sort() can seem strange at first but it\'s actually logic and consistent with what SM produces.\n\nI\'m going to attach the new patch to this issue. Let me know if you notice any other problem.\n\nThanks!Created attachment 300984\nSupport for __define[GS]etter__ on array (take 2)\n\nAdds a fix on the context used to call a getter/setter function and sets denseOnly to false.Created attachment 301533\nregress-414098.js\n\nProposed test caseCreated attachment 301535\nregress-414098.js\n\nOops, here\'s the correct version of the fileBob, can you review the regression test?Fixed in both cvs trunk and 1.7R1 branch.Comment on attachment 301535\nregress-414098.js\n\nr+, please put in js1_6/extensions/ since it uses __defineGetter__\n\nThanks!Test committed, thanks!Matthieu, I added some additional checks on !denseOnly before calling isGetterOrSetter because I was worried about performance impact. Can you take a look at what\'s in CVS to see if it looks good? It passes the test case I created based on this bug.The changes look good. I actually hesitated adding the condition but thought you\'d have a better idea of the balance you\'re looking for in terms of performance.\n\nThanks!Created attachment 362051\nchanges to s1_5/extensions/regress-452178.js, s1_6/extensions/regress-414098.js\n\nNorris: bug 478047 is changing the behavior on Spidermonkey when trying to set a property that only has a getter defined. This is the change to the affected tests to match the new behavior. How would you like to deal with this? File a bug on Rhino or special case Rhino?Bug 478047 was actually filed as a result of work I\'ve been doing on Rhino, so Rhino already has been changed to match the new behavior from bug 478047. No need to do anything additionally on your side.\n\nWhen I ran the tests against it I did get a failure on js1_5/extensions/regress-341956-01.js. Did you not get a failure on that test?No, I didn\'t. Was the failure you saw on the unshift? It might be related to the lack of failure with pop in Spidermonkey as well. Blake?(In reply to comment #15)\n> No, I didn\'t. Was the failure you saw on the unshift? It might be related to\n> the lack of failure with pop in Spidermonkey as well. Blake?\n\npop doesn\'t fail because it uses \'delete\' to delete elements, it doesn\'t set them.',?,RFE
414553,'destructuring assignment in let causes bindings to be lost',Rhino,Compiler,norrisboyd,norrisboyd,'ben.rees...@gmail.com   \t\nView profile\n\t More options Jan 28, 3:21 pm\nNewsgroups: mozilla.dev.tech.js-engine.rhino\nFrom: ben.rees...@gmail.com\nDate: Mon, 28 Jan 2008 12:21:23 -0800 (PST)\nLocal: Mon, Jan 28 2008 3:21 pm\nSubject: destructuring assignment bug?\nReply | Reply to author | Forward | Print | View thread | Show original | Report this message | Find messages by this author\nHi,\n\nI have stumbled across a behavior that doesn\'t seem correct in the CVS\nversion of Rhino. It seems that the presence of a destructuring\nassignment in a let-block causes the other variables to lose their\nbindings.\n\n$ java -cp js.jar org.mozilla.javascript.tools.shell.Main -version 170\nRhino 1.7 release 1 2008 01 28\njs> let(a = 1, [b,c] = [2,3], d = 4) { [a,b,c,d] }\n,2,3,\njs>\n\nAs I am new to the Rhino codebase I\'m expecting it will take me a\nlittle while to generate a patch for this, so if someone else also\nwanted to take a look at it that would probably be helpful. I suppose\nit\'s also possible that I simply misunderstand the specified behavior\nand that there actually isn\'t a problem.\n\nCheers,\nBen ReesmanFixed: \n\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.117; previous revision: 1.116\ndone\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.72; previous revision: 1.71\ndone\nChecking in src/org/mozilla/javascript/NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.81; previous revision: 1.80\ndone\nCreated attachment 300080\njs1_7/regress/regress-414553.js\n\nProposed test caseFixed function case missed in previous checkin:\n\nChecking in src/org/mozilla/javascript/NodeTransformer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NodeTransformer.java,v  <--  NodeTransformer.java\nnew revision: 1.82; previous revision: 1.81\ndone\nAdd cc for bclary; please review proposed test case when you have a chance.Comment on attachment 300080\njs1_7/regress/regress-414553.js\n\n\n>//-----------------------------------------------------------------------------\n>var BUGNUMBER = 414553;\n>printBugNumber(BUGNUMBER);\n>printStatus(summary);\n>\n>var expected = \'1,2,3,4\';\n>\nnit: delete blank line?\n>var actual = let (a = 1, [b,c] = [2,3], d = 4) ( String([a,b,c,d]) );\nnit: insert blank line?\n>reportCompare(expected, actual, \'destructuring assignment in let\');\n>\n>function f() {\n>  let (a = 1, [b,c] = [2,3], d = 4) {\n>    return String([a,b,c,d]);\n>  }\n>}\nnit: insert blank line?\n>reportCompare(expected, f(), \'destructuring assignment in let inside func\');\n\nSorry for the delay. I\'m in the middle of a work week in mtview and am behind on a couple of things (even more so than usual) ;-)\n\nThanks!Committed, thanks! Sorry, didn\'t mean to rush you--I wasn\'t sure what the best way to get it on your to-do list was.\n\n',?,BUG
414554,'ClassCache should use WeakHashMap',Rhino,Core,norrisboyd,nobody,'For better memory management, ClassCache should use WeakHashMap.Created attachment 300008\nProposed patchCommitting change:\n\nChecking in src/org/mozilla/javascript/ClassCache.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ClassCache.java,v  <--  ClassCache.java\nnew revision: 1.17; previous revision: 1.16\ndone\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\nnew revision: 1.108; previous revision: 1.107\ndone\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\nnew revision: 1.73; previous revision: 1.72\ndone\n',?,IMPROVEMENT
414869,'Rhino debugger fails to launch due to updates in mac os x leopard',Rhino,Core,mike.hatfield,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\nBuild Identifier: rhino1_6R7\n\nThe component count has changed in Mac OS X Leopard, causing the exception shown in the Actual Results field. To fix, update the updateToolTip() function in SwingGui.java as shown in the Additional Information field.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Launch debugging tool window in Mac OS X 10.5\nActual Results:  \nException in thread \"AWT-EventQueue-0\" java.lang.ArrayIndexOutOfBoundsException: No such child: 1 \nat java.awt.Container.getComponent(Container.java:280) \nat org.mozilla.javascript.tools.debugger.FileWindow.updateToolTip(SwingGui.java:2196) \nat org.mozilla.javascript.tools.debugger.FileWindow.<init>(SwingGui.java:2176) \nat org.mozilla.javascript.tools.debugger.SwingGui.createFileWindow(SwingGui.java:455) \nat org.mozilla.javascript.tools.debugger.RunProxy.run(SwingGui.java:3545) \nat java.awt.event.InvocationEvent.dispatch(InvocationEvent.java:209) \n\n\n\nExpected Results:  \nDebugging tool shown\n\n\n    private void updateToolTip() {\n         // On Mac OS X 10.5, the number of components is different\n         int n = getComponentCount() - 1;\n         if (n > 1) {\n             n = 1;\n         } else if (n < 0) {\n             return;\n         }\n\n        // in case fileName is very long, try to set tool tip on frame\n        Component c = getComponent(n);\n        // this will work at least for Metal L&F\n        if (c != null && c instanceof JComponent) {\n            ((JComponent)c).setToolTipText(getUrl());\n        }\n    }Created attachment 300651\npatch to avoid ArrayIndexOutOfBoundsException\n\nThis bug has also been reported for Helma: http://helma.org/bugs/show_bug.cgi?id=590\n\nThe problem seems to be indeed that the number of component is just 1 on Mac, while it\'s 2 on other platforms. I don\'t have a Mac myself, but I was able to test it quickly on a co-worker\'s macbook. This patch contains the fix proposed in the original report. \n\nAdditionally it contains a check to avoid NullPointerExceptions when populating the debugger context table, which I got for null and String values while testing. Hope it\'s ok to sneak that in without opening another bug :-)Thanks. Checked in:\n\nChecking in toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java,v  <--  SwingGui.java\nnew revision: 1.13.2.1; previous revision: 1.13\ndone\n\nChecking in toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java,v  <--  SwingGui.java\nnew revision: 1.14; previous revision: 1.13\ndone\n\n',?,BUG
414984,'Array.lastIndexOf gives ArrayIndexOutOfBoundsException',Rhino,Core,asashour,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)\nBuild Identifier: Latest in CVS\n\nThe following code gives an exception in latest code in CVS:\n\n[0,2,4,6].lastIndexOf(4)\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Fixed: \n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.84; previous revision: 1.83\ndone\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.83.2.1; previous revision: 1.83\ndone\n',?,BUG
415451,'Array.lastIndexOf does not work correctly',Rhino,Core,asashour,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)\nBuild Identifier: \n\nThe following code should return 3 instead of 0.\n\n[2, 5, 9, 2].lastIndexOf(2,-1)\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.\n\n\nExpected Results:  \n3Created attachment 301267\njs1_5/Regress/regress-415451.js\n\nProposed test caseChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  Na tiveArray.java\nnew revision: 1.86; previous revision: 1.85\ndone\n\nChecking in NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.83.2.3; previous revision: 1.83.2.2\ndone\nBob, can you review the proposed regression test when you have a chance?Comment on attachment 301267\njs1_5/Regress/regress-415451.js\n\nr+ but put it in js1_5/extensions since Array.prototype.indexOf is not required by the standard.\n\nCould you flip the in-litmus flag to - and the in-testsuite flag to + when you check in please?Actually, js1_6/Array is the better place for this.Checking in js1_6/Array/regress-415451.js;\n/cvsroot/mozilla/js/tests/js1_6/Array/regress-415451.js,v  <--  regress-415451.js\ninitial revision: 1.1\ndone\n\nAlso flipped bits.',?,BUG
415508,'PolicySecurityController bug: it creates lots of SecureCallerImpl instances!',Rhino,Core,songguoq,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\nBuild Identifier: Rhino 1.6R7\n\nIn Rhino 1.6R7, the class PolicySecurityController contains a bug in method \'callWithDomain\' such that it creates a new instance of SecureCallerImpl every time the method is invoked.\n\nThe bug caused OutOfMemory error when I called Rhino to evaluate a lot of scripts.\n\nThe problem happens because there is a missing line at 169:\n\nclassLoaderMap.put(classLoader, new SoftReference<SecureCaller>(caller))\n\nAfter adding the line, the code can remember the instances of SecureCaller it creates and reuse it if it has not been garbage collected.\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\nRunning some profiler (such as JProfiler) to see the number of instances of SecureCallerImpl created.Nice analysis of the problem, and a perfect fix - thank you.\nCommitted the fix to CVS HEAD:\n\n    Checking in src/org/mozilla/javascript/PolicySecurityController.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/PolicySecurityController.java,v  <--  PolicySecurityController.java\n    new revision: 1.7; previous revision: 1.6\n    done\n\n',?,BUG
415540,'Incorrect behavior for Array.push',Rhino,Core,norrisboyd,nobody,'Posting on the newsgroup by Matthieu Riou:\n\nHi,\n\nI think I\'ve found a small bug in the Array.function shortcut (instead\nof Array.prototype.function.call(...)). Here is the testcase:\n\njs> var Constr = function() {};\njs> Constr.prototype = [];\njs> c = new Constr();\njs> c.push(1);\n1\njs> c.push(2);\n2\njs> Array.push(c,3);\n4\njs> c\n1,2\n\nLet me know if you\'d like me to file a Bugzilla issue. With a few\npointers I don\'t mind looking into it but it\'s probably going to be\nquicker for you to fix it anyway :)\n\nThanks,\nMatthieuCreated attachment 301268\njs1_6/Regress/regress-415540.jsFixed. \n\nBob, can you review the proposed regression test?The form of the test looks ok. It should be in js1_6/Array though. \n\nSpiderMonkey fails the reportCompare(\"5,6,7\", String(c), \"contents of c\"); line with regress-415540.js:52: TypeError: Array.prototype.toString called on incompatible Object. I\'ll wait on the r+ until Brendan vets the TypeError.\n\nBrendan, is this a SpiderMonkey bug?\nSpiderMonkey behavior agrees with ECMA:\n\n15.4.4.2 Array.prototype.toString ( )\nThe result of calling this function is the same as if the built-in join method were invoked for this object with no argument.\nThe toString function is not generic; it throws a TypeError exception if its this value is not an Array object. Therefore, it cannot be transferred to other kinds of objects for use as a method.\n\nI guess toString isn\'t genericized. I\'ll change the test.\nCreated attachment 301436\njs1_6/Array/regress-415540.js\n\nUpdated test case(In reply to comment #4)\n> SpiderMonkey behavior agrees with ECMA:\n> \n> 15.4.4.2 Array.prototype.toString ( )\n> The result of calling this function is the same as if the built-in join method\n> were invoked for this object with no argument.\n> The toString function is not generic; it throws a TypeError exception if its\n> this value is not an Array object. Therefore, it cannot be transferred to other\n> kinds of objects for use as a method.\n\nyep, but you are using:\n\nvar actual = Array.push(c,7);\n\nwhich I don\'t think is defined in ecma262-3.I\'ve changed Rhino and the test to match SpiderMonkey on this. Can I submit the test given that I\'m just regression testing the existing behavior?Comment on attachment 301436\njs1_6/Array/regress-415540.js\n\nr=shaver; land at will.  Thanks!Norris, do you need me to check the test in for you?I\'ve committed it--thanks!',?,BUG
416127,'shell.html not found',Rhino,Core,josepharmbruster,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\nBuild Identifier: Rhino 1.7 release 1 2008 02 05\n\nshell.html is not found in the source tree\n\nReproducible: Always\n\nSteps to Reproduce:\n1 I downloaded and uncompressed rhino1_7R1-RC2.zip\n2 I ran:  ant compile-all\n3 I ran:  ant javadoc\n4 I ran:  java -jar js.jar\n5 I typed:  help()\n\nThe help states:  \"For full description of all available commands see shell.html in the docs directory of Rhino distribution.\"\n\nI cannot seem to find this file.  Is this comment stale?Yes, this comment is stale. I\'ve removed it.\n\nChecking in toolsrc/org/mozilla/javascript/tools/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.33; previous revision: 1.32\ndone\n',?,CLEANUP
418034,'[PATCH] Rhino shell improvement - better line editing',Rhino,Compiler,matthieu.riou,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9b3pre) Gecko/2008020507 Firefox/3.0b3pre\nBuild Identifier: \n\nThis is the first version of a patch to improve the Rhino shell by adding line editing, history and completion. It relies on the JLine library to work but the dependency is optional at runtime.\n\nA bit more about the implementation itself. Instead of relying only on reflection, which worked but led to a rather ugly code, I\'ve added a new file that includes all the JLine code. The classes contained in that file are only loaded if JLine is found in the classpath. The drawback is that JLine is required for compilation but I don\'t think it\'s a big problem, I\'ve just modified a bit the Ant scripts.\n\nOn the plus side it allowed me to implement a custom completor (the interface that handles completion in JLine) and add completion for all Rhino shell functions (load, print, spawn, ...).\n\nLet me know how it goes...\n\nReproducible: AlwaysCreated attachment 303815\nPatch to rely on JLine for a better shell\n\nA separate file must be added in addition to this patch.Created attachment 303816\nJLine hooks\n\nCopy this file in toolsrc/org/mozilla/javascript/tools/shell.I finally got a chance to try this out. Works great from the command line on Unix and Windows. Doesn\'t work so well from the Eclipse console: on Unix the entered text is printed out when enter is pressed, so that the text is effectively repeated. And on Windows the shell terminates before accepting any input. \n\nPerhaps the thing to do is just provide a command-line switch to disable this that could be used from within Eclipse. It\'d be better to detect if you\'re running in an Eclipse console, but I don\'t know if that\'s possible. \n\nIdeas?Actually I was seeing it as an opt-in feature, if JLine is in your classpath then it uses it, otherwise just don\'t use Jline. I\'d be surprised if folks who run this into an Eclipse console were using JLine already. Or you think that an additional option is necessary?Well, the problem is that if you load all the source into Eclipse then you need JLine to compile. I suppose another option is to exclude JLine from the source list, or to make it so ShellLine will compile without JLine. I\'ll look at the latter on my flight Monday if I have a chance.I changed ShellLine to just use reflection and I\'ve now committed the changes.\n\nThanks for contributing this; it makes the console much more pleasant to use! If I get more time to play with this I may explore completion for object/property chains starting with global variables (e.g. java.lang.Str^I)',?,IMPROVEMENT
419090,'Object properties list in different (hash?) order than entered',Rhino,Core,cwolves,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.12) Gecko/20080201 Firefox/2.0.0.12\nBuild Identifier: \n\nObject properties seem to be returned in hash order in a for-each loop as opposed to entered order.  e.g.:\n\n{a:1, b:1, c:1} appears as {b:1, c:1, a:1}.  I believe it\'s hash order because {c:1, b:1, a:1} or any other order you specify always returns the same order (b, c, a).\n\nReproducible: Always\n\nSteps to Reproduce:\n1. create an object with properties\n2. echo the properties of that object\nActual Results:  \nproperties returned in hash-order\n\nExpected Results:  \nproperties return in entered order\n\nI fully realize that from a programatic point of view this does not matter.  It does, however, matter in terms of a usability point of view.  If there is a logical order to the properties and you view the object, that order is discarded.  e.g.:\n\nmyObj: {posX: 10, posY: 10, posZ: 10, width: 10, height: 10, depth: 10}\n\nreturns:\n\n{\"height\": 10, \"posY\": 10, \"posX\": 10, \"width\": 10, \"posZ\": 10, \"depth\": 10}Hi,\n\nIt seems that all the browser interpreters implement this feature, so it\'s something that we at HtmlUnit (which emulates a browser and uses Rhino) would like to have.\n\nI have two questions:\n\n1. Would a patch fixing this \"bug\" be accepted, assuming it\'s up to snuff technically?\n\n2. Would it be preferrable to: a) modify the contract of Scriptable#getIds() so that it is guaranteed to return property IDs in definition order, or b) add a new method (Scriptable#getOrderedIds(), for example) that is used only by ScriptRuntime#enumChangeObject(IdEnumeration)?\n\nRegards,\n\nDanielCreated attachment 307332\nproposed patch\n\nAttaching proposed patch which uses a doubly-linked list of slots to keep track of property definition order.Strictly speaking, the current behavior is acceptable under ECMA. However, matching the behavior of JS engines in browsers is important. Bug 383592 is an open request with a proposed patch for making the architecture pluggable so that people who want a well-defined iteration order (and are willing to pay the performance penalty) can do so. This is probably the way to go, but in my work with it so far the performance cost of switching to the standard Java Map classes is too high. So some work needs to be done to improve performance before I can switch.I\'ve committed a modified version of the proposed patch (thanks!):\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.131; previous revision: 1.130\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/serialize.doctest,v\ndone\nChecking in testsrc/doctests/serialize.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/serialize.doctest,v  <--  serialize.doctest\ninitial revision: 1.1\ndone\n\nMy only changes were to go from a doubly-linked list to a singly-linked list to reduce the memory footprint. In my profiling the performance impact of adding this list was minimal. ',?,BUG
419491,'Rhino downloads and packages proprietary Sun files as part of its build process',Rhino,Core,mozilla,nobody,'Rhino currently downloads and packages four Sun files as part of its build process:\n\nAbstractCellEditor.java\nJTreeTable.java\nTreeTableModel.java\nTreeTableModelAdapter.java\n\nThis invalidates the Rhino licensing.\n\nApparently these files are used for some debugger UI or something?\n\nThere should be an option to build a Rhino package that doesn\'t include these proprietary files.If these files aren\'t vital for Rhino proper, the easiest fix is indeed to make their inclusion require a specific build option. In the long term, it would be good to get these files, if they are still needed, relicensed under something compatible with Rhino. Sun may well be happy to do that, given their current stance on free Java.\n\nBut for that, I\'d need a clear statement from a Rhino lead saying that the files are still used and useful, and that they\'d like me to investigate that possibility.\n\nGervIt is my understanding these are required for the debugger GUI. Their inclusion in the project predates my involvement, so I\'m not 100\% clear about their status. I know that we aren\'t hosting the source files, but that our build process is pulling them from Sun\'s website automatically for compilation. It might be the case that we aren\'t allowed to redistribute their sources (which we don\'t), but we can redistribute the binary compiled classfiles.\n\nIt would indeed be preferred to get an explicit permission from Sun, so we\'re in the clear. Especially since lacking it, we\'d need to either separate the debugger GUI into a different package, or distribute it in source code only and have people who need it run the build task for it themselves.  I definitely think you should split out the debugger UI. There are many use cases for Rhino that do not include the debugger UI.\n\nAlso, My bet is that the redistribution of binary files separate from the original distribution is not allowed either.\n\nI\'d like to know if there was ever an agreement with Sun to do this.(In reply to comment #2)\nAttila:\nI think that the GuI and build code that pulls those sources should be excluded from the default js.jar .\nand only a manual build option (with a detailed readme) should allow inluding those bits.\nwhat do you think?\nwould you are for a patch?(In reply to comment #4)\n\nAs I said, these files were first included before I got involved with the project, so I don\'t know if we have some sort of a separate agreement/permission from Sun. I\'ve notified Norris; he\'ll hopefully have some additional information from him soon.The odd part is that these are just code samples from an article:\n\nhttp://java.sun.com/products/jfc/tsc/articles/treetable2/ \n\nBut the code is marked proprietary/confidential.\n\nUnfortunately neither of the two people involved in writing the article work for Sun anymore.I\'ll let you guys work on a technical fix; I\'ve sent an email to Sun to ask them if they would be kind enough to solve the problem from the legal end.\n\nGerv\nThanks: is there anything I could help with?I\'ve refactored the build so we no longer ship binaries built from those files. Norris: that\'s great, thanks :-) Would it be possible to push a Rhino point release, perhaps just with that change, so the latest stable code we are distributing doesn\'t have this problem?\n\nGervNorris:\nThanks! yes, that would be great to push a point release!Gentlemen,\nI\'m told all the code in question has now been republished under  \nsuitable licenses at:\n\nhttp://java.sun.com/products/jfc/tsc/articles/treetable2/src/JTreeTable1.java\nhttp://java.sun.com/products/jfc/tsc/articles/treetable2/src/AbstractCellEditor.java\nhttp://java.sun.com/products/jfc/tsc/articles/treetable2/src/TreeTableModel.java\nhttp://java.sun.com/products/jfc/tsc/articles/treetable2/src/TreeTableModelAdapter.java\n\nPerhaps oneone would care to download these copies of the code and restore Rhino to its former form?\n\nGerv',?,CLEANUP
419940,'Incorrect JavaAdapter generation for base class that overrides an abstract method',Rhino,Compiler,norrisboyd,norrisboyd,'If you define a class as so:\npublic abstract class BaseFoo {\n  public abstract String doSomething();\n}\npublic class Foo extends BaseFoo {\n  public String doSomething() {\n     return \"hello world\";\n  }\n}\n\nand you do in Rhino:\nvar aFoo = new JavaAdapter(Packages.com.google.Foo, {});\n\nwhat is the return of:\naFoo.doSomething()\n\nThe answer is... the string \'undefined\'!\n\nShould be \"hello world\".Created attachment 306120\n419940.patch\n\nProposed patchCreated attachment 306121\ntestsrc\\org\\mozilla\\javascript\\tests\\Bug419940Test.javaFixed:\n\nChecking in testsrc/org/mozilla/javascript/tests/Bug419940Test.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug419940Test.jav\na,v  <--  Bug419940Test.java\ninitial revision: 1.1\ndone\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  Ja\nvaAdapter.java\nnew revision: 1.112; previous revision: 1.111\ndone',?,BUG
420012,'VerifyError on generated class',Rhino,Compiler,norrisboyd,norrisboyd,'From newsgroup:\n\nI am experiencing a problem with ClassCompiler with some of my scripts\nusing either rhino 1.6 or 1.7\njs.jar manifests...\n\nrhino 1.6 from 11/18/2006\nManifest-Version: 1.0\nAnt-Version: Apache Ant 1.6.5\nCreated-By: 1.5.0_06-b05 (Sun Microsystems Inc.)\nMain-Class: org.mozilla.javascript.tools.shell.Main\nClass-Path: xbean.jar\n\nrhino 1.7 from 8/19/2007\nManifest-Version: 1.0\nAnt-Version: Apache Ant 1.6.5\nCreated-By: 1.5.0_07-b03 (Sun Microsystems Inc.)\nMain-Class: org.mozilla.javascript.tools.shell.Main\nClass-Path: xbean.jar\n\nthe following contrived code example exhibits the problem producing a\njava.lang.VerifyError when a new instance is created.\nverifyError.js\n\nvar o = new Object;\no.setX = function (id) {\n   this.oid = id;\n}\n\nfunction setX(n) {\n        if (n == \"\" || n == null)\n                n = 0;\n\n   var s = new Object;\n   s.xyz = n;\n\n        if(s != null) {\n            o.setX(s.xyz);\n        }\n}\n\nsetX(\'x\');\n\nall compilations using jdk1.6...\n> java -version\n\njava version \"1.6.0_01-ea\"\nJava(TM) SE Runtime Environment (build 1.6.0_01-ea-b03)\nJava HotSpot(TM) Server VM (build 1.6.0_01-ea-b03, mixed mode)\n\n> java org.mozilla.javascript.tools.jsc.Main -nosource -O 9 -version 160 verifyError.js\n> java -classpath $classpath verifyError\n\nException in thread \"main\" java.lang.VerifyError: (class: verifyError,\nmethod: _c2 signature: (LverifyError;Lorg/mozilla/javascript/\nContext;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla/javascript/\nScriptable;Ljava/lang/Object;D[Ljava/lang/Object;)Ljava/lang/Object;)\nRegister 4 contains wrong type\nat java.lang.Class.getDeclaredConstructors0(Native Method)\nat java.lang.Class.privateGetDeclaredConstructors(Class.java:2389)\nat java.lang.Class.getConstructor0(Class.java:2699)\nat java.lang.Class.newInstance0(Class.java:326)\nat java.lang.Class.newInstance(Class.java:308)\n\nchanging version to 120 or 140 has no effect...\n\n> java org.mozilla.javascript.tools.jsc.Main -nosource -O 9 -version 140 verifyError.js\n> java org.mozilla.javascript.tools.jsc.Main verifyError\n\nException in thread \"main\" java.lang.VerifyError: (class: verifyError,\nmethod: _c2 signature: (LverifyError;Lorg/mozilla/javascript/\nContext;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla/javascript/\nScriptable;Ljava/lang/Object;D[Ljava/lang/Object;)Ljava/lang/Object;)\nRegister 4 contains wrong type\n\nchanging optimization to 1 has no effect...\n\n> java org.mozilla.javascript.tools.jsc.Main -nosource -O 1 -version 140 verifyError.js\n> java org.mozilla.javascript.tools.jsc.Main verifyError\n\nException in thread \"main\" java.lang.VerifyError: (class: verifyError,\nmethod: _c2 signature: (LverifyError;Lorg/mozilla/javascript/\nContext;Lorg/mozilla/javascript/Scriptable;Lorg/mozilla/javascript/\nScriptable;Ljava/lang/Object;D[Ljava/lang/Object;)Ljava/lang/Object;)\nRegister 4 contains wrong type\n\nchanging optimization to -1 or zero works...\n\n> java org.mozilla.javascript.tools.jsc.Main -nosource -O 0 -version 140 verifyError.js\n> java org.mozilla.javascript.tools.jsc.Main verifyError\n\nno exception thrown.\n\noddly enough, certain minor code changes cure the problem.   e.g.\n\ncomment out...\n/*\n           if (n == \"\" || n == null)\n                n = 0;\n*/\n\nor comment out...\n//  o.setX(s.ID);\n\nor change...\ns.xyz = 1;\n\nor...\n\nchange one of the function names so that they are different.\n\neach of these trivial modifications cures the problem in all\ncompilation cases.Created attachment 306400\nProposed patchFixed:\n\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <\n--  Codegen.java\nnew revision: 1.261; previous revision: 1.260\ndone',?,BUG
421071,'Performance problems after using importPackage',Rhino,Core,krzysztof.karczmarczyk,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.12) Gecko/20080201 Firefox/2.0.0.12\nBuild Identifier: 1.6R5\n\nThere seems to be a problem between 1.5 and 1.6 release when using importPackage(). \n\nReproducible: Always\n\nSteps to Reproduce:\nFor below snippet:\n\nimportPackage(java.util);\nvar searchmon = application.data[\"month\"].value;\nvar searchday = application.data[\"day\"].value;\nvar searchyear = application.data[\"year\"].value;\nvar searchwkday = application.data[\"wkDay\"];\n\nvar myDate = Calendar.getInstance();\nmyDate.set(Calendar.MONTH, searchmon);\nmyDate.set(Calendar.DATE, searchday);\nmyDate.set(Calendar.YEAR, searchyear);\nsearchwkday.value = myDate.get(Calendar.DAY_OF_WEEK);\n\nActual Results:  \nAn approximate performance drop is at magnitude of 10. Once you replace importPackage() with importClass(), there is no performance issue.\n\nExpected Results:  \nThe performance is the same or better with newer release (1.6x)\n\nAfter investigation it turned out the problem is either in caching inside the\nNativeJavaPackage.getPkgProperty(String name, Scriptable start, boolean createPkg), or in the general approach in the TopLevelScope. It looks like EVERY variable goes through the package evaluation process whenever importPackage has been used. The getPkgProperty() takes care of the previously FOUND classes but does not cache the information about classes that HAVE NOT BEEN FOUND, thus searching over and over for the classes that does not exist and failed previously.\n\nAs a workaround I used my own class loaded that caches the information about not found classes and fails fast. However, either the clarification on the actual intent (read - \'yes, we want to dynamically check for new classes\') or the fix is needed here.By TopLevelScope I meant ImporterTopLevel.Looking at the latest CVS source, I\'m not seeing this behavior.\n\nI put a breakpoint on NativeJavaPackage.getPkgProperty, then access a globally defined variable, both before and after executing importPackage. I don\'t get any calls to NativeJavaPackage.getPkgProperty for variables that are defined at the top level. \n\nIn your example code, I was assuming that \"application\" and \"Calendar\" were defined by your application. Are you using shared scopes or any other configuration that might come into play here?\n\nAnd as far as intent, I was not trying to detect dynamically loaded classes by repeatedly attempting to load them. I\'m fine with Rhino only attempting to load a class once and upon failure thereafter assuming it doesn\'t exist.OK, using 1.6R5 and below example code you should be able to reproduce.\n\n/*\n * @(#)Bug421071Test.java\n *\n * Copyright (c) 2008 Sabre, Inc. All rights reserved.\n */\n\npackage org.mozilla.bugs.bug421071;\n\nimport junit.framework.TestCase;\nimport org.mozilla.javascript.Context;\nimport org.mozilla.javascript.ImporterTopLevel;\nimport org.mozilla.javascript.Script;\nimport org.mozilla.javascript.Scriptable;\n\npublic class Bug421071Test extends TestCase\n{\n   private TopLevelScope globalScope;\n   private Script script;\n\n   public void testProblemReplicator() throws Exception\n   {\n      // before debugging please put the breakpoint in the NativeJavaPackage.getPkgProperty() and observe names passed in there\n      script = compileScript();\n      runTestScript();           // this one does not get to the NativeJavaPackage.getPkgProperty() on my variables\n      runTestScript();           // however this one does\n   }\n\n   private Script compileScript()\n   {\n      String scriptSource = \"importPackage(java.util);\\n\" +\n         \"var searchmon = 3;\\n\" +\n         \"var searchday = 10;\\n\" +\n         \"var searchyear = 2008;\\n\" +\n         \"var searchwkday = 0;\\n\" +\n         \"\\n\" +\n         \"var myDate = Calendar.getInstance();\\n // this is a java.util.Calendar\" +\n         \"myDate.set(Calendar.MONTH, searchmon);\\n\" +\n         \"myDate.set(Calendar.DATE, searchday);\\n\" +\n         \"myDate.set(Calendar.YEAR, searchyear);\\n\" +\n         \"searchwkday.value = myDate.get(Calendar.DAY_OF_WEEK);\";\n      Script script;\n      Context context = Context.enter();\n\n      try\n      {\n         script = context.compileString(scriptSource, \"testScript\", 1, null);\n         return script;\n      }\n      finally\n      {\n         Context.exit();\n      }\n   }\n\n   private void runTestScript() throws InterruptedException\n   {\n      // will start new thread to get as close as possible to original environment, however the same behavior is exposed using new ScriptRunner(script).run();\n      Thread thread = new Thread(new ScriptRunner(script));\n      thread.start();\n      thread.join();\n   }\n\n   private TopLevelScope createGlobalScope()\n   {\n      Context context = Context.enter();\n      //noinspection deprecation\n      context.setCompileFunctionsWithDynamicScope(true); // this does not seem to matter\n      TopLevelScope globalScope = new TopLevelScope(context);\n      Context.exit();\n      return globalScope;\n   }\n\n   protected void setUp() throws Exception\n   {\n      super.setUp();\n      globalScope = createGlobalScope();\n   }\n\n   private class TopLevelScope extends ImporterTopLevel\n   {\n      public TopLevelScope(Context context)\n      {\n         super(context);\n      }\n   }\n\n   private class ScriptRunner implements Runnable\n   {\n      private Script script;\n\n      public ScriptRunner(Script script)\n      {\n         this.script = script;\n      }\n\n      public void run()\n      {\n         Context context = Context.enter();\n         try\n         {\n            // Run each script in its own scope, to keep global variables\n            // defined in each script separate\n            Scriptable threadScope = context.newObject(globalScope);\n            threadScope.setPrototype(globalScope);\n            threadScope.setParentScope(null);\n            script.exec(context, threadScope);\n         }\n         catch (Exception ee)\n         {\n            ee.printStackTrace();\n         }\n         finally\n         {\n            Context.exit();\n         }\n      }\n   }\n}\n\nCreated attachment 312652\nProposed patch\n\nThanks--that test case illustrated what was going on. \n\nWhen a script is first started, Rhino must look up variables defined in the script and merge them with previous definitions. To perform this merge it has to look them up in the scope, and with importerTopLevel having package imports it causes a call to getPkgProperty for each variable. The first call to runTestScript didn\'t trigger this behavior because the importPackage calls had not yet been made. \n\nI think the best option here is, as you suggest, to maintain a cache of misses so we don\'t retry the class lookup. I\'ve attached a proposed patch. Can you let me know if this change addresses the performance issue?\n\nThanks for your help.I tried the patch and it works fine now.\n\nThank you!Committed (slightly modified from proposed patch):\n\nChecking in src/org/mozilla/javascript/NativeJavaPackage.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaPackage.java,v  <--  NativeJavaPackage.java\nnew revision: 1.43; previous revision: 1.42\ndone\nWhich is the latest release that has this fix.\nwe are facing the same issue.I think the fix to this bug caused a regression, but as it\'s so old, I created a new report. Please see bug 694286.',?,IMPROVEMENT
423557,'Compiler chokes on keywords as object properties',Rhino,Compiler,cwolves,hannesw,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.12) Gecko/20080201 Firefox/2.0.0.12\nBuild Identifier: rhino1_6R7\n\nThe following snippets cause compiler errors, all are valid:\n\nvar x = {int:5};\nvar x = {for:5};\nvar x = {continue:5};\nvar x = {while:5};\n...etc\n\nvar x = {\'int\': 5}; // passes this, but...\nalert(x.int);       // fails\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.I know alert isn\'t valid, I wasn\'t thinking about it.  Change that to whatever, the \"x.int\" still breaks.Okay, looking into this more I found that Rhino follows the ECMAScript Grammar on this while every browser I\'ve tested (FF, Opera, Safari, IE) allows the behavior.  I suppose the question is what Rhino should be following closer  :-)  A simple browser test:\n\njavascript:alert({int:5}.int);\n\n\n\nFrom ECMA-262 E3:\n\nReservedWord :: See section 7.5.1 \nKeyword \nFutureReservedWord \nNullLiteral \nBooleanLiteral \n \nKeyword :: one of See section 7.5.2 \nbreak else new var \ncase finally return void \ncatch for switch while \ncontinue function this with \ndefault if throw \ndelete in try \ndo instanceof typeof \n \nFutureReservedWord :: one of See section 7.5.3 \nabstract enum int short \nboolean export interface static \nbyte extends long super \nchar final native synchronized \nclass float package throws \nconst goto private transient \ndebugger implements protected volatile \ndouble import public \n\nIdentifier :: IdentifierName but not ReservedWordIE6 permits this:\n\nvar foo = {int: 5}\n\nbut NOT any of the following:\n\nvar foo = {return: 5}\nvar foo = {for: 5}\nvar foo = {while: 5}\nvar foo = {if: 5}\n\nSo technically IE is only permitting non-keyword reserved words as identifiers.  (Haven\'t verified it for all keywords, but that\'s my hunch.)Created attachment 522684\nAllow keywords as property identifiers\n\nThis patch allows all keywords as property ids if Context.FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER is enabled. In the meantime all major browsers allow this, so it\'s time to catch up.Committed my patch.\n\nChecking in src/org/mozilla/javascript/Token.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Token.java,v  <--  Token.java\nnew revision: 1.47; previous revision: 1.46\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.157; previous revision: 1.156\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/423557.doctest,v\ndone\nChecking in testsrc/doctests/423557.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/423557.doctest,v  <--  423557.doctest\ninitial revision: 1.1\ndone',?,BUG
428920,'regexp parser doesn\'t recognize / in character class',Rhino,Compiler,steve.yegge,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13\nBuild Identifier: \n\nthis code:\n\nvar foo = /[/]/;\n\nis parsed correctly by SpiderMonkey and IE.  Rhino thinks the slash in the char-class terminates the regexp.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. start the rhino console\n2. type:  var foo = /[/]/;\n3. hit Enter\nActual Results:  \n\"<stdin>\", line 16: missing ; before statement\njs: var foo = /[/]/;\njs: .............^\n\nExpected Results:  \nshould produce no output, and evaluating \"foo\" should show:\n\n/[/]/\n\nTokenStream#readRegExp(int) is going to have to change to keep track of whether it\'s inside a character class.Fixed, I believe by 1.69 of TokenStream.java.',?,BUG
429121,'encodeURIComponent wrongly uses lowercase for hex representation',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.13) Gecko/20080325 Ubuntu/7.10 (gutsy) Firefox/2.0.0.13\nBuild Identifier: \n\nECMA 262 3rd edition precisely defines p 80, 15.1.3 that encodeURIComponent should use upper case for hex representation:\n\n\"19. Let S be a string containing three characters ?\%XY? where XY are two uppercase hexadecimal digits encoding the value of Result(18).\"\n\nbut Rhino uses lower case.\n\nReproducible: Always\n\nSteps to Reproduce:\nencodeURIComponent(\'$ a ;\')\nActual Results:  \n\%24\%20a\%20\%3b\n\nExpected Results:  \n\%24\%20a\%20\%3BCreated attachment 315761\nuse uppercase for hex representationFixed*** Bug 456218 has been marked as a duplicate of this bug. ***',?,BUG
429853,'msg.inconsistent.return strict-warning incorrect for nested functions',Rhino,Core,steve.yegge,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.14) Gecko/20080404 Firefox/2.0.0.14\nBuild Identifier: Rhino 1.7 release 2 PRERELEASE 2008 04 19\n\nfunction foo(n){\n  if(n < 5) return;\n  var add = function(a) {\n    return n+a; // this should not be flagged\n  };\n  add(10);\n}\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. java -jar build/version/js.jar -strict\n2. paste in the code above\nActual Results:  \ngives a \"return statement is inconsistent with previous usage\" warning at the \"return n+a\" line\n\nExpected Results:  \nshould give no warning\n\nThis is a one-line fix.  In Parser.java, in the function(int functionType) method, just after this line:\n\nint savedFunctionEndFlags = endFlags;\n\nyou need to add:\n\nendFlags = 0;\n\nNote that the related variable, hasReturnValue, appears to be spurious and should be removed.Good catch. \n\nFor the fix I also removed the unused variables hasReturnValue and savedHasReturnValue.\n\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.\njava\nnew revision: 1.127; previous revision: 1.126\ndone',?,CLEANUP
431674,'Java field private access doesn\'t work well with Java Bean access',Rhino,Core,norrisboyd,nobody,'Automagic property access -- and when it\'s a bit too magical\n\nLet\'s say you have a Java class with a standard getFoo/setFoo pair of methods. Rhino lets automatically unmangles the names and let you write code like this:\n\nvar aFooHolder = new JavAFooHolder();\naFooHolder.foo = \'kung\';\nprint(aFooHolder.foo); // prints \'kung\'\n\nMagical! But wait, theres (unfortunately) more. Under some circumstances (what are these?) Rhino will also see private class variables. Even more unfortuantely, it seems to prefer the private member variables to the demangled property-access methods. This can bite you like a black mamba on a sunless Serengetti night. Let\'s say that the FooHolder?\'s setFoo method has Important Side Effects:\n\nvar aFooHolder = new JavAFooHolder();\naFooHolder.foo = \'kung\'; // should also close the Exhaust Port leading to the reactor core \nprint(aFooHolder.foo); // prints \'kung\', because the private member variable is set correctly\n\n\nassertFalse(ExhaustPort.isOpen); // Augh! We\'re wide open to Rebel attack!\n\nThis can be maddening, because the member variable appears to have been \'set\' but it was really inserted with a needle. Beware!Fixed: \n\nChecking in src/org/mozilla/javascript/JavaMembers.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\nnew revision: 1.77; previous revision: 1.76\ndone\nChecking in testsrc/org/mozilla/javascript/tests/JavaAcessibilityTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/JavaAcessibilityTest.java,v  <--  JavaAcessibilityTest.java\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java,v  <--  PrivateAccessClass.java\nnew revision: 1.4; previous revision: 1.3\ndone\n',?,DESIGN_DEFECT
433878,'minor glitch when decompiling \'let\' statements',Rhino,Compiler,norrisboyd,nobody,'From http://groups.google.com/group/mozilla.dev.tech.js-engine.rhino/msg/2605df4e4d2b328d:\n\nHi Everyone,\n\nwith the following source code:\n\nfunction myFunc(a, b, c) {\n  let sum = a + b + c ;\n  return sum / 3 ;\n\n}\n\np(\"the string is: \" + myFunc.toString()) ;\n\nI get the following output:\n\nthe string is:\nfunction myFunc(a, b, c) {\n    let sum = a + b + creturn sum / 3;\n\n}\n\nApplying the following patch:\n\ndiff -r -u mozilla/js/rhino/src/org/mozilla/javascript/Parser.java\nmozilla-patched/js/rhino/src/org/mozilla/javascript/Parser.java\n--- mozilla/js/rhino/src/org/mozilla/javascript/Parser.java     2008-04-19\n18:53:24.000000000 -0700\n+++ mozilla-patched/js/rhino/src/org/mozilla/javascript/Parser.java\n2008-05-13 12:46:51.000000000 -0700\n@@ -1117,7 +1117,7 @@\n             } else {\n                 pn = variables(false, tt);\n             }\n-            return pn;\n+            break;\n           }\n\n           case Token.RETURN:\n\ngives the following (presumably correct) output:\n\nthe string is:\nfunction myFunc(a, b, c) {\n    let sum = a + b + c;\n    return sum / 3;\n\n}\n\nLet me know if anyone sees a problem with this!\n\nThanks,\nBenCreated attachment 321328\nProposed patch\n\nOnce I ran this through the regression tests, this ended up being more complicated unfortunately. There was a missing error check all along, but the previous bug caused us to pass a negative test, so I had to implement that to get everything to pass.Fixed: \n\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.119; previous revision: 1.118\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.128; previous revision: 1.127\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.87; previous revision: 1.86\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/433878.doctest,v\ndone\nChecking in testsrc/doctests/433878.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/433878.doctest,v  <--  433878.doctestinitial revision: 1.1\ndone\n',?,BUG
434031,'NaN added to an object when optimization is used',Rhino,Core,ludovic.claude,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.1.14) Gecko/20080404 Firefox/2.0.0.14\nBuild Identifier: Rhino 1.6R5 and 1.7R1\n\nHello,\n\nI found a bug in the optimized Javascript code where calling a (slightly hacked) function which adds a new key/value pair into an object adds instead NaN/value to that object. \n\nI have created a JUnit test reproducing that bug. \n\nThanks, Ludovic\n\nReproducible: Always\n\nSteps to Reproduce:\nUnit test provided\nActual Results:  \n{NaN:\"value\"}\n\nExpected Results:  \n{key:\"value\"}Created attachment 321232\nUnit test for this optimization bug\n\nThis unit test fails with both Rhino 1.6R5 and Rhino 1.7R1 on Windows XP / JDK 1.4.2_13Created attachment 321237\nSimpler Unit test for this optimization bug\n\nI removed the class inheritance thing which was causing lots of clutter. The minimal code triggering this bug is actually quite simple.Fixed: \n\nChecking in src/org/mozilla/javascript/optimizer/Optimizer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java,v  <--  Optimizer.java\nnew revision: 1.51.2.1; previous revision: 1.51\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/Attic/434041.doctest,v\ndone\nChecking in testsrc/doctests/434041.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/Attic/434041.doctest,v  <--  434041.doctest\nnew revision: 1.1.2.1; previous revision: 1.1\ndone\n\nChecking in src/org/mozilla/javascript/optimizer/Optimizer.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java,v  <--  Optimizer.java\nnew revision: 1.53; previous revision: 1.52\ndone\nChecking in testsrc/doctests/434041.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/434041.doctest,v  <--  434041.doctestnew revision: 1.2; previous revision: 1.1\ndone',?,BUG
435625,'\" Display Delayed',Rhino,Core,goldyard,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.2; zh-CN; rv:1.8.1.14) Gecko/20080404 Firefox/2.0.0.14\nBuild Identifier: 1.7R1\n\nWhen I use the Swing version of JSConsole, a multi-line input content\'s display should be :\njs> function f01()\n  > {\n  > \tprint(\"Hello\");\n  > }\nbut in fact I got:\njs> function f01()\n {\n      print(\"Hello\");\n  }\n> > > \njs>\nI check the source code find that problem from ConsoleTextArea.java line 129 - 130,\n        out = new PrintStream(console1);\n        err = new PrintStream(console2);\nshould add the autoflush flag when init.\n        out = new PrintStream(console1, true);\n        err = new PrintStream(console2, true);\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Run org.mozilla.javascript.tools.shell.JSConsole\n2.input function f01()\n {\n      print(\"Hello\");\n  }\n3.You got the error. (I\'m using with JDK 1.6)\nActual Results:  \njs> function f01()\n {\n      print(\"Hello\");\n  }\n> > > \njs>\n\nExpected Results:  \njs> function f01()\n  > {\n  > \tprint(\"Hello\");\n  > }\njs>\n\nPlease change ConsoleTextArea.java line 129 - 130, from\n        out = new PrintStream(console1);\n        err = new PrintStream(console2);\nto:\n        out = new PrintStream(console1, true);\n        err = new PrintStream(console2, true);Done, thanks for the help:\n\nChecking in toolsrc/org/mozilla/javascript/tools/shell/ConsoleTextArea.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ConsoleTextArea.java,v  <--  ConsoleTextArea.java\nnew revision: 1.13; previous revision: 1.12\ndone\n',?,BUG
436666,'Invalid debugger statement handling in the interpreter loop',Rhino,Core,acebanenco,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; ru; rv:1.9) Gecko/2008051206 Firefox/3.0\nBuild Identifier: 1.7R1\n\nPackage org.mozilla.javascript, class Interpreter, line 3755. \'break Loop;\' should be changed to \'continue Loop;\'. \nCurrently after the JS debugger has been stoped on \'debugger\' statement, script execution halts because of the break operator in the interpreter loop. \nThis issue is still in CVS (I\'ve checked it against Interpreter.java, v 1.3).\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Write simple javascript, like \'x = 2+2; debugger; var y = x*2;\'\n2. Run the script mentioned above in the debugger.\n3. Debugger will stop execution on \'debugger\' statement\n4. Press step over to move to the next line (calculation of the y).\n\nActual Results:  \nDebugger finishes executing the script\n\nExpected Results:  \nDebugger moves to the next line and calculates y variable.Created attachment 345680\npatch\n\nConfirming bug and suggested fix.Checking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.350; previous revision: 1.349\ndone',?,BUG
436731,'multiple destructuring forms in function param list',Rhino,Core,steve.yegge,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.14) Gecko/20080404 Firefox/2.0.0.14\nBuild Identifier: Rhino 1.7 release 1 2008 03 06\n\nYou can define a function with multiple destructuring-forms as parameters, but calling the function results in a TypeError.\n\nReproducible: Always\n\nSteps to Reproduce:\nSpiderMonkey:\n\njs> function foo([a, b], [c, d]) {print(a); print(b); print(c); print(d);}\njs> foo([1, 2], [3, 4])\n1\n2\n3\n4\n\nRhino 1.7R1 (and also R2/trunk):\n\njs> function foo([a, b], [c, d]) {print(a); print(b); print(c); print(d);}\njs> foo([1, 2], [3, 4])\njs: \"<stdin>\", line 2: uncaught JavaScript runtime exception: TypeError: Cannot read property \"0\" from undefined\n\tat <stdin>:2 (foo)\n\tat <stdin>:3\n\nActual Results:  \nTypeError:  cannot read property \"0\" from undefined\n\nExpected Results:  \nSee details field for SpiderMonkey behavior.Created attachment 337778\nDelay creation of destructuring assignment helpers\n\nThe problem is that destructuring assignment helpers are created while still parsing the parameters and before the function body has been parsed. Therefore they somehow trash the function scope. I guess it\'s because of their wrong parent scope, but I\'m not completely sure. This patch fixes the problem.Created attachment 347968\nUpdated patch\n\nUpdate patch to refactored Parser code.Committed patch to CVS HEAD.\n\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.136; previous revision: 1.135\ndone',?,BUG
437988,'Rhino fails to implement abstract method',Rhino,Compiler,norrisboyd,norrisboyd,'Using this:\n\nvar tableModel = new AbstractTableModel() {\n     getRowCount: function() { return 2; },\n     getColumnCount: function() { return 2; },\n     getValueAt: function(row, column) {\n         return \"ABC\";\n     }\n};\n\nvar jTable = new JTable(tableModel);\n\nresults in this:\n\nException in thread \"main\" java.lang.AbstractMethodError:\nadapter1.getColumnCount()I\n         at javax.swing.JTable.createDefaultColumnsFromModel(Unknown Source)\n         at javax.swing.JTable.tableChanged(Unknown Source)\n         at javax.swing.JTable.setModel(Unknown Source)\n         at javax.swing.JTable.<init>(Unknown Source)\n         at javax.swing.JTable.<init>(Unknown Source)\n         at\nsun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n         at\nsun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)\n         at\nsun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)\n         at java.lang.reflect.Constructor.newInstance(Unknown Source)\n         at org.mozilla.javascript.MemberBox.newInstance(MemberBox.java:184)\n         at\norg.mozilla.javascript.NativeJavaClass.constructSpecific(NativeJavaClass.java:274)\n         at\norg.mozilla.javascript.NativeJavaClass.construct(NativeJavaClass.java:193)\n         at\norg.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3380)\n         at\n...\n\nSame error also for:\n\nvar tableModel = new JavaAdapter(AbstractTableModel, {\n     getRowCount: function() { return 2; },\n     getColumnCount: function() { return 2; },\n     getValueAt: function(row, column) {\n         return \"ABC\";\n     }\n});\n\nvar jTable = new JTable(tableModel);Bug was that Rhino didn\'t discover abstract methods defined only in interfaces of base classes. \n\nFixed:\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\nnew revision: 1.115; previous revision: 1.114\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/jstests/437988.jstest,v\ndone\nChecking in testsrc/jstests/437988.jstest;\n/cvsroot/mozilla/js/rhino/testsrc/jstests/437988.jstest,v  <--  437988.jstest\ninitial revision: 1.1\ndone\nIt still does not work with javax.swing.AbstractAction:\n\nExample:\n\nimportPackage(javax.swing)\n\nvar action = new AbstractAction() {\n\tactionPerformed: function(event) {\n\t\tprint(\"clicked\")\n\t}\n}\n\nvar button = new JButton(action)\nbutton.doClick()\n\n\nResult:\n\nException in thread \"main\" java.lang.AbstractMethodError: adapter1.actionPerformed(Ljava/awt/event/ActionEvent;)V\n\tat javax.swing.AbstractButton.fireActionPerformed(AbstractButton.java:2012)\n\tat javax.swing.AbstractButton$Handler.actionPerformed(AbstractButton.java:2335)\n\tat javax.swing.DefaultButtonModel.fireActionPerformed(DefaultButtonModel.java:404)\n\tat javax.swing.DefaultButtonModel.setPressed(DefaultButtonModel.java:259)\n\tat javax.swing.AbstractButton.doClick(AbstractButton.java:374)\n\tat javax.swing.AbstractButton.doClick(AbstractButton.java:354)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:616)\n\tat org.mozilla.javascript.MemberBox.invoke(MemberBox.java:161)\n\tat org.mozilla.javascript.NativeJavaMethod.call(NativeJavaMethod.java:247)\n\tat org.mozilla.javascript.optimizer.OptRuntime.callProp0(OptRuntime.java:119)\n\tat org.mozilla.javascript.gen.c1._c0(Unknown Source)\n\tat org.mozilla.javascript.gen.c1.call(Unknown Source)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:398)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3065)\n\tat org.mozilla.javascript.gen.c1.call(Unknown Source)\n\tat org.mozilla.javascript.gen.c1.exec(Unknown Source)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:564)\n\tat org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:486)\n\tat org.mozilla.javascript.tools.shell.Main.processFile(Main.java:452)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:443)\n\tat org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:196)\n\tat org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:117)\n\tat org.mozilla.javascript.Context.call(Context.java:515)\n\tat org.mozilla.javascript.ContextFactory.call(ContextFactory.java:507)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:179)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:157)\n\n\nRhino version:\n\nRhino 1.7 release 0.7.r2.fc12 2009 07 28',?,BUG
441417,'DOM exception when mixing empty and non-empty namespaces',Rhino,E4X,matthieu.riou,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9) Gecko/2008060309 Firefox/3.0\nBuild Identifier: 1.7RC1\n\nThis isn\'t really easy to describe so you\'ll have to bear with me a little (and have a look at the steps to reproduce first).\n\nWhen an expression like friendInfo.name gets executed, a new name element is created as a child of friendInfo. The new element qname matches the qname of the previous element if there was one before (friendInfo already had a name child). However when the new element gets created, the default namespace lookup happens on the parent node (the friendInfo element in this example) which does have a qname. So the code ends up creating an element with an empty namespace (as was previously) but with a prefix which is assumed to match the parent. That doesn\'t work quite well in DOM land.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nJust type the following in a Rhino interpreter:\n\nvar friendInfo = <friend xmlns=\"http://ode.apache.org/simpel/1.0/definition/XmlData\"><name xmlns=\"\"/><phone xmlns=\"\"/></friend>;\nvar msgIn = <xd:dataOpRequest xmlns:xd=\"http://ode.apache.org/simpel/1.0/definition/XmlData\">\n                    <person>\n                       <firstName>John</firstName>\n                       <lastName>Doe</lastName>\n                       <phone>(999)999-9999</phone>\n                    </person>\n                </xd:dataOpRequest>;\nfriendInfo.name = msgIn.person.firstName.text() + \" \" + msgIn.person.lastName.text();\n\nActual Results:  \nException in thread \"main\" org.w3c.dom.DOMException: NAMESPACE_ERR: An attempt is made to create or change an object in a way which is incorrect with regard to namespaces.\n        at com.sun.org.apache.xerces.internal.dom.ElementNSImpl.setName(ElementNSImpl.java:176)\n        at com.sun.org.apache.xerces.internal.dom.ElementNSImpl.<init>(ElementNSImpl.java:112)\n        at com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl.createElementNS(CoreDocumentImpl.java:1969)\n        at com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl.importNode(CoreDocumentImpl.java:1487)\n        at com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl.importNode(CoreDocumentImpl.java:1444)\n        at org.mozilla.javascript.xmlimpl.XmlNode.insertChildAt(XmlNode.java:223)\n        at org.mozilla.javascript.xmlimpl.XmlNode.insertChildrenAt(XmlNode.java:237)\n        at org.mozilla.javascript.xmlimpl.XML.insertChildAfter(XML.java:531)\n        at org.mozilla.javascript.xmlimpl.XML.replace(XML.java:478)\n        at org.mozilla.javascript.xmlimpl.XMLName.setMyValueOn(XMLName.java:341)\n        at org.mozilla.javascript.xmlimpl.XML.putXMLProperty(XML.java:195)\n        at org.mozilla.javascript.xmlimpl.XMLObjectImpl.ecmaPut(XMLObjectImpl.java:299)\n        at org.mozilla.javascript.ScriptRuntime.setObjectProp(ScriptRuntime.java:1515)\n        at org.mozilla.javascript.ScriptRuntime.setObjectProp(ScriptRuntime.java:1507)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3063)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:401)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3003)\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:173)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:526)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:386)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n        at org.mozilla.javascript.Context.call(Context.java:499)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:511)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)Created attachment 326426\nPatch to apply on xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.javaI tried the patch and got this:\n\ne4x-compile:\n    [javac] Compiling 11 source files to /home/norris/rhino17/mozilla/js/rhino/build/classes\n    [javac] /home/norris/rhino17/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java:92: cannot find symbol\n    [javac] symbol  : method getUri()\n    [javac] location: class org.mozilla.javascript.xmlimpl.XmlNode.QName\n    [javac]         if (qname.getUri().length() == 0)\n    [javac]                  ^\n    [javac] /home/norris/rhino17/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java:94: cannot find symbol\n    [javac] symbol  : method getUri()\n    [javac] location: class org.mozilla.javascript.xmlimpl.XmlNode.QName\n    [javac]         else e = document.createElementNS(qname.getUri(), qname.qualify(referenceDom));\n    [javac]                                                ^\n    [javac] 2 errors\nCreated attachment 327700\nPatch updated to apply on Rhino trunkSorry about that, I created the patch against 1.7RC1 and didn\'t notice that some cleanup had been done on trunk since then. I\'ve attached a new patch that should work on trunk.Can someone have a look at this? I\'ve updated the patch last time.I\'ll take a look.I patched in the change (here\'s my context diff, with minor formatting changes):\n\nRCS file: /cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java,v\nretrieving revision 1.10\ndiff -u -r1.10 XmlNode.java\n--- xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java      2 Jul 2008 18:16:35 -0000       1.10\n+++ xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java      20 Aug 2008 18:17:37 -0000\n@@ -94,7 +94,15 @@\n             document = processor.newDocument();\n         }\n         Node referenceDom = (reference != null) ? reference.dom : null;\n-        Element e = document.createElementNS(qname.getNamespace().getUri(), qname.qualify(referenceDom));\n+        Element e;\n+        if (qname.getNamespace() == null ||\n+            qname.getNamespace().getUri().length() == 0)\n+        {\n+            e = document.createElement(qname.getLocalName());\n+        } else {\n+            e = document.createElementNS(qname.getNamespace().getUri(),\n+                qname.qualify(referenceDom));\n+        }\n         if (value != null) {\n             e.appendChild(document.createTextNode(value));\n         }\n\n\nThe following tests start failing after making the change:\n\ne4x/Expressions/11.1.2.js\ne4x/Expressions/11.2.2.js\ne4x/Regress/regress-264369.js\ne4x/Regress/regress-369032.js\ne4x/Types/9.1.1.2.js\nAh sorry, I didn\'t where the tests were before. Thanks for checking this, it looks like I\'ll have to do another deep dive in that code.I think I\'ve found the problem and fixed my patch. Sorry about the back and forth, XML namespaces are a real pain in the neck. I\'d like to try the tests on it but don\'t know which bug list you typically use. Do you always test with all the 2618? Seems to be taking a looong time... :)\n\nAnyway I\'ll attach my patch still but if you could let me know what you usually run for the tests, that\'d be great.Created attachment 335044\nSame as previous but forces empty NS instead of no NSI\'ll run them locally and let you know if there are any regressions.That passed. I\'ve committed the change:\n\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java,v  <--  XmlNode.java\nnew revision: 1.11; previous revision: 1.10\ndone\n\nChecking in testsrc/doctests/441417.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/441417.doctest,v  <--  441417.doctest\ninitial revision: 1.1\ndone\nPerfect, thanks!',?,BUG
442922,'New E4X Dom based XML implementation is not serializable',Rhino,E4X,jamiemccrindle+mozilla,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.4; en-GB; rv:1.9) Gecko/2008061004 Firefox/3.0\nBuild Identifier: Rhino 1.7R1 and latest\n\nIt is not possible to serialize XML and XMLList objects created with the new DOM based E4X implementation.\n\nReproducible: Always\n\nSteps to Reproduce:\njs> var x = <blah x=\"asdf\"><a a=\"asdf\"/></blah>;\njs> serialize(x, \"x.ser\");\nActual Results:  \norg.mozilla.javascript.WrappedException: Wrapped java.io.NotSerializableException: org.mozilla.javascript.xmlimpl.XmlNode$Namespace (<stdin>#6)\n        at org.mozilla.javascript.Context.throwAsScriptRuntimeEx(Context.java:1654)\n        at org.mozilla.javascript.MemberBox.invoke(MemberBox.java:175)\n        at org.mozilla.javascript.FunctionObject.call(FunctionObject.java:411)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3335)\n        at script(<stdin>:6)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n\nExpected Results:  \nx is serialized\n\nBecause the DOM based E4X implementation uses the platform XML implementation there is no guarantee that it will be serializable (in fact the standard one isn\'t), so it would potentially make sense to use the DOM load/save standard to serialize the XMLNode object out.A problem with serializing the XmlNode.dom to a string is where the variable points to an element within a document e.g.\n\nvar x = <a><b/></a>;\nvar y = x.b;\n\nserializing x and y as strings will detach them...Created attachment 327804\nAllows DOM based E4X to be serialized\n\nAllows DOM based E4X to be serializedIgnore initial comment about the Platform DOM not being serializable. It turned out to be a DocumentBuilderFactoryImpl in XmlProcessor.Fixed:\n\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/442922.doctest,v\ndone\nChecking in testsrc/doctests/442922.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/442922.doctest,v  <--  442922.doctest\n\ninitial revision: 1.1\ndone\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java\n,v  <--  XmlNode.java\nnew revision: 1.9; previous revision: 1.8\ndone\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor\n.java,v  <--  XmlProcessor.java\nnew revision: 1.13; previous revision: 1.12\ndone\n\nThanks for the patch!',?,DESIGN_DEFECT
444047,'bizarre behavior running in pre-1.7 mode when \"let\" or \"yield\" is used as an identifier',Rhino,Core,dgreenspan,hannesw,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en; rv:1.8.1.14) Gecko/20080512 Camino/1.6.1 (like Firefox/2.0.0.14)\nBuild Identifier: 1.7r1\n\nJS code with a variable named \"let\" or \"yield\" behaves erratically when running Rhino with a pre-1.7 language version selected.  For example, given the definition \"var yield = 123\", the statement \"print(yield)\" behaves like \"print(print)\", and \"print(yield = 456)\" behaves like \"print = 456\"!\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Launch the rhino shell with a pre-1.7 language, e.g. \"rhino -version 160\"\n2. Type \"var yield = 123\".\n3. Type \"print(yield)\".\nActual Results:  \nfunction print() {\n\t[native code, arity=1]\n}\n\nExpected Results:  \n123\n\nThe same thing happens with \"let\" instead of \"yield\".  I noticed that the TokenStream class handles these two tokens specially when the language version is less than 1.7; perhaps that code is at fault?Aha!  I think \"yield\" and \"let\" take the name of the previous named token.\n\nSo in a pre-JS1.7 shell, \"(x=3)+yield+let\" will evaluate to 9, whether or not yield and let have every been assigned to anything.\n\nI don\'t know the code well enough to submit a patch, but I think the problem is in TokenStream, near where it says \"// LET and YIELD are tokens only in 1.7 and later\".\n\nThanks.Created attachment 345619\nfix for this bug\n\nyield/let tokens were handled as names in js < 170 but the actual name string wasn\'t set.Checking in src/org/mozilla/javascript/TokenStream.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/TokenStream.java,v  <--  TokenStream.java\nnew revision: 1.72; previous revision: 1.71\ndone',?,BUG
444926,'regular expression (regexp) enters infinite loop with non-greedy atom',Rhino,Core,mozilla,nobody,'Under rhino the following regular expression enters an infinite loop:\n/(a*?)+?/.exec(\"a\")\nI checked bug 359651 or bug 443590 but as they are not in the same component I don\'t think they are related. (especially as FF3 does not exhibit the infinite loop).My patch in pull request #22 ( https://github.com/mozilla/rhino/pull/22 ) will fix this bug.Merged your pull request. Thanks!',?,BUG
444935,'in regexps (regular expressions) empty string should not be matched when \'min\' repetitions have been matched.',Rhino,Core,mozilla,nobody,'in the following example the last line should not evaluate to true.\nvar a = /()?/.exec(\"a\")\na[1] === \'\'\n\naccording to the spec the \'?\'-operator is equivalent to {0,1} with the minimum repetition being 0. Once the minimum-repetitions have been matched empty strings should not be matched in repetitions.\nIncidentally /(){0,1}/ does not work either.\nNot sure if this is related to bug 444926.My patch in pull request #22 ( https://github.com/mozilla/rhino/pull/22 ) will fix this bug.Merged.',?,BUG
447697,'Continuations don\'t work across __noSuchMethod__ methods',Rhino,Core,jamiemccrindle+mozilla,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.4; en-GB; rv:1.9.0.1) Gecko/2008070206 Firefox/3.0.1\nBuild Identifier: 1.7R1\n\nContinuations don\'t work across methods defined with the name __noSuchMethod__.\n\nReproducible: Always\n\nSteps to Reproduce:\nfunction Test() {}\nTest.prototype = {\n    pause: function() { throw new Continuation(); },\n    one: function() { this.pause(); print(\"one\"); },\n    two: function() { this.one(); print(\"two\"); },\n    __noSuchMethod__: function(methodName) { this.two(); print(methodName); },\n    four: function() { this.three(); print(\"four\"); },\n    five: function() { this.four(); print(\"five\");}\n}\nvar test = new Test();\nvar x;\ntry { test.five(); } catch(c) { x = c; }\n\n\nActual Results:  \none\ntwo\nthree\n\nExpected Results:  \none\ntwo\nthree\nfour\nfive\n\nLooking at the code, __noSuchMethod__ calls use ScriptRuntime.NoSuchMethodShim which implements Callable. The Interpreter then doesn\'t treat them as InterpretedMethod\'s. It should be possible to treat them in a similarish way to apply() calls.Ah, In the test, I left out a call to x, i.e. x();Created attachment 331593\nFix for __noSuchMethod__ and continuations\n\nThis uses the Interpreter loop for __noSuchMethod__ calls which allows them to work correctly if they\'re in a stored Continuation stack. Note: it doesn\'t work for TAIL_CALLs.To clarify, it does work for TAIL_CALLs in the sense that it behaves as it currently does for TAIL_CALLs, i.e. it doesn\'t use the interpreter loop and a continuation wouldn\'t cross the __noSuchMethod__ call on the stack. Created attachment 333793\nImproved Jamie\'s patch that also handles tail calls\n\nAdded an improved patch that also handles tail callsCommitted the last patch:\n\ncvs ci -m \"Fix for bug #447697 ? Continuations don\'t work across __noSuchMethod__ methods. Patch contributed by Jamie McCrindle\" -l \"/Rhino/src/org/mozilla/javascript/ScriptRuntime.java\" \"/Rhino/src/org/mozilla/javascript/Interpreter.java\"\n     \n    Checking in src/org/mozilla/javascript/ScriptRuntime.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\n    new revision: 1.302; previous revision: 1.301\n    done\n    Checking in src/org/mozilla/javascript/Interpreter.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\n    new revision: 1.348; previous revision: 1.347\n    done\nok (took 0:28.095)\n***\nThis causes a regression in test js1_5/extensions/no-such-method.js. \n\nThe problem is that __noSuchMethod__ is being called as __noSuchMethod__(\"foo\", 1, 2, 3) rather than __noSuchMethod__(\"foo\", [1, 2, 3]).This regression only occurs for interpreted mode.Created attachment 335353\nPatch to fix regression\n\nPatch to fix regressionSigh, another problem. Adding this code blows the interpreter loop beyond the length that Hotspot will compile, so execution time goes up by more than 2X.\n\nThat\'s a shame -- I might be able to refactor it into a separate method call to drop the size down below it again.Created attachment 335364\nImprovement to previous patch that moves the code out to a separate method\n\nI attached a new patch developed from \"Patch to fix regression\" that factors out the code into a separate method, hopefully bringing the size of the interpret() method down so that HotSpot again compiles it normally.Fixed, with code pulled out into a separate method we don\'t exceed the maximum method size for Hotspot compilation.\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.349; previous revision: 1.348\ndone\n',?,IMPROVEMENT
448816,'Implement Map interface in ScriptableObject',Rhino,Core,wayfarer3134,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9) Gecko/2008052906 Firefox/3.0\nBuild Identifier: \n\nIt would be quite useful if ScriptableObject implemented at least a minimal version of the Map interface - containsKey, get, put, remove at a minimum, but also perhaps a read-only version of the various set views of the object.  This would allow accessing a NativeObject much more cleanly than having to know about the Scriptable Interface etc, and it could be accessed by the many classes that already can deal with java Maps.  In terms of general behaviour, this is much more useful than having ScriptableObject be implemented in terms of a HashMap, and should not cause any performance degredation.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 347951\npatch and test case\n\nPatch and testcase for implementing java.util.Map in ScriptableObject. Currently, put() is not supported (mainly because of object wrapping concerns, which probably isn\'t hard to implement), while remove() is, both directly and through the key/value/entry collections.Created attachment 347953\nimproved patch and testcase\n\nSimplified patch, improved test case.Committed to HEAD:\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.140; previous revision: 1.139\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug448816Test.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug448816Test.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug448816Test.java,v  <--  Bug448816Test.java\ninitial revision: 1.1\ndoneCreated attachment 349447\nadditional patch\n\nadditional patch to make the code compile and work with Java 1.5.Some thoughts and observations: \n\nFirst, maybe the implementation of Map should happen in NativeObject, not ScriptableObject. ScriptableObject is the parent class of virtually every scriptable object in Rhino, so implementing Map there may be a bit too \'broad\', and I think the idea is to have this feature explicitly for plain JS Objects.\n\nSecond, I don\'t think it would be difficult to implement write access over the Map interface. I think all we\'d have to make sure is that values are properly wrapped using the context\'s WrapFactory. \n\nI was trying to reopen this bug until these issues are sorted out but I can\'t - don\'t know if this is due to a bugzilla bug or some missing permissions.java.util.Map implementation has moved from ScriptableObject to NativeObject in the process of fixing bug 466207 (implementing java.util.List interface in NativeArray). The primary reason was that it is impossible to implement both Map ans List in the same class as they have remove(Object) methods with incompatible return types. Also, implementing Map makes most sense in NativeObject. It\'s not clear any JS object should be treated as Map when passed to Java code.',?,RFE
453360,'typeof RegExp returns \'function\'',Rhino,Core,agiletortoise,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_5_4; en-us) AppleWebKit/525.18 (KHTML, like Gecko) Version/3.1.2 Safari/525.20.1\nBuild Identifier: 1.7R1\n\ntypeof, when called on a RegExp object (or literal) returns \'function\', and it should return \'object\'\n\nReproducible: Always\n\nSteps to Reproduce:\n1. typeof new RegExp(); // \'function\'\n2. typeof /foo/; // \'function\'\n3.\n\n\nExpected Results:  \nExpected type \'object\', as returned in SeaMonkey.This changed between spidermonkey 1.7.0 and 1.8.0, see bug 61911 for discussion.So this bug is WONTFIX then?So what do you want to do on this?\n\nNo matter if it is the default or not, I\'d like to have the possibility to get \"object\" as result of typeof on RegExp.Fixed through #463996',?,DESIGN_DEFECT
454505,'Implement JS 1.8 destructuring assignment shorthand for Rhino',Rhino,Core,hannesw,hannesw,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.1) Gecko/2008072820 Firefox/3.0.1\nBuild Identifier: \n\nIt would be nice to have the destructuring assignment shorthand feature described in bug #404734 available in Rhino. \n\nReproducible: AlwaysCreated attachment 337853\nImplement destructuring assignment shorthand\n\nImplement destructuring assignment shorthand. Also adds a JS 1.8 language version constant to Context.java. \n\nThe reason I\'m using an instance field for inDestructuringAssignment to avoid shorhand notation to pass through in ordinary object literals is for nested assignments like \"var [a, {b}] = ...\". The call stack is really deep here (all the *Expr() methods) so passing this through as argument would add major overhead. Another approach would be to set a property on shorthanded name nodes and check for it later on in the interpreter/compiler like I think spidermonkey does.\n\nThe decompiler still renders the long form, i.e. {f} -> {f:f}. To fix that we\'d also have to set a property on the shorthanded name node.Created attachment 338065\nSame patch including Message.properties\n\nSame patch as previous, but includes added message to Message.properties.Created attachment 376481\nnew patch\n\nUpdated patch to new parser code.Created attachment 376707\nnew patch including decompiler support\n\nadd support for decompiler and minor code cleanupCommitted last patch to CVS HEAD: \n\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.124; previous revision: 1.123\ndone\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.81; previous revision: 1.80\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.138; previous revision: 1.137\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.92; previous revision: 1.91\ndone*** Bug 507850 has been marked as a duplicate of this bug. ***',?,RFE
454969,'destructuring for-in loop fails in top-level scope',Rhino,Core,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.1) Gecko/2008072820 Firefox/3.0.1\nBuild Identifier: \n\nDoing a for-in loop with a destructuring key-value assignment on a top-level scope currently throws a NullPointerException.\n\nReproducible: Always\n\nSteps to Reproduce:\nRun the following in the Rhino shell:\n\nfor (var [i, j] in this) print(i, j);\nActual Results:  \nException in thread \"main\" java.lang.NullPointerException\n\tat org.mozilla.javascript.ScriptableObject.getTopLevelScope(ScriptableObject.java:1514)\n\tat org.mozilla.javascript.ScriptRuntime.setObjectProtoAndParent(ScriptRuntime.java:3291)\n\tat org.mozilla.javascript.Context.newArray(Context.java:1439)\n\tat org.mozilla.javascript.ScriptRuntime.enumId(ScriptRuntime.java:2023)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3581)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:401)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3003)\n\tat org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:173)\n\tat org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:526)\n\tat org.mozilla.javascript.tools.shell.Main.processSource(Main.java:386)\n\tat org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n\tat org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n\tat org.mozilla.javascript.Context.call(Context.java:499)\n\tat org.mozilla.javascript.ContextFactory.call(ContextFactory.java:511)\n\tat org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n\tat org.mozilla.javascript.tools.shell.Main.main(Main.java:140)Created attachment 338284\nFix: don\'t pass parent scope to cx.newArray()\n\nThe problem is that ScriptRuntime passes the parent scope of the current object to Context.newArray(), which is null for the top level scope.Committed patch to CVS HEAD:\n\nChecking in src/org/mozilla/javascript/ScriptRuntime.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\nnew revision: 1.306; previous revision: 1.305\ndoneI copied this fix to the 1.7R2 branch.',?,BUG
456357,'Implement JS 1.8 expression closures in Rhino',Rhino,Core,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.1) Gecko/2008072820 Firefox/3.0.1\nBuild Identifier: \n\nExpression closures are another piece needed to support JavaScript 1.8 in Rhino. See bug #381113 for the spidermonkey implementation.\n\nReproducible: AlwaysCreated attachment 339770\nPatch implements expression closures\n\nThis is a patch contributed by Andreas Bolka. I slightly edited it to not allow expression closures for JS versions < 1.8. The patch relies on my patch for bug #454505 for the definition of the Context.VERSION_1_8 constant.Created attachment 376704\nnew patch\n\nupdated to new parser code.Committed last patch to CVS HEAD:\n\nChecking in src/org/mozilla/javascript/Context.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Context.java,v  <--  Context.java\nnew revision: 1.278; previous revision: 1.277\ndone\nChecking in src/org/mozilla/javascript/IRFactory.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IRFactory.java,v  <--  IRFactory.java\nnew revision: 1.123; previous revision: 1.122\ndone\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.80; previous revision: 1.79\ndone\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.137; previous revision: 1.136\ndone\nChecking in src/org/mozilla/javascript/ast/FunctionNode.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ast/FunctionNode.java,v  <--  FunctionNode.java\nnew revision: 1.2; previous revision: 1.1\ndone',?,RFE
456389,'Implement JS 1.8 reduce/reduceRight array methods',Rhino,Core,hannesw,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.1) Gecko/2008072820 Firefox/3.0.1\nBuild Identifier: \n\nImplement JavaScript 1.8 reduce/reduceRight array methods. See bug #363040 for spicermonkey implementation.\n\nReproducible: AlwaysCreated attachment 339794\nImplements reduce/reduceRight methods\n\nImplements reduce and reduceRight methods on array prototype and constructor. I tried to reproduce the behaviour of spidermonkey, especially for sparse/empty arrays.Created attachment 339863\nimproved patch\n\nPatch with minor improvements and fixes.Committed the last patch to CVS HEAD:\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.97; previous revision: 1.96\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.91; previous revision: 1.90\ndoneCreated attachment 391093\nreduce and reduceRight throw a TypeError when array empty and no initVal\n\nAs per 15.4.4.21 step 5, and 15.4.4.22 step 5 of the spec.(In reply to comment #4)\n> Created an attachment (id=391093) [details]\n> reduce and reduceRight throw a TypeError when array empty and no initVal\n> \n> As per 15.4.4.21 step 5, and 15.4.4.22 step 5 of the spec.\n\nCommitted:\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.105; previous revision: 1.104Created attachment 412824\nmade reduceRight pass the correct (descending) index to the callback function',?,RFE
456546,'Java method lookup fails for methods with Scriptable argument if argument is a subclass',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.1) Gecko/2008072820 Firefox/3.0.1\nBuild Identifier: \n\nThe method lookup in NativeJavaObject fails if the target method takes a Scriptable argument and the actual argument is a subclass of the formal parameter.\n\njs> org.mozilla.javascript.Context.currentContext.initStandardObjects({})\njs: \"<stdin>\", line 3: Can\'t find method org.mozilla.javascript.Context.initStandardObjects(object).\n\tat <stdin>:3\n\nReproducible: AlwaysCreated attachment 339939\nfix\n\nUse Class.isInstance() instead of ==Committing the patch.\n\nChecking in src/org/mozilla/javascript/NativeJavaObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaObject.java,v  <--  NativeJavaObject.java\nnew revision: 1.86; previous revision: 1.85\ndoneCreated attachment 368231\nPrevent previous patch from applying to java.lang.Object arguments\n\nThe previous patch causes passing a Scriptable arg to a java.lang.Object parameter to get a conversion weight 1:\n\njs> var sdf = new java.text.SimpleDateFormat();\njs> sdf.format(new Date());\njs: \"<stdin>\", line 3: The choice of Java constructor format matching\nJavaScript argument types (object) is ambiguous; candidate\nconstructors are:\n    class java.lang.String format(java.lang.Object)\n    class java.lang.String format(java.util.Date) \n\nThis patch additionally checks if the formal parameter is actually Scriptable or an class implementing Scriptable.I committed the second patch to both Rhino1_7R2_BRANCH and HEAD.Created attachment 397616\nAllow Scriptable objects to be used as Java method parameters of classes they implement\n\nThe second patch was too broad. It prevented objects implementing Scriptable to be used for parameters of any other interface or superclass they may implement/extend. \n\nFor example, org.mozilla.javascript.ScriptableObject now implements java.util.Map, but calling new java.util.HashMap({foo: \"bar\"}) fails because of this.\n\nWith the new patch, all formal parameter interfaces/classes that are directly implemented by the Scriptable instance produce a conversion weight of 1, except java.lang.Object, which produces a conversion weight of 2 (which is I think the intended behaviour).I committed the new patch.\n\nChecking in src/org/mozilla/javascript/NativeJavaObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaObject.java,v  <--  NativeJavaObject.java\nnew revision: 1.89; previous revision: 1.88\ndone',?,BUG
457705,'Use literal Array initializers instead of Kit.semicolonSplit()',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nRhino uses org.mozilla.javascript.Kit.semicolonSplit() in order to split strings into string arrays during initialization of error constructors and standard java packages. I guess this goes back to a time when Java didn\'t support literal array initializers, although I\'m not sure - they seem to have been in the Java language specification 1.0 already: http://java.sun.com/docs/books/jls/first_edition/html/10.doc.html#11358. \n\nReproducible: AlwaysCreated attachment 340934\nUse array literals instead of Kit.semicolonSplit\n\nUse literal array initializers and dump Kit.semicolonSplit().Created attachment 345682\nslightly revised patch\n\nNo cosmetic changes in ScriptableObjectChecking in src/org/mozilla/javascript/Kit.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Kit.java,v  <--  Kit.java\nnew revision: 1.26; previous revision: 1.25\ndone\nChecking in src/org/mozilla/javascript/NativeGlobal.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeGlobal.java,v  <--  NativeGlobal.java\nnew revision: 1.83; previous revision: 1.82\ndone\nChecking in src/org/mozilla/javascript/NativeJavaPackage.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaPackage.java,v  <--  NativeJavaPackage.java\nnew revision: 1.44; previous revision: 1.43\ndone\nChecking in src/org/mozilla/javascript/NativeJavaTopPackage.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaTopPackage.java,v  <--  NativeJavaTopPackage.java\nnew revision: 1.21; previous revision: 1.20\ndone',?,IMPROVEMENT
460283,'Use \"nicer\" names for generated classes',Rhino,Compiler,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nClasses generated from scripts are currently named c1, c2, ... no matter what the provided script name was. It would make stack traces as well as debugging a little bit easier if generated names were \"derived\" from the provided script names.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 343400\nPatch generating \"nicer\" class names\n\nThe provided patch generates a class name from the script name replacing illegal characters with \"_\" with the usual serial number as suffix.Could a Rhino committer apply this patch or explain why it is not wanted?I tried this patch and the class naming one as well, and after applying it several of my other unit tests fail in odd ways. On my Windows machine, I get a bunch of org.mozilla.javascript.tests.ObserveInstructionCountTest$QuotaExceeded exceptions, and on my Linux box I get a variety of errors, like org.mozilla.javascript.EcmaError: TypeError: Cannot call property newInstance in object [JavaPackage java.lang.reflect.Array]. It is not a function, it is \"object\" on org.mozilla.javascript.tests.Bug467396Test. I ran both in Eclipse.I swapped tests and code in and out and the problem was in the test for Bug 460726 - Use \"nicer\" names for generated methods, not this patch.Committed patch.Cool! Thanks.',?,CLEANUP
460726,'Use \"nicer\" names for generated methods',Rhino,Compiler,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nClasses generated from scripts have methods for functions _c0, _c1, _c2, ... no matter what the name of the function (or script) was. It would make stack traces as well as debugging a little bit easier if generated names were \"derived\" from the functions names when possible.\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 343873\nPatch generating \"nicer\" method names (including unit tests)\n\nThe provided patch uses the same prefix and suffix as currently done but adds a name derived from the function name, when available.Could a Rhino committer apply this patch or explain why it is not wanted?Could a Rhino committer apply this patch or explain why it is not wanted?Committed after fixing test to exit context at end, which was disrupting other tests.Thanks. Yes, this bug is quite old, at this time I didn\'t use ContextAction for the test code.',?,CLEANUP
460727,'Increase visibility of Context(ContextFactory factory) to allow usage of non global ContextFactory',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nIt should be possible to use a custom ContextFactory without to need to set it as the global one. This is currently not possible because the Context created by a custom ContextFactory will still refer the global ContextFactory in its \"factory\" field.\nThe consequence is for instance that hasFeature will delegate to the global factory rather than to the custom one.\n\n// ----------- currently -----------\n    public Context()\n    {\n        this(ContextFactory.getGlobal());\n    }\n    \n    Context(ContextFactory factory)\n    {\n        assert factory != null;\n        this.factory = factory;\n        ...\n    }\n// ----------------------\n\n\n\n// ----------- possible solution -----------\n    public Context()\n    {\n        this(ContextFactory.getGlobal());\n    }\n    \n    protected Context(ContextFactory factory)\n    {\n        assert factory != null;\n        this.factory = factory;\n        ...\n    }\n// ----------------------\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.This is actually fixed already for 1.7.2 -- it\'s in CVS HEAD since August 26.Oops, sorry, you\'re right. I\'ve been confused by the multiple Rhino checkouts that I have to manage locally. Sorry again.No worries...',?,RFE
460739,'Reduce output generated by StandardTests',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nStandardTests generate a huge amount of output which gets written in the file TEST-org.mozilla.javascript.drivers.StandardTests.xml. This causes problems when the files needs to be processed (for instance when running the tests from CruiseControl).\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 343880\nPatch reducing output of StandardTests\n\nThis patch allows to drastically reduce output volume of StandardTests (>90\%, can\'t say the precise \%, I don\'t have any original version of the result file anymore). As a side effect it seems to me that the execution time is significantly reduced as well.Created attachment 343882\nimprovement on the previous patch\n\nHere\'s a bit different patch. The difference is that it won\'t affect the tests when run from the command line at all (using JsDriver), but will only reduce the output for JUnit-run tests.I see that you\'re extremely prudent with these tests ;-) Perhaps a test to test how the tests should run would be interesting ;-)\n\nThese changes are ok for me as they should achieve the same result when running the junit tests from the build.Writing tests for tests that test how the tests should run is a path to madness caused by fear of Thompson hacks :-)\n\n\"I recompile my firmware regularly, thank you so much for your concern. Using a third-party compiler. One that I\'ve bootstrapped myself, starting out on an alarm clock controller and working up from there.\"Created attachment 344610\nPatch reporting exception that occured in test thread\n\nWe\'ve been wrong fighting again the consequence of the problem rather than against the cause.\nThe root of the problem here is that not all exceptions occurring in the test threads are captured and reported as they should. The consequence is that a large number of test failures have been ignored and tests marked as successful whereas they failed :-(\nWith this patch *all* exceptions and errors occurring in the test thread are captured and reported. The consequence is that instead of 150 failed tests with CVS head, I have now 815 failed tests!Reviewed and committed Marc\'s latest patch:\n\n    Checking in testsrc/org/mozilla/javascript/drivers/StandardTests.java;\n    /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/StandardTests.java,v  <--  StandardTests.java\n    new revision: 1.9; previous revision: 1.8\n    done\n    Checking in testsrc/org/mozilla/javascript/drivers/ShellTest.java;\n    /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/ShellTest.java,v  <--  ShellTest.java\n    new revision: 1.10; previous revision: 1.9\n    doneSince Attila committed Marc\'s patch I think the bug should be resolved fixed.',?,TEST
460956,'XML and XMLList objects do not implement toSource()',Rhino,E4X,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nXML and XMLList do not currently implement the toSource() method. The inherited toSource() produces a bogus JavaScript object:\n\nx = <x>foo</x>\nx.toSource()\n({0:{}})\n\n\nReproducible: AlwaysCreated attachment 344076\nFixes this bug\n\nImplement toSource for XML and XMLList objects.Committed patch: \n\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java,v  <--  XML.java\nnew revision: 1.28; previous revision: 1.27\ndone\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java,v  <--  XMLList.java\nnew revision: 1.28; previous revision: 1.27\ndone\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLObjectImpl.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLObjectImpl.java,v  <--  XMLObjectImpl.java\nnew revision: 1.24; previous revision: 1.23\ndone*** Bug 374047 has been marked as a duplicate of this bug. ***',?,DESIGN_DEFECT
461115,'Run ALL available Junit tests and fail build in case of errors',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nCurrent build doesn\'t run all JUnit tests (it doesn\'t even compile them all) and doesn\'t fail when some tests failed. Both points are quite bad.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 344251\nPatch allowing to compile and run all JUnit tests and to fail in case of test failure(s)\n\nPatch solves the problem. Note that due to inconsistent naming (*Test for classes that are not JUnit test cases) the tests selection is more complicated and made lead to forget tests in the future when they are placed in other package(s). For the same reason, the patch renames and helper class of one test case.Fixed:\n\nChecking in testsrc/build.xml;\n/cvsroot/mozilla/js/rhino/testsrc/build.xml,v  <--  build.xml\nnew revision: 1.12; previous revision: 1.11\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug409702Test.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug409702Test.java,v  <--  Bug409702Test.java\nnew revision: 1.4; previous revision: 1.3\ndoneFor info: StandardTests wrongly reports as successful > 600 failing tests. I\'ve attached a patch to\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=460739 as it is related to the problem reported there.',?,BUILD_SYSTEM
461122,'Improve handling of future reserved words',Rhino,Core,hannesw,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nRhino currently defaults to disallow future reserved words (ECMAScript 7.5.3) as identifiers. It seems all browser JS engines including spidermonkey allow these words to be used. Rhino has a FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER which is false by default, and prints a warning message when this feature is set to true and a future reserved word is encountered.\n\nI propose to set the default value for FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER to true and remove the warning.\n\nReproducible: AlwaysCreated attachment 344257\nFix for this bug\n\nSets the default value for Context.FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER to true. Also treat \"export\" and \"import\" as ordinary reserved words instead of actual keywords. They are listed as such in the ECMAScript spec, only spidermonkey uses them as actual keywords, but Rhino doesn\'t implement that feature.Changing summary to \"Improve handling of future reserved words\" as I\'ll leave the default value for FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER as false for now, but will commit the other changes.Created attachment 348536\nnew patch\n\nupdated patch to changes in CVS, leave default value for Context.FEATURE_RESERVED_KEYWORD_AS_IDENTIFIER as false.Committed to CVS HEAD:\n\nChecking in src/org/mozilla/javascript/Node.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Node.java,v  <--  Node.java\nnew revision: 1.78; previous revision: 1.77\ndone\nChecking in src/org/mozilla/javascript/TokenStream.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/TokenStream.java,v  <--  TokenStream.java\nnew revision: 1.74; previous revision: 1.73\ndone',?,IMPROVEMENT
461138,'Setter for a Scriptable on host object doesn\'t accept null value',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nWhen defining a setter on an host object for a field that implements Scriptable, Rhino throws EcmaError\norg.mozilla.javascript.EcmaError: TypeError: Cannot convert null to an object.\nwhen trying to assign null value.\n\nA workaround consists in changing the signature of the setter to accept java.lang.Object instead of the desired Scriptable, but it is not pleasant.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 344266\nPatch with unit test and fix*** Bug 424926 has been marked as a duplicate of this bug. ***Created attachment 345683\nrevised patch\n\nJust use ScriptRuntime.toObjectOrNull(). The only drawback is a potential extra call to ScriptRuntime.getTopCallScope() because toObjectOrNull doesn\'t take a scope argument, but I think that\'s acceptable for the simplified code.Checking in src/org/mozilla/javascript/FunctionObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/FunctionObject.java,v  <--  FunctionObject.java\nnew revision: 1.82; previous revision: 1.81\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/CustomSetterAcceptNullScriptableTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/CustomSetterAcceptNullScriptableTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/CustomSetterAcceptNullScriptableTest.java,v  <--  CustomSetterAcceptNullScriptableTest.java\ninitial revision: 1.1\ndoneI don\'t know if it matters here but getTopCallScope(Context) is evil when many scopes are involved, I wouldn\'t use it at all when an other solution is possible. Here we have a scope available, this information shouldn\'t be lost.',?,BUG
461168,'Regression: constructor form of Packages is broken (w/ possible fix)',Rhino,Core,zeppieri,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.9.0.2) Gecko/2008092418 BU Linux/3.0.2-3.el5.centos.bu50.1 Firefox/3.0.2\nBuild Identifier: rhino1_7R1\n\nIn 1.5R4, functionality was added to use Packages as a constructor that takes a Java ClassLoader as its argument.  The resulting object could be used as a base Java package, to access packages loaded by the provided ClassLoader (rather than by Rhino\'s default application class loader).\n\nThis functionality no longer works.  (I\'m not certain which version broke it, but it seems to have been broken for awhile.)  \n\nNote:  the constructor itself doesn\'t break.  That is to say:\n\n     var base = new Packages(loader);\n\nreturns a base package, but any attempt to access classes using it fails with a NullPointerException.\n\nThe problem is that the base package (an instance of NativeJavaPackage) has no parent scope.\n\n\nI have a patch, but I don\'t know enough about Rhino\'s internals to be certain of its correctness:\n\n\nNativeJavaTopPackage.java\n104c104,109\n<         return new NativeJavaPackage(true, \"\", loader);\n---\n> \n>         NativeJavaPackage result = new NativeJavaPackage(true, \"\", loader);\n>         result.setPrototype(getObjectPrototype(scope));\n>         result.setParentScope(scope);\n> \n>         return result;\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Create a jar file at /path/to/foo.jar, containing a class one.two.Foo\n2. Start up the Rhino shell\n3. Enter the following:\n\nshade:~/Desktop/rhino1_5R4$ java -jar js.jar \nRhino 1.5 release 4 2003 02 10\njs> var url = new java.net.URL(\"file:///path/to/foo.jar\");\njs> var loader = new java.net.URLClassLoader([ url ]);\njs> var pks = new Packages(loader);\njs> var foo = new pks.one.two.Foo();\n\nActual Results:  \nIn 1.7R1, I get the following NullPointerException:\n\nException in thread \"main\" java.lang.NullPointerException\n        at org.mozilla.javascript.ScriptableObject.getTopLevelScope(ScriptableObject.java:1514)\n        at org.mozilla.javascript.ScriptRuntime.setObjectProtoAndParent(ScriptRuntime.java:3291)\n        at org.mozilla.javascript.NativeJavaPackage.getPkgProperty(NativeJavaPackage.java:166)\n        at org.mozilla.javascript.NativeJavaPackage.get(NativeJavaPackage.java:105)\n        at org.mozilla.javascript.ScriptableObject.getProperty(ScriptableObject.java:1575)\n        at org.mozilla.javascript.ScriptRuntime.getObjectProp(ScriptRuntime.java:1397)\n        at org.mozilla.javascript.ScriptRuntime.getObjectProp(ScriptRuntime.java:1383)\n        at org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3054)\n        at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n        at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n        at org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:401)\n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3003)\n        at org.mozilla.javascript.InterpretedFunction.exec(InterpretedFunction.java:173)\n        at org.mozilla.javascript.tools.shell.Main.evaluateScript(Main.java:526)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:386)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:179)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:100)\n        at org.mozilla.javascript.Context.call(Context.java:499)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:511)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:162)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:140)\n\n\nExpected Results:  \nIn the shell, the last statement should be accepted silently.I can confirm that this bug occurs.  I\'m trying to add a jar class loader at run-time for \"Narwhal\", and this blocks that effort.\n\nRhino 1.7 release 2 2009 03 22\nMac OS 10.5.6I committed a patch similar to the proposed one to CVS HEAD.\n\nChecking in src/org/mozilla/javascript/NativeJavaTopPackage.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaTopPackage.java,v  <--  NativeJavaTopPackage.java\nnew revision: 1.22; previous revision: 1.21\ndone',?,SPEC
462827,'Allow JavaAdapter to extend Scriptable objects directly, without additional wrapping as NativeJavaObject',Rhino,Core,lists,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_5_5; en-us) AppleWebKit/525.18 (KHTML, like Gecko) Version/3.1.2 Safari/525.20.1\nBuild Identifier: \n\nJavaAdapter.createAdapterWrapper is responsible for wrapping of the created JavaAdapter instance in a Scriptable wrapper. Right now it always wraps it in a NativeJavaObject. But by adding an additional instanceof check and avoiding wrapping of instances of classes that already inherit from Scriptable, we could allow JavaScript to define new Scriptable objects directly from JavaScript, and therefore offer more flexible ways of wrapping Java and JavaScript objects.\n\nReproducible: AlwaysCreated attachment 346011\nThe proposed change to JavaAdapterI really like this idea. It takes two things already present in Rhino (JavaAdapters and not wrapping instances of Scriptable) and what comes out is simple and powerful metaprogramming. As we found out on IRC there\'s a problem with your patch, so I\'m uploading a revised patch and a test script.Created attachment 346922\nrevised patch\n\ncreateAdapterWrapper() is called by the JavaAdapter constructor to set up the \"self\" field in the adapter which is used as \"this\" object in method calls, and if that isn\'t wrapped as NativeJavaObject we can\'t call the super$ methods. This new patch only unwraps the object returned from the JavaAdapter constructor if it is an instance of Scriptable, but leaves the \"self\" field wrapped so we can call the super methods in the parent java class.\n\nThe code is a bit awkward with two instanceof\'s within close range, but I think this is the only way to implement this without major code restructuring.Created attachment 346923\ntest script\n\nThis script shows how easy it is to implement a JSAdapter similar to the one implemented by A. Sundararajan using this feature.Committed to HEAD.\n\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\nnew revision: 1.117; previous revision: 1.116\ndoneCreated attachment 349181\nbetter demo script\n\nshows how to override put(), get(), has() and getIds(). Sample usage: \n\nRhino 1.7 release 3 PRERELEASE 2008 11 19\njs> load(\'jsadapter.js\');\njs> for (var [key, value] in Iterator(s)) print(key, value);\nmoo COW\njs> s.foo = \"BAR\";\nBAR\njs> for (var [key, value] in Iterator(s)) print(key, value);\nfoo BAR\nmoo COW\njs>',?,RFE
463111,'retrun function() will cause exceptions thrown by evaluating the function not to be catched by a surrounding try-catch',Rhino,Core,manfred.andres,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30)\nBuild Identifier: Rhino HEAD snapshot from 2008-02-05 with token patch\n\nvar x = function() {\n   throw \"Some Exception\";\n}\n\ntry {\n   return x();\n} catch (e) {\n   logException(e); // will not be reached\n}\n\ntry {\n   var y = x();\n   return y;\n} catch (e) {\n   logException(e); // works fine\n}\n\nReproducible: Always\n\nSteps to Reproduce:\n1.see pseudo code describing the problem\n2.\n3.\nActual Results:  \nexception has not been catched and propergated up the stack\n\nExpected Results:  \nexception should have been catched and handled by the catch-code-block\n\nCan easily be workarounded by asigning the returnvalue to a local variable and returning the variable instead.I was able to reproduce this with a CVS snapshot from 2008-02-05 whith the example code wrapped in a function and optlevel set to -1, but not with current CVS snapshot. Marking as fixed.',?,BUG
463867,'Superfluous code in ScriptableObject associateValue',Rhino,Core,petermichaux,norrisboyd,'In ScriptableObject, the definition of associateValue is\n\npublic synchronized final Object associateValue(Object key, Object value)\n{\n    if (value == null) throw new IllegalArgumentException();\n    Map<Object,Object> h = associatedValues;\n    if (h == null) {\n        h = associatedValues;\n        if (h == null) {\n            h = new HashMap<Object,Object>();\n            associatedValues = h;\n        }\n    }\n    return Kit.initHash(h, key, value);\n}\n\nThis looks something like double check locking but without a synchronized check between the two tests for h being null. \n\nSince the whole method is synchronized, couldn\'t this code be reduced to\n\npublic synchronized final Object associateValue(Object key, Object value)\n{\n    if (value == null) throw new IllegalArgumentException();\n    Map<Object,Object> h = associatedValues;\n    if (h == null) {\n        h = new HashMap<Object,Object>();\n        associatedValues = h;\n    }\n    return Kit.initHash(h, key, value);\n}Created attachment 347120\nchanges per the ticket descriptionFixed: \n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.143; previous revision: 1.142\ndone',?,IMPROVEMENT
463875,'ScriptableObject seal documentation',Rhino,Core,petermichaux,norrisboyd,'Created attachment 347125\nScriptableObject seal documentation\n\nIn the documentation for ScriptableObject\'s seal method, there is mention that properties of a sealed object cannot be added or removed. I think it is beneficial to mention that properties can still be changed so someone does not think their object is frozen. I\'ll attach a patch that mentions this but it may need to be expanded to state that an accessor property cannot be changed to a data property and vice versa per the ES3.1 spec if that is the behavior of Rhino.Fixed:\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.144; previous revision: 1.143\ndone',?,CLEANUP
463878,' tag',Rhino,Core,petermichaux,nobody,'Created attachment 347129\nMove <pre> tag up a couple lines\n\nSeems like a <pre> tag was bumped down a few lines.Fixed in CVS HEAD',?,BUG
463996,'Allow to customize result of typeof operator',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nCurrently the processing of the typeof operator is handled at a central place with at least one error (on RegExpo: https://bugzilla.mozilla.org/show_bug.cgi?id=453360).\n\nIt should be possible for an host object to specify what typeof should return when called on it. ECMA 11.4.3 says that typeof on host object is Implementation-dependent.\n\nIn the case of HtmlUnit, this would be helpfull to be able to return \"object\" for objects that instantiate Function (for instance document.all).\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 347261\nPatch allowing ScriptableObject instances to determine what the typeof operator should return for them\n\nThis patch adds a String getTypeOf() method on ScriptableObject which result is returned when typeof is called on a ScriptableObject.\nThis allows to simplify code of ScriptRuntime.typeof (and method call is normally better than if test in terms of performance) and to fix bug453360.\n\nPatch includes unit tests.Could a Rhino committer apply this patch or explain why it is not wanted?Someone alive here?\n\nI would really appreciate a reaction on this issue (or even better, that my patch gets applied).I\'ll look at it. I looked at it earlier and was hoping to find a better way to do this, but there may not be anything more elegant.I think the solution is not inelegant... It\'d be nice to be able to have this on Scriptable too, but alas, adding methods to interfaces breaks backwards compatibility very cruelly...Committed the patch to CVS HEAD:\n\n***\ncvs add -kkv \"/Rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java\"\n    cvs add: scheduling file `testsrc/org/mozilla/javascript/tests/TypeOfTest.java\' for addition\n    cvs add: use \'cvs commit\' to add this file permanently\nok (took 0:00.411)\n***\n\n***\ncvs ci -m \"Pathch for [#463996]: customizable typeOf for ScriptableObjects (contributed by Marc Guillemot)\" -l \"/Rhino/src/org/mozilla/javascript/xml/XMLObject.java\" \"/Rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java\" \"/Rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java\" \"/Rhino/src/org/mozilla/javascript/ScriptableObject.java\" \"/Rhino/src/org/mozilla/javascript/BaseFunction.java\" \"/Rhino/src/org/mozilla/javascript/ScriptRuntime.java\"\n    RCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java,v\n    done\n    Checking in testsrc/org/mozilla/javascript/tests/TypeOfTest.java;\n    /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java,v  <--  TypeOfTest.java\n    initial revision: 1.1\n    done\n    Checking in src/org/mozilla/javascript/BaseFunction.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/BaseFunction.java,v  <--  BaseFunction.java\n    new revision: 1.68; previous revision: 1.67\n    done\n    Checking in src/org/mozilla/javascript/ScriptableObject.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\n    new revision: 1.146; previous revision: 1.145\n    done\n    Checking in src/org/mozilla/javascript/ScriptRuntime.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptRuntime.java,v  <--  ScriptRuntime.java\n    new revision: 1.310; previous revision: 1.309\n    done\n    Checking in src/org/mozilla/javascript/xml/XMLObject.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/xml/XMLObject.java,v  <--  XMLObject.java\n    new revision: 1.10; previous revision: 1.9\n    done\n    Checking in src/org/mozilla/javascript/regexp/NativeRegExp.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java,v  <--  NativeRegExp.java\n    new revision: 1.109; previous revision: 1.108\n    done\nok (took 1:05.129)\n***Thanks.\n\nDon\'t you want to close bug #453360?',?,DESIGN_DEFECT
464898,'Rhino standard tests don\'t run cleanly',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) Gecko/2008092510 Ubuntu/8.04 (hardy) Firefox/3.0.3\nBuild Identifier: \n\nRunning the tests with ant-junit all reports a lot of failed tests. Running tests as explained at https://developer.mozilla.org/en/Running_the_Rhino_tests doesn\'t report any failure (at least for interpreted mode).\nThis shows that there is a big problem at least in one of the two methods.\n\nThe first failing test reported when running the tests as junit tests is lc3/ArrayMethods/object-001.js. Which is not reported as failing by JsDriver.\n\nIf I add following as first statement of JsDriver.excluded:\n            if (!path.contains(\"lc3/ArrayMethods/object-001.js\"))\n            \treturn true;\nand run JsDriver tests again, then only this single test is run... and if fails exactly like when running it as unit test.\n\nFor me this shows a really big problem in the tests. Particularly this seems to mean that we can\'t trust the results of JsDriver and that the unit test result are (more?) correct. In which case, a lot of tests fail currently!\n\nAdditionally, do we really need JsDriver? It is important to be able to build and run the tests in automatic build process and have usable results that we can trust. JUnit seems better suited for this purpose.\n\nI set the severity of this issue as critical because I think that we can\'t have any reliable information on Rhino\'s quality as long as it is not fixed.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 349177\nPatch adding jstests.jar to the classpath for the unit tests\n\nOne part of the problem is that the junit test don\'t have jstests.jar in the classpath which contains com.netscape.*\n\nOn my computer this reduces the number of failed standard tests from 657 to 380.Thanks Marc. I committed your patch to both HEAD and Rhino1_7R2_BRANCH.Cool!\n\nhttp://cn-rhino01.nl.mozilla.org:8085/browse/RHINO-HEAD-163 shows that if fixed 146 tests ... but that 241 are still failing :-(Looking at the remaining failing bugs, it seems like the two biggest groups are failing due to the missing global options() function in Rhino, and because trying to call js1_8 tests and calling version(180). \n\noption() seems to be used to enable/disable the jit compiler - option() without arguments returns a string with current options status, and it looks like option(\'jit\') should toggle the jit. I couldn\'t reproduce this in spidermonkey shell - options() always returns an empty string. Maybe spidermonkey always runs with jit and options() is left in for backwards compatibility?\n\nThe js 1.8 issue is strange, because the js1_8 directory is in the skip list. I guess something there\'s a problem with processing the skip lists here. \n\nBTW, in my local copy with the js 1.8 patches we have already applied, 29 of the js1_8 test cases pass already, which is nice :-)Doh! StandardTests checks the skip list using Properties.containsKey(), but the skip list also contains directories (i.e. \'js1_8\' for all tests in that directory). Patch coming soon.Created attachment 349394\ncheck skiplist for partial paths\n\nI\'m down to 24 failures with this patch. Still have to check out if there are more issues left, or if this was actually the only cause for the diverging results.Isn\'t it possible to share the logic of test selection with JsDriver to avoid different results?(In reply to comment #7)\n> Isn\'t it possible to share the logic of test selection with JsDriver to avoid\n> different results?\n\nI guess it would be, and I guess that\'s the way it should be. JSDriver currently uses a String array and loops over it using startsWith() while StandardTests only checks on a directory/file level. Thus a skip list entry of \"js1_8\" covers directory \"js1_8_1\" in JSDriver, but does not in StandardTests. \n\nAny opinions on which behaviour is more desirable/compatible/whatever?(In reply to comment #8)\n> \n> Any opinions on which behaviour is more desirable/compatible/whatever?\n\nI don\'t care personally. What matters is to be sure that the same logic is used.Created attachment 351549\npatch to unify exclude list handling in test driversCreated attachment 351593\npatch with added options() function\n\nMost remaining bugs fail because of the missing options() function in spidermonkey. This patch extends the previous one to add a dummy options() function to the test scope.Committed to HEAD.\n\nRemoving testsrc/org/mozilla/javascript/drivers/FileUtils.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/FileUtils.java,v  <--  FileUtils.java\nnew revision: delete; previous revision: 1.2\ndone\nChecking in testsrc/org/mozilla/javascript/drivers/JsDriver.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/JsDriver.java,v  <--  JsDriver.java\nnew revision: 1.9; previous revision: 1.8\ndone\nChecking in testsrc/org/mozilla/javascript/drivers/ShellTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/ShellTest.java,v  <--  ShellTest.java\nnew revision: 1.11; previous revision: 1.10\ndone\nChecking in testsrc/org/mozilla/javascript/drivers/StandardTests.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/StandardTests.java,v  <--  StandardTests.java\nnew revision: 1.11; previous revision: 1.10\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/TestUtils.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/drivers/TestUtils.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/drivers/TestUtils.java,v  <--  TestUtils.java\ninitial revision: 1.1\ndone\nChecking in testsrc/org/mozilla/javascript/tests/DoctestsTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/DoctestsTest.java,v  <--  DoctestsTest.java\nnew revision: 1.4; previous revision: 1.3\ndone\nChecking in testsrc/org/mozilla/javascript/tests/JsTestsTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/JsTestsTest.java,v  <--  JsTestsTest.java\nnew revision: 1.3; previous revision: 1.2\ndone\n\nWith this, I have 10 tests failing with jsdriver and 11 with ant/junit. The one differing test fails with a stack overflow which is likely due to the different testing environment. Marking bug as fixed.You\'re the hero!\n\nDoes this mean that we will soon have a passed build? Shouldn\'t the failing tests be added to the skip list(s)?Thanks :-) I think we should look at the failing tests one by one and decide in each case if it applies to Rhino. But yes, I think passing the test suite is now well within reach.Committed last patch to Rhino1_7R2_BRANCH.',?,TEST
466207,'Implement java.util.List interface in NativeArray',Rhino,Core,hannesw,nobody,'As proposed by Attila, JavaScript Arrays should implement the java.util.List interface like ScriptableObject implements java.util.Map (see bug 448816). This would make exchange of list-like date between JavaScript and Java in Rhino a breeze.Turns out we can\'t make NativeArray implement java.util.List or even java.util.Collection since we made ScriptableObject implement java.util.Map with the patch for bug 448816, and Map has a remove(Object) method that is incompatible with that in List/Collection.\n\nI think what we should do is move the Map implementation from ScriptableObject to NativeObject. Making JS-Object -> java.util.Map conversion work for native JS Objects should cover most use cases, and it\'s not obvious a Function or Date object should auto-convert to a Map. Not sure about custom Host objects, but these can always implement Map or subclass NativeObject.\n\nI\'m working on a patch, will post it shortly.Created attachment 480945\nMake NativeArray implement java.util.List\n\nAs described in the previous comment, this moves the implementation of java.util.Map from ScriptableObject to NativeObject.Created attachment 481025\nslightly modified patch\n\npatch without the unrelated small optimization in NativeArrayI committed the last patch.',?,DESIGN_DEFECT
466661,'Primitive number not wrapped when used as paramter of apply',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.4) Gecko/2008111317 Ubuntu/8.04 (hardy) Firefox/3.0.4\nBuild Identifier: \n\nIn interpreted mode, primitive numbers are stored in the dblStack and should be wrapped when they are used as parameters of the apply method\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 349964\nPatch containing unit test and fix\n\nThe problem is just a verification for UniqueTag.DOUBLE_MARK that is missing.Committed patch to both HEAD and Rhino1_7R2_BRANCH.Hannes, thanks for quickly applying this patch.',?,BUG
467276,'NaN/Infinity.toExponential(...) should not check range',Rhino,Core,mozilla,szegedia,'according to 15.7.4.6 toExponential should verify the range only after it has verified that the number is neither NaN nor Infinity.\nthat is: Infinity.toExponential(-3) should not throw a RangeError.Created attachment 352565\nPatch that fixes the bug in both toExponential and toPrecisionReviewing the specification, it seems that in addition to toExponential, toPrecision would also need to allow for both NaN and the two infinities to skip range check, and toPrecision also needs to handle undefined value for precision specially. \n\nAttached patch fixes all these problems.Created attachment 352573\nExtensions to ECMA testcases for toExponential and toPrecision\n\nAdded testcasesCommitted fixes to CVS:\n\n***\ncvs ci -m \"Fix for #467276: NaN/Infinity.toExponential(...) should not check range\" -l \"/Rhino/src/org/mozilla/javascript/NativeNumber.java\"\n    Checking in src/org/mozilla/javascript/NativeNumber.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeNumber.java,v  <--  NativeNumber.java\n    new revision: 1.42; previous revision: 1.41\n    done\nok (took 0:01.410)\n***\n\n***\ncvs ci -m \"Adding testcases for NaN/Infinity.toExponential(...)/toPrecision() should not check range (see Bug #467276)\" -l \"/tests/ecma_3/Number/15.7.4.7-1.js\" \"/tests/ecma_3/Number/15.7.4.6-1.js\"\n    Checking in ecma_3/Number/15.7.4.6-1.js;\n    /cvsroot/mozilla/js/tests/ecma_3/Number/15.7.4.6-1.js,v  <--  15.7.4.6-1.js\n    new revision: 1.7; previous revision: 1.6\n    done\n    Checking in ecma_3/Number/15.7.4.7-1.js;\n    /cvsroot/mozilla/js/tests/ecma_3/Number/15.7.4.7-1.js,v  <--  15.7.4.7-1.js\n    new revision: 1.7; previous revision: 1.6\n    done\nok (took 0:01.629)\n***synced to mc: http://hg.mozilla.org/mozilla-central/rev/03d4e7eb5fcb\n\nplease get a review before checking in js tests or modifications. also, for the time being, please keep in sync with mozilla-central. thanks.',?,SPEC
467396,'Rhino always prefers non-varargs java method over varargs one',Rhino,Core,clovis.wichoski,hannesw,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.9) Gecko/2008052912 Firefox/3.0\nBuild Identifier: Rhino 1.7R1\n\nIf i try to run follow code:\n\nvar layRegE00 =  java.lang.reflect.Array.newInstance(java.lang.Object, [17,4]);\n\ni get the exception:\n\nCannot convert 17,4 to java.lang.Integer.\n\nthis code works in version 1.6R1 of Rhino.\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.I guess this might have to do with the patch from bug 382340. I just tried and it is broken with 1.6R6, which is the first release containing that patch. FWIW, invoking that method varargs style works:\n\njava.lang.reflect.Array.newInstance(java.lang.Object, 17, 4);I found the problem. The java.lang.reflect.Array.newInstance() method taking an int array as second argument has changed to varargs signature in Java 6, and NativeJavaMethod.preferSignature() currently always prefers non-varargs methods over varargs methods. Thus, the method with int as second argument is called on Java 6, while on Java 5 the right method in chosen.\n\nI guess we shouldn\'t blindly prefer non-varargs methods over varargs ones. Removing that code results in the varargs method being called with an array object, and the non-varargs one with a number argument. \n\nApart from that, I wonder if it is right that NativeJavaObject.canConvert() returns true for Scriptable -> java.lang.Number conversion. Is there a scenario where this conversion actually works - and makes sense?Created attachment 351536\npatch and test case\n\nThis patch removes the code that always prefers non-varargs methods over varargs ones. From the original comment, my feeling is that the author added that code without a stringent cause such as actual code requiring it, and the testcase shows the new code works in this case. The comment is updated to point to this bug.Committed to HEAD:\n\nChecking in src/org/mozilla/javascript/NativeJavaMethod.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaMethod.java,v  <--  NativeJavaMethod.java\nnew revision: 1.64; previous revision: 1.63\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Attic/Bug467396Test.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug467396Test.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Attic/Bug467396Test.java,v  <--  Bug467396Test.java\nnew revision: 1.1.2.1; previous revision: 1.1\ndone\n\nProbably should go also to Rhino1_7R2_BRANCH, although there\'s a slight chance something else might break.This change caused a regression (see bug 496585). I\'m working on a fix that will preserve this case as well.I committed my fix to bug 496585. That fix includes a new regression test for this bug: testsrc/doctests/467396.doctest.',?,BUG
468070,'New variation of primitive prototype resolution bug: foo[\'someProp\']',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.4) Gecko/2008111317 Ubuntu/8.04 (hardy) Firefox/3.0.4\nBuild Identifier: \n\nAttached is a patch demonstrating an other variation of the bug in primitive prototype resolution when many top scopes are involved.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 351544\nPatch demonstrating and fixing the problemI committed your patch, but without deprecating the old ScriptRuntime.getObjectElem() signature as it is still used in Codegen.Thanks a lotFolks, in the patch to Codegen, shouldn\'t variableObjectLocal be used instead of thisObjectLocal?From what I can guess from the variable names, thisObjectLocal makes more sense to me. This being said, the unit test pass as well when variableObjectLocal is used.\n\nDo you have an example where you think that one of both would fail?@Hannes:\n\ndo you plan to apply my patch in Rhino1_7R2_BRANCH too?(In reply to comment #4)\n> Folks, in the patch to Codegen, shouldn\'t variableObjectLocal be used instead\n> of thisObjectLocal?\n\nI was unsure about thisObjectLocal too. What convinced me was that the fix to bug #374918 uses the same approach (not really a good reason, I know :-). But yes, variableObjectLocal should make more sense here. I\'ll give it a short try here. \n\n(In reply to comment #6)\n> @Hannes:\n> \n> do you plan to apply my patch in Rhino1_7R2_BRANCH too?\n\nYes, if it\'s really important to you (as it seems to be).(In reply to comment #7)\n> (In reply to comment #4)\n> > Folks, in the patch to Codegen, shouldn\'t variableObjectLocal be used instead\n> > of thisObjectLocal?\n> \n> I was unsure about thisObjectLocal too. What convinced me was that the fix to\n> bug #374918 uses the same approach (not really a good reason, I know :-). \n\nHm... Maybe revisit that too, then?Created attachment 352548\nuse variable object as scope argument\n\nPatch to use variable object instead of this-object when we need to pass a scope argument. This affects the patches for this bug and bug 374918.@both: can you imagine a unit test?(In reply to comment #10)\n> @both: can you imagine a unit test?\n\nI have a wild imagination, Marc.(In reply to comment #11)\n> I have a wild imagination, Marc.\n\nI trust you Attila and therefore I\'d like to see this test to improve my Rhino knowledge.Marc: the variable object is by definition the top-most object in the current scope chain, so it makes more sense to use in this context than the this-object. I don\'t see a need to create an artificial test to make the original patch break. Committing the second patch. \n\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <--  Codegen.java\nnew revision: 1.269; previous revision: 1.268\ndone(In reply to comment #12)\n> (In reply to comment #11)\n> > I have a wild imagination, Marc.\n> \n> I trust you Attila and therefore I\'d like to see this test to improve my Rhino\n> knowledge.\n\nWell, this ain\'t about Rhino, it\'s about two basic and distinct JS runtime concepts at the current point of execution: the identity of the \"this\" object, and the identity of the scope used for identifier resolution. In example:\n\nvar x = 1;\nfunction f()\n{\n    var y = 2;\n    print(x);\n    print(y);\n    print(this.x);\n    print(this.y);\n}\n\nfunction obj() {\n    this.y = 4;\n    return this;\n}\nobj.prototype =  {\n    x: 3,\n    my_f: f\n};\n\nnew obj().my_f();\n\n===\nprints:\n1\n2\n3\n4\n\nAlso, in the interpreter patch, you used \"frame.scope\" for the same parameter (correctly), and not \"frame.thisObj\" (which would\'ve been incorrect), so by applying the same reasoning, you use localVariableObject (should really be called localScopeObject...) and not localThisObject in the generated compiled code.Thanks both for the explanations. What about adding some comment on the variable in CodeGen?\n\n@Hannes:\na test is never artificial when it allows to detect that something is incorrect. I understand your explanations (for my part I was just happy to hack successfully CodeGen) and don\'t contest this at all. But here we have something that was wrong until Attila\'s eyes detected it. I have no doubt that his view will stay sharp, but I believe that a unit test is better and more reliable than 1000 eyes. I\'ll try to propose a patch illustrating why thisObjectLocal was wrong.I committed the last two patches to Rhino1_7R2_BRANCH.(In reply to comment #15)\n> I\'ll try to propose a patch illustrating why thisObjectLocal was wrong.\n\nHeh. I tried to make a test that breaks before the patches using this:\n\n        Context cx = Context.enter();\n        cx.setOptimizationLevel(0);\n        ScriptableObject s1 = cx.initStandardObjects();\n        ScriptableObject s2 = cx.initStandardObjects();\n        cx.compileString(\"String.prototype.foo=1; function f1() { return String.prototype.foo; }\", \"\", 1, null).exec(cx, s1);\n        ScriptableObject.putProperty(s2, \"f1\", ScriptableObject.getProperty(s1, \"f1\"));\n        System.out.println(cx.compileString(\"this.f1();\", \"\", 1, null).exec(cx, s2));\n\nReasoning being that without the fix, this.f1() invocation would try to resolve String prototype against s2 (\"this\" in that invocation), and not the activation scope of f1 (which is a child of s1)). \n\nTurns out though that Codegen didn\'t even hit the point of the fix where it\'d emit \"getPropFunctionAndThis\", as it emitted a call to OptRuntime.callProp0() instead :-(\n\nSo, my inability to come up with a test stems from the fact that I can\'t get Codegen to actually hit that code path... (and the fact that I can\'t spend more time on it right now).',?,IMPROVEMENT
468580,' RegExpProxy to have all regexp related stuff in RegExpProxy',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.4) Gecko/2008111317 Ubuntu/8.04 (hardy) Firefox/3.0.4\nBuild Identifier: \n\nMost of the Regexp related code is hidden behind RegExpProxy and therefore allows to easily provide an other implementation of RegExp... except for String.split. Therefore String.split should delegate to the RegExpProxy as well.\n\nThis is a blocker for bug #390659\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Created attachment 352072\nPatch moving NativeString split related code to RegExpProxy and RegExpImp\n\nThis patch moves NativeString\'s js_split & find_split to RegExpImpl and adds method js_split to interface RegExpProxy.\n\nIt doesn\'t search to simplify anything to make patch review easier (for instance find_split should surely be removed from interface RegExpProxy).\n\nIt modifies the API of the public interface RegExpProxy but:\n- this interface doesn\'t belong to the public API for which a JavaDoc is generated and therefore can be seen as \"internal\"\n- I wouldn\'t be surprised if except HtmlUnit, nobody uses this mechanism to use an alternive RegExp implementation\n- finally, it will make possible to provide a new regexp support based on Java RegExp and to give the possibility to choose between the two implementationsLooks good, thanks.\n\nChecking in src/org/mozilla/javascript/NativeString.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeString.java,v  <--  NativeString.java\nnew revision: 1.63; previous revision: 1.62\ndone\nChecking in src/org/mozilla/javascript/RegExpProxy.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/RegExpProxy.java,v  <--  RegExpProxy.java\nnew revision: 1.20; previous revision: 1.19\ndone\nChecking in src/org/mozilla/javascript/regexp/RegExpImpl.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/RegExpImpl.java,v  <--  RegExpImpl.java\nnew revision: 1.37; previous revision: 1.36\ndone',?,REFACTORING
469937,'Properties without DontEnum are sometimes not enumerated',Rhino,Core,cam,szegedia,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.2a1pre) Gecko/20081214 Minefield/3.2a1pre\nBuild Identifier: Rhino 1.7 release 3 PRERELEASE 2008 12 17\n\nCertain sequences of operations on an object can cause a property to be not placed in the ordered linked list of properties.  Specifically this happens when:\n\n  * A property p1 with slot index X is created\n  * A property p2 with slot index Y (where X != Y) is created\n  * Property p2 is deleted\n  * The object\'s properties are enumerated\n  * A property p3 with slot index Y is created\n\nAfter this, p3 is on the object, but won\'t be enumerated.\n\n\nReproducible: Always\n\nSteps to Reproduce:\nEvaluate the following script:\n\no = { }\no.PageLeft = 1\no.Rect2 = 6\ndelete o.Rect2\nfor (var p in o);\no.Rect3 = 7\nfound = false\nfor (var p in o) if (p == \'Rect3\') found = true\njava.lang.System.out.println(\"found = \" + found)\n\nActual Results:  \nPrints out \"found = false\".\n\n\nExpected Results:  \nPrint out \"found = true\".Created attachment 353354\nPatch for the bug\n\nThe bug is that lastAdded is not updated when the final slot of the ordered property linked list is removed due to it having wasDeleted == true.  If this happens, then when a property slot is created after this, it will be assigned to lastAdded.orderedNext inside accessSlot(), resulting in it not being reached when traversing the list starting from firstAdded the next time the properties are enumerated.\n\nThe patch updates getIds(boolean) to ensure lastAdded remains pointing to the last slot in the list.Actually, disregard the stuff about the slot indexes in the first comment, that\'s a red herring.  The situation the bug occurs in is just:\n\n  * Start with an object that has at least one property and which hasn\'t had\n    its most recently added property (or properties) deleted\n  * Create a property p1\n  * Delete property p1\n  * Enumerate the object\'s properties\n  * Create property p2 (where p2 ! p1)\n\nThen p2 won\'t be enumerated.Committed to CVS HEAD; also added a unit test (confirmed that it failed before the patch and it passes after the patch).\n\ncvs ci -m \"Fix (and testcase) for Bug #469937 \"Properties without DontEnum are sometimes not enumerated\"\" -l \"/tests/ecma_3/Regress/regress-469937.js\"\n    RCS file: /cvsroot/mozilla/js/tests/ecma_3/Regress/regress-469937.js,v\n    done\n    Checking in ecma_3/Regress/regress-469937.js;\n    /cvsroot/mozilla/js/tests/ecma_3/Regress/regress-469937.js,v  <--  regress-469937.js\n    initial revision: 1.1\n    done\nok (took 0:11.235)\n***\n\n***\ncvs ci -m \"Fix (and testcase) for Bug #469937 \"Properties without DontEnum are sometimes not enumerated\"\" -l \"/Rhino/src/org/mozilla/javascript/ScriptableObject.java\"\n    Checking in src/org/mozilla/javascript/ScriptableObject.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\n    new revision: 1.142; previous revision: 1.141\n    done\nok (took 0:05.722)\n***Fix propagated to 1.7R2 release branchhttp://hg.mozilla.org/tracemonkey/rev/6e8432d93d57',?,BUG
470631,'Type flow analysis does not assume as much as it could for numeric operators',Rhino,Core,cam,szegedia,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.4; en-US; rv:1.9.2a1pre) Gecko/20081220 Minefield/3.2a1pre\nBuild Identifier: \n\nBinary multiplication and unary plus/minus are not treated as operators that unconditionally return a number.\n\nReproducible: AlwaysCreated attachment 354030\nMake binary multiplication and unary plus/minus be recognised as always returning an umber\n\nThis patch does some minor code style cleanups in Block.findExpressionType(), too.Created attachment 354031\nMake binary multiplication and unary plus/minus be recognised as always returning a number\n\nMy name up in lights...Looks to me that the patch matches the ECMA-262 specification - these operators indeed always return a number.\n\nCommitted the patch to CVS HEAD:\n\n***\ncvs ci -m \"Fix for bug #470631 \"Type flow analysis does not assume as much as it could for numeric operators\"\" -l \"/Rhino/src/org/mozilla/javascript/optimizer/Block.java\"\n    Checking in src/org/mozilla/javascript/optimizer/Block.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Block.java,v  <--  Block.java\n    new revision: 1.42; previous revision: 1.41\n    done\nok (took 0:02.157)\n***Fix propagated to 1.7R2 release branch',?,IMPROVEMENT
471159,'Fix a couple of javadoc errors',Rhino,Core,cam,norrisboyd,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.4; en-US; rv:1.9.2a1pre) Gecko/20081225 Minefield/3.2a1pre\nBuild Identifier: \n\nThere are some minor javadoc errors in src/org/mozilla/javascript/ast/:\n\n  [javadoc] /home/cam/work/cvs/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ast/ScriptNode.java:116: warning - Tag @see: reference not found: getEncodedSource\n  [javadoc] /home/cam/work/cvs/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ast/ScriptNode.java:132: warning - Tag @see: reference not found: getEncodedSource\n  [javadoc] /home/cam/work/cvs/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ast/ScriptNode.java:140: warning - Tag @see: reference not found: getEncodedSource\n  [javadoc] /home/cam/work/cvs/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ast/ScriptNode.java:149: warning - Tag @see: reference not found: getEncodedSource\n  [javadoc] /home/cam/work/cvs/rhino/mozilla/js/rhino/src/org/mozilla/javascript/ast/SwitchStatement.java:122: warning - @param argument \"case\" is not a parameter name.\n\n\nReproducible: AlwaysCreated attachment 354471\nPatch to fix the javadoc errorsFixed in CVS HEAD',?,CLEANUP
472246,'typo in toolsrc build file (build.xml)',Rhino,Core,driscoll.davidj,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.0.5) Gecko/2008120122 Firefox/3.0.5\nBuild Identifier: rhino1_7R1 \n\nThe build file in rhino\\toolsrc\\build.xml has a small typo in the target compile-debugger section.\nIt should have destdir=\"${classes}\" instead of  destdir=\"classes\" otherwise compiled classes do not get copied to appropriate build location and .jar file does not include the tools classes when command: \" ant compile-debugger \" is run.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Go to \\toolsrc\n2.ant compile-debugger\n3.notice compiled classed not copied to build folder\nActual Results:  \ncompiled classes do not get copied to the appropriate build folder due to this typo.\n\nExpected Results:  \nant compile-debugger should copy .class files to \\rhino\\build\\ \n\nIt should have destdir=\"${classes}\" instead of  destdir=\"classes\"\nin the target compile-debugger section.This has been fixed in the 1.7R2 candidate.',?,IMPROVEMENT
473185,'JavaAdapter does not support extending classes with non-empty constructors.',Rhino,Core,jcmcclurg,nobody,'User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; InfoPath.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)\nBuild Identifier: 1.7\n\nI receive a java exception in the following script:\n\n...\nvar MyConn = new JavaAdapter(Packages.com.trilead.ssh2.Connection,\n{\n   addedFunc: function(){\n      ...\n   }\n});\n...\nThe Packages.com.trilead.ssh2.Connection constructor requires a string as an argument.  There is no empty constructor for the Connection object.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Enter a similar script to above (making sure to attempt to extend a class with a non-empty constructor)\n2. Attempt to run it via the rhino 1.7 shell (org.mozilla.javascript.tools.shell.Main)\nActual Results:  \nException in thread \"Thread-4\" java.lang.NoSuchMethodError: com.trilead.ssh2.Connection: method <init>()V not found\n\tat adapter6.<init>(<adapter>)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)\n\tat java.lang.reflect.Constructor.newInstance(Unknown Source)\n\tat org.mozilla.javascript.JavaAdapter.js_createAdapter(JavaAdapter.java:203)\n\tat org.mozilla.javascript.JavaAdapter.execIdCall(JavaAdapter.java:124)\n\tat org.mozilla.javascript.IdFunctionObject.call(IdFunctionObject.java:127)\n\tat org.mozilla.javascript.BaseFunction.construct(BaseFunction.java:328)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3380)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n\tat org.mozilla.javascript.ScriptRuntime.evalSpecial(ScriptRuntime.java:2425)\n\tat org.mozilla.javascript.ScriptRuntime.callSpecial(ScriptRuntime.java:2277)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3223)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n\tat org.mozilla.javascript.ScriptRuntime.evalSpecial(ScriptRuntime.java:2425)\n\tat org.mozilla.javascript.ScriptRuntime.callSpecial(ScriptRuntime.java:2277)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:3223)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2484)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:162)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:401)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3003)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:160)\n\tat org.mozilla.javascript.Context$1.run(Context.java:488)\n\tat org.mozilla.javascript.Context.call(Context.java:499)\n\tat org.mozilla.javascript.Context.call(Context.java:486)\n\tat org.mozilla.javascript.JavaAdapter.callMethod(JavaAdapter.java:538)\n\tat adapter2.run(<adapter>)\n\nExpected Results:  \n(no errors)\n\nThe JavaAdapter function should provide a way to extend classes with non-empty constructors.  Moreover, it should provide the functionality to add a constructor to the parent class.I have this issue too, is it possible to overwrite constructor of an Java object?I\'ve started working on this, and hope to get it ready for being committed within the next few weeks.Hi, Hannes\nI\'d like to have a look at this problem too, if you can kindly give me some idea about how to fix it.\nMaybe I can submit a patch if I can fix it.\nThanks for your great help.The plan I\'ve come up with is to override all public superclass constructors in JavaAdapters, and then more or less use the same mechanism for JavaAdapter constructor lookup that is used when calling an ordinary Java classes (see NativeJavaClass.constructSpecific). If no extra args are provided, the current code path would be used. \n\nOverwriting all constructors is necessary because calling the super-constructor is the first thing you have to do in a constructor, so we can\'t just generate one constructor and let that figure out which super-constructor to use.\n\nThe major problems I still haven\'t figured out are actually trivial ones - How do you pass extra constructor args to JavaAdapter (the simple approach is to look for non-java-class arguments between JavaAdapter(javaClass, ..., jsObject), but what about constructors taking a java class parameter?), and how to keep generated constructors apart (there\'s specifically one 3-argument JavaAdapter constructor that\'s used for serialization that could cause conflicts).I came out following thoughts. Here is my two cents...\n\nIn normal usage you don\'t have to pass constructor args. It could just get from the out-side scope.\n\nvar arg = ...;\nvar childObj = new JavaAdapter(parentClass, {\n\t\'<init>\': function (){\n\t\tsuper(arg);\n\t}\n});\n\nAbove code adapts a Java Class to a js Obj.\nIt is okay for javascript style object based OOP which has no notion of Class.\n\nI guess what you are trying to do is to instantiate obj and define constructor at the same time.\nI suggest to separate two cases and provide a non-leak abstraction for it.\n\nFor example, maybe we can have a JavaAdapterConstructor to return a js constructor for the JavaAdapter.\nvar childConstructor = new JavaAdapterConstructor(parentClass, {\n\t\'<init>\': function (arg){\n\t\tsuper(arg);\n\t}\n});\nvar childObj = new childConstructor(arg);\n\nor just define a constructor function childConstructor. I don\'t know if this is a feasible solution.\n\nvar childConstructor = function(arg){\n\t... //Init JavaAdapter here\n};\n\nchildConstructor.prototype = ...something...; //or here\n\n\nIf we like to generate a Java Class complete inter-operable from the Java side, we might need the ability to create a complete Class information from javascript.\n\nWhich yields following sudo-code.\n\nvar cls = new JavaClass({\n\tname: \'className\',\n\textends: parentClass,\n\timplements: [interfaces...],\n\tdefine: {\n\t\t...field and function with type and signature\n\t}\n});\n\nI might call it \"Writing Java in Javascript\"! :pFixed in git master and rhino_1_8 branch:\n\nhttps://github.com/mozilla/rhino/commit/b96c299c9a824fe4a8aa703b7bc366f32465da0f\n\nCopied from commit message:\n\nThis changes JavaAdapter to accept additional arguments after the JavaScript implementation object to be passed to the super-class constructor.\n\nTo avoid ambiguity when parsing arguments, JavaAdapter expects the implementation object (previously the last argument to JavaAdapter) to be strictly an instance of NativeObject (a plain JavaScript object) when called with additional constructor arguments.',?,BUG
473761,'Bad XML new property creation',Rhino,E4X,sisu.eugen,nobody,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) AppleWebKit/525.19 (KHTML, like Gecko) Chrome/1.0.154.43 Safari/525.19\nBuild Identifier: \n\nScenario:\n1. define an xml:\nvar _xml = <root><customer></customer></root>\nvar _order = _xml.customer.order; \n\n_order.child1 = \"value 1\"; //here we expect to add a _xml.customer.order.child1 =\"value 1\"\n_order.child2 = \"value 2\";//here we expect to add a _xml.customer.order.child2 =\"value 2\"\n\nNow we expect to have child1  and child2 nodes created.\n!!! Child2 is not created !!!\n\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\nContext context = Context.enter();\n\t\tScriptable scope = context.initStandardObjects();\n\t\t String source = \"function b() {\" + \"var _xml = <xml><customer><name></name></customer></xml>;\" \n\t\t   + \"var  _order; _order = _xml.customer.order;\" + \"_order.orderid = \\\"1\\\";\"\n\t\t   + \"_order.test = \\\"expected_string\\\"; return _xml.customer.order.test; } b();\";\n\t\t Object result = context.evaluateString(scope, source, \"test.js\", 0, null);\n\t\t System.out.println(result);\n\t\t Context.exit();\n\nActual Results:  \nnull\n\nExpected Results:  \nexpected_string\n\nIn XMLList in putXMLProperty, the target object is set only one time.\nA patch can be found in the attachment.Created attachment 357146\nSet the targetObject with the target property.\n\nI noticed that when adding another property this is not set to the target object.\nHope this patch will fix it, please review.+David P. Caldwell\n\nAny comments on the patch, David?I don\'t see anything that seems wrong with the patch.  I only committed a few minutes to looking at it, though!Committed patch and created unit test:\n\nChecking in testsrc/doctests/473761.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/473761.doctest,v  <--  473761.doctestinitial revision: 1.1\ndone\nChecking in xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java;\n/cvsroot/mozilla/js/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java,v  <--  XMLList.java\nnew revision: 1.30; previous revision: 1.29\ndoneUnfortunatey, I\'ve found than with this patch, another issue happens. I don\'t think the pathc is wrong but it was shadowing another issue.\n\nI\'ve added a new issue with the problem at Bug 566186 [https://bugzilla.mozilla.org/show_bug.cgi?id=566181]Created attachment 446591\nPropposed patch to solve the previous issues\n\nThis patch, avoid re-setting the targetObject for all calls to putXMLProperty. Instead of that, it ensures than when a node is created using putXMLProperty, the parents of the node are well defined.',?,BUG
474310,'Incorrect optimization of unary increment/decrement operators applied to number function parameteres',Rhino,Compiler,sbabovich,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.9.0.5) Gecko/2008121622 Fedora/3.0.5-1.fc9 Firefox/3.0.5\nBuild Identifier: rhino1_7R1\n\nConsider the following java script function:\n\nfunction f1(i : Number) : String\n{\n return ++i;\n}\n\nfunction f2(i : Number) : String\n{\n  f1(i);\n}\n \nThe result of \nf2(\"5\") will return 1 - NOT 6 !!! \n\nHere is java code for f1() generated by compiler:\n\n    private static Object _c1(c1 c1_1, Context context, Scriptable scriptable, Scriptable scriptable1, Object i, double d, Object aobj[])\n    {\n        scriptable = c1_1.getParentScope();\n    //    0    0:aload_0         \n    //    1    1:invokeinterface #201 <Method Scriptable Scriptable.getParentScope()>\n    //    2    6:astore_2        \n        return OptRuntime.wrapDouble(++d);\n    //    3    7:dload           5\n    //    4    9:dconst_1        \n    //    5   10:dadd            \n    //    6   11:dup2            \n    //    7   12:dstore          5\n    //    8   14:invokestatic    #205 <Method Double OptRuntime.wrapDouble(double)>\n    //    9   17:goto            20\n    //   10   20:areturn         \n    }\n\n\nAs you can see optimized code ignores Object input parameter. org.mozilla.javascript.optimizer.Codegen.visitIncDec() needs to be fixed.\n\nIf replace ++i with i+1 correct java code is generated: \nprivate static Object _c1(c1 c1_1, Context context, Scriptable scriptable, Scriptable scriptable1, Object i, double d, Object aobj[])\n    {\n        if(i == Void.TYPE)\n    //*   0    0:aload           4\n    //*   1    2:getstatic       #201 <Field Class Void.TYPE>\n    //*   2    5:if_acmpne       15\n            i = OptRuntime.wrapDouble(d);\n    //    3    8:dload           5\n    //    4   10:invokestatic    #205 <Method Double OptRuntime.wrapDouble(double)>\n    //    5   13:astore          4\n        scriptable = c1_1.getParentScope();\n    //    6   15:aload_0         \n    //    7   16:invokeinterface #211 <Method Scriptable Scriptable.getParentScope()>\n    //    8   21:astore_2        \n        return OptRuntime.add(i, 1.0D);\n    //    9   22:aload           4\n    //   10   24:dconst_1        \n    //   11   25:invokestatic    #215 <Method Object OptRuntime.add(Object, double)>\n    //   12   28:goto            31\n    //   13   31:areturn         \n    }\n\n \n  \n\n\nReproducible: Always\n\nSteps to Reproduce:\n1.\n2.\n3.Base Rhino doesn\'t implement type annotations. Also, f2 doesn\'t have a return statement. Changing these I get correct behavior:\n\nfunction f1(i )\n{\n return ++i;\n}\n\nfunction f2(i )\n{\n return f1(i);\n}\nprint(f2(\"5\"));\n\nprints \"6\".Looks like bug appears with optimization levels > 0. Check below (test.js contains your test):\n\n[.. classes]$ java org.mozilla.javascript.tools.jsc.Main -opt 0 test.js\n[.. classes]$ java test\n6\n[.. classes]$ java org.mozilla.javascript.tools.jsc.Main -opt 1 test.js\n[.. classes]$ java test\n1ConfirmedCreated attachment 358115\nProposed patchCommitted change to CVS HEAD and 1.7R2 branch.',?,BUG
476041,'overloaded var-arg java method is not found when array is provided as argument',Rhino,Core,Marco,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; de; rv:1.9.0.5) Gecko/2008121623 Ubuntu/8.10 (intrepid) Firefox/3.0.5\nBuild Identifier: 1.7R1\n\nIf a Java object is accessed from within JavaScript and this object has an overloaded method with a var-arg parameter (like \"Object ... objects\"), the wrong method is chosen and an EvaluatorException is thrown like this:\n\norg.mozilla.javascript.EvaluatorException: Cannot convert org.mozilla.javascript.NativeArray@3487a5cc to rhinotest.MyInterface (TestScript#1)\n\nIt worked fine until 1.6R5. It is broken in 1.7R1 and all 1.6Rx from 1.6R6 on.\n\nI assume that is because of some specific extensions for Java var-args: It works now, if I do not pass \"new Array(...)\" but just put the arguments directly into the method call. However all our old scripts use the old syntax and therefore cannot be executed by the new version.\n\nIt should work with both - an explicit \"new Array(...)\" and with directly putting all arguments as method arguments.\n\nReproducible: Always\n\nSteps to Reproduce:\nSee this little test case for reproducing: http://www.nightlabs.de/~marco/rhino/2009-01-29.00/RhinoTest.tar.gz\nActual Results:  \norg.mozilla.javascript.EvaluatorException being thrown\n\nExpected Results:  \nCorrect method being executed - no exception.Just wanted to add: It works fine, too, if the method is not overloaded (i.e. only the var-args method exists in the Java object).This has been fixed and works correctly in 1.7R3 and current master branch. Thanks for reporting!',?,BUG
477076,'\" in the shell',Rhino,Compiler,umi.tanuki,norrisboyd,'User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; ja; rv:1.9.0.6) Gecko/2009011913 Firefox/3.0.6 (.NET CLR 3.5.30729) Ubiquity/0.1.5\nBuild Identifier: Rhino 1.7 release 1 2008 03 06\n\nLeft shift(<<) + \"<\" with integer fails assertion. Type \"1 <<<\" on your shell. This syntax is not of JavaScript but also finshes VM.\n\nC:\\tmp>java -jar js17R1.jar\nRhino 1.7 release 1 2008 03 06\njs> 1 <<<\njava.lang.IllegalStateException: FAILED ASSERTION\n        at org.mozilla.javascript.Kit.codeBug(Kit.java:480)\n        at org.mozilla.javascript.TokenStream.ungetChar(TokenStream.java:1213)\n        at org.mozilla.javascript.TokenStream.getFirstXMLToken(TokenStream.java:923)\n        at org.mozilla.javascript.Parser.xmlInitializer(Parser.java:1825)\n        at org.mozilla.javascript.Parser.unaryExpr(Parser.java:1802)\n        at org.mozilla.javascript.Parser.mulExpr(Parser.java:1737)\n        at org.mozilla.javascript.Parser.addExpr(Parser.java:1718)\n        at org.mozilla.javascript.Parser.shiftExpr(Parser.java:1707)\n        at org.mozilla.javascript.Parser.relExpr(Parser.java:1672)\n        at org.mozilla.javascript.Parser.eqExpr(Parser.java:1628)\n        at org.mozilla.javascript.Parser.bitAndExpr(Parser.java:1617)\n        at org.mozilla.javascript.Parser.bitXorExpr(Parser.java:1606)\n        at org.mozilla.javascript.Parser.bitOrExpr(Parser.java:1595)\n        at org.mozilla.javascript.Parser.andExpr(Parser.java:1583)\n        at org.mozilla.javascript.Parser.orExpr(Parser.java:1571)\n        at org.mozilla.javascript.Parser.condExpr(Parser.java:1554)\n        at org.mozilla.javascript.Parser.assignExpr(Parser.java:1539)\n\n... and more\n\nReproducible: Always\n\nSteps to Reproduce:\n1. start rhino shell\n2. type 1 <<< <Enter>\n3. VM finishesFixed:\n\nChecking in src/org/mozilla/javascript/TokenStream.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/TokenStream.java,v  <--  TokenStream.java\nnew revision: 1.75; previous revision: 1.74\ndone',?,BUG
477233,'E4X filters with namespaces codegen bug',Rhino,E4X,martin,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686 (x86_64); en-US; rv:1.9.1b2pre) Gecko/20081123 Minefield/3.1b2pre\nBuild Identifier: rhino1_7R2-RC3.zip\n\nI\'ve run into a problem with E4X filters on namespaced elements. The\nfollowing example demonstrates the problem:\n\nvar xml = <atom:feed xmlns:atom=\"http://www.w3.org/2005/Atom\">\n            <atom:entry>\n              <atom:title>One</atom:title>\n            </atom:entry>\n            <atom:entry>\n              <atom:title>Two</atom:title>\n            </atom:entry>\n           </atom:feed>;\n\nif (1) {\n  var atom = new Namespace(\"http://www.w3.org/2005/Atom\");\n  print(xml.atom::entry.(atom::title == \"One\"));\n}\nelse {\n  default xml namespace = \"http://www.w3.org/2005/Atom\";\n  print(xml.entry.(title == \"One\"));\n  default xml namespace = \"\";\n}\n\nThe first part of the if () statement results in the following stack\ntrace when optimization is turned on (tested with rhino1_7R2-RC3.zip).\nThe second part works.\n\nReproducible: Always\n\nSteps to Reproduce:\n1. Run provided example using \"java -jar js.jar bad-filter.js\"\n\nActual Results:  \n        at org.mozilla.javascript.optimizer.Codegen.badTree(Codegen.java:1273)\n        at org.mozilla.javascript.optimizer.BodyCodegen.visitIfJumpEqOp(Codegen.java:4429)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateExpression(Codegen.java:2589)\n        at org.mozilla.javascript.optimizer.BodyCodegen.visitDotQuery(Codegen.java:4758)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateExpression(Codegen.java:2805)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateCallArgArray(Codegen.java:3551)\n        at org.mozilla.javascript.optimizer.BodyCodegen.visitStandardCall(Codegen.java:3314)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateExpression(Codegen.java:2271)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:2118)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1937)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateStatement(Codegen.java:1937)\n        at org.mozilla.javascript.optimizer.BodyCodegen.generateBodyCode(Codegen.java:1363)\n        at org.mozilla.javascript.optimizer.Codegen.generateCode(Codegen.java:327)\n        at org.mozilla.javascript.optimizer.Codegen.compileToClassFile(Codegen.java:182)\n        at org.mozilla.javascript.optimizer.Codegen.compile(Codegen.java:91)\n        at org.mozilla.javascript.Context.compileImpl(Context.java:2391)\n        at org.mozilla.javascript.Context.compileString(Context.java:1359)\n        at org.mozilla.javascript.Context.compileString(Context.java:1348)\n        at org.mozilla.javascript.tools.shell.Main.loadScriptFromSource(Main.java:495)\n        at org.mozilla.javascript.tools.shell.Main.processFileSecure(Main.java:483)\n        at org.mozilla.javascript.tools.shell.Main.processFile(Main.java:452)\n        at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:443)\n        at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:196)\n        at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:117)\n        at org.mozilla.javascript.Context.call(Context.java:515)\n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:507)\n        at org.mozilla.javascript.tools.shell.Main.exec(Main.java:179)\n        at org.mozilla.javascript.tools.shell.Main.main(Main.java:157)\n\n\nExpected Results:  \n<atom:entry xmlns:atom=\"http://www.w3.org/2005/Atom\">\n  <atom:title>One</atom:title>\n</atom:entry>I think this patch fixes the problem: \n\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v\nretrieving revision 1.264.2.2\ndiff -u -r1.264.2.2 Codegen.java\n--- src/org/mozilla/javascript/optimizer/Codegen.java\t12 Dec 2008 10:37:25 -0000\t1.264.2.2\n+++ src/org/mozilla/javascript/optimizer/Codegen.java\t18 Mar 2009 22:52:19 -0000\n@@ -2787,6 +2787,7 @@\n                       case Token.REF_NS_NAME:\n                         methodName = \"nameRef\";\n                         signature = \"(Ljava/lang/Object;\"\n+                                    +\"Ljava/lang/Object;\"\n                                     +\"Lorg/mozilla/javascript/Context;\"\n                                     +\"Lorg/mozilla/javascript/Scriptable;\"\n                                     +\"I\"Patch committed, thanks.\n\nChecking in src/org/mozilla/javascript/optimizer/Codegen.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/optimizer/Codegen.java,v  <\n--  Codegen.java\nnew revision: 1.271; previous revision: 1.270\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/477233.doctest,v\ndone\nChecking in testsrc/doctests/477233.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/477233.doctest,v  <--  477233.doctest\n\ninitial revision: 1.1\ndone',?,BUG
477604,'Array.concat causes ArrayIndexOutOfBoundException with non dense array',Rhino,Core,mguillemot,norrisboyd,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.5) Gecko/2008121621 Ubuntu/8.04 (hardy) Firefox/3.0.5\nBuild Identifier: \n\neverything is in the title and in \"Steps to Reproduce\". I\'ll attach the fix as a patch.\n\nReproducible: Always\n\nSteps to Reproduce:\nvar a = [\'a0\', \'a1\'];\na[3] = \'a3\';\nvar b = [\'b1\', \'b2\'];\nb.concat(a)\";Created attachment 361270\nUnit test + fix for this bugDoesn\'t work for \n\nfunction myarray() { }\nmyarray.prototype = Array.prototype;\nvar c = new myarray();\nc[0] = \'c0\';\nc[1] = \'c1\';\nc[3] = \'c3\';\nc.length = 4;\nb.concat(c);\n\nI\'ll fix.I agree: my patch doesn\'t fix the problem illustrated in your example (but it doesn\'t introduce this problem).\n\nI wouldn\'t be surprised if Array.concat has other problems.Fixed.Thanks Norris for the very quick fix.\n\nFor info, #452993 reports a problem in Array.concat as well but it seems to me to be invalid (or it has been fixed as side effect of some other change).',?,BUG
482203,'NullPointerException capturing a continuation',Rhino,Core,szegedia,nobody,'Up to 1.7R1, I used to terminate an interpreter by capturing a continuation at the top scope level, and then invoking it when necessary. With HEAD though, now I\'m getting a NullPointerException:\n\nException in thread \"main\" java.lang.NullPointerException\n\tat org.mozilla.javascript.Interpreter.captureContinuation(Interpreter.java:2945)\n\tat org.mozilla.javascript.Interpreter.interpretLoop(Interpreter.java:1729)\n\tat org.mozilla.javascript.Interpreter.interpret(Interpreter.java:845)\n\tat org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:164)\n\tat org.mozilla.javascript.ContextFactory.doTopCall(ContextFactory.java:405)\n\tat org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java:3066)\n\tat org.mozilla.javascript.Context.callFunctionWithContinuations(Context.java:1199)\n\tat org.mozilla.javascript.Context.executeScriptWithContinuations(Context.java:1166)\n\tat org.szegedi.rhinotest.ContinuationsTest17.main(ContinuationsTest17.java:20)\n\nI\'ve attached a ZIP file with two Java test files and one .js file - the first Java class (suffixed 16) works against all 1.6 Rhino releases that support continuations, as well as 1.7R1. The second Java class (suffixed 17) uses the 1.7R2 continuations API, and throws a NPE.\n\nIs this a bug, or am I doing something wrong?Created attachment 366273\nA Zip file with testsFixed:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  In\nterpreter.java\nnew revision: 1.355; previous revision: 1.354\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug4822\n03.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug482203.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug482203.java,v\n <--  Bug482203.java\ninitial revision: 1.1\ndone\n\nand in release branch:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.349.2.5; previous revision: 1.349.2.4\ndone',?,BUG
487599,'NativeArray: improve performance of sort([fn]) using java\'s Arrays.sort(..)',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko/2009032711 Ubuntu/8.04 (hardy) Firefox/3.0.8\nBuild Identifier: \n\nNativeArray currently implement sort by itself whereas it could make usage of java.util.Arras#sort as done is provided patch.\n\nWith following code:\n\nvar t = [1, 5, 2, 1, 9];\nvar nbComp = 0;\nvar compare = function(x, y) { print((nbComp++) + \": \" + x + \"<>\" + y); return x - y; };\nt.sort(compare);\n\ncurrent implementation needs to call the compare function 11 times:\n--- output with current implementation ---\n0: 9<>1\n1: 9<>5\n2: 2<>9\n3: 9<>1\n4: 5<>1\n5: 5<>1\n6: 2<>5\n7: 5<>1\n8: 1<>1\n9: 2<>1\n10: 2<>1\n11: 1<>1\n\nwith provided patch, the compare function is called only 6 times!\n--- output with patched implementation using java\'s Array.sort ---\n0: 1<>5\n1: 5<>2\n2: 1<>2\n3: 5<>1\n4: 2<>1\n5: 1<>1\n6: 5<>9\n\nOk, this example is not necessary representative but my guess is that a JDK method like Arras.sort contains when not all necessary optimizations, surely more than Rhino\'s implementation.\n\n\nReproducible: AlwaysCreated attachment 371838\nPatch using Arrays.sort for NativeArray.sort\n\nThis patch removes all custom sort logic to use JDK\'s Arrays.sort method. With this patch applied, I get exactly the same errors running ant junit-all than without the patch.\n\nNote:\nI\'ve removed handling of arrays with length greater than Integer.MAX_VALUE first because I think that it is not a real use case and second because it is not tested by any test and a feature that is not tested doesn\'t exist! ;-)Overall, it looks good to me. Few minor points:\n\n1. removing handling of arrays with length equal to Integer.MAX_VALUE should be okay. Maximum length for JS native arrays is 2^32-1 anyway. It\'s true that sort() function can be transferred to another objects as well, but even if it were, the definition of sort is such that it only operates on ToUInt32(this.[[Get]](\"length\")).\n\n2. The testing for undefined values should also be performed in the case where you don\'t have a comparator function.\n\n3. storing the Undefined.instance and Scriptable.NOT_FOUND in a local variable won\'t really help performance. The anonymous inner Comparator class will have them stored in compiler-emitted synthetic instance fields, so they\'ll be accessed using GETFIELD JVM instruction on the comparator object, instead of a GETSTATIC on Undefined and Scriptable classes - not much if any performance boost. They certainly won\'t be accessed as local variables with ALOAD, if that\'s what your intent was...2. You\'re right.\n\n3- It just a rest of the old code that I haven\'t completely clean up. I\'m quite sure as well that it has no impact on the performance: the JVM is surely able to make the best decision here.\n\nI\'ll make the tow changes and upload a new version of the patch.Created attachment 371852\nthe same with the minor improvements suggested by AttilaYou shouldn\'t have to copy into a working array if \"denseOnly\" is true.\n\nIt would be nice to have the code work for sparse arrays. That appears to be the intent of the heapsort code (I didn\'t write it), but it doesn\'t appear to work from my brief testing, so I\'m fine with removing it.\n\nThanks for the contribution.(In reply to comment #5)\n> \n> It would be nice to have the code work for sparse arrays.\n\nThe existing heapsort code was also first copying a sparse array to a temporary array, didn\'t it? In this regard at least, the new code is not any worse :-)\n\nIt would be nice though if java.util.Collections.sort(List) weren\'t implemented in terms of Arrays.sort() (it too copies the list to an array first), so we could then delegate sorting of sparse arrays to java.util.Collections.sort(List) with a List adapter... \n\nBTW, did you hear that Josh Bloch checked in an implementation of timsort as a replacement for mergesort for Arrays.sort() in Java 7? See <http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6804124>Having the code work efficiently with very sparse arrays would be nice but shouldn\'t hold up this change. I hadn\'t heard of timsort, sounds promising.Ping!\n\nWhat about applying this patch as you seem to agree on it.Committed, thanks.\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.101; previous revision: 1.100\ndone',?,IMPROVEMENT
489329,'implement new Object constructor methods from ecmascript 5 spec',Rhino,Core,rspeyer,nobody,'User-Agent:       Opera/9.64 (Macintosh; Intel Mac OS X; U; en) Presto/2.1.1\nBuild Identifier: Rhino 1.7 release 2 2009 03 22\n\nObject.getPrototypeOf should return the prototype of a given object\n\nReproducible: Always\n\nActual Results:  \njs> Object.getPrototypeOf\njs> Object.getPrototypeOf() === undefined;\njs: \"<stdin>\", line 3: uncaught JavaScript runtime exception: TypeError: Cannot find function getPrototypeOf in object function Object() { [native code for Object.Object, arity=1] }\n.\n\tat <stdin>:3\n\njs> [undefined, null, true, 1, \'hello\'].every(function(value) {\n  >   try {\n  >     Object.getPrototypeOf(value);\n  >     return false;\n  >   } catch (e if e instanceof TypeError) {\n  >     return true;\n  >   } catch (e) {\n  >     return false;\n  >   }\n  > });\ntrue\njs> [(function(){}), [], {}].every(function(obj) {\n  >   return Object.getPrototypeOf(obj) === obj.__proto__;\n  > });\njs: \"<stdin>\", line 17: uncaught JavaScript runtime exception: TypeError: Cannot find function getPrototypeOf in object function Object() { [native code for Object.Object, arity=1] }\n.\n\tat <stdin>:17\n\tat <stdin>:16\n\njs> function UserDefined() {}\njs> [Date, UserDefined].every(function(type) {\n  >   var instance;\n  >   eval(\'instance = new \'+type.name);\n  >   return Object.getPrototypeOf(instance) === type.prototype;\n  > });\njs: \"<stdin>\", line 25: uncaught JavaScript runtime exception: TypeError: Cannot find function getPrototypeOf in object function Object() { [native code for Object.Object, arity=1] }\n.\n\tat <stdin>:25\n\tat <stdin>:22\n\njs> \n\n\nExpected Results:  \njs> Object.getPrototypeOf;\nfunction getPrototypeOf() { [native code for Object.getPrototypeOf, arity=1] }\njs> Object.getPrototypeOf() === undefined;\ntrue\njs> var nonObjects = [undefined, null, true, 1, \'hello\'];\njs> nonObjects.every(function(value) {\n  >   try {\n  >     Object.getPrototypeOf(value);\n  >     return false;\n  >   } catch (e if e instanceof TypeError) {\n  >     return true;\n  >   } catch (e) {\n  >     return false;\n  >   }\n  > });\ntrue\njs> [(function(){}), [], {}].every(function(obj) {\n  >   return Object.getPrototypeOf(obj) === obj.__proto__;\n  > });\ntrue\njs> function UserDefined() {}\njs> [Date, UserDefined].every(function(type) {\n  >   var instance;\n  >   eval(\'instance = new \'+type.name);\n  >   return Object.getPrototypeOf(instance) === type.prototype;\n  > });\ntrueCreated attachment 373835\ninitial patch for Object.getPrototypeOf functionalityCreated attachment 376910\npatch for getPrototypeOf, keys, getPropertyNames and getPropertyDescriptor methods on Object\n\nNote, this attachment depends on the patch submitted for bug 492525Comment on attachment 376910\npatch for getPrototypeOf, keys, getPropertyNames and getPropertyDescriptor methods on Object\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index 39f4dd3..49f00e5 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -71,6 +71,20 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     @Override\n>+    protected void fillConstructorProperties(IdFunctionObject ctor)\n>+    {\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getPrototypeOf,\n>+                \"getPrototypeOf\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_keys,\n>+                \"keys\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyNames,\n>+                \"getOwnPropertyNames\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyDescriptor,\n>+                \"getOwnPropertyDescriptor\", 2);\n>+        super.fillConstructorProperties(ctor);\n>+    }\n>+\n>+    @Override\n>     protected void initPrototypeId(int id)\n>     {\n>         String s;\n>@@ -256,6 +270,60 @@ public class NativeObject extends IdScriptableObject\n>               }\n>               return Undefined.instance;\n> \n>+          case ConstructorId_getPrototypeOf:\n>+              {\n>+                if (args.length < 1)\n>+                    return Undefined.instance;\n\nI think Object.getPrototypeOf() should throw the same error as Object.getPrototypeOf(undefined). Same for the other functions below.\n\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.toString(arg));\n\nSee comment below about error message. You can get the type of the argument by calling ScriptRuntime.typeof.\n\n>+\n>+                Scriptable obj = (Scriptable) arg;\n>+                return obj.getPrototype();\n>+              }\n>+          case ConstructorId_keys:\n>+              {\n>+                if (args.length < 1)\n>+                    return Undefined.instance;\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.toString(arg));\n>+\n>+                Scriptable obj = (Scriptable) arg;\n>+                return cx.newArray(scope, obj.getIds());\n\nUnfortunately getIds isn\'t quite right as far as the type of the elements:\n\njs> o = { a:3, \"1\":2 }\n[object Object]\njs> a = Object.keys(o)\na,1\njs> typeof a[1]\nnumber\n\nShould be string. Same for getOwnPropertyNames.\n\n>+              }\n>+          case ConstructorId_getOwnPropertyNames:\n>+              {\n>+                if (args.length < 1)\n>+                    return Undefined.instance;\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.toString(arg));\n>+\n>+                ScriptableObject obj = (ScriptableObject) arg;\n>+                return cx.newArray(scope, obj.getAllIds());\n>+              }\n>+          case ConstructorId_getOwnPropertyDescriptor:\n>+              {\n>+                if (args.length < 2)\n>+                    return Undefined.instance;\n\nNo, Object.getOwnPropertyDescriptor() is equivalent to Object.getOwnPropertyDescriptor(undefined, undefined)\n\n>+\n>+                Object arg = args[0];\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.toString(arg));\n>+                ScriptableObject obj = (ScriptableObject) arg;\n>+                String name = ScriptRuntime.toString(args[1]);\n>+\n>+                PropertyDescriptor desc = obj.getOwnPropertyDescriptor(name);\n>+                return desc == null ? Undefined.instance : desc.fromPropertyDescriptor();\n>+              }\n>+\n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>         }\n>@@ -303,6 +371,11 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     private static final int\n>+        ConstructorId_getPrototypeOf = -1,\n>+        ConstructorId_keys = -2,\n>+        ConstructorId_getOwnPropertyNames = -3,\n>+        ConstructorId_getOwnPropertyDescriptor = -4,\n>+\n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>         Id_toLocaleString        = 3,\n>diff --git a/src/org/mozilla/javascript/PropertyDescriptor.java b/src/org/mozilla/javascript/PropertyDescriptor.java\n>new file mode 100644\n>index 0000000..3f5aaa9\n>--- /dev/null\n>+++ b/src/org/mozilla/javascript/PropertyDescriptor.java\n>@@ -0,0 +1,106 @@\n>+package org.mozilla.javascript;\n>+\n>+public class PropertyDescriptor implements Cloneable {\n>+  protected Boolean enumerable = null;\n>+  protected Boolean configurable = null;\n>+  private Object value = null;\n>+  private Boolean writable = null;\n>+  // TODO these two values might be mutable, is it still okay to clone?\n>+  private Callable getter = null; \n>+  private Callable setter = null;\n>+\n>+  public PropertyDescriptor enumerable(Boolean enumerable) {\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.enumerable = enumerable;\n>+    return copy;\n>+  }\n>+  public PropertyDescriptor configurable(Boolean configurable) {\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.configurable = configurable;\n>+    return copy;\n>+  }\n>+  public PropertyDescriptor value(Object value) {\n>+    if (this.isAccessorDescriptor()) \n>+      throw new UnsupportedOperationException(\"Cannot add value to an accessor property descriptor\");\n>+\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.value = value;\n>+    return copy;\n>+  }\n>+  public PropertyDescriptor writable(Boolean writable) {\n>+    if (this.isAccessorDescriptor()) \n>+      throw new UnsupportedOperationException(\"Cannot add writable to an accessor property descriptor\");\n>+\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.writable = writable;\n>+    return copy;\n>+  }\n>+  public PropertyDescriptor getter(Callable getter) {\n>+    if (this.isDataDescriptor()) \n>+      throw new UnsupportedOperationException(\"Cannot add getter to a data property descriptor\");\n>+\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.getter = getter;\n>+    return copy;\n>+  }\n>+  public PropertyDescriptor setter(Callable setter) {\n>+    if (this.isDataDescriptor()) \n>+      throw new UnsupportedOperationException(\"Cannot add setter to a data property descriptor\");\n>+\n>+    PropertyDescriptor copy = this.copy();\n>+    copy.setter = setter;\n>+    return copy;\n>+  }\n>+\n>+  public boolean isEnumerable() {\n>+    return enumerable;\n>+  }\n>+  public boolean isConfigurable() {\n>+    return configurable;\n>+  }\n>+  public Object getValue() {\n>+    return this.value;\n>+  }\n>+  public boolean isWritable() {\n>+    return writable;\n>+  }\n>+  public Callable getGetter() {\n>+    return getter;\n>+  }\n>+  public Callable getSetter() {\n>+    return setter;\n>+  }\n>+\n>+  public boolean isDataDescriptor() {\n>+    return value != null || writable != null;\n>+  }\n>+  public boolean isAccessorDescriptor() {\n>+    return getter != null || setter != null;\n>+  }\n>+  public boolean isGenericDescriptor() {\n>+    return !isDataDescriptor() && !isAccessorDescriptor();\n>+  }\n>+\n>+  public NativeObject fromPropertyDescriptor() {\n>+    NativeObject obj = new NativeObject();\n>+    if (isDataDescriptor()) {\n>+      if (value != null) obj.defineProperty(\"value\", value, ScriptableObject.EMPTY);\n>+      if (writable != null) obj.defineProperty(\"writable\", writable, ScriptableObject.EMPTY);\n>+    } else if (isAccessorDescriptor()) {\n>+      if (getter != null) obj.defineProperty(\"get\", getter, ScriptableObject.EMPTY);\n>+      if (setter != null) obj.defineProperty(\"set\", setter, ScriptableObject.EMPTY);\n>+    }\n>+    if (enumerable != null) obj.defineProperty(\"enumerable\", enumerable, ScriptableObject.EMPTY);\n>+    if (configurable != null) obj.defineProperty(\"configurable\", configurable, ScriptableObject.EMPTY);\n>+    return obj;\n>+  }\n>+\n>+  private PropertyDescriptor copy() {\n>+    try {\n>+      return (PropertyDescriptor) this.clone();\n>+    } catch (CloneNotSupportedException ex) {\n>+      throw new RuntimeException(\"PropertyDescriptor does not support cloning\", ex);\n>+    }\n>+  }\n>+\n>+}\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 0c96d6c..5065076 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -202,6 +202,14 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>             }\n>         }\n> \n>+        PropertyDescriptor getPropertyDescriptor() {\n>+          return new PropertyDescriptor().\n>+            value(value).\n>+            writable((attributes & READONLY) == 0).\n>+            enumerable((attributes & DONTENUM) == 0).\n>+            configurable((attributes & PERMANENT) == 0);\n\nI think this isn\'t the best approach, because the prototype and parent aren\'t set, for one:\n\njs> x = Object.getOwnPropertyDescriptor(o, \"a\")\njs: uncaught JavaScript runtime exception: TypeError: Cannot find default value for object.\njs> typeof x\nobject\njs> Object.getPrototypeOf(x)\nnull\n\nI think you should use Context.newObject to create a new empty object and then set the appropriate properties on it for all places where you create a PropertyDescriptor. I don\'t think you need the PropertyDescriptor class.\n\n>+        }\n>+\n>     }\n> \n>     private static final class GetterSlot extends Slot\n>@@ -215,6 +223,14 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         {\n>             super(name, indexOrHash, attributes);\n>         }\n>+\n>+        PropertyDescriptor getPropertyDescriptor() {\n>+          return super.getPropertyDescriptor().\n>+            value(null).\n>+            writable(null).\n>+            getter((Callable) getter).\n>+            setter((Callable) setter);\n>+        }\n>     }\n> \n>     static void checkValidAttributes(int attributes)\n>@@ -2523,6 +2539,11 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>     }\n> \n>+    protected PropertyDescriptor getOwnPropertyDescriptor(String name) {\n>+      Slot slot = getSlot(name, 0, SLOT_QUERY);\n>+      return (slot == null) ? null : slot.getPropertyDescriptor();\n>+    }\n>+\n>     // Methods and classes to implement java.util.Map interface\n> \n>     public int size() {\n>diff --git a/src/org/mozilla/javascript/resources/Messages.properties b/src/org/mozilla/javascript/resources/Messages.properties\n>index a80e6a5..9f51f2c 100644\n>--- a/src/org/mozilla/javascript/resources/Messages.properties\n>+++ b/src/org/mozilla/javascript/resources/Messages.properties\n>@@ -260,6 +260,9 @@ msg.bad.regexp.compile =\\\n>     Only one argument may be specified if the first argument to \\\n>     RegExp.prototype.compile is a RegExp object.\n> \n>+msg.arg.not.object =\\\n>+    Argument is not an object {0}.\n>+\n\nI think a better error message would be \"Object expected, had instead <type>\", and similar for the other new functions you\'re defining.\n\n> # Parser\n> msg.got.syntax.errors = \\\n>     Compilation produced {0} syntax errors.\n>diff --git a/testsrc/build.xml b/testsrc/build.xml\n>index b4bde34..c907f00 100644\n>--- a/testsrc/build.xml\n>+++ b/testsrc/build.xml\n>@@ -118,7 +118,7 @@\n>         <pathelement location=\"${test.jstests.jar}\"/>\n>       </classpath>\n>       <batchtest todir=\"build/test\">\n>-        <fileset dir=\"${test.classes}\" includes=\"**/tests/*Test.class\"/>\n>+        <fileset dir=\"${test.classes}\" includes=\"**/tests/**/*Test.class\"/>\n>         <fileset dir=\"${test.classes}\" includes=\"**/StandardTests.class\"/>\n>       </batchtest>\n>       <formatter type=\"xml\"/>\n>diff --git a/testsrc/doctests/480758.doctest b/testsrc/doctests/480758.doctest\n>index 675483a..3893400 100755\n>diff --git a/testsrc/doctests/object.getownpropertydescriptor.doctest b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>new file mode 100644\n>index 0000000..8026267\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>@@ -0,0 +1,41 @@\n>+js> Object.getOwnPropertyDescriptor;\n>+function getOwnPropertyDescriptor() { [native code for Object.getOwnPropertyDescriptor, arity=2] }\n>+js> Object.getOwnPropertyDescriptor() === undefined;\n>+true\n>+js> [undefined, null, true, 1, \"hello\"].forEach(function(val) {\n>+  >   try {\n>+  >     Object.getOwnPropertyDescriptor(val, \'p\');\n>+  >     print(\"Object.getOwnPropertyDescriptor(\"+val+\", \'p\') should have thrown a TypeError\");\n>+  >   } catch (e if e instanceof TypeError) {\n>+  >     // expected this\n>+  >   } catch (e) {\n>+  >     print(\"Object.getOwnPropertyDescriptor(\"+val+\", \'p\') should have thrown a TypeError, but instead threw \"+e)\n>+  >   }\n>+  > })\n>+\n>+js> Object.getOwnPropertyDescriptor({}, \'p\') === undefined;\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({p:1}, \'p\');\n>+js> desc.value\n>+1\n>+js> desc.writable\n>+true\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({ get p() {}, set p() {} }, \'p\');\n>+js> desc.value === undefined;\n>+true\n>+js> desc.writable === undefined;\n>+true\n>+js> desc.get.toSource()\n>+(function () {})\n>+js> desc.set.toSource()\n>+(function () {})\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>diff --git a/testsrc/doctests/object.getownpropertynames.doctest b/testsrc/doctests/object.getownpropertynames.doctest\n>new file mode 100644\n>index 0000000..4fa5a64\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertynames.doctest\n>@@ -0,0 +1,56 @@\n>+js> Object.getOwnPropertyNames;\n>+function getOwnPropertyNames() { [native code for Object.getOwnPropertyNames, arity=1] }\n>+js> Object.getOwnPropertyNames() === undefined;\n>+true\n>+js> [undefined, null, true, 1, \"hello\"].forEach(function(val) {\n>+  >   try {\n>+  >     Object.getOwnPropertyNames(val);\n>+  >     print(\"Object.getOwnPropertyNames(\"+val+\") should have thrown a TypeError\");\n>+  >   } catch (e if e instanceof TypeError) {\n>+  >     // this was expected\n>+  >   } catch (e) {\n>+  >     print(\"Object.getOwnPropertyNames(\"+val+\") should have thrown a TypeError, but instead threw \"+e)\n>+  >   }\n>+  > })\n>+\n>+js> Object.getOwnPropertyNames({}).toSource();\n>+[]\n>+js> Object.getOwnPropertyNames({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.getOwnPropertyNames({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.getOwnPropertyNames({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.getOwnPropertyNames([]).toSource();\n>+[\"length\"]\n>+js> Object.getOwnPropertyNames([\'a\', \'b\', \'c\']).toSource();\n>+[0, 1, 2, \"length\"]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.getOwnPropertyNames({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>diff --git a/testsrc/doctests/object.getprototypeof.doctest b/testsrc/doctests/object.getprototypeof.doctest\n>new file mode 100644\n>index 0000000..dcd797a\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getprototypeof.doctest\n>@@ -0,0 +1,33 @@\n>+js> Object.getPrototypeOf;\n>+function getPrototypeOf() { [native code for Object.getPrototypeOf, arity=1] }\n>+\n>+js> // FIXME: not sure if this is correct behaviour, should we be expecting a TypeError here instead?\n>+js> Object.getPrototypeOf() === undefined;\n>+true\n>+\n>+js> var nonObjects = [undefined, null, true, 1, \'hello\'];\n>+js> nonObjects.every(function(value) {\n>+  >   try {\n>+  >     Object.getPrototypeOf(value);\n>+  >     return false;\n>+  >   } catch (e if e instanceof TypeError) {\n>+  >     return true;\n>+  >   } catch (e) {\n>+  >     return false;\n>+  >   }\n>+  > });\n>+true\n>+\n>+js> [(function(){}), [], {}].every(function(obj) {\n>+  >   return Object.getPrototypeOf(obj) === obj.__proto__;\n>+  > });\n>+true\n>+\n>+js> function UserDefined() {}\n>+js> [Date, UserDefined].every(function(type) {\n>+  >   var instance;\n>+  >   eval(\'instance = new \'+type.name);\n>+  >   return Object.getPrototypeOf(instance) === type.prototype;\n>+  > });\n>+true\n>+\n>diff --git a/testsrc/doctests/object.keys.doctest b/testsrc/doctests/object.keys.doctest\n>new file mode 100644\n>index 0000000..8c31399\n>--- /dev/null\n>+++ b/testsrc/doctests/object.keys.doctest\n>@@ -0,0 +1,56 @@\n>+js> Object.keys;\n>+function keys() { [native code for Object.keys, arity=1] }\n>+js> Object.keys() === undefined;\n>+true\n>+js> [undefined, null, true, 1, \"hello\"].forEach(function(val) {\n>+  >   try {\n>+  >     Object.keys(val);\n>+  >     print(\"Object.keys(\"+val+\") should have thrown a TypeError\");\n>+  >   } catch (e if e instanceof TypeError) {\n>+  >     // this was expected\n>+  >   } catch (e) {\n>+  >     print(\"Object.keys(\"+val+\") should have thrown a TypeError, but instead threw \"+e)\n>+  >   }\n>+  > })\n>+\n>+js> Object.keys({}).toSource();\n>+[]\n>+js> Object.keys({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.keys({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.keys({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.keys([]).toSource();\n>+[]\n>+js> Object.keys([\'a\', \'b\', \'c\']).toSource();\n>+[0, 1, 2]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.keys({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.keys({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.keys({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>diff --git a/testsrc/org/mozilla/javascript/tests/Evaluator.java b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>new file mode 100644\n>index 0000000..0876c41\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>@@ -0,0 +1,28 @@\n>+package org.mozilla.javascript.tests;\n>+import org.mozilla.javascript.*;\n>+import java.util.Collections;\n>+import java.util.Map;\n>+\n>+public class Evaluator {\n>+\n>+  public static Object eval(String source) {\n>+    return eval(source, Collections.EMPTY_MAP);\n>+  }\n>+\n>+  public static Object eval(String source, String id, Scriptable object) {\n>+    return eval(source, Collections.singletonMap(id, object));\n>+  }\n>+\n>+  public static Object eval(String source, Map<String, Scriptable> bindings) {\n>+    Context cx = ContextFactory.getGlobal().enterContext();\n>+    try {\n>+      Scriptable scope = cx.initStandardObjects();\n>+      for (String id : bindings.keySet()) {\n>+        scope.put(id, scope, bindings.get(id));\n>+      }\n>+      return cx.evaluateString(scope, source, \"source\", 1, null);\n>+    } finally {\n>+      Context.exit();\n>+    }\n>+  }\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>new file mode 100644\n>index 0000000..9eaf7a9\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>@@ -0,0 +1,32 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyDescriptor(obj, prop) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyDescriptorTest {\n>+\n>+  @Test\n>+  public void testContentsOfPropertyDescriptorShouldReflectAttributesOfProperty() {\n>+    NativeObject descriptor;\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM | ScriptableObject.READONLY | ScriptableObject.PERMANENT);\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'a\')\", \"obj\", object);\n>+    assertEquals(\"1\",  descriptor.get(\"value\"));\n>+    assertEquals(true, descriptor.get(\"enumerable\"));\n>+    assertEquals(true, descriptor.get(\"writable\"));\n>+    assertEquals(true, descriptor.get(\"configurable\"));\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'b\')\", \"obj\", object);\n>+    assertEquals(\"2\",  descriptor.get(\"value\"));\n>+    assertEquals(false, descriptor.get(\"enumerable\"));\n>+    assertEquals(false, descriptor.get(\"writable\"));\n>+    assertEquals(false, descriptor.get(\"configurable\"));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>new file mode 100644\n>index 0000000..3ba1f9d\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>@@ -0,0 +1,27 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyNames(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyNamesTest {\n>+\n>+  @Test\n>+  public void testShouldReturnAllPropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.getOwnPropertyNames(obj)\", \"obj\", object);\n>+\n>+    NativeArray names = (NativeArray) result;\n>+\n>+    assertEquals(2, names.getLength());\n>+    assertEquals(\"a\", names.get(0, names));\n>+    assertEquals(\"b\", names.get(1, names));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>new file mode 100644\n>index 0000000..9584c9f\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>@@ -0,0 +1,28 @@\n>+/*\n>+ * Tests for the Object.keys(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectKeysTest {\n>+\n>+  @Test\n>+  public void shouldReturnOnlyEnumerablePropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"c\", \"3\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.keys(obj)\", \"obj\", object);\n>+\n>+    NativeArray keys = (NativeArray) result;\n>+\n>+    assertEquals(2, keys.getLength());\n>+    assertEquals(\"a\", keys.get(0, keys));\n>+    assertEquals(\"b\", keys.get(1, keys));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/PropertyDescriptorTest.java b/testsrc/org/mozilla/javascript/tests/es5/PropertyDescriptorTest.java\n>new file mode 100644\n>index 0000000..15f767a\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/PropertyDescriptorTest.java\n>@@ -0,0 +1,120 @@\n>+package org.mozilla.javascript.tests.es5;\n>+\n>+import org.mozilla.javascript.*;\n>+import java.util.Arrays;\n>+import static org.junit.Assert.assertEquals;\n>+import static org.junit.Assert.assertTrue;\n>+import static org.junit.Assert.assertFalse;\n>+import static org.junit.Assert.fail;\n>+import org.junit.Test;\n>+\n>+public class PropertyDescriptorTest {\n>+  private final PropertyDescriptor blank = new PropertyDescriptor();\n>+  private final Callable getter = new StubCallable();\n>+  private final Callable setter = new StubCallable();\n>+\n>+  @Test\n>+  public void shouldInitializeDataDescriptorThroughBuilderMethods() {\n>+    PropertyDescriptor desc = blank.value(\"a\").enumerable(true).writable(true).configurable(true);\n>+    assertEquals(\"a\", desc.getValue());\n>+    assertEquals(true, desc.isEnumerable());\n>+    assertEquals(true, desc.isWritable());\n>+    assertEquals(true, desc.isConfigurable());\n>+  }\n>+\n>+  @Test\n>+  public void shouldInitialiseAccessorDescriptorThroughBuilderMethods() {\n>+    PropertyDescriptor desc = blank.getter(getter).setter(setter).enumerable(true).configurable(true);\n>+    assertEquals(getter, desc.getGetter());\n>+    assertEquals(setter, desc.getSetter());\n>+    assertEquals(true, desc.isEnumerable());\n>+    assertEquals(true, desc.isConfigurable());\n>+  }\n>+\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowGetterBeSetOnceValueHasBeenSet() {\n>+    blank.value(\"a\").getter(getter);\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowGetterToBeSetOnceWritableHasBeenSet() {\n>+    blank.writable(true).getter(getter);\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowSetterBeSetOnceValueHasBeenSet() {\n>+    blank.value(\"a\").setter(setter);\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowSetterToBeSetOnceWritableHasBeenSet() {\n>+    blank.writable(true).setter(setter);\n>+  }\n>+\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowValueToBeSetOnceGetterHasBeenSet() {\n>+    blank.getter(getter).value(\"a\");\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowWritableToBeSetOnceGetterHasBeenSet() {\n>+    blank.getter(getter).writable(true);\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowValueToBeSetOnceSetterHasBeenSet() {\n>+    blank.setter(setter).value(\"a\");\n>+  }\n>+  @Test(expected = UnsupportedOperationException.class)\n>+  public void shouldNotAllowWritableToBeSetOnceSetterHasBeenSet() {\n>+    blank.setter(setter).writable(true);\n>+  }\n>+\n>+  @Test\n>+  public void shouldBeDataDescriptorOnlyWhenValueOrWritableIsSet() {\n>+    assertFalse(blank.isDataDescriptor());\n>+    assertFalse(blank.enumerable(true).isDataDescriptor());\n>+    assertFalse(blank.configurable(true).isDataDescriptor());\n>+    assertFalse(blank.getter(getter).isDataDescriptor());\n>+    assertFalse(blank.setter(setter).isDataDescriptor());\n>+    assertTrue(blank.value(\"a\").isDataDescriptor());\n>+    assertTrue(blank.writable(true).isDataDescriptor());\n>+  }\n>+\n>+  @Test\n>+  public void shouldBeAccessorDescriptorOnlyWhenGetterOrSetterIsSet() {\n>+    assertFalse(blank.isAccessorDescriptor());\n>+    assertFalse(blank.enumerable(true).isAccessorDescriptor());\n>+    assertFalse(blank.configurable(true).isAccessorDescriptor());\n>+    assertFalse(blank.value(\"a\").isAccessorDescriptor());\n>+    assertFalse(blank.writable(true).isAccessorDescriptor());\n>+    assertTrue(blank.getter(getter).isAccessorDescriptor());\n>+    assertTrue(blank.setter(setter).isAccessorDescriptor());\n>+  }\n>+\n>+  @Test\n>+  public void shouldBeGenericDescriptorOnlyWhenNotDataOrAccessorDescriptor() {\n>+    assertTrue(blank.isGenericDescriptor());\n>+    assertTrue(blank.enumerable(true).isGenericDescriptor());\n>+    assertTrue(blank.configurable(true).isGenericDescriptor());\n>+    assertFalse(blank.value(\"a\").isGenericDescriptor());\n>+    assertFalse(blank.writable(true).isGenericDescriptor());\n>+    assertFalse(blank.getter(getter).isGenericDescriptor());\n>+    assertFalse(blank.setter(setter).isGenericDescriptor());\n>+  }\n>+\n>+  @Test\n>+  public void fromPropertyDescriptorShouldCreateValidObjectForDataDescriptor() {\n>+    NativeObject expected = new NativeObject();\n>+    expected.defineProperty(\"value\", Integer.valueOf(1), ScriptableObject.EMPTY);\n>+    expected.defineProperty(\"writable\", Boolean.TRUE, ScriptableObject.EMPTY);\n>+    expected.defineProperty(\"enumerable\", Boolean.TRUE, ScriptableObject.EMPTY);\n>+    expected.defineProperty(\"configurable\", Boolean.TRUE, ScriptableObject.EMPTY);\n>+\n>+    PropertyDescriptor desc = new PropertyDescriptor().value(1).writable(true).enumerable(true).configurable(true);\n>+    NativeObject actual = desc.fromPropertyDescriptor();\n>+\n>+    assertEquals(expected.entrySet(), actual.entrySet());\n>+  }\n>+\n>+  private static class StubCallable implements Callable {\n>+    public Object call(Context cx, Scriptable scope, Scriptable thisObj, Object[] args) {\n>+      return null;\n>+    }\n>+  }\n>+}Created attachment 379412\nupdated patch\n\n- replaced use of PropertyDescriptor with plain ScriptableObject\'s\n- made Object.keys and Object.getOwnPropertyNames return ids of type string, not number\n- changed error message for missing or wrong-typed arguments\n- changed Object constructor methods to throw type error if they do not receive enough argumentsThanks for the update!\n\nI tried applying the patch but ran into conflicts, I think because I have committed changes for one of your bug fixes. Can you sync to CVS head and send me a new patch? If you were at CVS head let me know and I\'ll investigate further on my end.I have it patched successfully now and it passed all regression tests. I\'ll review the code tomorrow.Comment on attachment 379412\nupdated patch\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index 39f4dd3..bdc0673 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -71,6 +71,20 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     @Override\n>+    protected void fillConstructorProperties(IdFunctionObject ctor)\n>+    {\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getPrototypeOf,\n>+                \"getPrototypeOf\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_keys,\n>+                \"keys\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyNames,\n>+                \"getOwnPropertyNames\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyDescriptor,\n>+                \"getOwnPropertyDescriptor\", 2);\n>+        super.fillConstructorProperties(ctor);\n>+    }\n>+\n>+    @Override\n>     protected void initPrototypeId(int id)\n>     {\n>         String s;\n>@@ -256,6 +270,66 @@ public class NativeObject extends IdScriptableObject\n>               }\n>               return Undefined.instance;\n> \n>+          case ConstructorId_getPrototypeOf:\n>+              {\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Scriptable obj = (Scriptable) arg;\n>+                return obj.getPrototype();\n>+              }\n>+          case ConstructorId_keys:\n>+              {\n\nHow about \n\nObject arg = args.length < 1 ? Undefined.instance : args[0];\n\nto replace through the declaration of \"Object arg\" below?\n\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Object[] ids = ((Scriptable) arg).getIds();\n>+                for (int i = 0; i < ids.length; i += 1) {\n\nJust use i++\n\n>+                  ids[i] = ScriptRuntime.toString(ids[i]);\n>+                }\n>+                return cx.newArray(scope, ids);\n>+              }\n>+          case ConstructorId_getOwnPropertyNames:\n>+              {\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Object[] ids = ((ScriptableObject) arg).getAllIds();\n>+                for (int i = 0; i < ids.length; i += 1) {\n>+                  ids[i] = ScriptRuntime.toString(ids[i]);\n>+                }\n>+                return cx.newArray(scope, ids);\n>+              }\n>+          case ConstructorId_getOwnPropertyDescriptor:\n>+              {\n>+                if (args.length < 2)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n\nThe second parameter can be any type as long as it can be converted to string, right? In fact, as an edge case, I think you could have a property named \"undefined\" that you could get the property descriptor for by calling Object.getOwnPropertyDescriptor(obj).\n\n>+\n>+                Object arg = args[0];\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+                ScriptableObject obj = (ScriptableObject) arg;\n>+                String name = ScriptRuntime.toString(args[1]);\n>+\n>+                Scriptable desc = obj.getOwnPropertyDescriptor(cx, name);\n>+                return desc == null ? Undefined.instance : desc;\n>+              }\n>+\n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>         }\n>@@ -303,6 +377,11 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     private static final int\n>+        ConstructorId_getPrototypeOf = -1,\n>+        ConstructorId_keys = -2,\n>+        ConstructorId_getOwnPropertyNames = -3,\n>+        ConstructorId_getOwnPropertyDescriptor = -4,\n>+\n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>         Id_toLocaleString        = 3,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 38bec1d..68f6e2f 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -202,6 +202,15 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>             }\n>         }\n> \n>+        ScriptableObject getPropertyDescriptor(Context cx, Scriptable parent) {\n\ns/parent/scope/. This is where the \"Object\" constructor is looked up.\n\n>+          ScriptableObject desc = (ScriptableObject) cx.newObject(parent);\n\nI steered you wrong before in suggesting you call this. The 8.10.4 #2 says \"Let obj be the result of creating a new object as if by the expression new Object() where Object is the standard built-in constructor with that name.\" This code would allow someone to intercept that call by redefining \"Object\" in the global scope. Instead you should use\n\n        ScriptableObject desc = new NativeObject();\n        ScriptRuntime.setObjectProtoAndParent(desc, scope);\n\n>+          if (value != null) desc.defineProperty(\"value\", value, EMPTY);\n>+          desc.defineProperty(\"writable\",     (attributes & READONLY) == 0, EMPTY);\n>+          desc.defineProperty(\"enumerable\",   (attributes & DONTENUM) == 0, EMPTY);\n>+          desc.defineProperty(\"configurable\", (attributes & PERMANENT) == 0, EMPTY);\n>+          return desc;\n>+        }\n>+\n>     }\n> \n>     private static final class GetterSlot extends Slot\n>@@ -215,6 +224,16 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         {\n>             super(name, indexOrHash, attributes);\n>         }\n>+\n>+        @Override\n>+        ScriptableObject getPropertyDescriptor(Context cx, Scriptable parent) {\n>+          ScriptableObject desc = super.getPropertyDescriptor(cx, parent);\n>+          desc.delete(\"value\");\n>+          desc.delete(\"writable\");\n>+          if (getter != null) desc.defineProperty(\"get\", getter, EMPTY);\n>+          if (setter != null) desc.defineProperty(\"set\", setter, EMPTY);\n>+          return desc;\n>+        }\n>     }\n> \n>     static void checkValidAttributes(int attributes)\n>@@ -2523,6 +2542,11 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>     }\n> \n>+    protected ScriptableObject getOwnPropertyDescriptor(Context cx, String name) {\n>+      Slot slot = getSlot(name, 0, SLOT_QUERY);\n>+      return (slot == null) ? null : slot.getPropertyDescriptor(cx, getParentScope());\n>+    }\n>+\n>     // Methods and classes to implement java.util.Map interface\n> \n>     public int size() {\n>diff --git a/src/org/mozilla/javascript/resources/Messages.properties b/src/org/mozilla/javascript/resources/Messages.properties\n>index a80e6a5..545dc87 100644\n>--- a/src/org/mozilla/javascript/resources/Messages.properties\n>+++ b/src/org/mozilla/javascript/resources/Messages.properties\n>@@ -260,6 +260,9 @@ msg.bad.regexp.compile =\\\n>     Only one argument may be specified if the first argument to \\\n>     RegExp.prototype.compile is a RegExp object.\n> \n>+msg.arg.not.object =\\\n>+    Expected argument of type object, but instead had type {0}\n>+\n> # Parser\n> msg.got.syntax.errors = \\\n>     Compilation produced {0} syntax errors.\n>diff --git a/testsrc/doctests/object.getownpropertydescriptor.doctest b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>new file mode 100644\n>index 0000000..8a2cb8a\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>@@ -0,0 +1,43 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getOwnPropertyDescriptor;\n>+function getOwnPropertyDescriptor() { [native code for Object.getOwnPropertyDescriptor, arity=2] }\n>+\n>+js> expectTypeError(function() { Object.getOwnPropertyDescriptor() })\n>+js> expectTypeError(function() { Object.getOwnPropertyDescriptor({}) })\n>+\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getOwnPropertyDescriptor(value, \'p\') }) \n>+  > })\n>+\n>+js> Object.getOwnPropertyDescriptor({}, \'p\') === undefined;\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({p:1}, \'p\');\n>+js> desc.value\n>+1\n>+js> desc.writable\n>+true\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({ get p() {}, set p() {} }, \'p\');\n>+js> desc.value === undefined;\n>+true\n>+js> desc.writable === undefined;\n>+true\n>+js> desc.get.toSource()\n>+(function () {})\n>+js> desc.set.toSource()\n>+(function () {})\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>+\n>+js> desc.__proto__ === Object.prototype\n>+true\n>+js> desc.__parent__;\n>+[object global]\n>diff --git a/testsrc/doctests/object.getownpropertynames.doctest b/testsrc/doctests/object.getownpropertynames.doctest\n>new file mode 100644\n>index 0000000..ddf91db\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertynames.doctest\n>@@ -0,0 +1,55 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getOwnPropertyNames;\n>+function getOwnPropertyNames() { [native code for Object.getOwnPropertyNames, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.getOwnPropertyNames() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getOwnPropertyNames(value) }) \n>+  > })\n>+\n>+js> Object.getOwnPropertyNames({}).toSource();\n>+[]\n>+js> Object.getOwnPropertyNames({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.getOwnPropertyNames({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.getOwnPropertyNames({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.getOwnPropertyNames([]).toSource();\n>+[\"length\"]\n>+js> Object.getOwnPropertyNames([\'a\', \'b\', \'c\']).toSource();\n>+[\"0\", \"1\", \"2\", \"length\"]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.getOwnPropertyNames({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>+\n>+js> var k = Object.getOwnPropertyNames({a:2, 5:6})\n>+js> typeof k[1]\n>+string\n>diff --git a/testsrc/doctests/object.getprototypeof.doctest b/testsrc/doctests/object.getprototypeof.doctest\n>new file mode 100644\n>index 0000000..5514e14\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getprototypeof.doctest\n>@@ -0,0 +1,23 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getPrototypeOf;\n>+function getPrototypeOf() { [native code for Object.getPrototypeOf, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.getPrototypeOf() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getPrototypeOf(value) }) \n>+  > })\n>+\n>+js> [(function(){}), [], {}].every(function(obj) {\n>+  >   return Object.getPrototypeOf(obj) === obj.__proto__;\n>+  > });\n>+true\n>+\n>+js> function UserDefined() {}\n>+js> [Date, UserDefined].every(function(type) {\n>+  >   var instance;\n>+  >   eval(\'instance = new \'+type.name);\n>+  >   return Object.getPrototypeOf(instance) === type.prototype;\n>+  > });\n>+true\n>+\n>diff --git a/testsrc/doctests/object.keys.doctest b/testsrc/doctests/object.keys.doctest\n>new file mode 100644\n>index 0000000..e9aef8e\n>--- /dev/null\n>+++ b/testsrc/doctests/object.keys.doctest\n>@@ -0,0 +1,55 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.keys;\n>+function keys() { [native code for Object.keys, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.keys() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.keys(value) }) \n>+  > })\n>+\n>+js> Object.keys({}).toSource();\n>+[]\n>+js> Object.keys({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.keys({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.keys({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.keys([]).toSource();\n>+[]\n>+js> Object.keys([\'a\', \'b\', \'c\']).toSource();\n>+[\"0\", \"1\", \"2\"]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.keys({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.keys({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.keys({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>+\n>+js> var k = Object.keys({ a:1, 3:2 });\n>+js> typeof k[1];\n>+string\n>diff --git a/testsrc/doctests/util.js b/testsrc/doctests/util.js\n>new file mode 100644\n>index 0000000..c17e4da\n>--- /dev/null\n>+++ b/testsrc/doctests/util.js\n>@@ -0,0 +1,8 @@\n>+function expectTypeError(code) {\n>+  try {\n>+    code();\n>+    throw (code.toSource() + \' should have thrown a TypeError\');\n>+  } catch (e if e instanceof TypeError) {\n>+    // all good\n>+  }\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/Evaluator.java b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>new file mode 100644\n>index 0000000..491c0e7\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>@@ -0,0 +1,30 @@\n>+package org.mozilla.javascript.tests;\n>+import org.mozilla.javascript.*;\n>+import java.util.Collections;\n>+import java.util.Map;\n>+\n>+public class Evaluator {\n>+\n>+  public static Object eval(String source) {\n>+    return eval(source, Collections.EMPTY_MAP);\n>+  }\n>+\n>+  public static Object eval(String source, String id, Scriptable object) {\n>+    return eval(source, Collections.singletonMap(id, object));\n>+  }\n>+\n>+  public static Object eval(String source, Map<String, Scriptable> bindings) {\n>+    Context cx = ContextFactory.getGlobal().enterContext();\n>+    try {\n>+      Scriptable scope = cx.initStandardObjects();\n>+      for (String id : bindings.keySet()) {\n>+        Scriptable object = bindings.get(id);\n>+        object.setParentScope(scope);\n>+        scope.put(id, scope, object);\n>+      }\n>+      return cx.evaluateString(scope, source, \"source\", 1, null);\n>+    } finally {\n>+      Context.exit();\n>+    }\n>+  }\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>new file mode 100644\n>index 0000000..9eaf7a9\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>@@ -0,0 +1,32 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyDescriptor(obj, prop) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyDescriptorTest {\n>+\n>+  @Test\n>+  public void testContentsOfPropertyDescriptorShouldReflectAttributesOfProperty() {\n>+    NativeObject descriptor;\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM | ScriptableObject.READONLY | ScriptableObject.PERMANENT);\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'a\')\", \"obj\", object);\n>+    assertEquals(\"1\",  descriptor.get(\"value\"));\n>+    assertEquals(true, descriptor.get(\"enumerable\"));\n>+    assertEquals(true, descriptor.get(\"writable\"));\n>+    assertEquals(true, descriptor.get(\"configurable\"));\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'b\')\", \"obj\", object);\n>+    assertEquals(\"2\",  descriptor.get(\"value\"));\n>+    assertEquals(false, descriptor.get(\"enumerable\"));\n>+    assertEquals(false, descriptor.get(\"writable\"));\n>+    assertEquals(false, descriptor.get(\"configurable\"));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>new file mode 100644\n>index 0000000..3ba1f9d\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>@@ -0,0 +1,27 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyNames(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyNamesTest {\n>+\n>+  @Test\n>+  public void testShouldReturnAllPropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.getOwnPropertyNames(obj)\", \"obj\", object);\n>+\n>+    NativeArray names = (NativeArray) result;\n>+\n>+    assertEquals(2, names.getLength());\n>+    assertEquals(\"a\", names.get(0, names));\n>+    assertEquals(\"b\", names.get(1, names));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>new file mode 100644\n>index 0000000..9584c9f\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>@@ -0,0 +1,28 @@\n>+/*\n>+ * Tests for the Object.keys(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectKeysTest {\n>+\n>+  @Test\n>+  public void shouldReturnOnlyEnumerablePropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"c\", \"3\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.keys(obj)\", \"obj\", object);\n>+\n>+    NativeArray keys = (NativeArray) result;\n>+\n>+    assertEquals(2, keys.getLength());\n>+    assertEquals(\"a\", keys.get(0, keys));\n>+    assertEquals(\"b\", keys.get(1, keys));\n>+  }\n>+\n>+}Comment on attachment 379412\nupdated patch\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index 39f4dd3..bdc0673 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -71,6 +71,20 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     @Override\n>+    protected void fillConstructorProperties(IdFunctionObject ctor)\n>+    {\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getPrototypeOf,\n>+                \"getPrototypeOf\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_keys,\n>+                \"keys\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyNames,\n>+                \"getOwnPropertyNames\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyDescriptor,\n>+                \"getOwnPropertyDescriptor\", 2);\n>+        super.fillConstructorProperties(ctor);\n>+    }\n>+\n>+    @Override\n>     protected void initPrototypeId(int id)\n>     {\n>         String s;\n>@@ -256,6 +270,66 @@ public class NativeObject extends IdScriptableObject\n>               }\n>               return Undefined.instance;\n> \n>+          case ConstructorId_getPrototypeOf:\n>+              {\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Scriptable obj = (Scriptable) arg;\n>+                return obj.getPrototype();\n>+              }\n>+          case ConstructorId_keys:\n>+              {\n\nHow about \n\nObject arg = args.length < 1 ? Undefined.instance : args[0];\n\nto replace through the declaration of \"Object arg\" below?\n\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof Scriptable) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Object[] ids = ((Scriptable) arg).getIds();\n>+                for (int i = 0; i < ids.length; i += 1) {\n\nJust use i++\n\n>+                  ids[i] = ScriptRuntime.toString(ids[i]);\n>+                }\n>+                return cx.newArray(scope, ids);\n>+              }\n>+          case ConstructorId_getOwnPropertyNames:\n>+              {\n>+                if (args.length < 1)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n>+\n>+                Object arg = args[0];\n>+\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+\n>+                Object[] ids = ((ScriptableObject) arg).getAllIds();\n>+                for (int i = 0; i < ids.length; i += 1) {\n>+                  ids[i] = ScriptRuntime.toString(ids[i]);\n>+                }\n>+                return cx.newArray(scope, ids);\n>+              }\n>+          case ConstructorId_getOwnPropertyDescriptor:\n>+              {\n>+                if (args.length < 2)\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(Undefined.instance));\n\nThe second parameter can be any type as long as it can be converted to string, right? In fact, as an edge case, I think you could have a property named \"undefined\" that you could get the property descriptor for by calling Object.getOwnPropertyDescriptor(obj).\n\n>+\n>+                Object arg = args[0];\n>+                if ( !(arg instanceof ScriptableObject) )\n>+                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+                ScriptableObject obj = (ScriptableObject) arg;\n>+                String name = ScriptRuntime.toString(args[1]);\n>+\n>+                Scriptable desc = obj.getOwnPropertyDescriptor(cx, name);\n>+                return desc == null ? Undefined.instance : desc;\n>+              }\n>+\n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>         }\n>@@ -303,6 +377,11 @@ public class NativeObject extends IdScriptableObject\n>     }\n> \n>     private static final int\n>+        ConstructorId_getPrototypeOf = -1,\n>+        ConstructorId_keys = -2,\n>+        ConstructorId_getOwnPropertyNames = -3,\n>+        ConstructorId_getOwnPropertyDescriptor = -4,\n>+\n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>         Id_toLocaleString        = 3,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 38bec1d..68f6e2f 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -202,6 +202,15 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>             }\n>         }\n> \n>+        ScriptableObject getPropertyDescriptor(Context cx, Scriptable parent) {\n\ns/parent/scope/. This is where the \"Object\" constructor is looked up.\n\n>+          ScriptableObject desc = (ScriptableObject) cx.newObject(parent);\n\nI steered you wrong before in suggesting you call this. The 8.10.4 #2 says \"Let obj be the result of creating a new object as if by the expression new Object() where Object is the standard built-in constructor with that name.\" This code would allow someone to intercept that call by redefining \"Object\" in the global scope. Instead you should use\n\n        ScriptableObject desc = new NativeObject();\n        ScriptRuntime.setObjectProtoAndParent(desc, scope);\n\n>+          if (value != null) desc.defineProperty(\"value\", value, EMPTY);\n>+          desc.defineProperty(\"writable\",     (attributes & READONLY) == 0, EMPTY);\n>+          desc.defineProperty(\"enumerable\",   (attributes & DONTENUM) == 0, EMPTY);\n>+          desc.defineProperty(\"configurable\", (attributes & PERMANENT) == 0, EMPTY);\n>+          return desc;\n>+        }\n>+\n>     }\n> \n>     private static final class GetterSlot extends Slot\n>@@ -215,6 +224,16 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         {\n>             super(name, indexOrHash, attributes);\n>         }\n>+\n>+        @Override\n>+        ScriptableObject getPropertyDescriptor(Context cx, Scriptable parent) {\n>+          ScriptableObject desc = super.getPropertyDescriptor(cx, parent);\n>+          desc.delete(\"value\");\n>+          desc.delete(\"writable\");\n>+          if (getter != null) desc.defineProperty(\"get\", getter, EMPTY);\n>+          if (setter != null) desc.defineProperty(\"set\", setter, EMPTY);\n>+          return desc;\n>+        }\n>     }\n> \n>     static void checkValidAttributes(int attributes)\n>@@ -2523,6 +2542,11 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>     }\n> \n>+    protected ScriptableObject getOwnPropertyDescriptor(Context cx, String name) {\n>+      Slot slot = getSlot(name, 0, SLOT_QUERY);\n>+      return (slot == null) ? null : slot.getPropertyDescriptor(cx, getParentScope());\n>+    }\n>+\n>     // Methods and classes to implement java.util.Map interface\n> \n>     public int size() {\n>diff --git a/src/org/mozilla/javascript/resources/Messages.properties b/src/org/mozilla/javascript/resources/Messages.properties\n>index a80e6a5..545dc87 100644\n>--- a/src/org/mozilla/javascript/resources/Messages.properties\n>+++ b/src/org/mozilla/javascript/resources/Messages.properties\n>@@ -260,6 +260,9 @@ msg.bad.regexp.compile =\\\n>     Only one argument may be specified if the first argument to \\\n>     RegExp.prototype.compile is a RegExp object.\n> \n>+msg.arg.not.object =\\\n>+    Expected argument of type object, but instead had type {0}\n>+\n> # Parser\n> msg.got.syntax.errors = \\\n>     Compilation produced {0} syntax errors.\n>diff --git a/testsrc/doctests/object.getownpropertydescriptor.doctest b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>new file mode 100644\n>index 0000000..8a2cb8a\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertydescriptor.doctest\n>@@ -0,0 +1,43 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getOwnPropertyDescriptor;\n>+function getOwnPropertyDescriptor() { [native code for Object.getOwnPropertyDescriptor, arity=2] }\n>+\n>+js> expectTypeError(function() { Object.getOwnPropertyDescriptor() })\n>+js> expectTypeError(function() { Object.getOwnPropertyDescriptor({}) })\n>+\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getOwnPropertyDescriptor(value, \'p\') }) \n>+  > })\n>+\n>+js> Object.getOwnPropertyDescriptor({}, \'p\') === undefined;\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({p:1}, \'p\');\n>+js> desc.value\n>+1\n>+js> desc.writable\n>+true\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>+\n>+js> var desc = Object.getOwnPropertyDescriptor({ get p() {}, set p() {} }, \'p\');\n>+js> desc.value === undefined;\n>+true\n>+js> desc.writable === undefined;\n>+true\n>+js> desc.get.toSource()\n>+(function () {})\n>+js> desc.set.toSource()\n>+(function () {})\n>+js> desc.enumerable\n>+true\n>+js> desc.configurable\n>+true\n>+\n>+js> desc.__proto__ === Object.prototype\n>+true\n>+js> desc.__parent__;\n>+[object global]\n>diff --git a/testsrc/doctests/object.getownpropertynames.doctest b/testsrc/doctests/object.getownpropertynames.doctest\n>new file mode 100644\n>index 0000000..ddf91db\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getownpropertynames.doctest\n>@@ -0,0 +1,55 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getOwnPropertyNames;\n>+function getOwnPropertyNames() { [native code for Object.getOwnPropertyNames, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.getOwnPropertyNames() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getOwnPropertyNames(value) }) \n>+  > })\n>+\n>+js> Object.getOwnPropertyNames({}).toSource();\n>+[]\n>+js> Object.getOwnPropertyNames({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.getOwnPropertyNames({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.getOwnPropertyNames({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.getOwnPropertyNames([]).toSource();\n>+[\"length\"]\n>+js> Object.getOwnPropertyNames([\'a\', \'b\', \'c\']).toSource();\n>+[\"0\", \"1\", \"2\", \"length\"]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.getOwnPropertyNames(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.getOwnPropertyNames({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.getOwnPropertyNames({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>+\n>+js> var k = Object.getOwnPropertyNames({a:2, 5:6})\n>+js> typeof k[1]\n>+string\n>diff --git a/testsrc/doctests/object.getprototypeof.doctest b/testsrc/doctests/object.getprototypeof.doctest\n>new file mode 100644\n>index 0000000..5514e14\n>--- /dev/null\n>+++ b/testsrc/doctests/object.getprototypeof.doctest\n>@@ -0,0 +1,23 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.getPrototypeOf;\n>+function getPrototypeOf() { [native code for Object.getPrototypeOf, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.getPrototypeOf() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.getPrototypeOf(value) }) \n>+  > })\n>+\n>+js> [(function(){}), [], {}].every(function(obj) {\n>+  >   return Object.getPrototypeOf(obj) === obj.__proto__;\n>+  > });\n>+true\n>+\n>+js> function UserDefined() {}\n>+js> [Date, UserDefined].every(function(type) {\n>+  >   var instance;\n>+  >   eval(\'instance = new \'+type.name);\n>+  >   return Object.getPrototypeOf(instance) === type.prototype;\n>+  > });\n>+true\n>+\n>diff --git a/testsrc/doctests/object.keys.doctest b/testsrc/doctests/object.keys.doctest\n>new file mode 100644\n>index 0000000..e9aef8e\n>--- /dev/null\n>+++ b/testsrc/doctests/object.keys.doctest\n>@@ -0,0 +1,55 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.keys;\n>+function keys() { [native code for Object.keys, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.keys() })\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.keys(value) }) \n>+  > })\n>+\n>+js> Object.keys({}).toSource();\n>+[]\n>+js> Object.keys({a:2}).toSource();\n>+[\"a\"]\n>+js> Object.keys({a:1, b:2}).toSource();\n>+[\"a\", \"b\"]\n>+js> Object.keys({\'a.b\':1, \'c d\':2}).toSource();\n>+[\"a.b\", \"c d\"]\n>+\n>+js> Object.keys([]).toSource();\n>+[]\n>+js> Object.keys([\'a\', \'b\', \'c\']).toSource();\n>+[\"0\", \"1\", \"2\"]\n>+\n>+js> function UserDefined() { this.a = 1; this.b = 2 };\n>+js> var obj = new UserDefined()\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> UserDefined.prototype.c = 3;\n>+3\n>+js> Object.keys(obj).toSource()\n>+[\"a\", \"b\"]\n>+\n>+js> // test properties of result are enumerable\n>+js> for (var p in Object.keys({a:2, b:3})) print(p)\n>+0\n>+1\n>+\n>+js> // test that properties of result are writable\n>+js> var k = Object.keys({a:2, b:3});\n>+js> k[1] = \'c\'; k.toSource();\n>+[\"a\", \"c\"]\n>+\n>+js> // test that properties of result are configurable\n>+js> var k = Object.keys({a:2, b:3})\n>+js> delete k[1];\n>+true\n>+js> k\n>+a,\n>+js> // TODO test that the attributes of the properties can be changed\n>+\n>+js> var k = Object.keys({ a:1, 3:2 });\n>+js> typeof k[1];\n>+string\n>diff --git a/testsrc/doctests/util.js b/testsrc/doctests/util.js\n>new file mode 100644\n>index 0000000..c17e4da\n>--- /dev/null\n>+++ b/testsrc/doctests/util.js\n>@@ -0,0 +1,8 @@\n>+function expectTypeError(code) {\n>+  try {\n>+    code();\n>+    throw (code.toSource() + \' should have thrown a TypeError\');\n>+  } catch (e if e instanceof TypeError) {\n>+    // all good\n>+  }\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/Evaluator.java b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>new file mode 100644\n>index 0000000..491c0e7\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/Evaluator.java\n>@@ -0,0 +1,30 @@\n>+package org.mozilla.javascript.tests;\n>+import org.mozilla.javascript.*;\n>+import java.util.Collections;\n>+import java.util.Map;\n>+\n>+public class Evaluator {\n>+\n>+  public static Object eval(String source) {\n>+    return eval(source, Collections.EMPTY_MAP);\n>+  }\n>+\n>+  public static Object eval(String source, String id, Scriptable object) {\n>+    return eval(source, Collections.singletonMap(id, object));\n>+  }\n>+\n>+  public static Object eval(String source, Map<String, Scriptable> bindings) {\n>+    Context cx = ContextFactory.getGlobal().enterContext();\n>+    try {\n>+      Scriptable scope = cx.initStandardObjects();\n>+      for (String id : bindings.keySet()) {\n>+        Scriptable object = bindings.get(id);\n>+        object.setParentScope(scope);\n>+        scope.put(id, scope, object);\n>+      }\n>+      return cx.evaluateString(scope, source, \"source\", 1, null);\n>+    } finally {\n>+      Context.exit();\n>+    }\n>+  }\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>new file mode 100644\n>index 0000000..9eaf7a9\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n>@@ -0,0 +1,32 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyDescriptor(obj, prop) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyDescriptorTest {\n>+\n>+  @Test\n>+  public void testContentsOfPropertyDescriptorShouldReflectAttributesOfProperty() {\n>+    NativeObject descriptor;\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM | ScriptableObject.READONLY | ScriptableObject.PERMANENT);\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'a\')\", \"obj\", object);\n>+    assertEquals(\"1\",  descriptor.get(\"value\"));\n>+    assertEquals(true, descriptor.get(\"enumerable\"));\n>+    assertEquals(true, descriptor.get(\"writable\"));\n>+    assertEquals(true, descriptor.get(\"configurable\"));\n>+\n>+    descriptor = (NativeObject) eval(\"Object.getOwnPropertyDescriptor(obj, \'b\')\", \"obj\", object);\n>+    assertEquals(\"2\",  descriptor.get(\"value\"));\n>+    assertEquals(false, descriptor.get(\"enumerable\"));\n>+    assertEquals(false, descriptor.get(\"writable\"));\n>+    assertEquals(false, descriptor.get(\"configurable\"));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>new file mode 100644\n>index 0000000..3ba1f9d\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n>@@ -0,0 +1,27 @@\n>+/*\n>+ * Tests for the Object.getOwnPropertyNames(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectGetOwnPropertyNamesTest {\n>+\n>+  @Test\n>+  public void testShouldReturnAllPropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.getOwnPropertyNames(obj)\", \"obj\", object);\n>+\n>+    NativeArray names = (NativeArray) result;\n>+\n>+    assertEquals(2, names.getLength());\n>+    assertEquals(\"a\", names.get(0, names));\n>+    assertEquals(\"b\", names.get(1, names));\n>+  }\n>+\n>+}\n>diff --git a/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>new file mode 100644\n>index 0000000..9584c9f\n>--- /dev/null\n>+++ b/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n>@@ -0,0 +1,28 @@\n>+/*\n>+ * Tests for the Object.keys(obj) method\n>+ */\n>+package org.mozilla.javascript.tests.es5;\n>+import org.mozilla.javascript.*;\n>+import static org.mozilla.javascript.tests.Evaluator.eval;\n>+import static org.junit.Assert.assertEquals;\n>+import org.junit.Test;\n>+\n>+public class ObjectKeysTest {\n>+\n>+  @Test\n>+  public void shouldReturnOnlyEnumerablePropertiesOfArg() {\n>+    NativeObject object = new NativeObject();\n>+    object.defineProperty(\"a\", \"1\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"b\", \"2\", ScriptableObject.EMPTY);\n>+    object.defineProperty(\"c\", \"3\", ScriptableObject.DONTENUM);\n>+\n>+    Object result = eval(\"Object.keys(obj)\", \"obj\", object);\n>+\n>+    NativeArray keys = (NativeArray) result;\n>+\n>+    assertEquals(2, keys.getLength());\n>+    assertEquals(\"a\", keys.get(0, keys));\n>+    assertEquals(\"b\", keys.get(1, keys));\n>+  }\n>+\n>+}Since the remaining edits were small, I made them myself and submitted:\n\nChecking in src/org/mozilla/javascript/NativeObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeObject.java,v  <--  NativeObject.java\nnew revision: 1.49; previous revision: 1.48\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.148; previous revision: 1.147\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.93; previous revision: 1.92\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.getownpropertydescriptor.doctest,v\ndone\nChecking in testsrc/doctests/object.getownpropertydescriptor.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.getownpropertydescriptor.doctest,v  <--  object.getownpropertydescriptor.doctest\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.getownpropertynames.doctest,v\ndone\nChecking in testsrc/doctests/object.getownpropertynames.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.getownpropertynames.doctest,v  <--  object.getownpropertynames.doctest\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.getprototypeof.doctest,v\ndone\nChecking in testsrc/doctests/object.getprototypeof.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.getprototypeof.doctest,v  <--  object.getprototypeof.doctest\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.keys.doctest,v\ndone\nChecking in testsrc/doctests/object.keys.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.keys.doctest,v  <--  object.keys.doctest\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/util.js,v\ndone\nChecking in testsrc/doctests/util.js;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/util.js,v  <--  util.js\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Evaluator.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Evaluator.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Evaluator.java,v  <--  Evaluator.java\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java,v  <--  ObjectGetOwnPropertyDescriptorTest.java\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java,v  <--  ObjectGetOwnPropertyNamesTest.java\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java,v  <--  ObjectKeysTest.java\ninitial revision: 1.1\ndoneCreated attachment 380047\nmakes junit run new tests\n\nSorry, I left this out of the previous patch. It just gets junit to execute the new test files which are currently under an es5 subpackage.Checking in testsrc/build.xml;\n/cvsroot/mozilla/js/rhino/testsrc/build.xml,v  <--  build.xml\nnew revision: 1.15; previous revision: 1.14\ndoneCreated attachment 380379\npatch for isExtensible, preventExtensions and defineProperty\n\nInitial implementation for isExtensible, preventExtensions and definePropertyCreated attachment 380698\nnew patch for isExtensible, preventExtensions and defineProperty\n\nThis is a slight revision of patch 380379 such that defineProperty now throws a TypeError when defining a new property on a non-extensible object, rather than just failing silently.Comment on attachment 380698\nnew patch for isExtensible, preventExtensions and defineProperty\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index 46cc101..b08aa68 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -81,6 +81,12 @@ public class NativeObject extends IdScriptableObject\n>                 \"getOwnPropertyNames\", 1);\n>         addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyDescriptor,\n>                 \"getOwnPropertyDescriptor\", 2);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_defineProperty,\n>+                \"defineProperty\", 3);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_isExtensible,\n>+                \"isExtensible\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_preventExtensions,\n>+                \"preventExtensions\", 1);\n>         super.fillConstructorProperties(ctor);\n>     }\n> \n>@@ -273,21 +279,14 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getPrototypeOf:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Scriptable obj = (Scriptable) arg;\n>+                Scriptable obj = ensureScriptable(arg);\n>                 return obj.getPrototype();\n>               }\n>           case ConstructorId_keys:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Object[] ids = ((Scriptable) arg).getIds();\n>+                Scriptable obj = ensureScriptable(arg);\n>+                Object[] ids = obj.getIds();\n>                 for (int i = 0; i < ids.length; i++) {\n>                   ids[i] = ScriptRuntime.toString(ids[i]);\n>                 }\n>@@ -296,11 +295,8 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getOwnPropertyNames:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Object[] ids = ((ScriptableObject) arg).getAllIds();\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                Object[] ids = obj.getAllIds();\n>                 for (int i = 0; i < ids.length; i++) {\n>                   ids[i] = ScriptRuntime.toString(ids[i]);\n>                 }\n>@@ -309,25 +305,56 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getOwnPropertyDescriptor:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof ScriptableObject)) {\n>                     // TODO(norris): There\'s a deeper issue here if\n>                     // arg instanceof Scriptable. Should we create a new\n>                     // interface to admit the new ECMAScript 5 operations?\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                ScriptableObject obj = (ScriptableObject) arg;\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>                 Object nameArg = args.length < 2 ? Undefined.instance : args[1];\n>                 String name = ScriptRuntime.toString(nameArg);\n>                 Scriptable desc = obj.getOwnPropertyDescriptor(cx, name);\n>                 return desc == null ? Undefined.instance : desc;\n>               }\n>+          case ConstructorId_defineProperty:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                Object nameArg = args.length < 2 ? Undefined.instance : args[1];\n>+                String name = ScriptRuntime.toString(nameArg);\n>+                Object descArg = args.length < 3 ? Undefined.instance : args[2];\n>+                ScriptableObject desc = ensureScriptableObject(descArg);\n>+                obj.defineOwnProperty(name, desc);\n>+                return obj;\n>+              }\n>+          case ConstructorId_isExtensible:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                return obj.isExtensible();\n>+              }\n>+          case ConstructorId_preventExtensions:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                obj.preventExtensions();\n>+                return obj;\n>+              }\n> \n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>         }\n>     }\n> \n>+    private Scriptable ensureScriptable(Object arg) {\n>+      if ( !(arg instanceof Scriptable) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (Scriptable) arg;\n>+    }\n\nAdd 1 line between\n\n>+    private ScriptableObject ensureScriptableObject(Object arg) {\n>+      if ( !(arg instanceof ScriptableObject) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (ScriptableObject) arg;\n>+    }\n>+\n> // #string_id_map#\n> \n>     @Override\n>@@ -374,6 +401,9 @@ public class NativeObject extends IdScriptableObject\n>         ConstructorId_keys = -2,\n>         ConstructorId_getOwnPropertyNames = -3,\n>         ConstructorId_getOwnPropertyDescriptor = -4,\n>+        ConstructorId_defineProperty = -5,\n>+        ConstructorId_isExtensible = -6,\n>+        ConstructorId_preventExtensions = -7,\n> \n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 87984f0..2044eb8 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -154,6 +154,9 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>     private static final int SLOT_REMOVE = 3;\n>     private static final int SLOT_MODIFY_GETTER_SETTER = 4;\n>     private static final int SLOT_MODIFY_CONST = 5;\n>+    private static final int SLOT_CONVERT_ACCESSOR_TO_DATA = 6;\n>+\n>+    private boolean isExtensible = true;\n\nIn the current Rhino, \"sealed\" is pretty much equivalent to !extensible in es5. I don\'t think it makes sense to have both concepts running around independently, especially since now there\'s a new \"sealed\" in es5 that means something different!\n\nThinking about it, go ahead and add this boolean and I\'ll think about how to handle this change in the most backwards compatible way.\n\n> \n>     private static class Slot implements Serializable\n>     {\n>@@ -574,13 +577,30 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>     public void setGetterOrSetter(String name, int index,\n>                                   Callable getterOrSetter, boolean isSetter)\n>     {\n>+        setGetterOrSetter(name, index, getterOrSetter, isSetter, false);\n>+    }\n>+\n>+    private void setGetterOrSetter(String name, int index, Callable getterOrSetter, boolean isSetter, boolean force)\n>+    {\n>         if (name != null && index != 0)\n>             throw new IllegalArgumentException(name);\n> \n>+        if (!force) {\n>         checkNotSealed(name, index);\n>-        GetterSlot gslot = (GetterSlot)getSlot(name, index,\n>-                                               SLOT_MODIFY_GETTER_SETTER);\n>+        }\n>+\n>+        final GetterSlot gslot;\n>+        if (isExtensible()) {\n>+          gslot = (GetterSlot)getSlot(name, index, SLOT_MODIFY_GETTER_SETTER);\n>+        } else {\n>+          gslot = (GetterSlot)getSlot(name, index, SLOT_QUERY);\n>+          if (gslot == null)\n>+            return;\n>+        }\n>+        \n>+        if (!force) {\n>         gslot.checkNotReadonly();\n>+        }\n>         if (isSetter) {\n>             gslot.setter = getterOrSetter;\n>         } else {\n>@@ -1476,6 +1496,117 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         gslot.setter = setterBox;\n>     }\n> \n>+    public void defineOwnProperty(String name, ScriptableObject desc) {\n\nAdd javadoc, at least with reference to ES5 spec section.\n\n>+      Slot slot = getSlot(name, 0, SLOT_QUERY);\n>+      final int attributes;\n>+\n>+      if (slot == null) { // new slot\n>+        if (!isExtensible()) throw ScriptRuntime.typeError(\"msg.not.extensible\");\n>+        slot = getSlot(name, 0, SLOT_MODIFY);\n>+        attributes = applyDescriptorToAttributeBitset(DONTENUM|READONLY|PERMANENT, desc);\n>+      } else {\n>+        checkLegalPropertyRedefinition(name, desc);\n>+        attributes = applyDescriptorToAttributeBitset(getAttributes(name), desc);\n>+      }\n>+\n>+      defineOwnProperty(slot, desc, attributes);\n>+    }\n>+\n>+    private void defineOwnProperty(Slot slot, ScriptableObject desc, int attributes) {\n>+      if (isAccessorDescriptor(desc)) {\n>+        if ( !(slot instanceof GetterSlot) ) \n>+          slot = getSlot(slot.name, 0, SLOT_MODIFY_GETTER_SETTER);\n>+\n>+        Object getter = desc.get(\"get\");\n>+        Object setter = desc.get(\"set\");\n>+\n>+        if (getter != null && !(getter instanceof Callable) ) {\n\nIf not found, get() returns NOT_FOUND, not null (since null is a valid value).\n\n>+          throw ScriptRuntime.notFunctionError(getter);\n>+        }\n>+        if (setter != null && !(setter instanceof Callable) ) {\n>+          throw ScriptRuntime.notFunctionError(setter);\n>+        }\n>+\n>+        defineOwnAccessorProperty( (GetterSlot) slot, (Callable) getter, (Callable) setter, attributes);\n>+      } else  {\n>+        if (slot instanceof GetterSlot && isDataDescriptor(desc)) {\n>+          slot = getSlot(slot.name, 0, SLOT_CONVERT_ACCESSOR_TO_DATA);\n>+        }\n>+        defineOwnDataProperty(slot, desc.get(\"value\"), attributes);\n>+      }\n>+    }\n>+\n>+    private void defineOwnDataProperty(Slot slot, Object value, int attributes) {\n>+      if (value != null) {\n>+        slot.value = value;\n>+      }\n>+      slot.setAttributes(attributes);\n>+    }\n>+\n>+    private void defineOwnAccessorProperty(GetterSlot slot, Callable getter, Callable setter, int attributes) {\n>+      if (getter != null) {\n>+        slot.getter = getter;\n>+      } if (setter != null) {\n>+        slot.setter = setter;\n>+      }\n>+      slot.value = Undefined.instance;\n>+      slot.setAttributes(attributes);\n>+    }\n>+\n>+    private void checkLegalPropertyRedefinition(String name, ScriptableObject desc) {\n>+      ScriptableObject current = getOwnPropertyDescriptor(Context.getContext(), name);\n>+      if (Boolean.FALSE.equals(current.get(\"configurable\"))) {\n\nFrom reading 8.10.5, a couple of changes are needed:\n* [[Get]] is not equivalent to ScriptableObject.get. [[Get]] will look in the prototype chain if need be, and will call getters if need be. I think getProperty will do what is needed here, but double check that getters are honored. There are other places in this patch that need to use a method other than get() as well.\n* Step 4b specifies that ToBoolean is called. So use ScriptRuntime.toBoolean rather than comparing with Boolean.FALSE.\n\nThis is as far as I got tonight, but it\'ll give you something to work on.\n\n>+\n>+        if (Boolean.TRUE.equals(desc.get(\"configurable\"))) \n>+          throw ScriptRuntime.typeError1(\"msg.change.configurable.false.to.true\", name);\n>+        if (desc.has(\"enumerable\", desc) && !current.get(\"enumerable\").equals(desc.get(\"enumerable\")))\n>+          throw ScriptRuntime.typeError1(\"msg.change.enumerable.with.configurable.false\", name);\n>+\n>+        if (isGenericDescriptor(desc)) {\n>+          // no further validation required\n>+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n>+          if (Boolean.FALSE.equals(current.get(\"writable\"))) {\n>+            if (Boolean.TRUE.equals(desc.get(\"writable\")))\n>+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n>+\n>+            if (desc.has(\"value\", desc) && !ScriptRuntime.shallowEq(current.get(\"value\"), desc.get(\"value\"))) \n>+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n>+          }\n>+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n>+          if (desc.has(\"set\", desc) && !ScriptRuntime.shallowEq(current.get(\"set\"), desc.get(\"set\")))\n>+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n>+\n>+          if (desc.has(\"get\", desc) && !ScriptRuntime.shallowEq(current.get(\"get\"), desc.get(\"get\"))) \n>+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n>+        } else {\n>+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n>+        }\n>+      }\n>+    }\n>+\n>+    private int applyDescriptorToAttributeBitset(int attributes, ScriptableObject desc) {\n>+      Boolean enumerable = (Boolean) desc.get(\"enumerable\");\n>+      if (enumerable != null) attributes = (enumerable ? attributes & ~DONTENUM : attributes | DONTENUM);\n>+\n>+      Boolean writable = (Boolean) desc.get(\"writable\");\n>+      if (writable != null) attributes = (writable ? attributes & ~READONLY : attributes | READONLY);\n>+\n>+      Boolean configurable = (Boolean) desc.get(\"configurable\");\n>+      if (configurable != null) attributes = (configurable ? attributes & ~PERMANENT : attributes | PERMANENT);\n>+\n>+      return attributes;\n>+    }\n>+\n>+    private boolean isDataDescriptor(ScriptableObject desc) {\n>+      return desc.has(\"value\", desc) || desc.has(\"writable\", desc);\n>+    }\n>+    private boolean isAccessorDescriptor(ScriptableObject desc) {\n>+      return desc.has(\"get\", desc) || desc.has(\"set\", desc);\n>+    }\n>+    private boolean isGenericDescriptor(ScriptableObject desc) {\n>+      return !isDataDescriptor(desc) && !isAccessorDescriptor(desc);\n>+    }\n>+\n>     /**\n>      * Search for names in a class, adding the resulting methods\n>      * as properties.\n>@@ -1576,6 +1707,14 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>     }\n> \n>+    public boolean isExtensible() {\n>+      return isExtensible;\n>+    }\n>+\n>+    public void preventExtensions() {\n>+      isExtensible = false;\n>+    }\n>+\n>     /**\n>      * Seal this object.\n>      *\n>@@ -2082,6 +2221,11 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>             if (slot == null) {\n>                 return false;\n>             }\n>+        } else if (!isExtensible()) {\n>+            slot = getSlot(name, index, SLOT_QUERY);\n>+            if (slot == null) {\n>+                return true;\n>+            }\n>         } else {\n>             checkNotSealed(name, index);\n>             // either const hoisted declaration or initialization\n>@@ -2188,6 +2332,10 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                 !(slot instanceof GetterSlot))\n>                 break lastAccessCheck;\n> \n>+            if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA &&\n>+                (slot instanceof GetterSlot))\n>+                break lastAccessCheck;\n>+\n>             return slot;\n>         }\n> \n>@@ -2206,7 +2354,8 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         if (accessType == SLOT_QUERY ||\n>             accessType == SLOT_MODIFY ||\n>             accessType == SLOT_MODIFY_CONST ||\n>-            accessType == SLOT_MODIFY_GETTER_SETTER)\n>+            accessType == SLOT_MODIFY_GETTER_SETTER ||\n>+            accessType == SLOT_CONVERT_ACCESSOR_TO_DATA)\n>         {\n>             // Check the hashtable without using synchronization\n> \n>@@ -2249,6 +2398,9 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                 } else if (accessType == SLOT_MODIFY_CONST) {\n>                     if (slot != null)\n>                         return slot;\n>+                } else if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA) {\n>+                    if ( !(slot instanceof GetterSlot) )\n>+                        return slot;\n>                 }\n>             }\n> \n>@@ -2288,11 +2440,19 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                         // implementation it is harmless with the only\n>                         // complication is the need to replace the added slot\n>                         // if we need GetterSlot and the old one is not.\n>-                        if (accessType == SLOT_MODIFY_GETTER_SETTER &&\n>-                            !(slot instanceof GetterSlot))\n>-                        {\n>-                            GetterSlot newSlot = new GetterSlot(name,\n>-                                    indexOrHash, slot.getAttributes());\n>+\n>+                        Slot newSlot;\n>+\n>+                        if (accessType == SLOT_MODIFY_GETTER_SETTER && !(slot instanceof GetterSlot)) {\n>+                            newSlot = new GetterSlot(name, indexOrHash, slot.getAttributes());\n>+                        } else if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA && (slot instanceof GetterSlot)) {\n>+                            newSlot = new Slot(name, indexOrHash, slot.getAttributes());\n>+                        } else if (accessType == SLOT_MODIFY_CONST) {\n>+                          return null;\n>+                        } else {\n>+                          return slot;\n>+                        }\n>+\n>                             newSlot.value = slot.value;\n>                             newSlot.next = slot.next;\n>                             // add new slot to linked list\n>@@ -2314,13 +2474,8 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                             if (slot == lastAccess) {\n>                                 lastAccess = REMOVED;\n>                             }\n>-                            slot = newSlot;\n>-                        } else if (accessType == SLOT_MODIFY_CONST) {\n>-                            return null;\n>-                        }\n>-                        return slot;\n>-                    }\n>-\n>+                        return newSlot;\n>+                    } else {\n>                     // Check if the table is not too full before inserting.\n>                     if (4 * (count + 1) > 3 * slotsLocalRef.length) {\n>                         slotsLocalRef = new Slot[slotsLocalRef.length * 2 + 1];\n>@@ -2330,7 +2485,7 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                                 indexOrHash);\n>                     }\n>                 }\n>-\n>+                }\n>                 Slot newSlot = (accessType == SLOT_MODIFY_GETTER_SETTER\n>                                 ? new GetterSlot(name, indexOrHash, 0)\n>                                 : new Slot(name, indexOrHash, 0));\n>diff --git a/src/org/mozilla/javascript/resources/Messages.properties b/src/org/mozilla/javascript/resources/Messages.properties\n>index 545dc87..6ad9097 100644\n>--- a/src/org/mozilla/javascript/resources/Messages.properties\n>+++ b/src/org/mozilla/javascript/resources/Messages.properties\n>@@ -667,6 +667,32 @@ msg.modify.sealed =\\\n> msg.modify.readonly =\\\n>     Cannot modify readonly property: {0}.\n> \n>+msg.change.configurable.false.to.true =\\\n>+    Cannot change the configurable attribute of \"{0}\" from false to true.\n>+\n>+msg.change.enumerable.with.configurable.false =\\\n>+    Cannot change the enumerable attribute of \"{0}\" because configurable is false.\n>+\n>+msg.change.writable.false.to.true.with.configurable.false =\\\n>+    Cannot change the writable attribute of \"{0}\" from false to true because configurable is false.\n>+\n>+# TODO should we be using msg.modify.readonly here instead?\n>+msg.change.value.with.writable.false =\\\n>+    Cannot change the value of attribute \"{0}\" because writable is false.\n>+\n>+msg.change.getter.with.configurable.false =\\\n>+    Cannot change the get attribute of \"{0}\" because configurable is false.\n>+\n>+msg.change.setter.with.configurable.false =\\\n>+    Cannot change the set attribute of \"{0}\" because configurable is false.\n>+\n>+# TODO not sure about how descriptive this message is\n>+msg.change.descriptor.type.with.configurable.false =\\\n>+    Cannot change type of property \"{0}\" because configurable is false.\n>+\n>+msg.not.extensible =\\\n>+    Cannot add properties to this object because extensible is false.\n>+\n> # TokenStream\n> msg.missing.exponent =\\\n>     missing exponent\n>diff --git a/testsrc/doctests/480758.doctest b/testsrc/doctests/480758.doctest\n>index 675483a..3893400 100755\n>diff --git a/testsrc/doctests/object.defineproperty.doctest b/testsrc/doctests/object.defineproperty.doctest\n>new file mode 100644\n>index 0000000..e40e972\n>--- /dev/null\n>+++ b/testsrc/doctests/object.defineproperty.doctest\n>@@ -0,0 +1,169 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.defineProperty\n>+function defineProperty() { [native code for Object.defineProperty, arity=3] }\n>+\n>+js> expectTypeError(function() { Object.defineProperty() });\n>+js> expectTypeError(function() { Object.defineProperty({}) });\n>+js> expectTypeError(function() { Object.defineProperty({}, \'p\') });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.defineProperty(value, \'p\', {}) }) \n>+  > })\n>+\n>+js> Object.defineProperty({}, \'p\', {value:1}).p\n>+1\n>+js> var obj = {}\n>+js> Object.defineProperty(obj, \'a\', {\n>+  >   value: 1,\n>+  >   enumerable: false,\n>+  >   writable: false,\n>+  >   configurable: false\n>+  > })  \n>+[object Object]\n>+js> for (var p in obj) print(p); // check it has no enumerable properties\n>+js> obj.a = 2; obj.a; // check that the property is not writable\n>+1\n>+js> delete obj.a; obj.a // check that the property is not deletable\n>+1\n>+\n>+js> var define = Object.defineProperty;\n>+js> var describe = Object.getOwnPropertyDescriptor;\n>+\n>+js> // when define new property with empty descriptor then default values are used for the descriptor\n>+js> var obj = define({}, \'a\', {});\n>+js> describe(obj, \'a\').toSource()\n>+({writable:false, enumerable:false, configurable:false})\n>+\n>+js> // when define new property with data descriptor then those values are used for the descriptor\n>+js> var obj = define({}, \'a\', { value: 2, writable: true });\n>+js> var {value:v, writable:w} = describe(obj, \'a\'); [v, w].toSource();\n>+[2, true]\n>+js> obj.a\n>+2\n>+\n>+js> // when define new property with accessor descriptor then those values are used for the descriptor\n>+js> var obj = define({}, \'a\', { get: function() { return 3; }, set: function(value) {} });\n>+js> var {get:g, set:s} = describe(obj, \'a\'); [g, s].toSource();\n>+[(function () {return 3;}), (function (value) {})]\n>+js> obj.a\n>+3\n>+\n>+js> // when define existing property with empty descriptor then descriptor is left unchanged\n>+js> var descriptor = {value:1, writable:true, enumerable:true, configurable:true};\n>+js> var obj = define({},  \'a\', descriptor);\n>+js> var obj = define(obj, \'a\', {});\n>+js> describe(obj, \'a\').toSource()\n>+({value:1, writable:true, enumerable:true, configurable:true})\n>+\n>+js> // when define existing property with same descriptor then descriptor is left unchanged\n>+js> var descriptor = {value:1, writable:true, enumerable:true, configurable:true};\n>+js> var obj = define({},  \'a\', descriptor);\n>+js> var obj = define(obj, \'a\', descriptor);\n>+js> describe(obj, \'a\').toSource()\n>+({value:1, writable:true, enumerable:true, configurable:true})\n>+\n>+js> // may not change configurable from false to true\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {configurable : false});\n>+  >   define(obj, \'a\',          {configurable : true});\n>+  > });\n>+\n>+js> // may not change enumerable when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {enumerable : true, configurable:false});\n>+  >   define(obj, \'a\',          {enumerable : false});\n>+  > });\n>+\n>+js> // may not change writable from false to true when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {writable : false, configurable: false});\n>+  >   define(obj, \'a\',          {writable : true});\n>+  > });\n>+\n>+js> // may not change value when writable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {value : 1, writable:false});\n>+  >   define(obj, \'a\',          {value : 2});\n>+  > });\n>+\n>+js> // may not change getter when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {get: function() { return 1 }, configurable:false});\n>+  >   define(obj, \'a\',          {get: function() { return 1 }});\n>+  > });\n>+\n>+js> // may not change setter when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {set: function(val) {}, configurable:false});\n>+  >   define(obj, \'a\',          {set: function(val) {}});\n>+  > });\n>+\n>+js> // may not change from data property to accessor property when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {value : 1, configurable:false});\n>+  >   define(obj, \'a\',          {get   : function() { return 1 }});\n>+  > });\n>+\n>+js> // may not change from accessor property to data property when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {get   : function() { return 1 }, configurable:false});\n>+  >   define(obj, \'a\',          {value : 1});\n>+  > });\n>+\n>+js> // can change writable from true to false when configurable is false\n>+js> var obj = define({},  \'a\', {writable:true, configurable:false});\n>+js> var obj = define(obj, \'a\', {writable:false});\n>+\n>+js> // can set enumerable to the same value when configuable is false\n>+js> var obj = define({},  \'a\', {enumerable:true, configurable:false});\n>+js> var obj = define(obj, \'a\', {enumerable:true});\n>+\n>+js> // can change from data property to accessor property when configurable is true\n>+js> var obj = define({},  \'a\', {value : 1, configurable: true});\n>+js> var obj = define(obj, \'a\', {get   : function() { return 4 }});\n>+js> obj.a\n>+4\n>+js> describe(obj, \'a\').toSource()\n>+({enumerable:false, configurable:true, get:(function () {return 4;})})\n>+\n>+js> // can change from accessor property to data property when configurable is true\n>+js> var obj = define({},  \'a\', {get   : function() { return 2 }, configurable:true});\n>+js> var obj = define(obj, \'a\', {value : 5});\n>+js> obj.a\n>+5\n>+js> describe(obj, \'a\').toSource()\n>+({value:5, writable:false, enumerable:false, configurable:true})\n>+\n>+js> // can change enumerable and writable to true when configurable is true\n>+js> var obj = define({},  \'a\', {writable : false, enumerable : false, configurable:true});\n>+js> var obj = define(obj, \'a\', {writable : true,  enumerable : true, configurable:true});\n>+\n>+js> // can change the value if writable is true\n>+js> var obj = define({},  \'a\', {value:6, writable:true})\n>+js> obj.a\n>+6\n>+js> var obj = define(obj, \'a\', {value:7})\n>+js> obj.a\n>+7\n>+\n>+js> // defining a new property should fail loudly when object is not extensible\n>+js> var obj = Object.preventExtensions({});\n>+js> expectTypeError(function() { define(obj, \'a\', {value:1}) })\n>+\n>+js> // defining new property should succeed when object is extensible\n>+js> var obj = {}\n>+js> Object.isExtensible(obj);\n>+true\n>+js> obj.a = 8; obj.a\n>+8\n>+\n>+js> // changing existing property should succeed when object is not extensible\n>+js> var obj = define({},  \'a\', {value:1, writable:true});\n>+js> var obj = Object.preventExtensions(obj);\n>+js> obj.a = 9; obj.a\n>+9\n>+\n>+js> // defined getters and setters must be functions\n>+js> expectTypeError(function() { define({}, \'a\', {get:1}); })\n>+js> expectTypeError(function() { define({}, \'a\', {set:1}); })\n>+\n>diff --git a/testsrc/doctests/object.extensible.doctest b/testsrc/doctests/object.extensible.doctest\n>new file mode 100644\n>index 0000000..841511d\n>--- /dev/null\n>+++ b/testsrc/doctests/object.extensible.doctest\n>@@ -0,0 +1,30 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.isExtensible;\n>+function isExtensible() { [native code for Object.isExtensible, arity=1] }\n>+js> expectTypeError(function() { Object.isExtensible() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.isExtensible(value) }) \n>+  > })\n>+\n>+js> Object.preventExtensions;\n>+function preventExtensions() { [native code for Object.preventExtensions, arity=1] }\n>+js> expectTypeError(function() { Object.preventExtensions() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.preventExtensions(value) }) \n>+  > })\n>+\n>+js> var x = {};\n>+js> Object.isExtensible(x);\n>+true\n>+js> var y = Object.preventExtensions(x);\n>+js> y === x;\n>+true\n>+js> Object.isExtensible(x);\n>+false\n>+\n>+js> x.a = 1; x.a\n>+js>\n>+\n>+js> x.__defineGetter__(\'b\', function() { return 1 }); x.b\n>+js>Created attachment 381099\nupdates from comment 14 (https://bugzilla.mozilla.org/show_bug.cgi?id=489329#c14)\n\n- added line between methods\n- Added javadoc for ScriptableObject#defineOwnProperty\n- replaced use of `get` with `getProperty` and `has` with `hasProperty` when dealing with property descriptors\n- called ScriptRuntime.toBoolean on the boolean properties of any property descriptors passed inComment on attachment 381099\nupdates from comment 14 (https://bugzilla.mozilla.org/show_bug.cgi?id=489329#c14)\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index 46cc101..f9f3bdd 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -81,6 +81,12 @@ public class NativeObject extends IdScriptableObject\n>                 \"getOwnPropertyNames\", 1);\n>         addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_getOwnPropertyDescriptor,\n>                 \"getOwnPropertyDescriptor\", 2);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_defineProperty,\n>+                \"defineProperty\", 3);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_isExtensible,\n>+                \"isExtensible\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_preventExtensions,\n>+                \"preventExtensions\", 1);\n>         super.fillConstructorProperties(ctor);\n>     }\n> \n>@@ -273,21 +279,14 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getPrototypeOf:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Scriptable obj = (Scriptable) arg;\n>+                Scriptable obj = ensureScriptable(arg);\n>                 return obj.getPrototype();\n>               }\n>           case ConstructorId_keys:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Object[] ids = ((Scriptable) arg).getIds();\n>+                Scriptable obj = ensureScriptable(arg);\n>+                Object[] ids = obj.getIds();\n>                 for (int i = 0; i < ids.length; i++) {\n>                   ids[i] = ScriptRuntime.toString(ids[i]);\n>                 }\n>@@ -296,11 +295,8 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getOwnPropertyNames:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof Scriptable)) {\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                Object[] ids = ((ScriptableObject) arg).getAllIds();\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                Object[] ids = obj.getAllIds();\n>                 for (int i = 0; i < ids.length; i++) {\n>                   ids[i] = ScriptRuntime.toString(ids[i]);\n>                 }\n>@@ -309,25 +305,57 @@ public class NativeObject extends IdScriptableObject\n>           case ConstructorId_getOwnPropertyDescriptor:\n>               {\n>                 Object arg = args.length < 1 ? Undefined.instance : args[0];\n>-                if (!(arg instanceof ScriptableObject)) {\n>-                    // TODO(norris): There\'s a deeper issue here if\n>-                    // arg instanceof Scriptable. Should we create a new\n>-                    // interface to admit the new ECMAScript 5 operations?\n>-                    throw ScriptRuntime.typeError1(\"msg.arg.not.object\",\n>-                                                   ScriptRuntime.typeof(arg));\n>-                }\n>-                ScriptableObject obj = (ScriptableObject) arg;\n>+                // TODO(norris): There\'s a deeper issue here if\n>+                // arg instanceof Scriptable. Should we create a new\n>+                // interface to admit the new ECMAScript 5 operations?\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>                 Object nameArg = args.length < 2 ? Undefined.instance : args[1];\n>                 String name = ScriptRuntime.toString(nameArg);\n>                 Scriptable desc = obj.getOwnPropertyDescriptor(cx, name);\n>                 return desc == null ? Undefined.instance : desc;\n>               }\n>+          case ConstructorId_defineProperty:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                Object nameArg = args.length < 2 ? Undefined.instance : args[1];\n>+                String name = ScriptRuntime.toString(nameArg);\n>+                Object descArg = args.length < 3 ? Undefined.instance : args[2];\n>+                ScriptableObject desc = ensureScriptableObject(descArg);\n>+                obj.defineOwnProperty(name, desc);\n>+                return obj;\n>+              }\n>+          case ConstructorId_isExtensible:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                return obj.isExtensible();\n>+              }\n>+          case ConstructorId_preventExtensions:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                obj.preventExtensions();\n>+                return obj;\n>+              }\n> \n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>         }\n>     }\n> \n>+    private Scriptable ensureScriptable(Object arg) {\n>+      if ( !(arg instanceof Scriptable) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (Scriptable) arg;\n>+    }\n>+\n>+    private ScriptableObject ensureScriptableObject(Object arg) {\n>+      if ( !(arg instanceof ScriptableObject) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (ScriptableObject) arg;\n>+    }\n>+\n> // #string_id_map#\n> \n>     @Override\n>@@ -374,6 +402,9 @@ public class NativeObject extends IdScriptableObject\n>         ConstructorId_keys = -2,\n>         ConstructorId_getOwnPropertyNames = -3,\n>         ConstructorId_getOwnPropertyDescriptor = -4,\n>+        ConstructorId_defineProperty = -5,\n>+        ConstructorId_isExtensible = -6,\n>+        ConstructorId_preventExtensions = -7,\n> \n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 87984f0..a4146d0 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -154,6 +154,9 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>     private static final int SLOT_REMOVE = 3;\n>     private static final int SLOT_MODIFY_GETTER_SETTER = 4;\n>     private static final int SLOT_MODIFY_CONST = 5;\n>+    private static final int SLOT_CONVERT_ACCESSOR_TO_DATA = 6;\n>+\n>+    private boolean isExtensible = true;\n> \n>     private static class Slot implements Serializable\n>     {\n>@@ -574,13 +577,30 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>     public void setGetterOrSetter(String name, int index,\n>                                   Callable getterOrSetter, boolean isSetter)\n>     {\n>+        setGetterOrSetter(name, index, getterOrSetter, isSetter, false);\n>+    }\n>+\n>+    private void setGetterOrSetter(String name, int index, Callable getterOrSetter, boolean isSetter, boolean force)\n>+    {\n>         if (name != null && index != 0)\n>             throw new IllegalArgumentException(name);\n> \n>-        checkNotSealed(name, index);\n>-        GetterSlot gslot = (GetterSlot)getSlot(name, index,\n>-                                               SLOT_MODIFY_GETTER_SETTER);\n>-        gslot.checkNotReadonly();\n>+        if (!force) {\n>+          checkNotSealed(name, index);\n>+        }\n>+\n>+        final GetterSlot gslot;\n>+        if (isExtensible()) {\n>+          gslot = (GetterSlot)getSlot(name, index, SLOT_MODIFY_GETTER_SETTER);\n>+        } else {\n>+          gslot = (GetterSlot)getSlot(name, index, SLOT_QUERY);\n>+          if (gslot == null)\n>+            return;\n>+        }\n>+        \n>+        if (!force) {\n>+          gslot.checkNotReadonly();\n>+        }\n>         if (isSetter) {\n>             gslot.setter = getterOrSetter;\n>         } else {\n>@@ -588,7 +608,7 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>         gslot.value = Undefined.instance;\n>     }\n>-    \n>+\n>     /**\n>      * Get the getter or setter for a given property. Used by __lookupGetter__\n>      * and __lookupSetter__.\n>@@ -1477,6 +1497,130 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>     }\n> \n>     /**\n>+     * Defines a property on an object\n>+     *\n>+     * Based on [[DefineOwnProperty]] from 8.12.10 of the spec\n>+     *\n>+     * @param name the name of the property\n>+     * @param desc the new property descriptor, as described in 8.6.1\n>+     */\n>+    public void defineOwnProperty(String name, ScriptableObject desc) {\n>+      Slot slot = getSlot(name, 0, SLOT_QUERY);\n>+      final int attributes;\n>+\n>+      if (slot == null) { // new slot\n>+        if (!isExtensible()) throw ScriptRuntime.typeError(\"msg.not.extensible\");\n>+        slot = getSlot(name, 0, SLOT_MODIFY);\n>+        attributes = applyDescriptorToAttributeBitset(DONTENUM|READONLY|PERMANENT, desc);\n>+      } else {\n>+        checkLegalPropertyRedefinition(name, desc);\n>+        attributes = applyDescriptorToAttributeBitset(getAttributes(name), desc);\n>+      }\n>+\n>+      defineOwnProperty(slot, desc, attributes);\n>+    }\n>+\n>+    private void defineOwnProperty(Slot slot, ScriptableObject desc, int attributes) {\n>+      if (isAccessorDescriptor(desc)) {\n>+        if ( !(slot instanceof GetterSlot) ) \n>+          slot = getSlot(slot.name, 0, SLOT_MODIFY_GETTER_SETTER);\n>+\n>+        GetterSlot gslot = (GetterSlot) slot;\n>+\n>+        if (hasProperty(desc, \"get\")) {\n>+          Object getter = getProperty(desc, \"get\");\n\nBoth hasProperty and getProperty traverse the prototype chain looking for the property. So it\'s more efficient to call getProperty once and compare the result to NOT_FOUND.\n\n>+          if ( !(getter instanceof Callable) ) {\n>+            throw ScriptRuntime.notFunctionError(getter);\n>+          } else {\n>+            gslot.getter = getter;\n>+          }\n>+        }\n>+        if (hasProperty(desc, \"set\")) {\n>+          Object setter = getProperty(desc, \"set\");\n>+          if ( !(setter instanceof Callable) ) {\n>+            throw ScriptRuntime.notFunctionError(setter);\n>+          } else {\n>+            gslot.setter = setter;\n>+          }\n>+        }\n>+\n>+        gslot.value = Undefined.instance;\n>+        gslot.setAttributes(attributes);\n>+      } else {\n>+        if (slot instanceof GetterSlot && isDataDescriptor(desc)) {\n>+          slot = getSlot(slot.name, 0, SLOT_CONVERT_ACCESSOR_TO_DATA);\n>+        }\n>+\n>+        if (hasProperty(desc, \"value\")) {\n>+          slot.value = getProperty(desc, \"value\");\n>+        }\n>+        slot.setAttributes(attributes);\n>+      }\n>+    }\n>+\n>+\n>+\n>+\n>+    private void checkLegalPropertyRedefinition(String name, ScriptableObject desc) {\n>+      ScriptableObject current = getOwnPropertyDescriptor(Context.getContext(), name);\n>+      if (Boolean.FALSE.equals(getProperty(current, \"configurable\"))) {\n\nI assume you\'re not calling toBoolean on the properties of current because you know that they will\nbe Boolean objects. Seems like you\'d also know that they\'d be defined in current rather than in its prototype chain you could call get(). Come to think of it, you don\'t have to create current at all\nbut instead could just compare against the bits in attributes.\n\n>+        if (hasProperty(desc, \"configurable\") && ScriptRuntime.toBoolean(getProperty(desc, \"configurable\")))\n>+          throw ScriptRuntime.typeError1(\"msg.change.configurable.false.to.true\", name);\n>+        if (hasProperty(desc, \"enumerable\") && !getProperty(current, \"enumerable\").equals(ScriptRuntime.toBoolean(getProperty(desc, \"enumerable\"))))\n>+          throw ScriptRuntime.typeError1(\"msg.change.enumerable.with.configurable.false\", name);\n>+\n>+        if (isGenericDescriptor(desc)) {\n>+          // no further validation required\n>+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n>+          if (Boolean.FALSE.equals(getProperty(current, \"writable\"))) {\n>+            if (hasProperty(desc, \"writable\") && ScriptRuntime.toBoolean(getProperty(desc, \"writable\")))\n>+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n>+\n>+            if (hasProperty(desc, \"value\") && !ScriptRuntime.shallowEq(getProperty(current, \"value\"), getProperty(desc, \"value\"))) \n>+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n>+          }\n>+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n>+          if (hasProperty(desc, \"set\") && !ScriptRuntime.shallowEq(getProperty(current, \"set\"), getProperty(desc, \"set\")))\n>+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n>+\n>+          if (hasProperty(desc, \"get\") && !ScriptRuntime.shallowEq(getProperty(current, \"get\"), getProperty(desc, \"get\"))) \n>+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n>+        } else {\n>+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n\nWhat does this correspond to in the spec? I\'m not sure where this comes from.\n\n>+        }\n>+      }\n>+    }\n>+\n>+    private int applyDescriptorToAttributeBitset(int attributes, ScriptableObject desc) {\n>+      if (hasProperty(desc, \"enumerable\")) {\n>+        boolean enumerable = ScriptRuntime.toBoolean(getProperty(desc, \"enumerable\"));\n>+        attributes = (enumerable ? attributes & ~DONTENUM : attributes | DONTENUM);\n>+      }\n>+\n>+      if (hasProperty(desc, \"writable\")) {\n>+        boolean writable = ScriptRuntime.toBoolean(getProperty(desc, \"writable\"));\n>+        attributes = (writable ? attributes & ~READONLY : attributes | READONLY);\n>+      }\n>+\n>+      if (hasProperty(desc, \"configurable\")) {\n>+        boolean configurable = ScriptRuntime.toBoolean(getProperty(desc, \"configurable\"));\n>+        attributes = (configurable ? attributes & ~PERMANENT : attributes | PERMANENT);\n>+      }\n>+\n>+      return attributes;\n>+    }\n>+\n>+    private boolean isDataDescriptor(ScriptableObject desc) {\n>+      return hasProperty(desc, \"value\") || hasProperty(desc, \"writable\");\n>+    }\n>+    private boolean isAccessorDescriptor(ScriptableObject desc) {\n>+      return hasProperty(desc, \"get\") || hasProperty(desc, \"set\");\n>+    }\n>+    private boolean isGenericDescriptor(ScriptableObject desc) {\n>+      return !isDataDescriptor(desc) && !isAccessorDescriptor(desc);\n>+    }\n>+\n>+    /**\n>      * Search for names in a class, adding the resulting methods\n>      * as properties.\n>      *\n>@@ -1576,6 +1720,14 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>     }\n> \n>+    public boolean isExtensible() {\n>+      return isExtensible;\n>+    }\n>+\n>+    public void preventExtensions() {\n>+      isExtensible = false;\n>+    }\n>+\n>     /**\n>      * Seal this object.\n>      *\n>@@ -2082,6 +2234,11 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>             if (slot == null) {\n>                 return false;\n>             }\n>+        } else if (!isExtensible()) {\n>+            slot = getSlot(name, index, SLOT_QUERY);\n>+            if (slot == null) {\n>+                return true;\n>+            }\n>         } else {\n>             checkNotSealed(name, index);\n>             // either const hoisted declaration or initialization\n>@@ -2188,6 +2345,10 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                 !(slot instanceof GetterSlot))\n>                 break lastAccessCheck;\n> \n>+            if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA &&\n>+                (slot instanceof GetterSlot))\n>+                break lastAccessCheck;\n>+\n>             return slot;\n>         }\n> \n>@@ -2206,7 +2367,8 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         if (accessType == SLOT_QUERY ||\n>             accessType == SLOT_MODIFY ||\n>             accessType == SLOT_MODIFY_CONST ||\n>-            accessType == SLOT_MODIFY_GETTER_SETTER)\n>+            accessType == SLOT_MODIFY_GETTER_SETTER ||\n>+            accessType == SLOT_CONVERT_ACCESSOR_TO_DATA)\n>         {\n>             // Check the hashtable without using synchronization\n> \n>@@ -2249,6 +2411,9 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                 } else if (accessType == SLOT_MODIFY_CONST) {\n>                     if (slot != null)\n>                         return slot;\n>+                } else if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA) {\n>+                    if ( !(slot instanceof GetterSlot) )\n>+                        return slot;\n>                 }\n>             }\n> \n>@@ -2288,49 +2453,52 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>                         // implementation it is harmless with the only\n>                         // complication is the need to replace the added slot\n>                         // if we need GetterSlot and the old one is not.\n>-                        if (accessType == SLOT_MODIFY_GETTER_SETTER &&\n>-                            !(slot instanceof GetterSlot))\n>-                        {\n>-                            GetterSlot newSlot = new GetterSlot(name,\n>-                                    indexOrHash, slot.getAttributes());\n>-                            newSlot.value = slot.value;\n>-                            newSlot.next = slot.next;\n>-                            // add new slot to linked list\n>-                            if (lastAdded != null)\n>-                                lastAdded.orderedNext = newSlot;\n>-                            if (firstAdded == null)\n>-                                firstAdded = newSlot;\n>-                            lastAdded = newSlot;\n>-                            // add new slot to hash table\n>-                            if (prev == slot) {\n>-                                slotsLocalRef[insertPos] = newSlot;\n>-                            } else {\n>-                                prev.next = newSlot;\n>-                            }\n>-                            // other housekeeping\n>-                            slot.wasDeleted = true;\n>-                            slot.value = null;\n>-                            slot.name = null;\n>-                            if (slot == lastAccess) {\n>-                                lastAccess = REMOVED;\n>-                            }\n>-                            slot = newSlot;\n>+\n>+                        Slot newSlot;\n>+\n>+                        if (accessType == SLOT_MODIFY_GETTER_SETTER && !(slot instanceof GetterSlot)) {\n>+                            newSlot = new GetterSlot(name, indexOrHash, slot.getAttributes());\n>+                        } else if (accessType == SLOT_CONVERT_ACCESSOR_TO_DATA && (slot instanceof GetterSlot)) {\n>+                            newSlot = new Slot(name, indexOrHash, slot.getAttributes());\n>                         } else if (accessType == SLOT_MODIFY_CONST) {\n>-                            return null;\n>+                          return null;\n>+                        } else {\n>+                          return slot;\n>                         }\n>-                        return slot;\n>-                    }\n> \n>-                    // Check if the table is not too full before inserting.\n>-                    if (4 * (count + 1) > 3 * slotsLocalRef.length) {\n>-                        slotsLocalRef = new Slot[slotsLocalRef.length * 2 + 1];\n>-                        copyTable(slots, slotsLocalRef, count);\n>-                        slots = slotsLocalRef;\n>-                        insertPos = getSlotIndex(slotsLocalRef.length,\n>-                                indexOrHash);\n>+                        newSlot.value = slot.value;\n>+                        newSlot.next = slot.next;\n>+                        // add new slot to linked list\n>+                        if (lastAdded != null)\n>+                            lastAdded.orderedNext = newSlot;\n>+                        if (firstAdded == null)\n>+                            firstAdded = newSlot;\n>+                        lastAdded = newSlot;\n>+                        // add new slot to hash table\n>+                        if (prev == slot) {\n>+                            slotsLocalRef[insertPos] = newSlot;\n>+                        } else {\n>+                            prev.next = newSlot;\n>+                        }\n>+                        // other housekeeping\n>+                        slot.wasDeleted = true;\n>+                        slot.value = null;\n>+                        slot.name = null;\n>+                        if (slot == lastAccess) {\n>+                            lastAccess = REMOVED;\n>+                        }\n>+                        return newSlot;\n>+                    } else {\n>+                      // Check if the table is not too full before inserting.\n>+                      if (4 * (count + 1) > 3 * slotsLocalRef.length) {\n>+                          slotsLocalRef = new Slot[slotsLocalRef.length * 2 + 1];\n>+                          copyTable(slots, slotsLocalRef, count);\n>+                          slots = slotsLocalRef;\n>+                          insertPos = getSlotIndex(slotsLocalRef.length,\n>+                                  indexOrHash);\n>+                      }\n>                     }\n>                 }\n>-\n>                 Slot newSlot = (accessType == SLOT_MODIFY_GETTER_SETTER\n>                                 ? new GetterSlot(name, indexOrHash, 0)\n>                                 : new Slot(name, indexOrHash, 0));\n>diff --git a/src/org/mozilla/javascript/resources/Messages.properties b/src/org/mozilla/javascript/resources/Messages.properties\n>index 545dc87..6ad9097 100644\n>--- a/src/org/mozilla/javascript/resources/Messages.properties\n>+++ b/src/org/mozilla/javascript/resources/Messages.properties\n>@@ -667,6 +667,32 @@ msg.modify.sealed =\\\n> msg.modify.readonly =\\\n>     Cannot modify readonly property: {0}.\n> \n>+msg.change.configurable.false.to.true =\\\n>+    Cannot change the configurable attribute of \"{0}\" from false to true.\n>+\n>+msg.change.enumerable.with.configurable.false =\\\n>+    Cannot change the enumerable attribute of \"{0}\" because configurable is false.\n>+\n>+msg.change.writable.false.to.true.with.configurable.false =\\\n>+    Cannot change the writable attribute of \"{0}\" from false to true because configurable is false.\n>+\n>+# TODO should we be using msg.modify.readonly here instead?\n\nNo, it\'s fine to have a separate message given that it\'s coming from a new ES5 function\n\n>+msg.change.value.with.writable.false =\\\n>+    Cannot change the value of attribute \"{0}\" because writable is false.\n>+\n>+msg.change.getter.with.configurable.false =\\\n>+    Cannot change the get attribute of \"{0}\" because configurable is false.\n>+\n>+msg.change.setter.with.configurable.false =\\\n>+    Cannot change the set attribute of \"{0}\" because configurable is false.\n>+\n>+# TODO not sure about how descriptive this message is\n>+msg.change.descriptor.type.with.configurable.false =\\\n>+    Cannot change type of property \"{0}\" because configurable is false.\n>+\n>+msg.not.extensible =\\\n>+    Cannot add properties to this object because extensible is false.\n>+\n> # TokenStream\n> msg.missing.exponent =\\\n>     missing exponent\n>diff --git a/testsrc/doctests/object.defineproperty.doctest b/testsrc/doctests/object.defineproperty.doctest\n>new file mode 100644\n>index 0000000..e40e972\n>--- /dev/null\n>+++ b/testsrc/doctests/object.defineproperty.doctest\n>@@ -0,0 +1,169 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.defineProperty\n>+function defineProperty() { [native code for Object.defineProperty, arity=3] }\n>+\n>+js> expectTypeError(function() { Object.defineProperty() });\n>+js> expectTypeError(function() { Object.defineProperty({}) });\n>+js> expectTypeError(function() { Object.defineProperty({}, \'p\') });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.defineProperty(value, \'p\', {}) }) \n>+  > })\n>+\n>+js> Object.defineProperty({}, \'p\', {value:1}).p\n>+1\n>+js> var obj = {}\n>+js> Object.defineProperty(obj, \'a\', {\n>+  >   value: 1,\n>+  >   enumerable: false,\n>+  >   writable: false,\n>+  >   configurable: false\n>+  > })  \n>+[object Object]\n>+js> for (var p in obj) print(p); // check it has no enumerable properties\n>+js> obj.a = 2; obj.a; // check that the property is not writable\n>+1\n>+js> delete obj.a; obj.a // check that the property is not deletable\n>+1\n>+\n>+js> var define = Object.defineProperty;\n>+js> var describe = Object.getOwnPropertyDescriptor;\n>+\n>+js> // when define new property with empty descriptor then default values are used for the descriptor\n>+js> var obj = define({}, \'a\', {});\n>+js> describe(obj, \'a\').toSource()\n>+({writable:false, enumerable:false, configurable:false})\n>+\n>+js> // when define new property with data descriptor then those values are used for the descriptor\n>+js> var obj = define({}, \'a\', { value: 2, writable: true });\n>+js> var {value:v, writable:w} = describe(obj, \'a\'); [v, w].toSource();\n>+[2, true]\n>+js> obj.a\n>+2\n>+\n>+js> // when define new property with accessor descriptor then those values are used for the descriptor\n>+js> var obj = define({}, \'a\', { get: function() { return 3; }, set: function(value) {} });\n>+js> var {get:g, set:s} = describe(obj, \'a\'); [g, s].toSource();\n>+[(function () {return 3;}), (function (value) {})]\n>+js> obj.a\n>+3\n>+\n>+js> // when define existing property with empty descriptor then descriptor is left unchanged\n>+js> var descriptor = {value:1, writable:true, enumerable:true, configurable:true};\n>+js> var obj = define({},  \'a\', descriptor);\n>+js> var obj = define(obj, \'a\', {});\n>+js> describe(obj, \'a\').toSource()\n>+({value:1, writable:true, enumerable:true, configurable:true})\n>+\n>+js> // when define existing property with same descriptor then descriptor is left unchanged\n>+js> var descriptor = {value:1, writable:true, enumerable:true, configurable:true};\n>+js> var obj = define({},  \'a\', descriptor);\n>+js> var obj = define(obj, \'a\', descriptor);\n>+js> describe(obj, \'a\').toSource()\n>+({value:1, writable:true, enumerable:true, configurable:true})\n>+\n>+js> // may not change configurable from false to true\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {configurable : false});\n>+  >   define(obj, \'a\',          {configurable : true});\n>+  > });\n>+\n>+js> // may not change enumerable when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {enumerable : true, configurable:false});\n>+  >   define(obj, \'a\',          {enumerable : false});\n>+  > });\n>+\n>+js> // may not change writable from false to true when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {writable : false, configurable: false});\n>+  >   define(obj, \'a\',          {writable : true});\n>+  > });\n>+\n>+js> // may not change value when writable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {value : 1, writable:false});\n>+  >   define(obj, \'a\',          {value : 2});\n>+  > });\n>+\n>+js> // may not change getter when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {get: function() { return 1 }, configurable:false});\n>+  >   define(obj, \'a\',          {get: function() { return 1 }});\n>+  > });\n>+\n>+js> // may not change setter when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {set: function(val) {}, configurable:false});\n>+  >   define(obj, \'a\',          {set: function(val) {}});\n>+  > });\n>+\n>+js> // may not change from data property to accessor property when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {value : 1, configurable:false});\n>+  >   define(obj, \'a\',          {get   : function() { return 1 }});\n>+  > });\n>+\n>+js> // may not change from accessor property to data property when configurable is false\n>+js> expectTypeError(function() {\n>+  >   var obj = define({}, \'a\', {get   : function() { return 1 }, configurable:false});\n>+  >   define(obj, \'a\',          {value : 1});\n>+  > });\n>+\n>+js> // can change writable from true to false when configurable is false\n>+js> var obj = define({},  \'a\', {writable:true, configurable:false});\n>+js> var obj = define(obj, \'a\', {writable:false});\n>+\n>+js> // can set enumerable to the same value when configuable is false\n>+js> var obj = define({},  \'a\', {enumerable:true, configurable:false});\n>+js> var obj = define(obj, \'a\', {enumerable:true});\n>+\n>+js> // can change from data property to accessor property when configurable is true\n>+js> var obj = define({},  \'a\', {value : 1, configurable: true});\n>+js> var obj = define(obj, \'a\', {get   : function() { return 4 }});\n>+js> obj.a\n>+4\n>+js> describe(obj, \'a\').toSource()\n>+({enumerable:false, configurable:true, get:(function () {return 4;})})\n>+\n>+js> // can change from accessor property to data property when configurable is true\n>+js> var obj = define({},  \'a\', {get   : function() { return 2 }, configurable:true});\n>+js> var obj = define(obj, \'a\', {value : 5});\n>+js> obj.a\n>+5\n>+js> describe(obj, \'a\').toSource()\n>+({value:5, writable:false, enumerable:false, configurable:true})\n>+\n>+js> // can change enumerable and writable to true when configurable is true\n>+js> var obj = define({},  \'a\', {writable : false, enumerable : false, configurable:true});\n>+js> var obj = define(obj, \'a\', {writable : true,  enumerable : true, configurable:true});\n>+\n>+js> // can change the value if writable is true\n>+js> var obj = define({},  \'a\', {value:6, writable:true})\n>+js> obj.a\n>+6\n>+js> var obj = define(obj, \'a\', {value:7})\n>+js> obj.a\n>+7\n>+\n>+js> // defining a new property should fail loudly when object is not extensible\n>+js> var obj = Object.preventExtensions({});\n>+js> expectTypeError(function() { define(obj, \'a\', {value:1}) })\n>+\n>+js> // defining new property should succeed when object is extensible\n>+js> var obj = {}\n>+js> Object.isExtensible(obj);\n>+true\n>+js> obj.a = 8; obj.a\n>+8\n>+\n>+js> // changing existing property should succeed when object is not extensible\n>+js> var obj = define({},  \'a\', {value:1, writable:true});\n>+js> var obj = Object.preventExtensions(obj);\n>+js> obj.a = 9; obj.a\n>+9\n>+\n>+js> // defined getters and setters must be functions\n>+js> expectTypeError(function() { define({}, \'a\', {get:1}); })\n>+js> expectTypeError(function() { define({}, \'a\', {set:1}); })\n>+\n>diff --git a/testsrc/doctests/object.extensible.doctest b/testsrc/doctests/object.extensible.doctest\n>new file mode 100644\n>index 0000000..841511d\n>--- /dev/null\n>+++ b/testsrc/doctests/object.extensible.doctest\n>@@ -0,0 +1,30 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.isExtensible;\n>+function isExtensible() { [native code for Object.isExtensible, arity=1] }\n>+js> expectTypeError(function() { Object.isExtensible() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.isExtensible(value) }) \n>+  > })\n>+\n>+js> Object.preventExtensions;\n>+function preventExtensions() { [native code for Object.preventExtensions, arity=1] }\n>+js> expectTypeError(function() { Object.preventExtensions() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.preventExtensions(value) }) \n>+  > })\n>+\n>+js> var x = {};\n>+js> Object.isExtensible(x);\n>+true\n>+js> var y = Object.preventExtensions(x);\n>+js> y === x;\n>+true\n>+js> Object.isExtensible(x);\n>+false\n>+\n>+js> x.a = 1; x.a\n>+js>\n>+\n>+js> x.__defineGetter__(\'b\', function() { return 1 }); x.b\n>+js>(In reply to comment #16)\n\n...snip...\n\n> >+        if (isGenericDescriptor(desc)) {\n> >+          // no further validation required\n> >+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n> >+          if (Boolean.FALSE.equals(getProperty(current, \"writable\"))) {\n> >+            if (hasProperty(desc, \"writable\") && ScriptRuntime.toBoolean(getProperty(desc, \"writable\")))\n> >+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n> >+\n> >+            if (hasProperty(desc, \"value\") && !ScriptRuntime.shallowEq(getProperty(current, \"value\"), getProperty(desc, \"value\"))) \n> >+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n> >+          }\n> >+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n> >+          if (hasProperty(desc, \"set\") && !ScriptRuntime.shallowEq(getProperty(current, \"set\"), getProperty(desc, \"set\")))\n> >+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n> >+\n> >+          if (hasProperty(desc, \"get\") && !ScriptRuntime.shallowEq(getProperty(current, \"get\"), getProperty(desc, \"get\"))) \n> >+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n> >+        } else {\n> >+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n> \n> What does this correspond to in the spec? I\'m not sure where this comes from.\n> \n\nThis comes from to 8.10.12 Step 9.a\n\n...snip...(In reply to comment #17)\n> (In reply to comment #16)\n> \n> ...snip...\n> \n> > >+        if (isGenericDescriptor(desc)) {\n> > >+          // no further validation required\n> > >+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n> > >+          if (Boolean.FALSE.equals(getProperty(current, \"writable\"))) {\n> > >+            if (hasProperty(desc, \"writable\") && ScriptRuntime.toBoolean(getProperty(desc, \"writable\")))\n> > >+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n> > >+\n> > >+            if (hasProperty(desc, \"value\") && !ScriptRuntime.shallowEq(getProperty(current, \"value\"), getProperty(desc, \"value\"))) \n> > >+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n> > >+          }\n> > >+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n> > >+          if (hasProperty(desc, \"set\") && !ScriptRuntime.shallowEq(getProperty(current, \"set\"), getProperty(desc, \"set\")))\n> > >+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n> > >+\n> > >+          if (hasProperty(desc, \"get\") && !ScriptRuntime.shallowEq(getProperty(current, \"get\"), getProperty(desc, \"get\"))) \n> > >+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n> > >+        } else {\n> > >+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n> > \n> > What does this correspond to in the spec? I\'m not sure where this comes from.\n> > \n> \n> This comes from to 8.10.12 Step 9.a\n> \n> ...snip...\n\nAh, thanks. The \"type\" confused me there as I was thinking runtime types. Perhaps a better error message would be something like \"can\'t add or remove getters or setters because configurable is false\" (Does that error message cover all the cases?)(In reply to comment #18)\n> (In reply to comment #17)\n> > (In reply to comment #16)\n> > \n> > ...snip...\n> > \n> > > >+        if (isGenericDescriptor(desc)) {\n> > > >+          // no further validation required\n> > > >+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n> > > >+          if (Boolean.FALSE.equals(getProperty(current, \"writable\"))) {\n> > > >+            if (hasProperty(desc, \"writable\") && ScriptRuntime.toBoolean(getProperty(desc, \"writable\")))\n> > > >+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n> > > >+\n> > > >+            if (hasProperty(desc, \"value\") && !ScriptRuntime.shallowEq(getProperty(current, \"value\"), getProperty(desc, \"value\"))) \n> > > >+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n> > > >+          }\n> > > >+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n> > > >+          if (hasProperty(desc, \"set\") && !ScriptRuntime.shallowEq(getProperty(current, \"set\"), getProperty(desc, \"set\")))\n> > > >+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n> > > >+\n> > > >+          if (hasProperty(desc, \"get\") && !ScriptRuntime.shallowEq(getProperty(current, \"get\"), getProperty(desc, \"get\"))) \n> > > >+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n> > > >+        } else {\n> > > >+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n> > > \n> > > What does this correspond to in the spec? I\'m not sure where this comes from.\n> > > \n> > \n> > This comes from to 8.10.12 Step 9.a\n> > \n> > ...snip...\n> \n> Ah, thanks. The \"type\" confused me there as I was thinking runtime types.\n> Perhaps a better error message would be something like \"can\'t add or remove\n> getters or setters because configurable is false\" (Does that error message\n> cover all the cases?)\n\nWell in principle they could just be defining a writable attribute to an existing accessor property, e.g.\n\njs> var obj = Object.defineProperty({}, \'a\', {configurable:false, get:function() { return 1 }})\njs> Object.defineProperty(obj, \'a\', {writable:false})\n\nWhat about something more explicit:\n\'Cannot change property \"a\" from an accessor property to a data property because configurable is false\" \nfor the accessor -> data case, and \n\'Cannot change property \"a\" from a data property to an accessor property because configurable is false\" \nfor the other?\n\nOr even:\n\'Cannot set value or writable on property \"a\" because it is currently a getter/setter property and configurable is false\'\nand\n\'Cannot set getter or setter on property \"a\" because it is currently a value/writable property and configurable is false\'\n?Created attachment 381475\nupdates from comment 16, 18, 19\n\n- replaced calls to hasProperty, with checks for for NOT_FOUND\n- replaced calls to getProperty(current, ...) with current.get(...)\n- didn\'t replace current.get() with direct slot attribute checks as that seemed to require duplication and reduced readability of the code, is it worthwhile for efficiency?\n- made error messages more descriptive for changing property data->accessor or accessor->data when configurable is falseCreated attachment 381478\nupdates from comment 16, 18, 19 again\n\n- same as previous but also removed hasProperty/getProperty pairing from applyDescriptorToAttributeBitset\n- have not attempted to optimise calls to isAccessorProperty/isDataProperty/isGenericProperty. worthwhile?(In reply to comment #19)\n> (In reply to comment #18)\n> > (In reply to comment #17)\n> > > (In reply to comment #16)\n> > > \n> > > ...snip...\n> > > \n> > > > >+        if (isGenericDescriptor(desc)) {\n> > > > >+          // no further validation required\n> > > > >+        } else if (isDataDescriptor(desc) && isDataDescriptor(current)) {\n> > > > >+          if (Boolean.FALSE.equals(getProperty(current, \"writable\"))) {\n> > > > >+            if (hasProperty(desc, \"writable\") && ScriptRuntime.toBoolean(getProperty(desc, \"writable\")))\n> > > > >+              throw ScriptRuntime.typeError1(\"msg.change.writable.false.to.true.with.configurable.false\", name);\n> > > > >+\n> > > > >+            if (hasProperty(desc, \"value\") && !ScriptRuntime.shallowEq(getProperty(current, \"value\"), getProperty(desc, \"value\"))) \n> > > > >+              throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n> > > > >+          }\n> > > > >+        } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n> > > > >+          if (hasProperty(desc, \"set\") && !ScriptRuntime.shallowEq(getProperty(current, \"set\"), getProperty(desc, \"set\")))\n> > > > >+            throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n> > > > >+\n> > > > >+          if (hasProperty(desc, \"get\") && !ScriptRuntime.shallowEq(getProperty(current, \"get\"), getProperty(desc, \"get\"))) \n> > > > >+            throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n> > > > >+        } else {\n> > > > >+          throw ScriptRuntime.typeError1(\"msg.change.descriptor.type.with.configurable.false\", name);\n> > > > \n> > > > What does this correspond to in the spec? I\'m not sure where this comes from.\n> > > > \n> > > \n> > > This comes from to 8.10.12 Step 9.a\n> > > \n> > > ...snip...\n> > \n> > Ah, thanks. The \"type\" confused me there as I was thinking runtime types.\n> > Perhaps a better error message would be something like \"can\'t add or remove\n> > getters or setters because configurable is false\" (Does that error message\n> > cover all the cases?)\n> \n> Well in principle they could just be defining a writable attribute to an\n> existing accessor property, e.g.\n> \n> js> var obj = Object.defineProperty({}, \'a\', {configurable:false,\n> get:function() { return 1 }})\n> js> Object.defineProperty(obj, \'a\', {writable:false})\n> \n> What about something more explicit:\n> \'Cannot change property \"a\" from an accessor property to a data property\n> because configurable is false\" \n> for the accessor -> data case, and \n> \'Cannot change property \"a\" from a data property to an accessor property\n> because configurable is false\" \n> for the other?\n\nYes, I like these, thanks.\n\n> \n> Or even:\n> \'Cannot set value or writable on property \"a\" because it is currently a\n> getter/setter property and configurable is false\'\n> and\n> \'Cannot set getter or setter on property \"a\" because it is currently a\n> value/writable property and configurable is false\'\n> ?Submitted:\n\nChecking in src/org/mozilla/javascript/NativeObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeObject.java,v  <--  NativeObject.java\nnew revision: 1.50; previous revision: 1.49\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.149; previous revision: 1.148\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.94; previous revision: 1.93\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/object.extensible.doctest,vdone\nChecking in testsrc/doctests/object.extensible.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.extensible.doctest,v  <--  object.extensible.doctest\ninitial revision: 1.1\ndoneCreated attachment 381889\npatch for Object.create and Object.defineProperties\n\n- added Object.defineProperties and Object.defineProperties\n- moved all validation of new properties into a separated method so it could be done independently\n- small change to ScriptableObject#getOwnPropertyDescriptor so that if the current parent scope is null, it uses this as descriptor\'s scope\n- also added small change to DoctestsTest so that it also prints out failing testsComment on attachment 381889\npatch for Object.create and Object.defineProperties\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index f9f3bdd..4be509e 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -40,6 +40,8 @@\n>  * ***** END LICENSE BLOCK ***** */\n> \n> package org.mozilla.javascript;\n>+import java.util.Map;\n>+import java.util.LinkedHashMap;\n> \n> /**\n>  * This class implements the Object native object.\n>@@ -87,6 +89,10 @@ public class NativeObject extends IdScriptableObject\n>                 \"isExtensible\", 1);\n>         addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_preventExtensions,\n>                 \"preventExtensions\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_defineProperties,\n>+                \"defineProperties\", 2);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_create,\n>+                \"create\", 2);\n>         super.fillConstructorProperties(ctor);\n>     }\n> \n>@@ -338,22 +344,36 @@ public class NativeObject extends IdScriptableObject\n>                 obj.preventExtensions();\n>                 return obj;\n>               }\n>-\n>-          default:\n>-            throw new IllegalArgumentException(String.valueOf(id));\n>+          case ConstructorId_defineProperties:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+                Object propsObj = args.length < 2 ? Undefined.instance : args[1];\n>+                Scriptable props = Context.toObject(propsObj, getParentScope());\n>+                obj.defineOwnProperties(ensureScriptableObject(props));\n>+                return obj;\n>         }\n>+          case ConstructorId_create:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                Scriptable obj = ensureScriptable(arg);\n>+                Object propsObj = args.length < 2 ? Undefined.instance : args[1];\n>+\n>+                ScriptableObject newObject = new NativeObject();\n>+                newObject.setParentScope(this.getParentScope());\n>+                newObject.setPrototype(obj);\n>+\n>+                if (propsObj != Undefined.instance) {\n\nSeems clearer to just check against args.length and define propsObj inside the if.\n\n>+                    Scriptable props = Context.toObject(propsObj, getParentScope());\n>+                    newObject.defineOwnProperties(ensureScriptableObject(props));\n>     }\n> \n>-    private Scriptable ensureScriptable(Object arg) {\n>-      if ( !(arg instanceof Scriptable) )\n>-        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>-      return (Scriptable) arg;\n>+                return newObject;\n>     }\n> \n>-    private ScriptableObject ensureScriptableObject(Object arg) {\n>-      if ( !(arg instanceof ScriptableObject) )\n>-        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>-      return (ScriptableObject) arg;\n>+          default:\n>+            throw new IllegalArgumentException(String.valueOf(id));\n>+        }\n>     }\n> \n> // #string_id_map#\n>@@ -405,6 +425,8 @@ public class NativeObject extends IdScriptableObject\n>         ConstructorId_defineProperty = -5,\n>         ConstructorId_isExtensible = -6,\n>         ConstructorId_preventExtensions = -7,\n>+        ConstructorId_defineProperties= -8,\n>+        ConstructorId_create = -9,\n> \n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 9ac6840..1021cdf 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -1496,6 +1496,21 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         gslot.setter = setterBox;\n>     }\n> \n>+    public void defineOwnProperties(ScriptableObject props) {\n>+        Object[] ids = props.getIds();\n>+        for (Object id : ids) {\n>+            String name = ScriptRuntime.toString(id);\n>+            Object descObj = props.get(id);\n>+            ScriptableObject desc = ensureScriptableObject(descObj);\n>+            checkValidPropertyDefinition(getSlot(name, 0, SLOT_QUERY), desc);\n\nHmm. Does getSlot actually need \"name\" here rather than \"id\"? In other words, does this work with integer \"names\"?\n\n>+        }\n>+        for (Object id : ids) {\n>+            String name = ScriptRuntime.toString(id);\n>+            ScriptableObject desc = (ScriptableObject) props.get(id);\n>+            defineOwnProperty(name, desc, false);\n>+        }\n>+    }\n>+\n>     /**\n>      * Defines a property on an object\n>      *\n>@@ -1505,15 +1520,20 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>      * @param desc the new property descriptor, as described in 8.6.1\n>      */\n>     public void defineOwnProperty(String name, ScriptableObject desc) {\n>+      defineOwnProperty(name, desc, true);\n>+    }\n>+\n>+    private void defineOwnProperty(String name, ScriptableObject desc, boolean checkValid) {\n>       Slot slot = getSlot(name, 0, SLOT_QUERY);\n>       final int attributes;\n> \n>+      if (checkValid)\n>+        checkValidPropertyDefinition(slot, desc);\n>+      \n>       if (slot == null) { // new slot\n>-        if (!isExtensible()) throw ScriptRuntime.typeError(\"msg.not.extensible\");\n>         slot = getSlot(name, 0, SLOT_MODIFY);\n>         attributes = applyDescriptorToAttributeBitset(DONTENUM|READONLY|PERMANENT, desc);\n>       } else {\n>-        checkLegalPropertyRedefinition(name, desc);\n>         attributes = applyDescriptorToAttributeBitset(getAttributes(name), desc);\n>       }\n> \n>@@ -1529,20 +1549,12 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n> \n>         Object getter = getProperty(desc, \"get\");\n>         if (getter != NOT_FOUND) {\n>-          if ( !(getter instanceof Callable) ) {\n>-            throw ScriptRuntime.notFunctionError(getter);\n>-          } else {\n>             gslot.getter = getter;\n>           }\n>-        }\n>         Object setter = getProperty(desc, \"set\");\n>         if (setter != NOT_FOUND) {\n>-          if ( !(setter instanceof Callable) ) {\n>-            throw ScriptRuntime.notFunctionError(setter);\n>-          } else {\n>             gslot.setter = setter;\n>           }\n>-        }\n> \n>         gslot.value = Undefined.instance;\n>         gslot.setAttributes(attributes);\n>@@ -1559,7 +1571,20 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>       }\n>     }\n> \n>-    private void checkLegalPropertyRedefinition(String name, ScriptableObject desc) {\n>+    private void checkValidPropertyDefinition(Slot slot, ScriptableObject desc) {\n>+      Object getter = getProperty(desc, \"get\");\n>+      if (getter != NOT_FOUND && !(getter instanceof Callable) ) {\n>+        throw ScriptRuntime.notFunctionError(getter);\n>+      }\n>+      Object setter = getProperty(desc, \"set\");\n>+      if (setter != NOT_FOUND && !(setter instanceof Callable) ) {\n>+        throw ScriptRuntime.notFunctionError(setter);\n>+      }\n>+\n>+      if (slot == null) { // new property\n>+        if (!isExtensible()) throw ScriptRuntime.typeError(\"msg.not.extensible\");\n>+      } else {\n>+        String name = slot.name;\n>       ScriptableObject current = getOwnPropertyDescriptor(Context.getContext(), name);\n>       if (Boolean.FALSE.equals(current.get(\"configurable\")) ) {\n>         if (Boolean.TRUE.equals(tryBoolean(getProperty(desc, \"configurable\")))) \n>@@ -1578,10 +1603,10 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>               throw ScriptRuntime.typeError1(\"msg.change.value.with.writable.false\", name);\n>           }\n>         } else if (isAccessorDescriptor(desc) && isAccessorDescriptor(current)) {\n>-          if (changes(current.get(\"set\"), getProperty(desc, \"set\")))\n>+            if (changes(current.get(\"set\"), setter))\n>             throw ScriptRuntime.typeError1(\"msg.change.setter.with.configurable.false\", name);\n> \n>-          if (changes(current.get(\"get\"), getProperty(desc, \"get\"))) \n>+            if (changes(current.get(\"get\"), getter)) \n>             throw ScriptRuntime.typeError1(\"msg.change.getter.with.configurable.false\", name);\n>         } else {\n>           if (isDataDescriptor(current))\n>@@ -1591,6 +1616,7 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>         }\n>       }\n>     }\n>+    }\n> \n>     private static Object tryBoolean(Object value) {\n>       if (value == NOT_FOUND) return NOT_FOUND;\n>@@ -1636,6 +1662,18 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>       return !isDataDescriptor(desc) && !isAccessorDescriptor(desc);\n>     }\n> \n>+    protected Scriptable ensureScriptable(Object arg) {\n>+      if ( !(arg instanceof Scriptable) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (Scriptable) arg;\n>+    }\n>+\n>+    protected ScriptableObject ensureScriptableObject(Object arg) {\n>+      if ( !(arg instanceof ScriptableObject) )\n>+        throw ScriptRuntime.typeError1(\"msg.arg.not.object\", ScriptRuntime.typeof(arg));\n>+      return (ScriptableObject) arg;\n>+    }\n>+\n>     /**\n>      * Search for names in a class, adding the resulting methods\n>      * as properties.\n>@@ -2729,7 +2767,8 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n> \n>     protected ScriptableObject getOwnPropertyDescriptor(Context cx, String name) {\n>       Slot slot = getSlot(name, 0, SLOT_QUERY);\n>-      return (slot == null) ? null : slot.getPropertyDescriptor(cx, getParentScope());\n>+      Scriptable scope = getParentScope();\n>+      return (slot == null) ? null : slot.getPropertyDescriptor(cx, (scope == null ? this : scope));\n>     }\n> \n>     // Methods and classes to implement java.util.Map interface\n>diff --git a/testsrc/doctests/object.create.doctest b/testsrc/doctests/object.create.doctest\n>new file mode 100644\n>index 0000000..3ba51d5\n>--- /dev/null\n>+++ b/testsrc/doctests/object.create.doctest\n>@@ -0,0 +1,30 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.create;\n>+function create() { [native code for Object.create, arity=2] }\n>+\n>+js> expectTypeError(function() { Object.create() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.create(value) }) \n>+  > })\n>+js> expectTypeError(function() { Object.create({}, null) }) \n>+\n>+js> var obj = Object.create({});\n>+js> var obj = Object.create({}, {});\n>+js> var obj = Object.create({}, undefined);\n>+\n>+js> var orig = {}\n>+js> var next = Object.create(orig);\n>+js> Object.getPrototypeOf(next) === orig;\n>+true\n>+\n>+js> var obj = Object.create({}, {a: {value:1}, b: {value:2}});\n>+js> [obj.a, obj.b].toSource();\n>+[1, 2]\n>+\n>+js> var orig = {a:1};\n>+js> var obj = Object.create(orig, {a:{value:2}, b:{value:3}});\n>+js> [obj.a, obj.b].toSource()\n>+[2, 3]\n>+\n>+js> expectTypeError(function() { Object.create({}, {b: {value:1}, c:1}) });\n>diff --git a/testsrc/doctests/object.defineproperties.doctest b/testsrc/doctests/object.defineproperties.doctest\n>new file mode 100644\n>index 0000000..0541f75\n>--- /dev/null\n>+++ b/testsrc/doctests/object.defineproperties.doctest\n>@@ -0,0 +1,39 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.defineProperties\n>+function defineProperties() { [native code for Object.defineProperties, arity=2] }\n>+\n>+js> expectTypeError(function() { Object.defineProperties() });\n>+js> expectTypeError(function() { Object.defineProperties({}) });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.defineProperties(value, {}) }) \n>+  > })\n>+\n>+js> Object.defineProperties({}, {p: {value:1}}).p\n>+1\n>+\n>+js> var obj = Object.defineProperties({}, {a: {value:1}, b: {value:2}});\n>+js> [obj.a, obj.b].toSource();\n>+[1, 2]\n>+\n>+js> Object.defineProperties({}, {\'wierd name\': {value:1}})[\'wierd name\']\n>+1\n>+\n>+js> Object.defineProperties({}, {}).toSource()\n>+({})\n>+\n>+js> var obj = {a:1};\n>+js> var obj = Object.defineProperties(obj, {a:{value:2}, b:{value:3}});\n>+js> [obj.a, obj.b].toSource()\n>+[2, 3]\n>+\n>+js> expectTypeError(function() { Object.defineProperties({}, {a: null}) })\n>+js> expectTypeError(function() { Object.defineProperties({}, {a: 1}) })\n>+js> expectTypeError(function() { Object.defineProperties({}, {a: {get: 1}}) })\n>+\n>+js> var obj = {a:1}\n>+js> expectTypeError(function() { \n>+  >   obj = Object.defineProperties(obj, {b: {value:1}, c:1});\n>+  > });\n>+js> obj.b\n>+js>\n>diff --git a/testsrc/org/mozilla/javascript/tests/DoctestsTest.java b/testsrc/org/mozilla/javascript/tests/DoctestsTest.java\n>index f03343f..8081253 100644\n>--- a/testsrc/org/mozilla/javascript/tests/DoctestsTest.java\n>+++ b/testsrc/org/mozilla/javascript/tests/DoctestsTest.java\n>@@ -93,6 +93,9 @@ public class DoctestsTest {\n>             System.out.println(name + \"(\" + optimizationLevel + \"): \" +\n>                     testsPassed + \" passed.\");\n>             assertTrue(testsPassed > 0);\n>+        } catch (Exception ex) {\n>+          System.out.println(name + \"(\" + optimizationLevel + \"): FAILED due to \"+ex);\n>+          throw ex;\n>         } finally {\n>             Context.exit();\n>         }Created attachment 382834\ncreate, defineProperty and defineProperties, and proper handling of numerical ids\n\nfixed methods to handle numerical property ids correctlySubmitted to CVS HEAD. Thanks!Created attachment 383057\npatch for seal, isSealed, freeze and isFrozen\n\nImplements Object.seal, Object.isSealed, Object.freeze and Object.isFrozenComment on attachment 383057\npatch for seal, isSealed, freeze and isFrozen\n\n>diff --git a/src/org/mozilla/javascript/NativeObject.java b/src/org/mozilla/javascript/NativeObject.java\n>index a46af60..325395f 100644\n>--- a/src/org/mozilla/javascript/NativeObject.java\n>+++ b/src/org/mozilla/javascript/NativeObject.java\n>@@ -93,6 +93,14 @@ public class NativeObject extends IdScriptableObject\n>                 \"defineProperties\", 2);\n>         addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_create,\n>                 \"create\", 2);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_isSealed,\n>+                \"isSealed\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_isFrozen,\n>+                \"isFrozen\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_seal,\n>+                \"seal\", 1);\n>+        addIdFunctionProperty(ctor, OBJECT_TAG, ConstructorId_freeze,\n>+                \"freeze\", 1);\n>         super.fillConstructorProperties(ctor);\n>     }\n> \n>@@ -364,10 +372,73 @@ public class NativeObject extends IdScriptableObject\n>                 if (args.length > 1 && args[1] != Undefined.instance) {\n>                   Scriptable props = Context.toObject(args[1], getParentScope());\n>                   newObject.defineOwnProperties(cx, ensureScriptableObject(props));\n>-    }\n>+                }\n> \n>                 return newObject;\n>-    }\n>+              }\n>+\n>+          case ConstructorId_isSealed:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+\n>+                for (Object name: obj.getAllIds()) {\n>+                  Object configurable = obj.getOwnPropertyDescriptor(cx, name).get(\"configurable\");\n>+                  if (Boolean.TRUE.equals(configurable)) \n>+                    return false;\n>+                }\n>+\n>+                return !obj.isExtensible();\n\nHow about testing this first since it\'s cheap to test?\n\n>+              }\n>+          case ConstructorId_isFrozen:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+\n>+                for (Object name: obj.getAllIds()) {\n>+                  ScriptableObject desc = obj.getOwnPropertyDescriptor(cx, name);\n>+                  if (Boolean.TRUE.equals(desc.get(\"configurable\"))) \n>+                    return false;\n>+                  if (isDataDescriptor(desc) && Boolean.TRUE.equals(desc.get(\"writable\")))\n>+                    return false;\n>+                }\n>+\n>+                return !obj.isExtensible();\n\nHere too.\n\n>+              }\n>+          case ConstructorId_seal:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+\n>+                for (Object name: obj.getAllIds()) {\n>+                  ScriptableObject desc = obj.getOwnPropertyDescriptor(cx, name);\n>+                  if (Boolean.TRUE.equals(desc.get(\"configurable\"))) {\n>+                    desc.put(\"configurable\", desc, false);\n>+                    obj.defineOwnProperty(cx, name, desc); \n>+                  }\n>+                }\n>+                obj.preventExtensions();\n\nThe spec has wording \"The above algorithm is specified as a set of sequential steps that include the possibility of an exception being thrown at various intermediate points. Rather than failing after a partial update of O, this function must be implemented such that it either atomically completes all property updates successfully or fails without making any update to the properties of object O.\" Do you know where the exceptions could be thrown, and do you avoid partial updates?\n\nSame question for freeze.\n\n>+\n>+                return obj;\n>+              }\n>+          case ConstructorId_freeze:\n>+              {\n>+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n>+                ScriptableObject obj = ensureScriptableObject(arg);\n>+\n>+                for (Object name: obj.getAllIds()) {\n>+                  ScriptableObject desc = obj.getOwnPropertyDescriptor(cx, name);\n>+                  if (isDataDescriptor(desc) && Boolean.TRUE.equals(desc.get(\"writable\")))\n>+                    desc.put(\"writable\", desc, false);\n>+                  if (Boolean.TRUE.equals(desc.get(\"configurable\")))\n>+                    desc.put(\"configurable\", desc, false);\n>+                  obj.defineOwnProperty(cx, name, desc);\n>+                }\n>+                obj.preventExtensions();\n>+\n>+                return obj;\n>+              }\n>+\n> \n>           default:\n>             throw new IllegalArgumentException(String.valueOf(id));\n>@@ -425,6 +496,10 @@ public class NativeObject extends IdScriptableObject\n>         ConstructorId_preventExtensions = -7,\n>         ConstructorId_defineProperties= -8,\n>         ConstructorId_create = -9,\n>+        ConstructorId_isSealed = -10,\n>+        ConstructorId_isFrozen = -11,\n>+        ConstructorId_seal = -12,\n>+        ConstructorId_freeze = -13,\n> \n>         Id_constructor           = 1,\n>         Id_toString              = 2,\n>diff --git a/src/org/mozilla/javascript/ScriptableObject.java b/src/org/mozilla/javascript/ScriptableObject.java\n>index 15fe398..31ab96c 100644\n>--- a/src/org/mozilla/javascript/ScriptableObject.java\n>+++ b/src/org/mozilla/javascript/ScriptableObject.java\n>@@ -1653,15 +1653,15 @@ public abstract class ScriptableObject implements Scriptable, Serializable,\n>       return attributes;\n>     }\n> \n>-    private boolean isDataDescriptor(ScriptableObject desc) {\n>+    protected boolean isDataDescriptor(ScriptableObject desc) {\n>       return hasProperty(desc, \"value\") || hasProperty(desc, \"writable\");\n>     }\n>-    \n>-    private boolean isAccessorDescriptor(ScriptableObject desc) {\n>+\n>+    protected boolean isAccessorDescriptor(ScriptableObject desc) {\n>       return hasProperty(desc, \"get\") || hasProperty(desc, \"set\");\n>     }\n>-    \n>-    private boolean isGenericDescriptor(ScriptableObject desc) {\n>+\n>+    protected boolean isGenericDescriptor(ScriptableObject desc) {\n>       return !isDataDescriptor(desc) && !isAccessorDescriptor(desc);\n>     }\n> \n>diff --git a/testsrc/doctests/object.freeze.doctest b/testsrc/doctests/object.freeze.doctest\n>new file mode 100644\n>index 0000000..db3f023\n>--- /dev/null\n>+++ b/testsrc/doctests/object.freeze.doctest\n>@@ -0,0 +1,27 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.freeze;\n>+function freeze() { [native code for Object.freeze, arity=1] }\n>+\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.freeze(value) }) \n>+  > })\n>+js> expectTypeError(function() { Object.freeze() })\n>+\n>+js> var x = {}\n>+js> var y = Object.freeze(x)\n>+js> x === y\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:true, writable:true})\n>+js> var _ = Object.freeze(obj)\n>+js> var a = Object.getOwnPropertyDescriptor(obj, \'a\');\n>+js> a.configurable\n>+false\n>+js> a.writable\n>+false\n>+js> Object.isExtensible(obj)\n>+false\n>+\n>+js> Object.isFrozen(obj)\n>+true\n>diff --git a/testsrc/doctests/object.isfrozen.doctest b/testsrc/doctests/object.isfrozen.doctest\n>new file mode 100644\n>index 0000000..b2206f9\n>--- /dev/null\n>+++ b/testsrc/doctests/object.isfrozen.doctest\n>@@ -0,0 +1,37 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.isFrozen\n>+function isFrozen() { [native code for Object.isFrozen, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.isFrozen() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.isFrozen(value) }) \n>+  > })\n>+\n>+js> Object.isFrozen({})\n>+false\n>+\n>+js> var obj = Object.preventExtensions({});\n>+js> Object.isFrozen(obj);\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:true, writable:false})\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isFrozen(obj);\n>+false\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:false, writable:true})\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isFrozen(obj);\n>+false\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:false, writable:false})\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isFrozen(obj);\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:false, set: function(){} })\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isFrozen(obj);\n>+true\n>+\n>diff --git a/testsrc/doctests/object.issealed.doctest b/testsrc/doctests/object.issealed.doctest\n>new file mode 100644\n>index 0000000..275b4ac\n>--- /dev/null\n>+++ b/testsrc/doctests/object.issealed.doctest\n>@@ -0,0 +1,26 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.isSealed\n>+function isSealed() { [native code for Object.isSealed, arity=1] }\n>+\n>+js> expectTypeError(function() { Object.isSealed() });\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.isSealed(value) }) \n>+  > })\n>+\n>+js> Object.isSealed({})\n>+false\n>+\n>+js> var obj = Object.preventExtensions({});\n>+js> Object.isSealed(obj);\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:false});\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isSealed(obj);\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:true});\n>+js> var _ = Object.preventExtensions(obj);\n>+js> Object.isSealed(obj);\n>+false\n>diff --git a/testsrc/doctests/object.seal.doctest b/testsrc/doctests/object.seal.doctest\n>new file mode 100644\n>index 0000000..2f50804\n>--- /dev/null\n>+++ b/testsrc/doctests/object.seal.doctest\n>@@ -0,0 +1,24 @@\n>+js> load(\'testsrc/doctests/util.js\');\n>+\n>+js> Object.seal;\n>+function seal() { [native code for Object.seal, arity=1] }\n>+\n>+js> [undefined, null, true, 1, \'hello\'].forEach(function(value) { \n>+  >   expectTypeError(function() { Object.seal(value) }) \n>+  > })\n>+js> expectTypeError(function() { Object.seal() })\n>+\n>+js> var x = {}\n>+js> var y = Object.seal(x)\n>+js> x === y\n>+true\n>+\n>+js> var obj = Object.defineProperty({}, \'a\', {configurable:true})\n>+js> var _ = Object.seal(obj)\n>+js> Object.getOwnPropertyDescriptor(obj, \'a\').configurable\n>+false\n>+js> Object.isExtensible(obj)\n>+false\n>+\n>+js> Object.isSealed(obj)\n>+true(In reply to comment #29)\n> (From update of attachment 383057 [details])\n...\n> >+          case ConstructorId_seal:\n> >+              {\n> >+                Object arg = args.length < 1 ? Undefined.instance : args[0];\n> >+                ScriptableObject obj = ensureScriptableObject(arg);\n> >+\n> >+                for (Object name: obj.getAllIds()) {\n> >+                  ScriptableObject desc = obj.getOwnPropertyDescriptor(cx, name);\n> >+                  if (Boolean.TRUE.equals(desc.get(\"configurable\"))) {\n> >+                    desc.put(\"configurable\", desc, false);\n> >+                    obj.defineOwnProperty(cx, name, desc); \n> >+                  }\n> >+                }\n> >+                obj.preventExtensions();\n> \n> The spec has wording \"The above algorithm is specified as a set of sequential\n> steps that include the possibility of an exception being thrown at various\n> intermediate points. Rather than failing after a partial update of O, this\n> function must be implemented such that it either atomically completes all\n> property updates successfully or fails without making any update to the\n> properties of object O.\" Do you know where the exceptions could be thrown, and\n> do you avoid partial updates?\n> \n> Same question for freeze.\n...\n\nBy my reading of 8.12.10, this algorithm shouldn\'t throw any exceptions, and since we create the descriptor ourselves with data properties, the descriptors\' setters won\'t throw. All the properties we\'re defining attributes on come from getAllIds, so we shouldn\'t have to worry about a null descriptor (unless another thread in application code deletes a property part-way through, should we worry about that?).No, we shouldn\'t worry about the multithreaded case. I\'ll submit these changes. Thanks!Created attachment 386879\nmake isSealed and isFrozen slightly more efficient in the common case\n\ncheck isExtensible at the beginning of the isSealed and isFrozen implementations, as it is fast that will typically be true, making checking all the attributes unnecessary.Created attachment 386880\nmake getOwnPropertyDescriptor and defineProperty work property for arrays\n\nAllows getting and setting attributes on index properties when the array is in dense mode.I saw the org.hamcrest.* references. Are they sufficiently useful with a good license to merit including them in Rhino?The particular hamcrest packages that are used (Is and IsNot) are included in junit. See http://junit.sourceforge.net/javadoc/org/hamcrest/core/package-summary.html\n\n(In reply to comment #34)\n> I saw the org.hamcrest.* references. Are they sufficiently useful with a good\n> license to merit including them in Rhino?Thanks. They\'re not working for me inside eclipse. I\'ll investigate.(In reply to comment #32)\n> Created an attachment (id=386879) [details]\n> make isSealed and isFrozen slightly more efficient in the common case\n> \n> check isExtensible at the beginning of the isSealed and isFrozen\n> implementations, as it is fast that will typically be true, making checking all\n> the attributes unnecessary.\n\nCommitted this patch:\n\nChecking in src/org/mozilla/javascript/NativeObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeObject.java,v  <--  NativeObject.java\nnew revision: 1.53; previous revision: 1.52\ndone(In reply to comment #36)\n> Thanks. They\'re not working for me inside eclipse. I\'ll investigate.\n\nI\'ve resolved the Eclipse issues, run the regression tests, and committed the code:\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.102; previous revision: 1.101\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/arrays.doctest,v\ndone\nChecking in testsrc/doctests/arrays.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/arrays.doctest,v  <--  arrays.doctest\ninitial revision: 1.1\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\nnew revision: 1.3; previous revision: 1.2\ndone\nChecking in testsrc/doctests/object.getownpropertydescriptor.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.getownpropertydescriptor.doctest,v  <--  object.getownpropertydescriptor.doctest\nnew revision: 1.3; previous revision: 1.2\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/NativeArrayTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/NativeArrayTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/NativeArrayTest.java,v  <--  NativeArrayTest.java\ninitial revision: 1.1\ndoneCreated attachment 388877\nAllow Object.create to accept null as a first argument\n\nAllow Object.create to accept null as a first argument\n\nThis reflects updates in the spec since Object.create was first implemented.Created attachment 388878\nMake Object.getOwnPropertyDescriptor work for members of builtin objects\n\nPreviously Object.getOwnPropertyDescriptor(Math, \"PI\") returned undefined. \n\nThis patch makes the members of builtin objects have descriptors with \nWritable=true, Enumerable=false, Configurable=true for function properties, and\nWritable=false, Enumerable=false, Configurable=false for non-function propertiesCreated attachment 389384\nadding JSON object\n\nAdded JSON object. Includes some new files (JsonLexer and JsonParser) for parsing JSON source.Comment on attachment 389384\nadding JSON object\n\nMoved to bug 505211Submitted patches from #39 and #40.Created attachment 390393\ncorrected the descriptor properties of built-ins\n\nIn attachment 388878 I had some of the logic inverted. This is fix for that.Created attachment 390629\nensure that getters/setters defined through defineProperty are actually used(In reply to comment #45)\n> Created an attachment (id=390629) [details]\n> ensure that getters/setters defined through defineProperty are actually used\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.153; previous revision: 1.152\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\nnew revision: 1.4; previous revision: 1.3\ndoneCreated attachment 390825\nallow getOwnPropertyDescriptor to be called for objects with no scope\n\ne.g. functions returned from Function.bind(In reply to comment #44)\n> Created an attachment (id=390393) [details]\n> corrected the descriptor properties of built-ins\n> \n> In attachment 388878 [details] I had some of the logic inverted. This is fix for that.\n\nIt\'s writable and configurable only if it is a method? That seems backward, and\nI couldn\'t see where in the spec it mentioned different behavior for function\nproperties. Can you describe more?(In reply to comment #48)\n> (In reply to comment #44)\n> > Created an attachment (id=390393) [details] [details]\n> > corrected the descriptor properties of built-ins\n> > \n> > In attachment 388878 [details] [details] I had some of the logic inverted. This is fix for that.\n> \n> It\'s writable and configurable only if it is a method? That seems backward, and\n> I couldn\'t see where in the spec it mentioned different behavior for function\n> properties. Can you describe more?\n\nWell the last paragraph of section 15 (before 15.1) says: \n\n\"In every case, the length property of a built-in Function object described in this section has the attributes \n{ [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false } (and no others). Every other property \n \ndescribed in this section has the attributes { [[Writable]]: true, [[Enumerable]]: false, [[Configurable]]: true } \nunless otherwise specified.\"\n\nLooking through the other properties specified on objects in section 15, it seems that all the non-function properties are \"otherwise specified\" to have all-false descriptors, while function properties all seem to take the default above.Checking in src/org/mozilla/javascript/IdScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IdScriptableObject.java,v  <--  IdScriptableObject.java\nnew revision: 1.14; previous revision: 1.13\ndone\n(In reply to comment #49)\n> (In reply to comment #48)\n> > (In reply to comment #44)\n> > > Created an attachment (id=390393) [details] [details] [details]\n> > > corrected the descriptor properties of built-ins\n> > > \n> > > In attachment 388878 [details] [details] [details] I had some of the logic inverted. This is fix for that.\n> > \n> > It\'s writable and configurable only if it is a method? That seems backward, and\n> > I couldn\'t see where in the spec it mentioned different behavior for function\n> > properties. Can you describe more?\n> \n> Well the last paragraph of section 15 (before 15.1) says: \n> \n> \"In every case, the length property of a built-in Function object described in\n> this section has the attributes \n> { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false } (and no\n> others). Every other property \n> \n> described in this section has the attributes { [[Writable]]: true,\n> [[Enumerable]]: false, [[Configurable]]: true } \n> unless otherwise specified.\"\n> \n> Looking through the other properties specified on objects in section 15, it\n> seems that all the non-function properties are \"otherwise specified\" to have\n> all-false descriptors, while function properties all seem to take the default\n> above.\n\nOk, thanks.\n\nChecking in src/org/mozilla/javascript/IdScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IdScriptableObject.java,v  <--  IdScriptableObject.java\nnew revision: 1.14; previous revision: 1.13\ndone(In reply to comment #47)\n> Created an attachment (id=390825) [details]\n> allow getOwnPropertyDescriptor to be called for objects with no scope\n> \n> e.g. functions returned from Function.bind\n\nChecking in src/org/mozilla/javascript/IdScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IdScriptableObject.java,v  <--  IdScriptableObject.java\nnew revision: 1.15; previous revision: 1.14Created attachment 391263\nmake defineProperty throw a TypeError when attributes is both data and accessor descriptor\n\nAs per 8.10.5 step 9 of the spec.Created attachment 391276\nFor getters and setters of accessor propeties, make being absent is equivalent to having value undefined\n\nAs per 8.6.1 Table 3.\n\nAssumes attachment 391263 has been applied.Created attachment 391299\nmade getOwnPropertDescriptor use the actual attributes for builtins, rather than the isMethod heuristicCreated attachment 391768\nmake Object.defineProperty work for builtin properties\n\nSuch as Math.pow, or JSON.stringify(In reply to comment #52)\n> Created an attachment (id=391263) [details]\n> make defineProperty throw a TypeError when attributes is both data and accessor\n> descriptor\n> \n> As per 8.10.5 step 9 of the spec.\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.154; previous revision: 1.153\ndone\nChecking in src/org/mozilla/javascript/resources/Messages.properties;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/resources/Messages.properties,v  <--  Messages.properties\nnew revision: 1.98; previous revision: 1.97\ndone(In reply to comment #53)\n> Created an attachment (id=391276) [details]\n> For getters and setters of accessor propeties, make being absent is equivalent\n> to having value undefined\n> \n> As per 8.6.1 Table 3.\n> \n> Assumes attachment 391263 [details] has been applied.\n\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.155; previous revision: 1.154\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\nnew revision: 1.5; previous revision: 1.4\ndone(In reply to comment #54)\n> Created an attachment (id=391299) [details]\n> made getOwnPropertDescriptor use the actual attributes for builtins, rather\n> than the isMethod heuristic\n\nChecking in src/org/mozilla/javascript/IdScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IdScriptableObject.java,v  <--  IdScriptableObject.java\nnew revision: 1.16; previous revision: 1.15\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.156; previous revision: 1.155\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\nnew revision: 1.6; previous revision: 1.5\ndone(In reply to comment #55)\n> Created an attachment (id=391768) [details]\n> make Object.defineProperty work for builtin properties\n> \n> Such as Math.pow, or JSON.stringify\n\nChecking in src/org/mozilla/javascript/IdScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/IdScriptableObject.java,v  <--  IdScriptableObject.java\nnew revision: 1.17; previous revision: 1.16\ndone\nChecking in src/org/mozilla/javascript/ScriptableObject.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ScriptableObject.java,v  <--  ScriptableObject.java\nnew revision: 1.157; previous revision: 1.156\ndone\nChecking in testsrc/doctests/object.defineproperty.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.defineproperty.doctest,v  <--  object.defineproperty.doctest\nnew revision: 1.7; previous revision: 1.6\ndoneCreated attachment 418627\nmake Object.freeze work with functions, arrays, regexp\n\nsetInstanceIdValue, called by defineOwnProperty, called by freeze, was not handing all id-identifiable properties, and so when freeze tried to freeze them all, setInstanceIdValue was deferring onto IdScriptableObject.setInstanceIdValue, which just throws an IllegalStateException.\n\nI made setInstanceIdValue always handle all the ids that getInstanceIdValue does.Committed:\n\nChecking in src/org/mozilla/javascript/BaseFunction.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/BaseFunction.java,v  <--  BaseFunction.java\nnew revision: 1.72; previous revision: 1.71\ndone\nChecking in src/org/mozilla/javascript/regexp/NativeRegExp.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java,v  <--  NativeRegExp.java\nnew revision: 1.112; previous revision: 1.111\ndone\nChecking in src/org/mozilla/javascript/regexp/NativeRegExpCtor.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/regexp/NativeRegExpCtor.java,v  <--  NativeRegExpCtor.java\nnew revision: 1.22; previous revision: 1.21\ndone\nChecking in testsrc/doctests/object.freeze.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/object.freeze.doctest,v  <--  object.freeze.doctest\nnew revision: 1.2; previous revision: 1.1\ndone',?,RFE
492036,'New AST code throws codebug on certain forms of destructuring assignment',Rhino,Compiler,hannesw,nobody,'Created attachment 376406\nsimple test script\n\nFrom IRFactory.transformAssignment: (line 397)\n\n        // TODO(stevey)\n        // Bug: for code like \"var obj={p:3};[obj.p]=[9];\", \"left\" will\n        // be ARRAYLITERAL with an embedded GETPROP. This causes errors\n        // at codegen.\n        Kit.codeBug();\n\nLooking at dumps of the parse tree, I noticed that the difference between rhino 1.7R2 and cvs head is middle child node of the SETPROP is of type STRING in 1.7R2 and of type NAME in HEAD:\n\n                         WITH\n                             COMMA\n                                 SETPROP\n-                                    NAME obj 2\n-                                    NAME foo 2\n+                                    NAME obj\n+                                    STRING foo\n                                     NAME $1\n                                 NUMBER 0.0\n                         LEAVEWITH\n\nSo I came up with this really simple patch that sets the node type where it is created in Parser.simpleAssignment(). It seems to work, but it\'s a simple hack of course, so somebody who knows the parser/classgen should definitely look into this for a real solution.Created attachment 376408\nsimplistic patch\n\nset the node type of second SETPROP child to STRING to mirror pre-AST-refactoring outputCreated attachment 376478\nnew patch\n\nObviously, the string id should only be forced for SETPROP and not for SETELEM operations.I noted that Norris recently removed the comment and Kit.codeBug():\n\nhttp://bonsai.mozilla.org/cvsquery.cgi?treeid=default&module=all&branch=HEAD&branchtype=match&dir=&file=mozilla\%2Fjs\%2Frhino\%2F&filetype=match&who=&whotype=match&sortby=Date&hours=2&date=explicit&mindate=2009-05-27+05\%3A23&maxdate=2009-05-27+05\%3A25&cvsroot=\%2Fcvsroot\n\nUnfortunately the bug is still there, it just doesn\'t show in the Rhino shell because this is a codegen-only bug and the shell runs in interpreter mode, which is probably why Norris assumed the bug had been fixed. \n\nIf nobody else comes up with a better solution, I suggest I\'ll commit my workaround patch with a big fat TODO comment including some explanation and a link to this bug.Created attachment 381303\npatch with workaround and TODO comment with link to this bug\n\nPatch with the workaround that sets the GETPROP id type to STRING and a revised TODO comment with link to this bug.Committed last patch.\n\nChecking in src/org/mozilla/javascript/Parser.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Parser.java,v  <--  Parser.java\nnew revision: 1.141; previous revision: 1.140\ndone',?,BUG
492359,'Calling generic String and Array functions without arguments causes ArrayIndexOutOfBoundsException',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.10) Gecko/2009042513 Ubuntu/8.04 (hardy) Firefox/3.0.10\nBuild Identifier: \n\napply called on String.toLowerCase causes ArrayIndexOutOfBoundsException:\n\nString.toLowerCase.apply(\'HELLO\')\n\nThe same occurs probably for other String methods.\n\nReproducible: AlwaysCreated attachment 376705\nPatch with unit test fixing the reported exception\n\nThe provided patch contains a unit test and fixes the problem. It makes some cleanup in NativeString removing (nearly) all ConstructorId_XXX. This code is the source of the error and it seems to useless (at least no new test fails with these changes). The patch doesn\'t try to make additional cleanup to stay as simple as possible.Created attachment 376712\nrevised patch for string generics that uses this-object if called without args\n\nYour patch breaks the basic functionality of the generic String functions: \n\njs> String.toLowerCase(\"FOO\")\nfunction string() { [native code for string.string, arity=1] }\n\nNote that the \"correct\" use of String.toLowerCase.apply would be (where the first argument could really be anything): \n\njs> String.toLowerCase.apply(String, [\"SOME STRING\"]);\n\nBut it looks like spidermonkey checks the arguments and uses the this-object if a string generic funciton is called without arguments. I\'ll try to implement the same behaviour in Rhino. Anyway we need better argument checking here.\n\nI\'m uploading a patch that seems to reproduce spidermonkey behaviour and avoids the ArrayOutOfBound exception. We should probable do the same for the generic Array methods.Created attachment 376719\nimproved patch\n\nImproved patch that checks the fallback this-object is a string object and does the same argument check and fallback for generic array methods.Thanks for the fast feedback Hannes.\nCould you add some tests for \"static\" usage of these functions. Currently it\nseems that there is absolutely no test for that as I couldn\'t see any broken\ntest with the changes in the propose patch.I committed your testcase and my patch.\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.98; previous revision: 1.97\ndone\nChecking in src/org/mozilla/javascript/NativeString.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeString.java,v  <--  NativeString.java\nnew revision: 1.64; previous revision: 1.63\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/NativeStringTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/NativeStringTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/NativeStringTest.java,v  <--  NativeStringTest.java\ninitial revision: 1.1\ndoneImpressing! I\'ve never seen such a fast reaction in the Rhino project! ;-)\n\nI\'ll attach a patch checking that the regression of my first patch can be catch by a test in the future.Created attachment 376722\nImproves unit test to cover call to String.toLowerCase\n\nAdds test for call to String.toLowerCase that first proposed patch was breaking and that is not covered by any test until now.I committed the patch to the unit test.',?,BUG
492367,'Some function calls cause lots of execution stack information in interpreted mode',Rhino,Core,mguillemot,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.10) Gecko/2009042513 Ubuntu/8.04 (hardy) Firefox/3.0.10\nBuild Identifier: \n\nIn interpreted mode, when an exception occurs after a call to some functions (like NativeString\'s toLowerCase), no script stacktrace is available.\n\nThe cause of the problem is that Context\'s lastInterpreterFrame is set to null after the function call and therefore the frame stack can\'t be retrieved.\n\nReproducible: AlwaysCreated attachment 376717\nPatch with unit test and fix\n\nThis patch fixes the problem without to break any of the existing working tests.Changed priority to major as it is a major inconvenient to understand errors in JS codePing! Somebody here?The line in Interpreter.java that was removed was originally added as part of the continuation api changes, but the regression test there executes successfully, so evidently the change isn\'t needed.\n\nCommitted:\n\nChecking in src/org/mozilla/javascript/Interpreter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/Interpreter.java,v  <--  Interpreter.java\nnew revision: 1.356; previous revision: 1.355\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/StackTraceTest.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/StackTraceTest.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/StackTraceTest.java,v  <--  StackTraceTest.java\ninitial revision: 1.1\ndoneThanks for applying the patch.',?,CLEANUP
492525,'NativeArray.getAllIds does not return array indices',Rhino,Core,rspeyer,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.0.10) Gecko/2009042315 Firefox/3.0.10\nBuild Identifier: Rhino 1.7 release 2 2009 03 22\n\nNativeArray.getIds extends ScriptableObject.getIds by adding the array indices, but they are not added to NativeArray.getAllIds, which should return everything returned by getIds, plus the non-enumerable properties.\n\nReproducible: Always\n\nSteps to Reproduce:\nnew NativeArray(new String[]{\"a\", \"b\"}).getAllIds()\n\nActual Results:  \n[\"length\"]\n\nExpected Results:  \n[0, 1, \"length\"]Created attachment 376903\noverrides NativeArray.getAllIds and adds NativeArrayTestCommitted:\n\nChecking in src/org/mozilla/javascript/NativeArray.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeArray.java,v  <--  NativeArray.java\nnew revision: 1.99; previous revision: 1.98\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug492525Test.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug492525Test.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug492525Test.java,v  <--  Bug492525Test.java\ninitial revision: 1.1\ndone',?,BUG
492538,'Use Google\'s v8 benchmark suite for performance testing',Rhino,Core,rspeyer,nobody,'User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.0.10) Gecko/2009042315 Firefox/3.0.10\nBuild Identifier: Rhino 1.7 release 2 2009 03 22\n\nInclude the performance benchmarks from v8.\n\nReproducible: Always\n\n\n\n\nProvide benchmark tests so that we can check for performance improvements or regressions as the implementation progresses.Created attachment 376918\nAdded benchmark scripts, a runner a script and an ant task\n\nCan now be run with:\n$ ant benchmarkGreat, thanks!\n\nLooking at http://v8.googlecode.com/svn/data/benchmarks/v4/run.html I see that the current version of the benchmark appears to include \"Splay\" but I don\'t see that test when I run from ant. Is it a different version of the benchmark?Yes, it\'s currently based on v3. I\'ll upgrade it to v4 to include the splay tree test.Created attachment 379168\nv8 benchmark suite version 4\n\nVersion 4 of the v8 benchmark suite. The new splay.js file tests memory usage, and I had to increase the JVM memory to 256MB to avoid an OutOfMemory exception.Committed, with minor modifications to make it easier to add other benchmarks in the future.',?,TEST
494665,' shared scopes',Rhino,Core,szegedia,szegedia,'From the e-mail Kieran Topping sent to the rhino mailing list: \n\nWhen using the default WrapFactory, ClassCache holds a reference to whatever the top level scope was at the time the class-in-question was cached.\nUsually, this is truly the top-level scope, which doesn\'t cause any problems.\nHowever, if you\'re using a shared \"global\" scope, as per:\nhttps://developer.mozilla.org/En/Rhino_documentation/Scopes_and_Contexts#Sharing_Scopes\nthen this sharedScope isn\'t used by ClassCache; it\'s actually your \"newScope\", as follows:\n\nScriptable sharedScope = ... create shared scope.\n\ncreate a scope that uses the shared scope\n  Scriptable newScope = cx.newObject(sharedScope);\n  newScope.setPrototype(sharedScope);\n  newScope.setParentScope(null);\nthen run a script in newScope, in particular one that ends up wrapping a java class, either via Context.javaToJS() or actually in your javascript. Even if you don\'t do this explicitly, things like throwing a java exception will end in WrapFactory being used.\n\nAfter the above, you can end up with the following:\n\nsharedScope\n-stores-reference-to-> classCacheInstance\n\nclassCacheInstance\n-stores-reference-to-> newScope.\n\nThis means that newScope will /never /become eligible for garbage collection. If you created some large objects in newScope then these will never be GC-ed either. Hence....memory leak.Created attachment 379424\nPatch that fixes the bug\n\nAttached a patch to fix the bug. Basically, have the JavaMembers objects bind to the scope of the ClassCache instead of the current top-level scope (as the ClassCache scope can be the current top-level scope\'s prototype).Committed patch to CVS HEAD:\n\n***\ncvs ci -m \"Fix for #494665: Memory leak when using Java reflection & shared scopes\" -l \"/Rhino/src/org/mozilla/javascript/JavaMembers.java\" \"/Rhino/src/org/mozilla/javascript/ClassCache.java\"\n    Checking in src/org/mozilla/javascript/ClassCache.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/ClassCache.java,v  <--  ClassCache.java\n    new revision: 1.20; previous revision: 1.19\n    done\n    Checking in src/org/mozilla/javascript/JavaMembers.java;\n    /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaMembers.java,v  <--  JavaMembers.java\n    new revision: 1.80; previous revision: 1.79\n    done\nok (took 0:04.203)\n***Comment on attachment 379424\nPatch that fixes the bug\n\nReview of attachment 379424:\n-----------------------------------------------------------------\n\nI haven\'t seen this at the time, and bugzilla has recently started sending me me reminder emails about it, so yes, this looks perfectly fine :)',?,DESIGN_DEFECT
495785,'Rhino interpreter shell crashes with NullPointerException',Rhino,Core,a.badger,nobody,'User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.1b4) Gecko/20090427 Fedora/3.5-0.20.beta4.fc11 Firefox/3.5b4\nBuild Identifier: Rhino-1.7r2\n\nOn Fedora Linux with rhino-1.7r2, scripts can run but trying to run the interactive shell throws a NullPointerException.  The cause is diagnosed in this bug in the Fedora bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=457336\n\n\nReproducible: Always\n\nSteps to Reproduce:\n1. $ java org.mozilla.javascript.tools.shell.Main\n2.\n3.\nActual Results:  \nRhino 1.7 release 0.5.r2.fc10 2009 04 23\nException in thread \"main\" java.lang.NullPointerException\n at org.mozilla.javascript.Kit.classOrNull(Kit.java:92)\n at org.mozilla.javascript.tools.shell.ShellLine.getStream(ShellLine.java:65)\n at org.mozilla.javascript.tools.shell.Global.getIn(Global.java:829)\n at org.mozilla.javascript.tools.shell.Main.processSource(Main.java:385)\n at org.mozilla.javascript.tools.shell.Main.processFiles(Main.java:196)\n at org.mozilla.javascript.tools.shell.Main$IProxy.run(Main.java:117)\n at org.mozilla.javascript.Context.call(Context.java:515)\n at org.mozilla.javascript.ContextFactory.call(ContextFactory.java:507)\n at org.mozilla.javascript.tools.shell.Main.exec(Main.java:179)\n at org.mozilla.javascript.tools.shell.Main.main(Main.java:157)\n\n\n\nExpected Results:  \nRhino 1.7 release 0.6.r2.fc11 2009 05 31\njs>\n\n\nSteven Elliot diagnosed the bug in the Fedora bug tracker and came up with the following:\n\n\"\"\"\nI\'ve looked into the null pointer exception quoted above. I believe it\'s a\nresult of Rhino attempting to dynamically load the jline library.  My\nunderstanding is that there are both class specific class loaders and a generic\nsystem class loader.  With this fix both will be attempted, if necessary, to\ndynamically load a jline class.\n\"\"\"\n\nI\'ll attach his patch (which fixes the exception).Created attachment 380840\nPatch to fallback to system jline if class specific loader fails\n\nSteven Elliott\'s patch to try the class specific loader for jline, then the system loader, then return null if no jline was found.Created attachment 380856\nSame patch minus Fedora script changes\n\nHere\'s the same patch minus changes to a Fedora-local script to invoke rhino with jline support.Fixed in CVS:\n\nChecking in toolsrc/org/mozilla/javascript/tools/shell/ShellLine.java;\n/cvsroot/mozilla/js/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellLine.java,v  <--  ShellLine.java\nnew revision: 1.5; previous revision: 1.4\ndone\n\nThanks!',?,BUG
496585,'Regression in overload resolution',Rhino,Core,norrisboyd,norrisboyd,'Hi there, \nI decided to run my application against the lastest version of rhino \nin source, and noticed that some of the calls to overloaded java \nfunctions triggered a index out of bounds exception. \nThe following testcase works in 1.7R1 \npackage foo; \nimport org.mozilla.javascript.Function; \nimport org.mozilla.javascript.ContextFactory; \nimport org.mozilla.javascript.ContextAction; \nimport org.mozilla.javascript.Context; \nimport org.junit.Test; \npublic class OverloadTest { \n        public void method(String one, Function function) { \n                System.out.println(\"string+function\"); \n        } \n        public void method(String... strings) { \n                System.out.println(\"string[]\"); \n        } \n        @Test \n        public void callOverloadedFunction() { \n                new ContextFactory().call(new ContextAction() { \n                        public Object run(Context cx) { \n                                cx.evaluateString(cx.initStandardObjects(),\"new \nPackages.foo.OverloadTest().method(\'one\', \'two\',\'three\')\", \"<test>\", \n1, null); \n                                cx.evaluateString(cx.initStandardObjects(),\"new \nPackages.foo.OverloadTest().method(\'one\', function() {})\", \"<test>\", \n1, null); \n                                return null; \n                        } \n                }); \n        } \n} \n\n//outputs: \nstring[] \nstring+function \nWhen I run it against the latest source, it results in the following \nstring[] \njava.lang.ArrayIndexOutOfBoundsException: 1 \n        at org.mozilla.javascript.NativeJavaMethod.preferSignature \n(NativeJavaMethod.java:508) \n        at org.mozilla.javascript.NativeJavaMethod.findFunction \n(NativeJavaMethod.java:367) \n        at org.mozilla.javascript.NativeJavaMethod.call(NativeJavaMethod.java: \n161) \n        at org.mozilla.javascript.optimizer.OptRuntime.call2(OptRuntime.java: \n76) \n        at org.mozilla.javascript.gen._test__2._c_script_0(<test>:1) \n        at org.mozilla.javascript.gen._test__2.call(<test>) \n        at org.mozilla.javascript.ContextFactory.doTopCall \n(ContextFactory.java:426) \n        at org.mozilla.javascript.ScriptRuntime.doTopCall(ScriptRuntime.java: \n3060) \n        at org.mozilla.javascript.gen._test__2.call(<test>) \n        at org.mozilla.javascript.gen._test__2.exec(<test>) \n        at org.mozilla.javascript.Context.evaluateString(Context.java:1112) \n        at foo.OverloadTest$1.run(OverloadTest.java:24) \n        at org.mozilla.javascript.Context.call(Context.java:522) \n        at org.mozilla.javascript.ContextFactory.call(ContextFactory.java: \n535) \n        at foo.OverloadTest.callOverloadedFunction(OverloadTest.java:21) \n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) \n        at sun.reflect.NativeMethodAccessorImpl.invoke \n(NativeMethodAccessorImpl.java:39) \n        at sun.reflect.DelegatingMethodAccessorImpl.invoke \n(DelegatingMethodAccessorImpl.java:25) \n        at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall \n(FrameworkMethod.java:44) \n        at org.junit.internal.runners.model.ReflectiveCallable.run \n(ReflectiveCallable.java:15) \n        at org.junit.runners.model.FrameworkMethod.invokeExplosively \n(FrameworkMethod.java:41) \n        at org.junit.internal.runners.statements.InvokeMethod.evaluate \n(InvokeMethod.java:20) \n        at org.junit.internal.runners.statements.RunBefores.evaluate \n(RunBefores.java:28) \n        at org.junit.internal.runners.statements.RunAfters.evaluate \n(RunAfters.java:31) \n        at org.junit.runners.BlockJUnit4ClassRunner.runChild \n(BlockJUnit4ClassRunner.java:73) \n        at org.junit.runners.BlockJUnit4ClassRunner.runChild \n(BlockJUnit4ClassRunner.java:46) \n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:180) \n        at org.junit.runners.ParentRunner.access$000(ParentRunner.java:41) \n        at org.junit.runners.ParentRunner$1.evaluate(ParentRunner.java:173) \n        at org.junit.internal.runners.statements.RunBefores.evaluate \n(RunBefores.java:28) \n        at org.junit.internal.runners.statements.RunAfters.evaluate \n(RunAfters.java:31) \n        at org.junit.runners.ParentRunner.run(ParentRunner.java:220) \nbug?Checking in src/org/mozilla/javascript/NativeJavaMethod.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/NativeJavaMethod.java,v  <-\n-  NativeJavaMethod.java\nnew revision: 1.65; previous revision: 1.64\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/doctests/467396.doctest,v\ndone\nChecking in testsrc/doctests/467396.doctest;\n/cvsroot/mozilla/js/rhino/testsrc/doctests/467396.doctest,v  <--  467396.doctest\n\ninitial revision: 1.1\ndone\nRCS file: /cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug4965\n85.java,v\ndone\nChecking in testsrc/org/mozilla/javascript/tests/Bug496585.java;\n/cvsroot/mozilla/js/rhino/testsrc/org/mozilla/javascript/tests/Bug496585.java,v\n <--  Bug496585.java\ninitial revision: 1.1\ndone',?,BUG
500199,'JavaAdapters have same ProtectionDomain as rhino jar file',Rhino,Core,hannesw,nobody,'Created attachment 384870\nPatch adding RhinoSecurityManager class\n\nCurrently, JavaAdapter classes are created with the same java.security.ProtectionDomain as the org.mozilla.javascript.JavaAdapter class (i.e. that of the Rhino js.jar file). I think they should use the domain of the script that creates them. \n\nThe patch adds a org.mozilla.javascript.RhinoSecurityManager class that provides a method to retrieve the protection domain of the top-most stack element representing a user script, and uses that as the dynamic security domain returned by PolicySecurityController.getDynamicSecurityDomain() if available.I should note that one interesting pattern this patch enables is to provide privileged actions in javascript, provided you have multiple script repositories with different policies:\n\n    importClass(java.security.AccessController);\n    importClass(java.security.PrivilegedAction);\n\n    AccessController.doPrivileged(new PrivilegedAction({\n       run: function() {\n           ...\n       }\n    }));Note: the patch is bogus, at least the part for PolicySecurityController.getDynamicSecurityDomain(). Of course, the Java Policy framework needs the least priviledged domain on the stack, not the last one. \n\nStill, the parts in SecurityUtils and RhinoSecurityManager would be useful to make JavaAdapters securable by creating them with the code source of the calling script code. InterfaceAdapters, on the other hand, use the java.lang.reflect.Proxy class which is always created using the trusted system code source (see the java.lang.reflect.Proxy API documentation), so it seems to be non-securable.Created attachment 433931\nRevised patch\n\nSimilar to the first patch, but the script protection domain is only used by JavaAdapter.loadAdapterClass(). Also, the getScriptProtectionDomain() method in RhinoSecurityManager is changed to getCurrentScriptClass() to make it more generic and flexible.Committed last patch.\n\nChecking in src/org/mozilla/javascript/JavaAdapter.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/JavaAdapter.java,v  <--  JavaAdapter.java\nnew revision: 1.118; previous revision: 1.117\ndone\nRCS file: /cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/RhinoSecurityManager.java,v\ndone\nChecking in src/org/mozilla/javascript/RhinoSecurityManager.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/RhinoSecurityManager.java,v  <--  RhinoSecurityManager.java\ninitial revision: 1.1\ndone\nChecking in src/org/mozilla/javascript/SecurityUtilities.java;\n/cvsroot/mozilla/js/rhino/src/org/mozilla/javascript/SecurityUtilities.java,v  <--  SecurityUtilities.java\nnew revision: 1.7; previous revision: 1.6\ndone',?,RFE